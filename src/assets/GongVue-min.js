!function(){var undefined=void 0,defaultConfig={targetFrame:undefined,exportInstaller:!1,useNative:!0,useInnerText:!0},config;if(window.jsxpath)config=window.jsxpath;else{var scriptElms=document.getElementsByTagName("script"),scriptElm=scriptElms[scriptElms.length-1],scriptSrc=scriptElm.src;config={};var scriptSrcMatchResult=scriptSrc.match(/\?(.*)$/);if(scriptSrcMatchResult)for(var configStrings=scriptSrcMatchResult[1].split("&"),i=0,l=configStrings.length;i<l;i++){var configString=configStrings[i],configStringSplited=configString.split("="),configName=configStringSplited[0],configValue=configStringSplited[1];configValue==undefined||("false"==configValue||/^-?\d+$/.test(configValue))&&(configValue=eval(configValue)),config[configName]=configValue}}for(var n in defaultConfig)n in config||(config[n]=defaultConfig[n]);if(config.hasNative=!!(document.implementation&&document.implementation.hasFeature&&document.implementation.hasFeature("XPath",null)),!config.hasNative||!config.useNative||config.exportInstaller){var BinaryExpr,FilterExpr,FunctionCall,Literal,NameTest,NodeSet,NodeType,NodeUtil,Number,PathExpr,Step,UnaryExpr,UnionExpr,VariableReference,uai=new function(){var e=navigator.userAgent;if(RegExp==undefined)e.indexOf("Opera")>=0?this.opera=!0:e.indexOf("Netscape")>=0?this.netscape=!0:0==e.indexOf("Mozilla/")?this.mozilla=!0:this.unknown=!0,e.indexOf("Gecko/")>=0&&(this.gecko=!0),e.indexOf("Win")>=0?this.windows=!0:e.indexOf("Mac")>=0?this.mac=!0:e.indexOf("Linux")>=0?this.linux=!0:e.indexOf("BSD")>=0?this.bsd=!0:e.indexOf("SunOS")>=0&&(this.sunos=!0);else if(/AppleWebKit\/(\d+(?:\.\d+)*)/.test(e)?(this.applewebkit=RegExp.$1,4==RegExp.$1.charAt(0)?this.applewebkit2=!0:this.applewebkit3=!0):"object"==typeof Components&&(/Gecko\/(\d{8})/.test(e)||"Gecko"==navigator.product&&/^(\d{8})$/.test(navigator.productSub))&&(this.gecko=RegExp.$1),"object"==typeof opera&&"function"==typeof opera.version?(this.opera=opera.version(),this["opera"+this.opera[0]+this.opera[2]]=!0):"object"==typeof opera&&/Opera[\/ ](\d+\.\d+)/.test(e)?this.opera=RegExp.$1:this.ie||(/Safari\/(\d+(?:\.\d+)*)/.test(e)?this.safari=RegExp.$1:/NetFront\/(\d+(?:\.\d+)*)/.test(e)?this.netfront=RegExp.$1:/Konqueror\/(\d+(?:\.\d+)*)/.test(e)?this.konqueror=RegExp.$1:e.indexOf("(compatible;")<0&&/^Mozilla\/(\d+\.\d+)/.test(e)?(this.mozilla=RegExp.$1,/\([^(]*rv:(\d+(?:\.\d+)*).*?\)/.test(e)&&(this.mozillarv=RegExp.$1),/Firefox\/(\d+(?:\.\d+)*)/.test(e)?this.firefox=RegExp.$1:/Netscape\d?\/(\d+(?:\.\d+)*)/.test(e)&&(this.netscape=RegExp.$1)):this.unknown=!0),e.indexOf("Win 9x 4.90")>=0)this.windows="ME";else if(/Win(?:dows)? ?(NT ?(\d+\.\d+)?|\d+|ME|Vista|XP)/.test(e))if(this.windows=RegExp.$1,RegExp.$2)this.winnt=RegExp.$2;else switch(RegExp.$1){case"2000":this.winnt="5.0";break;case"XP":this.winnt="5.1";break;case"Vista":this.winnt="6.0"}else e.indexOf("Mac")>=0?this.mac=!0:e.indexOf("Linux")>=0?this.linux=!0:/(\w*BSD)/.test(e)?this.bsd=RegExp.$1:e.indexOf("SunOS")>=0&&(this.sunos=!0)},Lexer=function(e){for(var t=Lexer.prototype,i=e.match(t.regs.token),r=0,n=i.length;r<n;r++)t.regs.strip.test(i[r])&&i.splice(r,1);for(var o in t)i[o]=t[o];return i.index=0,i};Lexer.prototype.regs={token:/\$?(?:(?![0-9-])[\w-]+:)?(?![0-9-])[\w-]+|\/\/|\.\.|::|\d+(?:\.\d*)?|\.\d+|"[^"]*"|'[^']*'|[!<>]=|(?![0-9-])[\w-]+:\*|\s+|./g,strip:/^\s/},Lexer.prototype.peek=function(e){return this[this.index+(e||0)]},Lexer.prototype.next=function(){return this[this.index++]},Lexer.prototype.back=function(){this.index--},Lexer.prototype.empty=function(){return this.length<=this.index};var Ctx=function(e,t,i){this.node=e,this.position=t||1,this.last=i||1},BaseExpr=function(){};BaseExpr.prototype.number=function(e){var t=this.evaluate(e);return t.isNodeSet?t.number():+t},BaseExpr.prototype.string=function(e){var t=this.evaluate(e);return t.isNodeSet?t.string():""+t},BaseExpr.prototype.bool=function(e){var t=this.evaluate(e);return t.isNodeSet?t.bool():!!t};var BaseExprHasPredicates=function(){};BaseExprHasPredicates.parsePredicates=function(e,t){for(;"["==e.peek();){if(e.next(),e.empty())throw Error("missing predicate expr");var i=BinaryExpr.parse(e);if(t.predicate(i),e.empty())throw Error("unclosed predicate expr");if("]"!=e.next())throw e.back(),Error("bad token: "+e.next())}},BaseExprHasPredicates.prototype=new BaseExpr,BaseExprHasPredicates.prototype.evaluatePredicates=function(e,t){var i,r,n,o;o=this.reverse,i=this.predicates,e.sort();for(var a=t||0,s=i.length;a<s;a++){r=i[a];for(var c,l=[],h=0,u=(c=e.list()).length;h<u;h++){switch(n=o?u-h:h+1,exrs=r.evaluate(new Ctx(c[h],n,u)),typeof exrs){case"number":exrs=n==exrs;break;case"string":exrs=!!exrs;break;case"object":exrs=exrs.bool()}exrs||l.push(h)}for(h=l.length-1,u=0;h>=u;h--)e.del(l[h])}return e},!window.BinaryExpr&&window.defaultConfig&&(window.BinaryExpr=null),BinaryExpr=function(e,t,i,r){this.op=e,this.left=t,this.right=i,this.datatype=BinaryExpr.ops[e][2],this.needContextPosition=t.needContextPosition||i.needContextPosition,this.needContextNode=t.needContextNode||i.needContextNode,"="==this.op&&(i.needContextNode||i.needContextPosition||"nodeset"==i.datatype||"void"==i.datatype||!t.quickAttr?t.needContextNode||t.needContextPosition||"nodeset"==t.datatype||"void"==t.datatype||!i.quickAttr||(this.quickAttr=!0,this.attrName=i.attrName,this.attrValueExpr=t):(this.quickAttr=!0,this.attrName=t.attrName,this.attrValueExpr=i))},BinaryExpr.compare=function(e,t,i,r,n){var o,a,s,c,l,h;if(i=i.evaluate(n),r=r.evaluate(n),i.isNodeSet&&r.isNodeSet){a=i.list(),s=r.list();for(var u=0,d=a.length;u<d;u++)for(var p=0,f=s.length;p<f;p++)if(t(NodeUtil.to("string",a[u]),NodeUtil.to("string",s[p])))return!0;return!1}if(i.isNodeSet||r.isNodeSet){i.isNodeSet?(l=i,h=r):(l=r,h=i),o=typeof h;u=0;for(var m=(c=l.list()).length;u<m;u++)if(t(NodeUtil.to(o,c[u]),h))return!0;return!1}return"="==e||"!="==e?"boolean"==typeof i||"boolean"==typeof r?t(!!i,!!r):"number"==typeof i||"number"==typeof r?t(+i,+r):t(i,r):t(+i,+r)},BinaryExpr.ops={div:[6,function(e,t,i){return e.number(i)/t.number(i)},"number"],mod:[6,function(e,t,i){return e.number(i)%t.number(i)},"number"],"*":[6,function(e,t,i){return e.number(i)*t.number(i)},"number"],"+":[5,function(e,t,i){return e.number(i)+t.number(i)},"number"],"-":[5,function(e,t,i){return e.number(i)-t.number(i)},"number"],"<":[4,function(e,t,i){return BinaryExpr.compare("<",function(e,t){return e<t},e,t,i)},"boolean"],">":[4,function(e,t,i){return BinaryExpr.compare(">",function(e,t){return e>t},e,t,i)},"boolean"],"<=":[4,function(e,t,i){return BinaryExpr.compare("<=",function(e,t){return e<=t},e,t,i)},"boolean"],">=":[4,function(e,t,i){return BinaryExpr.compare(">=",function(e,t){return e>=t},e,t,i)},"boolean"],"=":[3,function(e,t,i){return BinaryExpr.compare("=",function(e,t){return e==t},e,t,i)},"boolean"],"!=":[3,function(e,t,i){return BinaryExpr.compare("!=",function(e,t){return e!=t},e,t,i)},"boolean"],and:[2,function(e,t,i){return e.bool(i)&&t.bool(i)},"boolean"],or:[1,function(e,t,i){return e.bool(i)||t.bool(i)},"boolean"]},BinaryExpr.parse=function(e){var t,i,r,n,o=[];for(e.index;;){if(e.empty())throw Error("missing right expression");if(n=UnaryExpr.parse(e),!(t=e.next()))break;if(!(i=(r=this.ops[t])&&r[0])){e.back();break}for(;o.length&&i<=this.ops[o[o.length-1]][0];)n=new BinaryExpr(o.pop(),o.pop(),n);o.push(n,t)}for(;o.length;)n=new BinaryExpr(o.pop(),o.pop(),n);return n},BinaryExpr.prototype=new BaseExpr,BinaryExpr.prototype.evaluate=function(e){return BinaryExpr.ops[this.op][1](this.left,this.right,e)},BinaryExpr.prototype.show=function(e){var t="";return t+=(e=e||"")+"binary: "+this.op+"\n",e+="    ",t+=this.left.show(e),t+=this.right.show(e)},!window.UnaryExpr&&window.defaultConfig&&(window.UnaryExpr=null),UnaryExpr=function(e,t){this.op=e,this.expr=t,this.needContextPosition=t.needContextPosition,this.needContextNode=t.needContextNode},UnaryExpr.ops={"-":1},UnaryExpr.parse=function(e){return this.ops[e.peek()]?new UnaryExpr(e.next(),UnaryExpr.parse(e)):UnionExpr.parse(e)},UnaryExpr.prototype=new BaseExpr,UnaryExpr.prototype.datatype="number",UnaryExpr.prototype.evaluate=function(e){return-this.expr.number(e)},UnaryExpr.prototype.show=function(e){var t="";return t+=(e=e||"")+"unary: "+this.op+"\n",e+="    ",t+=this.expr.show(e)},!window.UnionExpr&&window.defaultConfig&&(window.UnionExpr=null),UnionExpr=function(){this.paths=[]},UnionExpr.ops={"|":1},UnionExpr.parse=function(e){var t,i;if(i=PathExpr.parse(e),!this.ops[e.peek()])return i;for((t=new UnionExpr).path(i);this.ops[e.next()];){if(e.empty())throw Error("missing next union location path");t.path(PathExpr.parse(e))}return e.back(),t},UnionExpr.prototype=new BaseExpr,UnionExpr.prototype.datatype="nodeset",UnionExpr.prototype.evaluate=function(e){for(var t=this.paths,i=new NodeSet,r=0,n=t.length;r<n;r++){var o=t[r].evaluate(e);if(!o.isNodeSet)throw Error("PathExpr must be nodeset");i.merge(o)}return i},UnionExpr.prototype.path=function(e){this.paths.push(e),e.needContextPosition&&(this.needContextPosition=!0),e.needContextNode&&(this.needContextNode=!0)},UnionExpr.prototype.show=function(e){var t="";t+=(e=e||"")+"union:\n",e+="    ";for(var i=0;i<this.paths.length;i++)t+=this.paths[i].show(e);return t},!window.PathExpr&&window.defaultConfig&&(window.PathExpr=null),PathExpr=function(e){this.filter=e,this.steps=[],this.datatype=e.datatype,this.needContextPosition=e.needContextPosition,this.needContextNode=e.needContextNode},PathExpr.ops={"//":1,"/":1},PathExpr.parse=function(e){var t,i,r,n;if(this.ops[e.peek()]){if(t=e.next(),n=e.peek(),"/"==t&&(e.empty()||"."!=n&&".."!=n&&"@"!=n&&"*"!=n&&!/(?![0-9])[\w]/.test(n)))return FilterExpr.root();if(r=new PathExpr(FilterExpr.root()),e.empty())throw Error("missing next location step");i=Step.parse(e),r.step(t,i)}else if(i=FilterExpr.parse(e)){if(!this.ops[e.peek()])return i;r=new PathExpr(i)}else i=Step.parse(e),(r=new PathExpr(FilterExpr.context())).step("/",i);for(;this.ops[e.peek()];){if(t=e.next(),e.empty())throw Error("missing next location step");r.step(t,Step.parse(e))}return r},PathExpr.prototype=new BaseExpr,PathExpr.prototype.evaluate=function(e){var t=this.filter.evaluate(e);if(!t.isNodeSet)throw Exception("Filter nodeset must be nodeset type");for(var i=this.steps,r=0,n=i.length;r<n&&t.length;r++){var o,a,s=i[r][1],c=s.reverse,l=t.iterator(c),h=t;if(t=null,s.needContextPosition||"following"!=s.axis)if(s.needContextPosition||"preceding"!=s.axis){o=l();var u=0;for(t=s.evaluate(new Ctx(o),!1,h,u);o=l();)u++,t.merge(s.evaluate(new Ctx(o),!1,h,u))}else o=l(),t=s.evaluate(new Ctx(o));else{for(o=l();a=l();o=a)if(uai.applewebkit2){var d=!1,p=a;do{if(p==o){d=!0;break}}while(p=p.parentNode);if(!d)break}else try{if(!o.contains(a))break}catch(e){if(!(8&a.compareDocumentPosition(o)))break}t=s.evaluate(new Ctx(o))}}return t},PathExpr.prototype.step=function(e,t){if(t.op=e,this.steps.push([e,t]),this.quickAttr=!1,1==this.steps.length&&"/"==e&&"attribute"==t.axis){var i=t.test;i.notOnlyElement||"*"==i.name||(this.quickAttr=!0,this.attrName=i.name)}},PathExpr.prototype.show=function(e){var t="";if(t+=(e=e||"")+"path:\n",t+=(e+="    ")+"filter:\n",t+=this.filter.show(e+"    "),this.steps.length){t+=e+"steps:\n",e+="    ";for(var i=0;i<this.steps.length;i++){var r=this.steps[i];t+=e+"operator: "+r[0]+"\n",t+=r[1].show(e)}}return t},!window.FilterExpr&&window.defaultConfig&&(window.FilterExpr=null),FilterExpr=function(e){this.primary=e,this.predicates=[],this.datatype=e.datatype,this.needContextPosition=e.needContextPosition,this.needContextNode=e.needContextNode},FilterExpr.parse=function(e){var t,i,r,n;switch(n=(r=e.peek()).charAt(0)){case"$":t=VariableReference.parse(e);break;case"(":if(e.next(),t=BinaryExpr.parse(e),e.empty())throw Error('unclosed "("');if(")"!=e.next())throw e.back(),Error("bad token: "+e.next());break;case'"':case"'":t=Literal.parse(e);break;default:if(isNaN(+r)){if(NodeType.types[r])return null;if(!/(?![0-9])[\w]/.test(n)||"("!=e.peek(1))return null;t=FunctionCall.parse(e)}else t=Number.parse(e)}return"["!=e.peek()?t:(i=new FilterExpr(t),BaseExprHasPredicates.parsePredicates(e,i),i)},FilterExpr.root=function(){return new FunctionCall("root-node")},FilterExpr.context=function(){return new FunctionCall("context-node")},FilterExpr.prototype=new BaseExprHasPredicates,FilterExpr.prototype.evaluate=function(e){var t=this.primary.evaluate(e);if(!t.isNodeSet){if(this.predicates.length)throw Error("Primary result must be nodeset type if filter have predicate expression");return t}return this.evaluatePredicates(t)},FilterExpr.prototype.predicate=function(e){this.predicates.push(e)},FilterExpr.prototype.show=function(e){var t="";if(t+=(e=e||"")+"filter: \n",e+="    ",t+=this.primary.show(e),this.predicates.length){t+=e+"predicates: \n",e+="    ";for(var i=0;i<this.predicates.length;i++)t+=this.predicates[i].show(e)}return t},!window.NodeUtil&&window.defaultConfig&&(window.NodeUtil=null),NodeUtil={to:function(e,t){var r,n=t.nodeType;if(1==n&&config.useInnerText&&!uai.applewebkit2&&(r=(r=(r=t.textContent)==undefined||null==r?t.innerText:r)==undefined||null==r?"":r),"string"!=typeof r)if(9==n||1==n)for(t=9==n?t.documentElement:t.firstChild,r="",stack=[],i=0;t;){do{1!=t.nodeType&&(r+=t.nodeValue),stack[i++]=t}while(t=t.firstChild);for(;i&&!(t=stack[--i].nextSibling););}else r=t.nodeValue;switch(e){case"number":return+r;case"boolean":return!!r;default:return r}},attrPropMap:{name:"name",class:"className",dir:"dir",id:"id",name:"name",title:"title"},attrMatch:function(e,t,i){return!!(!t||null==i&&e.hasAttribute&&e.hasAttribute(t)||null!=i&&e.getAttribute&&e.getAttribute(t)==i)},getDescendantNodes:function(e,t,i,r,n,o,a){if(o&&o.delDescendant(t,a),n&&"id"==r&&t.getElementById)(t=t.getElementById(n))&&e.match(t)&&i.push(t);else if(n&&"name"==r&&t.getElementsByName)for(var s=0,c=(l=t.getElementsByName(n)).length;s<c;s++)t=l[s],(uai.opera?t.name==n&&e.match(t):e.match(t))&&i.push(t);else if(n&&"class"==r&&t.getElementsByClassName)for(s=0,c=(l=t.getElementsByClassName(n)).length;s<c;s++)(t=l[s]).className==n&&e.match(t)&&i.push(t);else if(e.notOnlyElement)!function(t){for(var o=arguments.callee,a=t.firstChild;a;a=a.nextSibling)NodeUtil.attrMatch(a,r,n)&&e.match(a.nodeType)&&i.push(a),o(a)}(t);else{var l,h=e.name;if(t.getElementsByTagName)if(l=t.getElementsByTagName(h))for(s=0;t=l[s++];)NodeUtil.attrMatch(t,r,n)&&i.push(t)}return i},getChildNodes:function(e,t,i,r,n){for(t=t.firstChild;t;t=t.nextSibling)NodeUtil.attrMatch(t,r,n)&&e.match(t)&&i.push(t);return i}},!window.Step&&window.defaultConfig&&(window.Step=null),Step=function(e,t){this.axis=e,this.reverse=Step.axises[e][0],this.func=Step.axises[e][1],this.test=t,this.predicates=[],this._quickAttr=Step.axises[e][2]},Step.axises={ancestor:[!0,function(e,t,i,r,n,o,a){for(;t=t.parentNode;)o&&1==t.nodeType&&o.reserveDelByNode(t,a,!0),e.match(t)&&i.unshift(t);return i}],"ancestor-or-self":[!0,function(e,t,i,r,n,o,a){do{o&&1==t.nodeType&&o.reserveDelByNode(t,a,!0),e.match(t)&&i.unshift(t)}while(t=t.parentNode);return i}],attribute:[!1,function(e,t,i){var r=t.attributes;if(r)if(e.notOnlyElement&&0==e.type||"*"==e.name)for(var n,o=0;n=r[o];o++)i.push(n);else(n=r.getNamedItem(e.name))&&i.push(n);return i}],child:[!1,NodeUtil.getChildNodes,!0],descendant:[!1,NodeUtil.getDescendantNodes,!0],"descendant-or-self":[!1,function(e,t,i,r,n,o,a){return NodeUtil.attrMatch(t,r,n)&&e.match(t)&&i.push(t),NodeUtil.getDescendantNodes(e,t,i,r,n,o,a)},!0],following:[!1,function(e,t,i,r,n){do{for(var o=t;o=o.nextSibling;)NodeUtil.attrMatch(o,r,n)&&e.match(o)&&i.push(o),i=NodeUtil.getDescendantNodes(e,o,i,r,n)}while(t=t.parentNode);return i},!0],"following-sibling":[!1,function(e,t,i,r,n,o,a){for(;t=t.nextSibling;)o&&1==t.nodeType&&o.reserveDelByNode(t,a),e.match(t)&&i.push(t);return i}],namespace:[!1,function(e,t,i){return i}],parent:[!1,function(e,t,i){if(9==t.nodeType)return i;if(2==t.nodeType)return i.push(t.ownerElement),i;t=t.parentNode;return e.match(t)&&i.push(t),i}],preceding:[!0,function(e,t,i,r,n){var o=[];do{o.unshift(t)}while(t=t.parentNode);for(var a=1,s=o.length;a<s;a++){var c=[];for(t=o[a];t=t.previousSibling;)c.unshift(t);for(var l=0,h=c.length;l<h;l++)t=c[l],NodeUtil.attrMatch(t,r,n)&&e.match(t)&&i.push(t),i=NodeUtil.getDescendantNodes(e,t,i,r,n)}return i},!0],"preceding-sibling":[!0,function(e,t,i,r,n,o,a){for(;t=t.previousSibling;)o&&1==t.nodeType&&o.reserveDelByNode(t,a,!0),e.match(t)&&i.unshift(t);return i}],self:[!1,function(e,t,i){return e.match(t)&&i.push(t),i}]},Step.parse=function(e){var t,i,r,n;if("."==e.peek())r=this.self(),e.next();else if(".."==e.peek())r=this.parent(),e.next();else{if("@"==e.peek()){if(t="attribute",e.next(),e.empty())throw Error("missing attribute name")}else if("::"==e.peek(1)){if(!/(?![0-9])[\w]/.test(e.peek().charAt(0)))throw Error("bad token: "+e.next());if(t=e.next(),e.next(),!this.axises[t])throw Error("invalid axis: "+t);if(e.empty())throw Error("missing node name")}else t="child";if(n=e.peek(),/(?![0-9])[\w]/.test(n.charAt(0)))if("("==e.peek(1)){if(!NodeType.types[n])throw Error("invalid node type: "+n);i=NodeType.parse(e)}else i=NameTest.parse(e);else{if("*"!=n)throw Error("bad token: "+e.next());i=NameTest.parse(e)}r=new Step(t,i)}return BaseExprHasPredicates.parsePredicates(e,r),r},Step.self=function(){return new Step("self",new NodeType("node"))},Step.parent=function(){return new Step("parent",new NodeType("node"))},Step.prototype=new BaseExprHasPredicates,Step.prototype.evaluate=function(e,t,i,r){var n=e.node;if(t||"//"!=this.op){if(this.needContextPosition&&(i=null,r=null),this.quickAttr){h=this.attrValueExpr?this.attrValueExpr.string(e):null,s=this.func(this.test,n,new NodeSet,this.attrName,h,i,r);s=this.evaluatePredicates(s,1)}else{s=this.func(this.test,n,new NodeSet,null,null,i,r);s=this.evaluatePredicates(s)}i&&i.doDel()}else if(this.needContextPosition||"child"!=this.axis){var o=new Step("descendant-or-self",new NodeType("node")),a=o.evaluate(e,!1,i,r).list(),s=null;o.op="/";for(var c=0,l=a.length;c<l;c++)s?s.merge(this.evaluate(new Ctx(a[c]),!0)):s=this.evaluate(new Ctx(a[c]),!0);s=s||new NodeSet}else if(this.quickAttr){var h=this.attrValueExpr?this.attrValueExpr.string(e):null,s=NodeUtil.getDescendantNodes(this.test,n,new NodeSet,this.attrName,h,i,r);s=this.evaluatePredicates(s,1)}else{var s=NodeUtil.getDescendantNodes(this.test,n,new NodeSet,null,null,i,r);s=this.evaluatePredicates(s)}return s},Step.prototype.predicate=function(e){if(this.predicates.push(e),(e.needContextPosition||"number"==e.datatype||"void"==e.datatype)&&(this.needContextPosition=!0),this._quickAttr&&1==this.predicates.length&&e.quickAttr){var t=e.attrName;this.attrName=t,this.attrValueExpr=e.attrValueExpr,this.quickAttr=!0}},Step.prototype.show=function(e){var t="";if(t+=(e=e||"")+"step: \n",e+="    ",this.axis&&(t+=e+"axis: "+this.axis+"\n"),t+=this.test.show(e),this.predicates.length){t+=e+"predicates: \n",e+="    ";for(var i=0;i<this.predicates.length;i++)t+=this.predicates[i].show(e)}return t},!window.NodeType&&window.defaultConfig&&(window.NodeType=null),NodeType=function(e,t){switch(this.name=e,this.literal=t,e){case"comment":this.type=8;break;case"text":this.type=3;break;case"processing-instruction":this.type=7;break;case"node":this.type=0}},NodeType.types={comment:1,text:1,"processing-instruction":1,node:1},NodeType.parse=function(e){var t,i,r;if(t=e.next(),e.next(),e.empty())throw Error("bad nodetype");if('"'!=(r=e.peek().charAt(0))&&"'"!=r||(i=Literal.parse(e)),e.empty())throw Error("bad nodetype");if(")"!=e.next())throw e.back(),Error("bad token "+e.next());return new NodeType(t,i)},NodeType.prototype=new BaseExpr,NodeType.prototype.notOnlyElement=!0,NodeType.prototype.match=function(e){return!this.type||this.type==e.nodeType},NodeType.prototype.show=function(e){var t="";return t+=(e=e||"")+"nodetype: "+this.type+"\n",this.literal&&(e+="    ",t+=this.literal.show(e)),t},!window.NameTest&&window.defaultConfig&&(window.NameTest=null),NameTest=function(e){this.name=e.toLowerCase()},NameTest.parse=function(e){return"*"!=e.peek()&&":"==e.peek(1)&&"*"==e.peek(2)?new NameTest(e.next()+e.next()+e.next()):new NameTest(e.next())},NameTest.prototype=new BaseExpr,NameTest.prototype.match=function(e){var t=e.nodeType;return!(1!=t&&2!=t||"*"!=this.name&&this.name!=e.nodeName.toLowerCase())},NameTest.prototype.show=function(e){var t="";return t+=(e=e||"")+"nametest: "+this.name+"\n"},!window.VariableReference&&window.defaultConfig&&(window.VariableReference=null),VariableReference=function(e){this.name=e.substring(1)},VariableReference.parse=function(e){var t=e.next();if(t.length<2)throw Error("unnamed variable reference");return new VariableReference(t)},VariableReference.prototype=new BaseExpr,VariableReference.prototype.datatype="void",VariableReference.prototype.show=function(e){var t="";return t+=(e=e||"")+"variable: "+this.name+"\n"},!window.Literal&&window.defaultConfig&&(window.Literal=null),Literal=function(e){this.text=e.substring(1,e.length-1)},Literal.parse=function(e){var t=e.next();if(t.length<2)throw Error("unclosed literal string");return new Literal(t)},Literal.prototype=new BaseExpr,Literal.prototype.datatype="string",Literal.prototype.evaluate=function(e){return this.text},Literal.prototype.show=function(e){var t="";return t+=(e=e||"")+"literal: "+this.text+"\n"},!window.Number&&window.defaultConfig&&(window.Number=null),Number=function(e){this.digit=+e},Number.parse=function(e){return new Number(e.next())},Number.prototype=new BaseExpr,Number.prototype.datatype="number",Number.prototype.evaluate=function(e){return this.digit},Number.prototype.show=function(e){var t="";return t+=(e=e||"")+"number: "+this.digit+"\n"},!window.FunctionCall&&window.defaultConfig&&(window.FunctionCall=null),FunctionCall=function(e){var t=FunctionCall.funcs[e];if(!t)throw Error(e+" is not a function");this.name=e,this.func=t[0],this.args=[],this.datatype=t[1],t[2]&&(this.needContextPosition=!0),this.needContextNodeInfo=t[3],this.needContextNode=this.needContextNodeInfo[0]},FunctionCall.funcs={"context-node":[function(){if(0!=arguments.length)throw Error("Function context-node expects ()");var e;return(e=new NodeSet).push(this.node),e},"nodeset",!1,[!0]],"root-node":[function(){if(0!=arguments.length)throw Error("Function root-node expects ()");var e,t;return e=new NodeSet,9==(t=this.node).nodeType?e.push(t):e.push(t.ownerDocument),e},"nodeset",!1,[]],last:[function(){if(0!=arguments.length)throw Error("Function last expects ()");return this.last},"number",!0,[]],position:[function(){if(0!=arguments.length)throw Error("Function position expects ()");return this.position},"number",!0,[]],count:[function(e){if(1!=arguments.length||!(e=e.evaluate(this)).isNodeSet)throw Error("Function count expects (nodeset)");return e.length},"number",!1,[]],id:[function(e){var t,i,r,n,o,a,s;if(1!=arguments.length)throw Error("Function id expects (object)");for(s=9==(a=this.node).nodeType?a:a.ownerDocument,t=(e=e.string(this)).split(/\s+/),i=new NodeSet,r=0,l=t.length;r<l;r++)if(n=t[r],o=s.getElementById(n),uai.opera&&o&&o.id!=n)for(var c=s.getElementsByName(n),h=0,u=c.length;h<u;h++)(o=c[h]).id==n&&i.push(o);else o&&i.push(o);return i.isSorted=!1,i},"nodeset",!1,[]],"local-name":[function(e){var t;switch(arguments.length){case 0:t=this.node;break;case 1:if((e=e.evaluate(this)).isNodeSet){t=e.first();break}default:throw Error("Function local-name expects (nodeset?)")}return""+t.nodeName.toLowerCase()},"string",!1,[!0,!1]],name:[function(e){return FunctionCall.funcs["local-name"][0].apply(this,arguments)},"string",!1,[!0,!1]],"namespace-uri":[function(e){return""},"string",!1,[!0,!1]],string:[function(e){switch(arguments.length){case 0:e=NodeUtil.to("string",this.node);break;case 1:e=e.string(this);break;default:throw Error("Function string expects (object?)")}return e},"string",!1,[!0,!1]],concat:[function(e,t){if(arguments.length<2)throw Error("Function concat expects (string, string[, ...])");for(var i="",r=0,n=arguments.length;r<n;r++)i+=arguments[r].string(this);return i},"string",!1,[]],"starts-with":[function(e,t){if(2!=arguments.length)throw Error("Function starts-with expects (string, string)");return e=e.string(this),t=t.string(this),0==e.indexOf(t)},"boolean",!1,[]],contains:[function(e,t){if(2!=arguments.length)throw Error("Function contains expects (string, string)");return e=e.string(this),t=t.string(this),-1!=e.indexOf(t)},"boolean",!1,[]],substring:[function(e,t,i){var r,n;switch(e=e.string(this),t=t.number(this),arguments.length){case 2:i=e.length-t+1;break;case 3:i=i.number(this);break;default:throw Error("Function substring expects (string, string)")}return r=(t=Math.round(t))-1,(n=t+(i=Math.round(i))-1)==1/0?e.substring(r<0?0:r):e.substring(r<0?0:r,n)},"string",!1,[]],"substring-before":[function(e,t){var i;if(2!=arguments.length)throw Error("Function substring-before expects (string, string)");return e=e.string(this),t=t.string(this),-1==(i=e.indexOf(t))?"":e.substring(0,i)},"string",!1,[]],"substring-after":[function(e,t){if(2!=arguments.length)throw Error("Function substring-after expects (string, string)");e=e.string(this),t=t.string(this);var i=e.indexOf(t);return-1==i?"":e.substring(i+t.length)},"string",!1,[]],"string-length":[function(e){switch(arguments.length){case 0:e=NodeUtil.to("string",this.node);break;case 1:e=e.string(this);break;default:throw Error("Function string-length expects (string?)")}return e.length},"number",!1,[!0,!1]],"normalize-space":[function(e){switch(arguments.length){case 0:e=NodeUtil.to("string",this.node);break;case 1:e=e.string(this);break;default:throw Error("Function normalize-space expects (string?)")}return e.replace(/\s+/g," ").replace(/^ /,"").replace(/ $/,"")},"string",!1,[!0,!1]],translate:[function(e,t,i){if(3!=arguments.length)throw Error("Function translate expects (string, string, string)");e=e.string(this),t=t.string(this),i=i.string(this);for(var r=[],n=0,o=t.length;n<o;n++){r[s=t.charAt(n)]||(r[s]=i.charAt(n)||"")}var a="";for(n=0,o=e.length;n<o;n++){var s,c=r[s=e.charAt(n)];a+=c!=undefined?c:s}return a},"string",!1,[]],boolean:[function(e){if(1!=arguments.length)throw Error("Function boolean expects (object)");return e.bool(this)},"boolean",!1,[]],not:[function(e){if(1!=arguments.length)throw Error("Function not expects (object)");return!e.bool(this)},"boolean",!1,[]],true:[function(){if(0!=arguments.length)throw Error("Function true expects ()");return!0},"boolean",!1,[]],false:[function(){if(0!=arguments.length)throw Error("Function false expects ()");return!1},"boolean",!1,[]],lang:[function(e){return!1},"boolean",!1,[]],number:[function(e){switch(arguments.length){case 0:e=NodeUtil.to("number",this.node);break;case 1:e=e.number(this);break;default:throw Error("Function number expects (object?)")}return e},"number",!1,[!0,!1]],sum:[function(e){var t,i,r,n;if(1!=arguments.length||!(e=e.evaluate(this)).isNodeSet)throw Error("Function sum expects (nodeset)");for(i=0,r=0,n=(t=e.list()).length;r<n;r++)i+=NodeUtil.to("number",t[r]);return i},"number",!1,[]],floor:[function(e){if(1!=arguments.length)throw Error("Function floor expects (number)");return e=e.number(this),Math.floor(e)},"number",!1,[]],ceiling:[function(e){if(1!=arguments.length)throw Error("Function ceiling expects (number)");return e=e.number(this),Math.ceil(e)},"number",!1,[]],round:[function(e){if(1!=arguments.length)throw Error("Function round expects (number)");return e=e.number(this),Math.round(e)},"number",!1,[]]},FunctionCall.parse=function(e){var t,i=new FunctionCall(e.next());for(e.next();")"!=e.peek();){if(e.empty())throw Error("missing function argument list");if(t=BinaryExpr.parse(e),i.arg(t),","!=e.peek())break;e.next()}if(e.empty())throw Error("unclosed function argument list");if(")"!=e.next())throw e.back(),Error("bad token: "+e.next());return i},FunctionCall.prototype=new BaseExpr,FunctionCall.prototype.evaluate=function(e){return this.func.apply(e,this.args)},FunctionCall.prototype.arg=function(e){this.args.push(e),e.needContextPosition&&(this.needContextPosition=!0);var t=this.args;e.needContextNode&&(t.needContexNode=!0),this.needContextNode=t.needContextNode||this.needContextNodeInfo[t.length]},FunctionCall.prototype.show=function(e){var t="";if(t+=(e=e||"")+"function: "+this.name+"\n",e+="    ",this.args.length){t+=e+"arguments: \n",e+="    ";for(var i=0;i<this.args.length;i++)t+=this.args[i].show(e)}return t};var NodeID={uuid:1,get:function(e){return e.__jsxpath_id__||(e.__jsxpath_id__=this.uuid++)}};!window.NodeSet&&window.defaultConfig&&(window.NodeSet=null),NodeSet=function(){this.length=0,this.nodes=[],this.seen={},this.idIndexMap=null,this.reserveDels=[]},NodeSet.prototype.isNodeSet=!0,NodeSet.prototype.isSorted=!0,NodeSet.prototype.merge=function(e){if(this.isSorted=!1,e.only)return this.push(e.only);if(this.only){var t=this.only;delete this.only,this.push(t),this.length--}for(var i=e.nodes,r=0,n=i.length;r<n;r++)this._add(i[r])},NodeSet.prototype.sort=function(){this.only||(this.sortOff||this.isSorted||(this.isSorted=!0,this.idIndexMap=null,this.nodes.sort(function(e,t){if(e==t)return 0;if(e.compareDocumentPosition){var i=e.compareDocumentPosition(t);return 2&i?1:4&i?-1:0}for(var r=e,n=t,o=e,a=t,s=0,c=0;o=o.parentNode;)s++;for(;a=a.parentNode;)c++;if(s>c){for(;s--!=c;)r=r.parentNode;if(r==n)return 1}else if(c>s){for(;c--!=s;)n=n.parentNode;if(r==n)return-1}for(;(o=r.parentNode)!=(a=n.parentNode);)r=o,n=a;for(;r=r.nextSibling;)if(r==n)return-1;return 1})))},NodeSet.prototype.reserveDelByNodeID=function(e,t,i){var r;if((r=this.createIdIndexMap()[e])&&(i&&this.length-t-1>r||!i&&t<r)){var n={value:r,order:String.fromCharCode(r),toString:function(){return this.order},valueOf:function(){return this.value}};this.reserveDels.push(n)}},NodeSet.prototype.reserveDelByNode=function(e,t,i){this.reserveDelByNodeID(NodeID.get(e),t,i)},NodeSet.prototype.doDel=function(){if(this.reserveDels.length){if(this.length<65536)var e=this.reserveDels.sort(function(e,t){return t-e});else e=this.reserveDels.sort(function(e,t){return t-e});for(var t=0,i=e.length;t<i;t++)this.del(e[t]);this.reserveDels=[],this.idIndexMap=null}},NodeSet.prototype.createIdIndexMap=function(){if(this.idIndexMap)return this.idIndexMap;for(var e=this.idIndexMap={},t=this.nodes,i=0,r=t.length;i<r;i++){var n=t[i];e[NodeID.get(n)]=i}return e},NodeSet.prototype.del=function(e){if(this.length--,this.only)delete this.only;else{var t=this.nodes.splice(e,1)[0];this._first==t&&(delete this._first,delete this._firstSourceIndex,delete this._firstSubIndex),delete this.seen[NodeID.get(t)]}},NodeSet.prototype.delDescendant=function(e,t){if(!this.only){var i=e.nodeType;if((1==i||9==i)&&!uai.applewebkit2){if(!e.contains)if(1==i){var r=e;e={contains:function(e){return 8&e.compareDocumentPosition(r)}}}else e={contains:function(){return!0}};for(var n=this.nodes,o=t+1;o<n.length;o++)e.contains(n[o])&&(this.del(o),o--)}}},NodeSet.prototype._add=function(e,t){var i=this.seen,r=NodeID.get(e);if(i[r])return!0;i[r]=!0,this.length++,t?this.nodes.unshift(e):this.nodes.push(e)},NodeSet.prototype.unshift=function(e){if(!this.length)return this.length++,void(this.only=e);if(this.only){var t=this.only;delete this.only,this.unshift(t),this.length--}return this._add(e,!0)},NodeSet.prototype.push=function(e){if(!this.length)return this.length++,void(this.only=e);if(this.only){var t=this.only;delete this.only,this.push(t),this.length--}return this._add(e)},NodeSet.prototype.first=function(){return this.only?this.only:(this.nodes.length>1&&this.sort(),this.nodes[0])},NodeSet.prototype.list=function(){return this.only?[this.only]:(this.sort(),this.nodes)},NodeSet.prototype.string=function(){var e=this.only||this.first();return e?NodeUtil.to("string",e):""},NodeSet.prototype.bool=function(){return!(!this.length&&!this.only)},NodeSet.prototype.number=function(){return+this.string()},NodeSet.prototype.iterator=function(e){this.sort();var t=this;if(e){i=0;return function(){var e=t.length-i++-1;return t.only&&0==e?t.only:t.nodes[e]}}var i=0;return function(){return t.only&&0==i++?t.only:t.nodes[i++]}};var install=function(e){var t=(e=e||this).document;e.undefined;e.XPathExpression=function(t){if(!t.length)throw e.Error("no expression");var i=this.lexer=Lexer(t);if(i.empty())throw e.Error("no expression");if(this.expr=BinaryExpr.parse(i),!i.empty())throw e.Error("bad token: "+i.next())},e.XPathExpression.prototype.evaluate=function(t,i){return new e.XPathResult(this.expr.evaluate(new Ctx(t)),i)},e.XPathResult=function(e,t){if(0==t)switch(typeof e){case"object":t++;case"boolean":t++;case"string":t++;case"number":t++}switch(this.resultType=t,t){case 1:return void(this.numberValue=e.isNodeSet?e.number():+e);case 2:return void(this.stringValue=e.isNodeSet?e.string():""+e);case 3:return void(this.booleanValue=e.isNodeSet?e.bool():!!e);case 4:case 5:case 6:case 7:this.nodes=e.list(),this.snapshotLength=e.length,this.index=0,this.invalidIteratorState=!1;break;case 8:case 9:return void(this.singleNodeValue=e.first())}},e.XPathResult.prototype.iterateNext=function(){return this.nodes[this.index++]},e.XPathResult.prototype.snapshotItem=function(e){return this.nodes[e]},e.XPathResult.ANY_TYPE=0,e.XPathResult.NUMBER_TYPE=1,e.XPathResult.STRING_TYPE=2,e.XPathResult.BOOLEAN_TYPE=3,e.XPathResult.UNORDERED_NODE_ITERATOR_TYPE=4,e.XPathResult.ORDERED_NODE_ITERATOR_TYPE=5,e.XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE=6,e.XPathResult.ORDERED_NODE_SNAPSHOT_TYPE=7,e.XPathResult.ANY_UNORDERED_NODE_TYPE=8,e.XPathResult.FIRST_ORDERED_NODE_TYPE=9,t.createExpression=function(t){return new e.XPathExpression(t,null)},t.evaluate=function(e,i,r,n){return t.createExpression(e,null).evaluate(i,n)}},win;if(config.targetFrame){var frame=document.getElementById(config.targetFrame);frame&&(win=frame.contentWindow)}config.exportInstaller&&(window.install=install),config.hasNative&&config.useNative||install(win||window)}}(),Map=function(){this.map=new Object},Map.prototype={put:function(e,t){this.map[e]=t},get:function(e){return this.map[e]},containsKey:function(e){return e in this.map},containsValue:function(e){for(var t in this.map)if(this.map[t]===e)return!0;return!1},isEmpty:function(e){return 0===this.size()},clear:function(){for(var e in this.map)delete this.map[e]},remove:function(e){delete this.map[e]},keys:function(){var e=new Array;for(var t in this.map)e.push(t);return e},values:function(){var e=new Array;for(var t in this.map)e.push(this.map[t]);return e},size:function(){var e=0;for(var t in this.map)e++;return e}},void 0===Date.now&&(Date.now=function(){return(new Date).valueOf()});var TWEEN=TWEEN||function(){var e=[];return{REVISION:"14",getAll:function(){return e},removeAll:function(){e=[]},add:function(t){e.push(t)},remove:function(t){var i=e.indexOf(t);-1!==i&&e.splice(i,1)},update:function(t){if(0===e.length)return!1;var i=0;for(t=void 0!==t?t:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();i<e.length;)e[i].update(t)?i++:e.splice(i,1);return!0}}}();TWEEN.Tween=function(e){var t=e,i={},r={},n={},o=1e3,a=0,s=!1,c=!1,l=!1,h=0,u=null,d=TWEEN.Easing.Linear.None,p=TWEEN.Interpolation.Linear,f=[],m=null,g=!1,v=null,y=null,E=null;for(var x in e)i[x]=parseFloat(e[x],10);this.to=function(e,t){return void 0!==t&&(o=t),r=e,this},this.start=function(e){for(var o in TWEEN.add(this),c=!0,g=!1,u=void 0!==e?e:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),u+=h,r){if(r[o]instanceof Array){if(0===r[o].length)continue;r[o]=[t[o]].concat(r[o])}i[o]=t[o],i[o]instanceof Array==!1&&(i[o]*=1),n[o]=i[o]||0}return this},this.stop=function(){return c?(TWEEN.remove(this),c=!1,null!==E&&E.call(t),this.stopChainedTweens(),this):this},this.stopChainedTweens=function(){for(var e=0,t=f.length;e<t;e++)f[e].stop()},this.delay=function(e){return h=e,this},this.repeat=function(e){return a=e,this},this.yoyo=function(e){return s=e,this},this.easing=function(e){return d=e,this},this.interpolation=function(e){return p=e,this},this.chain=function(){return f=arguments,this},this.onStart=function(e){return m=e,this},this.onUpdate=function(e){return v=e,this},this.onComplete=function(e){return y=e,this},this.onStop=function(e){return E=e,this},this.update=function(e){var c;if(e<u)return!0;!1===g&&(null!==m&&m.call(t),g=!0);var E=(e-u)/o,x=d(E=E>1?1:E);for(c in r){var b=i[c]||0,w=r[c];w instanceof Array?t[c]=p(w,x):("string"==typeof w&&(w=b+parseFloat(w,10)),"number"==typeof w&&(t[c]=b+(w-b)*x))}if(null!==v&&v.call(t,x),1==E){if(a>0){for(c in isFinite(a)&&a--,n){if("string"==typeof r[c]&&(n[c]=n[c]+parseFloat(r[c],10)),s){var T=n[c];n[c]=r[c],r[c]=T}i[c]=n[c]}return s&&(l=!l),u=e+h,!0}null!==y&&y.call(t);for(var M=0,S=f.length;M<S;M++)f[M].start(e);return!1}return!0}},TWEEN.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))},Out:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)},InOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*.5+1)}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-TWEEN.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*TWEEN.Easing.Bounce.In(2*e):.5*TWEEN.Easing.Bounce.Out(2*e-1)+.5}}},TWEEN.Interpolation={Linear:function(e,t){var i=e.length-1,r=i*t,n=Math.floor(r),o=TWEEN.Interpolation.Utils.Linear;return t<0?o(e[0],e[1],r):t>1?o(e[i],e[i-1],i-r):o(e[n],e[n+1>i?i:n+1],r-n)},Bezier:function(e,t){var i,r=0,n=e.length-1,o=Math.pow,a=TWEEN.Interpolation.Utils.Bernstein;for(i=0;i<=n;i++)r+=o(1-t,n-i)*o(t,i)*e[i]*a(n,i);return r},CatmullRom:function(e,t){var i=e.length-1,r=i*t,n=Math.floor(r),o=TWEEN.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(n=Math.floor(r=i*(1+t))),o(e[(n-1+i)%i],e[n],e[(n+1)%i],e[(n+2)%i],r-n)):t<0?e[0]-(o(e[0],e[0],e[1],e[1],-r)-e[0]):t>1?e[i]-(o(e[i],e[i],e[i-1],e[i-1],r-i)-e[i]):o(e[n?n-1:0],e[n],e[i<n+1?i:n+1],e[i<n+2?i:n+2],r-n)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=TWEEN.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:function(){var e=[1];return function(t){var i,r=1;if(e[t])return e[t];for(i=t;i>1;i--)r*=i;return e[t]=r}}(),CatmullRom:function(e,t,i,r,n){var o=.5*(i-e),a=.5*(r-t),s=n*n;return(2*t-2*i+o+a)*(n*s)+(-3*t+3*i-2*o-a)*s+o*n+t}}},"undefined"!=typeof module&&module.exports&&(module.exports=TWEEN),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.THREE=e.THREE||{})}(this,function(e){"use strict";function t(){}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:e>0?1:+e}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),i=1;i<arguments.length;i++){var r=arguments[i];if(void 0!==r&&null!==r)for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}),Object.assign(t.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},removeEventListener:function(e,t){if(void 0!==this._listeners){var i=this._listeners[e];if(void 0!==i){var r=i.indexOf(t);-1!==r&&i.splice(r,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=t.slice(0),r=0,n=i.length;r<n;r++)i[r].call(this,e)}}}});var i,r,n,o,a,s,c="87",l=0,h=1,u=2,d=0,p=1,f=2,m=0,g=1,v=2,y=0,E=1,x=2,b=0,w=1,T=2,M=3,S=4,R=5,A=100,_=101,D=102,C=103,L=104,P=200,H=201,B=202,I=203,O=204,U=205,N=206,V=207,F=208,z=209,j=210,k=0,G=1,W=2,X=3,Y=4,q=5,Z=6,J=7,Q=0,K=1,$=2,ee=0,te=1,ie=2,re=3,ne=4,oe=301,ae=302,se=303,ce=304,le=305,he=306,ue=307,de=1e3,pe=1001,fe=1002,me=1003,ge=1004,ve=1005,ye=1006,Ee=1007,xe=1008,be=1009,we=1010,Te=1011,Me=1012,Se=1013,Re=1014,Ae=1015,_e=1016,De=1017,Ce=1018,Le=1019,Pe=1020,He=1021,Be=1022,Ie=1023,Oe=1024,Ue=1025,Ne=Ie,Ve=1026,Fe=1027,ze=2001,je=2002,ke=2003,Ge=2004,We=2100,Xe=2101,Ye=2102,qe=2103,Ze=2151,Je=2201,Qe=2400,Ke=0,$e=1,et=2,tt=3e3,it=3001,rt=3007,nt=3002,ot=3004,at=3005,st=3006,ct=3200,lt=3201,ht={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:(r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=new Array(36),o=0,function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?n[e]="-":14===e?n[e]="4":(o<=2&&(o=33554432+16777216*Math.random()|0),i=15&o,o>>=4,n[e]=r[19===e?3&i|8:i]);return n.join("")}),clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,i,r,n){return r+(e-t)*(n-r)/(i-t)},lerp:function(e,t,i){return(1-i)*e+i*t},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*ht.DEG2RAD},radToDeg:function(e){return e*ht.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}};function ut(e,t){this.x=e||0,this.y=t||0}Object.defineProperties(ut.prototype,{width:{get:function(){return this.x},set:function(e){this.x=e}},height:{get:function(){return this.y},set:function(e){this.y=e}}}),Object.assign(ut.prototype,{isVector2:!0,set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:(a=new ut,s=new ut,function(e,t){return a.set(e,e),s.set(t,t),this.clamp(a,s)}),clampLength:function(e,t){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,i=this.y-e.y;return t*t+i*i},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this},rotateAround:function(e,t){var i=Math.cos(t),r=Math.sin(t),n=this.x-e.x,o=this.y-e.y;return this.x=n*i-o*r+e.x,this.y=n*r+o*i+e.y,this}});var dt,pt,ft,mt,gt,vt,yt=0;function Et(e,t,i,r,n,o,a,s,c,l){Object.defineProperty(this,"id",{value:yt++}),this.uuid=ht.generateUUID(),this.name="",this.image=void 0!==e?e:Et.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:Et.DEFAULT_MAPPING,this.wrapS=void 0!==i?i:pe,this.wrapT=void 0!==r?r:pe,this.magFilter=void 0!==n?n:ye,this.minFilter=void 0!==o?o:xe,this.anisotropy=void 0!==c?c:1,this.format=void 0!==a?a:Ie,this.type=void 0!==s?s:be,this.offset=new ut(0,0),this.repeat=new ut(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==l?l:tt,this.version=0,this.onUpdate=null}function xt(e,t,i,r){this.x=e||0,this.y=t||0,this.z=i||0,this.w=void 0!==r?r:1}function bt(e,t,i){this.uuid=ht.generateUUID(),this.width=e,this.height=t,this.scissor=new xt(0,0,e,t),this.scissorTest=!1,this.viewport=new xt(0,0,e,t),void 0===(i=i||{}).minFilter&&(i.minFilter=ye),this.texture=new Et(void 0,void 0,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0===i.stencilBuffer||i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}function wt(e,t,i){bt.call(this,e,t,i),this.activeCubeFace=0,this.activeMipMapLevel=0}function Tt(e,t,i,r){this._x=e||0,this._y=t||0,this._z=i||0,this._w=void 0!==r?r:1}function Mt(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}function St(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function Rt(e,t,i,r,n,o,a,s,c,l,h,u){Et.call(this,null,o,a,s,c,l,r,n,h,u),this.image={data:e,width:t,height:i},this.magFilter=void 0!==c?c:me,this.minFilter=void 0!==l?l:me,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function At(e,t,i,r,n,o,a,s,c,l){e=void 0!==e?e:[],t=void 0!==t?t:oe,Et.call(this,e,t,i,r,n,o,a,s,c,l),this.flipY=!1}Et.DEFAULT_IMAGE=void 0,Et.DEFAULT_MAPPING=300,Object.defineProperty(Et.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(Et.prototype,t.prototype,{constructor:Et,isTexture:!0,clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this},toJSON:function(e){if(void 0!==e.textures[this.uuid])return e.textures[this.uuid];var t={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],wrap:[this.wrapS,this.wrapT],minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY};if(void 0!==this.image){var i=this.image;void 0===i.uuid&&(i.uuid=ht.generateUUID()),void 0===e.images[i.uuid]&&(e.images[i.uuid]={uuid:i.uuid,url:function(e){var t;if(e instanceof HTMLCanvasElement)t=e;else{(t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")).width=e.width,t.height=e.height;var i=t.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height)}return t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}(i)}),t.image=i.uuid}return e.textures[this.uuid]=t,t},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(300===this.mapping){if(e.multiply(this.repeat),e.add(this.offset),e.x<0||e.x>1)switch(this.wrapS){case de:e.x=e.x-Math.floor(e.x);break;case pe:e.x=e.x<0?0:1;break;case fe:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case de:e.y=e.y-Math.floor(e.y);break;case pe:e.y=e.y<0?0:1;break;case fe:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}}}),Object.assign(xt.prototype,{isVector4:!0,set:function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,i=this.y,r=this.z,n=this.w,o=e.elements;return this.x=o[0]*t+o[4]*i+o[8]*r+o[12]*n,this.y=o[1]*t+o[5]*i+o[9]*r+o[13]*n,this.z=o[2]*t+o[6]*i+o[10]*r+o[14]*n,this.w=o[3]*t+o[7]*i+o[11]*r+o[15]*n,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,i,r,n,o=e.elements,a=o[0],s=o[4],c=o[8],l=o[1],h=o[5],u=o[9],d=o[2],p=o[6],f=o[10];if(Math.abs(s-l)<.01&&Math.abs(c-d)<.01&&Math.abs(u-p)<.01){if(Math.abs(s+l)<.1&&Math.abs(c+d)<.1&&Math.abs(u+p)<.1&&Math.abs(a+h+f-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;var m=(a+1)/2,g=(h+1)/2,v=(f+1)/2,y=(s+l)/4,E=(c+d)/4,x=(u+p)/4;return m>g&&m>v?m<.01?(i=0,r=.707106781,n=.707106781):(r=y/(i=Math.sqrt(m)),n=E/i):g>v?g<.01?(i=.707106781,r=0,n=.707106781):(i=y/(r=Math.sqrt(g)),n=x/r):v<.01?(i=.707106781,r=.707106781,n=0):(i=E/(n=Math.sqrt(v)),r=x/n),this.set(i,r,n,t),this}var b=Math.sqrt((p-u)*(p-u)+(c-d)*(c-d)+(l-s)*(l-s));return Math.abs(b)<.001&&(b=1),this.x=(p-u)/b,this.y=(c-d)/b,this.z=(l-s)/b,this.w=Math.acos((a+h+f-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(){var e,t;return function(i,r){return void 0===e&&(e=new xt,t=new xt),e.set(i,i,i,i),t.set(r,r,r,r),this.clamp(e,t)}}(),clampLength:function(e,t){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}}),Object.assign(bt.prototype,t.prototype,{isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),wt.prototype=Object.create(bt.prototype),wt.prototype.constructor=wt,wt.prototype.isWebGLRenderTargetCube=!0,Object.assign(Tt,{slerp:function(e,t,i,r){return i.copy(e).slerp(t,r)},slerpFlat:function(e,t,i,r,n,o,a){var s=i[r+0],c=i[r+1],l=i[r+2],h=i[r+3],u=n[o+0],d=n[o+1],p=n[o+2],f=n[o+3];if(h!==f||s!==u||c!==d||l!==p){var m=1-a,g=s*u+c*d+l*p+h*f,v=g>=0?1:-1,y=1-g*g;if(y>Number.EPSILON){var E=Math.sqrt(y),x=Math.atan2(E,g*v);m=Math.sin(m*x)/E,a=Math.sin(a*x)/E}var b=a*v;if(s=s*m+u*b,c=c*m+d*b,l=l*m+p*b,h=h*m+f*b,m===1-a){var w=1/Math.sqrt(s*s+c*c+l*l+h*h);s*=w,c*=w,l*=w,h*=w}}e[t]=s,e[t+1]=c,e[t+2]=l,e[t+3]=h}}),Object.defineProperties(Tt.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this.onChangeCallback()}}}),Object.assign(Tt.prototype,{set:function(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var i=e._x,r=e._y,n=e._z,o=e.order,a=Math.cos,s=Math.sin,c=a(i/2),l=a(r/2),h=a(n/2),u=s(i/2),d=s(r/2),p=s(n/2);return"XYZ"===o?(this._x=u*l*h+c*d*p,this._y=c*d*h-u*l*p,this._z=c*l*p+u*d*h,this._w=c*l*h-u*d*p):"YXZ"===o?(this._x=u*l*h+c*d*p,this._y=c*d*h-u*l*p,this._z=c*l*p-u*d*h,this._w=c*l*h+u*d*p):"ZXY"===o?(this._x=u*l*h-c*d*p,this._y=c*d*h+u*l*p,this._z=c*l*p+u*d*h,this._w=c*l*h-u*d*p):"ZYX"===o?(this._x=u*l*h-c*d*p,this._y=c*d*h+u*l*p,this._z=c*l*p-u*d*h,this._w=c*l*h+u*d*p):"YZX"===o?(this._x=u*l*h+c*d*p,this._y=c*d*h+u*l*p,this._z=c*l*p-u*d*h,this._w=c*l*h-u*d*p):"XZY"===o&&(this._x=u*l*h-c*d*p,this._y=c*d*h-u*l*p,this._z=c*l*p+u*d*h,this._w=c*l*h+u*d*p),!1!==t&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var i=t/2,r=Math.sin(i);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(i),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,i=e.elements,r=i[0],n=i[4],o=i[8],a=i[1],s=i[5],c=i[9],l=i[2],h=i[6],u=i[10],d=r+s+u;return d>0?(t=.5/Math.sqrt(d+1),this._w=.25/t,this._x=(h-c)*t,this._y=(o-l)*t,this._z=(a-n)*t):r>s&&r>u?(t=2*Math.sqrt(1+r-s-u),this._w=(h-c)/t,this._x=.25*t,this._y=(n+a)/t,this._z=(o+l)/t):s>u?(t=2*Math.sqrt(1+s-r-u),this._w=(o-l)/t,this._x=(n+a)/t,this._y=.25*t,this._z=(c+h)/t):(t=2*Math.sqrt(1+u-r-s),this._w=(a-n)/t,this._x=(o+l)/t,this._y=(c+h)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t=new Mt;return function(i,r){return void 0===t&&(t=new Mt),(e=i.dot(r)+1)<1e-6?(e=0,Math.abs(i.x)>Math.abs(i.z)?t.set(-i.y,i.x,0):t.set(0,-i.z,i.y)):t.crossVectors(i,r),this._x=t.x,this._y=t.y,this._z=t.z,this._w=e,this.normalize()}}(),inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var i=e._x,r=e._y,n=e._z,o=e._w,a=t._x,s=t._y,c=t._z,l=t._w;return this._x=i*l+o*a+r*c-n*s,this._y=r*l+o*s+n*a-i*c,this._z=n*l+o*c+i*s-r*a,this._w=o*l-i*a-r*s-n*c,this.onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var i=this._x,r=this._y,n=this._z,o=this._w,a=o*e._w+i*e._x+r*e._y+n*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=o,this._x=i,this._y=r,this._z=n,this;var s=Math.sqrt(1-a*a);if(Math.abs(s)<.001)return this._w=.5*(o+this._w),this._x=.5*(i+this._x),this._y=.5*(r+this._y),this._z=.5*(n+this._z),this;var c=Math.atan2(s,a),l=Math.sin((1-t)*c)/s,h=Math.sin(t*c)/s;return this._w=o*l+this._w*h,this._x=i*l+this._x*h,this._y=r*l+this._y*h,this._z=n*l+this._z*h,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(Mt.prototype,{isVector3:!0,set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:(ft=new Tt,function(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(ft.setFromEuler(e))}),applyAxisAngle:function(){var e=new Tt;return function(t,i){return this.applyQuaternion(e.setFromAxisAngle(t,i))}}(),applyMatrix3:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6]*r,this.y=n[1]*t+n[4]*i+n[7]*r,this.z=n[2]*t+n[5]*i+n[8]*r,this},applyMatrix4:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements,o=1/(n[3]*t+n[7]*i+n[11]*r+n[15]);return this.x=(n[0]*t+n[4]*i+n[8]*r+n[12])*o,this.y=(n[1]*t+n[5]*i+n[9]*r+n[13])*o,this.z=(n[2]*t+n[6]*i+n[10]*r+n[14])*o,this},applyQuaternion:function(e){var t=this.x,i=this.y,r=this.z,n=e.x,o=e.y,a=e.z,s=e.w,c=s*t+o*r-a*i,l=s*i+a*t-n*r,h=s*r+n*i-o*t,u=-n*t-o*i-a*r;return this.x=c*s+u*-n+l*-a-h*-o,this.y=l*s+u*-o+h*-n-c*-a,this.z=h*s+u*-a+c*-o-l*-n,this},project:(pt=new St,function(e){return pt.multiplyMatrices(e.projectionMatrix,pt.getInverse(e.matrixWorld)),this.applyMatrix4(pt)}),unproject:function(){var e=new St;return function(t){return e.multiplyMatrices(t.matrixWorld,e.getInverse(t.projectionMatrix)),this.applyMatrix4(e)}}(),transformDirection:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*r,this.y=n[1]*t+n[5]*i+n[9]*r,this.z=n[2]*t+n[6]*i+n[10]*r,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:function(){var e=new Mt,t=new Mt;return function(i,r){return e.set(i,i,i),t.set(r,r,r),this.clamp(e,t)}}(),clampLength:function(e,t){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},cross:function(e,t){if(void 0!==t)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var i=this.x,r=this.y,n=this.z;return this.x=r*e.z-n*e.y,this.y=n*e.x-i*e.z,this.z=i*e.y-r*e.x,this},crossVectors:function(e,t){var i=e.x,r=e.y,n=e.z,o=t.x,a=t.y,s=t.z;return this.x=r*s-n*a,this.y=n*o-i*s,this.z=i*a-r*o,this},projectOnVector:function(e){var t=e.dot(this)/e.lengthSq();return this.copy(e).multiplyScalar(t)},projectOnPlane:(dt=new Mt,function(e){return dt.copy(this).projectOnVector(e),this.sub(dt)}),reflect:function(){var e=new Mt;return function(t){return this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/Math.sqrt(this.lengthSq()*e.lengthSq());return Math.acos(ht.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,i=this.y-e.y,r=this.z-e.z;return t*t+i*i+r*r},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(e){var t=Math.sin(e.phi)*e.radius;return this.x=t*Math.sin(e.theta),this.y=Math.cos(e.phi)*e.radius,this.z=t*Math.cos(e.theta),this},setFromCylindrical:function(e){return this.x=e.radius*Math.sin(e.theta),this.y=e.y,this.z=e.radius*Math.cos(e.theta),this},setFromMatrixPosition:function(e){var t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this},setFromMatrixScale:function(e){var t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),r=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=r,this},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}}),Object.assign(St.prototype,{isMatrix4:!0,set:function(e,t,i,r,n,o,a,s,c,l,h,u,d,p,f,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=r,g[1]=n,g[5]=o,g[9]=a,g[13]=s,g[2]=c,g[6]=l,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new St).fromArray(this.elements)},copy:function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this},copyPosition:function(e){var t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this},extractBasis:function(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this},extractRotation:function(){var e=new Mt;return function(t){var i=this.elements,r=t.elements,n=1/e.setFromMatrixColumn(t,0).length(),o=1/e.setFromMatrixColumn(t,1).length(),a=1/e.setFromMatrixColumn(t,2).length();return i[0]=r[0]*n,i[1]=r[1]*n,i[2]=r[2]*n,i[4]=r[4]*o,i[5]=r[5]*o,i[6]=r[6]*o,i[8]=r[8]*a,i[9]=r[9]*a,i[10]=r[10]*a,this}}(),makeRotationFromEuler:function(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,i=e.x,r=e.y,n=e.z,o=Math.cos(i),a=Math.sin(i),s=Math.cos(r),c=Math.sin(r),l=Math.cos(n),h=Math.sin(n);if("XYZ"===e.order){var u=o*l,d=o*h,p=a*l,f=a*h;t[0]=s*l,t[4]=-s*h,t[8]=c,t[1]=d+p*c,t[5]=u-f*c,t[9]=-a*s,t[2]=f-u*c,t[6]=p+d*c,t[10]=o*s}else if("YXZ"===e.order){var m=s*l,g=s*h,v=c*l,y=c*h;t[0]=m+y*a,t[4]=v*a-g,t[8]=o*c,t[1]=o*h,t[5]=o*l,t[9]=-a,t[2]=g*a-v,t[6]=y+m*a,t[10]=o*s}else if("ZXY"===e.order){m=s*l,g=s*h,v=c*l,y=c*h;t[0]=m-y*a,t[4]=-o*h,t[8]=v+g*a,t[1]=g+v*a,t[5]=o*l,t[9]=y-m*a,t[2]=-o*c,t[6]=a,t[10]=o*s}else if("ZYX"===e.order){u=o*l,d=o*h,p=a*l,f=a*h;t[0]=s*l,t[4]=p*c-d,t[8]=u*c+f,t[1]=s*h,t[5]=f*c+u,t[9]=d*c-p,t[2]=-c,t[6]=a*s,t[10]=o*s}else if("YZX"===e.order){var E=o*s,x=o*c,b=a*s,w=a*c;t[0]=s*l,t[4]=w-E*h,t[8]=b*h+x,t[1]=h,t[5]=o*l,t[9]=-a*l,t[2]=-c*l,t[6]=x*h+b,t[10]=E-w*h}else if("XZY"===e.order){E=o*s,x=o*c,b=a*s,w=a*c;t[0]=s*l,t[4]=-h,t[8]=c*l,t[1]=E*h+w,t[5]=o*l,t[9]=x*h-b,t[2]=b*h-x,t[6]=a*l,t[10]=w*h+E}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:function(e){var t=this.elements,i=e._x,r=e._y,n=e._z,o=e._w,a=i+i,s=r+r,c=n+n,l=i*a,h=i*s,u=i*c,d=r*s,p=r*c,f=n*c,m=o*a,g=o*s,v=o*c;return t[0]=1-(d+f),t[4]=h-v,t[8]=u+g,t[1]=h+v,t[5]=1-(l+f),t[9]=p-m,t[2]=u-g,t[6]=p+m,t[10]=1-(l+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:(mt=new Mt,gt=new Mt,vt=new Mt,function(e,t,i){var r=this.elements;return vt.subVectors(e,t),0===vt.lengthSq()&&(vt.z=1),vt.normalize(),mt.crossVectors(i,vt),0===mt.lengthSq()&&(1===Math.abs(i.z)?vt.x+=1e-4:vt.z+=1e-4,vt.normalize(),mt.crossVectors(i,vt)),mt.normalize(),gt.crossVectors(vt,mt),r[0]=mt.x,r[4]=gt.x,r[8]=vt.x,r[1]=mt.y,r[5]=gt.y,r[9]=vt.y,r[2]=mt.z,r[6]=gt.z,r[10]=vt.z,this}),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var i=e.elements,r=t.elements,n=this.elements,o=i[0],a=i[4],s=i[8],c=i[12],l=i[1],h=i[5],u=i[9],d=i[13],p=i[2],f=i[6],m=i[10],g=i[14],v=i[3],y=i[7],E=i[11],x=i[15],b=r[0],w=r[4],T=r[8],M=r[12],S=r[1],R=r[5],A=r[9],_=r[13],D=r[2],C=r[6],L=r[10],P=r[14],H=r[3],B=r[7],I=r[11],O=r[15];return n[0]=o*b+a*S+s*D+c*H,n[4]=o*w+a*R+s*C+c*B,n[8]=o*T+a*A+s*L+c*I,n[12]=o*M+a*_+s*P+c*O,n[1]=l*b+h*S+u*D+d*H,n[5]=l*w+h*R+u*C+d*B,n[9]=l*T+h*A+u*L+d*I,n[13]=l*M+h*_+u*P+d*O,n[2]=p*b+f*S+m*D+g*H,n[6]=p*w+f*R+m*C+g*B,n[10]=p*T+f*A+m*L+g*I,n[14]=p*M+f*_+m*P+g*O,n[3]=v*b+y*S+E*D+x*H,n[7]=v*w+y*R+E*C+x*B,n[11]=v*T+y*A+E*L+x*I,n[15]=v*M+y*_+E*P+x*O,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},applyToBufferAttribute:function(){var e=new Mt;return function(t){for(var i=0,r=t.count;i<r;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix4(this),t.setXYZ(i,e.x,e.y,e.z);return t}}(),determinant:function(){var e=this.elements,t=e[0],i=e[4],r=e[8],n=e[12],o=e[1],a=e[5],s=e[9],c=e[13],l=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+n*s*h-r*c*h-n*a*u+i*c*u+r*a*d-i*s*d)+e[7]*(+t*s*d-t*c*u+n*o*u-r*o*d+r*c*l-n*s*l)+e[11]*(+t*c*h-t*a*d-n*o*h+i*o*d+n*a*l-i*c*l)+e[15]*(-r*a*l-t*s*h+t*a*u+r*o*h-i*o*u+i*s*l)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var i=this.elements,r=e.elements,n=r[0],o=r[1],a=r[2],s=r[3],c=r[4],l=r[5],h=r[6],u=r[7],d=r[8],p=r[9],f=r[10],m=r[11],g=r[12],v=r[13],y=r[14],E=r[15],x=p*y*u-v*f*u+v*h*m-l*y*m-p*h*E+l*f*E,b=g*f*u-d*y*u-g*h*m+c*y*m+d*h*E-c*f*E,w=d*v*u-g*p*u+g*l*m-c*v*m-d*l*E+c*p*E,T=g*p*h-d*v*h-g*l*f+c*v*f+d*l*y-c*p*y,M=n*x+o*b+a*w+s*T;if(0===M){var S="THREE.Matrix4: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(S);return console.warn(S),this.identity()}var R=1/M;return i[0]=x*R,i[1]=(v*f*s-p*y*s-v*a*m+o*y*m+p*a*E-o*f*E)*R,i[2]=(l*y*s-v*h*s+v*a*u-o*y*u-l*a*E+o*h*E)*R,i[3]=(p*h*s-l*f*s-p*a*u+o*f*u+l*a*m-o*h*m)*R,i[4]=b*R,i[5]=(d*y*s-g*f*s+g*a*m-n*y*m-d*a*E+n*f*E)*R,i[6]=(g*h*s-c*y*s-g*a*u+n*y*u+c*a*E-n*h*E)*R,i[7]=(c*f*s-d*h*s+d*a*u-n*f*u-c*a*m+n*h*m)*R,i[8]=w*R,i[9]=(g*p*s-d*v*s-g*o*m+n*v*m+d*o*E-n*p*E)*R,i[10]=(c*v*s-g*l*s+g*o*u-n*v*u-c*o*E+n*l*E)*R,i[11]=(d*l*s-c*p*s-d*o*u+n*p*u+c*o*m-n*l*m)*R,i[12]=T*R,i[13]=(d*v*a-g*p*a+g*o*f-n*v*f-d*o*y+n*p*y)*R,i[14]=(g*l*a-c*v*a-g*o*h+n*v*h+c*o*y-n*l*y)*R,i[15]=(c*p*a-d*l*a+d*o*h-n*p*h-c*o*f+n*l*f)*R,this},scale:function(e){var t=this.elements,i=e.x,r=e.y,n=e.z;return t[0]*=i,t[4]*=r,t[8]*=n,t[1]*=i,t[5]*=r,t[9]*=n,t[2]*=i,t[6]*=r,t[10]*=n,t[3]*=i,t[7]*=r,t[11]*=n,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))},makeTranslation:function(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var i=Math.cos(t),r=Math.sin(t),n=1-i,o=e.x,a=e.y,s=e.z,c=n*o,l=n*a;return this.set(c*o+i,c*a-r*s,c*s+r*a,0,c*a+r*s,l*a+i,l*s-r*o,0,c*s-r*a,l*s+r*o,n*s*s+i,0,0,0,0,1),this},makeScale:function(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this},makeShear:function(e,t,i){return this.set(1,t,i,0,e,1,i,0,e,t,1,0,0,0,0,1),this},compose:function(e,t,i){return this.makeRotationFromQuaternion(t),this.scale(i),this.setPosition(e),this},decompose:function(){var e=new Mt,t=new St;return function(i,r,n){var o=this.elements,a=e.set(o[0],o[1],o[2]).length(),s=e.set(o[4],o[5],o[6]).length(),c=e.set(o[8],o[9],o[10]).length();this.determinant()<0&&(a=-a),i.x=o[12],i.y=o[13],i.z=o[14],t.copy(this);var l=1/a,h=1/s,u=1/c;return t.elements[0]*=l,t.elements[1]*=l,t.elements[2]*=l,t.elements[4]*=h,t.elements[5]*=h,t.elements[6]*=h,t.elements[8]*=u,t.elements[9]*=u,t.elements[10]*=u,r.setFromRotationMatrix(t),n.x=a,n.y=s,n.z=c,this}}(),makePerspective:function(e,t,i,r,n,o){void 0===o&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var a=this.elements,s=2*n/(t-e),c=2*n/(i-r),l=(t+e)/(t-e),h=(i+r)/(i-r),u=-(o+n)/(o-n),d=-2*o*n/(o-n);return a[0]=s,a[4]=0,a[8]=l,a[12]=0,a[1]=0,a[5]=c,a[9]=h,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this},makeOrthographic:function(e,t,i,r,n,o){var a=this.elements,s=1/(t-e),c=1/(i-r),l=1/(o-n),h=(t+e)*s,u=(i+r)*c,d=(o+n)*l;return a[0]=2*s,a[4]=0,a[8]=0,a[12]=-h,a[1]=0,a[5]=2*c,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*l,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},equals:function(e){for(var t=this.elements,i=e.elements,r=0;r<16;r++)if(t[r]!==i[r])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var i=0;i<16;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}),Rt.prototype=Object.create(Et.prototype),Rt.prototype.constructor=Rt,Rt.prototype.isDataTexture=!0,At.prototype=Object.create(Et.prototype),At.prototype.constructor=At,At.prototype.isCubeTexture=!0,Object.defineProperty(At.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}});var _t=new Et,Dt=new At;function Ct(){this.seq=[],this.map={}}var Lt=[],Pt=[],Ht=new Float32Array(16),Bt=new Float32Array(9);function It(e,t,i){var r=e[0];if(r<=0||r>0)return e;var n=t*i,o=Lt[n];if(void 0===o&&(o=new Float32Array(n),Lt[n]=o),0!==t){r.toArray(o,0);for(var a=1,s=0;a!==t;++a)s+=i,e[a].toArray(o,s)}return o}function Ot(e,t){var i=Pt[t];void 0===i&&(i=new Int32Array(t),Pt[t]=i);for(var r=0;r!==t;++r)i[r]=e.allocTextureUnit();return i}function Ut(e,t){e.uniform1f(this.addr,t)}function Nt(e,t){e.uniform1i(this.addr,t)}function Vt(e,t){void 0===t.x?e.uniform2fv(this.addr,t):e.uniform2f(this.addr,t.x,t.y)}function Ft(e,t){void 0!==t.x?e.uniform3f(this.addr,t.x,t.y,t.z):void 0!==t.r?e.uniform3f(this.addr,t.r,t.g,t.b):e.uniform3fv(this.addr,t)}function zt(e,t){void 0===t.x?e.uniform4fv(this.addr,t):e.uniform4f(this.addr,t.x,t.y,t.z,t.w)}function jt(e,t){e.uniformMatrix2fv(this.addr,!1,t.elements||t)}function kt(e,t){void 0===t.elements?e.uniformMatrix3fv(this.addr,!1,t):(Bt.set(t.elements),e.uniformMatrix3fv(this.addr,!1,Bt))}function Gt(e,t){void 0===t.elements?e.uniformMatrix4fv(this.addr,!1,t):(Ht.set(t.elements),e.uniformMatrix4fv(this.addr,!1,Ht))}function Wt(e,t,i){var r=i.allocTextureUnit();e.uniform1i(this.addr,r),i.setTexture2D(t||_t,r)}function Xt(e,t,i){var r=i.allocTextureUnit();e.uniform1i(this.addr,r),i.setTextureCube(t||Dt,r)}function Yt(e,t){e.uniform2iv(this.addr,t)}function qt(e,t){e.uniform3iv(this.addr,t)}function Zt(e,t){e.uniform4iv(this.addr,t)}function Jt(e,t){e.uniform1fv(this.addr,t)}function Qt(e,t){e.uniform1iv(this.addr,t)}function Kt(e,t){e.uniform2fv(this.addr,It(t,this.size,2))}function $t(e,t){e.uniform3fv(this.addr,It(t,this.size,3))}function ei(e,t){e.uniform4fv(this.addr,It(t,this.size,4))}function ti(e,t){e.uniformMatrix2fv(this.addr,!1,It(t,this.size,4))}function ii(e,t){e.uniformMatrix3fv(this.addr,!1,It(t,this.size,9))}function ri(e,t){e.uniformMatrix4fv(this.addr,!1,It(t,this.size,16))}function ni(e,t,i){var r=t.length,n=Ot(i,r);e.uniform1iv(this.addr,n);for(var o=0;o!==r;++o)i.setTexture2D(t[o]||_t,n[o])}function oi(e,t,i){var r=t.length,n=Ot(i,r);e.uniform1iv(this.addr,n);for(var o=0;o!==r;++o)i.setTextureCube(t[o]||Dt,n[o])}function ai(e,t,i){this.id=e,this.addr=i,this.setValue=function(e){switch(e){case 5126:return Ut;case 35664:return Vt;case 35665:return Ft;case 35666:return zt;case 35674:return jt;case 35675:return kt;case 35676:return Gt;case 35678:case 36198:return Wt;case 35680:return Xt;case 5124:case 35670:return Nt;case 35667:case 35671:return Yt;case 35668:case 35672:return qt;case 35669:case 35673:return Zt}}(t.type)}function si(e,t,i){this.id=e,this.addr=i,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return Jt;case 35664:return Kt;case 35665:return $t;case 35666:return ei;case 35674:return ti;case 35675:return ii;case 35676:return ri;case 35678:return ni;case 35680:return oi;case 5124:case 35670:return Qt;case 35667:case 35671:return Yt;case 35668:case 35672:return qt;case 35669:case 35673:return Zt}}(t.type)}function ci(e){this.id=e,Ct.call(this)}ci.prototype.setValue=function(e,t){for(var i=this.seq,r=0,n=i.length;r!==n;++r){var o=i[r];o.setValue(e,t[o.id])}};var li=/([\w\d_]+)(\])?(\[|\.)?/g;function hi(e,t){e.seq.push(t),e.map[t.id]=t}function ui(e,t,i){var r=e.name,n=r.length;for(li.lastIndex=0;;){var o=li.exec(r),a=li.lastIndex,s=o[1],c="]"===o[2],l=o[3];if(c&&(s|=0),void 0===l||"["===l&&a+2===n){hi(i,void 0===l?new ai(s,e,t):new si(s,e,t));break}var h=i.map[s];void 0===h&&hi(i,h=new ci(s)),i=h}}function di(e,t,i){Ct.call(this),this.renderer=i;for(var r=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),n=0;n<r;++n){var o=e.getActiveUniform(t,n),a=o.name;ui(o,e.getUniformLocation(t,a),this)}}di.prototype.setValue=function(e,t,i){var r=this.map[t];void 0!==r&&r.setValue(e,i,this.renderer)},di.prototype.setOptional=function(e,t,i){var r=t[i];void 0!==r&&this.setValue(e,i,r)},di.upload=function(e,t,i,r){for(var n=0,o=t.length;n!==o;++n){var a=t[n],s=i[a.id];!1!==s.needsUpdate&&a.setValue(e,s.value,r)}},di.seqWithValue=function(e,t){for(var i=[],r=0,n=e.length;r!==n;++r){var o=e[r];o.id in t&&i.push(o)}return i};var pi={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function fi(e,t,i){return void 0===t&&void 0===i?this.set(e):this.setRGB(e,t,i)}Object.assign(fi.prototype,{isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,i){return this.r=e,this.g=t,this.b=i,this},setHSL:function(){function e(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}return function(t,i,r){if(t=ht.euclideanModulo(t,1),i=ht.clamp(i,0,1),r=ht.clamp(r,0,1),0===i)this.r=this.g=this.b=r;else{var n=r<=.5?r*(1+i):r+i-r*i,o=2*r-n;this.r=e(o,n,t+1/3),this.g=e(o,n,t),this.b=e(o,n,t-1/3)}return this}}(),setStyle:function(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}var i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(e)){var r,n=i[1],o=i[2];switch(n){case"rgb":case"rgba":if(r=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,t(r[5]),this;if(r=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,t(r[5]),this;break;case"hsl":case"hsla":if(r=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o)){var a=parseFloat(r[1])/360,s=parseInt(r[2],10)/100,c=parseInt(r[3],10)/100;return t(r[5]),this.setHSL(a,s,c)}}}else if(i=/^\#([A-Fa-f0-9]+)$/.exec(e)){var l,h=(l=i[1]).length;if(3===h)return this.r=parseInt(l.charAt(0)+l.charAt(0),16)/255,this.g=parseInt(l.charAt(1)+l.charAt(1),16)/255,this.b=parseInt(l.charAt(2)+l.charAt(2),16)/255,this;if(6===h)return this.r=parseInt(l.charAt(0)+l.charAt(1),16)/255,this.g=parseInt(l.charAt(2)+l.charAt(3),16)/255,this.b=parseInt(l.charAt(4)+l.charAt(5),16)/255,this}e&&e.length>0&&(void 0!==(l=pi[e])?this.setHex(l):console.warn("THREE.Color: Unknown color "+e));return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var i=t>0?1/t:1;return this.r=Math.pow(e.r,i),this.g=Math.pow(e.g,i),this.b=Math.pow(e.b,i),this},convertGammaToLinear:function(){var e=this.r,t=this.g,i=this.b;return this.r=e*e,this.g=t*t,this.b=i*i,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){var t,i,r=e||{h:0,s:0,l:0},n=this.r,o=this.g,a=this.b,s=Math.max(n,o,a),c=Math.min(n,o,a),l=(c+s)/2;if(c===s)t=0,i=0;else{var h=s-c;switch(i=l<=.5?h/(s+c):h/(2-s-c),s){case n:t=(o-a)/h+(o<a?6:0);break;case o:t=(a-n)/h+2;break;case a:t=(n-o)/h+4}t/=6}return r.h=t,r.s=i,r.l=l,r},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,i){var r=this.getHSL();return r.h+=e,r.s+=t,r.l+=i,this.setHSL(r.h,r.s,r.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},toJSON:function(){return this.getHex()}});var mi={common:{diffuse:{value:new fi(15658734)},opacity:{value:1},map:{value:null},offsetRepeat:{value:new xt(0,0,1,1)},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new ut(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new fi(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new fi(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},offsetRepeat:{value:new xt(0,0,1,1)}}},gi={merge:function(e){for(var t={},i=0;i<e.length;i++){var r=this.clone(e[i]);for(var n in r)t[n]=r[n]}return t},clone:function(e){var t={};for(var i in e)for(var r in t[i]={},e[i]){var n=e[i][r];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture)?t[i][r]=n.clone():Array.isArray(n)?t[i][r]=n.slice():t[i][r]=n}return t}},vi={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif\n",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif\n",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif\n",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif\n",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"\nvec3 transformed = vec3( position );\n",beginnormal_vertex:"\nvec3 objectNormal = vec3( normal );\n",bsdfs:"float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tif( decayExponent > 0.0 ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\treturn distanceFalloff * maxDistanceCutoffFactor;\n#else\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n#endif\n\t}\n\treturn 1.0;\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\tfloat theta = acos( dot( N, V ) );\n\tvec2 uv = vec2(\n\t\tsqrt( saturate( roughness ) ),\n\t\tsaturate( theta / ( 0.5 * PI ) ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.86267 + (0.49788 + 0.01436 * y ) * y;\n\tfloat b = 3.45068 + (4.18814 + y) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = (x > 0.0) ? v : 0.5 * inversesqrt( 1.0 - x * x ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transpose( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tvec3 result = vec3( LTC_ClippedSphereFormFactor( vectorFormFactor ) );\n\treturn result;\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\treturn specularColor * AB.x + AB.y;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif\n",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n\t\tvec4 plane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t\t\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n\t\t\tvec4 plane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t\n\t#endif\n#endif\n",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif\n",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif\n",color_pars_vertex:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common:"#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transpose( const in mat3 v ) {\n\tmat3 tmp;\n\ttmp[0] = vec3(v[0].x, v[1].x, v[2].x);\n\ttmp[1] = vec3(v[0].y, v[1].y, v[2].y);\n\ttmp[2] = vec3(v[0].z, v[1].z, v[2].z);\n\treturn tmp;\n}\n",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif\n",defaultnormal_vertex:"vec3 transformedNormal = normalMatrix * objectNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif\n",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif\n",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif\n",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif\n",encodings_fragment:"  gl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM            = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat D      = max( maxRange / maxRGB, 1.0 );\n\tD            = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract(Le);\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n\treturn vec4( max(vRGB, 0.0), 1.0 );\n}\n",envmap_fragment:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\treflectVec = normalize( reflectVec );\n\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\treflectVec = normalize( reflectVec );\n\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif\n",envmap_pars_fragment:"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif\n",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif\n",envmap_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif\n",fog_vertex:"\n#ifdef USE_FOG\nfogDepth = -mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n  varying float fogDepth;\n#endif\n",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif\n",gradientmap_pars_fragment:"#ifdef TOON\n\tuniform sampler2D gradientMap;\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t\t#ifdef USE_GRADIENTMAP\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\t\t#else\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t\t#endif\n\t}\n#endif\n",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif\n",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif\n",lights_pars:"uniform vec3 ambientLightColor;\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t\tfloat shadowCameraNear;\n\t\tfloat shadowCameraFar;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltcMat;\tuniform sampler2D ltcMag;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif\n",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifdef TOON\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#else\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\t#endif\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}\n",lights_template:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tirradiance += getLightProbeIndirectIrradiance( geometry, 8 );\n\t#endif\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tvec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );\n\t#ifndef STANDARD\n\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );\n\t#else\n\t\tvec3 clearCoatRadiance = vec3( 0.0 );\n\t#endif\n\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif\n",logdepthbuf_fragment:"#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n\tgl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#ifdef USE_LOGDEPTHBUF\n\tuniform float logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n#endif\n",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n\tuniform float logDepthBufFC;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tgl_Position.z = log2(max( EPSILON, gl_Position.w + 1.0 )) * logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t#else\n\t\tgl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\n\t#endif\n#endif\n",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif\n",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n",map_particle_fragment:"#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) * offsetRepeat.zw + offsetRepeat.xy );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n",map_particle_pars_fragment:"#ifdef USE_MAP\n\tuniform vec4 offsetRepeat;\n\tuniform sampler2D map;\n#endif\n",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif\n",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif\n",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif\n",normal_fragment:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n#endif\n#ifdef USE_NORMALMAP\n\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 S = normalize( q0 * st1.t - q1 * st0.t );\n\t\tvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n\t\tvec3 N = normalize( surf_norm );\n\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\tmapN.xy = normalScale * mapN.xy;\n\t\tmat3 tsn = mat3( S, T, N );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif\n",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 1.0 - 2.0 * rgb.xyz;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif\n",project_vertex:"vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment:"#if defined( DITHERING )\n  gl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif\n",dithering_pars_fragment:"#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif\n",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif\n",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif\n",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif\n",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif\n",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}\n",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif\n",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif\n",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n#endif\n",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif\n",tonemapping_pars_fragment:"#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\n",uv_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform vec4 offsetRepeat;\n#endif\n",uv_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( PHYSICAL ) || defined( LAMBERT ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n#endif\n",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\nvoid main() {\n\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n\tgl_FragColor.a *= opacity;\n}\n",cube_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}\n",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}\n",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}\n",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldPosition );\n\tvec2 sampleUV;\n\tsampleUV.y = asin( clamp( direction.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n}\n",equirect_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphysical_frag:"#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <lights_pars>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphysical_vert:"#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}\n",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}\n",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = size * ( scale / - mvPosition.z );\n\t#else\n\t\tgl_PointSize = size;\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <bsdfs>\n#include <lights_pars>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n}\n",shadow_vert:"#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n}\n"},yi={basic:{uniforms:gi.merge([mi.common,mi.specularmap,mi.envmap,mi.aomap,mi.lightmap,mi.fog]),vertexShader:vi.meshbasic_vert,fragmentShader:vi.meshbasic_frag},lambert:{uniforms:gi.merge([mi.common,mi.specularmap,mi.envmap,mi.aomap,mi.lightmap,mi.emissivemap,mi.fog,mi.lights,{emissive:{value:new fi(0)}}]),vertexShader:vi.meshlambert_vert,fragmentShader:vi.meshlambert_frag},phong:{uniforms:gi.merge([mi.common,mi.specularmap,mi.envmap,mi.aomap,mi.lightmap,mi.emissivemap,mi.bumpmap,mi.normalmap,mi.displacementmap,mi.gradientmap,mi.fog,mi.lights,{emissive:{value:new fi(0)},specular:{value:new fi(1118481)},shininess:{value:30}}]),vertexShader:vi.meshphong_vert,fragmentShader:vi.meshphong_frag},standard:{uniforms:gi.merge([mi.common,mi.envmap,mi.aomap,mi.lightmap,mi.emissivemap,mi.bumpmap,mi.normalmap,mi.displacementmap,mi.roughnessmap,mi.metalnessmap,mi.fog,mi.lights,{emissive:{value:new fi(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:vi.meshphysical_vert,fragmentShader:vi.meshphysical_frag},points:{uniforms:gi.merge([mi.points,mi.fog]),vertexShader:vi.points_vert,fragmentShader:vi.points_frag},dashed:{uniforms:gi.merge([mi.common,mi.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:vi.linedashed_vert,fragmentShader:vi.linedashed_frag},depth:{uniforms:gi.merge([mi.common,mi.displacementmap]),vertexShader:vi.depth_vert,fragmentShader:vi.depth_frag},normal:{uniforms:gi.merge([mi.common,mi.bumpmap,mi.normalmap,mi.displacementmap,{opacity:{value:1}}]),vertexShader:vi.normal_vert,fragmentShader:vi.normal_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:vi.cube_vert,fragmentShader:vi.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:vi.equirect_vert,fragmentShader:vi.equirect_frag},distanceRGBA:{uniforms:gi.merge([mi.common,mi.displacementmap,{referencePosition:{value:new Mt},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:vi.distanceRGBA_vert,fragmentShader:vi.distanceRGBA_frag},shadow:{uniforms:gi.merge([mi.lights,{color:{value:new fi(0)},opacity:{value:1}}]),vertexShader:vi.shadow_vert,fragmentShader:vi.shadow_frag}};function Ei(e,t){this.min=void 0!==e?e:new ut(1/0,1/0),this.max=void 0!==t?t:new ut(-1/0,-1/0)}function xi(e,t,i,r,n){var o,a,s,c,l,h,u,d;function p(){var e=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),r=new Uint16Array([0,1,2,0,2,3]);o=t.createBuffer(),a=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,r,t.STATIC_DRAW),u=t.createTexture(),d=t.createTexture(),i.bindTexture(t.TEXTURE_2D,u),t.texImage2D(t.TEXTURE_2D,0,t.RGB,16,16,0,t.RGB,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),i.bindTexture(t.TEXTURE_2D,d),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,16,16,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),s={vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},c=function(e){var i=t.createProgram(),r=t.createShader(t.FRAGMENT_SHADER),o=t.createShader(t.VERTEX_SHADER),a="precision "+n.precision+" float;\n";return t.shaderSource(r,a+e.fragmentShader),t.shaderSource(o,a+e.vertexShader),t.compileShader(r),t.compileShader(o),t.attachShader(i,r),t.attachShader(i,o),t.linkProgram(i),i}(s),l={vertex:t.getAttribLocation(c,"position"),uv:t.getAttribLocation(c,"uv")},h={renderType:t.getUniformLocation(c,"renderType"),map:t.getUniformLocation(c,"map"),occlusionMap:t.getUniformLocation(c,"occlusionMap"),opacity:t.getUniformLocation(c,"opacity"),color:t.getUniformLocation(c,"color"),scale:t.getUniformLocation(c,"scale"),rotation:t.getUniformLocation(c,"rotation"),screenPosition:t.getUniformLocation(c,"screenPosition")}}this.render=function(e,n,s,f){if(0!==e.length){var m=new Mt,g=f.w/f.z,v=.5*f.z,y=.5*f.w,E=16/f.w,x=new ut(E*g,E),b=new Mt(1,1,0),w=new ut(1,1),T=new Ei;T.min.set(f.x,f.y),T.max.set(f.x+(f.z-16),f.y+(f.w-16)),void 0===c&&p(),i.useProgram(c),i.initAttributes(),i.enableAttribute(l.vertex),i.enableAttribute(l.uv),i.disableUnusedAttributes(),t.uniform1i(h.occlusionMap,0),t.uniform1i(h.map,1),t.bindBuffer(t.ARRAY_BUFFER,o),t.vertexAttribPointer(l.vertex,2,t.FLOAT,!1,16,0),t.vertexAttribPointer(l.uv,2,t.FLOAT,!1,16,8),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),i.disable(t.CULL_FACE),i.buffers.depth.setMask(!1);for(var M=0,S=e.length;M<S;M++){E=16/f.w,x.set(E*g,E);var R=e[M];if(m.set(R.matrixWorld.elements[12],R.matrixWorld.elements[13],R.matrixWorld.elements[14]),m.applyMatrix4(s.matrixWorldInverse),m.applyMatrix4(s.projectionMatrix),b.copy(m),w.x=f.x+b.x*v+v-8,w.y=f.y+b.y*y+y-8,!0===T.containsPoint(w)){i.activeTexture(t.TEXTURE0),i.bindTexture(t.TEXTURE_2D,null),i.activeTexture(t.TEXTURE1),i.bindTexture(t.TEXTURE_2D,u),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGB,w.x,w.y,16,16,0),t.uniform1i(h.renderType,0),t.uniform2f(h.scale,x.x,x.y),t.uniform3f(h.screenPosition,b.x,b.y,b.z),i.disable(t.BLEND),i.enable(t.DEPTH_TEST),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0),i.activeTexture(t.TEXTURE0),i.bindTexture(t.TEXTURE_2D,d),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,w.x,w.y,16,16,0),t.uniform1i(h.renderType,1),i.disable(t.DEPTH_TEST),i.activeTexture(t.TEXTURE1),i.bindTexture(t.TEXTURE_2D,u),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0),R.positionScreen.copy(b),R.customUpdateCallback?R.customUpdateCallback(R):R.updateLensFlares(),t.uniform1i(h.renderType,2),i.enable(t.BLEND);for(var A=0,_=R.lensFlares.length;A<_;A++){var D=R.lensFlares[A];D.opacity>.001&&D.scale>.001&&(b.x=D.x,b.y=D.y,b.z=D.z,E=D.size*D.scale/f.w,x.x=E*g,x.y=E,t.uniform3f(h.screenPosition,b.x,b.y,b.z),t.uniform2f(h.scale,x.x,x.y),t.uniform1f(h.rotation,D.rotation),t.uniform1f(h.opacity,D.opacity),t.uniform3f(h.color,D.color.r,D.color.g,D.color.b),i.setBlending(D.blending,D.blendEquation,D.blendSrc,D.blendDst),r.setTexture2D(D.texture,1),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0))}}}i.enable(t.CULL_FACE),i.enable(t.DEPTH_TEST),i.buffers.depth.setMask(!0),i.reset()}}}function bi(e,t,i,r,n,o,a,s,c){Et.call(this,e,t,i,r,n,o,a,s,c),this.needsUpdate=!0}function wi(e,t,i,r,n){var o,a,s,c,l,h,u=new Mt,d=new Tt,p=new Mt;function f(){var e=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),i=new Uint16Array([0,1,2,0,2,3]);o=t.createBuffer(),a=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i,t.STATIC_DRAW),s=function(){var e=t.createProgram(),i=t.createShader(t.VERTEX_SHADER),r=t.createShader(t.FRAGMENT_SHADER);return t.shaderSource(i,["precision "+n.precision+" float;","#define SHADER_NAME SpriteMaterial","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position * scale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 finalPosition;","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition;","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n")),t.shaderSource(r,["precision "+n.precision+" float;","#define SHADER_NAME SpriteMaterial","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")),t.compileShader(i),t.compileShader(r),t.attachShader(e,i),t.attachShader(e,r),t.linkProgram(e),e}(),c={position:t.getAttribLocation(s,"position"),uv:t.getAttribLocation(s,"uv")},l={uvOffset:t.getUniformLocation(s,"uvOffset"),uvScale:t.getUniformLocation(s,"uvScale"),rotation:t.getUniformLocation(s,"rotation"),scale:t.getUniformLocation(s,"scale"),color:t.getUniformLocation(s,"color"),map:t.getUniformLocation(s,"map"),opacity:t.getUniformLocation(s,"opacity"),modelViewMatrix:t.getUniformLocation(s,"modelViewMatrix"),projectionMatrix:t.getUniformLocation(s,"projectionMatrix"),fogType:t.getUniformLocation(s,"fogType"),fogDensity:t.getUniformLocation(s,"fogDensity"),fogNear:t.getUniformLocation(s,"fogNear"),fogFar:t.getUniformLocation(s,"fogFar"),fogColor:t.getUniformLocation(s,"fogColor"),alphaTest:t.getUniformLocation(s,"alphaTest")};var r=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");r.width=8,r.height=8;var u=r.getContext("2d");u.fillStyle="white",u.fillRect(0,0,8,8),h=new bi(r)}function m(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:t.id-e.id}this.render=function(n,g,v){if(0!==n.length){void 0===s&&f(),i.useProgram(s),i.initAttributes(),i.enableAttribute(c.position),i.enableAttribute(c.uv),i.disableUnusedAttributes(),i.disable(t.CULL_FACE),i.enable(t.BLEND),t.bindBuffer(t.ARRAY_BUFFER,o),t.vertexAttribPointer(c.position,2,t.FLOAT,!1,16,0),t.vertexAttribPointer(c.uv,2,t.FLOAT,!1,16,8),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.uniformMatrix4fv(l.projectionMatrix,!1,v.projectionMatrix.elements),i.activeTexture(t.TEXTURE0),t.uniform1i(l.map,0);var y=0,E=0,x=g.fog;x?(t.uniform3f(l.fogColor,x.color.r,x.color.g,x.color.b),x.isFog?(t.uniform1f(l.fogNear,x.near),t.uniform1f(l.fogFar,x.far),t.uniform1i(l.fogType,1),y=1,E=1):x.isFogExp2&&(t.uniform1f(l.fogDensity,x.density),t.uniform1i(l.fogType,2),y=2,E=2)):(t.uniform1i(l.fogType,0),y=0,E=0);for(var b=0,w=n.length;b<w;b++){(M=n[b]).modelViewMatrix.multiplyMatrices(v.matrixWorldInverse,M.matrixWorld),M.z=-M.modelViewMatrix.elements[14]}n.sort(m);var T=[];for(b=0,w=n.length;b<w;b++){var M,S=(M=n[b]).material;if(!1!==S.visible){M.onBeforeRender(e,g,v,void 0,S,void 0),t.uniform1f(l.alphaTest,S.alphaTest),t.uniformMatrix4fv(l.modelViewMatrix,!1,M.modelViewMatrix.elements),M.matrixWorld.decompose(u,d,p),T[0]=p.x,T[1]=p.y;var R=0;g.fog&&S.fog&&(R=E),y!==R&&(t.uniform1i(l.fogType,R),y=R),null!==S.map?(t.uniform2f(l.uvOffset,S.map.offset.x,S.map.offset.y),t.uniform2f(l.uvScale,S.map.repeat.x,S.map.repeat.y)):(t.uniform2f(l.uvOffset,0,0),t.uniform2f(l.uvScale,1,1)),t.uniform1f(l.opacity,S.opacity),t.uniform3f(l.color,S.color.r,S.color.g,S.color.b),t.uniform1f(l.rotation,S.rotation),t.uniform2fv(l.scale,T),i.setBlending(S.blending,S.blendEquation,S.blendSrc,S.blendDst,S.blendEquationAlpha,S.blendSrcAlpha,S.blendDstAlpha,S.premultipliedAlpha),i.buffers.depth.setTest(S.depthTest),i.buffers.depth.setMask(S.depthWrite),r.setTexture2D(S.map||h,0),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0),M.onAfterRender(e,g,v,void 0,S,void 0)}}i.enable(t.CULL_FACE),i.reset()}}}yi.physical={uniforms:gi.merge([yi.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:vi.meshphysical_vert,fragmentShader:vi.meshphysical_frag},Object.assign(Ei.prototype,{set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new ut;return function(t,i){var r=e.copy(i).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){var t=e||new ut;return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new ut;return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){return(t||new ut).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(e,t){return(t||new ut).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new ut;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),bi.prototype=Object.create(Et.prototype),bi.prototype.constructor=bi;var Ti,Mi,Si,Ri,Ai,_i,Di,Ci=0;function Li(){Object.defineProperty(this,"id",{value:Ci++}),this.uuid=ht.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=w,this.side=m,this.flatShading=!1,this.vertexColors=y,this.opacity=1,this.transparent=!1,this.blendSrc=O,this.blendDst=U,this.blendEquation=A,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=X,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this.userData={},this.needsUpdate=!0}function Pi(e){Li.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function Hi(e){Li.call(this),this.type="MeshDepthMaterial",this.depthPacking=ct,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(e)}function Bi(e){Li.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new Mt,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.lights=!1,this.setValues(e)}function Ii(e,t){this.min=void 0!==e?e:new Mt(1/0,1/0,1/0),this.max=void 0!==t?t:new Mt(-1/0,-1/0,-1/0)}function Oi(e,t){this.center=void 0!==e?e:new Mt,this.radius=void 0!==t?t:0}function Ui(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}function Ni(e,t){this.normal=void 0!==e?e:new Mt(1,0,0),this.constant=void 0!==t?t:0}function Vi(e,t,i,r,n,o){this.planes=[void 0!==e?e:new Ni,void 0!==t?t:new Ni,void 0!==i?i:new Ni,void 0!==r?r:new Ni,void 0!==n?n:new Ni,void 0!==o?o:new Ni]}function Fi(e,t,i){for(var r=new Vi,n=new St,o=new ut,a=new ut(i,i),s=new Mt,c=new Mt,l=1,h=2,u=1+(l|h),d=new Array(u),f=new Array(u),y={},E=[new Mt(1,0,0),new Mt(-1,0,0),new Mt(0,0,1),new Mt(0,0,-1),new Mt(0,1,0),new Mt(0,-1,0)],x=[new Mt(0,1,0),new Mt(0,1,0),new Mt(0,1,0),new Mt(0,1,0),new Mt(0,0,1),new Mt(0,0,-1)],b=[new xt,new xt,new xt,new xt,new xt,new xt],w=0;w!==u;++w){var T=0!=(w&l),M=0!=(w&h),S=new Hi({depthPacking:lt,morphTargets:T,skinning:M});d[w]=S;var R=new Bi({morphTargets:T,skinning:M});f[w]=R}var A=this;function _(t,i,r,n,o,a){var s=t.geometry,c=null,u=d,p=t.customDepthMaterial;if(r&&(u=f,p=t.customDistanceMaterial),p)c=p;else{var E=!1;i.morphTargets&&(s&&s.isBufferGeometry?E=s.morphAttributes&&s.morphAttributes.position&&s.morphAttributes.position.length>0:s&&s.isGeometry&&(E=s.morphTargets&&s.morphTargets.length>0)),t.isSkinnedMesh&&!1===i.skinning&&console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",t);var x=t.isSkinnedMesh&&i.skinning,b=0;E&&(b|=l),x&&(b|=h),c=u[b]}if(e.localClippingEnabled&&!0===i.clipShadows&&0!==i.clippingPlanes.length){var w=c.uuid,T=i.uuid,M=y[w];void 0===M&&(M={},y[w]=M);var S=M[T];void 0===S&&(S=c.clone(),M[T]=S),c=S}c.visible=i.visible,c.wireframe=i.wireframe;var R=i.side;return A.renderSingleSided&&R==v&&(R=m),A.renderReverseSided&&(R===m?R=g:R===g&&(R=m)),c.side=R,c.clipShadows=i.clipShadows,c.clippingPlanes=i.clippingPlanes,c.clipIntersection=i.clipIntersection,c.wireframeLinewidth=i.wireframeLinewidth,c.linewidth=i.linewidth,r&&c.isMeshDistanceMaterial&&(c.referencePosition.copy(n),c.nearDistance=o,c.farDistance=a),c}function D(i,n,o,a){if(!1!==i.visible){if(i.layers.test(n.layers)&&(i.isMesh||i.isLine||i.isPoints)&&i.castShadow&&(!i.frustumCulled||r.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,i.matrixWorld);var s=t.update(i),l=i.material;if(Array.isArray(l))for(var h=s.groups,u=0,d=h.length;u<d;u++){var p=h[u],f=l[p.materialIndex];if(f&&f.visible){var m=_(i,f,a,c,o.near,o.far);e.renderBufferDirect(o,null,s,m,i,p)}}else if(l.visible){m=_(i,l,a,c,o.near,o.far);e.renderBufferDirect(o,null,s,m,i,null)}}for(var g=i.children,v=0,y=g.length;v<y;v++)D(g[v],n,o,a)}}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=p,this.renderReverseSided=!0,this.renderSingleSided=!0,this.render=function(t,i,l){if(!1!==A.enabled&&(!1!==A.autoUpdate||!1!==A.needsUpdate)&&0!==t.length){var h,u=e.context,d=e.state;d.disable(u.BLEND),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(var p=0,f=t.length;p<f;p++){var m=t[p],g=m.shadow,v=m&&m.isPointLight;if(void 0!==g){var y=g.camera;if(o.copy(g.mapSize),o.min(a),v){var w=o.x,T=o.y;b[0].set(2*w,T,w,T),b[1].set(0,T,w,T),b[2].set(3*w,T,w,T),b[3].set(w,T,w,T),b[4].set(3*w,0,w,T),b[5].set(w,0,w,T),o.x*=4,o.y*=2}if(null===g.map){var M={minFilter:me,magFilter:me,format:Ie};g.map=new bt(o.x,o.y,M),g.map.texture.name=m.name+".shadowMap",y.updateProjectionMatrix()}g.isSpotLightShadow&&g.update(m);var S=g.map,R=g.matrix;c.setFromMatrixPosition(m.matrixWorld),y.position.copy(c),v?(h=6,R.makeTranslation(-c.x,-c.y,-c.z)):(h=1,s.setFromMatrixPosition(m.target.matrixWorld),y.lookAt(s),y.updateMatrixWorld(),R.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),R.multiply(y.projectionMatrix),R.multiply(y.matrixWorldInverse)),e.setRenderTarget(S),e.clear();for(var _=0;_<h;_++){if(v){s.copy(y.position),s.add(E[_]),y.up.copy(x[_]),y.lookAt(s),y.updateMatrixWorld();var C=b[_];d.viewport(C)}n.multiplyMatrices(y.projectionMatrix,y.matrixWorldInverse),r.setFromMatrix(n),D(i,l,y,v)}}else console.warn("THREE.WebGLShadowMap:",m,"has no shadow.")}A.needsUpdate=!1}}}function zi(e){var t={};return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t[e.uuid]},remove:function(i){i.isInterleavedBufferAttribute&&(i=i.data);var r=t[i.uuid];r&&(e.deleteBuffer(r.buffer),delete t[i.uuid])},update:function(i,r){i.isInterleavedBufferAttribute&&(i=i.data);var n=t[i.uuid];void 0===n?t[i.uuid]=function(t,i){var r=t.array,n=t.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW,o=e.createBuffer();e.bindBuffer(i,o),e.bufferData(i,r,n),t.onUploadCallback();var a=e.FLOAT;return r instanceof Float32Array?a=e.FLOAT:r instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):r instanceof Uint16Array?a=e.UNSIGNED_SHORT:r instanceof Int16Array?a=e.SHORT:r instanceof Uint32Array?a=e.UNSIGNED_INT:r instanceof Int32Array?a=e.INT:r instanceof Int8Array?a=e.BYTE:r instanceof Uint8Array&&(a=e.UNSIGNED_BYTE),{buffer:o,type:a,bytesPerElement:r.BYTES_PER_ELEMENT,version:t.version}}(i,r):n.version<i.version&&(function(t,i,r){var n=i.array,o=i.updateRange;e.bindBuffer(r,t),!1===i.dynamic?e.bufferData(r,n,e.STATIC_DRAW):-1===o.count?e.bufferSubData(r,0,n):0===o.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(e.bufferSubData(r,o.offset*n.BYTES_PER_ELEMENT,n.subarray(o.offset,o.offset+o.count)),o.count=-1)}(n.buffer,i,r),n.version=i.version)}}}function ji(e,t,i,r){this._x=e||0,this._y=t||0,this._z=i||0,this._order=r||ji.DefaultOrder}function ki(){this.mask=1}Object.assign(Li.prototype,t.prototype,{isMaterial:!0,onBeforeCompile:function(){},setValues:function(e){if(void 0!==e)for(var t in e){var i=e[t];if(void 0!==i)if("shading"!==t){var r=this[t];void 0!==r?r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]="overdraw"===t?Number(i):i:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}else console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===i;else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},toJSON:function(e){var t=void 0===e;t&&(e={textures:{},images:{}});var i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function r(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearCoat&&(i.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(i.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,i.reflectivity=this.reflectivity),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(i.size=this.size),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==w&&(i.blending=this.blending),!0===this.flatShading&&(i.flatShading=this.flatShading),this.side!==m&&(i.side=this.side),this.vertexColors!==y&&(i.vertexColors=this.vertexColors),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(i.morphTargets=!0),!0===this.skinning&&(i.skinning=!0),!1===this.visible&&(i.visible=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),t){var n=r(e.textures),o=r(e.images);n.length>0&&(i.textures=n),o.length>0&&(i.images=o)}return i},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.lights=e.lights,this.blending=e.blending,this.side=e.side,this.flatShading=e.flatShading,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.overdraw=e.overdraw,this.visible=e.visible,this.userData=JSON.parse(JSON.stringify(e.userData)),this.clipShadows=e.clipShadows,this.clipIntersection=e.clipIntersection;var t=e.clippingPlanes,i=null;if(null!==t){var r=t.length;i=new Array(r);for(var n=0;n!==r;++n)i[n]=t[n].clone()}return this.clippingPlanes=i,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Pi.prototype=Object.create(Li.prototype),Pi.prototype.constructor=Pi,Pi.prototype.isShaderMaterial=!0,Pi.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=gi.clone(e.uniforms),this.defines=e.defines,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=e.extensions,this},Pi.prototype.toJSON=function(e){var t=Li.prototype.toJSON.call(this,e);return t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t},Hi.prototype=Object.create(Li.prototype),Hi.prototype.constructor=Hi,Hi.prototype.isMeshDepthMaterial=!0,Hi.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},Bi.prototype=Object.create(Li.prototype),Bi.prototype.constructor=Bi,Bi.prototype.isMeshDistanceMaterial=!0,Bi.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this},Object.assign(Ii.prototype,{isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){for(var t=1/0,i=1/0,r=1/0,n=-1/0,o=-1/0,a=-1/0,s=0,c=e.length;s<c;s+=3){var l=e[s],h=e[s+1],u=e[s+2];l<t&&(t=l),h<i&&(i=h),u<r&&(r=u),l>n&&(n=l),h>o&&(o=h),u>a&&(a=u)}return this.min.set(t,i,r),this.max.set(n,o,a),this},setFromBufferAttribute:function(e){for(var t=1/0,i=1/0,r=1/0,n=-1/0,o=-1/0,a=-1/0,s=0,c=e.count;s<c;s++){var l=e.getX(s),h=e.getY(s),u=e.getZ(s);l<t&&(t=l),h<i&&(i=h),u<r&&(r=u),l>n&&(n=l),h>o&&(o=h),u>a&&(a=u)}return this.min.set(t,i,r),this.max.set(n,o,a),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new Mt;return function(t,i){var r=e.copy(i).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}}(),setFromObject:function(e){return this.makeEmpty(),this.expandByObject(e)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){var t=e||new Mt;return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new Mt;return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByObject:function(){var e=new Mt;return function(t){var i=this;return t.updateMatrixWorld(!0),t.traverse(function(t){var r,n,o=t.geometry;if(void 0!==o)if(o.isGeometry){var a=o.vertices;for(r=0,n=a.length;r<n;r++)e.copy(a[r]),e.applyMatrix4(t.matrixWorld),i.expandByPoint(e)}else if(o.isBufferGeometry){var s=o.attributes.position;if(void 0!==s)for(r=0,n=s.count;r<n;r++)e.fromBufferAttribute(s,r).applyMatrix4(t.matrixWorld),i.expandByPoint(e)}}),this}}(),containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return(t||new Mt).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:(Mi=new Mt,function(e){return this.clampPoint(e.center,Mi),Mi.distanceToSquared(e.center)<=e.radius*e.radius}),intersectsPlane:function(e){var t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=e.constant&&i>=e.constant},clampPoint:function(e,t){return(t||new Mt).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new Mt;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),getBoundingSphere:function(){var e=new Mt;return function(t){var i=t||new Oi;return this.getCenter(i.center),i.radius=.5*this.getSize(e).length(),i}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:(Ti=[new Mt,new Mt,new Mt,new Mt,new Mt,new Mt,new Mt,new Mt],function(e){return this.isEmpty()?this:(Ti[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Ti[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Ti[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Ti[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Ti[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Ti[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Ti[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Ti[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Ti),this)}),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),Object.assign(Oi.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:(Si=new Ii,function(e,t){var i=this.center;void 0!==t?i.copy(t):Si.setFromPoints(e).getCenter(i);for(var r=0,n=0,o=e.length;n<o;n++)r=Math.max(r,i.distanceToSquared(e[n]));return this.radius=Math.sqrt(r),this}),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius},clampPoint:function(e,t){var i=this.center.distanceToSquared(e),r=t||new Mt;return r.copy(e),i>this.radius*this.radius&&(r.sub(this.center).normalize(),r.multiplyScalar(this.radius).add(this.center)),r},getBoundingBox:function(e){var t=e||new Ii;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}}),Object.assign(Ui.prototype,{isMatrix3:!0,set:function(e,t,i,r,n,o,a,s,c){var l=this.elements;return l[0]=e,l[1]=r,l[2]=a,l[3]=t,l[4]=n,l[5]=s,l[6]=i,l[7]=o,l[8]=c,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToBufferAttribute:function(){var e=new Mt;return function(t){for(var i=0,r=t.count;i<r;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix3(this),t.setXYZ(i,e.x,e.y,e.z);return t}}(),multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var i=e.elements,r=t.elements,n=this.elements,o=i[0],a=i[3],s=i[6],c=i[1],l=i[4],h=i[7],u=i[2],d=i[5],p=i[8],f=r[0],m=r[3],g=r[6],v=r[1],y=r[4],E=r[7],x=r[2],b=r[5],w=r[8];return n[0]=o*f+a*v+s*x,n[3]=o*m+a*y+s*b,n[6]=o*g+a*E+s*w,n[1]=c*f+l*v+h*x,n[4]=c*m+l*y+h*b,n[7]=c*g+l*E+h*w,n[2]=u*f+d*v+p*x,n[5]=u*m+d*y+p*b,n[8]=u*g+d*E+p*w,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],i=e[1],r=e[2],n=e[3],o=e[4],a=e[5],s=e[6],c=e[7],l=e[8];return t*o*l-t*a*c-i*n*l+i*a*s+r*n*c-r*o*s},getInverse:function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3: .getInverse() no longer takes a Matrix4 argument.");var i=e.elements,r=this.elements,n=i[0],o=i[1],a=i[2],s=i[3],c=i[4],l=i[5],h=i[6],u=i[7],d=i[8],p=d*c-l*u,f=l*h-d*s,m=u*s-c*h,g=n*p+o*f+a*m;if(0===g){var v="THREE.Matrix3: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(v);return console.warn(v),this.identity()}var y=1/g;return r[0]=p*y,r[1]=(a*u-d*o)*y,r[2]=(l*o-a*c)*y,r[3]=f*y,r[4]=(d*n-a*h)*y,r[5]=(a*s-l*n)*y,r[6]=m*y,r[7]=(o*h-u*n)*y,r[8]=(c*n-o*s)*y,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},equals:function(e){for(var t=this.elements,i=e.elements,r=0;r<9;r++)if(t[r]!==i[r])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var i=0;i<9;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}}),Object.assign(Ni.prototype,{set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,i,r){return this.normal.set(e,t,i),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var e=new Mt,t=new Mt;return function(i,r,n){var o=e.subVectors(n,r).cross(t.subVectors(i,r)).normalize();return this.setFromNormalAndCoplanarPoint(o,i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return(t||new Mt).copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)},intersectLine:function(){var e=new Mt;return function(t,i){var r=i||new Mt,n=t.delta(e),o=this.normal.dot(n);if(0===o)return 0===this.distanceToPoint(t.start)?r.copy(t.start):void 0;var a=-(t.start.dot(this.normal)+this.constant)/o;return a<0||a>1?void 0:r.copy(n).multiplyScalar(a).add(t.start)}}(),intersectsLine:function(e){var t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){return(e||new Mt).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var e=new Mt,t=new Ui;return function(i,r){var n=r||t.getNormalMatrix(i),o=this.coplanarPoint(e).applyMatrix4(i),a=this.normal.applyMatrix3(n).normalize();return this.constant=-o.dot(a),this}}(),translate:function(e){return this.constant-=e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}}),Object.assign(Vi.prototype,{set:function(e,t,i,r,n,o){var a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(i),a[3].copy(r),a[4].copy(n),a[5].copy(o),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,i=0;i<6;i++)t[i].copy(e.planes[i]);return this},setFromMatrix:function(e){var t=this.planes,i=e.elements,r=i[0],n=i[1],o=i[2],a=i[3],s=i[4],c=i[5],l=i[6],h=i[7],u=i[8],d=i[9],p=i[10],f=i[11],m=i[12],g=i[13],v=i[14],y=i[15];return t[0].setComponents(a-r,h-s,f-u,y-m).normalize(),t[1].setComponents(a+r,h+s,f+u,y+m).normalize(),t[2].setComponents(a+n,h+c,f+d,y+g).normalize(),t[3].setComponents(a-n,h-c,f-d,y-g).normalize(),t[4].setComponents(a-o,h-l,f-p,y-v).normalize(),t[5].setComponents(a+o,h+l,f+p,y+v).normalize(),this},intersectsObject:(_i=new Oi,function(e){var t=e.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),_i.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(_i)}),intersectsSprite:function(){var e=new Oi;return function(t){return e.center.set(0,0,0),e.radius=.7071067811865476,e.applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSphere:function(e){for(var t=this.planes,i=e.center,r=-e.radius,n=0;n<6;n++){if(t[n].distanceToPoint(i)<r)return!1}return!0},intersectsBox:(Ri=new Mt,Ai=new Mt,function(e){for(var t=this.planes,i=0;i<6;i++){var r=t[i];Ri.x=r.normal.x>0?e.min.x:e.max.x,Ai.x=r.normal.x>0?e.max.x:e.min.x,Ri.y=r.normal.y>0?e.min.y:e.max.y,Ai.y=r.normal.y>0?e.max.y:e.min.y,Ri.z=r.normal.z>0?e.min.z:e.max.z,Ai.z=r.normal.z>0?e.max.z:e.min.z;var n=r.distanceToPoint(Ri),o=r.distanceToPoint(Ai);if(n<0&&o<0)return!1}return!0}),containsPoint:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}}),ji.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],ji.DefaultOrder="XYZ",Object.defineProperties(ji.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this.onChangeCallback()}}}),Object.assign(ji.prototype,{isEuler:!0,set:function(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._order=r||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,i){var r=ht.clamp,n=e.elements,o=n[0],a=n[4],s=n[8],c=n[1],l=n[5],h=n[9],u=n[2],d=n[6],p=n[10];return"XYZ"===(t=t||this._order)?(this._y=Math.asin(r(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-a,o)):(this._x=Math.atan2(d,l),this._z=0)):"YXZ"===t?(this._x=Math.asin(-r(h,-1,1)),Math.abs(h)<.99999?(this._y=Math.atan2(s,p),this._z=Math.atan2(c,l)):(this._y=Math.atan2(-u,o),this._z=0)):"ZXY"===t?(this._x=Math.asin(r(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-a,l)):(this._y=0,this._z=Math.atan2(c,o))):"ZYX"===t?(this._y=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(this._x=Math.atan2(d,p),this._z=Math.atan2(c,o)):(this._x=0,this._z=Math.atan2(-a,l))):"YZX"===t?(this._z=Math.asin(r(c,-1,1)),Math.abs(c)<.99999?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-u,o)):(this._x=0,this._y=Math.atan2(s,p))):"XZY"===t?(this._z=Math.asin(-r(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(d,l),this._y=Math.atan2(s,o)):(this._x=Math.atan2(-h,p),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==i&&this.onChangeCallback(),this},setFromQuaternion:function(){var e=new St;return function(t,i,r){return e.makeRotationFromQuaternion(t),this.setFromRotationMatrix(e,i,r)}}(),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:(Di=new Tt,function(e){return Di.setFromEuler(this),this.setFromQuaternion(Di,e)}),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new Mt(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(ki.prototype,{set:function(e){this.mask=1<<e|0},enable:function(e){this.mask|=1<<e|0},toggle:function(e){this.mask^=1<<e|0},disable:function(e){this.mask&=~(1<<e|0)},test:function(e){return 0!=(this.mask&e.mask)}});var Gi,Wi,Xi,Yi,qi=0;function Zi(){Object.defineProperty(this,"id",{value:qi++}),this.uuid=ht.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Zi.DefaultUp.clone();var e=new Mt,t=new ji,i=new Tt,r=new Mt(1,1,1);t.onChange(function(){i.setFromEuler(t,!1)}),i.onChange(function(){t.setFromQuaternion(i,void 0,!1)}),Object.defineProperties(this,{position:{enumerable:!0,value:e},rotation:{enumerable:!0,value:t},quaternion:{enumerable:!0,value:i},scale:{enumerable:!0,value:r},modelViewMatrix:{value:new St},normalMatrix:{value:new Ui}}),this.matrix=new St,this.matrixWorld=new St,this.matrixAutoUpdate=Zi.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new ki,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}function Ji(){Zi.call(this),this.type="Camera",this.matrixWorldInverse=new St,this.projectionMatrix=new St}function Qi(e,t,i,r,n,o){Ji.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=r,this.near=void 0!==n?n:.1,this.far=void 0!==o?o:2e3,this.updateProjectionMatrix()}function Ki(e,t,i,r){Ji.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==i?i:.1,this.far=void 0!==r?r:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function $i(e,t,i,r,n,o){this.a=e,this.b=t,this.c=i,this.normal=r&&r.isVector3?r:new Mt,this.vertexNormals=Array.isArray(r)?r:[],this.color=n&&n.isColor?n:new fi,this.vertexColors=Array.isArray(n)?n:[],this.materialIndex=void 0!==o?o:0}Zi.DefaultUp=new Mt(0,1,0),Zi.DefaultMatrixAutoUpdate=!0,Object.assign(Zi.prototype,t.prototype,{isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(e){return this.quaternion.premultiply(e),this},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:(Yi=new Tt,function(e,t){return Yi.setFromAxisAngle(e,t),this.quaternion.multiply(Yi),this}),rotateX:function(){var e=new Mt(1,0,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateY:function(){var e=new Mt(0,1,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateZ:function(){var e=new Mt(0,0,1);return function(t){return this.rotateOnAxis(e,t)}}(),translateOnAxis:function(){var e=new Mt;return function(t,i){return e.copy(t).applyQuaternion(this.quaternion),this.position.add(e.multiplyScalar(i)),this}}(),translateX:function(){var e=new Mt(1,0,0);return function(t){return this.translateOnAxis(e,t)}}(),translateY:function(){var e=new Mt(0,1,0);return function(t){return this.translateOnAxis(e,t)}}(),translateZ:function(){var e=new Mt(0,0,1);return function(t){return this.translateOnAxis(e,t)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:(Xi=new St,function(e){return e.applyMatrix4(Xi.getInverse(this.matrixWorld))}),lookAt:function(){var e=new St;return function(t){this.isCamera?e.lookAt(this.position,t,this.up):e.lookAt(t,this.position,this.up),this.quaternion.setFromRotationMatrix(e)}}(),add:function(e){if(arguments.length>1){for(var t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1){for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}var i=this.children.indexOf(e);return-1!==i&&(e.parent=null,e.dispatchEvent({type:"removed"}),this.children.splice(i,1)),this},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var i=0,r=this.children.length;i<r;i++){var n=this.children[i].getObjectByProperty(e,t);if(void 0!==n)return n}},getWorldPosition:function(e){var t=e||new Mt;return this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:(Gi=new Mt,Wi=new Mt,function(e){var t=e||new Tt;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(Gi,t,Wi),t}),getWorldRotation:function(){var e=new Tt;return function(t){var i=t||new ji;return this.getWorldQuaternion(e),i.setFromQuaternion(e,this.rotation.order,!1)}}(),getWorldScale:function(){var e=new Mt,t=new Tt;return function(i){var r=i||new Mt;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,t,r),r}}(),getWorldDirection:function(){var e=new Tt;return function(t){var i=t||new Mt;return this.getWorldQuaternion(e),i.set(0,0,1).applyQuaternion(e)}}(),raycast:function(){},traverse:function(e){e(this);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].traverse(e)},traverseVisible:function(e){if(!1!==this.visible){e(this);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].updateMatrixWorld(e)},toJSON:function(e){var t=void 0===e||""===e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var r={};function n(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),!0===this.castShadow&&(r.castShadow=!0),!0===this.receiveShadow&&(r.receiveShadow=!0),!1===this.visible&&(r.visible=!1),"{}"!==JSON.stringify(this.userData)&&(r.userData=this.userData),r.matrix=this.matrix.toArray(),void 0!==this.geometry&&(r.geometry=n(e.geometries,this.geometry)),void 0!==this.material)if(Array.isArray(this.material)){for(var o=[],a=0,s=this.material.length;a<s;a++)o.push(n(e.materials,this.material[a]));r.material=o}else r.material=n(e.materials,this.material);if(this.children.length>0){r.children=[];for(a=0;a<this.children.length;a++)r.children.push(this.children[a].toJSON(e).object)}if(t){var c=d(e.geometries),l=d(e.materials),h=d(e.textures),u=d(e.images);c.length>0&&(i.geometries=c),l.length>0&&(i.materials=l),h.length>0&&(i.textures=h),u.length>0&&(i.images=u)}return i.object=r,i;function d(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(var i=0;i<e.children.length;i++){var r=e.children[i];this.add(r.clone())}return this}}),Ji.prototype=Object.assign(Object.create(Zi.prototype),{constructor:Ji,isCamera:!0,copy:function(e,t){return Zi.prototype.copy.call(this,e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this},getWorldDirection:function(){var e=new Tt;return function(t){var i=t||new Mt;return this.getWorldQuaternion(e),i.set(0,0,-1).applyQuaternion(e)}}(),updateMatrixWorld:function(e){Zi.prototype.updateMatrixWorld.call(this,e),this.matrixWorldInverse.getInverse(this.matrixWorld)},clone:function(){return(new this.constructor).copy(this)}}),Qi.prototype=Object.assign(Object.create(Ji.prototype),{constructor:Qi,isOrthographicCamera:!0,copy:function(e,t){return Ji.prototype.copy.call(this,e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this},setViewOffset:function(e,t,i,r,n,o){this.view={fullWidth:e,fullHeight:t,offsetX:i,offsetY:r,width:n,height:o},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,r=(this.top+this.bottom)/2,n=i-e,o=i+e,a=r+t,s=r-t;if(null!==this.view){var c=this.zoom/(this.view.width/this.view.fullWidth),l=this.zoom/(this.view.height/this.view.fullHeight),h=(this.right-this.left)/this.view.width,u=(this.top-this.bottom)/this.view.height;o=(n+=h*(this.view.offsetX/c))+h*(this.view.width/c),s=(a-=u*(this.view.offsetY/l))-u*(this.view.height/l)}this.projectionMatrix.makeOrthographic(n,o,a,s,this.near,this.far)},toJSON:function(e){var t=Zi.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}),Ki.prototype=Object.assign(Object.create(Ji.prototype),{constructor:Ki,isPerspectiveCamera:!0,copy:function(e,t){return Ji.prototype.copy.call(this,e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){var t=.5*this.getFilmHeight()/e;this.fov=2*ht.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var e=Math.tan(.5*ht.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*ht.RAD2DEG*Math.atan(Math.tan(.5*ht.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,i,r,n,o){this.aspect=e/t,this.view={fullWidth:e,fullHeight:t,offsetX:i,offsetY:r,width:n,height:o},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=this.near,t=e*Math.tan(.5*ht.DEG2RAD*this.fov)/this.zoom,i=2*t,r=this.aspect*i,n=-.5*r,o=this.view;if(null!==o){var a=o.fullWidth,s=o.fullHeight;n+=o.offsetX*r/a,t-=o.offsetY*i/s,r*=o.width/a,i*=o.height/s}var c=this.filmOffset;0!==c&&(n+=e*c/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+r,t,t-i,e,this.far)},toJSON:function(e){var t=Zi.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),Object.assign($i.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(var t=0,i=e.vertexNormals.length;t<i;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(t=0,i=e.vertexColors.length;t<i;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}});var er,tr,ir,rr,nr,or,ar,sr,cr,lr=0;function hr(){return lr++}function ur(){Object.defineProperty(this,"id",{value:hr()}),this.uuid=ht.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function dr(e,t,i){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.uuid=ht.generateUUID(),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===i,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function pr(e,t){dr.call(this,new Int8Array(e),t)}function fr(e,t){dr.call(this,new Uint8Array(e),t)}function mr(e,t){dr.call(this,new Uint8ClampedArray(e),t)}function gr(e,t){dr.call(this,new Int16Array(e),t)}function vr(e,t){dr.call(this,new Uint16Array(e),t)}function yr(e,t){dr.call(this,new Int32Array(e),t)}function Er(e,t){dr.call(this,new Uint32Array(e),t)}function xr(e,t){dr.call(this,new Float32Array(e),t)}function br(e,t){dr.call(this,new Float64Array(e),t)}function wr(){this.indices=[],this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function Tr(e){if(0===e.length)return-1/0;for(var t=e[0],i=1,r=e.length;i<r;++i)e[i]>t&&(t=e[i]);return t}function Mr(){Object.defineProperty(this,"id",{value:hr()}),this.uuid=ht.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}}function Sr(e,t,i,r,n,o){ur.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:r,heightSegments:n,depthSegments:o},this.fromBufferGeometry(new Rr(e,t,i,r,n,o)),this.mergeVertices()}function Rr(e,t,i,r,n,o){Mr.call(this),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:r,heightSegments:n,depthSegments:o};var a=this;r=Math.floor(r)||1,n=Math.floor(n)||1;var s=[],c=[],l=[],h=[],u=0,d=0;function p(e,t,i,r,n,o,p,f,m,g,v){var y,E,x=o/m,b=p/g,w=o/2,T=p/2,M=f/2,S=m+1,R=g+1,A=0,_=0,D=new Mt;for(E=0;E<R;E++){var C=E*b-T;for(y=0;y<S;y++){var L=y*x-w;D[e]=L*r,D[t]=C*n,D[i]=M,c.push(D.x,D.y,D.z),D[e]=0,D[t]=0,D[i]=f>0?1:-1,l.push(D.x,D.y,D.z),h.push(y/m),h.push(1-E/g),A+=1}}for(E=0;E<g;E++)for(y=0;y<m;y++){var P=u+y+S*E,H=u+y+S*(E+1),B=u+(y+1)+S*(E+1),I=u+(y+1)+S*E;s.push(P,H,I),s.push(H,B,I),_+=6}a.addGroup(d,_,v),d+=_,u+=A}p("z","y","x",-1,-1,i,t,e,o=Math.floor(o)||1,n,0),p("z","y","x",1,-1,i,t,-e,o,n,1),p("x","z","y",1,1,e,i,t,r,o,2),p("x","z","y",1,-1,e,i,-t,r,o,3),p("x","y","z",1,-1,e,t,i,r,n,4),p("x","y","z",-1,-1,e,t,-i,r,n,5),this.setIndex(s),this.addAttribute("position",new xr(c,3)),this.addAttribute("normal",new xr(l,3)),this.addAttribute("uv",new xr(h,2))}function Ar(e,t,i,r){ur.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:r},this.fromBufferGeometry(new _r(e,t,i,r)),this.mergeVertices()}function _r(e,t,i,r){Mr.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:r};var n,o,a=e/2,s=t/2,c=Math.floor(i)||1,l=Math.floor(r)||1,h=c+1,u=l+1,d=e/c,p=t/l,f=[],m=[],g=[],v=[];for(o=0;o<u;o++){var y=o*p-s;for(n=0;n<h;n++){var E=n*d-a;m.push(E,-y,0),g.push(0,0,1),v.push(n/c),v.push(1-o/l)}}for(o=0;o<l;o++)for(n=0;n<c;n++){var x=n+h*o,b=n+h*(o+1),w=n+1+h*(o+1),T=n+1+h*o;f.push(x,b,T),f.push(b,w,T)}this.setIndex(f),this.addAttribute("position",new xr(m,3)),this.addAttribute("normal",new xr(g,3)),this.addAttribute("uv",new xr(v,2))}function Dr(e){Li.call(this),this.type="MeshBasicMaterial",this.color=new fi(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Q,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function Cr(e,t){this.origin=void 0!==e?e:new Mt,this.direction=void 0!==t?t:new Mt}function Lr(e,t){this.start=void 0!==e?e:new Mt,this.end=void 0!==t?t:new Mt}function Pr(e,t,i){this.a=void 0!==e?e:new Mt,this.b=void 0!==t?t:new Mt,this.c=void 0!==i?i:new Mt}function Hr(e,t){Zi.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new Mr,this.material=void 0!==t?t:new Dr({color:16777215*Math.random()}),this.drawMode=Ke,this.updateMorphTargets()}function Br(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program&&t.program&&e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Ir(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Or(){var e={};return{get:function(t,i){var r=t.id+","+i.id,n=e[r];return void 0===n&&(n=new function(){var e=[],t=0,i=[],r=[];return{opaque:i,transparent:r,init:function(){t=0,i.length=0,r.length=0},push:function(n,o,a,s,c){var l=e[t];void 0===l?(l={id:n.id,object:n,geometry:o,material:a,program:a.program,renderOrder:n.renderOrder,z:s,group:c},e[t]=l):(l.id=n.id,l.object=n,l.geometry=o,l.material=a,l.program=a.program,l.renderOrder=n.renderOrder,l.z=s,l.group=c),(!0===a.transparent?r:i).push(l),t++},sort:function(){i.length>1&&i.sort(Br),r.length>1&&r.sort(Ir)}}},e[r]=n),n},dispose:function(){e={}}}}function Ur(e,t){return Math.abs(t[1])-Math.abs(e[1])}function Nr(){var e=new function(){var e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];var i;switch(t.type){case"DirectionalLight":i={direction:new Mt,color:new fi,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new ut};break;case"SpotLight":i={position:new Mt,direction:new Mt,color:new fi,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new ut};break;case"PointLight":i={position:new Mt,color:new fi,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new ut,shadowCameraNear:1,shadowCameraFar:1e3};break;case"HemisphereLight":i={direction:new Mt,skyColor:new fi,groundColor:new fi};break;case"RectAreaLight":i={color:new fi,position:new Mt,halfWidth:new Mt,halfHeight:new Mt}}return e[t.id]=i,i}}},t={hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]},i=new Mt,r=new St,n=new St;return{setup:function(o,a,s){for(var c=0,l=0,h=0,u=0,d=0,p=0,f=0,m=0,g=s.matrixWorldInverse,v=0,y=o.length;v<y;v++){var E=o[v],x=E.color,b=E.intensity,w=E.distance,T=E.shadow&&E.shadow.map?E.shadow.map.texture:null;if(E.isAmbientLight)c+=x.r*b,l+=x.g*b,h+=x.b*b;else if(E.isDirectionalLight){if((S=e.get(E)).color.copy(E.color).multiplyScalar(E.intensity),S.direction.setFromMatrixPosition(E.matrixWorld),i.setFromMatrixPosition(E.target.matrixWorld),S.direction.sub(i),S.direction.transformDirection(g),S.shadow=E.castShadow,E.castShadow){var M=E.shadow;S.shadowBias=M.bias,S.shadowRadius=M.radius,S.shadowMapSize=M.mapSize}t.directionalShadowMap[u]=T,t.directionalShadowMatrix[u]=E.shadow.matrix,t.directional[u]=S,u++}else if(E.isSpotLight)(S=e.get(E)).position.setFromMatrixPosition(E.matrixWorld),S.position.applyMatrix4(g),S.color.copy(x).multiplyScalar(b),S.distance=w,S.direction.setFromMatrixPosition(E.matrixWorld),i.setFromMatrixPosition(E.target.matrixWorld),S.direction.sub(i),S.direction.transformDirection(g),S.coneCos=Math.cos(E.angle),S.penumbraCos=Math.cos(E.angle*(1-E.penumbra)),S.decay=0===E.distance?0:E.decay,S.shadow=E.castShadow,E.castShadow&&(M=E.shadow,S.shadowBias=M.bias,S.shadowRadius=M.radius,S.shadowMapSize=M.mapSize),t.spotShadowMap[p]=T,t.spotShadowMatrix[p]=E.shadow.matrix,t.spot[p]=S,p++;else if(E.isRectAreaLight)(S=e.get(E)).color.copy(x).multiplyScalar(b/(E.width*E.height)),S.position.setFromMatrixPosition(E.matrixWorld),S.position.applyMatrix4(g),n.identity(),r.copy(E.matrixWorld),r.premultiply(g),n.extractRotation(r),S.halfWidth.set(.5*E.width,0,0),S.halfHeight.set(0,.5*E.height,0),S.halfWidth.applyMatrix4(n),S.halfHeight.applyMatrix4(n),t.rectArea[f]=S,f++;else if(E.isPointLight)(S=e.get(E)).position.setFromMatrixPosition(E.matrixWorld),S.position.applyMatrix4(g),S.color.copy(E.color).multiplyScalar(E.intensity),S.distance=E.distance,S.decay=0===E.distance?0:E.decay,S.shadow=E.castShadow,E.castShadow&&(M=E.shadow,S.shadowBias=M.bias,S.shadowRadius=M.radius,S.shadowMapSize=M.mapSize,S.shadowCameraNear=M.camera.near,S.shadowCameraFar=M.camera.far),t.pointShadowMap[d]=T,t.pointShadowMatrix[d]=E.shadow.matrix,t.point[d]=S,d++;else if(E.isHemisphereLight){var S;(S=e.get(E)).direction.setFromMatrixPosition(E.matrixWorld),S.direction.transformDirection(g),S.direction.normalize(),S.skyColor.copy(E.color).multiplyScalar(b),S.groundColor.copy(E.groundColor).multiplyScalar(b),t.hemi[m]=S,m++}}t.ambient[0]=c,t.ambient[1]=l,t.ambient[2]=h,t.directional.length=u,t.spot.length=p,t.rectArea.length=f,t.point.length=d,t.hemi.length=m,t.hash=u+","+d+","+p+","+f+","+m+","+a.length},state:t}}function Vr(e,t,i){var r=e.createShader(t);return e.shaderSource(r,i),e.compileShader(r),!1===e.getShaderParameter(r,e.COMPILE_STATUS)&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==e.getShaderInfoLog(r)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",t===e.VERTEX_SHADER?"vertex":"fragment",e.getShaderInfoLog(r),function(e){for(var t=e.split("\n"),i=0;i<t.length;i++)t[i]=i+1+": "+t[i];return t.join("\n")}(i)),r}Object.assign(ur.prototype,t.prototype,{isGeometry:!0,applyMatrix:function(e){for(var t=(new Ui).getNormalMatrix(e),i=0,r=this.vertices.length;i<r;i++){this.vertices[i].applyMatrix4(e)}for(i=0,r=this.faces.length;i<r;i++){var n=this.faces[i];n.normal.applyMatrix3(t).normalize();for(var o=0,a=n.vertexNormals.length;o<a;o++)n.vertexNormals[o].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(){var e=new St;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new St;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new St;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new St;return function(t,i,r){return e.makeTranslation(t,i,r),this.applyMatrix(e),this}}(),scale:function(){var e=new St;return function(t,i,r){return e.makeScale(t,i,r),this.applyMatrix(e),this}}(),lookAt:(er=new Zi,function(e){er.lookAt(e),er.updateMatrix(),this.applyMatrix(er.matrix)}),fromBufferGeometry:function(e){var t=this,i=null!==e.index?e.index.array:void 0,r=e.attributes,n=r.position.array,o=void 0!==r.normal?r.normal.array:void 0,a=void 0!==r.color?r.color.array:void 0,s=void 0!==r.uv?r.uv.array:void 0,c=void 0!==r.uv2?r.uv2.array:void 0;void 0!==c&&(this.faceVertexUvs[1]=[]);for(var l=[],h=[],u=[],d=0,p=0;d<n.length;d+=3,p+=2)t.vertices.push(new Mt(n[d],n[d+1],n[d+2])),void 0!==o&&l.push(new Mt(o[d],o[d+1],o[d+2])),void 0!==a&&t.colors.push(new fi(a[d],a[d+1],a[d+2])),void 0!==s&&h.push(new ut(s[p],s[p+1])),void 0!==c&&u.push(new ut(c[p],c[p+1]));function f(e,i,r,n){var d=new $i(e,i,r,void 0!==o?[l[e].clone(),l[i].clone(),l[r].clone()]:[],void 0!==a?[t.colors[e].clone(),t.colors[i].clone(),t.colors[r].clone()]:[],n);t.faces.push(d),void 0!==s&&t.faceVertexUvs[0].push([h[e].clone(),h[i].clone(),h[r].clone()]),void 0!==c&&t.faceVertexUvs[1].push([u[e].clone(),u[i].clone(),u[r].clone()])}var m=e.groups;if(m.length>0)for(d=0;d<m.length;d++)for(var g=m[d],v=g.start,y=(p=v,v+g.count);p<y;p+=3)void 0!==i?f(i[p],i[p+1],i[p+2],g.materialIndex):f(p,p+1,p+2,g.materialIndex);else if(void 0!==i)for(d=0;d<i.length;d+=3)f(i[d],i[d+1],i[d+2]);else for(d=0;d<n.length/3;d+=3)f(d,d+1,d+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,i=0===t?1:1/t,r=new St;return r.set(i,0,0,-i*e.x,0,i,0,-i*e.y,0,0,i,-i*e.z,0,0,0,1),this.applyMatrix(r),this},computeFaceNormals:function(){for(var e=new Mt,t=new Mt,i=0,r=this.faces.length;i<r;i++){var n=this.faces[i],o=this.vertices[n.a],a=this.vertices[n.b],s=this.vertices[n.c];e.subVectors(s,a),t.subVectors(o,a),e.cross(t),e.normalize(),n.normal.copy(e)}},computeVertexNormals:function(e){var t,i,r,n,o,a;for(void 0===e&&(e=!0),a=new Array(this.vertices.length),t=0,i=this.vertices.length;t<i;t++)a[t]=new Mt;if(e){var s,c,l,h=new Mt,u=new Mt;for(r=0,n=this.faces.length;r<n;r++)o=this.faces[r],s=this.vertices[o.a],c=this.vertices[o.b],l=this.vertices[o.c],h.subVectors(l,c),u.subVectors(s,c),h.cross(u),a[o.a].add(h),a[o.b].add(h),a[o.c].add(h)}else for(this.computeFaceNormals(),r=0,n=this.faces.length;r<n;r++)a[(o=this.faces[r]).a].add(o.normal),a[o.b].add(o.normal),a[o.c].add(o.normal);for(t=0,i=this.vertices.length;t<i;t++)a[t].normalize();for(r=0,n=this.faces.length;r<n;r++){var d=(o=this.faces[r]).vertexNormals;3===d.length?(d[0].copy(a[o.a]),d[1].copy(a[o.b]),d[2].copy(a[o.c])):(d[0]=a[o.a].clone(),d[1]=a[o.b].clone(),d[2]=a[o.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var e,t,i;for(this.computeFaceNormals(),e=0,t=this.faces.length;e<t;e++){var r=(i=this.faces[e]).vertexNormals;3===r.length?(r[0].copy(i.normal),r[1].copy(i.normal),r[2].copy(i.normal)):(r[0]=i.normal.clone(),r[1]=i.normal.clone(),r[2]=i.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var e,t,i,r,n;for(i=0,r=this.faces.length;i<r;i++)for((n=this.faces[i]).__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]),e=0,t=n.vertexNormals.length;e<t;e++)n.__originalVertexNormals[e]?n.__originalVertexNormals[e].copy(n.vertexNormals[e]):n.__originalVertexNormals[e]=n.vertexNormals[e].clone();var o=new ur;for(o.faces=this.faces,e=0,t=this.morphTargets.length;e<t;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var a=this.morphNormals[e].faceNormals,s=this.morphNormals[e].vertexNormals;for(i=0,r=this.faces.length;i<r;i++)c=new Mt,l={a:new Mt,b:new Mt,c:new Mt},a.push(c),s.push(l)}var c,l,h=this.morphNormals[e];for(o.vertices=this.morphTargets[e].vertices,o.computeFaceNormals(),o.computeVertexNormals(),i=0,r=this.faces.length;i<r;i++)n=this.faces[i],c=h.faceNormals[i],l=h.vertexNormals[i],c.copy(n.normal),l.a.copy(n.vertexNormals[0]),l.b.copy(n.vertexNormals[1]),l.c.copy(n.vertexNormals[2])}for(i=0,r=this.faces.length;i<r;i++)(n=this.faces[i]).normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeLineDistances:function(){for(var e=0,t=this.vertices,i=0,r=t.length;i<r;i++)i>0&&(e+=t[i].distanceTo(t[i-1])),this.lineDistances[i]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Ii),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Oi),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,i){if(e&&e.isGeometry){var r,n=this.vertices.length,o=this.vertices,a=e.vertices,s=this.faces,c=e.faces,l=this.faceVertexUvs[0],h=e.faceVertexUvs[0],u=this.colors,d=e.colors;void 0===i&&(i=0),void 0!==t&&(r=(new Ui).getNormalMatrix(t));for(var p=0,f=a.length;p<f;p++){var m=a[p].clone();void 0!==t&&m.applyMatrix4(t),o.push(m)}for(p=0,f=d.length;p<f;p++)u.push(d[p].clone());for(p=0,f=c.length;p<f;p++){var g,v,y,E=c[p],x=E.vertexNormals,b=E.vertexColors;(g=new $i(E.a+n,E.b+n,E.c+n)).normal.copy(E.normal),void 0!==r&&g.normal.applyMatrix3(r).normalize();for(var w=0,T=x.length;w<T;w++)v=x[w].clone(),void 0!==r&&v.applyMatrix3(r).normalize(),g.vertexNormals.push(v);g.color.copy(E.color);for(w=0,T=b.length;w<T;w++)y=b[w],g.vertexColors.push(y.clone());g.materialIndex=E.materialIndex+i,s.push(g)}for(p=0,f=h.length;p<f;p++){var M=h[p],S=[];if(void 0!==M){for(w=0,T=M.length;w<T;w++)S.push(M[w].clone());l.push(S)}}}else console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e)},mergeMesh:function(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)},mergeVertices:function(){var e,t,i,r,n,o,a,s,c={},l=[],h=[],u=Math.pow(10,4);for(i=0,r=this.vertices.length;i<r;i++)e=this.vertices[i],void 0===c[t=Math.round(e.x*u)+"_"+Math.round(e.y*u)+"_"+Math.round(e.z*u)]?(c[t]=i,l.push(this.vertices[i]),h[i]=l.length-1):h[i]=h[c[t]];var d=[];for(i=0,r=this.faces.length;i<r;i++){(n=this.faces[i]).a=h[n.a],n.b=h[n.b],n.c=h[n.c],o=[n.a,n.b,n.c];for(var p=0;p<3;p++)if(o[p]===o[(p+1)%3]){d.push(i);break}}for(i=d.length-1;i>=0;i--){var f=d[i];for(this.faces.splice(f,1),a=0,s=this.faceVertexUvs.length;a<s;a++)this.faceVertexUvs[a].splice(f,1)}var m=this.vertices.length-l.length;return this.vertices=l,m},sortFacesByMaterialIndex:function(){for(var e=this.faces,t=e.length,i=0;i<t;i++)e[i]._id=i;e.sort(function(e,t){return e.materialIndex-t.materialIndex});var r,n,o=this.faceVertexUvs[0],a=this.faceVertexUvs[1];o&&o.length===t&&(r=[]),a&&a.length===t&&(n=[]);for(i=0;i<t;i++){var s=e[i]._id;r&&r.push(o[s]),n&&n.push(a[s])}r&&(this.faceVertexUvs[0]=r),n&&(this.faceVertexUvs[1]=n)},toJSON:function(){var e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var i in t)void 0!==t[i]&&(e[i]=t[i]);return e}for(var r=[],n=0;n<this.vertices.length;n++){var o=this.vertices[n];r.push(o.x,o.y,o.z)}var a=[],s=[],c={},l=[],h={},u=[],d={};for(n=0;n<this.faces.length;n++){var p=this.faces[n],f=void 0!==this.faceVertexUvs[0][n],m=p.normal.length()>0,g=p.vertexNormals.length>0,v=1!==p.color.r||1!==p.color.g||1!==p.color.b,y=p.vertexColors.length>0,E=0;if(E=T(E=T(E=T(E=T(E=T(E=T(E=T(E=T(E,0,0),1,!0),2,!1),3,f),4,m),5,g),6,v),7,y),a.push(E),a.push(p.a,p.b,p.c),a.push(p.materialIndex),f){var x=this.faceVertexUvs[0][n];a.push(R(x[0]),R(x[1]),R(x[2]))}if(m&&a.push(M(p.normal)),g){var b=p.vertexNormals;a.push(M(b[0]),M(b[1]),M(b[2]))}if(v&&a.push(S(p.color)),y){var w=p.vertexColors;a.push(S(w[0]),S(w[1]),S(w[2]))}}function T(e,t,i){return i?e|1<<t:e&~(1<<t)}function M(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==c[t]?c[t]:(c[t]=s.length/3,s.push(e.x,e.y,e.z),c[t])}function S(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==h[t]?h[t]:(h[t]=l.length,l.push(e.getHex()),h[t])}function R(e){var t=e.x.toString()+e.y.toString();return void 0!==d[t]?d[t]:(d[t]=u.length/2,u.push(e.x,e.y),d[t])}return e.data={},e.data.vertices=r,e.data.normals=s,l.length>0&&(e.data.colors=l),u.length>0&&(e.data.uvs=[u]),e.data.faces=a,e},clone:function(){return(new ur).copy(this)},copy:function(e){var t,i,r,n,o,a;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var s=e.vertices;for(t=0,i=s.length;t<i;t++)this.vertices.push(s[t].clone());var c=e.colors;for(t=0,i=c.length;t<i;t++)this.colors.push(c[t].clone());var l=e.faces;for(t=0,i=l.length;t<i;t++)this.faces.push(l[t].clone());for(t=0,i=e.faceVertexUvs.length;t<i;t++){var h=e.faceVertexUvs[t];for(void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]),r=0,n=h.length;r<n;r++){var u=h[r],d=[];for(o=0,a=u.length;o<a;o++){var p=u[o];d.push(p.clone())}this.faceVertexUvs[t].push(d)}}var f=e.morphTargets;for(t=0,i=f.length;t<i;t++){var m={};if(m.name=f[t].name,void 0!==f[t].vertices)for(m.vertices=[],r=0,n=f[t].vertices.length;r<n;r++)m.vertices.push(f[t].vertices[r].clone());if(void 0!==f[t].normals)for(m.normals=[],r=0,n=f[t].normals.length;r<n;r++)m.normals.push(f[t].normals[r].clone());this.morphTargets.push(m)}var g=e.morphNormals;for(t=0,i=g.length;t<i;t++){var v={};if(void 0!==g[t].vertexNormals)for(v.vertexNormals=[],r=0,n=g[t].vertexNormals.length;r<n;r++){var y=g[t].vertexNormals[r],E={};E.a=y.a.clone(),E.b=y.b.clone(),E.c=y.c.clone(),v.vertexNormals.push(E)}if(void 0!==g[t].faceNormals)for(v.faceNormals=[],r=0,n=g[t].faceNormals.length;r<n;r++)v.faceNormals.push(g[t].faceNormals[r].clone());this.morphNormals.push(v)}var x=e.skinWeights;for(t=0,i=x.length;t<i;t++)this.skinWeights.push(x[t].clone());var b=e.skinIndices;for(t=0,i=b.length;t<i;t++)this.skinIndices.push(b[t].clone());var w=e.lineDistances;for(t=0,i=w.length;t<i;t++)this.lineDistances.push(w[t]);var T=e.boundingBox;null!==T&&(this.boundingBox=T.clone());var M=e.boundingSphere;return null!==M&&(this.boundingSphere=M.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(dr.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(dr.prototype,{isBufferAttribute:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.itemSize:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.dynamic=e.dynamic,this},copyAt:function(e,t,i){e*=this.itemSize,i*=t.itemSize;for(var r=0,n=this.itemSize;r<n;r++)this.array[e+r]=t.array[i+r];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",r),o=new fi),t[i++]=o.r,t[i++]=o.g,t[i++]=o.b}return this},copyIndicesArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];t[i++]=o.a,t[i++]=o.b,t[i++]=o.c}return this},copyVector2sArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",r),o=new ut),t[i++]=o.x,t[i++]=o.y}return this},copyVector3sArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",r),o=new Mt),t[i++]=o.x,t[i++]=o.y,t[i++]=o.z}return this},copyVector4sArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",r),o=new xt),t[i++]=o.x,t[i++]=o.y,t[i++]=o.z,t[i++]=o.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this},setXYZ:function(e,t,i,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=r,this},setXYZW:function(e,t,i,r,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=r,this.array[e+3]=n,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)}}),pr.prototype=Object.create(dr.prototype),pr.prototype.constructor=pr,fr.prototype=Object.create(dr.prototype),fr.prototype.constructor=fr,mr.prototype=Object.create(dr.prototype),mr.prototype.constructor=mr,gr.prototype=Object.create(dr.prototype),gr.prototype.constructor=gr,vr.prototype=Object.create(dr.prototype),vr.prototype.constructor=vr,yr.prototype=Object.create(dr.prototype),yr.prototype.constructor=yr,Er.prototype=Object.create(dr.prototype),Er.prototype.constructor=Er,xr.prototype=Object.create(dr.prototype),xr.prototype.constructor=xr,br.prototype=Object.create(dr.prototype),br.prototype.constructor=br,Object.assign(wr.prototype,{computeGroups:function(e){for(var t,i=[],r=void 0,n=e.faces,o=0;o<n.length;o++){var a=n[o];a.materialIndex!==r&&(r=a.materialIndex,void 0!==t&&(t.count=3*o-t.start,i.push(t)),t={start:3*o,materialIndex:r})}void 0!==t&&(t.count=3*o-t.start,i.push(t)),this.groups=i},fromGeometry:function(e){var t,i=e.faces,r=e.vertices,n=e.faceVertexUvs,o=n[0]&&n[0].length>0,a=n[1]&&n[1].length>0,s=e.morphTargets,c=s.length;if(c>0){t=[];for(var l=0;l<c;l++)t[l]=[];this.morphTargets.position=t}var h,u=e.morphNormals,d=u.length;if(d>0){h=[];for(l=0;l<d;l++)h[l]=[];this.morphTargets.normal=h}var p=e.skinIndices,f=e.skinWeights,m=p.length===r.length,g=f.length===r.length;for(l=0;l<i.length;l++){var v=i[l];this.vertices.push(r[v.a],r[v.b],r[v.c]);var y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{var E=v.normal;this.normals.push(E,E,E)}var x,b=v.vertexColors;if(3===b.length)this.colors.push(b[0],b[1],b[2]);else{var w=v.color;this.colors.push(w,w,w)}if(!0===o)void 0!==(x=n[0][l])?this.uvs.push(x[0],x[1],x[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",l),this.uvs.push(new ut,new ut,new ut));if(!0===a)void 0!==(x=n[1][l])?this.uvs2.push(x[0],x[1],x[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",l),this.uvs2.push(new ut,new ut,new ut));for(var T=0;T<c;T++){var M=s[T].vertices;t[T].push(M[v.a],M[v.b],M[v.c])}for(T=0;T<d;T++){var S=u[T].vertexNormals[l];h[T].push(S.a,S.b,S.c)}m&&this.skinIndices.push(p[v.a],p[v.b],p[v.c]),g&&this.skinWeights.push(f[v.a],f[v.b],f[v.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}}),Mr.MaxIndex=65535,Object.assign(Mr.prototype,t.prototype,{isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){Array.isArray(e)?this.index=new(Tr(e)>65535?Er:vr)(e,1):this.index=e},addAttribute:function(e,t){return t&&t.isBufferAttribute||t&&t.isInterleavedBufferAttribute?"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(t)):(this.attributes[e]=t,this):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(e,new dr(arguments[1],arguments[2])))},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,i){this.groups.push({start:e,count:t,materialIndex:void 0!==i?i:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToBufferAttribute(t),t.needsUpdate=!0);var i=this.attributes.normal;void 0!==i&&((new Ui).getNormalMatrix(e).applyToBufferAttribute(i),i.needsUpdate=!0);return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var e=new St;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new St;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new St;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new St;return function(t,i,r){return e.makeTranslation(t,i,r),this.applyMatrix(e),this}}(),scale:function(){var e=new St;return function(t,i,r){return e.makeScale(t,i,r),this.applyMatrix(e),this}}(),lookAt:function(){var e=new Zi;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},setFromObject:function(e){var t=e.geometry;if(e.isPoints||e.isLine){var i=new xr(3*t.vertices.length,3),r=new xr(3*t.colors.length,3);if(this.addAttribute("position",i.copyVector3sArray(t.vertices)),this.addAttribute("color",r.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){var n=new xr(t.lineDistances.length,1);this.addAttribute("lineDistance",n.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e.isMesh&&t&&t.isGeometry&&this.fromGeometry(t);return this},updateFromObject:function(e){var t,i=e.geometry;if(e.isMesh){var r=i.__directGeometry;if(!0===i.elementsNeedUpdate&&(r=void 0,i.elementsNeedUpdate=!1),void 0===r)return this.fromGeometry(i);r.verticesNeedUpdate=i.verticesNeedUpdate,r.normalsNeedUpdate=i.normalsNeedUpdate,r.colorsNeedUpdate=i.colorsNeedUpdate,r.uvsNeedUpdate=i.uvsNeedUpdate,r.groupsNeedUpdate=i.groupsNeedUpdate,i.verticesNeedUpdate=!1,i.normalsNeedUpdate=!1,i.colorsNeedUpdate=!1,i.uvsNeedUpdate=!1,i.groupsNeedUpdate=!1,i=r}return!0===i.verticesNeedUpdate&&(void 0!==(t=this.attributes.position)&&(t.copyVector3sArray(i.vertices),t.needsUpdate=!0),i.verticesNeedUpdate=!1),!0===i.normalsNeedUpdate&&(void 0!==(t=this.attributes.normal)&&(t.copyVector3sArray(i.normals),t.needsUpdate=!0),i.normalsNeedUpdate=!1),!0===i.colorsNeedUpdate&&(void 0!==(t=this.attributes.color)&&(t.copyColorsArray(i.colors),t.needsUpdate=!0),i.colorsNeedUpdate=!1),i.uvsNeedUpdate&&(void 0!==(t=this.attributes.uv)&&(t.copyVector2sArray(i.uvs),t.needsUpdate=!0),i.uvsNeedUpdate=!1),i.lineDistancesNeedUpdate&&(void 0!==(t=this.attributes.lineDistance)&&(t.copyArray(i.lineDistances),t.needsUpdate=!0),i.lineDistancesNeedUpdate=!1),i.groupsNeedUpdate&&(i.computeGroups(e.geometry),this.groups=i.groups,i.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new wr).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new dr(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){var i=new Float32Array(3*e.normals.length);this.addAttribute("normal",new dr(i,3).copyVector3sArray(e.normals))}if(e.colors.length>0){var r=new Float32Array(3*e.colors.length);this.addAttribute("color",new dr(r,3).copyColorsArray(e.colors))}if(e.uvs.length>0){var n=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new dr(n,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){var o=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new dr(o,2).copyVector2sArray(e.uvs2))}if(e.indices.length>0){var a=new(Tr(e.indices)>65535?Uint32Array:Uint16Array)(3*e.indices.length);this.setIndex(new dr(a,1).copyIndicesArray(e.indices))}for(var s in this.groups=e.groups,e.morphTargets){for(var c=[],l=e.morphTargets[s],h=0,u=l.length;h<u;h++){var d=l[h],p=new xr(3*d.length,3);c.push(p.copyVector3sArray(d))}this.morphAttributes[s]=c}if(e.skinIndices.length>0){var f=new xr(4*e.skinIndices.length,4);this.addAttribute("skinIndex",f.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var m=new xr(4*e.skinWeights.length,4);this.addAttribute("skinWeight",m.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Ii);var e=this.attributes.position;void 0!==e?this.boundingBox.setFromBufferAttribute(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){var e=new Ii,t=new Mt;return function(){null===this.boundingSphere&&(this.boundingSphere=new Oi);var i=this.attributes.position;if(i){var r=this.boundingSphere.center;e.setFromBufferAttribute(i),e.getCenter(r);for(var n=0,o=0,a=i.count;o<a;o++)t.x=i.getX(o),t.y=i.getY(o),t.z=i.getZ(o),n=Math.max(n,r.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes,i=this.groups;if(t.position){var r=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new dr(new Float32Array(r.length),3));else for(var n=t.normal.array,o=0,a=n.length;o<a;o++)n[o]=0;var s,c,l,h=t.normal.array,u=new Mt,d=new Mt,p=new Mt,f=new Mt,m=new Mt;if(e){var g=e.array;0===i.length&&this.addGroup(0,g.length);for(var v=0,y=i.length;v<y;++v){var E=i[v],x=E.start;for(o=x,a=x+E.count;o<a;o+=3)s=3*g[o+0],c=3*g[o+1],l=3*g[o+2],u.fromArray(r,s),d.fromArray(r,c),p.fromArray(r,l),f.subVectors(p,d),m.subVectors(u,d),f.cross(m),h[s]+=f.x,h[s+1]+=f.y,h[s+2]+=f.z,h[c]+=f.x,h[c+1]+=f.y,h[c+2]+=f.z,h[l]+=f.x,h[l+1]+=f.y,h[l+2]+=f.z}}else for(o=0,a=r.length;o<a;o+=9)u.fromArray(r,o),d.fromArray(r,o+3),p.fromArray(r,o+6),f.subVectors(p,d),m.subVectors(u,d),f.cross(m),h[o]=f.x,h[o+1]=f.y,h[o+2]=f.z,h[o+3]=f.x,h[o+4]=f.y,h[o+5]=f.z,h[o+6]=f.x,h[o+7]=f.y,h[o+8]=f.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},merge:function(e,t){if(e&&e.isBufferGeometry){void 0===t&&(t=0);var i=this.attributes;for(var r in i)if(void 0!==e.attributes[r])for(var n=i[r].array,o=e.attributes[r],a=o.array,s=0,c=o.itemSize*t;s<a.length;s++,c++)n[c]=a[s];return this}console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e)},normalizeNormals:(tr=new Mt,function(){for(var e=this.attributes.normal,t=0,i=e.count;t<i;t++)tr.x=e.getX(t),tr.y=e.getY(t),tr.z=e.getZ(t),tr.normalize(),e.setXYZ(t,tr.x,tr.y,tr.z)}),toNonIndexed:function(){if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var e=new Mr,t=this.index.array,i=this.attributes;for(var r in i){for(var n=i[r],o=n.array,a=n.itemSize,s=new o.constructor(t.length*a),c=0,l=0,h=0,u=t.length;h<u;h++){c=t[h]*a;for(var d=0;d<a;d++)s[l++]=o[c++]}e.addAttribute(r,new dr(s,a))}return e},toJSON:function(){var e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};var r=this.index;if(null!==r){var n=Array.prototype.slice.call(r.array);e.data.index={type:r.array.constructor.name,array:n}}var o=this.attributes;for(var i in o){var a=o[i];n=Array.prototype.slice.call(a.array);e.data.attributes[i]={itemSize:a.itemSize,type:a.array.constructor.name,array:n,normalized:a.normalized}}var s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));var c=this.boundingSphere;return null!==c&&(e.data.boundingSphere={center:c.center.toArray(),radius:c.radius}),e},clone:function(){return(new Mr).copy(this)},copy:function(e){var t,i,r;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var n=e.index;null!==n&&this.setIndex(n.clone());var o=e.attributes;for(t in o){var a=o[t];this.addAttribute(t,a.clone())}var s=e.morphAttributes;for(t in s){var c=[],l=s[t];for(i=0,r=l.length;i<r;i++)c.push(l[i].clone());this.morphAttributes[t]=c}var h=e.groups;for(i=0,r=h.length;i<r;i++){var u=h[i];this.addGroup(u.start,u.count,u.materialIndex)}var d=e.boundingBox;null!==d&&(this.boundingBox=d.clone());var p=e.boundingSphere;return null!==p&&(this.boundingSphere=p.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Sr.prototype=Object.create(ur.prototype),Sr.prototype.constructor=Sr,Rr.prototype=Object.create(Mr.prototype),Rr.prototype.constructor=Rr,Ar.prototype=Object.create(ur.prototype),Ar.prototype.constructor=Ar,_r.prototype=Object.create(Mr.prototype),_r.prototype.constructor=_r,Dr.prototype=Object.create(Li.prototype),Dr.prototype.constructor=Dr,Dr.prototype.isMeshBasicMaterial=!0,Dr.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this},Object.assign(Cr.prototype,{set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){return(t||new Mt).copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:function(){var e=new Mt;return function(t){return this.origin.copy(this.at(t,e)),this}}(),closestPointToPoint:function(e,t){var i=t||new Mt;i.subVectors(e,this.origin);var r=i.dot(this.direction);return r<0?i.copy(this.origin):i.copy(this.direction).multiplyScalar(r).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(){var e=new Mt;return function(t){var i=e.subVectors(t,this.origin).dot(this.direction);return i<0?this.origin.distanceToSquared(t):(e.copy(this.direction).multiplyScalar(i).add(this.origin),e.distanceToSquared(t))}}(),distanceSqToSegment:(rr=new Mt,nr=new Mt,or=new Mt,function(e,t,i,r){rr.copy(e).add(t).multiplyScalar(.5),nr.copy(t).sub(e).normalize(),or.copy(this.origin).sub(rr);var n,o,a,s,c=.5*e.distanceTo(t),l=-this.direction.dot(nr),h=or.dot(this.direction),u=-or.dot(nr),d=or.lengthSq(),p=Math.abs(1-l*l);if(p>0)if(o=l*h-u,s=c*p,(n=l*u-h)>=0)if(o>=-s)if(o<=s){var f=1/p;a=(n*=f)*(n+l*(o*=f)+2*h)+o*(l*n+o+2*u)+d}else o=c,a=-(n=Math.max(0,-(l*o+h)))*n+o*(o+2*u)+d;else o=-c,a=-(n=Math.max(0,-(l*o+h)))*n+o*(o+2*u)+d;else o<=-s?a=-(n=Math.max(0,-(-l*c+h)))*n+(o=n>0?-c:Math.min(Math.max(-c,-u),c))*(o+2*u)+d:o<=s?(n=0,a=(o=Math.min(Math.max(-c,-u),c))*(o+2*u)+d):a=-(n=Math.max(0,-(l*c+h)))*n+(o=n>0?c:Math.min(Math.max(-c,-u),c))*(o+2*u)+d;else o=l>0?-c:c,a=-(n=Math.max(0,-(l*o+h)))*n+o*(o+2*u)+d;return i&&i.copy(this.direction).multiplyScalar(n).add(this.origin),r&&r.copy(nr).multiplyScalar(o).add(rr),a}),intersectSphere:function(){var e=new Mt;return function(t,i){e.subVectors(t.center,this.origin);var r=e.dot(this.direction),n=e.dot(e)-r*r,o=t.radius*t.radius;if(n>o)return null;var a=Math.sqrt(o-n),s=r-a,c=r+a;return s<0&&c<0?null:s<0?this.at(c,i):this.at(s,i)}}(),intersectsSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null},intersectPlane:function(e,t){var i=this.distanceToPlane(e);return null===i?null:this.at(i,t)},intersectsPlane:function(e){var t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0},intersectBox:function(e,t){var i,r,n,o,a,s,c=1/this.direction.x,l=1/this.direction.y,h=1/this.direction.z,u=this.origin;return c>=0?(i=(e.min.x-u.x)*c,r=(e.max.x-u.x)*c):(i=(e.max.x-u.x)*c,r=(e.min.x-u.x)*c),l>=0?(n=(e.min.y-u.y)*l,o=(e.max.y-u.y)*l):(n=(e.max.y-u.y)*l,o=(e.min.y-u.y)*l),i>o||n>r?null:((n>i||i!=i)&&(i=n),(o<r||r!=r)&&(r=o),h>=0?(a=(e.min.z-u.z)*h,s=(e.max.z-u.z)*h):(a=(e.max.z-u.z)*h,s=(e.min.z-u.z)*h),i>s||a>r?null:((a>i||i!=i)&&(i=a),(s<r||r!=r)&&(r=s),r<0?null:this.at(i>=0?i:r,t)))},intersectsBox:(ir=new Mt,function(e){return null!==this.intersectBox(e,ir)}),intersectTriangle:function(){var e=new Mt,t=new Mt,i=new Mt,r=new Mt;return function(n,o,a,s,c){t.subVectors(o,n),i.subVectors(a,n),r.crossVectors(t,i);var l,h=this.direction.dot(r);if(h>0){if(s)return null;l=1}else{if(!(h<0))return null;l=-1,h=-h}e.subVectors(this.origin,n);var u=l*this.direction.dot(i.crossVectors(e,i));if(u<0)return null;var d=l*this.direction.dot(t.cross(e));if(d<0)return null;if(u+d>h)return null;var p=-l*e.dot(r);return p<0?null:this.at(p/h,c)}}(),applyMatrix4:function(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}}),Object.assign(Lr.prototype,{set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},getCenter:function(e){return(e||new Mt).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){return(e||new Mt).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){var i=t||new Mt;return this.delta(i).multiplyScalar(e).add(this.start)},closestPointToPointParameter:(ar=new Mt,sr=new Mt,function(e,t){ar.subVectors(e,this.start),sr.subVectors(this.end,this.start);var i=sr.dot(sr),r=sr.dot(ar)/i;return t&&(r=ht.clamp(r,0,1)),r}),closestPointToPoint:function(e,t,i){var r=this.closestPointToPointParameter(e,t),n=i||new Mt;return this.delta(n).multiplyScalar(r).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)}}),Object.assign(Pr,{normal:(cr=new Mt,function(e,t,i,r){var n=r||new Mt;n.subVectors(i,t),cr.subVectors(e,t),n.cross(cr);var o=n.lengthSq();return o>0?n.multiplyScalar(1/Math.sqrt(o)):n.set(0,0,0)}),barycoordFromPoint:function(){var e=new Mt,t=new Mt,i=new Mt;return function(r,n,o,a,s){e.subVectors(a,n),t.subVectors(o,n),i.subVectors(r,n);var c=e.dot(e),l=e.dot(t),h=e.dot(i),u=t.dot(t),d=t.dot(i),p=c*u-l*l,f=s||new Mt;if(0===p)return f.set(-2,-1,-1);var m=1/p,g=(u*h-l*d)*m,v=(c*d-l*h)*m;return f.set(1-g-v,v,g)}}(),containsPoint:function(){var e=new Mt;return function(t,i,r,n){var o=Pr.barycoordFromPoint(t,i,r,n,e);return o.x>=0&&o.y>=0&&o.x+o.y<=1}}()}),Object.assign(Pr.prototype,{set:function(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this},setFromPointsAndIndices:function(e,t,i,r){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[r]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var e=new Mt,t=new Mt;return function(){return e.subVectors(this.c,this.b),t.subVectors(this.a,this.b),.5*e.cross(t).length()}}(),midpoint:function(e){return(e||new Mt).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return Pr.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new Ni).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return Pr.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return Pr.containsPoint(e,this.a,this.b,this.c)},closestPointToPoint:function(){var e=new Ni,t=[new Lr,new Lr,new Lr],i=new Mt,r=new Mt;return function(n,o){var a=o||new Mt,s=1/0;if(e.setFromCoplanarPoints(this.a,this.b,this.c),e.projectPoint(n,i),!0===this.containsPoint(i))a.copy(i);else{t[0].set(this.a,this.b),t[1].set(this.b,this.c),t[2].set(this.c,this.a);for(var c=0;c<t.length;c++){t[c].closestPointToPoint(i,!0,r);var l=i.distanceToSquared(r);l<s&&(s=l,a.copy(r))}}return a}}(),equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}),Hr.prototype=Object.assign(Object.create(Zi.prototype),{constructor:Hr,isMesh:!0,setDrawMode:function(e){this.drawMode=e},copy:function(e){return Zi.prototype.copy.call(this,e),this.drawMode=e.drawMode,this},updateMorphTargets:function(){var e,t,i,r=this.geometry;if(r.isBufferGeometry){var n=r.morphAttributes,o=Object.keys(n);if(o.length>0){var a=n[o[0]];if(void 0!==a)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},e=0,t=a.length;e<t;e++)i=a[e].name||String(e),this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}else{var s=r.morphTargets;if(void 0!==s&&s.length>0)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},e=0,t=s.length;e<t;e++)i=s[e].name||String(e),this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}},raycast:function(){var e=new St,t=new Cr,i=new Oi,r=new Mt,n=new Mt,o=new Mt,a=new Mt,s=new Mt,c=new Mt,l=new ut,h=new ut,u=new ut,d=new Mt,p=new Mt,f=new Mt;function m(e,t,i,r,n,o,a){return Pr.barycoordFromPoint(e,t,i,r,d),n.multiplyScalar(d.x),o.multiplyScalar(d.y),a.multiplyScalar(d.z),n.add(o).add(a),n.clone()}function y(e,t,i,r,n,o,a,s){if(null===(t.side===g?r.intersectTriangle(a,o,n,!0,s):r.intersectTriangle(n,o,a,t.side!==v,s)))return null;f.copy(s),f.applyMatrix4(e.matrixWorld);var c=i.ray.origin.distanceTo(f);return c<i.near||c>i.far?null:{distance:c,point:f.clone(),object:e}}function E(e,t,i,a,s,c,d,f){r.fromBufferAttribute(a,c),n.fromBufferAttribute(a,d),o.fromBufferAttribute(a,f);var g=y(e,e.material,t,i,r,n,o,p);return g&&(s&&(l.fromBufferAttribute(s,c),h.fromBufferAttribute(s,d),u.fromBufferAttribute(s,f),g.uv=m(p,r,n,o,l,h,u)),g.face=new $i(c,d,f,Pr.normal(r,n,o)),g.faceIndex=c),g}return function(d,f){var g,v=this.geometry,x=this.material,b=this.matrixWorld;if(void 0!==x&&(null===v.boundingSphere&&v.computeBoundingSphere(),i.copy(v.boundingSphere),i.applyMatrix4(b),!1!==d.ray.intersectsSphere(i)&&(e.getInverse(b),t.copy(d.ray).applyMatrix4(e),null===v.boundingBox||!1!==t.intersectsBox(v.boundingBox))))if(v.isBufferGeometry){var w,T,M,S,R,A=v.index,_=v.attributes.position,D=v.attributes.uv;if(null!==A)for(S=0,R=A.count;S<R;S+=3)w=A.getX(S),T=A.getX(S+1),M=A.getX(S+2),(g=E(this,d,t,_,D,w,T,M))&&(g.faceIndex=Math.floor(S/3),f.push(g));else for(S=0,R=_.count;S<R;S+=3)(g=E(this,d,t,_,D,w=S,T=S+1,M=S+2))&&(g.index=w,f.push(g))}else if(v.isGeometry){var C,L,P,H,B=Array.isArray(x),I=v.vertices,O=v.faces,U=v.faceVertexUvs[0];U.length>0&&(H=U);for(var N=0,V=O.length;N<V;N++){var F=O[N],z=B?x[F.materialIndex]:x;if(void 0!==z){if(C=I[F.a],L=I[F.b],P=I[F.c],!0===z.morphTargets){var j=v.morphTargets,k=this.morphTargetInfluences;r.set(0,0,0),n.set(0,0,0),o.set(0,0,0);for(var G=0,W=j.length;G<W;G++){var X=k[G];if(0!==X){var Y=j[G].vertices;r.addScaledVector(a.subVectors(Y[F.a],C),X),n.addScaledVector(s.subVectors(Y[F.b],L),X),o.addScaledVector(c.subVectors(Y[F.c],P),X)}}r.add(C),n.add(L),o.add(P),C=r,L=n,P=o}if(g=y(this,z,d,t,C,L,P,p)){if(H&&H[N]){var q=H[N];l.copy(q[0]),h.copy(q[1]),u.copy(q[2]),g.uv=m(p,C,L,P,l,h,u)}g.face=F,g.faceIndex=N,f.push(g)}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}});var Fr,zr,jr,kr,Gr,Wr,Xr=0;function Yr(e){switch(e){case tt:return["Linear","( value )"];case it:return["sRGB","( value )"];case nt:return["RGBE","( value )"];case ot:return["RGBM","( value, 7.0 )"];case at:return["RGBM","( value, 16.0 )"];case st:return["RGBD","( value, 256.0 )"];case rt:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+e)}}function qr(e,t){var i=Yr(t);return"vec4 "+e+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function Zr(e){return""!==e}function Jr(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights)}function Qr(e){return e.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,function(e,t){var i=vi[t];if(void 0===i)throw new Error("Can not resolve #include <"+t+">");return Qr(i)})}function Kr(e){return e.replace(/for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,function(e,t,i,r){for(var n="",o=parseInt(t);o<parseInt(i);o++)n+=r.replace(/\[ i \]/g,"[ "+o+" ]");return n})}function $r(e,t,i,r,n,o){var a=e.context,s=r.defines,c=n.vertexShader,l=n.fragmentShader,h="SHADOWMAP_TYPE_BASIC";o.shadowMapType===p?h="SHADOWMAP_TYPE_PCF":o.shadowMapType===f&&(h="SHADOWMAP_TYPE_PCF_SOFT");var u="ENVMAP_TYPE_CUBE",d="ENVMAP_MODE_REFLECTION",m="ENVMAP_BLENDING_MULTIPLY";if(o.envMap){switch(r.envMap.mapping){case oe:case ae:u="ENVMAP_TYPE_CUBE";break;case he:case ue:u="ENVMAP_TYPE_CUBE_UV";break;case se:case ce:u="ENVMAP_TYPE_EQUIREC";break;case le:u="ENVMAP_TYPE_SPHERE"}switch(r.envMap.mapping){case ae:case ce:d="ENVMAP_MODE_REFRACTION"}switch(r.combine){case Q:m="ENVMAP_BLENDING_MULTIPLY";break;case K:m="ENVMAP_BLENDING_MIX";break;case $:m="ENVMAP_BLENDING_ADD"}}var g,v,y,E,x,b=e.gammaFactor>0?e.gammaFactor:1,w=function(e,t,i){return[(e=e||{}).derivatives||t.envMapCubeUV||t.bumpMap||t.normalMap||t.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(e.fragDepth||t.logarithmicDepthBuffer)&&i.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",e.drawBuffers&&i.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(e.shaderTextureLOD||t.envMap)&&i.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Zr).join("\n")}(r.extensions,o,t),T=function(e){var t=[];for(var i in e){var r=e[i];!1!==r&&t.push("#define "+i+" "+r)}return t.join("\n")}(s),M=a.createProgram();r.isRawShaderMaterial?(g=[T,"\n"].filter(Zr).join("\n"),v=[w,T,"\n"].filter(Zr).join("\n")):(g=["precision "+o.precision+" float;","precision "+o.precision+" int;","#define SHADER_NAME "+n.name,T,o.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+b,"#define MAX_BONES "+o.maxBones,o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fogExp?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.envMap?"#define "+d:"",o.lightMap?"#define USE_LIGHTMAP":"",o.aoMap?"#define USE_AOMAP":"",o.emissiveMap?"#define USE_EMISSIVEMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.normalMap?"#define USE_NORMALMAP":"",o.displacementMap&&o.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.roughnessMap?"#define USE_ROUGHNESSMAP":"",o.metalnessMap?"#define USE_METALNESSMAP":"",o.alphaMap?"#define USE_ALPHAMAP":"",o.vertexColors?"#define USE_COLOR":"",o.flatShading?"#define FLAT_SHADED":"",o.skinning?"#define USE_SKINNING":"",o.useVertexTexture?"#define BONE_TEXTURE":"",o.morphTargets?"#define USE_MORPHTARGETS":"",o.morphNormals&&!1===o.flatShading?"#define USE_MORPHNORMALS":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+o.numClippingPlanes,o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapEnabled?"#define "+h:"",o.sizeAttenuation?"#define USE_SIZEATTENUATION":"",o.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",o.logarithmicDepthBuffer&&t.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Zr).join("\n"),v=[w,"precision "+o.precision+" float;","precision "+o.precision+" int;","#define SHADER_NAME "+n.name,T,o.alphaTest?"#define ALPHATEST "+o.alphaTest:"","#define GAMMA_FACTOR "+b,o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fogExp?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.envMap?"#define "+u:"",o.envMap?"#define "+d:"",o.envMap?"#define "+m:"",o.lightMap?"#define USE_LIGHTMAP":"",o.aoMap?"#define USE_AOMAP":"",o.emissiveMap?"#define USE_EMISSIVEMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.normalMap?"#define USE_NORMALMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.roughnessMap?"#define USE_ROUGHNESSMAP":"",o.metalnessMap?"#define USE_METALNESSMAP":"",o.alphaMap?"#define USE_ALPHAMAP":"",o.vertexColors?"#define USE_COLOR":"",o.gradientMap?"#define USE_GRADIENTMAP":"",o.flatShading?"#define FLAT_SHADED":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+o.numClippingPlanes,"#define UNION_CLIPPING_PLANES "+(o.numClippingPlanes-o.numClipIntersection),o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapEnabled?"#define "+h:"",o.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",o.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",o.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",o.logarithmicDepthBuffer&&t.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"",o.envMap&&t.get("EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",o.toneMapping!==ee?"#define TONE_MAPPING":"",o.toneMapping!==ee?vi.tonemapping_pars_fragment:"",o.toneMapping!==ee?function(e,t){var i;switch(t){case te:i="Linear";break;case ie:i="Reinhard";break;case re:i="Uncharted2";break;case ne:i="OptimizedCineon";break;default:throw new Error("unsupported toneMapping: "+t)}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}("toneMapping",o.toneMapping):"",o.dithering?"#define DITHERING":"",o.outputEncoding||o.mapEncoding||o.envMapEncoding||o.emissiveMapEncoding?vi.encodings_pars_fragment:"",o.mapEncoding?qr("mapTexelToLinear",o.mapEncoding):"",o.envMapEncoding?qr("envMapTexelToLinear",o.envMapEncoding):"",o.emissiveMapEncoding?qr("emissiveMapTexelToLinear",o.emissiveMapEncoding):"",o.outputEncoding?(y="linearToOutputTexel",E=o.outputEncoding,x=Yr(E),"vec4 "+y+"( vec4 value ) { return LinearTo"+x[0]+x[1]+"; }"):"",o.depthPacking?"#define DEPTH_PACKING "+r.depthPacking:"","\n"].filter(Zr).join("\n")),c=Jr(c=Qr(c),o),l=Jr(l=Qr(l),o),r.isShaderMaterial||(c=Kr(c),l=Kr(l));var S=g+c,R=v+l,A=Vr(a,a.VERTEX_SHADER,S),_=Vr(a,a.FRAGMENT_SHADER,R);a.attachShader(M,A),a.attachShader(M,_),void 0!==r.index0AttributeName?a.bindAttribLocation(M,0,r.index0AttributeName):!0===o.morphTargets&&a.bindAttribLocation(M,0,"position"),a.linkProgram(M);var D,C,L=a.getProgramInfoLog(M),P=a.getShaderInfoLog(A),H=a.getShaderInfoLog(_),B=!0,I=!0;return!1===a.getProgramParameter(M,a.LINK_STATUS)?(B=!1,console.error("THREE.WebGLProgram: shader error: ",a.getError(),"gl.VALIDATE_STATUS",a.getProgramParameter(M,a.VALIDATE_STATUS),"gl.getProgramInfoLog",L,P,H)):""!==L?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",L):""!==P&&""!==H||(I=!1),I&&(this.diagnostics={runnable:B,material:r,programLog:L,vertexShader:{log:P,prefix:g},fragmentShader:{log:H,prefix:v}}),a.deleteShader(A),a.deleteShader(_),this.getUniforms=function(){return void 0===D&&(D=new di(a,M,e)),D},this.getAttributes=function(){return void 0===C&&(C=function(e,t,i){for(var r={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),o=0;o<n;o++){var a=e.getActiveAttrib(t,o).name;r[a]=e.getAttribLocation(t,a)}return r}(a,M)),C},this.destroy=function(){a.deleteProgram(M),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.id=Xr++,this.code=i,this.usedTimes=1,this.program=M,this.vertexShader=A,this.fragmentShader=_,this}function en(e,t,i){var r=[],n={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow"},o=["precision","supportsVertexTextures","map","mapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering"];function a(e,t){var i;return e?e.isTexture?i=e.encoding:e.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),i=e.texture.encoding):i=tt,i===tt&&t&&(i=rt),i}this.getParameters=function(t,r,o,s,c,l,h){var u=n[t.type],d=h.isSkinnedMesh?function(e){var t=e.skeleton.bones;if(i.floatVertexTextures)return 1024;var r=i.maxVertexUniforms,n=Math.floor((r-20)/4),o=Math.min(n,t.length);return o<t.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+t.length+" bones. This GPU supports "+o+"."),0):o}(h):0,p=i.precision;null!==t.precision&&(p=i.getMaxPrecision(t.precision))!==t.precision&&console.warn("THREE.WebGLProgram.getParameters:",t.precision,"not supported, using",p,"instead.");var f=e.getRenderTarget();return{shaderID:u,precision:p,supportsVertexTextures:i.vertexTextures,outputEncoding:a(f?f.texture:null,e.gammaOutput),map:!!t.map,mapEncoding:a(t.map,e.gammaInput),envMap:!!t.envMap,envMapMode:t.envMap&&t.envMap.mapping,envMapEncoding:a(t.envMap,e.gammaInput),envMapCubeUV:!!t.envMap&&(t.envMap.mapping===he||t.envMap.mapping===ue),lightMap:!!t.lightMap,aoMap:!!t.aoMap,emissiveMap:!!t.emissiveMap,emissiveMapEncoding:a(t.emissiveMap,e.gammaInput),bumpMap:!!t.bumpMap,normalMap:!!t.normalMap,displacementMap:!!t.displacementMap,roughnessMap:!!t.roughnessMap,metalnessMap:!!t.metalnessMap,specularMap:!!t.specularMap,alphaMap:!!t.alphaMap,gradientMap:!!t.gradientMap,combine:t.combine,vertexColors:t.vertexColors,fog:!!s,useFog:t.fog,fogExp:s&&s.isFogExp2,flatShading:t.flatShading,sizeAttenuation:t.sizeAttenuation,logarithmicDepthBuffer:i.logarithmicDepthBuffer,skinning:t.skinning&&d>0,maxBones:d,useVertexTexture:i.floatVertexTextures,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:r.directional.length,numPointLights:r.point.length,numSpotLights:r.spot.length,numRectAreaLights:r.rectArea.length,numHemiLights:r.hemi.length,numClippingPlanes:c,numClipIntersection:l,dithering:t.dithering,shadowMapEnabled:e.shadowMap.enabled&&h.receiveShadow&&o.length>0,shadowMapType:e.shadowMap.type,toneMapping:e.toneMapping,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:t.premultipliedAlpha,alphaTest:t.alphaTest,doubleSided:t.side===v,flipSided:t.side===g,depthPacking:void 0!==t.depthPacking&&t.depthPacking}},this.getProgramCode=function(t,i){var r=[];if(i.shaderID?r.push(i.shaderID):(r.push(t.fragmentShader),r.push(t.vertexShader)),void 0!==t.defines)for(var n in t.defines)r.push(n),r.push(t.defines[n]);for(var a=0;a<o.length;a++)r.push(i[o[a]]);return r.push(t.onBeforeCompile.toString()),r.push(e.gammaOutput),r.join()},this.acquireProgram=function(i,n,o,a){for(var s,c=0,l=r.length;c<l;c++){var h=r[c];if(h.code===a){++(s=h).usedTimes;break}}return void 0===s&&(s=new $r(e,t,a,i,n,o),r.push(s)),s},this.releaseProgram=function(e){if(0==--e.usedTimes){var t=r.indexOf(e);r[t]=r[r.length-1],r.pop(),e.destroy()}},this.programs=r}function tn(e,t,i,r,n,o,a){var s="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext;function c(e,t){if(e.width>t||e.height>t){var i=t/Math.max(e.width,e.height),r=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return r.width=Math.floor(e.width*i),r.height=Math.floor(e.height*i),r.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,r.width,r.height),console.warn("THREE.WebGLRenderer: image is too big ("+e.width+"x"+e.height+"). Resized to "+r.width+"x"+r.height,e),r}return e}function l(e){return ht.isPowerOfTwo(e.width)&&ht.isPowerOfTwo(e.height)}function h(e,t){return e.generateMipmaps&&t&&e.minFilter!==me&&e.minFilter!==ye}function u(t){return t===me||t===ge||t===ve?e.NEAREST:e.LINEAR}function d(t){var i=t.target;i.removeEventListener("dispose",d),function(t){var i=r.get(t);if(t.image&&i.__image__webglTextureCube)e.deleteTexture(i.__image__webglTextureCube);else{if(void 0===i.__webglInit)return;e.deleteTexture(i.__webglTexture)}r.remove(t)}(i),a.textures--}function p(t){var i=t.target;i.removeEventListener("dispose",p),function(t){var i=r.get(t),n=r.get(t.texture);if(!t)return;void 0!==n.__webglTexture&&e.deleteTexture(n.__webglTexture);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLRenderTargetCube)for(var o=0;o<6;o++)e.deleteFramebuffer(i.__webglFramebuffer[o]),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer[o]);else e.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer);r.remove(t.texture),r.remove(t)}(i),a.textures--}function f(t,u){var p=r.get(t);if(t.version>0&&p.__version!==t.version){var f=t.image;if(void 0===f)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",t);else{if(!1!==f.complete)return void function(t,r,u){void 0===t.__webglInit&&(t.__webglInit=!0,r.addEventListener("dispose",d),t.__webglTexture=e.createTexture(),a.textures++);i.activeTexture(e.TEXTURE0+u),i.bindTexture(e.TEXTURE_2D,t.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,r.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,r.unpackAlignment);var p=c(r.image,n.maxTextureSize);(function(e){return e.wrapS!==pe||e.wrapT!==pe||e.minFilter!==me&&e.minFilter!==ye})(r)&&!1===l(p)&&(p=function(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){var t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.width=ht.nearestPowerOfTwo(e.width),t.height=ht.nearestPowerOfTwo(e.height),t.getContext("2d").drawImage(e,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}(p));var f=l(p),g=o.convert(r.format),v=o.convert(r.type);m(e.TEXTURE_2D,r,f);var y,E=r.mipmaps;if(r.isDepthTexture){var x=e.DEPTH_COMPONENT;if(r.type===Ae){if(!s)throw new Error("Float Depth Texture only supported in WebGL2.0");x=e.DEPTH_COMPONENT32F}else s&&(x=e.DEPTH_COMPONENT16);r.format===Ve&&x===e.DEPTH_COMPONENT&&r.type!==Me&&r.type!==Re&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),r.type=Me,v=o.convert(r.type)),r.format===Fe&&(x=e.DEPTH_STENCIL,r.type!==Pe&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),r.type=Pe,v=o.convert(r.type))),i.texImage2D(e.TEXTURE_2D,0,x,p.width,p.height,0,g,v,null)}else if(r.isDataTexture)if(E.length>0&&f){for(var b=0,w=E.length;b<w;b++)y=E[b],i.texImage2D(e.TEXTURE_2D,b,g,y.width,y.height,0,g,v,y.data);r.generateMipmaps=!1}else i.texImage2D(e.TEXTURE_2D,0,g,p.width,p.height,0,g,v,p.data);else if(r.isCompressedTexture)for(var b=0,w=E.length;b<w;b++)y=E[b],r.format!==Ie&&r.format!==Be?i.getCompressedTextureFormats().indexOf(g)>-1?i.compressedTexImage2D(e.TEXTURE_2D,b,g,y.width,y.height,0,y.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(e.TEXTURE_2D,b,g,y.width,y.height,0,g,v,y.data);else if(E.length>0&&f){for(var b=0,w=E.length;b<w;b++)y=E[b],i.texImage2D(e.TEXTURE_2D,b,g,g,v,y);r.generateMipmaps=!1}else i.texImage2D(e.TEXTURE_2D,0,g,g,v,p);h(r,f)&&e.generateMipmap(e.TEXTURE_2D);t.__version=r.version,r.onUpdate&&r.onUpdate(r)}(p,t,u);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",t)}}i.activeTexture(e.TEXTURE0+u),i.bindTexture(e.TEXTURE_2D,p.__webglTexture)}function m(i,a,s){var c;if(s?(e.texParameteri(i,e.TEXTURE_WRAP_S,o.convert(a.wrapS)),e.texParameteri(i,e.TEXTURE_WRAP_T,o.convert(a.wrapT)),e.texParameteri(i,e.TEXTURE_MAG_FILTER,o.convert(a.magFilter)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,o.convert(a.minFilter))):(e.texParameteri(i,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(i,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),a.wrapS===pe&&a.wrapT===pe||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",a),e.texParameteri(i,e.TEXTURE_MAG_FILTER,u(a.magFilter)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,u(a.minFilter)),a.minFilter!==me&&a.minFilter!==ye&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",a)),c=t.get("EXT_texture_filter_anisotropic")){if(a.type===Ae&&null===t.get("OES_texture_float_linear"))return;if(a.type===_e&&null===t.get("OES_texture_half_float_linear"))return;(a.anisotropy>1||r.get(a).__currentAnisotropy)&&(e.texParameterf(i,c.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(a.anisotropy,n.getMaxAnisotropy())),r.get(a).__currentAnisotropy=a.anisotropy)}}function g(t,n,a,s){var c=o.convert(n.texture.format),l=o.convert(n.texture.type);i.texImage2D(s,0,c,n.width,n.height,0,c,l,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,a,s,r.get(n.texture).__webglTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}function v(t,i){e.bindRenderbuffer(e.RENDERBUFFER,t),i.depthBuffer&&!i.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)):i.depthBuffer&&i.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)):e.renderbufferStorage(e.RENDERBUFFER,e.RGBA4,i.width,i.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}function y(t){var i=r.get(t),n=!0===t.isWebGLRenderTargetCube;if(t.depthTexture){if(n)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,i){if(i&&i.isWebGLRenderTargetCube)throw new Error("Depth Texture with cube render targets is not supported");if(e.bindFramebuffer(e.FRAMEBUFFER,t),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");r.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),f(i.depthTexture,0);var n=r.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===Ve)e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,n,0);else{if(i.depthTexture.format!==Fe)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,n,0)}}(i.__webglFramebuffer,t)}else if(n){i.__webglDepthbuffer=[];for(var o=0;o<6;o++)e.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer[o]),i.__webglDepthbuffer[o]=e.createRenderbuffer(),v(i.__webglDepthbuffer[o],t)}else e.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer),i.__webglDepthbuffer=e.createRenderbuffer(),v(i.__webglDepthbuffer,t);e.bindFramebuffer(e.FRAMEBUFFER,null)}this.setTexture2D=f,this.setTextureCube=function(t,s){var u=r.get(t);if(6===t.image.length)if(t.version>0&&u.__version!==t.version){u.__image__webglTextureCube||(t.addEventListener("dispose",d),u.__image__webglTextureCube=e.createTexture(),a.textures++),i.activeTexture(e.TEXTURE0+s),i.bindTexture(e.TEXTURE_CUBE_MAP,u.__image__webglTextureCube),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY);for(var p=t&&t.isCompressedTexture,f=t.image[0]&&t.image[0].isDataTexture,g=[],v=0;v<6;v++)g[v]=p||f?f?t.image[v].image:t.image[v]:c(t.image[v],n.maxCubemapSize);var y=l(g[0]),E=o.convert(t.format),x=o.convert(t.type);for(m(e.TEXTURE_CUBE_MAP,t,y),v=0;v<6;v++)if(p)for(var b,w=g[v].mipmaps,T=0,M=w.length;T<M;T++)b=w[T],t.format!==Ie&&t.format!==Be?i.getCompressedTextureFormats().indexOf(E)>-1?i.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+v,T,E,b.width,b.height,0,b.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+v,T,E,b.width,b.height,0,E,x,b.data);else f?i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+v,0,E,g[v].width,g[v].height,0,E,x,g[v].data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+v,0,E,E,x,g[v]);h(t,y)&&e.generateMipmap(e.TEXTURE_CUBE_MAP),u.__version=t.version,t.onUpdate&&t.onUpdate(t)}else i.activeTexture(e.TEXTURE0+s),i.bindTexture(e.TEXTURE_CUBE_MAP,u.__image__webglTextureCube)},this.setTextureCubeDynamic=function(t,n){i.activeTexture(e.TEXTURE0+n),i.bindTexture(e.TEXTURE_CUBE_MAP,r.get(t).__webglTexture)},this.setupRenderTarget=function(t){var n=r.get(t),o=r.get(t.texture);t.addEventListener("dispose",p),o.__webglTexture=e.createTexture(),a.textures++;var s=!0===t.isWebGLRenderTargetCube,c=l(t);if(s){n.__webglFramebuffer=[];for(var u=0;u<6;u++)n.__webglFramebuffer[u]=e.createFramebuffer()}else n.__webglFramebuffer=e.createFramebuffer();if(s){for(i.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture),m(e.TEXTURE_CUBE_MAP,t.texture,c),u=0;u<6;u++)g(n.__webglFramebuffer[u],t,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+u);h(t.texture,c)&&e.generateMipmap(e.TEXTURE_CUBE_MAP),i.bindTexture(e.TEXTURE_CUBE_MAP,null)}else i.bindTexture(e.TEXTURE_2D,o.__webglTexture),m(e.TEXTURE_2D,t.texture,c),g(n.__webglFramebuffer,t,e.COLOR_ATTACHMENT0,e.TEXTURE_2D),h(t.texture,c)&&e.generateMipmap(e.TEXTURE_2D),i.bindTexture(e.TEXTURE_2D,null);t.depthBuffer&&y(t)},this.updateRenderTargetMipmap=function(t){var n=t.texture;if(h(n,l(t))){var o=t.isWebGLRenderTargetCube?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,a=r.get(n).__webglTexture;i.bindTexture(o,a),e.generateMipmap(o),i.bindTexture(o,null)}}}function rn(e){Ki.call(this),this.cameras=e||[]}function nn(e,t){return{convert:function(i){var r;if(i===de)return e.REPEAT;if(i===pe)return e.CLAMP_TO_EDGE;if(i===fe)return e.MIRRORED_REPEAT;if(i===me)return e.NEAREST;if(i===ge)return e.NEAREST_MIPMAP_NEAREST;if(i===ve)return e.NEAREST_MIPMAP_LINEAR;if(i===ye)return e.LINEAR;if(i===Ee)return e.LINEAR_MIPMAP_NEAREST;if(i===xe)return e.LINEAR_MIPMAP_LINEAR;if(i===be)return e.UNSIGNED_BYTE;if(i===De)return e.UNSIGNED_SHORT_4_4_4_4;if(i===Ce)return e.UNSIGNED_SHORT_5_5_5_1;if(i===Le)return e.UNSIGNED_SHORT_5_6_5;if(i===we)return e.BYTE;if(i===Te)return e.SHORT;if(i===Me)return e.UNSIGNED_SHORT;if(i===Se)return e.INT;if(i===Re)return e.UNSIGNED_INT;if(i===Ae)return e.FLOAT;if(i===_e&&null!==(r=t.get("OES_texture_half_float")))return r.HALF_FLOAT_OES;if(i===He)return e.ALPHA;if(i===Be)return e.RGB;if(i===Ie)return e.RGBA;if(i===Oe)return e.LUMINANCE;if(i===Ue)return e.LUMINANCE_ALPHA;if(i===Ve)return e.DEPTH_COMPONENT;if(i===Fe)return e.DEPTH_STENCIL;if(i===A)return e.FUNC_ADD;if(i===_)return e.FUNC_SUBTRACT;if(i===D)return e.FUNC_REVERSE_SUBTRACT;if(i===P)return e.ZERO;if(i===H)return e.ONE;if(i===B)return e.SRC_COLOR;if(i===I)return e.ONE_MINUS_SRC_COLOR;if(i===O)return e.SRC_ALPHA;if(i===U)return e.ONE_MINUS_SRC_ALPHA;if(i===N)return e.DST_ALPHA;if(i===V)return e.ONE_MINUS_DST_ALPHA;if(i===F)return e.DST_COLOR;if(i===z)return e.ONE_MINUS_DST_COLOR;if(i===j)return e.SRC_ALPHA_SATURATE;if((i===ze||i===je||i===ke||i===Ge)&&null!==(r=t.get("WEBGL_compressed_texture_s3tc"))){if(i===ze)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===je)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===ke)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===Ge)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((i===We||i===Xe||i===Ye||i===qe)&&null!==(r=t.get("WEBGL_compressed_texture_pvrtc"))){if(i===We)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===Xe)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===Ye)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===qe)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(i===Ze&&null!==(r=t.get("WEBGL_compressed_texture_etc1")))return r.COMPRESSED_RGB_ETC1_WEBGL;if((i===C||i===L)&&null!==(r=t.get("EXT_blend_minmax"))){if(i===C)return r.MIN_EXT;if(i===L)return r.MAX_EXT}return i===Pe&&null!==(r=t.get("WEBGL_depth_texture"))?r.UNSIGNED_INT_24_8_WEBGL:0}}}function on(e){console.log("THREE.WebGLRenderer",c);var t=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),i=void 0!==e.context?e.context:null,r=void 0!==e.alpha&&e.alpha,n=void 0===e.depth||e.depth,o=void 0===e.stencil||e.stencil,a=void 0!==e.antialias&&e.antialias,s=void 0===e.premultipliedAlpha||e.premultipliedAlpha,p=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,f=[],m=[],E=null,x=[],A=[];this.domElement=t,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=te,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var _,D,C,L,P,H,B,I,O,U,N,V,F,z,j,Q,K,$,ee,ie=this,re=!1,ne=null,oe=null,ae=-1,se="",ce=null,le=null,he=new xt,ue=new xt,de=null,pe=0,fe=t.width,me=t.height,ge=1,ve=new xt(0,0,fe,me),ye=new xt(0,0,fe,me),Ee=!1,xe=new Vi,we=new function(){var e=this,t=null,i=0,r=!1,n=!1,o=new Ni,a=new Ui,s={value:null,needsUpdate:!1};function c(){s.value!==t&&(s.value=t,s.needsUpdate=i>0),e.numPlanes=i,e.numIntersection=0}function l(t,i,r,n){var c=null!==t?t.length:0,l=null;if(0!==c){if(l=s.value,!0!==n||null===l){var h=r+4*c,u=i.matrixWorldInverse;a.getNormalMatrix(u),(null===l||l.length<h)&&(l=new Float32Array(h));for(var d=0,p=r;d!==c;++d,p+=4)o.copy(t[d]).applyMatrix4(u,a),o.normal.toArray(l,p),l[p+3]=o.constant}s.value=l,s.needsUpdate=!0}return e.numPlanes=c,l}this.uniform=s,this.numPlanes=0,this.numIntersection=0,this.init=function(e,n,o){var a=0!==e.length||n||0!==i||r;return r=n,t=l(e,o,0),i=e.length,a},this.beginShadows=function(){n=!0,l(null)},this.endShadows=function(){n=!1,c()},this.setState=function(e,o,a,h,u,d){if(!r||null===e||0===e.length||n&&!a)n?l(null):c();else{var p=n?0:i,f=4*p,m=u.clippingState||null;s.value=m,m=l(e,h,f,d);for(var g=0;g!==f;++g)m[g]=t[g];u.clippingState=m,this.numIntersection=o?this.numPlanes:0,this.numPlanes+=p}}},Te=!1,Me=!1,Se=new St,Re=new Mt,De={geometries:0,textures:0},Ce={frame:0,calls:0,vertices:0,faces:0,points:0};function Le(){return null===ne?ge:1}this.info={render:Ce,memory:De,programs:null};try{var Pe={alpha:r,depth:n,stencil:o,antialias:a,premultipliedAlpha:s,preserveDrawingBuffer:p};if(null===(_=i||t.getContext("webgl",Pe)||t.getContext("experimental-webgl",Pe)))throw null!==t.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===_.getShaderPrecisionFormat&&(_.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),t.addEventListener("webglcontextlost",Ue,!1),t.addEventListener("webglcontextrestored",Ne,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}function He(){(D=new function(e){var t={};return{get:function(i){if(void 0!==t[i])return t[i];var r;switch(i){case"WEBGL_depth_texture":r=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":r=e.getExtension("WEBGL_compressed_texture_etc1");break;default:r=e.getExtension(i)}return null===r&&console.warn("THREE.WebGLRenderer: "+i+" extension not supported."),t[i]=r,r}}}(_)).get("WEBGL_depth_texture"),D.get("OES_texture_float"),D.get("OES_texture_float_linear"),D.get("OES_texture_half_float"),D.get("OES_texture_half_float_linear"),D.get("OES_standard_derivatives"),D.get("ANGLE_instanced_arrays"),D.get("OES_element_index_uint")&&(Mr.MaxIndex=4294967296),ee=new nn(_,D),C=new function(e,t,i){var r;function n(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}var o=void 0!==i.precision?i.precision:"highp",a=n(o);a!==o&&(console.warn("THREE.WebGLRenderer:",o,"not supported, using",a,"instead."),o=a);var s=!0===i.logarithmicDepthBuffer&&!!t.get("EXT_frag_depth"),c=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),l=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),h=e.getParameter(e.MAX_TEXTURE_SIZE),u=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),d=e.getParameter(e.MAX_VERTEX_ATTRIBS),p=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),f=e.getParameter(e.MAX_VARYING_VECTORS),m=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),g=l>0,v=!!t.get("OES_texture_float");return{getMaxAnisotropy:function(){if(void 0!==r)return r;var i=t.get("EXT_texture_filter_anisotropic");return r=null!==i?e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},getMaxPrecision:n,precision:o,logarithmicDepthBuffer:s,maxTextures:c,maxVertexTextures:l,maxTextureSize:h,maxCubemapSize:u,maxAttributes:d,maxVertexUniforms:p,maxVaryings:f,maxFragmentUniforms:m,vertexTextures:g,floatFragmentTextures:v,floatVertexTextures:g&&v}}(_,D,e),(L=new function(e,t,i){var r=new function(){var t=!1,i=new xt,r=null,n=new xt(0,0,0,0);return{setMask:function(i){r===i||t||(e.colorMask(i,i,i,i),r=i)},setLocked:function(e){t=e},setClear:function(t,r,o,a,s){!0===s&&(t*=a,r*=a,o*=a),i.set(t,r,o,a),!1===n.equals(i)&&(e.clearColor(t,r,o,a),n.copy(i))},reset:function(){t=!1,r=null,n.set(-1,0,0,0)}}},n=new function(){var t=!1,i=null,r=null,n=null;return{setTest:function(t){t?ee(e.DEPTH_TEST):te(e.DEPTH_TEST)},setMask:function(r){i===r||t||(e.depthMask(r),i=r)},setFunc:function(t){if(r!==t){if(t)switch(t){case k:e.depthFunc(e.NEVER);break;case G:e.depthFunc(e.ALWAYS);break;case W:e.depthFunc(e.LESS);break;case X:e.depthFunc(e.LEQUAL);break;case Y:e.depthFunc(e.EQUAL);break;case q:e.depthFunc(e.GEQUAL);break;case Z:e.depthFunc(e.GREATER);break;case J:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);r=t}},setLocked:function(e){t=e},setClear:function(t){n!==t&&(e.clearDepth(t),n=t)},reset:function(){t=!1,i=null,r=null,n=null}}},o=new function(){var t=!1,i=null,r=null,n=null,o=null,a=null,s=null,c=null,l=null;return{setTest:function(t){t?ee(e.STENCIL_TEST):te(e.STENCIL_TEST)},setMask:function(r){i===r||t||(e.stencilMask(r),i=r)},setFunc:function(t,i,a){r===t&&n===i&&o===a||(e.stencilFunc(t,i,a),r=t,n=i,o=a)},setOp:function(t,i,r){a===t&&s===i&&c===r||(e.stencilOp(t,i,r),a=t,s=i,c=r)},setLocked:function(e){t=e},setClear:function(t){l!==t&&(e.clearStencil(t),l=t)},reset:function(){t=!1,i=null,r=null,n=null,o=null,a=null,s=null,c=null,l=null}}},a=e.getParameter(e.MAX_VERTEX_ATTRIBS),s=new Uint8Array(a),c=new Uint8Array(a),d=new Uint8Array(a),p={},f=null,m=null,y=null,E=null,x=null,A=null,_=null,D=null,C=null,L=!1,P=null,H=null,B=null,I=null,O=null,U=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),N=parseFloat(/^WebGL\ ([0-9])/.exec(e.getParameter(e.VERSION))[1]),V=parseFloat(N)>=1,F=null,z={},j=new xt,Q=new xt;function K(t,i,r){var n=new Uint8Array(4),o=e.createTexture();e.bindTexture(t,o),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(var a=0;a<r;a++)e.texImage2D(i+a,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,n);return o}var $={};function ee(t){!0!==p[t]&&(e.enable(t),p[t]=!0)}function te(t){!1!==p[t]&&(e.disable(t),p[t]=!1)}function ie(t,r,n,o,a,s,c,l){if(t!==b?ee(e.BLEND):te(e.BLEND),t!==R){if(t!==y||l!==L)switch(t){case T:l?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE,e.ONE,e.ONE)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE));break;case M:l?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR));break;case S:l?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.SRC_COLOR));break;default:l?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA))}E=null,x=null,A=null,_=null,D=null,C=null}else a=a||r,s=s||n,c=c||o,r===E&&a===_||(e.blendEquationSeparate(i.convert(r),i.convert(a)),E=r,_=a),n===x&&o===A&&s===D&&c===C||(e.blendFuncSeparate(i.convert(n),i.convert(o),i.convert(s),i.convert(c)),x=n,A=o,D=s,C=c);y=t,L=l}function re(t){P!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),P=t)}function ne(t){t!==l?(ee(e.CULL_FACE),t!==H&&(t===h?e.cullFace(e.BACK):t===u?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):te(e.CULL_FACE),H=t}function oe(t,i,r){t?(ee(e.POLYGON_OFFSET_FILL),I===i&&O===r||(e.polygonOffset(i,r),I=i,O=r)):te(e.POLYGON_OFFSET_FILL)}function ae(t){void 0===t&&(t=e.TEXTURE0+U-1),F!==t&&(e.activeTexture(t),F=t)}return $[e.TEXTURE_2D]=K(e.TEXTURE_2D,e.TEXTURE_2D,1),$[e.TEXTURE_CUBE_MAP]=K(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),r.setClear(0,0,0,1),n.setClear(1),o.setClear(0),ee(e.DEPTH_TEST),n.setFunc(X),re(!1),ne(h),ee(e.CULL_FACE),ee(e.BLEND),ie(w),{buffers:{color:r,depth:n,stencil:o},initAttributes:function(){for(var e=0,t=s.length;e<t;e++)s[e]=0},enableAttribute:function(i){s[i]=1,0===c[i]&&(e.enableVertexAttribArray(i),c[i]=1),0!==d[i]&&(t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(i,0),d[i]=0)},enableAttributeAndDivisor:function(i,r){s[i]=1,0===c[i]&&(e.enableVertexAttribArray(i),c[i]=1),d[i]!==r&&(t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(i,r),d[i]=r)},disableUnusedAttributes:function(){for(var t=0,i=c.length;t!==i;++t)c[t]!==s[t]&&(e.disableVertexAttribArray(t),c[t]=0)},enable:ee,disable:te,getCompressedTextureFormats:function(){if(null===f&&(f=[],t.get("WEBGL_compressed_texture_pvrtc")||t.get("WEBGL_compressed_texture_s3tc")||t.get("WEBGL_compressed_texture_etc1")))for(var i=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS),r=0;r<i.length;r++)f.push(i[r]);return f},useProgram:function(t){return m!==t&&(e.useProgram(t),m=t,!0)},setBlending:ie,setMaterial:function(t){t.side===v?te(e.CULL_FACE):ee(e.CULL_FACE),re(t.side===g),!0===t.transparent?ie(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha):ie(b),n.setFunc(t.depthFunc),n.setTest(t.depthTest),n.setMask(t.depthWrite),r.setMask(t.colorWrite),oe(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)},setFlipSided:re,setCullFace:ne,setLineWidth:function(t){t!==B&&(V&&e.lineWidth(t),B=t)},setPolygonOffset:oe,setScissorTest:function(t){t?ee(e.SCISSOR_TEST):te(e.SCISSOR_TEST)},activeTexture:ae,bindTexture:function(t,i){null===F&&ae();var r=z[F];void 0===r&&(r={type:void 0,texture:void 0},z[F]=r),r.type===t&&r.texture===i||(e.bindTexture(t,i||$[t]),r.type=t,r.texture=i)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===j.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),j.copy(t))},viewport:function(t){!1===Q.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),Q.copy(t))},reset:function(){for(var t=0;t<c.length;t++)1===c[t]&&(e.disableVertexAttribArray(t),c[t]=0);p={},f=null,F=null,z={},m=null,y=null,P=null,H=null,r.reset(),n.reset(),o.reset()}}}(_,D,ee)).scissor(ue.copy(ye).multiplyScalar(ge)),L.viewport(he.copy(ve).multiplyScalar(ge)),P=new function(){var e={};return{get:function(t){var i=t.uuid,r=e[i];return void 0===r&&(r={},e[i]=r),r},remove:function(t){delete e[t.uuid]},clear:function(){e={}}}},H=new tn(_,D,L,P,C,ee,De),B=new zi(_),I=new function(e,t,i){var r={},n={};function o(e){var a=e.target,s=r[a.id];for(var c in null!==s.index&&t.remove(s.index),s.attributes)t.remove(s.attributes[c]);a.removeEventListener("dispose",o),delete r[a.id];var l=n[a.id];l&&(t.remove(l),delete n[a.id]),(l=n[s.id])&&(t.remove(l),delete n[s.id]),i.geometries--}return{get:function(e,t){var n=r[t.id];return n||(t.addEventListener("dispose",o),t.isBufferGeometry?n=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new Mr).setFromObject(e)),n=t._bufferGeometry),r[t.id]=n,i.geometries++,n)},update:function(i){var r=i.index,n=i.attributes;for(var o in null!==r&&t.update(r,e.ELEMENT_ARRAY_BUFFER),n)t.update(n[o],e.ARRAY_BUFFER);var a=i.morphAttributes;for(var o in a)for(var s=a[o],c=0,l=s.length;c<l;c++)t.update(s[c],e.ARRAY_BUFFER)},getWireframeAttribute:function(i){var r=n[i.id];if(r)return r;var o,a=[],s=i.index,c=i.attributes;if(null!==s)for(var l=0,h=(o=s.array).length;l<h;l+=3){var u=o[l+0],d=o[l+1],p=o[l+2];a.push(u,d,d,p,p,u)}else for(l=0,h=(o=c.position.array).length/3-1;l<h;l+=3)u=l+0,d=l+1,p=l+2,a.push(u,d,d,p,p,u);return r=new(Tr(a)>65535?Er:vr)(a,1),t.update(r,e.ELEMENT_ARRAY_BUFFER),n[i.id]=r,r}}}(_,B,De),O=new function(e,t){var i={};return{update:function(r){var n=t.frame,o=r.geometry,a=e.get(r,o);return i[a.id]!==n&&(o.isGeometry&&a.updateFromObject(r),e.update(a),i[a.id]=n),a},clear:function(){i={}}}}(I,Ce),z=new function(e){var t={},i=new Float32Array(8);return{update:function(r,n,o,a){var s=r.morphTargetInfluences,c=s.length,l=t[n.id];if(void 0===l){l=[];for(var h=0;h<c;h++)l[h]=[h,0];t[n.id]=l}var u=o.morphTargets&&n.morphAttributes.position,d=o.morphNormals&&n.morphAttributes.normal;for(h=0;h<c;h++)0!==(p=l[h])[1]&&(u&&n.removeAttribute("morphTarget"+h),d&&n.removeAttribute("morphNormal"+h));for(h=0;h<c;h++)(p=l[h])[0]=h,p[1]=s[h];for(l.sort(Ur),h=0;h<8;h++){var p;if(p=l[h]){var f=p[0],m=p[1];if(m){u&&n.addAttribute("morphTarget"+h,u[f]),d&&n.addAttribute("morphNormal"+h,d[f]),i[h]=m;continue}}i[h]=0}a.getUniforms().setValue(e,"morphTargetInfluences",i)}}}(_),N=new en(ie,D,C),U=new Nr,V=new Or,F=new function(e,t,i,r){var n,o,a,s=new fi(0),c=0;function l(e,i){t.buffers.color.setClear(e.r,e.g,e.b,i,r)}return{getClearColor:function(){return s},setClearColor:function(e,t){s.set(e),l(s,c=void 0!==t?t:1)},getClearAlpha:function(){return c},setClearAlpha:function(e){l(s,c=e)},render:function(t,r,h,u){var d=r.background;null===d?l(s,c):d&&d.isColor&&(l(d,1),u=!0),(e.autoClear||u)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),d&&d.isCubeTexture?(void 0===a&&((a=new Hr(new Rr(1,1,1),new Pi({uniforms:yi.cube.uniforms,vertexShader:yi.cube.vertexShader,fragmentShader:yi.cube.fragmentShader,side:g,depthTest:!0,depthWrite:!1,polygonOffset:!0,fog:!1}))).geometry.removeAttribute("normal"),a.geometry.removeAttribute("uv"),a.onBeforeRender=function(e,t,i){var r=i.far;this.matrixWorld.makeScale(r,r,r),this.matrixWorld.copyPosition(i.matrixWorld),this.material.polygonOffsetUnits=10*r},i.update(a.geometry)),a.material.uniforms.tCube.value=d,t.push(a,a.geometry,a.material,0,null)):d&&d.isTexture&&(void 0===n&&(n=new Qi(-1,1,1,-1,0,1),o=new Hr(new _r(2,2),new Dr({depthTest:!1,depthWrite:!1,fog:!1})),i.update(o.geometry)),o.material.map=d,e.renderBufferDirect(n,null,o.geometry,o.material,o,null))}}}(ie,L,I,s),j=new function(e,t,i){var r;this.setMode=function(e){r=e},this.render=function(t,n){e.drawArrays(r,t,n),i.calls++,i.vertices+=n,r===e.TRIANGLES?i.faces+=n/3:r===e.POINTS&&(i.points+=n)},this.renderInstances=function(n,o,a){var s=t.get("ANGLE_instanced_arrays");if(null!==s){var c=n.attributes.position;c.isInterleavedBufferAttribute?(a=c.data.count,s.drawArraysInstancedANGLE(r,0,a,n.maxInstancedCount)):s.drawArraysInstancedANGLE(r,o,a,n.maxInstancedCount),i.calls++,i.vertices+=a*n.maxInstancedCount,r===e.TRIANGLES?i.faces+=n.maxInstancedCount*a/3:r===e.POINTS&&(i.points+=n.maxInstancedCount*a)}else console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.")}}(_,D,Ce),Q=new function(e,t,i){var r,n,o;this.setMode=function(e){r=e},this.setIndex=function(e){n=e.type,o=e.bytesPerElement},this.render=function(t,a){e.drawElements(r,a,n,t*o),i.calls++,i.vertices+=a,r===e.TRIANGLES?i.faces+=a/3:r===e.POINTS&&(i.points+=a)},this.renderInstances=function(a,s,c){var l=t.get("ANGLE_instanced_arrays");null!==l?(l.drawElementsInstancedANGLE(r,c,n,s*o,a.maxInstancedCount),i.calls++,i.vertices+=c*a.maxInstancedCount,r===e.TRIANGLES?i.faces+=a.maxInstancedCount*c/3:r===e.POINTS&&(i.points+=a.maxInstancedCount*c)):console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.")}}(_,D,Ce),K=new xi(ie,_,L,H,C),$=new wi(ie,_,L,H,C),ie.info.programs=N.programs,ie.context=_,ie.capabilities=C,ie.extensions=D,ie.properties=P,ie.renderLists=V,ie.state=L}He();var Be=new function(e){var t=this,i=null,r=null;"VRFrameData"in window&&(r=new window.VRFrameData);var n=new St,o=new St,a=new St,s=new Ki;s.bounds=new xt(0,0,.5,1),s.layers.enable(1);var c=new Ki;c.bounds=new xt(.5,0,.5,1),c.layers.enable(2);var l,h,u=new rn([s,c]);function d(){if(null!==i&&i.isPresenting){var r=i.getEyeParameters("left"),n=r.renderWidth,o=r.renderHeight;h=e.getPixelRatio(),l=e.getSize(),e.setDrawingBufferSize(2*n,o,1)}else t.enabled&&e.setDrawingBufferSize(l.width,l.height,h)}u.layers.enable(1),u.layers.enable(2),window.addEventListener("vrdisplaypresentchange",d,!1),this.enabled=!1,this.standing=!1,this.getDevice=function(){return i},this.setDevice=function(e){void 0!==e&&(i=e)},this.getCamera=function(e){if(null===i)return e;i.depthNear=e.near,i.depthFar=e.far,i.getFrameData(r);var t=r.pose;null!==t.position?e.position.fromArray(t.position):e.position.set(0,0,0),null!==t.orientation&&e.quaternion.fromArray(t.orientation),e.updateMatrixWorld();var l=i.stageParameters;if(this.standing&&l&&(o.fromArray(l.sittingToStandingTransform),a.getInverse(o),e.matrixWorld.multiply(o),e.matrixWorldInverse.multiply(a)),!1===i.isPresenting)return e;s.near=e.near,c.near=e.near,s.far=e.far,c.far=e.far,u.matrixWorld.copy(e.matrixWorld),u.matrixWorldInverse.copy(e.matrixWorldInverse),s.matrixWorldInverse.fromArray(r.leftViewMatrix),c.matrixWorldInverse.fromArray(r.rightViewMatrix),this.standing&&l&&(s.matrixWorldInverse.multiply(a),c.matrixWorldInverse.multiply(a));var h=e.parent;null!==h&&(n.getInverse(h.matrixWorld),s.matrixWorldInverse.multiply(n),c.matrixWorldInverse.multiply(n)),s.matrixWorld.getInverse(s.matrixWorldInverse),c.matrixWorld.getInverse(c.matrixWorldInverse),s.projectionMatrix.fromArray(r.leftProjectionMatrix),c.projectionMatrix.fromArray(r.rightProjectionMatrix),u.projectionMatrix.copy(s.projectionMatrix);var d=i.getLayers();if(d.length){var p=d[0];null!==p.leftBounds&&4===p.leftBounds.length&&s.bounds.fromArray(p.leftBounds),null!==p.rightBounds&&4===p.rightBounds.length&&c.bounds.fromArray(p.rightBounds)}return u},this.getStandingMatrix=function(){return o},this.submitFrame=function(){i&&i.isPresenting&&i.submitFrame()},this.dispose=function(){window.removeEventListener("vrdisplaypresentchange",d)}}(ie);this.vr=Be;var Oe=new Fi(ie,O,C.maxTextureSize);function Ue(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),re=!0}function Ne(e){console.log("THREE.WebGLRenderer: Context Restored."),re=!1,He()}function Ve(e){var t=e.target;t.removeEventListener("dispose",Ve),function(e){Fe(e),P.remove(e)}(t)}function Fe(e){var t=P.get(e).program;e.program=void 0,void 0!==t&&N.releaseProgram(t)}this.shadowMap=Oe,this.getContext=function(){return _},this.getContextAttributes=function(){return _.getContextAttributes()},this.forceContextLoss=function(){var e=D.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){var e=D.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return ge},this.setPixelRatio=function(e){void 0!==e&&(ge=e,this.setSize(fe,me,!1))},this.getSize=function(){return{width:fe,height:me}},this.setSize=function(e,i,r){var n=Be.getDevice();n&&n.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(fe=e,me=i,t.width=e*ge,t.height=i*ge,!1!==r&&(t.style.width=e+"px",t.style.height=i+"px"),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(){return{width:fe*ge,height:me*ge}},this.setDrawingBufferSize=function(e,i,r){fe=e,me=i,ge=r,t.width=e*r,t.height=i*r,this.setViewport(0,0,e,i)},this.setViewport=function(e,t,i,r){ve.set(e,me-t-r,i,r),L.viewport(he.copy(ve).multiplyScalar(ge))},this.setScissor=function(e,t,i,r){ye.set(e,me-t-r,i,r),L.scissor(ue.copy(ye).multiplyScalar(ge))},this.setScissorTest=function(e){L.setScissorTest(Ee=e)},this.getClearColor=F.getClearColor,this.setClearColor=F.setClearColor,this.getClearAlpha=F.getClearAlpha,this.setClearAlpha=F.setClearAlpha,this.clear=function(e,t,i){var r=0;(void 0===e||e)&&(r|=_.COLOR_BUFFER_BIT),(void 0===t||t)&&(r|=_.DEPTH_BUFFER_BIT),(void 0===i||i)&&(r|=_.STENCIL_BUFFER_BIT),_.clear(r)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,i,r){this.setRenderTarget(e),this.clear(t,i,r)},this.dispose=function(){t.removeEventListener("webglcontextlost",Ue,!1),t.removeEventListener("webglcontextrestored",Ne,!1),V.dispose(),Be.dispose()},this.renderBufferImmediate=function(e,t,i){L.initAttributes();var r=P.get(e);e.hasPositions&&!r.position&&(r.position=_.createBuffer()),e.hasNormals&&!r.normal&&(r.normal=_.createBuffer()),e.hasUvs&&!r.uv&&(r.uv=_.createBuffer()),e.hasColors&&!r.color&&(r.color=_.createBuffer());var n=t.getAttributes();if(e.hasPositions&&(_.bindBuffer(_.ARRAY_BUFFER,r.position),_.bufferData(_.ARRAY_BUFFER,e.positionArray,_.DYNAMIC_DRAW),L.enableAttribute(n.position),_.vertexAttribPointer(n.position,3,_.FLOAT,!1,0,0)),e.hasNormals){if(_.bindBuffer(_.ARRAY_BUFFER,r.normal),!i.isMeshPhongMaterial&&!i.isMeshStandardMaterial&&!i.isMeshNormalMaterial&&!0===i.flatShading)for(var o=0,a=3*e.count;o<a;o+=9){var s=e.normalArray,c=(s[o+0]+s[o+3]+s[o+6])/3,l=(s[o+1]+s[o+4]+s[o+7])/3,h=(s[o+2]+s[o+5]+s[o+8])/3;s[o+0]=c,s[o+1]=l,s[o+2]=h,s[o+3]=c,s[o+4]=l,s[o+5]=h,s[o+6]=c,s[o+7]=l,s[o+8]=h}_.bufferData(_.ARRAY_BUFFER,e.normalArray,_.DYNAMIC_DRAW),L.enableAttribute(n.normal),_.vertexAttribPointer(n.normal,3,_.FLOAT,!1,0,0)}e.hasUvs&&i.map&&(_.bindBuffer(_.ARRAY_BUFFER,r.uv),_.bufferData(_.ARRAY_BUFFER,e.uvArray,_.DYNAMIC_DRAW),L.enableAttribute(n.uv),_.vertexAttribPointer(n.uv,2,_.FLOAT,!1,0,0)),e.hasColors&&i.vertexColors!==y&&(_.bindBuffer(_.ARRAY_BUFFER,r.color),_.bufferData(_.ARRAY_BUFFER,e.colorArray,_.DYNAMIC_DRAW),L.enableAttribute(n.color),_.vertexAttribPointer(n.color,3,_.FLOAT,!1,0,0)),L.disableUnusedAttributes(),_.drawArrays(_.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,i,r,n,o){L.setMaterial(r);var a=qe(e,t,r,n),s=i.id+"_"+a.id+"_"+(!0===r.wireframe),c=!1;s!==se&&(se=s,c=!0),n.morphTargetInfluences&&(z.update(n,i,r,a),c=!0);var l,h=i.index,u=i.attributes.position,d=1;!0===r.wireframe&&(h=I.getWireframeAttribute(i),d=2);var p=j;null!==h&&(l=B.get(h),(p=Q).setIndex(l)),c&&(!function(e,t,i,r){if(i&&i.isInstancedBufferGeometry&&null===D.get("ANGLE_instanced_arrays"))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===r&&(r=0);L.initAttributes();var n=i.attributes,o=t.getAttributes(),a=e.defaultAttributeValues;for(var s in o){var c=o[s];if(c>=0){var l=n[s];if(void 0!==l){var h=l.normalized,u=l.itemSize,d=B.get(l);if(void 0===d)continue;var p=d.buffer,f=d.type,m=d.bytesPerElement;if(l.isInterleavedBufferAttribute){var g=l.data,v=g.stride,y=l.offset;g&&g.isInstancedInterleavedBuffer?(L.enableAttributeAndDivisor(c,g.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=g.meshPerAttribute*g.count)):L.enableAttribute(c),_.bindBuffer(_.ARRAY_BUFFER,p),_.vertexAttribPointer(c,u,f,h,v*m,(r*v+y)*m)}else l.isInstancedBufferAttribute?(L.enableAttributeAndDivisor(c,l.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=l.meshPerAttribute*l.count)):L.enableAttribute(c),_.bindBuffer(_.ARRAY_BUFFER,p),_.vertexAttribPointer(c,u,f,h,0,r*u*m)}else if(void 0!==a){var E=a[s];if(void 0!==E)switch(E.length){case 2:_.vertexAttrib2fv(c,E);break;case 3:_.vertexAttrib3fv(c,E);break;case 4:_.vertexAttrib4fv(c,E);break;default:_.vertexAttrib1fv(c,E)}}}}L.disableUnusedAttributes()}(r,a,i),null!==h&&_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,l.buffer));var f=0;null!==h?f=h.count:void 0!==u&&(f=u.count);var m=i.drawRange.start*d,g=i.drawRange.count*d,v=null!==o?o.start*d:0,y=null!==o?o.count*d:1/0,E=Math.max(m,v),x=Math.min(f,m+g,v+y)-1,b=Math.max(0,x-E+1);if(0!==b){if(n.isMesh)if(!0===r.wireframe)L.setLineWidth(r.wireframeLinewidth*Le()),p.setMode(_.LINES);else switch(n.drawMode){case Ke:p.setMode(_.TRIANGLES);break;case $e:p.setMode(_.TRIANGLE_STRIP);break;case et:p.setMode(_.TRIANGLE_FAN)}else if(n.isLine){var w=r.linewidth;void 0===w&&(w=1),L.setLineWidth(w*Le()),n.isLineSegments?p.setMode(_.LINES):n.isLineLoop?p.setMode(_.LINE_LOOP):p.setMode(_.LINE_STRIP)}else n.isPoints&&p.setMode(_.POINTS);i&&i.isInstancedBufferGeometry?i.maxInstancedCount>0&&p.renderInstances(i,E,b):p.render(E,b)}},this.compile=function(e,t){f.length=0,m.length=0,e.traverse(function(e){e.isLight&&(f.push(e),e.castShadow&&m.push(e))}),U.setup(f,m,t),e.traverse(function(t){if(t.material)if(Array.isArray(t.material))for(var i=0;i<t.material.length;i++)Ye(t.material[i],e.fog,t);else Ye(t.material,e.fog,t)})};var ze,je=!1,ke=null;function Ge(e){null!==ke&&ke(e),(Be.getDevice()||window).requestAnimationFrame(Ge)}function We(e,t,i,r){for(var n=0,o=e.length;n<o;n++){var a=e[n],s=a.object,c=a.geometry,l=void 0===r?a.material:r,h=a.group;if(i.isArrayCamera){le=i;for(var u=i.cameras,d=0,p=u.length;d<p;d++){var f=u[d];if(s.layers.test(f.layers)){var m=f.bounds,g=m.x*fe,v=m.y*me,y=m.z*fe,E=m.w*me;L.viewport(he.set(g,v,y,E).multiplyScalar(ge)),Xe(s,t,f,c,l,h)}}}else le=null,Xe(s,t,i,c,l,h)}}function Xe(e,t,i,r,n,o){if(e.onBeforeRender(ie,t,i,r,n,o),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){L.setMaterial(n);var a=qe(i,t.fog,n,e);se="",function(e,t,i){e.render(function(e){ie.renderBufferImmediate(e,t,i)})}(e,a,n)}else ie.renderBufferDirect(i,t.fog,r,n,e,o);e.onAfterRender(ie,t,i,r,n,o)}function Ye(e,t,i){var r=P.get(e),n=N.getParameters(e,U.state,m,t,we.numPlanes,we.numIntersection,i),o=N.getProgramCode(e,n),a=r.program,s=!0;if(void 0===a)e.addEventListener("dispose",Ve);else if(a.code!==o)Fe(e);else{if(void 0!==n.shaderID)return;s=!1}if(s){if(n.shaderID){var c=yi[n.shaderID];r.shader={name:e.type,uniforms:gi.clone(c.uniforms),vertexShader:c.vertexShader,fragmentShader:c.fragmentShader}}else r.shader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.onBeforeCompile(r.shader),a=N.acquireProgram(e,r.shader,n,o),r.program=a,e.program=a}var l=a.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var h=0;h<ie.maxMorphTargets;h++)l["morphTarget"+h]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(h=0;h<ie.maxMorphNormals;h++)l["morphNormal"+h]>=0&&e.numSupportedMorphNormals++}var u=r.shader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(r.numClippingPlanes=we.numPlanes,r.numIntersection=we.numIntersection,u.clippingPlanes=we.uniform),r.fog=t,r.lightsHash=U.state.hash,e.lights&&(u.ambientLightColor.value=U.state.ambient,u.directionalLights.value=U.state.directional,u.spotLights.value=U.state.spot,u.rectAreaLights.value=U.state.rectArea,u.pointLights.value=U.state.point,u.hemisphereLights.value=U.state.hemi,u.directionalShadowMap.value=U.state.directionalShadowMap,u.directionalShadowMatrix.value=U.state.directionalShadowMatrix,u.spotShadowMap.value=U.state.spotShadowMap,u.spotShadowMatrix.value=U.state.spotShadowMatrix,u.pointShadowMap.value=U.state.pointShadowMap,u.pointShadowMatrix.value=U.state.pointShadowMatrix);var d=r.program.getUniforms(),p=di.seqWithValue(d.seq,u);r.uniformsList=p}function qe(e,t,i,r){pe=0;var n=P.get(i);if(Te&&(Me||e!==ce)){var o=e===ce&&i.id===ae;we.setState(i.clippingPlanes,i.clipIntersection,i.clipShadows,e,n,o)}!1===i.needsUpdate&&(void 0===n.program?i.needsUpdate=!0:i.fog&&n.fog!==t?i.needsUpdate=!0:i.lights&&n.lightsHash!==U.state.hash?i.needsUpdate=!0:void 0===n.numClippingPlanes||n.numClippingPlanes===we.numPlanes&&n.numIntersection===we.numIntersection||(i.needsUpdate=!0)),i.needsUpdate&&(Ye(i,t,r),i.needsUpdate=!1);var a,s,c=!1,l=!1,h=!1,u=n.program,d=u.getUniforms(),p=n.shader.uniforms;if(L.useProgram(u.program)&&(c=!0,l=!0,h=!0),i.id!==ae&&(ae=i.id,l=!0),c||e!==ce){if(d.setValue(_,"projectionMatrix",e.projectionMatrix),C.logarithmicDepthBuffer&&d.setValue(_,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),ce!==(le||e)&&(ce=le||e,l=!0,h=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.envMap){var f=d.map.cameraPosition;void 0!==f&&f.setValue(_,Re.setFromMatrixPosition(e.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.skinning)&&d.setValue(_,"viewMatrix",e.matrixWorldInverse)}if(i.skinning){d.setOptional(_,r,"bindMatrix"),d.setOptional(_,r,"bindMatrixInverse");var m=r.skeleton;if(m){var g=m.bones;if(C.floatVertexTextures){if(void 0===m.boneTexture){var v=Math.sqrt(4*g.length);v=ht.nextPowerOfTwo(Math.ceil(v)),v=Math.max(v,4);var y=new Float32Array(v*v*4);y.set(m.boneMatrices);var E=new Rt(y,v,v,Ie,Ae);m.boneMatrices=y,m.boneTexture=E,m.boneTextureSize=v}d.setValue(_,"boneTexture",m.boneTexture),d.setValue(_,"boneTextureSize",m.boneTextureSize)}else d.setOptional(_,m,"boneMatrices")}}return l&&(d.setValue(_,"toneMappingExposure",ie.toneMappingExposure),d.setValue(_,"toneMappingWhitePoint",ie.toneMappingWhitePoint),i.lights&&(s=h,(a=p).ambientLightColor.needsUpdate=s,a.directionalLights.needsUpdate=s,a.pointLights.needsUpdate=s,a.spotLights.needsUpdate=s,a.rectAreaLights.needsUpdate=s,a.hemisphereLights.needsUpdate=s),t&&i.fog&&function(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}(p,t),i.isMeshBasicMaterial?Ze(p,i):i.isMeshLambertMaterial?(Ze(p,i),function(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(p,i)):i.isMeshPhongMaterial?(Ze(p,i),i.isMeshToonMaterial?function(e,t){Je(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(p,i):Je(p,i)):i.isMeshStandardMaterial?(Ze(p,i),i.isMeshPhysicalMaterial?function(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,Qe(e,t)}(p,i):Qe(p,i)):i.isMeshDepthMaterial?(Ze(p,i),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(p,i)):i.isMeshDistanceMaterial?(Ze(p,i),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(p,i)):i.isMeshNormalMaterial?(Ze(p,i),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale);t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale));t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(p,i)):i.isLineBasicMaterial?(function(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}(p,i),i.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(p,i)):i.isPointsMaterial?function(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*ge,e.scale.value=.5*me,e.map.value=t.map,null!==t.map){var i=t.map.offset,r=t.map.repeat;e.offsetRepeat.value.set(i.x,i.y,r.x,r.y)}}(p,i):i.isShadowMaterial&&(p.color.value=i.color,p.opacity.value=i.opacity),void 0!==p.ltcMat&&(p.ltcMat.value=mi.LTC_MAT_TEXTURE),void 0!==p.ltcMag&&(p.ltcMag.value=mi.LTC_MAG_TEXTURE),di.upload(_,n.uniformsList,p,ie)),d.setValue(_,"modelViewMatrix",r.modelViewMatrix),d.setValue(_,"normalMatrix",r.normalMatrix),d.setValue(_,"modelMatrix",r.matrixWorld),u}function Ze(e,t){var i;if(e.opacity.value=t.opacity,t.color&&(e.diffuse.value=t.color),t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),t.map&&(e.map.value=t.map),t.alphaMap&&(e.alphaMap.value=t.alphaMap),t.specularMap&&(e.specularMap.value=t.specularMap),t.envMap&&(e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity),t.map?i=t.map:t.specularMap?i=t.specularMap:t.displacementMap?i=t.displacementMap:t.normalMap?i=t.normalMap:t.bumpMap?i=t.bumpMap:t.roughnessMap?i=t.roughnessMap:t.metalnessMap?i=t.metalnessMap:t.alphaMap?i=t.alphaMap:t.emissiveMap&&(i=t.emissiveMap),void 0!==i){i.isWebGLRenderTarget&&(i=i.texture);var r=i.offset,n=i.repeat;e.offsetRepeat.value.set(r.x,r.y,n.x,n.y)}}function Je(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function Qe(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}this.animate=function(e){ke=e,je||((Be.getDevice()||window).requestAnimationFrame(Ge),je=!0)},this.render=function(e,t,i,r){if(t&&t.isCamera){if(!re){se="",ae=-1,ce=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),Be.enabled&&(t=Be.getCamera(t)),Se.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),xe.setFromMatrix(Se),f.length=0,m.length=0,x.length=0,A.length=0,Me=this.localClippingEnabled,Te=we.init(this.clippingPlanes,Me,t),(E=V.get(e,t)).init(),function e(t,i,r){if(!t.visible)return;var n=t.layers.test(i.layers);if(n)if(t.isLight)f.push(t),t.castShadow&&m.push(t);else if(t.isSprite)t.frustumCulled&&!xe.intersectsSprite(t)||x.push(t);else if(t.isLensFlare)A.push(t);else if(t.isImmediateRenderObject)r&&Re.setFromMatrixPosition(t.matrixWorld).applyMatrix4(Se),E.push(t,null,t.material,Re.z,null);else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.update(),!t.frustumCulled||xe.intersectsObject(t))){r&&Re.setFromMatrixPosition(t.matrixWorld).applyMatrix4(Se);var o=O.update(t),a=t.material;if(Array.isArray(a))for(var s=o.groups,c=0,l=s.length;c<l;c++){var h=s[c],u=a[h.materialIndex];u&&u.visible&&E.push(t,o,u,Re.z,h)}else a.visible&&E.push(t,o,a,Re.z,null)}var d=t.children;for(var c=0,l=d.length;c<l;c++)e(d[c],i,r)}(e,t,ie.sortObjects),!0===ie.sortObjects&&E.sort(),Te&&we.beginShadows(),Oe.render(m,e,t),U.setup(f,m,t),Te&&we.endShadows(),Ce.frame++,Ce.calls=0,Ce.vertices=0,Ce.faces=0,Ce.points=0,void 0===i&&(i=null),this.setRenderTarget(i),F.render(E,e,t,r);var n=E.opaque,o=E.transparent;if(e.overrideMaterial){var a=e.overrideMaterial;n.length&&We(n,e,t,a),o.length&&We(o,e,t,a)}else n.length&&We(n,e,t),o.length&&We(o,e,t);$.render(x,e,t),K.render(A,e,t,he),i&&H.updateRenderTargetMipmap(i),L.buffers.depth.setTest(!0),L.buffers.depth.setMask(!0),L.buffers.color.setMask(!0),L.setPolygonOffset(!1),Be.enabled&&Be.submitFrame()}}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.setFaceCulling=function(e,t){L.setCullFace(e),L.setFlipSided(t===d)},this.allocTextureUnit=function(){var e=pe;return e>=C.maxTextures&&console.warn("THREE.WebGLRenderer: Trying to use "+e+" texture units while this GPU supports only "+C.maxTextures),pe+=1,e},this.setTexture2D=(ze=!1,function(e,t){e&&e.isWebGLRenderTarget&&(ze||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),ze=!0),e=e.texture),H.setTexture2D(e,t)}),this.setTexture=function(){var e=!1;return function(t,i){e||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),H.setTexture2D(t,i)}}(),this.setTextureCube=function(){var e=!1;return function(t,i){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?H.setTextureCube(t,i):H.setTextureCubeDynamic(t,i)}}(),this.getRenderTarget=function(){return ne},this.setRenderTarget=function(e){ne=e,e&&void 0===P.get(e).__webglFramebuffer&&H.setupRenderTarget(e);var t=null,i=!1;if(e){var r=P.get(e).__webglFramebuffer;e.isWebGLRenderTargetCube?(t=r[e.activeCubeFace],i=!0):t=r,he.copy(e.viewport),ue.copy(e.scissor),de=e.scissorTest}else he.copy(ve).multiplyScalar(ge),ue.copy(ye).multiplyScalar(ge),de=Ee;if(oe!==t&&(_.bindFramebuffer(_.FRAMEBUFFER,t),oe=t),L.viewport(he),L.scissor(ue),L.setScissorTest(de),i){var n=P.get(e.texture);_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,n.__webglTexture,e.activeMipMapLevel)}},this.readRenderTargetPixels=function(e,t,i,r,n,o){if(e&&e.isWebGLRenderTarget){var a=P.get(e).__webglFramebuffer;if(a){var s=!1;a!==oe&&(_.bindFramebuffer(_.FRAMEBUFFER,a),s=!0);try{var c=e.texture,l=c.format,h=c.type;if(l!==Ie&&ee.convert(l)!==_.getParameter(_.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(h===be||ee.convert(h)===_.getParameter(_.IMPLEMENTATION_COLOR_READ_TYPE)||h===Ae&&(D.get("OES_texture_float")||D.get("WEBGL_color_buffer_float"))||h===_e&&D.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");_.checkFramebufferStatus(_.FRAMEBUFFER)===_.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-r&&i>=0&&i<=e.height-n&&_.readPixels(t,i,r,n,ee.convert(l),ee.convert(h),o):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&_.bindFramebuffer(_.FRAMEBUFFER,oe)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")}}function an(e,t){this.name="",this.color=new fi(e),this.density=void 0!==t?t:25e-5}function sn(e,t,i){this.name="",this.color=new fi(e),this.near=void 0!==t?t:1,this.far=void 0!==i?i:1e3}function cn(){Zi.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function ln(e,t,i,r,n){Zi.call(this),this.lensFlares=[],this.positionScreen=new Mt,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,i,r,n)}function hn(e){Li.call(this),this.type="SpriteMaterial",this.color=new fi(16777215),this.map=null,this.rotation=0,this.fog=!1,this.lights=!1,this.setValues(e)}function un(e){Zi.call(this),this.type="Sprite",this.material=void 0!==e?e:new hn}function dn(){Zi.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function pn(e,t){if(e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[];for(var i=0,r=this.bones.length;i<r;i++)this.boneInverses.push(new St)}}function fn(){Zi.call(this),this.type="Bone"}function mn(e,t){Hr.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new St,this.bindMatrixInverse=new St;var i=new pn(this.initBones());this.bind(i,this.matrixWorld),this.normalizeSkinWeights()}function gn(e){Li.call(this),this.type="LineBasicMaterial",this.color=new fi(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(e)}function vn(e,t,i){if(1===i)return console.warn("THREE.Line: parameter THREE.LinePieces no longer supported. Created THREE.LineSegments instead."),new yn(e,t);Zi.call(this),this.type="Line",this.geometry=void 0!==e?e:new Mr,this.material=void 0!==t?t:new gn({color:16777215*Math.random()})}function yn(e,t){vn.call(this,e,t),this.type="LineSegments"}function En(e,t){vn.call(this,e,t),this.type="LineLoop"}function xn(e){Li.call(this),this.type="PointsMaterial",this.color=new fi(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.lights=!1,this.setValues(e)}function bn(e,t){Zi.call(this),this.type="Points",this.geometry=void 0!==e?e:new Mr,this.material=void 0!==t?t:new xn({color:16777215*Math.random()})}function wn(){Zi.call(this),this.type="Group"}function Tn(e,t,i,r,n,o,a,s,c){Et.call(this,e,t,i,r,n,o,a,s,c),this.generateMipmaps=!1;var l=this;!function t(){requestAnimationFrame(t),e.readyState>=e.HAVE_CURRENT_DATA&&(l.needsUpdate=!0)}()}function Mn(e,t,i,r,n,o,a,s,c,l,h,u){Et.call(this,null,o,a,s,c,l,r,n,h,u),this.image={width:t,height:i},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}function Sn(e,t,i,r,n,o,a,s,c,l){if((l=void 0!==l?l:Ve)!==Ve&&l!==Fe)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&l===Ve&&(i=Me),void 0===i&&l===Fe&&(i=Pe),Et.call(this,null,r,n,o,a,s,l,i,c),this.image={width:e,height:t},this.magFilter=void 0!==a?a:me,this.minFilter=void 0!==s?s:me,this.flipY=!1,this.generateMipmaps=!1}function Rn(e){Mr.call(this),this.type="WireframeGeometry";var t,i,r,n,o,a,s,c,l,h,u=[],d=[0,0],p={},f=["a","b","c"];if(e&&e.isGeometry){var m=e.faces;for(t=0,r=m.length;t<r;t++){var g=m[t];for(i=0;i<3;i++)s=g[f[i]],c=g[f[(i+1)%3]],d[0]=Math.min(s,c),d[1]=Math.max(s,c),void 0===p[l=d[0]+","+d[1]]&&(p[l]={index1:d[0],index2:d[1]})}for(l in p)a=p[l],h=e.vertices[a.index1],u.push(h.x,h.y,h.z),h=e.vertices[a.index2],u.push(h.x,h.y,h.z)}else if(e&&e.isBufferGeometry){var v,y,E,x,b,w,T;if(h=new Mt,null!==e.index){for(v=e.attributes.position,y=e.index,0===(E=e.groups).length&&(E=[{start:0,count:y.count,materialIndex:0}]),n=0,o=E.length;n<o;++n)for(t=b=(x=E[n]).start,r=b+x.count;t<r;t+=3)for(i=0;i<3;i++)s=y.getX(t+i),c=y.getX(t+(i+1)%3),d[0]=Math.min(s,c),d[1]=Math.max(s,c),void 0===p[l=d[0]+","+d[1]]&&(p[l]={index1:d[0],index2:d[1]});for(l in p)a=p[l],h.fromBufferAttribute(v,a.index1),u.push(h.x,h.y,h.z),h.fromBufferAttribute(v,a.index2),u.push(h.x,h.y,h.z)}else for(t=0,r=(v=e.attributes.position).count/3;t<r;t++)for(i=0;i<3;i++)w=3*t+i,h.fromBufferAttribute(v,w),u.push(h.x,h.y,h.z),T=3*t+(i+1)%3,h.fromBufferAttribute(v,T),u.push(h.x,h.y,h.z)}this.addAttribute("position",new xr(u,3))}function An(e,t,i){ur.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:i},this.fromBufferGeometry(new _n(e,t,i)),this.mergeVertices()}function _n(e,t,i){Mr.call(this),this.type="ParametricBufferGeometry",this.parameters={func:e,slices:t,stacks:i};var r,n,o=[],a=[],s=[],c=[],l=new Mt,h=new Mt,u=new Mt,d=new Mt,p=new Mt,f=t+1;for(r=0;r<=i;r++){var m=r/i;for(n=0;n<=t;n++){var g=n/t;h=e(g,m,h),a.push(h.x,h.y,h.z),g-1e-5>=0?(u=e(g-1e-5,m,u),d.subVectors(h,u)):(u=e(g+1e-5,m,u),d.subVectors(u,h)),m-1e-5>=0?(u=e(g,m-1e-5,u),p.subVectors(h,u)):(u=e(g,m+1e-5,u),p.subVectors(u,h)),l.crossVectors(d,p).normalize(),s.push(l.x,l.y,l.z),c.push(g,m)}}for(r=0;r<i;r++)for(n=0;n<t;n++){var v=r*f+n,y=r*f+n+1,E=(r+1)*f+n+1,x=(r+1)*f+n;o.push(v,y,x),o.push(y,E,x)}this.setIndex(o),this.addAttribute("position",new xr(a,3)),this.addAttribute("normal",new xr(s,3)),this.addAttribute("uv",new xr(c,2))}function Dn(e,t,i,r){ur.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:r},this.fromBufferGeometry(new Cn(e,t,i,r)),this.mergeVertices()}function Cn(e,t,i,r){Mr.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:r},i=i||1;var n=[],o=[];function a(e,t,i,r){var n,o,a=Math.pow(2,r),c=[];for(n=0;n<=a;n++){c[n]=[];var l=e.clone().lerp(i,n/a),h=t.clone().lerp(i,n/a),u=a-n;for(o=0;o<=u;o++)c[n][o]=0===o&&n===a?l:l.clone().lerp(h,o/u)}for(n=0;n<a;n++)for(o=0;o<2*(a-n)-1;o++){var d=Math.floor(o/2);o%2==0?(s(c[n][d+1]),s(c[n+1][d]),s(c[n][d])):(s(c[n][d+1]),s(c[n+1][d+1]),s(c[n+1][d]))}}function s(e){n.push(e.x,e.y,e.z)}function c(t,i){var r=3*t;i.x=e[r+0],i.y=e[r+1],i.z=e[r+2]}function l(e,t,i,r){r<0&&1===e.x&&(o[t]=e.x-1),0===i.x&&0===i.z&&(o[t]=r/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}!function(e){for(var i=new Mt,r=new Mt,n=new Mt,o=0;o<t.length;o+=3)c(t[o+0],i),c(t[o+1],r),c(t[o+2],n),a(i,r,n,e)}(r=r||0),function(e){for(var t=new Mt,i=0;i<n.length;i+=3)t.x=n[i+0],t.y=n[i+1],t.z=n[i+2],t.normalize().multiplyScalar(e),n[i+0]=t.x,n[i+1]=t.y,n[i+2]=t.z}(i),function(){for(var e=new Mt,t=0;t<n.length;t+=3){e.x=n[t+0],e.y=n[t+1],e.z=n[t+2];var i=h(e)/2/Math.PI+.5,r=(a=e,Math.atan2(-a.y,Math.sqrt(a.x*a.x+a.z*a.z))/Math.PI+.5);o.push(i,1-r)}var a;(function(){for(var e=new Mt,t=new Mt,i=new Mt,r=new Mt,a=new ut,s=new ut,c=new ut,u=0,d=0;u<n.length;u+=9,d+=6){e.set(n[u+0],n[u+1],n[u+2]),t.set(n[u+3],n[u+4],n[u+5]),i.set(n[u+6],n[u+7],n[u+8]),a.set(o[d+0],o[d+1]),s.set(o[d+2],o[d+3]),c.set(o[d+4],o[d+5]),r.copy(e).add(t).add(i).divideScalar(3);var p=h(r);l(a,d+0,e,p),l(s,d+2,t,p),l(c,d+4,i,p)}})(),function(){for(var e=0;e<o.length;e+=6){var t=o[e+0],i=o[e+2],r=o[e+4],n=Math.max(t,i,r),a=Math.min(t,i,r);n>.9&&a<.1&&(t<.2&&(o[e+0]+=1),i<.2&&(o[e+2]+=1),r<.2&&(o[e+4]+=1))}}()}(),this.addAttribute("position",new xr(n,3)),this.addAttribute("normal",new xr(n.slice(),3)),this.addAttribute("uv",new xr(o,2)),0===r?this.computeVertexNormals():this.normalizeNormals()}function Ln(e,t){ur.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Pn(e,t)),this.mergeVertices()}function Pn(e,t){Cn.call(this,[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function Hn(e,t){ur.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Bn(e,t)),this.mergeVertices()}function Bn(e,t){Cn.call(this,[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function In(e,t){ur.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new On(e,t)),this.mergeVertices()}function On(e,t){var i=(1+Math.sqrt(5))/2,r=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1];Cn.call(this,r,[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function Un(e,t){ur.call(this),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Nn(e,t)),this.mergeVertices()}function Nn(e,t){var i=(1+Math.sqrt(5))/2,r=1/i,n=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-r,-i,0,-r,i,0,r,-i,0,r,i,-r,-i,0,-r,i,0,r,-i,0,r,i,0,-i,0,-r,i,0,-r,-i,0,r,i,0,r];Cn.call(this,n,[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronBufferGeometry",this.parameters={radius:e,detail:t}}function Vn(e,t,i,r,n,o){ur.call(this),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:r,closed:n},void 0!==o&&console.warn("THREE.TubeGeometry: taper has been removed.");var a=new Fn(e,t,i,r,n);this.tangents=a.tangents,this.normals=a.normals,this.binormals=a.binormals,this.fromBufferGeometry(a),this.mergeVertices()}function Fn(e,t,i,r,n){Mr.call(this),this.type="TubeBufferGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:r,closed:n},t=t||64,i=i||1,r=r||8,n=n||!1;var o=e.computeFrenetFrames(t,n);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals;var a,s,c=new Mt,l=new Mt,h=new ut,u=[],d=[],p=[],f=[];function m(n){var a=e.getPointAt(n/t),h=o.normals[n],p=o.binormals[n];for(s=0;s<=r;s++){var f=s/r*Math.PI*2,m=Math.sin(f),g=-Math.cos(f);l.x=g*h.x+m*p.x,l.y=g*h.y+m*p.y,l.z=g*h.z+m*p.z,l.normalize(),d.push(l.x,l.y,l.z),c.x=a.x+i*l.x,c.y=a.y+i*l.y,c.z=a.z+i*l.z,u.push(c.x,c.y,c.z)}}!function(){for(a=0;a<t;a++)m(a);m(!1===n?t:0),function(){for(a=0;a<=t;a++)for(s=0;s<=r;s++)h.x=a/t,h.y=s/r,p.push(h.x,h.y)}(),function(){for(s=1;s<=t;s++)for(a=1;a<=r;a++){var e=(r+1)*(s-1)+(a-1),i=(r+1)*s+(a-1),n=(r+1)*s+a,o=(r+1)*(s-1)+a;f.push(e,i,o),f.push(i,n,o)}}()}(),this.setIndex(f),this.addAttribute("position",new xr(u,3)),this.addAttribute("normal",new xr(d,3)),this.addAttribute("uv",new xr(p,2))}function zn(e,t,i,r,n,o,a){ur.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:r,p:n,q:o},void 0!==a&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new jn(e,t,i,r,n,o)),this.mergeVertices()}function jn(e,t,i,r,n,o){Mr.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:r,p:n,q:o},e=e||100,t=t||40,i=Math.floor(i)||64,r=Math.floor(r)||8,n=n||2,o=o||3;var a,s,c=[],l=[],h=[],u=[],d=new Mt,p=new Mt,f=new Mt,m=new Mt,g=new Mt,v=new Mt,y=new Mt;for(a=0;a<=i;++a){var E=a/i*n*Math.PI*2;for(A(E,n,o,e,f),A(E+.01,n,o,e,m),v.subVectors(m,f),y.addVectors(m,f),g.crossVectors(v,y),y.crossVectors(g,v),g.normalize(),y.normalize(),s=0;s<=r;++s){var x=s/r*Math.PI*2,b=-t*Math.cos(x),w=t*Math.sin(x);d.x=f.x+(b*y.x+w*g.x),d.y=f.y+(b*y.y+w*g.y),d.z=f.z+(b*y.z+w*g.z),l.push(d.x,d.y,d.z),p.subVectors(d,f).normalize(),h.push(p.x,p.y,p.z),u.push(a/i),u.push(s/r)}}for(s=1;s<=i;s++)for(a=1;a<=r;a++){var T=(r+1)*(s-1)+(a-1),M=(r+1)*s+(a-1),S=(r+1)*s+a,R=(r+1)*(s-1)+a;c.push(T,M,R),c.push(M,S,R)}function A(e,t,i,r,n){var o=Math.cos(e),a=Math.sin(e),s=i/t*e,c=Math.cos(s);n.x=r*(2+c)*.5*o,n.y=r*(2+c)*a*.5,n.z=r*Math.sin(s)*.5}this.setIndex(c),this.addAttribute("position",new xr(l,3)),this.addAttribute("normal",new xr(h,3)),this.addAttribute("uv",new xr(u,2))}function kn(e,t,i,r,n){ur.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:r,arc:n},this.fromBufferGeometry(new Gn(e,t,i,r,n)),this.mergeVertices()}function Gn(e,t,i,r,n){Mr.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:r,arc:n},e=e||100,t=t||40,i=Math.floor(i)||8,r=Math.floor(r)||6,n=n||2*Math.PI;var o,a,s=[],c=[],l=[],h=[],u=new Mt,d=new Mt,p=new Mt;for(o=0;o<=i;o++)for(a=0;a<=r;a++){var f=a/r*n,m=o/i*Math.PI*2;d.x=(e+t*Math.cos(m))*Math.cos(f),d.y=(e+t*Math.cos(m))*Math.sin(f),d.z=t*Math.sin(m),c.push(d.x,d.y,d.z),u.x=e*Math.cos(f),u.y=e*Math.sin(f),p.subVectors(d,u).normalize(),l.push(p.x,p.y,p.z),h.push(a/r),h.push(o/i)}for(o=1;o<=i;o++)for(a=1;a<=r;a++){var g=(r+1)*o+a-1,v=(r+1)*(o-1)+a-1,y=(r+1)*(o-1)+a,E=(r+1)*o+a;s.push(g,v,E),s.push(v,y,E)}this.setIndex(s),this.addAttribute("position",new xr(c,3)),this.addAttribute("normal",new xr(l,3)),this.addAttribute("uv",new xr(h,2))}rn.prototype=Object.assign(Object.create(Ki.prototype),{constructor:rn,isArrayCamera:!0}),an.prototype.isFogExp2=!0,an.prototype.clone=function(){return new an(this.color.getHex(),this.density)},an.prototype.toJSON=function(e){return{type:"FogExp2",color:this.color.getHex(),density:this.density}},sn.prototype.isFog=!0,sn.prototype.clone=function(){return new sn(this.color.getHex(),this.near,this.far)},sn.prototype.toJSON=function(e){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}},cn.prototype=Object.assign(Object.create(Zi.prototype),{constructor:cn,copy:function(e,t){return Zi.prototype.copy.call(this,e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},toJSON:function(e){var t=Zi.prototype.toJSON.call(this,e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}),ln.prototype=Object.assign(Object.create(Zi.prototype),{constructor:ln,isLensFlare:!0,copy:function(e){Zi.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,i=e.lensFlares.length;t<i;t++)this.lensFlares.push(e.lensFlares[t]);return this},add:function(e,t,i,r,n,o){void 0===t&&(t=-1),void 0===i&&(i=0),void 0===o&&(o=1),void 0===n&&(n=new fi(16777215)),void 0===r&&(r=w),i=Math.min(i,Math.max(0,i)),this.lensFlares.push({texture:e,size:t,distance:i,x:0,y:0,z:0,scale:1,rotation:0,opacity:o,color:n,blending:r})},updateLensFlares:function(){var e,t,i=this.lensFlares.length,r=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;e<i;e++)(t=this.lensFlares[e]).x=this.positionScreen.x+r*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}}),hn.prototype=Object.create(Li.prototype),hn.prototype.constructor=hn,hn.prototype.isSpriteMaterial=!0,hn.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.rotation=e.rotation,this},un.prototype=Object.assign(Object.create(Zi.prototype),{constructor:un,isSprite:!0,raycast:(Fr=new Mt,zr=new Mt,jr=new Mt,function(e,t){zr.setFromMatrixPosition(this.matrixWorld),e.ray.closestPointToPoint(zr,Fr),jr.setFromMatrixScale(this.matrixWorld);var i=jr.x*jr.y/4;if(!(zr.distanceToSquared(Fr)>i)){var r=e.ray.origin.distanceTo(Fr);r<e.near||r>e.far||t.push({distance:r,point:Fr.clone(),face:null,object:this})}}),clone:function(){return new this.constructor(this.material).copy(this)}}),dn.prototype=Object.assign(Object.create(Zi.prototype),{constructor:dn,copy:function(e){Zi.prototype.copy.call(this,e,!1);for(var t=e.levels,i=0,r=t.length;i<r;i++){var n=t[i];this.addLevel(n.object.clone(),n.distance)}return this},addLevel:function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var i=this.levels,r=0;r<i.length&&!(t<i[r].distance);r++);i.splice(r,0,{distance:t,object:e}),this.add(e)},getObjectForDistance:function(e){for(var t=this.levels,i=1,r=t.length;i<r&&!(e<t[i].distance);i++);return t[i-1].object},raycast:(kr=new Mt,function(e,t){kr.setFromMatrixPosition(this.matrixWorld);var i=e.ray.origin.distanceTo(kr);this.getObjectForDistance(i).raycast(e,t)}),update:function(){var e=new Mt,t=new Mt;return function(i){var r=this.levels;if(r.length>1){e.setFromMatrixPosition(i.matrixWorld),t.setFromMatrixPosition(this.matrixWorld);var n=e.distanceTo(t);r[0].object.visible=!0;for(var o=1,a=r.length;o<a&&n>=r[o].distance;o++)r[o-1].object.visible=!1,r[o].object.visible=!0;for(;o<a;o++)r[o].object.visible=!1}}}(),toJSON:function(e){var t=Zi.prototype.toJSON.call(this,e);t.object.levels=[];for(var i=this.levels,r=0,n=i.length;r<n;r++){var o=i[r];t.object.levels.push({object:o.object.uuid,distance:o.distance})}return t}}),Object.assign(pn.prototype,{calculateInverses:function(){this.boneInverses=[];for(var e=0,t=this.bones.length;e<t;e++){var i=new St;this.bones[e]&&i.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(i)}},pose:function(){var e,t,i;for(t=0,i=this.bones.length;t<i;t++)(e=this.bones[t])&&e.matrixWorld.getInverse(this.boneInverses[t]);for(t=0,i=this.bones.length;t<i;t++)(e=this.bones[t])&&(e.parent&&e.parent.isBone?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},update:(Gr=new St,Wr=new St,function(){for(var e=this.bones,t=this.boneInverses,i=this.boneMatrices,r=this.boneTexture,n=0,o=e.length;n<o;n++){var a=e[n]?e[n].matrixWorld:Wr;Gr.multiplyMatrices(a,t[n]),Gr.toArray(i,16*n)}void 0!==r&&(r.needsUpdate=!0)}),clone:function(){return new pn(this.bones,this.boneInverses)}}),fn.prototype=Object.assign(Object.create(Zi.prototype),{constructor:fn,isBone:!0}),mn.prototype=Object.assign(Object.create(Hr.prototype),{constructor:mn,isSkinnedMesh:!0,initBones:function(){var e,t,i,r,n=[];if(this.geometry&&void 0!==this.geometry.bones){for(i=0,r=this.geometry.bones.length;i<r;i++)t=this.geometry.bones[i],e=new fn,n.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(i=0,r=this.geometry.bones.length;i<r;i++)-1!==(t=this.geometry.bones[i]).parent&&null!==t.parent&&void 0!==n[t.parent]?n[t.parent].add(n[i]):this.add(n[i])}return this.updateMatrixWorld(!0),n},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var i=this.geometry.skinWeights[t];(e=1/i.lengthManhattan())!==1/0?i.multiplyScalar(e):i.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var r=new xt,n=this.geometry.attributes.skinWeight;for(t=0;t<n.count;t++)r.x=n.getX(t),r.y=n.getY(t),r.z=n.getZ(t),r.w=n.getW(t),(e=1/r.lengthManhattan())!==1/0?r.multiplyScalar(e):r.set(1,0,0,0),n.setXYZW(t,r.x,r.y,r.z,r.w)}},updateMatrixWorld:function(e){Hr.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),gn.prototype=Object.create(Li.prototype),gn.prototype.constructor=gn,gn.prototype.isLineBasicMaterial=!0,gn.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this},vn.prototype=Object.assign(Object.create(Zi.prototype),{constructor:vn,isLine:!0,raycast:function(){var e=new St,t=new Cr,i=new Oi;return function(r,n){var o=r.linePrecision,a=o*o,s=this.geometry,c=this.matrixWorld;if(null===s.boundingSphere&&s.computeBoundingSphere(),i.copy(s.boundingSphere),i.applyMatrix4(c),!1!==r.ray.intersectsSphere(i)){e.getInverse(c),t.copy(r.ray).applyMatrix4(e);var l=new Mt,h=new Mt,u=new Mt,d=new Mt,p=this&&this.isLineSegments?2:1;if(s.isBufferGeometry){var f=s.index,m=s.attributes.position.array;if(null!==f)for(var g=f.array,v=0,y=g.length-1;v<y;v+=p){var E=g[v],x=g[v+1];if(l.fromArray(m,3*E),h.fromArray(m,3*x),!(t.distanceSqToSegment(l,h,d,u)>a))d.applyMatrix4(this.matrixWorld),(T=r.ray.origin.distanceTo(d))<r.near||T>r.far||n.push({distance:T,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}else for(v=0,y=m.length/3-1;v<y;v+=p){if(l.fromArray(m,3*v),h.fromArray(m,3*v+3),!(t.distanceSqToSegment(l,h,d,u)>a))d.applyMatrix4(this.matrixWorld),(T=r.ray.origin.distanceTo(d))<r.near||T>r.far||n.push({distance:T,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}else if(s.isGeometry){var b=s.vertices,w=b.length;for(v=0;v<w-1;v+=p){var T;if(!(t.distanceSqToSegment(b[v],b[v+1],d,u)>a))d.applyMatrix4(this.matrixWorld),(T=r.ray.origin.distanceTo(d))<r.near||T>r.far||n.push({distance:T,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),yn.prototype=Object.assign(Object.create(vn.prototype),{constructor:yn,isLineSegments:!0}),En.prototype=Object.assign(Object.create(vn.prototype),{constructor:En,isLineLoop:!0}),xn.prototype=Object.create(Li.prototype),xn.prototype.constructor=xn,xn.prototype.isPointsMaterial=!0,xn.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this},bn.prototype=Object.assign(Object.create(Zi.prototype),{constructor:bn,isPoints:!0,raycast:function(){var e=new St,t=new Cr,i=new Oi;return function(r,n){var o=this,a=this.geometry,s=this.matrixWorld,c=r.params.Points.threshold;if(null===a.boundingSphere&&a.computeBoundingSphere(),i.copy(a.boundingSphere),i.applyMatrix4(s),i.radius+=c,!1!==r.ray.intersectsSphere(i)){e.getInverse(s),t.copy(r.ray).applyMatrix4(e);var l=c/((this.scale.x+this.scale.y+this.scale.z)/3),h=l*l,u=new Mt;if(a.isBufferGeometry){var d=a.index,p=a.attributes.position.array;if(null!==d)for(var f=d.array,m=0,g=f.length;m<g;m++){var v=f[m];u.fromArray(p,3*v),x(u,v)}else{m=0;for(var y=p.length/3;m<y;m++)u.fromArray(p,3*m),x(u,m)}}else{var E=a.vertices;for(m=0,y=E.length;m<y;m++)x(E[m],m)}}function x(e,i){var a=t.distanceSqToPoint(e);if(a<h){var c=t.closestPointToPoint(e);c.applyMatrix4(s);var l=r.ray.origin.distanceTo(c);if(l<r.near||l>r.far)return;n.push({distance:l,distanceToRay:Math.sqrt(a),point:c.clone(),index:i,face:null,object:o})}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),wn.prototype=Object.assign(Object.create(Zi.prototype),{constructor:wn}),Tn.prototype=Object.create(Et.prototype),Tn.prototype.constructor=Tn,Mn.prototype=Object.create(Et.prototype),Mn.prototype.constructor=Mn,Mn.prototype.isCompressedTexture=!0,Sn.prototype=Object.create(Et.prototype),Sn.prototype.constructor=Sn,Sn.prototype.isDepthTexture=!0,Rn.prototype=Object.create(Mr.prototype),Rn.prototype.constructor=Rn,An.prototype=Object.create(ur.prototype),An.prototype.constructor=An,_n.prototype=Object.create(Mr.prototype),_n.prototype.constructor=_n,Dn.prototype=Object.create(ur.prototype),Dn.prototype.constructor=Dn,Cn.prototype=Object.create(Mr.prototype),Cn.prototype.constructor=Cn,Ln.prototype=Object.create(ur.prototype),Ln.prototype.constructor=Ln,Pn.prototype=Object.create(Cn.prototype),Pn.prototype.constructor=Pn,Hn.prototype=Object.create(ur.prototype),Hn.prototype.constructor=Hn,Bn.prototype=Object.create(Cn.prototype),Bn.prototype.constructor=Bn,In.prototype=Object.create(ur.prototype),In.prototype.constructor=In,On.prototype=Object.create(Cn.prototype),On.prototype.constructor=On,Un.prototype=Object.create(ur.prototype),Un.prototype.constructor=Un,Nn.prototype=Object.create(Cn.prototype),Nn.prototype.constructor=Nn,Vn.prototype=Object.create(ur.prototype),Vn.prototype.constructor=Vn,Fn.prototype=Object.create(Mr.prototype),Fn.prototype.constructor=Fn,zn.prototype=Object.create(ur.prototype),zn.prototype.constructor=zn,jn.prototype=Object.create(Mr.prototype),jn.prototype.constructor=jn,kn.prototype=Object.create(ur.prototype),kn.prototype.constructor=kn,Gn.prototype=Object.create(Mr.prototype),Gn.prototype.constructor=Gn;var Wn={area:function(e){for(var t=e.length,i=0,r=t-1,n=0;n<t;r=n++)i+=e[r].x*e[n].y-e[n].x*e[r].y;return.5*i},triangulate:function(){function e(e,t,i,r,n,o){var a,s,c,l,h,u,d,p,f,m,g,v,y,E,x,b,w;if(s=e[o[t]].x,c=e[o[t]].y,l=e[o[i]].x,h=e[o[i]].y,u=e[o[r]].x,(l-s)*((d=e[o[r]].y)-c)-(h-c)*(u-s)<=0)return!1;for(m=u-l,g=d-h,v=s-u,y=c-d,E=l-s,x=h-c,a=0;a<n;a++)if(p=e[o[a]].x,f=e[o[a]].y,!(p===s&&f===c||p===l&&f===h||p===u&&f===d)&&(b=E*(f-c)-x*(p-s),w=v*(f-d)-y*(p-u),m*(f-h)-g*(p-l)>=-Number.EPSILON&&w>=-Number.EPSILON&&b>=-Number.EPSILON))return!1;return!0}return function(t,i){var r=t.length;if(r<3)return null;var n,o,a,s=[],c=[],l=[];if(Wn.area(t)>0)for(o=0;o<r;o++)c[o]=o;else for(o=0;o<r;o++)c[o]=r-1-o;var h=r,u=2*h;for(o=h-1;h>2;){if(u--<=0)return console.warn("THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"),i?l:s;if(h<=(n=o)&&(n=0),h<=(o=n+1)&&(o=0),h<=(a=o+1)&&(a=0),e(t,n,o,a,h,c)){var d,p,f,m,g;for(d=c[n],p=c[o],f=c[a],s.push([t[d],t[p],t[f]]),l.push([c[n],c[o],c[a]]),m=o,g=o+1;g<h;m++,g++)c[m]=c[g];u=2*--h}}return i?l:s}}(),triangulateShape:function(e,t){function i(e){var t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function r(e,t,i){return e.x!==t.x?e.x<t.x?e.x<=i.x&&i.x<=t.x:t.x<=i.x&&i.x<=e.x:e.y<t.y?e.y<=i.y&&i.y<=t.y:t.y<=i.y&&i.y<=e.y}function n(e,t,i,n,o){var a=t.x-e.x,s=t.y-e.y,c=n.x-i.x,l=n.y-i.y,h=e.x-i.x,u=e.y-i.y,d=s*c-a*l,p=s*h-a*u;if(Math.abs(d)>Number.EPSILON){var f;if(d>0){if(p<0||p>d)return[];if((f=l*h-c*u)<0||f>d)return[]}else{if(p>0||p<d)return[];if((f=l*h-c*u)>0||f<d)return[]}if(0===f)return!o||0!==p&&p!==d?[e]:[];if(f===d)return!o||0!==p&&p!==d?[t]:[];if(0===p)return[i];if(p===d)return[n];var m=f/d;return[{x:e.x+m*a,y:e.y+m*s}]}if(0!==p||l*h!=c*u)return[];var g,v,y,E,x,b,w,T,M=0===a&&0===s,S=0===c&&0===l;return M&&S?e.x!==i.x||e.y!==i.y?[]:[e]:M?r(i,n,e)?[e]:[]:S?r(e,t,i)?[i]:[]:(0!==a?(e.x<t.x?(g=e,y=e.x,v=t,E=t.x):(g=t,y=t.x,v=e,E=e.x),i.x<n.x?(x=i,w=i.x,b=n,T=n.x):(x=n,w=n.x,b=i,T=i.x)):(e.y<t.y?(g=e,y=e.y,v=t,E=t.y):(g=t,y=t.y,v=e,E=e.y),i.y<n.y?(x=i,w=i.y,b=n,T=n.y):(x=n,w=n.y,b=i,T=i.y)),y<=w?E<w?[]:E===w?o?[]:[x]:E<=T?[x,v]:[x,b]:y>T?[]:y===T?o?[]:[g]:E<=T?[g,v]:[g,b])}function o(e,t,i,r){var n=t.x-e.x,o=t.y-e.y,a=i.x-e.x,s=i.y-e.y,c=r.x-e.x,l=r.y-e.y,h=n*s-o*a,u=n*l-o*c;if(Math.abs(h)>Number.EPSILON){var d=c*s-l*a;return h>0?u>=0&&d>=0:u>=0||d>=0}return u>0}i(e),t.forEach(i);for(var a,s,c,l,h,u,d={},p=e.concat(),f=0,m=t.length;f<m;f++)Array.prototype.push.apply(p,t[f]);for(a=0,s=p.length;a<s;a++)void 0!==d[h=p[a].x+":"+p[a].y]&&console.warn("THREE.ShapeUtils: Duplicate point",h,a),d[h]=a;var g=function(e,t){var i,r=e.concat();function a(e,t){var n=r.length-1,a=e-1;a<0&&(a=n);var s=e+1;s>n&&(s=0);var c=o(r[e],r[a],r[s],i[t]);if(!c)return!1;var l=i.length-1,h=t-1;h<0&&(h=l);var u=t+1;return u>l&&(u=0),!!(c=o(i[t],i[h],i[u],r[e]))}function s(e,t){var i,o;for(i=0;i<r.length;i++)if(o=i+1,o%=r.length,n(e,t,r[i],r[o],!0).length>0)return!0;return!1}var c=[];function l(e,i){var r,o,a,s;for(r=0;r<c.length;r++)for(o=t[c[r]],a=0;a<o.length;a++)if(s=a+1,s%=o.length,n(e,i,o[a],o[s],!0).length>0)return!0;return!1}for(var h,u,d,p,f,m,g,v,y,E,x=[],b=0,w=t.length;b<w;b++)c.push(b);for(var T=0,M=2*c.length;c.length>0;){if(--M<0){console.log('THREE.ShapeUtils: Infinite Loop! Holes left:" + indepHoles.length + ", Probably Hole outside Shape!');break}for(u=T;u<r.length;u++){for(d=r[u],h=-1,b=0;b<c.length;b++)if(f=c[b],void 0===x[m=d.x+":"+d.y+":"+f]){i=t[f];for(var S=0;S<i.length;S++)if(p=i[S],a(u,S)&&!s(d,p)&&!l(d,p)){h=S,c.splice(b,1),g=r.slice(0,u+1),v=r.slice(u),y=i.slice(h),E=i.slice(0,h+1),r=g.concat(y).concat(E).concat(v),T=u;break}if(h>=0)break;x[m]=!0}if(h>=0)break}}return r}(e,t),v=Wn.triangulate(g,!1);for(a=0,s=v.length;a<s;a++)for(l=v[a],c=0;c<3;c++)void 0!==(u=d[h=l[c].x+":"+l[c].y])&&(l[c]=u);return v.concat()},isClockWise:function(e){return Wn.area(e)<0}};function Xn(e,t){ur.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},this.fromBufferGeometry(new Yn(e,t)),this.mergeVertices()}function Yn(e,t){void 0!==e&&(Mr.call(this),this.type="ExtrudeBufferGeometry",e=Array.isArray(e)?e:[e],this.addShapeList(e,t),this.computeVertexNormals())}function qn(e,t){ur.call(this),this.type="TextGeometry",this.parameters={text:e,parameters:t},this.fromBufferGeometry(new Zn(e,t)),this.mergeVertices()}function Zn(e,t){var i=(t=t||{}).font;if(!i||!i.isFont)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new ur;var r=i.generateShapes(e,t.size,t.curveSegments);t.amount=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),Yn.call(this,r,t),this.type="TextBufferGeometry"}function Jn(e,t,i,r,n,o,a){ur.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:r,phiLength:n,thetaStart:o,thetaLength:a},this.fromBufferGeometry(new Qn(e,t,i,r,n,o,a)),this.mergeVertices()}function Qn(e,t,i,r,n,o,a){Mr.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:r,phiLength:n,thetaStart:o,thetaLength:a},e=e||50,t=Math.max(3,Math.floor(t)||8),i=Math.max(2,Math.floor(i)||6),r=void 0!==r?r:0,n=void 0!==n?n:2*Math.PI;var s,c,l=(o=void 0!==o?o:0)+(a=void 0!==a?a:Math.PI),h=0,u=[],d=new Mt,p=new Mt,f=[],m=[],g=[],v=[];for(c=0;c<=i;c++){var y=[],E=c/i;for(s=0;s<=t;s++){var x=s/t;d.x=-e*Math.cos(r+x*n)*Math.sin(o+E*a),d.y=e*Math.cos(o+E*a),d.z=e*Math.sin(r+x*n)*Math.sin(o+E*a),m.push(d.x,d.y,d.z),p.set(d.x,d.y,d.z).normalize(),g.push(p.x,p.y,p.z),v.push(x,1-E),y.push(h++)}u.push(y)}for(c=0;c<i;c++)for(s=0;s<t;s++){var b=u[c][s+1],w=u[c][s],T=u[c+1][s],M=u[c+1][s+1];(0!==c||o>0)&&f.push(b,w,M),(c!==i-1||l<Math.PI)&&f.push(w,T,M)}this.setIndex(f),this.addAttribute("position",new xr(m,3)),this.addAttribute("normal",new xr(g,3)),this.addAttribute("uv",new xr(v,2))}function Kn(e,t,i,r,n,o){ur.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:r,thetaStart:n,thetaLength:o},this.fromBufferGeometry(new $n(e,t,i,r,n,o)),this.mergeVertices()}function $n(e,t,i,r,n,o){Mr.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:r,thetaStart:n,thetaLength:o},e=e||20,t=t||50,n=void 0!==n?n:0,o=void 0!==o?o:2*Math.PI,i=void 0!==i?Math.max(3,i):8;var a,s,c,l=[],h=[],u=[],d=[],p=e,f=(t-e)/(r=void 0!==r?Math.max(1,r):1),m=new Mt,g=new ut;for(s=0;s<=r;s++){for(c=0;c<=i;c++)a=n+c/i*o,m.x=p*Math.cos(a),m.y=p*Math.sin(a),h.push(m.x,m.y,m.z),u.push(0,0,1),g.x=(m.x/t+1)/2,g.y=(m.y/t+1)/2,d.push(g.x,g.y);p+=f}for(s=0;s<r;s++){var v=s*(i+1);for(c=0;c<i;c++){var y=a=c+v,E=a+i+1,x=a+i+2,b=a+1;l.push(y,E,b),l.push(E,x,b)}}this.setIndex(l),this.addAttribute("position",new xr(h,3)),this.addAttribute("normal",new xr(u,3)),this.addAttribute("uv",new xr(d,2))}function eo(e,t,i,r){ur.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:r},this.fromBufferGeometry(new to(e,t,i,r)),this.mergeVertices()}function to(e,t,i,r){Mr.call(this),this.type="LatheBufferGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:r},t=Math.floor(t)||12,i=i||0,r=r||2*Math.PI,r=ht.clamp(r,0,2*Math.PI);var n,o,a,s=[],c=[],l=[],h=1/t,u=new Mt,d=new ut;for(o=0;o<=t;o++){var p=i+o*h*r,f=Math.sin(p),m=Math.cos(p);for(a=0;a<=e.length-1;a++)u.x=e[a].x*f,u.y=e[a].y,u.z=e[a].x*m,c.push(u.x,u.y,u.z),d.x=o/t,d.y=a/(e.length-1),l.push(d.x,d.y)}for(o=0;o<t;o++)for(a=0;a<e.length-1;a++){var g=n=a+o*e.length,v=n+e.length,y=n+e.length+1,E=n+1;s.push(g,v,E),s.push(v,y,E)}if(this.setIndex(s),this.addAttribute("position",new xr(c,3)),this.addAttribute("uv",new xr(l,2)),this.computeVertexNormals(),r===2*Math.PI){var x=this.attributes.normal.array,b=new Mt,w=new Mt,T=new Mt;for(n=t*e.length*3,o=0,a=0;o<e.length;o++,a+=3)b.x=x[a+0],b.y=x[a+1],b.z=x[a+2],w.x=x[n+a+0],w.y=x[n+a+1],w.z=x[n+a+2],T.addVectors(b,w).normalize(),x[a+0]=x[n+a+0]=T.x,x[a+1]=x[n+a+1]=T.y,x[a+2]=x[n+a+2]=T.z}}function io(e,t){ur.call(this),this.type="ShapeGeometry","object"==typeof t&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),t=t.curveSegments),this.parameters={shapes:e,curveSegments:t},this.fromBufferGeometry(new ro(e,t)),this.mergeVertices()}function ro(e,t){Mr.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:e,curveSegments:t},t=t||12;var i=[],r=[],n=[],o=[],a=0,s=0;if(!1===Array.isArray(e))l(e);else for(var c=0;c<e.length;c++)l(e[c]),this.addGroup(a,s,c),a+=s,s=0;function l(e){var a,c,l,h=r.length/3,u=e.extractPoints(t),d=u.shape,p=u.holes;if(!1===Wn.isClockWise(d))for(d=d.reverse(),a=0,c=p.length;a<c;a++)l=p[a],!0===Wn.isClockWise(l)&&(p[a]=l.reverse());var f=Wn.triangulateShape(d,p);for(a=0,c=p.length;a<c;a++)l=p[a],d=d.concat(l);for(a=0,c=d.length;a<c;a++){var m=d[a];r.push(m.x,m.y,0),n.push(0,0,1),o.push(m.x,m.y)}for(a=0,c=f.length;a<c;a++){var g=f[a],v=g[0]+h,y=g[1]+h,E=g[2]+h;i.push(v,y,E),s+=3}}this.setIndex(i),this.addAttribute("position",new xr(r,3)),this.addAttribute("normal",new xr(n,3)),this.addAttribute("uv",new xr(o,2))}function no(e,t){Mr.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1;var i,r,n,o,a=[],s=Math.cos(ht.DEG2RAD*t),c=[0,0],l={},h=["a","b","c"];e.isBufferGeometry?(o=new ur).fromBufferGeometry(e):o=e.clone(),o.mergeVertices(),o.computeFaceNormals();for(var u=o.vertices,d=o.faces,p=0,f=d.length;p<f;p++)for(var m=d[p],g=0;g<3;g++)i=m[h[g]],r=m[h[(g+1)%3]],c[0]=Math.min(i,r),c[1]=Math.max(i,r),void 0===l[n=c[0]+","+c[1]]?l[n]={index1:c[0],index2:c[1],face1:p,face2:void 0}:l[n].face2=p;for(n in l){var v=l[n];if(void 0===v.face2||d[v.face1].normal.dot(d[v.face2].normal)<=s){var y=u[v.index1];a.push(y.x,y.y,y.z),y=u[v.index2],a.push(y.x,y.y,y.z)}}this.addAttribute("position",new xr(a,3))}function oo(e,t,i,r,n,o,a,s){ur.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:r,heightSegments:n,openEnded:o,thetaStart:a,thetaLength:s},this.fromBufferGeometry(new ao(e,t,i,r,n,o,a,s)),this.mergeVertices()}function ao(e,t,i,r,n,o,a,s){Mr.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:r,heightSegments:n,openEnded:o,thetaStart:a,thetaLength:s};var c=this;e=void 0!==e?e:20,t=void 0!==t?t:20,i=void 0!==i?i:100,r=Math.floor(r)||8,n=Math.floor(n)||1,o=void 0!==o&&o,a=void 0!==a?a:0,s=void 0!==s?s:2*Math.PI;var l=[],h=[],u=[],d=[],p=0,f=[],m=i/2,g=0;function v(i){var n,o,f,v=new ut,y=new Mt,E=0,x=!0===i?e:t,b=!0===i?1:-1;for(o=p,n=1;n<=r;n++)h.push(0,m*b,0),u.push(0,b,0),d.push(.5,.5),p++;for(f=p,n=0;n<=r;n++){var w=n/r*s+a,T=Math.cos(w),M=Math.sin(w);y.x=x*M,y.y=m*b,y.z=x*T,h.push(y.x,y.y,y.z),u.push(0,b,0),v.x=.5*T+.5,v.y=.5*M*b+.5,d.push(v.x,v.y),p++}for(n=0;n<r;n++){var S=o+n,R=f+n;!0===i?l.push(R,R+1,S):l.push(R+1,R,S),E+=3}c.addGroup(g,E,!0===i?1:2),g+=E}!function(){var o,v,y=new Mt,E=new Mt,x=0,b=(t-e)/i;for(v=0;v<=n;v++){var w=[],T=v/n,M=T*(t-e)+e;for(o=0;o<=r;o++){var S=o/r,R=S*s+a,A=Math.sin(R),_=Math.cos(R);E.x=M*A,E.y=-T*i+m,E.z=M*_,h.push(E.x,E.y,E.z),y.set(A,b,_).normalize(),u.push(y.x,y.y,y.z),d.push(S,1-T),w.push(p++)}f.push(w)}for(o=0;o<r;o++)for(v=0;v<n;v++){var D=f[v][o],C=f[v+1][o],L=f[v+1][o+1],P=f[v][o+1];l.push(D,C,P),l.push(C,L,P),x+=6}c.addGroup(g,x,0),g+=x}(),!1===o&&(e>0&&v(!0),t>0&&v(!1)),this.setIndex(l),this.addAttribute("position",new xr(h,3)),this.addAttribute("normal",new xr(u,3)),this.addAttribute("uv",new xr(d,2))}function so(e,t,i,r,n,o,a){oo.call(this,0,e,t,i,r,n,o,a),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:r,openEnded:n,thetaStart:o,thetaLength:a}}function co(e,t,i,r,n,o,a){ao.call(this,0,e,t,i,r,n,o,a),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:r,openEnded:n,thetaStart:o,thetaLength:a}}function lo(e,t,i,r){ur.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:r},this.fromBufferGeometry(new ho(e,t,i,r)),this.mergeVertices()}function ho(e,t,i,r){Mr.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:r},e=e||50,t=void 0!==t?Math.max(3,t):8,i=void 0!==i?i:0,r=void 0!==r?r:2*Math.PI;var n,o,a=[],s=[],c=[],l=[],h=new Mt,u=new ut;for(s.push(0,0,0),c.push(0,0,1),l.push(.5,.5),o=0,n=3;o<=t;o++,n+=3){var d=i+o/t*r;h.x=e*Math.cos(d),h.y=e*Math.sin(d),s.push(h.x,h.y,h.z),c.push(0,0,1),u.x=(s[n]/e+1)/2,u.y=(s[n+1]/e+1)/2,l.push(u.x,u.y)}for(n=1;n<=t;n++)a.push(n,n+1,0);this.setIndex(a),this.addAttribute("position",new xr(s,3)),this.addAttribute("normal",new xr(c,3)),this.addAttribute("uv",new xr(l,2))}Xn.prototype=Object.create(ur.prototype),Xn.prototype.constructor=Xn,Yn.prototype=Object.create(Mr.prototype),Yn.prototype.constructor=Yn,Yn.prototype.getArrays=function(){var e=this.getAttribute("position"),t=e?Array.prototype.slice.call(e.array):[],i=this.getAttribute("uv"),r=i?Array.prototype.slice.call(i.array):[],n=this.index;return{position:t,uv:r,index:n?Array.prototype.slice.call(n.array):[]}},Yn.prototype.addShapeList=function(e,t){var i=e.length;t.arrays=this.getArrays();for(var r=0;r<i;r++){var n=e[r];this.addShape(n,t)}this.setIndex(t.arrays.index),this.addAttribute("position",new xr(t.arrays.position,3)),this.addAttribute("uv",new xr(t.arrays.uv,2))},Yn.prototype.addShape=function(e,t){var i,r,n,o,a,s,c,l,h=t.arrays?t.arrays:this.getArrays(),u=h.position,d=h.index,p=h.uv,f=[],m=void 0!==t.amount?t.amount:100,g=void 0!==t.bevelThickness?t.bevelThickness:6,v=void 0!==t.bevelSize?t.bevelSize:g-2,y=void 0!==t.bevelSegments?t.bevelSegments:3,E=void 0===t.bevelEnabled||t.bevelEnabled,x=void 0!==t.curveSegments?t.curveSegments:12,b=void 0!==t.steps?t.steps:1,w=t.extrudePath,T=!1,M=void 0!==t.UVGenerator?t.UVGenerator:Xn.WorldUVGenerator;w&&(i=w.getSpacedPoints(b),T=!0,E=!1,r=void 0!==t.frames?t.frames:w.computeFrenetFrames(b,!1),n=new Mt,o=new Mt,a=new Mt),E||(y=0,g=0,v=0);var S=this,R=e.extractPoints(x),A=R.shape,_=R.holes;if(!Wn.isClockWise(A))for(A=A.reverse(),c=0,l=_.length;c<l;c++)s=_[c],Wn.isClockWise(s)&&(_[c]=s.reverse());var D=Wn.triangulateShape(A,_),C=A;for(c=0,l=_.length;c<l;c++)s=_[c],A=A.concat(s);function L(e,t,i){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(i).add(e)}var P,H,B,I,O,U,N=A.length,V=D.length;function F(e,t,i){var r,n,o,a=e.x-t.x,s=e.y-t.y,c=i.x-e.x,l=i.y-e.y,h=a*a+s*s,u=a*l-s*c;if(Math.abs(u)>Number.EPSILON){var d=Math.sqrt(h),p=Math.sqrt(c*c+l*l),f=t.x-s/d,m=t.y+a/d,g=((i.x-l/p-f)*l-(i.y+c/p-m)*c)/(a*l-s*c),v=(r=f+a*g-e.x)*r+(n=m+s*g-e.y)*n;if(v<=2)return new ut(r,n);o=Math.sqrt(v/2)}else{var y=!1;a>Number.EPSILON?c>Number.EPSILON&&(y=!0):a<-Number.EPSILON?c<-Number.EPSILON&&(y=!0):Math.sign(s)===Math.sign(l)&&(y=!0),y?(r=-s,n=a,o=Math.sqrt(h)):(r=a,n=s,o=Math.sqrt(h/2))}return new ut(r/o,n/o)}for(var z=[],j=0,k=C.length,G=k-1,W=j+1;j<k;j++,G++,W++)G===k&&(G=0),W===k&&(W=0),z[j]=F(C[j],C[G],C[W]);var X,Y,q=[],Z=z.concat();for(c=0,l=_.length;c<l;c++){for(s=_[c],X=[],j=0,G=(k=s.length)-1,W=j+1;j<k;j++,G++,W++)G===k&&(G=0),W===k&&(W=0),X[j]=F(s[j],s[G],s[W]);q.push(X),Z=Z.concat(X)}for(P=0;P<y;P++){for(B=P/y,I=g*Math.cos(B*Math.PI/2),H=v*Math.sin(B*Math.PI/2),j=0,k=C.length;j<k;j++)Q((O=L(C[j],z[j],H)).x,O.y,-I);for(c=0,l=_.length;c<l;c++)for(s=_[c],X=q[c],j=0,k=s.length;j<k;j++)Q((O=L(s[j],X[j],H)).x,O.y,-I)}for(H=v,j=0;j<N;j++)O=E?L(A[j],Z[j],H):A[j],T?(o.copy(r.normals[0]).multiplyScalar(O.x),n.copy(r.binormals[0]).multiplyScalar(O.y),a.copy(i[0]).add(o).add(n),Q(a.x,a.y,a.z)):Q(O.x,O.y,0);for(Y=1;Y<=b;Y++)for(j=0;j<N;j++)O=E?L(A[j],Z[j],H):A[j],T?(o.copy(r.normals[Y]).multiplyScalar(O.x),n.copy(r.binormals[Y]).multiplyScalar(O.y),a.copy(i[Y]).add(o).add(n),Q(a.x,a.y,a.z)):Q(O.x,O.y,m/b*Y);for(P=y-1;P>=0;P--){for(B=P/y,I=g*Math.cos(B*Math.PI/2),H=v*Math.sin(B*Math.PI/2),j=0,k=C.length;j<k;j++)Q((O=L(C[j],z[j],H)).x,O.y,m+I);for(c=0,l=_.length;c<l;c++)for(s=_[c],X=q[c],j=0,k=s.length;j<k;j++)O=L(s[j],X[j],H),T?Q(O.x,O.y+i[b-1].y,i[b-1].x+I):Q(O.x,O.y,m+I)}function J(e,t){var i,r;for(j=e.length;--j>=0;){i=j,(r=j-1)<0&&(r=e.length-1);var n=0,o=b+2*y;for(n=0;n<o;n++){var a=N*n,s=N*(n+1);$(t+i+a,t+r+a,t+r+s,t+i+s,e,n,o,i,r)}}}function Q(e,t,i){f.push(e),f.push(t),f.push(i)}function K(e,t,i){ee(e),ee(t),ee(i);var r=u.length/3,n=M.generateTopUV(S,u,r-3,r-2,r-1);te(n[0]),te(n[1]),te(n[2])}function $(e,t,i,r,n,o,a,s,c){ee(e),ee(t),ee(r),ee(t),ee(i),ee(r);var l=u.length/3,h=M.generateSideWallUV(S,u,l-6,l-3,l-2,l-1);te(h[0]),te(h[1]),te(h[3]),te(h[1]),te(h[2]),te(h[3])}function ee(e){d.push(u.length/3),u.push(f[3*e+0]),u.push(f[3*e+1]),u.push(f[3*e+2])}function te(e){p.push(e.x),p.push(e.y)}!function(){var e=u.length/3;if(E){var i=0,r=N*i;for(j=0;j<V;j++)K((U=D[j])[2]+r,U[1]+r,U[0]+r);for(r=N*(i=b+2*y),j=0;j<V;j++)K((U=D[j])[0]+r,U[1]+r,U[2]+r)}else{for(j=0;j<V;j++)K((U=D[j])[2],U[1],U[0]);for(j=0;j<V;j++)K((U=D[j])[0]+N*b,U[1]+N*b,U[2]+N*b)}S.addGroup(e,u.length/3-e,void 0!==t.material?t.material:0)}(),function(){var e=u.length/3,i=0;for(J(C,i),i+=C.length,c=0,l=_.length;c<l;c++)J(s=_[c],i),i+=s.length;S.addGroup(e,u.length/3-e,void 0!==t.extrudeMaterial?t.extrudeMaterial:1)}(),t.arrays||(this.setIndex(d),this.addAttribute("position",new xr(u,3)),this.addAttribute("uv",new xr(t.arrays.uv,2)))},Xn.WorldUVGenerator={generateTopUV:function(e,t,i,r,n){var o=t[3*i],a=t[3*i+1],s=t[3*r],c=t[3*r+1],l=t[3*n],h=t[3*n+1];return[new ut(o,a),new ut(s,c),new ut(l,h)]},generateSideWallUV:function(e,t,i,r,n,o){var a=t[3*i],s=t[3*i+1],c=t[3*i+2],l=t[3*r],h=t[3*r+1],u=t[3*r+2],d=t[3*n],p=t[3*n+1],f=t[3*n+2],m=t[3*o],g=t[3*o+1],v=t[3*o+2];return Math.abs(s-h)<.01?[new ut(a,1-c),new ut(l,1-u),new ut(d,1-f),new ut(m,1-v)]:[new ut(s,1-c),new ut(h,1-u),new ut(p,1-f),new ut(g,1-v)]}},qn.prototype=Object.create(ur.prototype),qn.prototype.constructor=qn,Zn.prototype=Object.create(Yn.prototype),Zn.prototype.constructor=Zn,Jn.prototype=Object.create(ur.prototype),Jn.prototype.constructor=Jn,Qn.prototype=Object.create(Mr.prototype),Qn.prototype.constructor=Qn,Kn.prototype=Object.create(ur.prototype),Kn.prototype.constructor=Kn,$n.prototype=Object.create(Mr.prototype),$n.prototype.constructor=$n,eo.prototype=Object.create(ur.prototype),eo.prototype.constructor=eo,to.prototype=Object.create(Mr.prototype),to.prototype.constructor=to,io.prototype=Object.create(ur.prototype),io.prototype.constructor=io,ro.prototype=Object.create(Mr.prototype),ro.prototype.constructor=ro,no.prototype=Object.create(Mr.prototype),no.prototype.constructor=no,oo.prototype=Object.create(ur.prototype),oo.prototype.constructor=oo,ao.prototype=Object.create(Mr.prototype),ao.prototype.constructor=ao,so.prototype=Object.create(oo.prototype),so.prototype.constructor=so,co.prototype=Object.create(ao.prototype),co.prototype.constructor=co,lo.prototype=Object.create(ur.prototype),lo.prototype.constructor=lo,ho.prototype=Object.create(Mr.prototype),ho.prototype.constructor=ho;var uo=Object.freeze({WireframeGeometry:Rn,ParametricGeometry:An,ParametricBufferGeometry:_n,TetrahedronGeometry:Ln,TetrahedronBufferGeometry:Pn,OctahedronGeometry:Hn,OctahedronBufferGeometry:Bn,IcosahedronGeometry:In,IcosahedronBufferGeometry:On,DodecahedronGeometry:Un,DodecahedronBufferGeometry:Nn,PolyhedronGeometry:Dn,PolyhedronBufferGeometry:Cn,TubeGeometry:Vn,TubeBufferGeometry:Fn,TorusKnotGeometry:zn,TorusKnotBufferGeometry:jn,TorusGeometry:kn,TorusBufferGeometry:Gn,TextGeometry:qn,TextBufferGeometry:Zn,SphereGeometry:Jn,SphereBufferGeometry:Qn,RingGeometry:Kn,RingBufferGeometry:$n,PlaneGeometry:Ar,PlaneBufferGeometry:_r,LatheGeometry:eo,LatheBufferGeometry:to,ShapeGeometry:io,ShapeBufferGeometry:ro,ExtrudeGeometry:Xn,ExtrudeBufferGeometry:Yn,EdgesGeometry:no,ConeGeometry:so,ConeBufferGeometry:co,CylinderGeometry:oo,CylinderBufferGeometry:ao,CircleGeometry:lo,CircleBufferGeometry:ho,BoxGeometry:Sr,BoxBufferGeometry:Rr});function po(e){Li.call(this),this.type="ShadowMaterial",this.color=new fi(0),this.opacity=1,this.lights=!0,this.transparent=!0,this.setValues(e)}function fo(e){Pi.call(this,e),this.type="RawShaderMaterial"}function mo(e){Li.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new fi(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new fi(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new ut(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function go(e){mo.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(e)}function vo(e){Li.call(this),this.type="MeshPhongMaterial",this.color=new fi(16777215),this.specular=new fi(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new fi(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new ut(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Q,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function yo(e){vo.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(e)}function Eo(e){Li.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new ut(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function xo(e){Li.call(this),this.type="MeshLambertMaterial",this.color=new fi(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new fi(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Q,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function bo(e){gn.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}po.prototype=Object.create(Li.prototype),po.prototype.constructor=po,po.prototype.isShadowMaterial=!0,fo.prototype=Object.create(Pi.prototype),fo.prototype.constructor=fo,fo.prototype.isRawShaderMaterial=!0,mo.prototype=Object.create(Li.prototype),mo.prototype.constructor=mo,mo.prototype.isMeshStandardMaterial=!0,mo.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},go.prototype=Object.create(mo.prototype),go.prototype.constructor=go,go.prototype.isMeshPhysicalMaterial=!0,go.prototype.copy=function(e){return mo.prototype.copy.call(this,e),this.defines={PHYSICAL:""},this.reflectivity=e.reflectivity,this.clearCoat=e.clearCoat,this.clearCoatRoughness=e.clearCoatRoughness,this},vo.prototype=Object.create(Li.prototype),vo.prototype.constructor=vo,vo.prototype.isMeshPhongMaterial=!0,vo.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},yo.prototype=Object.create(vo.prototype),yo.prototype.constructor=yo,yo.prototype.isMeshToonMaterial=!0,yo.prototype.copy=function(e){return vo.prototype.copy.call(this,e),this.gradientMap=e.gradientMap,this},Eo.prototype=Object.create(Li.prototype),Eo.prototype.constructor=Eo,Eo.prototype.isMeshNormalMaterial=!0,Eo.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},xo.prototype=Object.create(Li.prototype),xo.prototype.constructor=xo,xo.prototype.isMeshLambertMaterial=!0,xo.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},bo.prototype=Object.create(gn.prototype),bo.prototype.constructor=bo,bo.prototype.isLineDashedMaterial=!0,bo.prototype.copy=function(e){return gn.prototype.copy.call(this,e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this};var wo=Object.freeze({ShadowMaterial:po,SpriteMaterial:hn,RawShaderMaterial:fo,ShaderMaterial:Pi,PointsMaterial:xn,MeshPhysicalMaterial:go,MeshStandardMaterial:mo,MeshPhongMaterial:vo,MeshToonMaterial:yo,MeshNormalMaterial:Eo,MeshLambertMaterial:xo,MeshDepthMaterial:Hi,MeshDistanceMaterial:Bi,MeshBasicMaterial:Dr,LineDashedMaterial:bo,LineBasicMaterial:gn,Material:Li}),To={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};function Mo(e,t,i){var r=this,n=!1,o=0,a=0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){a++,!1===n&&void 0!==r.onStart&&r.onStart(e,o,a),n=!0},this.itemEnd=function(e){o++,void 0!==r.onProgress&&r.onProgress(e,o,a),o===a&&(n=!1,void 0!==r.onLoad&&r.onLoad())},this.itemError=function(e){void 0!==r.onError&&r.onError(e)}}var So=new Mo;function Ro(e){this.manager=void 0!==e?e:So}function Ao(e){this.manager=void 0!==e?e:So,this._parser=null}function _o(e){this.manager=void 0!==e?e:So,this._parser=null}function Do(e){this.manager=void 0!==e?e:So}function Co(e){this.manager=void 0!==e?e:So}function Lo(e){this.manager=void 0!==e?e:So}function Po(e,t){Zi.call(this),this.type="Light",this.color=new fi(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function Ho(e,t,i){Po.call(this,e,i),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(Zi.DefaultUp),this.updateMatrix(),this.groundColor=new fi(t)}function Bo(e){this.camera=e,this.bias=0,this.radius=1,this.mapSize=new ut(512,512),this.map=null,this.matrix=new St}function Io(){Bo.call(this,new Ki(50,1,.5,500))}function Oo(e,t,i,r,n,o){Po.call(this,e,t),this.type="SpotLight",this.position.copy(Zi.DefaultUp),this.updateMatrix(),this.target=new Zi,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==i?i:0,this.angle=void 0!==r?r:Math.PI/3,this.penumbra=void 0!==n?n:0,this.decay=void 0!==o?o:1,this.shadow=new Io}function Uo(e,t,i,r){Po.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==i?i:0,this.decay=void 0!==r?r:1,this.shadow=new Bo(new Ki(90,1,.5,500))}function No(){Bo.call(this,new Qi(-5,5,5,-5,.5,500))}function Vo(e,t){Po.call(this,e,t),this.type="DirectionalLight",this.position.copy(Zi.DefaultUp),this.updateMatrix(),this.target=new Zi,this.shadow=new No}function Fo(e,t){Po.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}function zo(e,t,i,r){Po.call(this,e,t),this.type="RectAreaLight",this.position.set(0,1,0),this.updateMatrix(),this.width=void 0!==i?i:10,this.height=void 0!==r?r:10}Object.assign(Ro.prototype,{load:function(e,t,i,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var n=this,o=To.get(e);if(void 0!==o)return n.manager.itemStart(e),setTimeout(function(){t&&t(o),n.manager.itemEnd(e)},0),o;var a=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(a){var s=a[1],c=!!a[2],l=a[3];l=window.decodeURIComponent(l),c&&(l=window.atob(l));try{var h,u=(this.responseType||"").toLowerCase();switch(u){case"arraybuffer":case"blob":h=new ArrayBuffer(l.length);for(var d=new Uint8Array(h),p=0;p<l.length;p++)d[p]=l.charCodeAt(p);"blob"===u&&(h=new Blob([h],{type:s}));break;case"document":var f=new DOMParser;h=f.parseFromString(l,s);break;case"json":h=JSON.parse(l);break;default:h=l}window.setTimeout(function(){t&&t(h),n.manager.itemEnd(e)},0)}catch(t){window.setTimeout(function(){r&&r(t),n.manager.itemEnd(e),n.manager.itemError(e)},0)}}else{var m=new XMLHttpRequest;for(var g in m.open("GET",e,!0),m.addEventListener("load",function(i){var o=i.target.response;To.add(e,o),200===this.status?(t&&t(o),n.manager.itemEnd(e)):0===this.status?(console.warn("THREE.FileLoader: HTTP Status 0 received."),t&&t(o),n.manager.itemEnd(e)):(r&&r(i),n.manager.itemEnd(e),n.manager.itemError(e))},!1),void 0!==i&&m.addEventListener("progress",function(e){i(e)},!1),m.addEventListener("error",function(t){r&&r(t),n.manager.itemEnd(e),n.manager.itemError(e)},!1),void 0!==this.responseType&&(m.responseType=this.responseType),void 0!==this.withCredentials&&(m.withCredentials=this.withCredentials),m.overrideMimeType&&m.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)m.setRequestHeader(g,this.requestHeader[g]);m.send(null)}return n.manager.itemStart(e),m},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),Object.assign(Ao.prototype,{load:function(e,t,i,r){var n=this,o=[],a=new Mn;a.image=o;var s=new Ro(this.manager);function c(c){s.load(e[c],function(e){var i=n._parser(e,!0);o[c]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},6===(l+=1)&&(1===i.mipmapCount&&(a.minFilter=ye),a.format=i.format,a.needsUpdate=!0,t&&t(a))},i,r)}if(s.setPath(this.path),s.setResponseType("arraybuffer"),Array.isArray(e))for(var l=0,h=0,u=e.length;h<u;++h)c(h);else s.load(e,function(e){var i=n._parser(e,!0);if(i.isCubemap)for(var r=i.mipmaps.length/i.mipmapCount,s=0;s<r;s++){o[s]={mipmaps:[]};for(var c=0;c<i.mipmapCount;c++)o[s].mipmaps.push(i.mipmaps[s*i.mipmapCount+c]),o[s].format=i.format,o[s].width=i.width,o[s].height=i.height}else a.image.width=i.width,a.image.height=i.height,a.mipmaps=i.mipmaps;1===i.mipmapCount&&(a.minFilter=ye),a.format=i.format,a.needsUpdate=!0,t&&t(a)},i,r);return a},setPath:function(e){return this.path=e,this}}),Object.assign(_o.prototype,{load:function(e,t,i,r){var n=this,o=new Rt,a=new Ro(this.manager);return a.setResponseType("arraybuffer"),a.load(e,function(e){var i=n._parser(e);i&&(void 0!==i.image?o.image=i.image:void 0!==i.data&&(o.image.width=i.width,o.image.height=i.height,o.image.data=i.data),o.wrapS=void 0!==i.wrapS?i.wrapS:pe,o.wrapT=void 0!==i.wrapT?i.wrapT:pe,o.magFilter=void 0!==i.magFilter?i.magFilter:ye,o.minFilter=void 0!==i.minFilter?i.minFilter:xe,o.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.format&&(o.format=i.format),void 0!==i.type&&(o.type=i.type),void 0!==i.mipmaps&&(o.mipmaps=i.mipmaps),1===i.mipmapCount&&(o.minFilter=ye),o.needsUpdate=!0,t&&t(o,i))},i,r),o}}),Object.assign(Do.prototype,{crossOrigin:"Anonymous",load:function(e,t,i,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var n=this,o=To.get(e);if(void 0!==o)return n.manager.itemStart(e),setTimeout(function(){t&&t(o),n.manager.itemEnd(e)},0),o;var a=document.createElementNS("http://www.w3.org/1999/xhtml","img");return a.addEventListener("load",function(){To.add(e,this),t&&t(this),n.manager.itemEnd(e)},!1),a.addEventListener("error",function(t){r&&r(t),n.manager.itemEnd(e),n.manager.itemError(e)},!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),n.manager.itemStart(e),a.src=e,a},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(Co.prototype,{crossOrigin:"Anonymous",load:function(e,t,i,r){var n=new At,o=new Do(this.manager);o.setCrossOrigin(this.crossOrigin),o.setPath(this.path);var a=0;function s(i){o.load(e[i],function(e){n.images[i]=e,6===++a&&(n.needsUpdate=!0,t&&t(n))},void 0,r)}for(var c=0;c<e.length;++c)s(c);return n},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(Lo.prototype,{crossOrigin:"Anonymous",load:function(e,t,i,r){var n=new Do(this.manager);n.setCrossOrigin(this.crossOrigin),n.setPath(this.path);var o=new Et;return o.image=n.load(e,function(){var i=e.search(/\.(jpg|jpeg)$/)>0||0===e.search(/^data\:image\/jpeg/);o.format=i?Be:Ie,o.needsUpdate=!0,void 0!==t&&t(o)},i,r),o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Po.prototype=Object.assign(Object.create(Zi.prototype),{constructor:Po,isLight:!0,copy:function(e){return Zi.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},toJSON:function(e){var t=Zi.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),Ho.prototype=Object.assign(Object.create(Po.prototype),{constructor:Ho,isHemisphereLight:!0,copy:function(e){return Po.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}),Object.assign(Bo.prototype,{copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var e={};return 0!==this.bias&&(e.bias=this.bias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),Io.prototype=Object.assign(Object.create(Bo.prototype),{constructor:Io,isSpotLightShadow:!0,update:function(e){var t=this.camera,i=2*ht.RAD2DEG*e.angle,r=this.mapSize.width/this.mapSize.height,n=e.distance||t.far;i===t.fov&&r===t.aspect&&n===t.far||(t.fov=i,t.aspect=r,t.far=n,t.updateProjectionMatrix())}}),Oo.prototype=Object.assign(Object.create(Po.prototype),{constructor:Oo,isSpotLight:!0,copy:function(e){return Po.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),Uo.prototype=Object.assign(Object.create(Po.prototype),{constructor:Uo,isPointLight:!0,copy:function(e){return Po.prototype.copy.call(this,e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}),No.prototype=Object.assign(Object.create(Bo.prototype),{constructor:No}),Vo.prototype=Object.assign(Object.create(Po.prototype),{constructor:Vo,isDirectionalLight:!0,copy:function(e){return Po.prototype.copy.call(this,e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),Fo.prototype=Object.assign(Object.create(Po.prototype),{constructor:Fo,isAmbientLight:!0}),zo.prototype=Object.assign(Object.create(Po.prototype),{constructor:zo,isRectAreaLight:!0,copy:function(e){return Po.prototype.copy.call(this,e),this.width=e.width,this.height=e.height,this},toJSON:function(e){var t=Po.prototype.toJSON.call(this,e);return t.object.width=this.width,t.object.height=this.height,t}});var jo,ko={arraySlice:function(e,t,i){return ko.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==i?i:e.length)):e.slice(t,i)},convertArray:function(e,t,i){return!e||!i&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){for(var t=e.length,i=new Array(t),r=0;r!==t;++r)i[r]=r;return i.sort(function(t,i){return e[t]-e[i]}),i},sortedArray:function(e,t,i){for(var r=e.length,n=new e.constructor(r),o=0,a=0;a!==r;++o)for(var s=i[o]*t,c=0;c!==t;++c)n[a++]=e[s+c];return n},flattenJSON:function(e,t,i,r){for(var n=1,o=e[0];void 0!==o&&void 0===o[r];)o=e[n++];if(void 0!==o){var a=o[r];if(void 0!==a)if(Array.isArray(a))do{void 0!==(a=o[r])&&(t.push(o.time),i.push.apply(i,a)),o=e[n++]}while(void 0!==o);else if(void 0!==a.toArray)do{void 0!==(a=o[r])&&(t.push(o.time),a.toArray(i,i.length)),o=e[n++]}while(void 0!==o);else do{void 0!==(a=o[r])&&(t.push(o.time),i.push(a)),o=e[n++]}while(void 0!==o)}}};function Go(e,t,i,r){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==r?r:new t.constructor(i),this.sampleValues=t,this.valueSize=i}function Wo(e,t,i,r){Go.call(this,e,t,i,r),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function Xo(e,t,i,r){Go.call(this,e,t,i,r)}function Yo(e,t,i,r){Go.call(this,e,t,i,r)}function qo(e,t,i,r){if(void 0===e)throw new Error("track name is undefined");if(void 0===t||0===t.length)throw new Error("no keyframes in track named "+e);this.name=e,this.times=ko.convertArray(t,this.TimeBufferType),this.values=ko.convertArray(i,this.ValueBufferType),this.setInterpolation(r||this.DefaultInterpolation),this.validate(),this.optimize()}function Zo(e,t,i,r){qo.call(this,e,t,i,r)}function Jo(e,t,i,r){Go.call(this,e,t,i,r)}function Qo(e,t,i,r){qo.call(this,e,t,i,r)}function Ko(e,t,i,r){qo.call(this,e,t,i,r)}function $o(e,t,i,r){qo.call(this,e,t,i,r)}function ea(e,t,i){qo.call(this,e,t,i)}function ta(e,t,i,r){qo.call(this,e,t,i,r)}function ia(e,t,i,r){qo.apply(this,arguments)}function ra(e,t,i){this.name=e,this.tracks=i,this.duration=void 0!==t?t:-1,this.uuid=ht.generateUUID(),this.duration<0&&this.resetDuration(),this.optimize()}function na(e){this.manager=void 0!==e?e:So,this.textures={}}function oa(e){this.manager=void 0!==e?e:So}Object.assign(Go.prototype,{evaluate:function(e){var t=this.parameterPositions,i=this._cachedIndex,r=t[i],n=t[i-1];e:{t:{var o;i:{r:if(!(e<r)){for(var a=i+2;;){if(void 0===r){if(e<n)break r;return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,e,n)}if(i===a)break;if(n=r,e<(r=t[++i]))break t}o=t.length;break i}if(e>=n)break e;var s=t[1];e<s&&(i=2,n=s);for(a=i-2;;){if(void 0===n)return this._cachedIndex=0,this.beforeStart_(0,e,r);if(i===a)break;if(r=n,e>=(n=t[--i-1]))break t}o=i,i=0}for(;i<o;){var c=i+o>>>1;e<t[c]?o=c:i=c+1}if(r=t[i],void 0===(n=t[i-1]))return this._cachedIndex=0,this.beforeStart_(0,e,r);if(void 0===r)return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,n,e)}this._cachedIndex=i,this.intervalChanged_(i,n,r)}return this.interpolate_(i,n,e,r)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,i=this.sampleValues,r=this.valueSize,n=e*r,o=0;o!==r;++o)t[o]=i[n+o];return t},interpolate_:function(e,t,i,r){throw new Error("call to abstract method")},intervalChanged_:function(e,t,i){}}),Object.assign(Go.prototype,{beforeStart_:Go.prototype.copySampleValue_,afterEnd_:Go.prototype.copySampleValue_}),Wo.prototype=Object.assign(Object.create(Go.prototype),{constructor:Wo,DefaultSettings_:{endingStart:Qe,endingEnd:Qe},intervalChanged_:function(e,t,i){var r=this.parameterPositions,n=e-2,o=e+1,a=r[n],s=r[o];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:n=e,a=2*t-i;break;case 2402:a=t+r[n=r.length-2]-r[n+1];break;default:n=e,a=i}if(void 0===s)switch(this.getSettings_().endingEnd){case 2401:o=e,s=2*i-t;break;case 2402:o=1,s=i+r[1]-r[0];break;default:o=e-1,s=t}var c=.5*(i-t),l=this.valueSize;this._weightPrev=c/(t-a),this._weightNext=c/(s-i),this._offsetPrev=n*l,this._offsetNext=o*l},interpolate_:function(e,t,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,c=s-a,l=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(i-t)/(r-t),f=p*p,m=f*p,g=-u*m+2*u*f-u*p,v=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*p+1,y=(-1-d)*m+(1.5+d)*f+.5*p,E=d*m-d*f,x=0;x!==a;++x)n[x]=g*o[l+x]+v*o[c+x]+y*o[s+x]+E*o[h+x];return n}}),Xo.prototype=Object.assign(Object.create(Go.prototype),{constructor:Xo,interpolate_:function(e,t,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,c=s-a,l=(i-t)/(r-t),h=1-l,u=0;u!==a;++u)n[u]=o[c+u]*h+o[s+u]*l;return n}}),Yo.prototype=Object.assign(Object.create(Go.prototype),{constructor:Yo,interpolate_:function(e,t,i,r){return this.copySampleValue_(e-1)}}),jo={TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:2301,InterpolantFactoryMethodDiscrete:function(e){return new Yo(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodLinear:function(e){return new Xo(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:function(e){return new Wo(this.times,this.values,this.getValueSize(),e)},setInterpolation:function(e){var t;switch(e){case 2300:t=this.InterpolantFactoryMethodDiscrete;break;case 2301:t=this.InterpolantFactoryMethodLinear;break;case 2302:t=this.InterpolantFactoryMethodSmooth}if(void 0!==t)this.createInterpolant=t;else{var i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(i);this.setInterpolation(this.DefaultInterpolation)}console.warn("THREE.KeyframeTrackPrototype:",i)}},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(e){if(0!==e)for(var t=this.times,i=0,r=t.length;i!==r;++i)t[i]+=e;return this},scale:function(e){if(1!==e)for(var t=this.times,i=0,r=t.length;i!==r;++i)t[i]*=e;return this},trim:function(e,t){for(var i=this.times,r=i.length,n=0,o=r-1;n!==r&&i[n]<e;)++n;for(;-1!==o&&i[o]>t;)--o;if(++o,0!==n||o!==r){n>=o&&(n=(o=Math.max(o,1))-1);var a=this.getValueSize();this.times=ko.arraySlice(i,n,o),this.values=ko.arraySlice(this.values,n*a,o*a)}return this},validate:function(){var e=!0,t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrackPrototype: Invalid value size in track.",this),e=!1);var i=this.times,r=this.values,n=i.length;0===n&&(console.error("THREE.KeyframeTrackPrototype: Track is empty.",this),e=!1);for(var o=null,a=0;a!==n;a++){var s=i[a];if("number"==typeof s&&isNaN(s)){console.error("THREE.KeyframeTrackPrototype: Time is not a valid number.",this,a,s),e=!1;break}if(null!==o&&o>s){console.error("THREE.KeyframeTrackPrototype: Out of order keys.",this,a,s,o),e=!1;break}o=s}if(void 0!==r&&ko.isTypedArray(r)){a=0;for(var c=r.length;a!==c;++a){var l=r[a];if(isNaN(l)){console.error("THREE.KeyframeTrackPrototype: Value is not a valid number.",this,a,l),e=!1;break}}}return e},optimize:function(){for(var e=this.times,t=this.values,i=this.getValueSize(),r=2302===this.getInterpolation(),n=1,o=e.length-1,a=1;a<o;++a){var s=!1,c=e[a];if(c!==e[a+1]&&(1!==a||c!==c[0]))if(r)s=!0;else for(var l=a*i,h=l-i,u=l+i,d=0;d!==i;++d){var p=t[l+d];if(p!==t[h+d]||p!==t[u+d]){s=!0;break}}if(s){if(a!==n){e[n]=e[a];var f=a*i,m=n*i;for(d=0;d!==i;++d)t[m+d]=t[f+d]}++n}}if(o>0){e[n]=e[o];for(f=o*i,m=n*i,d=0;d!==i;++d)t[m+d]=t[f+d];++n}return n!==e.length&&(this.times=ko.arraySlice(e,0,n),this.values=ko.arraySlice(t,0,n*i)),this}},Zo.prototype=Object.assign(Object.create(jo),{constructor:Zo,ValueTypeName:"vector"}),Jo.prototype=Object.assign(Object.create(Go.prototype),{constructor:Jo,interpolate_:function(e,t,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,c=(i-t)/(r-t),l=s+a;s!==l;s+=4)Tt.slerpFlat(n,0,o,s-a,o,s,c);return n}}),Qo.prototype=Object.assign(Object.create(jo),{constructor:Qo,ValueTypeName:"quaternion",DefaultInterpolation:2301,InterpolantFactoryMethodLinear:function(e){return new Jo(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:void 0}),Ko.prototype=Object.assign(Object.create(jo),{constructor:Ko,ValueTypeName:"number"}),$o.prototype=Object.assign(Object.create(jo),{constructor:$o,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),ea.prototype=Object.assign(Object.create(jo),{constructor:ea,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),ta.prototype=Object.assign(Object.create(jo),{constructor:ta,ValueTypeName:"color"}),ia.prototype=jo,jo.constructor=ia,Object.assign(ia,{parse:function(e){if(void 0===e.type)throw new Error("track type undefined, can not parse");var t=ia._getTrackTypeForValueTypeName(e.type);if(void 0===e.times){var i=[],r=[];ko.flattenJSON(e.keys,i,r,"value"),e.times=i,e.values=r}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)},toJSON:function(e){var t,i=e.constructor;if(void 0!==i.toJSON)t=i.toJSON(e);else{t={name:e.name,times:ko.convertArray(e.times,Array),values:ko.convertArray(e.values,Array)};var r=e.getInterpolation();r!==e.DefaultInterpolation&&(t.interpolation=r)}return t.type=e.ValueTypeName,t},_getTrackTypeForValueTypeName:function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Ko;case"vector":case"vector2":case"vector3":case"vector4":return Zo;case"color":return ta;case"quaternion":return Qo;case"bool":case"boolean":return ea;case"string":return $o}throw new Error("Unsupported typeName: "+e)}}),Object.assign(ra,{parse:function(e){for(var t=[],i=e.tracks,r=1/(e.fps||1),n=0,o=i.length;n!==o;++n)t.push(ia.parse(i[n]).scale(r));return new ra(e.name,e.duration,t)},toJSON:function(e){for(var t=[],i=e.tracks,r={name:e.name,duration:e.duration,tracks:t},n=0,o=i.length;n!==o;++n)t.push(ia.toJSON(i[n]));return r},CreateFromMorphTargetSequence:function(e,t,i,r){for(var n=t.length,o=[],a=0;a<n;a++){var s=[],c=[];s.push((a+n-1)%n,a,(a+1)%n),c.push(0,1,0);var l=ko.getKeyframeOrder(s);s=ko.sortedArray(s,1,l),c=ko.sortedArray(c,1,l),r||0!==s[0]||(s.push(n),c.push(c[0])),o.push(new Ko(".morphTargetInfluences["+t[a].name+"]",s,c).scale(1/i))}return new ra(e,-1,o)},findByName:function(e,t){var i=e;if(!Array.isArray(e)){var r=e;i=r.geometry&&r.geometry.animations||r.animations}for(var n=0;n<i.length;n++)if(i[n].name===t)return i[n];return null},CreateClipsFromMorphTargetSequences:function(e,t,i){for(var r={},n=/^([\w-]*?)([\d]+)$/,o=0,a=e.length;o<a;o++){var s=e[o],c=s.name.match(n);if(c&&c.length>1){var l=r[u=c[1]];l||(r[u]=l=[]),l.push(s)}}var h=[];for(var u in r)h.push(ra.CreateFromMorphTargetSequence(u,r[u],t,i));return h},parseAnimation:function(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;for(var i=function(e,t,i,r,n){if(0!==i.length){var o=[],a=[];ko.flattenJSON(i,o,a,r),0!==o.length&&n.push(new e(t,o,a))}},r=[],n=e.name||"default",o=e.length||-1,a=e.fps||30,s=e.hierarchy||[],c=0;c<s.length;c++){var l=s[c].keys;if(l&&0!==l.length)if(l[0].morphTargets){for(var h={},u=0;u<l.length;u++)if(l[u].morphTargets)for(var d=0;d<l[u].morphTargets.length;d++)h[l[u].morphTargets[d]]=-1;for(var p in h){var f=[],m=[];for(d=0;d!==l[u].morphTargets.length;++d){var g=l[u];f.push(g.time),m.push(g.morphTarget===p?1:0)}r.push(new Ko(".morphTargetInfluence["+p+"]",f,m))}o=h.length*(a||1)}else{var v=".bones["+t[c].name+"]";i(Zo,v+".position",l,"pos",r),i(Qo,v+".quaternion",l,"rot",r),i(Zo,v+".scale",l,"scl",r)}}return 0===r.length?null:new ra(n,o,r)}}),Object.assign(ra.prototype,{resetDuration:function(){for(var e=0,t=0,i=this.tracks.length;t!==i;++t){var r=this.tracks[t];e=Math.max(e,r.times[r.times.length-1])}this.duration=e},trim:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this},optimize:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}}),Object.assign(na.prototype,{load:function(e,t,i,r){var n=this;new Ro(n.manager).load(e,function(e){t(n.parse(JSON.parse(e)))},i,r)},setTextures:function(e){this.textures=e},parse:function(e){var t=this.textures;function i(e){return void 0===t[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),t[e]}var r=new wo[e.type];if(void 0!==e.uuid&&(r.uuid=e.uuid),void 0!==e.name&&(r.name=e.name),void 0!==e.color&&r.color.setHex(e.color),void 0!==e.roughness&&(r.roughness=e.roughness),void 0!==e.metalness&&(r.metalness=e.metalness),void 0!==e.emissive&&r.emissive.setHex(e.emissive),void 0!==e.specular&&r.specular.setHex(e.specular),void 0!==e.shininess&&(r.shininess=e.shininess),void 0!==e.clearCoat&&(r.clearCoat=e.clearCoat),void 0!==e.clearCoatRoughness&&(r.clearCoatRoughness=e.clearCoatRoughness),void 0!==e.uniforms&&(r.uniforms=e.uniforms),void 0!==e.vertexShader&&(r.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(r.fragmentShader=e.fragmentShader),void 0!==e.vertexColors&&(r.vertexColors=e.vertexColors),void 0!==e.fog&&(r.fog=e.fog),void 0!==e.flatShading&&(r.flatShading=e.flatShading),void 0!==e.blending&&(r.blending=e.blending),void 0!==e.side&&(r.side=e.side),void 0!==e.opacity&&(r.opacity=e.opacity),void 0!==e.transparent&&(r.transparent=e.transparent),void 0!==e.alphaTest&&(r.alphaTest=e.alphaTest),void 0!==e.depthTest&&(r.depthTest=e.depthTest),void 0!==e.depthWrite&&(r.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(r.colorWrite=e.colorWrite),void 0!==e.wireframe&&(r.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(r.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(r.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(r.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.skinning&&(r.skinning=e.skinning),void 0!==e.morphTargets&&(r.morphTargets=e.morphTargets),void 0!==e.dithering&&(r.dithering=e.dithering),void 0!==e.visible&&(r.visible=e.visible),void 0!==e.userData&&(r.userData=e.userData),void 0!==e.shading&&(r.flatShading=1===e.shading),void 0!==e.size&&(r.size=e.size),void 0!==e.sizeAttenuation&&(r.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(r.map=i(e.map)),void 0!==e.alphaMap&&(r.alphaMap=i(e.alphaMap),r.transparent=!0),void 0!==e.bumpMap&&(r.bumpMap=i(e.bumpMap)),void 0!==e.bumpScale&&(r.bumpScale=e.bumpScale),void 0!==e.normalMap&&(r.normalMap=i(e.normalMap)),void 0!==e.normalScale){var n=e.normalScale;!1===Array.isArray(n)&&(n=[n,n]),r.normalScale=(new ut).fromArray(n)}return void 0!==e.displacementMap&&(r.displacementMap=i(e.displacementMap)),void 0!==e.displacementScale&&(r.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(r.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(r.roughnessMap=i(e.roughnessMap)),void 0!==e.metalnessMap&&(r.metalnessMap=i(e.metalnessMap)),void 0!==e.emissiveMap&&(r.emissiveMap=i(e.emissiveMap)),void 0!==e.emissiveIntensity&&(r.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(r.specularMap=i(e.specularMap)),void 0!==e.envMap&&(r.envMap=i(e.envMap)),void 0!==e.reflectivity&&(r.reflectivity=e.reflectivity),void 0!==e.lightMap&&(r.lightMap=i(e.lightMap)),void 0!==e.lightMapIntensity&&(r.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(r.aoMap=i(e.aoMap)),void 0!==e.aoMapIntensity&&(r.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(r.gradientMap=i(e.gradientMap)),r}}),Object.assign(oa.prototype,{load:function(e,t,i,r){var n=this;new Ro(n.manager).load(e,function(e){t(n.parse(JSON.parse(e)))},i,r)},parse:function(e){var t=new Mr,i=e.data.index;if(void 0!==i){var r=new ha[i.type](i.array);t.setIndex(new dr(r,1))}var n=e.data.attributes;for(var o in n){var a=n[o];r=new ha[a.type](a.array);t.addAttribute(o,new dr(r,a.itemSize,a.normalized))}var s=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==s)for(var c=0,l=s.length;c!==l;++c){var h=s[c];t.addGroup(h.start,h.count,h.materialIndex)}var u=e.data.boundingSphere;if(void 0!==u){var d=new Mt;void 0!==u.center&&d.fromArray(u.center),t.boundingSphere=new Oi(d,u.radius)}return t}});var aa,sa,ca,la,ha={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:"undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function ua(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}}function da(e){"boolean"==typeof e&&(console.warn("THREE.JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:So,this.withCredentials=!1}function pa(e){this.manager=void 0!==e?e:So,this.texturePath=""}ua.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,i=0,r=t.length;i<r;i+=2){var n=t[i],o=t[i+1];if(n.test(e))return o}return null}},Object.assign(ua.prototype,{crossOrigin:void 0,extractUrlBase:function(e){var t=e.split("/");return 1===t.length?"./":(t.pop(),t.join("/")+"/")},initMaterials:function(e,t,i){for(var r=[],n=0;n<e.length;++n)r[n]=this.createMaterial(e[n],t,i);return r},createMaterial:(aa={NoBlending:b,NormalBlending:w,AdditiveBlending:T,SubtractiveBlending:M,MultiplyBlending:S,CustomBlending:R},sa=new fi,ca=new Lo,la=new na,function(e,t,i){var r={};function n(e,n,o,a,s){var c,l=t+e,h=ua.Handlers.get(l);null!==h?c=h.load(l):(ca.setCrossOrigin(i),c=ca.load(l)),void 0!==n&&(c.repeat.fromArray(n),1!==n[0]&&(c.wrapS=de),1!==n[1]&&(c.wrapT=de)),void 0!==o&&c.offset.fromArray(o),void 0!==a&&("repeat"===a[0]&&(c.wrapS=de),"mirror"===a[0]&&(c.wrapS=fe),"repeat"===a[1]&&(c.wrapT=de),"mirror"===a[1]&&(c.wrapT=fe)),void 0!==s&&(c.anisotropy=s);var u=ht.generateUUID();return r[u]=c,u}var o={uuid:ht.generateUUID(),type:"MeshLambertMaterial"};for(var a in e){var s=e[a];switch(a){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":o.name=s;break;case"blending":o.blending=aa[s];break;case"colorAmbient":case"mapAmbient":console.warn("THREE.Loader.createMaterial:",a,"is no longer supported.");break;case"colorDiffuse":o.color=sa.fromArray(s).getHex();break;case"colorSpecular":o.specular=sa.fromArray(s).getHex();break;case"colorEmissive":o.emissive=sa.fromArray(s).getHex();break;case"specularCoef":o.shininess=s;break;case"shading":"basic"===s.toLowerCase()&&(o.type="MeshBasicMaterial"),"phong"===s.toLowerCase()&&(o.type="MeshPhongMaterial"),"standard"===s.toLowerCase()&&(o.type="MeshStandardMaterial");break;case"mapDiffuse":o.map=n(s,e.mapDiffuseRepeat,e.mapDiffuseOffset,e.mapDiffuseWrap,e.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":o.emissiveMap=n(s,e.mapEmissiveRepeat,e.mapEmissiveOffset,e.mapEmissiveWrap,e.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":o.lightMap=n(s,e.mapLightRepeat,e.mapLightOffset,e.mapLightWrap,e.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":o.aoMap=n(s,e.mapAORepeat,e.mapAOOffset,e.mapAOWrap,e.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":o.bumpMap=n(s,e.mapBumpRepeat,e.mapBumpOffset,e.mapBumpWrap,e.mapBumpAnisotropy);break;case"mapBumpScale":o.bumpScale=s;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":o.normalMap=n(s,e.mapNormalRepeat,e.mapNormalOffset,e.mapNormalWrap,e.mapNormalAnisotropy);break;case"mapNormalFactor":o.normalScale=[s,s];break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":o.specularMap=n(s,e.mapSpecularRepeat,e.mapSpecularOffset,e.mapSpecularWrap,e.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":o.metalnessMap=n(s,e.mapMetalnessRepeat,e.mapMetalnessOffset,e.mapMetalnessWrap,e.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":o.roughnessMap=n(s,e.mapRoughnessRepeat,e.mapRoughnessOffset,e.mapRoughnessWrap,e.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":o.alphaMap=n(s,e.mapAlphaRepeat,e.mapAlphaOffset,e.mapAlphaWrap,e.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":o.side=g;break;case"doubleSided":o.side=v;break;case"transparency":console.warn("THREE.Loader.createMaterial: transparency has been renamed to opacity"),o.opacity=s;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":o[a]=s;break;case"vertexColors":!0===s&&(o.vertexColors=x),"face"===s&&(o.vertexColors=E);break;default:console.error("THREE.Loader.createMaterial: Unsupported",a,s)}}return"MeshBasicMaterial"===o.type&&delete o.emissive,"MeshPhongMaterial"!==o.type&&delete o.specular,o.opacity<1&&(o.transparent=!0),la.setTextures(r),la.parse(o)})}),Object.assign(da.prototype,{load:function(e,t,i,r){var n=this,o=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:ua.prototype.extractUrlBase(e),a=new Ro(this.manager);a.setWithCredentials(this.withCredentials),a.load(e,function(i){var r=JSON.parse(i),a=r.metadata;if(void 0!==a){var s=a.type;if(void 0!==s){if("object"===s.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.ObjectLoader instead.");if("scene"===s.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.SceneLoader instead.")}}var c=n.parse(r,o);t(c.geometry,c.materials)},i,r)},setTexturePath:function(e){this.texturePath=e},parse:function(){return function(e,t){void 0!==e.data&&(e=e.data),void 0!==e.scale?e.scale=1/e.scale:e.scale=1;var i=new ur;return function(e,t){function i(e,t){return e&1<<t}var r,n,o,a,s,c,l,h,u,d,p,f,m,g,v,y,E,x,b,w,T,M,S,R,A,_=e.faces,D=e.vertices,C=e.normals,L=e.colors,P=e.scale,H=0;if(void 0!==e.uvs){for(r=0;r<e.uvs.length;r++)e.uvs[r].length&&H++;for(r=0;r<H;r++)t.faceVertexUvs[r]=[]}for(a=0,s=D.length;a<s;)(x=new Mt).x=D[a++]*P,x.y=D[a++]*P,x.z=D[a++]*P,t.vertices.push(x);for(a=0,s=_.length;a<s;)if(p=i(d=_[a++],0),f=i(d,1),m=i(d,3),g=i(d,4),v=i(d,5),y=i(d,6),E=i(d,7),p){if((w=new $i).a=_[a],w.b=_[a+1],w.c=_[a+3],(T=new $i).a=_[a+1],T.b=_[a+2],T.c=_[a+3],a+=4,f&&(u=_[a++],w.materialIndex=u,T.materialIndex=u),o=t.faces.length,m)for(r=0;r<H;r++)for(R=e.uvs[r],t.faceVertexUvs[r][o]=[],t.faceVertexUvs[r][o+1]=[],n=0;n<4;n++)A=new ut(R[2*(h=_[a++])],R[2*h+1]),2!==n&&t.faceVertexUvs[r][o].push(A),0!==n&&t.faceVertexUvs[r][o+1].push(A);if(g&&(l=3*_[a++],w.normal.set(C[l++],C[l++],C[l]),T.normal.copy(w.normal)),v)for(r=0;r<4;r++)l=3*_[a++],S=new Mt(C[l++],C[l++],C[l]),2!==r&&w.vertexNormals.push(S),0!==r&&T.vertexNormals.push(S);if(y&&(M=L[c=_[a++]],w.color.setHex(M),T.color.setHex(M)),E)for(r=0;r<4;r++)M=L[c=_[a++]],2!==r&&w.vertexColors.push(new fi(M)),0!==r&&T.vertexColors.push(new fi(M));t.faces.push(w),t.faces.push(T)}else{if((b=new $i).a=_[a++],b.b=_[a++],b.c=_[a++],f&&(u=_[a++],b.materialIndex=u),o=t.faces.length,m)for(r=0;r<H;r++)for(R=e.uvs[r],t.faceVertexUvs[r][o]=[],n=0;n<3;n++)A=new ut(R[2*(h=_[a++])],R[2*h+1]),t.faceVertexUvs[r][o].push(A);if(g&&(l=3*_[a++],b.normal.set(C[l++],C[l++],C[l])),v)for(r=0;r<3;r++)l=3*_[a++],S=new Mt(C[l++],C[l++],C[l]),b.vertexNormals.push(S);if(y&&(c=_[a++],b.color.setHex(L[c])),E)for(r=0;r<3;r++)c=_[a++],b.vertexColors.push(new fi(L[c]));t.faces.push(b)}}(e,i),function(e,t){var i=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var r=0,n=e.skinWeights.length;r<n;r+=i){var o=e.skinWeights[r],a=i>1?e.skinWeights[r+1]:0,s=i>2?e.skinWeights[r+2]:0,c=i>3?e.skinWeights[r+3]:0;t.skinWeights.push(new xt(o,a,s,c))}if(e.skinIndices)for(r=0,n=e.skinIndices.length;r<n;r+=i){var l=e.skinIndices[r],h=i>1?e.skinIndices[r+1]:0,u=i>2?e.skinIndices[r+2]:0,d=i>3?e.skinIndices[r+3]:0;t.skinIndices.push(new xt(l,h,u,d))}t.bones=e.bones,t.bones&&t.bones.length>0&&(t.skinWeights.length!==t.skinIndices.length||t.skinIndices.length!==t.vertices.length)&&console.warn("When skinning, number of vertices ("+t.vertices.length+"), skinIndices ("+t.skinIndices.length+"), and skinWeights ("+t.skinWeights.length+") should match.")}(e,i),function(e,t){var i=e.scale;if(void 0!==e.morphTargets)for(var r=0,n=e.morphTargets.length;r<n;r++){t.morphTargets[r]={},t.morphTargets[r].name=e.morphTargets[r].name,t.morphTargets[r].vertices=[];for(var o=t.morphTargets[r].vertices,a=e.morphTargets[r].vertices,s=0,c=a.length;s<c;s+=3){var l=new Mt;l.x=a[s]*i,l.y=a[s+1]*i,l.z=a[s+2]*i,o.push(l)}}if(void 0!==e.morphColors&&e.morphColors.length>0){console.warn('THREE.JSONLoader: "morphColors" no longer supported. Using them as face colors.');var h=t.faces,u=e.morphColors[0].colors;for(r=0,n=h.length;r<n;r++)h[r].color.fromArray(u,3*r)}}(e,i),function(e,t){var i=[],r=[];void 0!==e.animation&&r.push(e.animation),void 0!==e.animations&&(e.animations.length?r=r.concat(e.animations):r.push(e.animations));for(var n=0;n<r.length;n++){var o=ra.parseAnimation(r[n],t.bones);o&&i.push(o)}if(t.morphTargets){var a=ra.CreateClipsFromMorphTargetSequences(t.morphTargets,10);i=i.concat(a)}i.length>0&&(t.animations=i)}(e,i),i.computeFaceNormals(),i.computeBoundingSphere(),void 0===e.materials||0===e.materials.length?{geometry:i}:{geometry:i,materials:ua.prototype.initMaterials(e.materials,t,this.crossOrigin)}}}()}),Object.assign(pa.prototype,{load:function(e,t,i,r){""===this.texturePath&&(this.texturePath=e.substring(0,e.lastIndexOf("/")+1));var n=this;new Ro(n.manager).load(e,function(i){var o=null;try{o=JSON.parse(i)}catch(t){return void 0!==r&&r(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}var a=o.metadata;void 0!==a&&void 0!==a.type&&"geometry"!==a.type.toLowerCase()?n.parse(o,t):console.error("THREE.ObjectLoader: Can't load "+e+". Use THREE.JSONLoader instead.")},i,r)},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){var i=this.parseGeometries(e.geometries),r=this.parseImages(e.images,function(){void 0!==t&&t(a)}),n=this.parseTextures(e.textures,r),o=this.parseMaterials(e.materials,n),a=this.parseObject(e.object,i,o);return e.animations&&(a.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(a),a},parseGeometries:function(e){var t={};if(void 0!==e)for(var i=new da,r=new oa,n=0,o=e.length;n<o;n++){var a,s=e[n];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new uo[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":a=new uo[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":a=new uo[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":a=new uo[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":a=new uo[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":a=new uo[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"IcosahedronGeometry":case"OctahedronGeometry":case"TetrahedronGeometry":a=new uo[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":a=new uo[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":a=new uo[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":a=new uo[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"LatheGeometry":case"LatheBufferGeometry":a=new uo[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"BufferGeometry":a=r.parse(s);break;case"Geometry":a=i.parse(s,this.texturePath).geometry;break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t[s.uuid]=a}return t},parseMaterials:function(e,t){var i={};if(void 0!==e){var r=new na;r.setTextures(t);for(var n=0,o=e.length;n<o;n++){var a=e[n];if("MultiMaterial"===a.type){for(var s=[],c=0;c<a.materials.length;c++)s.push(r.parse(a.materials[c]));i[a.uuid]=s}else i[a.uuid]=r.parse(a)}}return i},parseAnimations:function(e){for(var t=[],i=0;i<e.length;i++){var r=ra.parse(e[i]);t.push(r)}return t},parseImages:function(e,t){var i=this,r={};function n(e){return i.manager.itemStart(e),o.load(e,function(){i.manager.itemEnd(e)},void 0,function(){i.manager.itemEnd(e),i.manager.itemError(e)})}if(void 0!==e&&e.length>0){var o=new Do(new Mo(t));o.setCrossOrigin(this.crossOrigin);for(var a=0,s=e.length;a<s;a++){var c=e[a],l=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(c.url)?c.url:i.texturePath+c.url;r[c.uuid]=n(l)}}return r},parseTextures:function(e,t){function i(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var r={};if(void 0!==e)for(var n=0,o=e.length;n<o;n++){var a=e[n];void 0===a.image&&console.warn('THREE.ObjectLoader: No "image" specified for',a.uuid),void 0===t[a.image]&&console.warn("THREE.ObjectLoader: Undefined image",a.image);var s=new Et(t[a.image]);s.needsUpdate=!0,s.uuid=a.uuid,void 0!==a.name&&(s.name=a.name),void 0!==a.mapping&&(s.mapping=i(a.mapping,fa)),void 0!==a.offset&&s.offset.fromArray(a.offset),void 0!==a.repeat&&s.repeat.fromArray(a.repeat),void 0!==a.wrap&&(s.wrapS=i(a.wrap[0],ma),s.wrapT=i(a.wrap[1],ma)),void 0!==a.minFilter&&(s.minFilter=i(a.minFilter,ga)),void 0!==a.magFilter&&(s.magFilter=i(a.magFilter,ga)),void 0!==a.anisotropy&&(s.anisotropy=a.anisotropy),void 0!==a.flipY&&(s.flipY=a.flipY),r[a.uuid]=s}return r},parseObject:function(){var e=new St;return function(t,i,r){var n;function o(e){return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),i[e]}function a(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,n=e.length;i<n;i++){var o=e[i];void 0===r[o]&&console.warn("THREE.ObjectLoader: Undefined material",o),t.push(r[o])}return t}return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),r[e]}}switch(t.type){case"Scene":n=new cn,void 0!==t.background&&Number.isInteger(t.background)&&(n.background=new fi(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?n.fog=new sn(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(n.fog=new an(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":n=new Ki(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(n.focus=t.focus),void 0!==t.zoom&&(n.zoom=t.zoom),void 0!==t.filmGauge&&(n.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(n.filmOffset=t.filmOffset),void 0!==t.view&&(n.view=Object.assign({},t.view));break;case"OrthographicCamera":n=new Qi(t.left,t.right,t.top,t.bottom,t.near,t.far);break;case"AmbientLight":n=new Fo(t.color,t.intensity);break;case"DirectionalLight":n=new Vo(t.color,t.intensity);break;case"PointLight":n=new Uo(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":n=new zo(t.color,t.intensity,t.width,t.height);break;case"SpotLight":n=new Oo(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":n=new Ho(t.color,t.groundColor,t.intensity);break;case"SkinnedMesh":console.warn("THREE.ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":var s=o(t.geometry),c=a(t.material);n=s.bones&&s.bones.length>0?new mn(s,c):new Hr(s,c);break;case"LOD":n=new dn;break;case"Line":n=new vn(o(t.geometry),a(t.material),t.mode);break;case"LineLoop":n=new En(o(t.geometry),a(t.material));break;case"LineSegments":n=new yn(o(t.geometry),a(t.material));break;case"PointCloud":case"Points":n=new bn(o(t.geometry),a(t.material));break;case"Sprite":n=new un(a(t.material));break;case"Group":n=new wn;break;default:n=new Zi}if(n.uuid=t.uuid,void 0!==t.name&&(n.name=t.name),void 0!==t.matrix?(e.fromArray(t.matrix),e.decompose(n.position,n.quaternion,n.scale)):(void 0!==t.position&&n.position.fromArray(t.position),void 0!==t.rotation&&n.rotation.fromArray(t.rotation),void 0!==t.quaternion&&n.quaternion.fromArray(t.quaternion),void 0!==t.scale&&n.scale.fromArray(t.scale)),void 0!==t.castShadow&&(n.castShadow=t.castShadow),void 0!==t.receiveShadow&&(n.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(n.shadow.bias=t.shadow.bias),void 0!==t.shadow.radius&&(n.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&n.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(n.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(n.visible=t.visible),void 0!==t.userData&&(n.userData=t.userData),void 0!==t.children)for(var l=t.children,h=0;h<l.length;h++)n.add(this.parseObject(l[h],i,r));if("LOD"===t.type)for(var u=t.levels,d=0;d<u.length;d++){var p=u[d],f=n.getObjectByProperty("uuid",p.object);void 0!==f&&n.addLevel(f,p.distance)}return n}}()});var fa={UVMapping:300,CubeReflectionMapping:oe,CubeRefractionMapping:ae,EquirectangularReflectionMapping:se,EquirectangularRefractionMapping:ce,SphericalReflectionMapping:le,CubeUVReflectionMapping:he,CubeUVRefractionMapping:ue},ma={RepeatWrapping:de,ClampToEdgeWrapping:pe,MirroredRepeatWrapping:fe},ga={NearestFilter:me,NearestMipMapNearestFilter:ge,NearestMipMapLinearFilter:ve,LinearFilter:ye,LinearMipMapNearestFilter:Ee,LinearMipMapLinearFilter:xe};function va(e,t,i,r,n){var o=.5*(r-t),a=.5*(n-i),s=e*e;return(2*i-2*r+o+a)*(e*s)+(-3*i+3*r-2*o-a)*s+o*e+i}function ya(e,t,i,r){return function(e,t){var i=1-e;return i*i*t}(e,t)+function(e,t){return 2*(1-e)*e*t}(e,i)+function(e,t){return e*e*t}(e,r)}function Ea(e,t,i,r,n){return function(e,t){var i=1-e;return i*i*i*t}(e,t)+function(e,t){var i=1-e;return 3*i*i*e*t}(e,i)+function(e,t){return 3*(1-e)*e*e*t}(e,r)+function(e,t){return e*e*e*t}(e,n)}function xa(){this.arcLengthDivisions=200}function ba(e,t){xa.call(this),this.v1=e,this.v2=t}function wa(){xa.call(this),this.curves=[],this.autoClose=!1}function Ta(e,t,i,r,n,o,a,s){xa.call(this),this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=r,this.aStartAngle=n,this.aEndAngle=o,this.aClockwise=a,this.aRotation=s||0}function Ma(e){xa.call(this),this.points=void 0===e?[]:e}function Sa(e,t,i,r){xa.call(this),this.v0=e,this.v1=t,this.v2=i,this.v3=r}function Ra(e,t,i){xa.call(this),this.v0=e,this.v1=t,this.v2=i}Object.assign(xa.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},getPoints:function(e){void 0===e&&(e=5);for(var t=[],i=0;i<=e;i++)t.push(this.getPoint(i/e));return t},getSpacedPoints:function(e){void 0===e&&(e=5);for(var t=[],i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,i,r=[],n=this.getPoint(0),o=0;for(r.push(0),i=1;i<=e;i++)o+=(t=this.getPoint(i/e)).distanceTo(n),r.push(o),n=t;return this.cacheArcLengths=r,r},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){var i,r=this.getLengths(),n=0,o=r.length;i=t||e*r[o-1];for(var a,s=0,c=o-1;s<=c;)if((a=r[n=Math.floor(s+(c-s)/2)]-i)<0)s=n+1;else{if(!(a>0)){c=n;break}c=n-1}if(r[n=c]===i)return n/(o-1);var l=r[n];return(n+(i-l)/(r[n+1]-l))/(o-1)},getTangent:function(e){var t=e-1e-4,i=e+1e-4;t<0&&(t=0),i>1&&(i=1);var r=this.getPoint(t);return this.getPoint(i).clone().sub(r).normalize()},getTangentAt:function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},computeFrenetFrames:function(e,t){var i,r,n,o=new Mt,a=[],s=[],c=[],l=new Mt,h=new St;for(i=0;i<=e;i++)r=i/e,a[i]=this.getTangentAt(r),a[i].normalize();s[0]=new Mt,c[0]=new Mt;var u=Number.MAX_VALUE,d=Math.abs(a[0].x),p=Math.abs(a[0].y),f=Math.abs(a[0].z);for(d<=u&&(u=d,o.set(1,0,0)),p<=u&&(u=p,o.set(0,1,0)),f<=u&&o.set(0,0,1),l.crossVectors(a[0],o).normalize(),s[0].crossVectors(a[0],l),c[0].crossVectors(a[0],s[0]),i=1;i<=e;i++)s[i]=s[i-1].clone(),c[i]=c[i-1].clone(),l.crossVectors(a[i-1],a[i]),l.length()>Number.EPSILON&&(l.normalize(),n=Math.acos(ht.clamp(a[i-1].dot(a[i]),-1,1)),s[i].applyMatrix4(h.makeRotationAxis(l,n))),c[i].crossVectors(a[i],s[i]);if(!0===t)for(n=Math.acos(ht.clamp(s[0].dot(s[e]),-1,1)),n/=e,a[0].dot(l.crossVectors(s[0],s[e]))>0&&(n=-n),i=1;i<=e;i++)s[i].applyMatrix4(h.makeRotationAxis(a[i],n*i)),c[i].crossVectors(a[i],s[i]);return{tangents:a,normals:s,binormals:c}}}),ba.prototype=Object.create(xa.prototype),ba.prototype.constructor=ba,ba.prototype.isLineCurve=!0,ba.prototype.getPoint=function(e){if(1===e)return this.v2.clone();var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},ba.prototype.getPointAt=function(e){return this.getPoint(e)},ba.prototype.getTangent=function(e){return this.v2.clone().sub(this.v1).normalize()},wa.prototype=Object.assign(Object.create(xa.prototype),{constructor:wa,add:function(e){this.curves.push(e)},closePath:function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new ba(t,e))},getPoint:function(e){for(var t=e*this.getLength(),i=this.getCurveLengths(),r=0;r<i.length;){if(i[r]>=t){var n=i[r]-t,o=this.curves[r],a=o.getLength(),s=0===a?0:1-n/a;return o.getPointAt(s)}r++}return null},getLength:function(){var e=this.getCurveLengths();return e[e.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,i=0,r=this.curves.length;i<r;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e},getSpacedPoints:function(e){void 0===e&&(e=40);for(var t=[],i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t},getPoints:function(e){e=e||12;for(var t,i=[],r=0,n=this.curves;r<n.length;r++)for(var o=n[r],a=o&&o.isEllipseCurve?2*e:o&&o.isLineCurve?1:o&&o.isSplineCurve?e*o.points.length:e,s=o.getPoints(a),c=0;c<s.length;c++){var l=s[c];t&&t.equals(l)||(i.push(l),t=l)}return this.autoClose&&i.length>1&&!i[i.length-1].equals(i[0])&&i.push(i[0]),i},createPointsGeometry:function(e){var t=this.getPoints(e);return this.createGeometry(t)},createSpacedPointsGeometry:function(e){var t=this.getSpacedPoints(e);return this.createGeometry(t)},createGeometry:function(e){for(var t=new ur,i=0,r=e.length;i<r;i++){var n=e[i];t.vertices.push(new Mt(n.x,n.y,n.z||0))}return t}}),Ta.prototype=Object.create(xa.prototype),Ta.prototype.constructor=Ta,Ta.prototype.isEllipseCurve=!0,Ta.prototype.getPoint=function(e){for(var t=2*Math.PI,i=this.aEndAngle-this.aStartAngle,r=Math.abs(i)<Number.EPSILON;i<0;)i+=t;for(;i>t;)i-=t;i<Number.EPSILON&&(i=r?0:t),!0!==this.aClockwise||r||(i===t?i=-t:i-=t);var n=this.aStartAngle+e*i,o=this.aX+this.xRadius*Math.cos(n),a=this.aY+this.yRadius*Math.sin(n);if(0!==this.aRotation){var s=Math.cos(this.aRotation),c=Math.sin(this.aRotation),l=o-this.aX,h=a-this.aY;o=l*s-h*c+this.aX,a=l*c+h*s+this.aY}return new ut(o,a)},Ma.prototype=Object.create(xa.prototype),Ma.prototype.constructor=Ma,Ma.prototype.isSplineCurve=!0,Ma.prototype.getPoint=function(e){var t=this.points,i=(t.length-1)*e,r=Math.floor(i),n=i-r,o=t[0===r?r:r-1],a=t[r],s=t[r>t.length-2?t.length-1:r+1],c=t[r>t.length-3?t.length-1:r+2];return new ut(va(n,o.x,a.x,s.x,c.x),va(n,o.y,a.y,s.y,c.y))},Sa.prototype=Object.create(xa.prototype),Sa.prototype.constructor=Sa,Sa.prototype.getPoint=function(e){var t=this.v0,i=this.v1,r=this.v2,n=this.v3;return new ut(Ea(e,t.x,i.x,r.x,n.x),Ea(e,t.y,i.y,r.y,n.y))},Ra.prototype=Object.create(xa.prototype),Ra.prototype.constructor=Ra,Ra.prototype.getPoint=function(e){var t=this.v0,i=this.v1,r=this.v2;return new ut(ya(e,t.x,i.x,r.x),ya(e,t.y,i.y,r.y))};var Aa,_a=Object.assign(Object.create(wa.prototype),{fromPoints:function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y)},moveTo:function(e,t){this.currentPoint.set(e,t)},lineTo:function(e,t){var i=new ba(this.currentPoint.clone(),new ut(e,t));this.curves.push(i),this.currentPoint.set(e,t)},quadraticCurveTo:function(e,t,i,r){var n=new Ra(this.currentPoint.clone(),new ut(e,t),new ut(i,r));this.curves.push(n),this.currentPoint.set(i,r)},bezierCurveTo:function(e,t,i,r,n,o){var a=new Sa(this.currentPoint.clone(),new ut(e,t),new ut(i,r),new ut(n,o));this.curves.push(a),this.currentPoint.set(n,o)},splineThru:function(e){var t=new Ma([this.currentPoint.clone()].concat(e));this.curves.push(t),this.currentPoint.copy(e[e.length-1])},arc:function(e,t,i,r,n,o){var a=this.currentPoint.x,s=this.currentPoint.y;this.absarc(e+a,t+s,i,r,n,o)},absarc:function(e,t,i,r,n,o){this.absellipse(e,t,i,i,r,n,o)},ellipse:function(e,t,i,r,n,o,a,s){var c=this.currentPoint.x,l=this.currentPoint.y;this.absellipse(e+c,t+l,i,r,n,o,a,s)},absellipse:function(e,t,i,r,n,o,a,s){var c=new Ta(e,t,i,r,n,o,a,s);if(this.curves.length>0){var l=c.getPoint(0);l.equals(this.currentPoint)||this.lineTo(l.x,l.y)}this.curves.push(c);var h=c.getPoint(1);this.currentPoint.copy(h)}});function Da(e){wa.call(this),this.currentPoint=new ut,e&&this.fromPoints(e)}function Ca(){Da.apply(this,arguments),this.holes=[]}function La(){this.subPaths=[],this.currentPath=null}function Pa(e){this.data=e}function Ha(e){this.manager=void 0!==e?e:So}Da.prototype=_a,_a.constructor=Da,Ca.prototype=Object.assign(Object.create(_a),{constructor:Ca,getPointsHoles:function(e){for(var t=[],i=0,r=this.holes.length;i<r;i++)t[i]=this.holes[i].getPoints(e);return t},extractAllPoints:function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},extractPoints:function(e){return this.extractAllPoints(e)}}),Object.assign(La.prototype,{moveTo:function(e,t){this.currentPath=new Da,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t)},lineTo:function(e,t){this.currentPath.lineTo(e,t)},quadraticCurveTo:function(e,t,i,r){this.currentPath.quadraticCurveTo(e,t,i,r)},bezierCurveTo:function(e,t,i,r,n,o){this.currentPath.bezierCurveTo(e,t,i,r,n,o)},splineThru:function(e){this.currentPath.splineThru(e)},toShapes:function(e,t){function i(e){for(var t=[],i=0,r=e.length;i<r;i++){var n=e[i],o=new Ca;o.curves=n.curves,t.push(o)}return t}function r(e,t){for(var i=t.length,r=!1,n=i-1,o=0;o<i;n=o++){var a=t[n],s=t[o],c=s.x-a.x,l=s.y-a.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(a=t[o],c=-c,s=t[n],l=-l),e.y<a.y||e.y>s.y)continue;if(e.y===a.y){if(e.x===a.x)return!0}else{var h=l*(e.x-a.x)-c*(e.y-a.y);if(0===h)return!0;if(h<0)continue;r=!r}}else{if(e.y!==a.y)continue;if(s.x<=e.x&&e.x<=a.x||a.x<=e.x&&e.x<=s.x)return!0}}return r}var n=Wn.isClockWise,o=this.subPaths;if(0===o.length)return[];if(!0===t)return i(o);var a,s,c,l=[];if(1===o.length)return s=o[0],(c=new Ca).curves=s.curves,l.push(c),l;var h=!n(o[0].getPoints());h=e?!h:h;var u,d,p=[],f=[],m=[],g=0;f[g]=void 0,m[g]=[];for(var v=0,y=o.length;v<y;v++)a=n(u=(s=o[v]).getPoints()),(a=e?!a:a)?(!h&&f[g]&&g++,f[g]={s:new Ca,p:u},f[g].s.curves=s.curves,h&&g++,m[g]=[]):m[g].push({h:s,p:u[0]});if(!f[0])return i(o);if(f.length>1){for(var E=!1,x=[],b=0,w=f.length;b<w;b++)p[b]=[];for(b=0,w=f.length;b<w;b++)for(var T=m[b],M=0;M<T.length;M++){for(var S=T[M],R=!0,A=0;A<f.length;A++)r(S.p,f[A].p)&&(b!==A&&x.push({froms:b,tos:A,hole:M}),R?(R=!1,p[A].push(S)):E=!0);R&&p[b].push(S)}x.length>0&&(E||(m=p))}v=0;for(var _=f.length;v<_;v++){c=f[v].s,l.push(c);for(var D=0,C=(d=m[v]).length;D<C;D++)c.holes.push(d[D].h)}return l}}),Object.assign(Pa.prototype,{isFont:!0,generateShapes:function(e,t,i){function r(e,t,r,o){var a=n.glyphs[e]||n.glyphs["?"];if(a){var s,c,l,h,u,d,p,f,m,g,v,y=new La,E=[];if(a.o)for(var x=a._cachedOutline||(a._cachedOutline=a.o.split(" ")),b=0,w=x.length;b<w;){switch(x[b++]){case"m":s=x[b++]*t+r,c=x[b++]*t+o,y.moveTo(s,c);break;case"l":s=x[b++]*t+r,c=x[b++]*t+o,y.lineTo(s,c);break;case"q":if(l=x[b++]*t+r,h=x[b++]*t+o,p=x[b++]*t+r,f=x[b++]*t+o,y.quadraticCurveTo(p,f,l,h),v=E[E.length-1]){u=v.x,d=v.y;for(var T=1;T<=i;T++){ya(M=T/i,u,p,l),ya(M,d,f,h)}}break;case"b":if(l=x[b++]*t+r,h=x[b++]*t+o,p=x[b++]*t+r,f=x[b++]*t+o,m=x[b++]*t+r,g=x[b++]*t+o,y.bezierCurveTo(p,f,m,g,l,h),v=E[E.length-1]){u=v.x,d=v.y;for(T=1;T<=i;T++){var M;Ea(M=T/i,u,p,m,l),Ea(M,d,f,g,h)}}}}return{offsetX:a.ha*t,path:y}}}void 0===t&&(t=100),void 0===i&&(i=4);for(var n=this.data,o=function(e){for(var i=String(e).split(""),o=t/n.resolution,a=(n.boundingBox.yMax-n.boundingBox.yMin+n.underlineThickness)*o,s=0,c=0,l=[],h=0;h<i.length;h++){var u=i[h];if("\n"===u)s=0,c-=a;else{var d=r(u,o,s,c);s+=d.offsetX,l.push(d.path)}}return l}(e),a=[],s=0,c=o.length;s<c;s++)Array.prototype.push.apply(a,o[s].toShapes());return a}}),Object.assign(Ha.prototype,{load:function(e,t,i,r){var n=this;new Ro(this.manager).load(e,function(e){var i;try{i=JSON.parse(e)}catch(t){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),i=JSON.parse(e.substring(65,e.length-2))}var r=n.parse(i);t&&t(r)},i,r)},parse:function(e){return new Pa(e)}});var Ba,Ia,Oa,Ua,Na,Va,Fa,za,ja,ka,Ga,Wa,Xa,Ya,qa,Za,Ja={getContext:function(){return void 0===Aa&&(Aa=new(window.AudioContext||window.webkitAudioContext)),Aa},setContext:function(e){Aa=e}};function Qa(e){this.manager=void 0!==e?e:So}function Ka(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Ki,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Ki,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}function $a(e,t,i){Zi.call(this),this.type="CubeCamera";var r=new Ki(90,1,e,t);r.up.set(0,-1,0),r.lookAt(new Mt(1,0,0)),this.add(r);var n=new Ki(90,1,e,t);n.up.set(0,-1,0),n.lookAt(new Mt(-1,0,0)),this.add(n);var o=new Ki(90,1,e,t);o.up.set(0,0,1),o.lookAt(new Mt(0,1,0)),this.add(o);var a=new Ki(90,1,e,t);a.up.set(0,0,-1),a.lookAt(new Mt(0,-1,0)),this.add(a);var s=new Ki(90,1,e,t);s.up.set(0,-1,0),s.lookAt(new Mt(0,0,1)),this.add(s);var c=new Ki(90,1,e,t);c.up.set(0,-1,0),c.lookAt(new Mt(0,0,-1)),this.add(c);var l={format:Be,magFilter:ye,minFilter:ye};this.renderTarget=new wt(i,i,l),this.renderTarget.texture.name="CubeCamera",this.update=function(e,t){null===this.parent&&this.updateMatrixWorld();var i=this.renderTarget,l=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,i.activeCubeFace=0,e.render(t,r,i),i.activeCubeFace=1,e.render(t,n,i),i.activeCubeFace=2,e.render(t,o,i),i.activeCubeFace=3,e.render(t,a,i),i.activeCubeFace=4,e.render(t,s,i),i.texture.generateMipmaps=l,i.activeCubeFace=5,e.render(t,c,i),e.setRenderTarget(null)},this.clear=function(e,t,i,r){for(var n=this.renderTarget,o=0;o<6;o++)n.activeCubeFace=o,e.setRenderTarget(n),e.clear(t,i,r);e.setRenderTarget(null)}}function es(){Zi.call(this),this.type="AudioListener",this.context=Ja.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null}function ts(e){Zi.call(this),this.type="Audio",this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.loop=!1,this.startTime=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function is(e){ts.call(this,e),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function rs(e,t){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=void 0!==t?t:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}function ns(e,t,i){this.binding=e,this.valueSize=i;var r,n=Float64Array;switch(t){case"quaternion":r=this._slerp;break;case"string":case"bool":n=Array,r=this._select;break;default:r=this._lerp}this.buffer=new n(4*i),this._mixBufferRegion=r,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}function os(e,t,i){var r=i||as.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,r)}function as(e,t,i){this.path=t,this.parsedPath=i||as.parseTrackName(t),this.node=as.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}function ss(e){this.uuid=ht.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var i=0,r=arguments.length;i!==r;++i)t[arguments[i].uuid]=i;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var n=this;this.stats={objects:{get total(){return n._objects.length},get inUse(){return this.total-n.nCachedObjects_}},get bindingsPerObject(){return n._bindings.length}}}function cs(e,t,i){this._mixer=e,this._clip=t,this._localRoot=i||null;for(var r=t.tracks,n=r.length,o=new Array(n),a={endingStart:Qe,endingEnd:Qe},s=0;s!==n;++s){var c=r[s].createInterpolant(null);o[s]=c,c.settings=a}this._interpolantSettings=a,this._interpolants=o,this._propertyBindings=new Array(n),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=Je,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function ls(e){this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function hs(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}function us(){Mr.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function ds(e,t,i,r){this.uuid=ht.generateUUID(),this.data=e,this.itemSize=t,this.offset=i,this.normalized=!0===r}function ps(e,t){this.uuid=ht.generateUUID(),this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function fs(e,t,i){ps.call(this,e,t),this.meshPerAttribute=i||1}function ms(e,t,i){dr.call(this,e,t),this.meshPerAttribute=i||1}function gs(e,t,i,r){this.ray=new Cr(e,t),this.near=i||0,this.far=r||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function vs(e,t){return e.distance-t.distance}function ys(e,t,i,r){if(!1!==e.visible&&(e.raycast(t,i),!0===r))for(var n=e.children,o=0,a=n.length;o<a;o++)ys(n[o],t,i,!0)}function Es(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}function xs(e,t,i){return this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==i?i:0,this}function bs(e,t,i){return this.radius=void 0!==e?e:1,this.theta=void 0!==t?t:0,this.y=void 0!==i?i:0,this}function ws(e){Zi.call(this),this.material=e,this.render=function(e){}}function Ts(e,t,i,r){this.object=e,this.size=void 0!==t?t:1;var n=void 0!==i?i:16711680,o=void 0!==r?r:1,a=0,s=this.object.geometry;s&&s.isGeometry?a=3*s.faces.length:s&&s.isBufferGeometry&&(a=s.attributes.normal.count);var c=new Mr,l=new xr(2*a*3,3);c.addAttribute("position",l),yn.call(this,c,new gn({color:n,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function Ms(e,t){Zi.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;for(var i=new Mr,r=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1],n=0,o=1;n<32;n++,o++){var a=n/32*Math.PI*2,s=o/32*Math.PI*2;r.push(Math.cos(a),Math.sin(a),1,Math.cos(s),Math.sin(s),1)}i.addAttribute("position",new xr(r,3));var c=new gn({fog:!1});this.cone=new yn(i,c),this.add(this.cone),this.update()}function Ss(e){for(var t=function e(t){var i=[];t&&t.isBone&&i.push(t);for(var r=0;r<t.children.length;r++)i.push.apply(i,e(t.children[r]));return i}(e),i=new Mr,r=[],n=[],o=new fi(0,0,1),a=new fi(0,1,0),s=0;s<t.length;s++){var c=t[s];c.parent&&c.parent.isBone&&(r.push(0,0,0),r.push(0,0,0),n.push(o.r,o.g,o.b),n.push(a.r,a.g,a.b))}i.addAttribute("position",new xr(r,3)),i.addAttribute("color",new xr(n,3));var l=new gn({vertexColors:x,depthTest:!1,depthWrite:!1,transparent:!0});yn.call(this,i,l),this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.onBeforeRender()}function Rs(e,t,i){this.light=e,this.light.updateMatrixWorld(),this.color=i;var r=new Qn(t,4,2),n=new Dr({wireframe:!0,fog:!1});Hr.call(this,r,n),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function As(e,t){Zi.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;var i=new gn({fog:!1}),r=new Mr;r.addAttribute("position",new dr(new Float32Array(15),3)),this.line=new vn(r,i),this.add(this.line),this.update()}function _s(e,t,i){Zi.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=i;var r=new Bn(t);r.rotateY(.5*Math.PI),this.material=new Dr({wireframe:!0,fog:!1}),void 0===this.color&&(this.material.vertexColors=x);var n=r.getAttribute("position"),o=new Float32Array(3*n.count);r.addAttribute("color",new dr(o,3)),this.add(new Hr(r,this.material)),this.update()}function Ds(e,t,i,r){e=e||10,t=t||10,i=new fi(void 0!==i?i:4473924),r=new fi(void 0!==r?r:8947848);for(var n=t/2,o=e/t,a=e/2,s=[],c=[],l=0,h=0,u=-a;l<=t;l++,u+=o){s.push(-a,0,u,a,0,u),s.push(u,0,-a,u,0,a);var d=l===n?i:r;d.toArray(c,h),h+=3,d.toArray(c,h),h+=3,d.toArray(c,h),h+=3,d.toArray(c,h),h+=3}var p=new Mr;p.addAttribute("position",new xr(s,3)),p.addAttribute("color",new xr(c,3));var f=new gn({vertexColors:x});yn.call(this,p,f)}function Cs(e,t,i,r,n,o){e=e||10,t=t||16,i=i||8,r=r||64,n=new fi(void 0!==n?n:4473924),o=new fi(void 0!==o?o:8947848);var a,s,c,l,h,u,d,p=[],f=[];for(l=0;l<=t;l++)c=l/t*(2*Math.PI),a=Math.sin(c)*e,s=Math.cos(c)*e,p.push(0,0,0),p.push(a,0,s),d=1&l?n:o,f.push(d.r,d.g,d.b),f.push(d.r,d.g,d.b);for(l=0;l<=i;l++)for(d=1&l?n:o,u=e-e/i*l,h=0;h<r;h++)c=h/r*(2*Math.PI),a=Math.sin(c)*u,s=Math.cos(c)*u,p.push(a,0,s),f.push(d.r,d.g,d.b),c=(h+1)/r*(2*Math.PI),a=Math.sin(c)*u,s=Math.cos(c)*u,p.push(a,0,s),f.push(d.r,d.g,d.b);var m=new Mr;m.addAttribute("position",new xr(p,3)),m.addAttribute("color",new xr(f,3));var g=new gn({vertexColors:x});yn.call(this,m,g)}function Ls(e,t,i,r){this.object=e,this.size=void 0!==t?t:1;var n=void 0!==i?i:16776960,o=void 0!==r?r:1,a=0,s=this.object.geometry;s&&s.isGeometry?a=s.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead.");var c=new Mr,l=new xr(2*a*3,3);c.addAttribute("position",l),yn.call(this,c,new gn({color:n,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function Ps(e,t,i){Zi.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,void 0===t&&(t=1);var r=new Mr;r.addAttribute("position",new xr([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));var n=new gn({fog:!1});this.lightPlane=new vn(r,n),this.add(this.lightPlane),(r=new Mr).addAttribute("position",new xr([0,0,0,0,0,1],3)),this.targetLine=new vn(r,n),this.add(this.targetLine),this.update()}function Hs(e){var t=new Mr,i=new gn({color:16777215,vertexColors:E}),r=[],n=[],o={},a=new fi(16755200),s=new fi(16711680),c=new fi(43775),l=new fi(16777215),h=new fi(3355443);function u(e,t,i){d(e,i),d(t,i)}function d(e,t){r.push(0,0,0),n.push(t.r,t.g,t.b),void 0===o[e]&&(o[e]=[]),o[e].push(r.length/3-1)}u("n1","n2",a),u("n2","n4",a),u("n4","n3",a),u("n3","n1",a),u("f1","f2",a),u("f2","f4",a),u("f4","f3",a),u("f3","f1",a),u("n1","f1",a),u("n2","f2",a),u("n3","f3",a),u("n4","f4",a),u("p","n1",s),u("p","n2",s),u("p","n3",s),u("p","n4",s),u("u1","u2",c),u("u2","u3",c),u("u3","u1",c),u("c","t",l),u("p","c",h),u("cn1","cn2",h),u("cn3","cn4",h),u("cf1","cf2",h),u("cf3","cf4",h),t.addAttribute("position",new xr(r,3)),t.addAttribute("color",new xr(n,3)),yn.call(this,t,i),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=o,this.update()}function Bs(e,t){this.object=e,void 0===t&&(t=16776960);var i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new Float32Array(24),n=new Mr;n.setIndex(new dr(i,1)),n.addAttribute("position",new dr(r,3)),yn.call(this,n,new gn({color:t})),this.matrixAutoUpdate=!1,this.update()}function Is(e,t){this.type="Box3Helper",this.box=e;var i=void 0!==t?t:16776960,r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Mr;n.setIndex(new dr(r,1)),n.addAttribute("position",new xr([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),yn.call(this,n,new gn({color:i})),this.geometry.computeBoundingSphere(),this.onBeforeRender()}function Os(e,t,i){this.type="PlaneHelper",this.plane=e,this.size=void 0===t?1:t;var r=void 0!==i?i:16776960,n=new Mr;n.addAttribute("position",new xr([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),n.computeBoundingSphere(),vn.call(this,n,new gn({color:r}));var o=new Mr;o.addAttribute("position",new xr([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),o.computeBoundingSphere(),this.add(new Hr(o,new Dr({color:r,opacity:.2,transparent:!0,depthWrite:!1}))),this.onBeforeRender()}function Us(e,t,i,r,n,o){Zi.call(this),void 0===r&&(r=16776960),void 0===i&&(i=1),void 0===n&&(n=.2*i),void 0===o&&(o=.2*n),void 0===Xa&&((Xa=new Mr).addAttribute("position",new xr([0,0,0,0,1,0],3)),(Ya=new ao(0,.5,1,5,1)).translate(0,-.5,0)),this.position.copy(t),this.line=new vn(Xa,new gn({color:r})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Hr(Ya,new Dr({color:r})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(i,n,o)}function Ns(e){var t=[0,0,0,e=e||1,0,0,0,0,0,0,e,0,0,0,0,0,0,e],i=new Mr;i.addAttribute("position",new xr(t,3)),i.addAttribute("color",new xr([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));var r=new gn({vertexColors:x});yn.call(this,i,r)}function Vs(){var e=0,t=0,i=0,r=0;function n(n,o,a,s){e=n,t=a,i=-3*n+3*o-2*a-s,r=2*n-2*o+a+s}return{initCatmullRom:function(e,t,i,r,o){n(t,i,o*(i-e),o*(r-t))},initNonuniformCatmullRom:function(e,t,i,r,o,a,s){var c=(t-e)/o-(i-e)/(o+a)+(i-t)/a,l=(i-t)/a-(r-t)/(a+s)+(r-i)/s;n(t,i,c*=a,l*=a)},calc:function(n){var o=n*n;return e+t*n+i*o+r*(o*n)}}}Object.assign(Qa.prototype,{load:function(e,t,i,r){var n=new Ro(this.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){Ja.getContext().decodeAudioData(e,function(e){t(e)})},i,r)}}),Object.assign(Ka.prototype,{update:(ja=new St,ka=new St,function(e){if(Ba!==this||Ia!==e.focus||Oa!==e.fov||Ua!==e.aspect*this.aspect||Na!==e.near||Va!==e.far||Fa!==e.zoom||za!==this.eyeSep){Ba=this,Ia=e.focus,Oa=e.fov,Ua=e.aspect*this.aspect,Na=e.near,Va=e.far,Fa=e.zoom;var t,i,r=e.projectionMatrix.clone(),n=(za=this.eyeSep/2)*Na/Ia,o=Na*Math.tan(ht.DEG2RAD*Oa*.5)/Fa;ka.elements[12]=-za,ja.elements[12]=za,t=-o*Ua+n,i=o*Ua+n,r.elements[0]=2*Na/(i-t),r.elements[8]=(i+t)/(i-t),this.cameraL.projectionMatrix.copy(r),t=-o*Ua-n,i=o*Ua-n,r.elements[0]=2*Na/(i-t),r.elements[8]=(i+t)/(i-t),this.cameraR.projectionMatrix.copy(r)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(ka),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(ja)})}),$a.prototype=Object.create(Zi.prototype),$a.prototype.constructor=$a,es.prototype=Object.assign(Object.create(Zi.prototype),{constructor:es,getInput:function(){return this.gain},removeFilter:function(){null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null)},getFilter:function(){return this.filter},setFilter:function(e){null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination)},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(e){this.gain.gain.value=e},updateMatrixWorld:function(){var e=new Mt,t=new Tt,i=new Mt,r=new Mt;return function(n){Zi.prototype.updateMatrixWorld.call(this,n);var o=this.context.listener,a=this.up;this.matrixWorld.decompose(e,t,i),r.set(0,0,-1).applyQuaternion(t),o.positionX?(o.positionX.setValueAtTime(e.x,this.context.currentTime),o.positionY.setValueAtTime(e.y,this.context.currentTime),o.positionZ.setValueAtTime(e.z,this.context.currentTime),o.forwardX.setValueAtTime(r.x,this.context.currentTime),o.forwardY.setValueAtTime(r.y,this.context.currentTime),o.forwardZ.setValueAtTime(r.z,this.context.currentTime),o.upX.setValueAtTime(a.x,this.context.currentTime),o.upY.setValueAtTime(a.y,this.context.currentTime),o.upZ.setValueAtTime(a.z,this.context.currentTime)):(o.setPosition(e.x,e.y,e.z),o.setOrientation(r.x,r.y,r.z,a.x,a.y,a.z))}}()}),ts.prototype=Object.assign(Object.create(Zi.prototype),{constructor:ts,getOutput:function(){return this.gain},setNodeSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},setBuffer:function(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0!==this.isPlaying){if(!1!==this.hasPlaybackControl){var e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.onended=this.onEnded.bind(this),e.playbackRate.setValueAtTime(this.playbackRate,this.startTime),e.start(0,this.startTime),this.isPlaying=!0,this.source=e,this.connect()}console.warn("THREE.Audio: this Audio has no playback control.")}else console.warn("THREE.Audio: Audio is already playing.")},pause:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.startTime=this.context.currentTime,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")},stop:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.startTime=0,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(e){return e||(e=[]),!0===this.isPlaying?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},getFilter:function(){return this.getFilters()[0]},setFilter:function(e){return this.setFilters(e?[e]:[])},setPlaybackRate:function(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setValueAtTime(this.playbackRate,this.context.currentTime),this;console.warn("THREE.Audio: this Audio has no playback control.")},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")},getVolume:function(){return this.gain.gain.value},setVolume:function(e){return this.gain.gain.value=e,this}}),is.prototype=Object.assign(Object.create(ts.prototype),{constructor:is,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(e){this.panner.refDistance=e},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},updateMatrixWorld:function(){var e=new Mt;return function(t){Zi.prototype.updateMatrixWorld.call(this,t),e.setFromMatrixPosition(this.matrixWorld),this.panner.setPosition(e.x,e.y,e.z)}}()}),Object.assign(rs.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var e=0,t=this.getFrequencyData(),i=0;i<t.length;i++)e+=t[i];return e/t.length}}),Object.assign(ns.prototype,{accumulate:function(e,t){var i=this.buffer,r=this.valueSize,n=e*r+r,o=this.cumulativeWeight;if(0===o){for(var a=0;a!==r;++a)i[n+a]=i[a];o=t}else{var s=t/(o+=t);this._mixBufferRegion(i,n,0,s,r)}this.cumulativeWeight=o},apply:function(e){var t=this.valueSize,i=this.buffer,r=e*t+t,n=this.cumulativeWeight,o=this.binding;if(this.cumulativeWeight=0,n<1){var a=3*t;this._mixBufferRegion(i,r,a,1-n,t)}for(var s=t,c=t+t;s!==c;++s)if(i[s]!==i[s+t]){o.setValue(i,r);break}},saveOriginalState:function(){var e=this.binding,t=this.buffer,i=this.valueSize,r=3*i;e.getValue(t,r);for(var n=i,o=r;n!==o;++n)t[n]=t[r+n%i];this.cumulativeWeight=0},restoreOriginalState:function(){var e=3*this.valueSize;this.binding.setValue(this.buffer,e)},_select:function(e,t,i,r,n){if(r>=.5)for(var o=0;o!==n;++o)e[t+o]=e[i+o]},_slerp:function(e,t,i,r){Tt.slerpFlat(e,t,e,t,e,i,r)},_lerp:function(e,t,i,r,n){for(var o=1-r,a=0;a!==n;++a){var s=t+a;e[s]=e[s]*o+e[i+a]*r}}}),Object.assign(os.prototype,{getValue:function(e,t){this.bind();var i=this._targetGroup.nCachedObjects_,r=this._bindings[i];void 0!==r&&r.getValue(e,t)},setValue:function(e,t){for(var i=this._bindings,r=this._targetGroup.nCachedObjects_,n=i.length;r!==n;++r)i[r].setValue(e,t)},bind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()},unbind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}}),Object.assign(as,{Composite:os,create:function(e,t,i){return e&&e.isAnimationObjectGroup?new as.Composite(e,t,i):new as(e,t,i)},sanitizeNodeName:function(e){return e.replace(/\s/g,"_").replace(/[^\w-]/g,"")},parseTrackName:(Ga=new RegExp("^"+/((?:[\w-]+[\/:])*)/.source+/([\w-\.]+)?/.source+/(?:\.([\w-]+)(?:\[(.+)\])?)?/.source+/\.([\w-]+)(?:\[(.+)\])?/.source+"$"),Wa=["material","materials","bones"],function(e){var t=Ga.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);var i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},r=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==r&&-1!==r){var n=i.nodeName.substring(r+1);-1!==Wa.indexOf(n)&&(i.nodeName=i.nodeName.substring(0,r),i.objectName=n)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}),findNode:function(e,t){if(!t||""===t||"root"===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){var i=function(e){for(var i=0;i<e.bones.length;i++){var r=e.bones[i];if(r.name===t)return r}return null}(e.skeleton);if(i)return i}if(e.children){var r=function(e){for(var i=0;i<e.length;i++){var n=e[i];if(n.name===t||n.uuid===t)return n;var o=r(n.children);if(o)return o}return null},n=r(e.children);if(n)return n}return null}}),Object.assign(as.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,t){e[t]=this.node[this.propertyName]},function(e,t){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)e[t++]=i[r]},function(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function(e,t){this.node[this.propertyName]=e[t]},function(e,t){this.node[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.node[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=e[t++]},function(e,t){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=e[t++];this.targetObject.needsUpdate=!0},function(e,t){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty.fromArray(e,t)},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,t){this.bind(),this.getValue(e,t)},setValue:function(e,t){this.bind(),this.setValue(e,t)},bind:function(){var e=this.node,t=this.parsedPath,i=t.objectName,r=t.propertyName,n=t.propertyIndex;if(e||(e=as.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,e){if(i){var o=t.objectIndex;switch(i){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(var a=0;a<e.length;a++)if(e[a].name===o){o=a;break}break;default:if(void 0===e[i])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[i]}if(void 0!==o){if(void 0===e[o])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[o]}}var s=e[r];if(void 0!==s){var c=this.Versioning.None;void 0!==e.needsUpdate?(c=this.Versioning.NeedsUpdate,this.targetObject=e):void 0!==e.matrixWorldNeedsUpdate&&(c=this.Versioning.MatrixWorldNeedsUpdate,this.targetObject=e);var l=this.BindingType.Direct;if(void 0!==n){if("morphTargetInfluences"===r){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(e.geometry.isBufferGeometry){if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);for(a=0;a<this.node.geometry.morphAttributes.position.length;a++)if(e.geometry.morphAttributes.position[a].name===n){n=a;break}}else{if(!e.geometry.morphTargets)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphTargets.",this);for(a=0;a<this.node.geometry.morphTargets.length;a++)if(e.geometry.morphTargets[a].name===n){n=a;break}}}l=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=n}else void 0!==s.fromArray&&void 0!==s.toArray?(l=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(l=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=r;this.getValue=this.GetterByBindingType[l],this.setValue=this.SetterByBindingTypeAndVersioning[l][c]}else{var h=t.nodeName;console.error("THREE.PropertyBinding: Trying to update property for track: "+h+"."+r+" but it wasn't found.",e)}}else console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.")},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(as.prototype,{_getValue_unbound:as.prototype.getValue,_setValue_unbound:as.prototype.setValue}),Object.assign(ss.prototype,{isAnimationObjectGroup:!0,add:function(e){for(var t=this._objects,i=t.length,r=this.nCachedObjects_,n=this._indicesByUUID,o=this._paths,a=this._parsedPaths,s=this._bindings,c=s.length,l=0,h=arguments.length;l!==h;++l){var u=arguments[l],d=u.uuid,p=n[d],f=void 0;if(void 0===p){p=i++,n[d]=p,t.push(u);for(var m=0,g=c;m!==g;++m)s[m].push(new as(u,o[m],a[m]))}else if(p<r){f=t[p];var v=--r,y=t[v];n[y.uuid]=p,t[p]=y,n[d]=v,t[v]=u;for(m=0,g=c;m!==g;++m){var E=s[m],x=E[v],b=E[p];E[p]=x,void 0===b&&(b=new as(u,o[m],a[m])),E[v]=b}}else t[p]!==f&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=r},remove:function(e){for(var t=this._objects,i=this.nCachedObjects_,r=this._indicesByUUID,n=this._bindings,o=n.length,a=0,s=arguments.length;a!==s;++a){var c=arguments[a],l=c.uuid,h=r[l];if(void 0!==h&&h>=i){var u=i++,d=t[u];r[d.uuid]=h,t[h]=d,r[l]=u,t[u]=c;for(var p=0,f=o;p!==f;++p){var m=n[p],g=m[u],v=m[h];m[h]=g,m[u]=v}}}this.nCachedObjects_=i},uncache:function(e){for(var t=this._objects,i=t.length,r=this.nCachedObjects_,n=this._indicesByUUID,o=this._bindings,a=o.length,s=0,c=arguments.length;s!==c;++s){var l=arguments[s].uuid,h=n[l];if(void 0!==h)if(delete n[l],h<r){var u=--r,d=t[u],p=t[y=--i];n[d.uuid]=h,t[h]=d,n[p.uuid]=u,t[u]=p,t.pop();for(var f=0,m=a;f!==m;++f){var g=(E=o[f])[u],v=E[y];E[h]=g,E[u]=v,E.pop()}}else{var y;n[(p=t[y=--i]).uuid]=h,t[h]=p,t.pop();for(f=0,m=a;f!==m;++f){var E;(E=o[f])[h]=E[y],E.pop()}}}this.nCachedObjects_=r},subscribe_:function(e,t){var i=this._bindingsIndicesByPath,r=i[e],n=this._bindings;if(void 0!==r)return n[r];var o=this._paths,a=this._parsedPaths,s=this._objects,c=s.length,l=this.nCachedObjects_,h=new Array(c);r=n.length,i[e]=r,o.push(e),a.push(t),n.push(h);for(var u=l,d=s.length;u!==d;++u){var p=s[u];h[u]=new as(p,e,t)}return h},unsubscribe_:function(e){var t=this._bindingsIndicesByPath,i=t[e];if(void 0!==i){var r=this._paths,n=this._parsedPaths,o=this._bindings,a=o.length-1,s=o[a];t[e[a]]=i,o[i]=s,o.pop(),n[i]=n[a],n.pop(),r[i]=r[a],r.pop()}}}),Object.assign(cs.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(e){return this._startTime=e,this},setLoop:function(e,t){return this.loop=e,this.repetitions=t,this},setEffectiveWeight:function(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(e){return this._scheduleFading(e,0,1)},fadeOut:function(e){return this._scheduleFading(e,1,0)},crossFadeFrom:function(e,t,i){if(e.fadeOut(t),this.fadeIn(t),i){var r=this._clip.duration,n=e._clip.duration,o=n/r,a=r/n;e.warp(1,o,t),this.warp(a,1,t)}return this},crossFadeTo:function(e,t,i){return e.crossFadeFrom(this,t,i)},stopFading:function(){var e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},setEffectiveTimeScale:function(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(e){return this.timeScale=this._clip.duration/e,this.stopWarping()},syncWith:function(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()},halt:function(e){return this.warp(this._effectiveTimeScale,0,e)},warp:function(e,t,i){var r=this._mixer,n=r.time,o=this._timeScaleInterpolant,a=this.timeScale;null===o&&(o=r._lendControlInterpolant(),this._timeScaleInterpolant=o);var s=o.parameterPositions,c=o.sampleValues;return s[0]=n,s[1]=n+i,c[0]=e/a,c[1]=t/a,this},stopWarping:function(){var e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(e,t,i,r){if(this.enabled){var n=this._startTime;if(null!==n){var o=(e-n)*i;if(o<0||0===i)return;this._startTime=null,t=i*o}t*=this._updateTimeScale(e);var a=this._updateTime(t),s=this._updateWeight(e);if(s>0)for(var c=this._interpolants,l=this._propertyBindings,h=0,u=c.length;h!==u;++h)c[h].evaluate(a),l[h].accumulate(r,s)}else this._updateWeight(e)},_updateWeight:function(e){var t=0;if(this.enabled){t=this.weight;var i=this._weightInterpolant;if(null!==i){var r=i.evaluate(e)[0];t*=r,e>i.parameterPositions[1]&&(this.stopFading(),0===r&&(this.enabled=!1))}}return this._effectiveWeight=t,t},_updateTimeScale:function(e){var t=0;if(!this.paused){t=this.timeScale;var i=this._timeScaleInterpolant;if(null!==i)t*=i.evaluate(e)[0],e>i.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}return this._effectiveTimeScale=t,t},_updateTime:function(e){var t=this.time+e;if(0===e)return t;var i=this._clip.duration,r=this.loop,n=this._loopCount;if(2200===r){-1===n&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(t>=i)t=i;else{if(!(t<0))break e;t=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{var o=2202===r;if(-1===n&&(e>=0?(n=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),t>=i||t<0){var a=Math.floor(t/i);t-=i*a,n+=Math.abs(a);var s=this.repetitions-n;if(s<0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,t=e>0?i:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(0===s){var c=e<0;this._setEndings(c,!c,o)}else this._setEndings(!1,!1,o);this._loopCount=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:a})}}if(o&&1==(1&n))return this.time=t,i-t}return this.time=t,t},_setEndings:function(e,t,i){var r=this._interpolantSettings;i?(r.endingStart=2401,r.endingEnd=2401):(r.endingStart=e?this.zeroSlopeAtStart?2401:Qe:2402,r.endingEnd=t?this.zeroSlopeAtEnd?2401:Qe:2402)},_scheduleFading:function(e,t,i){var r=this._mixer,n=r.time,o=this._weightInterpolant;null===o&&(o=r._lendControlInterpolant(),this._weightInterpolant=o);var a=o.parameterPositions,s=o.sampleValues;return a[0]=n,s[0]=t,a[1]=n+e,s[1]=i,this}}),Object.assign(ls.prototype,t.prototype,{_bindAction:function(e,t){var i=e._localRoot||this._root,r=e._clip.tracks,n=r.length,o=e._propertyBindings,a=e._interpolants,s=i.uuid,c=this._bindingsByRootAndName,l=c[s];void 0===l&&(l={},c[s]=l);for(var h=0;h!==n;++h){var u=r[h],d=u.name,p=l[d];if(void 0!==p)o[h]=p;else{if(void 0!==(p=o[h])){null===p._cacheIndex&&(++p.referenceCount,this._addInactiveBinding(p,s,d));continue}var f=t&&t._propertyBindings[h].binding.parsedPath;++(p=new ns(as.create(i,d,f),u.ValueTypeName,u.getValueSize())).referenceCount,this._addInactiveBinding(p,s,d),o[h]=p}a[h].resultBuffer=p.buffer}},_activateAction:function(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){var t=(e._localRoot||this._root).uuid,i=e._clip.uuid,r=this._actionsByClip[i];this._bindAction(e,r&&r.knownActions[0]),this._addInactiveAction(e,i,t)}for(var n=e._propertyBindings,o=0,a=n.length;o!==a;++o){var s=n[o];0==s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(e)}},_deactivateAction:function(e){if(this._isActiveAction(e)){for(var t=e._propertyBindings,i=0,r=t.length;i!==r;++i){var n=t[i];0==--n.useCount&&(n.restoreOriginalState(),this._takeBackBinding(n))}this._takeBackAction(e)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}},_isActiveAction:function(e){var t=e._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(e,t,i){var r=this._actions,n=this._actionsByClip,o=n[t];if(void 0===o)o={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,n[t]=o;else{var a=o.knownActions;e._byClipCacheIndex=a.length,a.push(e)}e._cacheIndex=r.length,r.push(e),o.actionByRoot[i]=e},_removeInactiveAction:function(e){var t=this._actions,i=t[t.length-1],r=e._cacheIndex;i._cacheIndex=r,t[r]=i,t.pop(),e._cacheIndex=null;var n=e._clip.uuid,o=this._actionsByClip,a=o[n],s=a.knownActions,c=s[s.length-1],l=e._byClipCacheIndex;c._byClipCacheIndex=l,s[l]=c,s.pop(),e._byClipCacheIndex=null,delete a.actionByRoot[(e._localRoot||this._root).uuid],0===s.length&&delete o[n],this._removeInactiveBindingsForAction(e)},_removeInactiveBindingsForAction:function(e){for(var t=e._propertyBindings,i=0,r=t.length;i!==r;++i){var n=t[i];0==--n.referenceCount&&this._removeInactiveBinding(n)}},_lendAction:function(e){var t=this._actions,i=e._cacheIndex,r=this._nActiveActions++,n=t[r];e._cacheIndex=r,t[r]=e,n._cacheIndex=i,t[i]=n},_takeBackAction:function(e){var t=this._actions,i=e._cacheIndex,r=--this._nActiveActions,n=t[r];e._cacheIndex=r,t[r]=e,n._cacheIndex=i,t[i]=n},_addInactiveBinding:function(e,t,i){var r=this._bindingsByRootAndName,n=r[t],o=this._bindings;void 0===n&&(n={},r[t]=n),n[i]=e,e._cacheIndex=o.length,o.push(e)},_removeInactiveBinding:function(e){var t=this._bindings,i=e.binding,r=i.rootNode.uuid,n=i.path,o=this._bindingsByRootAndName,a=o[r],s=t[t.length-1],c=e._cacheIndex;s._cacheIndex=c,t[c]=s,t.pop(),delete a[n];e:{for(var l in a)break e;delete o[r]}},_lendBinding:function(e){var t=this._bindings,i=e._cacheIndex,r=this._nActiveBindings++,n=t[r];e._cacheIndex=r,t[r]=e,n._cacheIndex=i,t[i]=n},_takeBackBinding:function(e){var t=this._bindings,i=e._cacheIndex,r=--this._nActiveBindings,n=t[r];e._cacheIndex=r,t[r]=e,n._cacheIndex=i,t[i]=n},_lendControlInterpolant:function(){var e=this._controlInterpolants,t=this._nActiveControlInterpolants++,i=e[t];return void 0===i&&((i=new Xo(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=t,e[t]=i),i},_takeBackControlInterpolant:function(e){var t=this._controlInterpolants,i=e.__cacheIndex,r=--this._nActiveControlInterpolants,n=t[r];e.__cacheIndex=r,t[r]=e,n.__cacheIndex=i,t[i]=n},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(e,t){var i=t||this._root,r=i.uuid,n="string"==typeof e?ra.findByName(i,e):e,o=null!==n?n.uuid:e,a=this._actionsByClip[o],s=null;if(void 0!==a){var c=a.actionByRoot[r];if(void 0!==c)return c;s=a.knownActions[0],null===n&&(n=s._clip)}if(null===n)return null;var l=new cs(this,n,t);return this._bindAction(l,s),this._addInactiveAction(l,o,r),l},existingAction:function(e,t){var i=t||this._root,r=i.uuid,n="string"==typeof e?ra.findByName(i,e):e,o=n?n.uuid:e,a=this._actionsByClip[o];return void 0!==a&&a.actionByRoot[r]||null},stopAllAction:function(){var e=this._actions,t=this._nActiveActions,i=this._bindings,r=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var n=0;n!==t;++n)e[n].reset();for(n=0;n!==r;++n)i[n].useCount=0;return this},update:function(e){e*=this.timeScale;for(var t=this._actions,i=this._nActiveActions,r=this.time+=e,n=Math.sign(e),o=this._accuIndex^=1,a=0;a!==i;++a){t[a]._update(r,e,n,o)}var s=this._bindings,c=this._nActiveBindings;for(a=0;a!==c;++a)s[a].apply(o);return this},getRoot:function(){return this._root},uncacheClip:function(e){var t=this._actions,i=e.uuid,r=this._actionsByClip,n=r[i];if(void 0!==n){for(var o=n.knownActions,a=0,s=o.length;a!==s;++a){var c=o[a];this._deactivateAction(c);var l=c._cacheIndex,h=t[t.length-1];c._cacheIndex=null,c._byClipCacheIndex=null,h._cacheIndex=l,t[l]=h,t.pop(),this._removeInactiveBindingsForAction(c)}delete r[i]}},uncacheRoot:function(e){var t=e.uuid,i=this._actionsByClip;for(var r in i){var n=i[r].actionByRoot[t];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}var o=this._bindingsByRootAndName[t];if(void 0!==o)for(var a in o){var s=o[a];s.restoreOriginalState(),this._removeInactiveBinding(s)}},uncacheAction:function(e,t){var i=this.existingAction(e,t);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}}),hs.prototype.clone=function(){return new hs(void 0===this.value.clone?this.value:this.value.clone())},us.prototype=Object.assign(Object.create(Mr.prototype),{constructor:us,isInstancedBufferGeometry:!0,addGroup:function(e,t,i){this.groups.push({start:e,count:t,materialIndex:i})},copy:function(e){var t=e.index;null!==t&&this.setIndex(t.clone());var i=e.attributes;for(var r in i){var n=i[r];this.addAttribute(r,n.clone())}for(var o=e.groups,a=0,s=o.length;a<s;a++){var c=o[a];this.addGroup(c.start,c.count,c.materialIndex)}return this}}),Object.defineProperties(ds.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(ds.prototype,{isInterleavedBufferAttribute:!0,setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this},setXYZ:function(e,t,i,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=r,this},setXYZW:function(e,t,i,r,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=r,this.data.array[e+3]=n,this}}),Object.defineProperty(ps.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(ps.prototype,{isInterleavedBuffer:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.stride:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.dynamic=e.dynamic,this},copyAt:function(e,t,i){e*=this.stride,i*=t.stride;for(var r=0,n=this.stride;r<n;r++)this.array[e+r]=t.array[i+r];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(e){return this.onUploadCallback=e,this}}),fs.prototype=Object.assign(Object.create(ps.prototype),{constructor:fs,isInstancedInterleavedBuffer:!0,copy:function(e){return ps.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),ms.prototype=Object.assign(Object.create(dr.prototype),{constructor:ms,isInstancedBufferAttribute:!0,copy:function(e){return dr.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),Object.assign(gs.prototype,{linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(e,t){var i=[];return ys(e,this,i,t),i.sort(vs),i},intersectObjects:function(e,t){var i=[];if(!1===Array.isArray(e))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),i;for(var r=0,n=e.length;r<n;r++)ys(e[r],this,i,t);return i.sort(vs),i}}),Object.assign(Es.prototype,{start:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1,this.autoStart=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}),Object.assign(xs.prototype,{set:function(e,t,i){return this.radius=e,this.phi=t,this.theta=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(ht.clamp(e.y/this.radius,-1,1))),this}}),Object.assign(bs.prototype,{set:function(e,t,i){return this.radius=e,this.theta=t,this.y=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this},setFromVector3:function(e){return this.radius=Math.sqrt(e.x*e.x+e.z*e.z),this.theta=Math.atan2(e.x,e.z),this.y=e.y,this}}),ws.prototype=Object.create(Zi.prototype),ws.prototype.constructor=ws,ws.prototype.isImmediateRenderObject=!0,Ts.prototype=Object.create(yn.prototype),Ts.prototype.constructor=Ts,Ts.prototype.update=function(){var e=new Mt,t=new Mt,i=new Ui;return function(){var r=["a","b","c"];this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);var n=this.object.matrixWorld,o=this.geometry.attributes.position,a=this.object.geometry;if(a&&a.isGeometry)for(var s=a.vertices,c=a.faces,l=0,h=0,u=c.length;h<u;h++)for(var d=c[h],p=0,f=d.vertexNormals.length;p<f;p++){var m=s[d[r[p]]],g=d.vertexNormals[p];e.copy(m).applyMatrix4(n),t.copy(g).applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),o.setXYZ(l,e.x,e.y,e.z),l+=1,o.setXYZ(l,t.x,t.y,t.z),l+=1}else if(a&&a.isBufferGeometry){var v=a.attributes.position,y=a.attributes.normal;for(l=0,p=0,f=v.count;p<f;p++)e.set(v.getX(p),v.getY(p),v.getZ(p)).applyMatrix4(n),t.set(y.getX(p),y.getY(p),y.getZ(p)),t.applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),o.setXYZ(l,e.x,e.y,e.z),l+=1,o.setXYZ(l,t.x,t.y,t.z),l+=1}o.needsUpdate=!0}}(),Ms.prototype=Object.create(Zi.prototype),Ms.prototype.constructor=Ms,Ms.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},Ms.prototype.update=function(){var e=new Mt,t=new Mt;return function(){this.light.updateMatrixWorld();var i=this.light.distance?this.light.distance:1e3,r=i*Math.tan(this.light.angle);this.cone.scale.set(r,r,i),e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(t.sub(e)),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}(),Ss.prototype=Object.create(yn.prototype),Ss.prototype.constructor=Ss,Ss.prototype.onBeforeRender=function(){var e=new Mt,t=new St,i=new St;return function(){var r=this.bones,n=this.geometry,o=n.getAttribute("position");i.getInverse(this.root.matrixWorld);for(var a=0,s=0;a<r.length;a++){var c=r[a];c.parent&&c.parent.isBone&&(t.multiplyMatrices(i,c.matrixWorld),e.setFromMatrixPosition(t),o.setXYZ(s,e.x,e.y,e.z),t.multiplyMatrices(i,c.parent.matrixWorld),e.setFromMatrixPosition(t),o.setXYZ(s+1,e.x,e.y,e.z),s+=2)}n.getAttribute("position").needsUpdate=!0}}(),Rs.prototype=Object.create(Hr.prototype),Rs.prototype.constructor=Rs,Rs.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},Rs.prototype.update=function(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)},As.prototype=Object.create(Zi.prototype),As.prototype.constructor=As,As.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},As.prototype.update=function(){var e=.5*this.light.width,t=.5*this.light.height,i=this.line.geometry.attributes.position,r=i.array;r[0]=e,r[1]=-t,r[2]=0,r[3]=e,r[4]=t,r[5]=0,r[6]=-e,r[7]=t,r[8]=0,r[9]=-e,r[10]=-t,r[11]=0,r[12]=e,r[13]=-t,r[14]=0,i.needsUpdate=!0,void 0!==this.color?this.line.material.color.set(this.color):this.line.material.color.copy(this.light.color)},_s.prototype=Object.create(Zi.prototype),_s.prototype.constructor=_s,_s.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},_s.prototype.update=function(){var e=new Mt,t=new fi,i=new fi;return function(){var r=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{var n=r.geometry.getAttribute("color");t.copy(this.light.color),i.copy(this.light.groundColor);for(var o=0,a=n.count;o<a;o++){var s=o<a/2?t:i;n.setXYZ(o,s.r,s.g,s.b)}n.needsUpdate=!0}r.lookAt(e.setFromMatrixPosition(this.light.matrixWorld).negate())}}(),Ds.prototype=Object.create(yn.prototype),Ds.prototype.constructor=Ds,Cs.prototype=Object.create(yn.prototype),Cs.prototype.constructor=Cs,Ls.prototype=Object.create(yn.prototype),Ls.prototype.constructor=Ls,Ls.prototype.update=function(){var e=new Mt,t=new Mt,i=new Ui;return function(){this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);for(var r=this.object.matrixWorld,n=this.geometry.attributes.position,o=this.object.geometry,a=o.vertices,s=o.faces,c=0,l=0,h=s.length;l<h;l++){var u=s[l],d=u.normal;e.copy(a[u.a]).add(a[u.b]).add(a[u.c]).divideScalar(3).applyMatrix4(r),t.copy(d).applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),n.setXYZ(c,e.x,e.y,e.z),c+=1,n.setXYZ(c,t.x,t.y,t.z),c+=1}n.needsUpdate=!0}}(),Ps.prototype=Object.create(Zi.prototype),Ps.prototype.constructor=Ps,Ps.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},Ps.prototype.update=function(){var e=new Mt,t=new Mt,i=new Mt;return function(){e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),i.subVectors(t,e),this.lightPlane.lookAt(i),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(i),this.targetLine.scale.z=i.length()}}(),Hs.prototype=Object.create(yn.prototype),Hs.prototype.constructor=Hs,Hs.prototype.update=function(){var e,t,i=new Mt,r=new Ji;function n(n,o,a,s){i.set(o,a,s).unproject(r);var c=t[n];if(void 0!==c)for(var l=e.getAttribute("position"),h=0,u=c.length;h<u;h++)l.setXYZ(c[h],i.x,i.y,i.z)}return function(){e=this.geometry,t=this.pointMap;r.projectionMatrix.copy(this.camera.projectionMatrix),n("c",0,0,-1),n("t",0,0,1),n("n1",-1,-1,-1),n("n2",1,-1,-1),n("n3",-1,1,-1),n("n4",1,1,-1),n("f1",-1,-1,1),n("f2",1,-1,1),n("f3",-1,1,1),n("f4",1,1,1),n("u1",.7,1.1,-1),n("u2",-.7,1.1,-1),n("u3",0,2,-1),n("cf1",-1,0,1),n("cf2",1,0,1),n("cf3",0,-1,1),n("cf4",0,1,1),n("cn1",-1,0,-1),n("cn2",1,0,-1),n("cn3",0,-1,-1),n("cn4",0,1,-1),e.getAttribute("position").needsUpdate=!0}}(),Bs.prototype=Object.create(yn.prototype),Bs.prototype.constructor=Bs,Bs.prototype.update=function(){var e=new Ii;return function(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&e.setFromObject(this.object),!e.isEmpty()){var i=e.min,r=e.max,n=this.geometry.attributes.position,o=n.array;o[0]=r.x,o[1]=r.y,o[2]=r.z,o[3]=i.x,o[4]=r.y,o[5]=r.z,o[6]=i.x,o[7]=i.y,o[8]=r.z,o[9]=r.x,o[10]=i.y,o[11]=r.z,o[12]=r.x,o[13]=r.y,o[14]=i.z,o[15]=i.x,o[16]=r.y,o[17]=i.z,o[18]=i.x,o[19]=i.y,o[20]=i.z,o[21]=r.x,o[22]=i.y,o[23]=i.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}(),Bs.prototype.setFromObject=function(e){return this.object=e,this.update(),this},Is.prototype=Object.create(yn.prototype),Is.prototype.constructor=Is,Is.prototype.onBeforeRender=function(){var e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5))},Os.prototype=Object.create(vn.prototype),Os.prototype.constructor=Os,Os.prototype.onBeforeRender=function(){var e=-this.plane.constant;Math.abs(e)<1e-8&&(e=1e-8),this.scale.set(.5*this.size,.5*this.size,e),this.lookAt(this.plane.normal),this.updateMatrixWorld()},Us.prototype=Object.create(Zi.prototype),Us.prototype.constructor=Us,Us.prototype.setDirection=(Za=new Mt,function(e){e.y>.99999?this.quaternion.set(0,0,0,1):e.y<-.99999?this.quaternion.set(1,0,0,0):(Za.set(e.z,0,-e.x).normalize(),qa=Math.acos(e.y),this.quaternion.setFromAxisAngle(Za,qa))}),Us.prototype.setLength=function(e,t,i){void 0===t&&(t=.2*e),void 0===i&&(i=.2*t),this.line.scale.set(1,Math.max(0,e-t),1),this.line.updateMatrix(),this.cone.scale.set(i,t,i),this.cone.position.y=e,this.cone.updateMatrix()},Us.prototype.setColor=function(e){this.line.material.color.copy(e),this.cone.material.color.copy(e)},Ns.prototype=Object.create(yn.prototype),Ns.prototype.constructor=Ns;var Fs=new Mt,zs=new Vs,js=new Vs,ks=new Vs;function Gs(e){xa.call(this),e.length<2&&console.warn("THREE.CatmullRomCurve3: Points array needs at least two entries."),this.points=e||[],this.closed=!1}function Ws(e,t,i,r){xa.call(this),this.v0=e,this.v1=t,this.v2=i,this.v3=r}function Xs(e,t,i){xa.call(this),this.v0=e,this.v1=t,this.v2=i}function Ys(e,t){xa.call(this),this.v1=e,this.v2=t}function qs(e,t,i,r,n,o){Ta.call(this,e,t,i,i,r,n,o)}Gs.prototype=Object.create(xa.prototype),Gs.prototype.constructor=Gs,Gs.prototype.getPoint=function(e){var t,i,r,n,o=this.points,a=o.length,s=(a-(this.closed?0:1))*e,c=Math.floor(s),l=s-c;if(this.closed?c+=c>0?0:(Math.floor(Math.abs(c)/o.length)+1)*o.length:0===l&&c===a-1&&(c=a-2,l=1),this.closed||c>0?t=o[(c-1)%a]:(Fs.subVectors(o[0],o[1]).add(o[0]),t=Fs),i=o[c%a],r=o[(c+1)%a],this.closed||c+2<a?n=o[(c+2)%a]:(Fs.subVectors(o[a-1],o[a-2]).add(o[a-1]),n=Fs),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){var h="chordal"===this.type?.5:.25,u=Math.pow(t.distanceToSquared(i),h),d=Math.pow(i.distanceToSquared(r),h),p=Math.pow(r.distanceToSquared(n),h);d<1e-4&&(d=1),u<1e-4&&(u=d),p<1e-4&&(p=d),zs.initNonuniformCatmullRom(t.x,i.x,r.x,n.x,u,d,p),js.initNonuniformCatmullRom(t.y,i.y,r.y,n.y,u,d,p),ks.initNonuniformCatmullRom(t.z,i.z,r.z,n.z,u,d,p)}else if("catmullrom"===this.type){var f=void 0!==this.tension?this.tension:.5;zs.initCatmullRom(t.x,i.x,r.x,n.x,f),js.initCatmullRom(t.y,i.y,r.y,n.y,f),ks.initCatmullRom(t.z,i.z,r.z,n.z,f)}return new Mt(zs.calc(l),js.calc(l),ks.calc(l))},Ws.prototype=Object.create(xa.prototype),Ws.prototype.constructor=Ws,Ws.prototype.getPoint=function(e){var t=this.v0,i=this.v1,r=this.v2,n=this.v3;return new Mt(Ea(e,t.x,i.x,r.x,n.x),Ea(e,t.y,i.y,r.y,n.y),Ea(e,t.z,i.z,r.z,n.z))},Xs.prototype=Object.create(xa.prototype),Xs.prototype.constructor=Xs,Xs.prototype.getPoint=function(e){var t=this.v0,i=this.v1,r=this.v2;return new Mt(ya(e,t.x,i.x,r.x),ya(e,t.y,i.y,r.y),ya(e,t.z,i.z,r.z))},Ys.prototype=Object.create(xa.prototype),Ys.prototype.constructor=Ys,Ys.prototype.getPoint=function(e){if(1===e)return this.v2.clone();var t=new Mt;return t.subVectors(this.v2,this.v1),t.multiplyScalar(e),t.add(this.v1),t},qs.prototype=Object.create(Ta.prototype),qs.prototype.constructor=qs;var Zs={createMultiMaterialObject:function(e,t){for(var i=new wn,r=0,n=t.length;r<n;r++)i.add(new Hr(e,t[r]));return i},detach:function(e,t,i){e.applyMatrix(t.matrixWorld),t.remove(e),i.add(e)},attach:function(e,t,i){e.applyMatrix((new St).getInverse(i.matrixWorld)),t.remove(e),i.add(e)}};function Js(e){console.warn("THREE.ClosedSplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),Gs.call(this,e),this.type="catmullrom",this.closed=!0}function Qs(e){console.warn("THREE.SplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),Gs.call(this,e),this.type="catmullrom"}function Ks(e){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),Gs.call(this,e),this.type="catmullrom"}xa.create=function(e,t){return console.log("THREE.Curve.create() has been deprecated"),e.prototype=Object.create(xa.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},Js.prototype=Object.create(Gs.prototype),Qs.prototype=Object.create(Gs.prototype),Ks.prototype=Object.create(Gs.prototype),Object.assign(Ks.prototype,{initFromArray:function(e){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(e){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(e){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),Ds.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},Ss.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Object.assign(Ei.prototype,{center:function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},size:function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)}}),Object.assign(Ii.prototype,{center:function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionSphere:function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},size:function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)}}),Lr.prototype.center=function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)},ht.random16=function(){return console.warn("THREE.Math.random16() has been deprecated. Use Math.random() instead."),Math.random()},Object.assign(Ui.prototype,{flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},multiplyVector3:function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(e){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},applyToBuffer:function(e,t,i){return console.warn("THREE.Matrix3: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(e,t,i){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")}}),Object.assign(St.prototype,{extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},getPosition:function(){var e;return function(){return void 0===e&&(e=new Mt),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),e.setFromMatrixColumn(this,3)}}(),setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(e){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBuffer:function(e,t,i){return console.warn("THREE.Matrix4: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(e,t,i){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(e,t,i,r,n,o){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(e,t,r,i,n,o)}}),Ni.prototype.isIntersectionLine=function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)},Tt.prototype.multiplyVector3=function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},Object.assign(Cr.prototype,{isIntersectionBox:function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionPlane:function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},isIntersectionSphere:function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)}}),Object.assign(Ca.prototype,{extrude:function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new Xn(this,e)},makeGeometry:function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new io(this,e)}}),Object.assign(ut.prototype,{fromAttribute:function(e,t,i){return console.error("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),Object.assign(Mt.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},applyProjection:function(e){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(e)},fromAttribute:function(e,t,i){return console.error("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),Object.assign(xt.prototype,{fromAttribute:function(e,t,i){return console.error("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),ur.prototype.computeTangents=function(){console.warn("THREE.Geometry: .computeTangents() has been removed.")},Object.assign(Zi.prototype,{getChildByName:function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)}}),Object.defineProperties(Zi.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.defineProperties(dn.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(pn.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),Object.defineProperty(xa.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(e){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=e}}),Ki.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Po.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(dr.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}}}),Object.assign(Mr.prototype,{addIndex:function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},addDrawCall:function(e,t,i){void 0!==i&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")}}),Object.defineProperties(Mr.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(hs.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(Li.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new fi}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===e}}}),Object.defineProperties(vo.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(Pi.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),Object.assign(on.prototype,{getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},getMaxAnisotropy:function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},getPrecision:function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(on.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),Object.defineProperties(Fi.prototype,{cullFace:{get:function(){return this.renderReverseSided?u:h},set:function(e){var t=e!==h;console.warn("WebGLRenderer: .shadowMap.cullFace is deprecated. Set .shadowMap.renderReverseSided to "+t+"."),this.renderReverseSided=t}}}),Object.defineProperties(bt.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),ts.prototype.load=function(e){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");var t=this;return(new Qa).load(e,function(e){t.setBuffer(e)}),this},rs.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()},$a.prototype.updateCubeMap=function(e,t){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(e,t)};var $s={merge:function(e,t,i){var r;console.warn("THREE.GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead."),t.isMesh&&(t.matrixAutoUpdate&&t.updateMatrix(),r=t.matrix,t=t.geometry),e.merge(t,r,i)},center:function(e){return console.warn("THREE.GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),e.center()}},ec={crossOrigin:void 0,loadTexture:function(e,t,i,r){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");var n=new Lo;n.setCrossOrigin(this.crossOrigin);var o=n.load(e,i,void 0,r);return t&&(o.mapping=t),o},loadTextureCube:function(e,t,i,r){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");var n=new Co;n.setCrossOrigin(this.crossOrigin);var o=n.load(e,i,void 0,r);return t&&(o.mapping=t),o},loadCompressedTexture:function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},loadCompressedTextureCube:function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")}};e.WebGLRenderTargetCube=wt,e.WebGLRenderTarget=bt,e.WebGLRenderer=on,e.ShaderLib=yi,e.UniformsLib=mi,e.UniformsUtils=gi,e.ShaderChunk=vi,e.FogExp2=an,e.Fog=sn,e.Scene=cn,e.LensFlare=ln,e.Sprite=un,e.LOD=dn,e.SkinnedMesh=mn,e.Skeleton=pn,e.Bone=fn,e.Mesh=Hr,e.LineSegments=yn,e.LineLoop=En,e.Line=vn,e.Points=bn,e.Group=wn,e.VideoTexture=Tn,e.DataTexture=Rt,e.CompressedTexture=Mn,e.CubeTexture=At,e.CanvasTexture=bi,e.DepthTexture=Sn,e.Texture=Et,e.CompressedTextureLoader=Ao,e.DataTextureLoader=_o,e.CubeTextureLoader=Co,e.TextureLoader=Lo,e.ObjectLoader=pa,e.MaterialLoader=na,e.BufferGeometryLoader=oa,e.DefaultLoadingManager=So,e.LoadingManager=Mo,e.JSONLoader=da,e.ImageLoader=Do,e.FontLoader=Ha,e.FileLoader=Ro,e.Loader=ua,e.Cache=To,e.AudioLoader=Qa,e.SpotLightShadow=Io,e.SpotLight=Oo,e.PointLight=Uo,e.RectAreaLight=zo,e.HemisphereLight=Ho,e.DirectionalLightShadow=No,e.DirectionalLight=Vo,e.AmbientLight=Fo,e.LightShadow=Bo,e.Light=Po,e.StereoCamera=Ka,e.PerspectiveCamera=Ki,e.OrthographicCamera=Qi,e.CubeCamera=$a,e.ArrayCamera=rn,e.Camera=Ji,e.AudioListener=es,e.PositionalAudio=is,e.AudioContext=Ja,e.AudioAnalyser=rs,e.Audio=ts,e.VectorKeyframeTrack=Zo,e.StringKeyframeTrack=$o,e.QuaternionKeyframeTrack=Qo,e.NumberKeyframeTrack=Ko,e.ColorKeyframeTrack=ta,e.BooleanKeyframeTrack=ea,e.PropertyMixer=ns,e.PropertyBinding=as,e.KeyframeTrack=ia,e.AnimationUtils=ko,e.AnimationObjectGroup=ss,e.AnimationMixer=ls,e.AnimationClip=ra,e.Uniform=hs,e.InstancedBufferGeometry=us,e.BufferGeometry=Mr,e.GeometryIdCount=hr,e.Geometry=ur,e.InterleavedBufferAttribute=ds,e.InstancedInterleavedBuffer=fs,e.InterleavedBuffer=ps,e.InstancedBufferAttribute=ms,e.Face3=$i,e.Object3D=Zi,e.Raycaster=gs,e.Layers=ki,e.EventDispatcher=t,e.Clock=Es,e.QuaternionLinearInterpolant=Jo,e.LinearInterpolant=Xo,e.DiscreteInterpolant=Yo,e.CubicInterpolant=Wo,e.Interpolant=Go,e.Triangle=Pr,e.Math=ht,e.Spherical=xs,e.Cylindrical=bs,e.Plane=Ni,e.Frustum=Vi,e.Sphere=Oi,e.Ray=Cr,e.Matrix4=St,e.Matrix3=Ui,e.Box3=Ii,e.Box2=Ei,e.Line3=Lr,e.Euler=ji,e.Vector4=xt,e.Vector3=Mt,e.Vector2=ut,e.Quaternion=Tt,e.Color=fi,e.ImmediateRenderObject=ws,e.VertexNormalsHelper=Ts,e.SpotLightHelper=Ms,e.SkeletonHelper=Ss,e.PointLightHelper=Rs,e.RectAreaLightHelper=As,e.HemisphereLightHelper=_s,e.GridHelper=Ds,e.PolarGridHelper=Cs,e.FaceNormalsHelper=Ls,e.DirectionalLightHelper=Ps,e.CameraHelper=Hs,e.BoxHelper=Bs,e.Box3Helper=Is,e.PlaneHelper=Os,e.ArrowHelper=Us,e.AxisHelper=Ns,e.CatmullRomCurve3=Gs,e.CubicBezierCurve3=Ws,e.QuadraticBezierCurve3=Xs,e.LineCurve3=Ys,e.ArcCurve=qs,e.EllipseCurve=Ta,e.SplineCurve=Ma,e.CubicBezierCurve=Sa,e.QuadraticBezierCurve=Ra,e.LineCurve=ba,e.Shape=Ca,e.Path=Da,e.ShapePath=La,e.Font=Pa,e.CurvePath=wa,e.Curve=xa,e.ShapeUtils=Wn,e.SceneUtils=Zs,e.WebGLUtils=nn,e.WireframeGeometry=Rn,e.ParametricGeometry=An,e.ParametricBufferGeometry=_n,e.TetrahedronGeometry=Ln,e.TetrahedronBufferGeometry=Pn,e.OctahedronGeometry=Hn,e.OctahedronBufferGeometry=Bn,e.IcosahedronGeometry=In,e.IcosahedronBufferGeometry=On,e.DodecahedronGeometry=Un,e.DodecahedronBufferGeometry=Nn,e.PolyhedronGeometry=Dn,e.PolyhedronBufferGeometry=Cn,e.TubeGeometry=Vn,e.TubeBufferGeometry=Fn,e.TorusKnotGeometry=zn,e.TorusKnotBufferGeometry=jn,e.TorusGeometry=kn,e.TorusBufferGeometry=Gn,e.TextGeometry=qn,e.TextBufferGeometry=Zn,e.SphereGeometry=Jn,e.SphereBufferGeometry=Qn,e.RingGeometry=Kn,e.RingBufferGeometry=$n,e.PlaneGeometry=Ar,e.PlaneBufferGeometry=_r,e.LatheGeometry=eo,e.LatheBufferGeometry=to,e.ShapeGeometry=io,e.ShapeBufferGeometry=ro,e.ExtrudeGeometry=Xn,e.ExtrudeBufferGeometry=Yn,e.EdgesGeometry=no,e.ConeGeometry=so,e.ConeBufferGeometry=co,e.CylinderGeometry=oo,e.CylinderBufferGeometry=ao,e.CircleGeometry=lo,e.CircleBufferGeometry=ho,e.BoxGeometry=Sr,e.BoxBufferGeometry=Rr,e.ShadowMaterial=po,e.SpriteMaterial=hn,e.RawShaderMaterial=fo,e.ShaderMaterial=Pi,e.PointsMaterial=xn,e.MeshPhysicalMaterial=go,e.MeshStandardMaterial=mo,e.MeshPhongMaterial=vo,e.MeshToonMaterial=yo,e.MeshNormalMaterial=Eo,e.MeshLambertMaterial=xo,e.MeshDepthMaterial=Hi,e.MeshDistanceMaterial=Bi,e.MeshBasicMaterial=Dr,e.LineDashedMaterial=bo,e.LineBasicMaterial=gn,e.Material=Li,e.Float64BufferAttribute=br,e.Float32BufferAttribute=xr,e.Uint32BufferAttribute=Er,e.Int32BufferAttribute=yr,e.Uint16BufferAttribute=vr,e.Int16BufferAttribute=gr,e.Uint8ClampedBufferAttribute=mr,e.Uint8BufferAttribute=fr,e.Int8BufferAttribute=pr,e.BufferAttribute=dr,e.REVISION=c,e.MOUSE={LEFT:0,MIDDLE:1,RIGHT:2},e.CullFaceNone=l,e.CullFaceBack=h,e.CullFaceFront=u,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=d,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=p,e.PCFSoftShadowMap=f,e.FrontSide=m,e.BackSide=g,e.DoubleSide=v,e.FlatShading=1,e.SmoothShading=2,e.NoColors=y,e.FaceColors=E,e.VertexColors=x,e.NoBlending=b,e.NormalBlending=w,e.AdditiveBlending=T,e.SubtractiveBlending=M,e.MultiplyBlending=S,e.CustomBlending=R,e.AddEquation=A,e.SubtractEquation=_,e.ReverseSubtractEquation=D,e.MinEquation=C,e.MaxEquation=L,e.ZeroFactor=P,e.OneFactor=H,e.SrcColorFactor=B,e.OneMinusSrcColorFactor=I,e.SrcAlphaFactor=O,e.OneMinusSrcAlphaFactor=U,e.DstAlphaFactor=N,e.OneMinusDstAlphaFactor=V,e.DstColorFactor=F,e.OneMinusDstColorFactor=z,e.SrcAlphaSaturateFactor=j,e.NeverDepth=k,e.AlwaysDepth=G,e.LessDepth=W,e.LessEqualDepth=X,e.EqualDepth=Y,e.GreaterEqualDepth=q,e.GreaterDepth=Z,e.NotEqualDepth=J,e.MultiplyOperation=Q,e.MixOperation=K,e.AddOperation=$,e.NoToneMapping=ee,e.LinearToneMapping=te,e.ReinhardToneMapping=ie,e.Uncharted2ToneMapping=re,e.CineonToneMapping=ne,e.UVMapping=300,e.CubeReflectionMapping=oe,e.CubeRefractionMapping=ae,e.EquirectangularReflectionMapping=se,e.EquirectangularRefractionMapping=ce,e.SphericalReflectionMapping=le,e.CubeUVReflectionMapping=he,e.CubeUVRefractionMapping=ue,e.RepeatWrapping=de,e.ClampToEdgeWrapping=pe,e.MirroredRepeatWrapping=fe,e.NearestFilter=me,e.NearestMipMapNearestFilter=ge,e.NearestMipMapLinearFilter=ve,e.LinearFilter=ye,e.LinearMipMapNearestFilter=Ee,e.LinearMipMapLinearFilter=xe,e.UnsignedByteType=be,e.ByteType=we,e.ShortType=Te,e.UnsignedShortType=Me,e.IntType=Se,e.UnsignedIntType=Re,e.FloatType=Ae,e.HalfFloatType=_e,e.UnsignedShort4444Type=De,e.UnsignedShort5551Type=Ce,e.UnsignedShort565Type=Le,e.UnsignedInt248Type=Pe,e.AlphaFormat=He,e.RGBFormat=Be,e.RGBAFormat=Ie,e.LuminanceFormat=Oe,e.LuminanceAlphaFormat=Ue,e.RGBEFormat=Ne,e.DepthFormat=Ve,e.DepthStencilFormat=Fe,e.RGB_S3TC_DXT1_Format=ze,e.RGBA_S3TC_DXT1_Format=je,e.RGBA_S3TC_DXT3_Format=ke,e.RGBA_S3TC_DXT5_Format=Ge,e.RGB_PVRTC_4BPPV1_Format=We,e.RGB_PVRTC_2BPPV1_Format=Xe,e.RGBA_PVRTC_4BPPV1_Format=Ye,e.RGBA_PVRTC_2BPPV1_Format=qe,e.RGB_ETC1_Format=Ze,e.LoopOnce=2200,e.LoopRepeat=Je,e.LoopPingPong=2202,e.InterpolateDiscrete=2300,e.InterpolateLinear=2301,e.InterpolateSmooth=2302,e.ZeroCurvatureEnding=Qe,e.ZeroSlopeEnding=2401,e.WrapAroundEnding=2402,e.TrianglesDrawMode=Ke,e.TriangleStripDrawMode=$e,e.TriangleFanDrawMode=et,e.LinearEncoding=tt,e.sRGBEncoding=it,e.GammaEncoding=rt,e.RGBEEncoding=nt,e.LogLuvEncoding=3003,e.RGBM7Encoding=ot,e.RGBM16Encoding=at,e.RGBDEncoding=st,e.BasicDepthPacking=ct,e.RGBADepthPacking=lt,e.CubeGeometry=Sr,e.Face4=function(e,t,i,r,n,o,a){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new $i(e,t,i,n,o,a)},e.LineStrip=0,e.LinePieces=1,e.MeshFaceMaterial=function(e){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),e},e.MultiMaterial=function(e){return void 0===e&&(e=[]),console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),e.isMultiMaterial=!0,e.materials=e,e.clone=function(){return e.slice()},e},e.PointCloud=function(e,t){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new bn(e,t)},e.Particle=function(e){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new un(e)},e.ParticleSystem=function(e,t){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new bn(e,t)},e.PointCloudMaterial=function(e){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new xn(e)},e.ParticleBasicMaterial=function(e){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new xn(e)},e.ParticleSystemMaterial=function(e){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new xn(e)},e.Vertex=function(e,t,i){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new Mt(e,t,i)},e.DynamicBufferAttribute=function(e,t){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setDynamic( true ) instead."),new dr(e,t).setDynamic(!0)},e.Int8Attribute=function(e,t){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new pr(e,t)},e.Uint8Attribute=function(e,t){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new fr(e,t)},e.Uint8ClampedAttribute=function(e,t){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new mr(e,t)},e.Int16Attribute=function(e,t){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new gr(e,t)},e.Uint16Attribute=function(e,t){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new vr(e,t)},e.Int32Attribute=function(e,t){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new yr(e,t)},e.Uint32Attribute=function(e,t){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new Er(e,t)},e.Float32Attribute=function(e,t){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new xr(e,t)},e.Float64Attribute=function(e,t){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new br(e,t)},e.ClosedSplineCurve3=Js,e.SplineCurve3=Qs,e.Spline=Ks,e.BoundingBoxHelper=function(e,t){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new Bs(e,t)},e.EdgesHelper=function(e,t){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new yn(new no(e.geometry),new gn({color:void 0!==t?t:16777215}))},e.WireframeHelper=function(e,t){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new yn(new Rn(e.geometry),new gn({color:void 0!==t?t:16777215}))},e.XHRLoader=function(e){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new Ro(e)},e.BinaryTextureLoader=function(e){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new _o(e)},e.GeometryUtils=$s,e.ImageUtils=ec,e.Projector=function(){console.error("THREE.Projector has been moved to /examples/js/renderers/Projector.js."),this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")}},e.CanvasRenderer=function(){console.error("THREE.CanvasRenderer has been moved to /examples/js/renderers/CanvasRenderer.js"),this.domElement=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.clear=function(){},this.render=function(){},this.setClearColor=function(){},this.setSize=function(){}},Object.defineProperty(e,"__esModule",{value:!0})});var System={browser:function(){var e=navigator.userAgent;return/Arora/i.test(e)?"Arora":/Chrome/i.test(e)?"Chrome":/Epiphany/i.test(e)?"Epiphany":/Firefox/i.test(e)?"Firefox":/Mobile(\/.*)? Safari/i.test(e)?"Mobile Safari":/MSIE/i.test(e)?"Internet Explorer":/Midori/i.test(e)?"Midori":/Opera/.test(e)?"Opera":!!/Safari/i.test(e)&&"Safari"}(),os:function(){var e=navigator.userAgent;return/Android/i.test(e)?"Android":/CrOS/i.test(e)?"Chrome OS":/iP[ao]d|iPhone/i.test(e)?"iOS":/Linux/i.test(e)?"Linux":/Mac OS/i.test(e)?"Mac OS":!!/windows/i.test(e)&&"Windows"}(),support:{canvas:!!window.CanvasRenderingContext2D,localStorage:function(){try{return!!window.localStorage.getItem}catch(e){return!1}}(),file:!!(window.File&&window.FileReader&&window.FileList&&window.Blob),fileSystem:!!window.requestFileSystem||!!window.webkitRequestFileSystem,getUserMedia:!!(window.navigator.getUserMedia||window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia||window.navigator.msGetUserMedia),requestAnimationFrame:!!(window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame),sessionStorage:function(){try{return!!window.sessionStorage.getItem}catch(e){return!1}}(),webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}}(),worker:!!window.Worker}};!function(){"use strict";var e=function(e){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.FrontSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};(e.prototype=Object.create(THREE.MeshBasicMaterial.prototype)).constructor=e;var t=function(e){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};(t.prototype=Object.create(THREE.LineBasicMaterial.prototype)).constructor=t;var i=new e({visible:!1,transparent:!1});THREE.TransformGizmo=function(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var e=new THREE.PlaneBufferGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),i={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};for(var r in this.activePlane=i.XYZE,i.YZ.rotation.set(0,Math.PI/2,0),i.XZ.rotation.set(-Math.PI/2,0,0),i)i[r].name=r,this.planes.add(i[r]),this.planes[r]=i[r];var n=function(e,t){for(var i in e)for(r=e[i].length;r--;){var n=e[i][r][0],o=e[i][r][1],a=e[i][r][2];n.name=i,o&&n.position.set(o[0],o[1],o[2]),a&&n.rotation.set(a[0],a[1],a[2]),t.add(n)}};n(this.handleGizmos,this.handles),n(this.pickerGizmos,this.pickers),this.traverse(function(e){if(e instanceof THREE.Mesh){e.updateMatrix();var t=e.geometry.clone();t.applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}})},this.highlight=function(e){this.traverse(function(t){t.material&&t.material.highlight&&(t.name===e?t.material.highlight(!0):t.material.highlight(!1))})}},THREE.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformGizmo.prototype.constructor=THREE.TransformGizmo,THREE.TransformGizmo.prototype.update=function(e,t){var i=new THREE.Vector3(0,0,0),r=new THREE.Vector3(0,1,0),n=new THREE.Matrix4;this.traverse(function(o){-1!==o.name.search("E")?o.quaternion.setFromRotationMatrix(n.lookAt(t,i,r)):-1===o.name.search("X")&&-1===o.name.search("Y")&&-1===o.name.search("Z")||o.quaternion.setFromEuler(e)})},THREE.TransformGizmoTranslate=function(){THREE.TransformGizmo.call(this);var r=new THREE.Geometry,n=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));n.position.y=.5,n.updateMatrix(),r.merge(n.geometry,n.matrix);var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(r,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(o,new t({color:16711680}))]],Y:[[new THREE.Mesh(r,new e({color:65280})),[0,.5,0]],[new THREE.Line(a,new t({color:65280}))]],Z:[[new THREE.Mesh(r,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(s,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new e({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),i)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()},THREE.TransformGizmoTranslate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoTranslate.prototype.constructor=THREE.TransformGizmoTranslate,THREE.TransformGizmoRotate=function(){THREE.TransformGizmo.call(this);var e=function(e,t,i){var r=new THREE.BufferGeometry,n=[];i=i||1;for(var o=0;o<=64*i;++o)"x"===t&&n.push(0,Math.cos(o/32*Math.PI)*e,Math.sin(o/32*Math.PI)*e),"y"===t&&n.push(Math.cos(o/32*Math.PI)*e,0,Math.sin(o/32*Math.PI)*e),"z"===t&&n.push(Math.sin(o/32*Math.PI)*e,Math.cos(o/32*Math.PI)*e,0);return r.addAttribute("position",new THREE.Float32BufferAttribute(n,3)),r};this.handleGizmos={X:[[new THREE.Line(new e(1,"x",.5),new t({color:16711680}))]],Y:[[new THREE.Line(new e(1,"y",.5),new t({color:65280}))]],Z:[[new THREE.Line(new e(1,"z",.5),new t({color:255}))]],E:[[new THREE.Line(new e(1.25,"z",1),new t({color:13421568}))]],XYZE:[[new THREE.Line(new e(1,"z",1),new t({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,.12,2,24),i)]],XYZE:[[new THREE.Mesh]]},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){THREE.TransformGizmo.prototype.update.apply(this,arguments);var i=new THREE.Matrix4,r=new THREE.Euler(0,0,1),n=new THREE.Quaternion,o=new THREE.Vector3(1,0,0),a=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),c=new THREE.Quaternion,l=new THREE.Quaternion,h=new THREE.Quaternion,u=t.clone();r.copy(this.planes.XY.rotation),n.setFromEuler(r),i.makeRotationFromQuaternion(n).getInverse(i),u.applyMatrix4(i),this.traverse(function(e){n.setFromEuler(r),"X"===e.name&&(c.setFromAxisAngle(o,Math.atan2(-u.y,u.z)),n.multiplyQuaternions(n,c),e.quaternion.copy(n)),"Y"===e.name&&(l.setFromAxisAngle(a,Math.atan2(u.x,u.z)),n.multiplyQuaternions(n,l),e.quaternion.copy(n)),"Z"===e.name&&(h.setFromAxisAngle(s,Math.atan2(u.y,u.x)),n.multiplyQuaternions(n,h),e.quaternion.copy(n))})},this.init()},THREE.TransformGizmoRotate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoRotate.prototype.constructor=THREE.TransformGizmoRotate,THREE.TransformGizmoScale=function(){THREE.TransformGizmo.call(this);var r=new THREE.Geometry,n=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));n.position.y=.5,n.updateMatrix(),r.merge(n.geometry,n.matrix);var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(r,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(o,new t({color:16711680}))]],Y:[[new THREE.Mesh(r,new e({color:65280})),[0,.5,0]],[new THREE.Line(a,new t({color:65280}))]],Z:[[new THREE.Mesh(r,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(s,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),new e({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.4,.4,.4),i)]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()},THREE.TransformGizmoScale.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoScale.prototype.constructor=THREE.TransformGizmoScale,THREE.TransformControls=function(e,t){THREE.Object3D.call(this),t=void 0!==t?t:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null;var i=this,r="translate",n=!1,o={translate:new THREE.TransformGizmoTranslate,rotate:new THREE.TransformGizmoRotate,scale:new THREE.TransformGizmoScale};for(var a in o){var s=o[a];s.visible=a===r,this.add(s)}var c={type:"change"},l={type:"mouseDown"},h={type:"mouseUp",mode:r},u={type:"objectChange"},d=new THREE.Raycaster,p=new THREE.Vector2,f=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3,y=1,E=new THREE.Matrix4,x=new THREE.Vector3,b=new THREE.Matrix4,w=new THREE.Vector3,T=new THREE.Quaternion,M=new THREE.Vector3(1,0,0),S=new THREE.Vector3(0,1,0),R=new THREE.Vector3(0,0,1),A=new THREE.Quaternion,_=new THREE.Quaternion,D=new THREE.Quaternion,C=new THREE.Quaternion,L=new THREE.Quaternion,P=new THREE.Vector3,H=new THREE.Vector3,B=new THREE.Matrix4,I=new THREE.Matrix4,O=new THREE.Vector3,U=new THREE.Vector3,N=new THREE.Euler,V=new THREE.Matrix4,F=new THREE.Vector3,z=new THREE.Euler;function j(e){if(void 0!==i.object&&!0!==n&&(void 0===e.button||0===e.button)){var t=X(e.changedTouches?e.changedTouches[0]:e,o[r].pickers.children),a=null;t&&(a=t.object.name,e.preventDefault()),i.axis!==a&&(i.axis=a,i.update(),i.dispatchEvent(c))}}function k(e){if(void 0!==i.object&&!0!==n&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e;if(0===t.button||void 0===t.button){var a=X(t,o[r].pickers.children);if(a){e.preventDefault(),e.stopPropagation(),i.dispatchEvent(l),i.axis=a.object.name,i.update(),x.copy(F).sub(U).normalize(),o[r].setActivePlane(i.axis,x);var s=X(t,[o[r].activePlane]);s&&(P.copy(i.object.position),H.copy(i.object.scale),B.extractRotation(i.object.matrix),V.extractRotation(i.object.matrixWorld),I.extractRotation(i.object.parent.matrixWorld),O.setFromMatrixScale(b.getInverse(i.object.parent.matrixWorld)),m.copy(s.point))}}n=!0}}function G(e){if(void 0!==i.object&&null!==i.axis&&!1!==n&&(void 0===e.button||0===e.button)){var t=X(e.changedTouches?e.changedTouches[0]:e,[o[r].activePlane]);!1!==t&&(e.preventDefault(),e.stopPropagation(),f.copy(t.point),"translate"===r?(f.sub(m),f.multiply(O),"local"===i.space&&(f.applyMatrix4(b.getInverse(V)),-1===i.axis.search("X")&&(f.x=0),-1===i.axis.search("Y")&&(f.y=0),-1===i.axis.search("Z")&&(f.z=0),f.applyMatrix4(B),i.object.position.copy(P),i.object.position.add(f)),"world"!==i.space&&-1===i.axis.search("XYZ")||(-1===i.axis.search("X")&&(f.x=0),-1===i.axis.search("Y")&&(f.y=0),-1===i.axis.search("Z")&&(f.z=0),f.applyMatrix4(b.getInverse(I)),i.object.position.copy(P),i.object.position.add(f)),null!==i.translationSnap&&("local"===i.space&&i.object.position.applyMatrix4(b.getInverse(V)),-1!==i.axis.search("X")&&(i.object.position.x=Math.round(i.object.position.x/i.translationSnap)*i.translationSnap),-1!==i.axis.search("Y")&&(i.object.position.y=Math.round(i.object.position.y/i.translationSnap)*i.translationSnap),-1!==i.axis.search("Z")&&(i.object.position.z=Math.round(i.object.position.z/i.translationSnap)*i.translationSnap),"local"===i.space&&i.object.position.applyMatrix4(V))):"scale"===r?(f.sub(m),f.multiply(O),"local"===i.space&&("XYZ"===i.axis?(y=1+f.y/Math.max(H.x,H.y,H.z),i.object.scale.x=H.x*y,i.object.scale.y=H.y*y,i.object.scale.z=H.z*y):(f.applyMatrix4(b.getInverse(V)),"X"===i.axis&&(i.object.scale.x=H.x*(1+f.x/H.x)),"Y"===i.axis&&(i.object.scale.y=H.y*(1+f.y/H.y)),"Z"===i.axis&&(i.object.scale.z=H.z*(1+f.z/H.z))))):"rotate"===r&&(f.sub(U),f.multiply(O),w.copy(m).sub(U),w.multiply(O),"E"===i.axis?(f.applyMatrix4(b.getInverse(E)),w.applyMatrix4(b.getInverse(E)),g.set(Math.atan2(f.z,f.y),Math.atan2(f.x,f.z),Math.atan2(f.y,f.x)),v.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),T.setFromRotationMatrix(b.getInverse(I)),L.setFromAxisAngle(x,g.z-v.z),A.setFromRotationMatrix(V),T.multiplyQuaternions(T,L),T.multiplyQuaternions(T,A),i.object.quaternion.copy(T)):"XYZE"===i.axis?(L.setFromEuler(f.clone().cross(w).normalize()),T.setFromRotationMatrix(b.getInverse(I)),_.setFromAxisAngle(L,-f.clone().angleTo(w)),A.setFromRotationMatrix(V),T.multiplyQuaternions(T,_),T.multiplyQuaternions(T,A),i.object.quaternion.copy(T)):"local"===i.space?(f.applyMatrix4(b.getInverse(V)),w.applyMatrix4(b.getInverse(V)),g.set(Math.atan2(f.z,f.y),Math.atan2(f.x,f.z),Math.atan2(f.y,f.x)),v.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),A.setFromRotationMatrix(B),null!==i.rotationSnap?(_.setFromAxisAngle(M,Math.round((g.x-v.x)/i.rotationSnap)*i.rotationSnap),D.setFromAxisAngle(S,Math.round((g.y-v.y)/i.rotationSnap)*i.rotationSnap),C.setFromAxisAngle(R,Math.round((g.z-v.z)/i.rotationSnap)*i.rotationSnap)):(_.setFromAxisAngle(M,g.x-v.x),D.setFromAxisAngle(S,g.y-v.y),C.setFromAxisAngle(R,g.z-v.z)),"X"===i.axis&&A.multiplyQuaternions(A,_),"Y"===i.axis&&A.multiplyQuaternions(A,D),"Z"===i.axis&&A.multiplyQuaternions(A,C),i.object.quaternion.copy(A)):"world"===i.space&&(g.set(Math.atan2(f.z,f.y),Math.atan2(f.x,f.z),Math.atan2(f.y,f.x)),v.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),T.setFromRotationMatrix(b.getInverse(I)),null!==i.rotationSnap?(_.setFromAxisAngle(M,Math.round((g.x-v.x)/i.rotationSnap)*i.rotationSnap),D.setFromAxisAngle(S,Math.round((g.y-v.y)/i.rotationSnap)*i.rotationSnap),C.setFromAxisAngle(R,Math.round((g.z-v.z)/i.rotationSnap)*i.rotationSnap)):(_.setFromAxisAngle(M,g.x-v.x),D.setFromAxisAngle(S,g.y-v.y),C.setFromAxisAngle(R,g.z-v.z)),A.setFromRotationMatrix(V),"X"===i.axis&&T.multiplyQuaternions(T,_),"Y"===i.axis&&T.multiplyQuaternions(T,D),"Z"===i.axis&&T.multiplyQuaternions(T,C),T.multiplyQuaternions(T,A),i.object.quaternion.copy(T))),i.update(),i.dispatchEvent(c),i.dispatchEvent(u))}}function W(e){e.preventDefault(),void 0!==e.button&&0!==e.button||(n&&null!==i.axis&&(h.mode=r,i.dispatchEvent(h)),n=!1,"TouchEvent"in window&&e instanceof TouchEvent?(i.axis=null,i.update(),i.dispatchEvent(c)):j(e))}function X(i,r){var n=t.getBoundingClientRect(),o=(i.clientX-n.left)/n.width,a=(i.clientY-n.top)/n.height;p.set(2*o-1,-2*a+1),d.setFromCamera(p,e);var s=d.intersectObjects(r,!0);return!!s[0]&&s[0]}t.addEventListener("mousedown",k,!1),t.addEventListener("touchstart",k,!1),t.addEventListener("mousemove",j,!1),t.addEventListener("touchmove",j,!1),t.addEventListener("mousemove",G,!1),t.addEventListener("touchmove",G,!1),t.addEventListener("mouseup",W,!1),t.addEventListener("mouseout",W,!1),t.addEventListener("touchend",W,!1),t.addEventListener("touchcancel",W,!1),t.addEventListener("touchleave",W,!1),this.dispose=function(){t.removeEventListener("mousedown",k),t.removeEventListener("touchstart",k),t.removeEventListener("mousemove",j),t.removeEventListener("touchmove",j),t.removeEventListener("mousemove",G),t.removeEventListener("touchmove",G),t.removeEventListener("mouseup",W),t.removeEventListener("mouseout",W),t.removeEventListener("touchend",W),t.removeEventListener("touchcancel",W),t.removeEventListener("touchleave",W)},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return r},this.setMode=function(e){for(var t in"scale"===(r=e||r)&&(i.space="local"),o)o[t].visible=t===r;this.update(),i.dispatchEvent(c)},this.setTranslationSnap=function(e){i.translationSnap=e},this.setRotationSnap=function(e){i.rotationSnap=e},this.setSize=function(e){i.size=e,this.update(),i.dispatchEvent(c)},this.setSpace=function(e){i.space=e,this.update(),i.dispatchEvent(c)},this.update=function(){void 0!==i.object&&(i.object.updateMatrixWorld(),U.setFromMatrixPosition(i.object.matrixWorld),N.setFromRotationMatrix(b.extractRotation(i.object.matrixWorld)),e.updateMatrixWorld(),F.setFromMatrixPosition(e.matrixWorld),z.setFromRotationMatrix(b.extractRotation(e.matrixWorld)),y=U.distanceTo(F)/6*i.size,this.position.copy(U),this.scale.set(y,y,y),e instanceof THREE.PerspectiveCamera?x.copy(F).sub(U).normalize():e instanceof THREE.OrthographicCamera&&x.copy(F).normalize(),"local"===i.space?o[r].update(N,x):"world"===i.space&&o[r].update(new THREE.Euler,x),o[r].highlight(i.axis))}},THREE.TransformControls.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformControls.prototype.constructor=THREE.TransformControls}(),THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec4 rgbA = (1.0/2.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (1.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (2.0/3.0 - 0.5)));","vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (0.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (3.0/3.0 - 0.5)));","float lumaB = dot(rgbB, vec4(luma, 0.0));","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = rgbA;","} else {","gl_FragColor = rgbB;","}","}"].join("\n")},THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var e,t,i,r,n,o,a,s,c,l,h,u=[],d=0,p=[],f=0,m=[],g=0,v=[],y=0,E=[],x=0,b={objects:[],lights:[],elements:[]},w=new THREE.Vector3,T=new THREE.Vector4,M=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),S=new THREE.Box3,R=new Array(3),A=new THREE.Matrix4,_=new THREE.Matrix4,D=new THREE.Matrix4,C=new THREE.Matrix3,L=new THREE.Frustum,P=new THREE.Vector4,H=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var B=new function(){var e=[],t=[],r=[],o=null,s=null,c=new THREE.Matrix3;function l(e){var t=e.position,i=e.positionWorld,r=e.positionScreen;i.copy(t).applyMatrix4(h),r.copy(i).applyMatrix4(_);var n=1/r.w;r.x*=n,r.y*=n,r.z*=n,e.visible=r.x>=-1&&r.x<=1&&r.y>=-1&&r.y<=1&&r.z>=-1&&r.z<=1}function u(e,t,i){return!0===e.visible||!0===t.visible||!0===i.visible||(R[0]=e.positionScreen,R[1]=t.positionScreen,R[2]=i.positionScreen,M.intersectsBox(S.setFromPoints(R)))}function d(e,t,i){return(i.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(i.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(i){s=(o=i).material,c.getNormalMatrix(o.matrixWorld),e.length=0,t.length=0,r.length=0},projectVertex:l,checkTriangleVisibility:u,checkBackfaceCulling:d,pushVertex:function(e,t,r){(i=U()).position.set(e,t,r),l(i)},pushNormal:function(t,i,r){e.push(t,i,r)},pushColor:function(e,i,r){t.push(e,i,r)},pushUv:function(e,t){r.push(e,t)},pushLine:function(e,i){var r=p[e],n=p[i];r.positionScreen.copy(r.position).applyMatrix4(D),n.positionScreen.copy(n.position).applyMatrix4(D),!0===z(r.positionScreen,n.positionScreen)&&(r.positionScreen.multiplyScalar(1/r.positionScreen.w),n.positionScreen.multiplyScalar(1/n.positionScreen.w),(a=V()).id=o.id,a.v1.copy(r),a.v2.copy(n),a.z=Math.max(r.positionScreen.z,n.positionScreen.z),a.renderOrder=o.renderOrder,a.material=o.material,o.material.vertexColors===THREE.VertexColors&&(a.vertexColors[0].fromArray(t,3*e),a.vertexColors[1].fromArray(t,3*i)),b.elements.push(a))},pushTriangle:function(t,i,a){var l=p[t],h=p[i],f=p[a];if(!1!==u(l,h,f)&&(s.side===THREE.DoubleSide||!0===d(l,h,f))){(n=N()).id=o.id,n.v1.copy(l),n.v2.copy(h),n.v3.copy(f),n.z=(l.positionScreen.z+h.positionScreen.z+f.positionScreen.z)/3,n.renderOrder=o.renderOrder,n.normalModel.fromArray(e,3*t),n.normalModel.applyMatrix3(c).normalize();for(var m=0;m<3;m++){var g=n.vertexNormalsModel[m];g.fromArray(e,3*arguments[m]),g.applyMatrix3(c).normalize(),n.uvs[m].fromArray(r,2*arguments[m])}n.vertexNormalsLength=3,n.material=o.material,b.elements.push(n)}}}};function I(i){(e=function(){if(t===d){var e=new THREE.RenderableObject;return u.push(e),d++,t++,e}return u[t++]}()).id=i.id,e.object=i,w.setFromMatrixPosition(i.matrixWorld),w.applyMatrix4(_),e.z=w.z,e.renderOrder=i.renderOrder,b.objects.push(e)}function O(e,t,i){var r=1/e.w;e.z*=r,e.z>=-1&&e.z<=1&&((c=function(){if(l===x){var e=new THREE.RenderableSprite;return E.push(e),x++,l++,e}return E[l++]}()).id=t.id,c.x=e.x*r,c.y=e.y*r,c.z=e.z,c.renderOrder=t.renderOrder,c.object=t,c.rotation=t.rotation,c.scale.x=t.scale.x*Math.abs(c.x-(e.x+i.projectionMatrix.elements[0])/(e.w+i.projectionMatrix.elements[12])),c.scale.y=t.scale.y*Math.abs(c.y-(e.y+i.projectionMatrix.elements[5])/(e.w+i.projectionMatrix.elements[13])),c.material=t.material,b.elements.push(c))}function U(){if(r===f){var e=new THREE.RenderableVertex;return p.push(e),f++,r++,e}return p[r++]}function N(){if(o===g){var e=new THREE.RenderableFace;return m.push(e),g++,o++,e}return m[o++]}function V(){if(s===y){var e=new THREE.RenderableLine;return v.push(e),y++,s++,e}return v[s++]}function F(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function z(e,t){var i=0,r=1,n=e.z+e.w,o=t.z+t.w,a=-e.z+e.w,s=-t.z+t.w;return n>=0&&o>=0&&a>=0&&s>=0||!(n<0&&o<0||a<0&&s<0)&&(n<0?i=Math.max(i,n/(n-o)):o<0&&(r=Math.min(r,n/(n-o))),a<0?i=Math.max(i,a/(a-s)):s<0&&(r=Math.min(r,a/(a-s))),!(r<i)&&(e.lerp(t,i),t.lerp(e,1-r),!0))}this.projectScene=function(e,i,c,u){o=0,s=0,l=0,b.elements.length=0,!0===e.autoUpdate&&e.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),A.copy(i.matrixWorldInverse),_.multiplyMatrices(i.projectionMatrix,A),L.setFromMatrix(_),t=0,b.objects.length=0,b.lights.length=0,function e(t){if(!1!==t.visible){if(t instanceof THREE.Light)b.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Points){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===L.intersectsObject(t))return;I(t)}else if(t instanceof THREE.Sprite){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===L.intersectsSprite(t))return;I(t)}for(var i=t.children,r=0,n=i.length;r<n;r++)e(i[r])}}(e),!0===c&&b.objects.sort(F);for(var d=b.objects,f=0,m=d.length;f<m;f++){var g=d[f].object,v=g.geometry;if(B.setObject(g),h=g.matrixWorld,r=0,g instanceof THREE.Mesh){if(v instanceof THREE.BufferGeometry){var y=v.attributes,E=v.groups;if(void 0===y.position)continue;for(var x=0,M=(be=y.position.array).length;x<M;x+=3)B.pushVertex(be[x],be[x+1],be[x+2]);if(void 0!==y.normal){var S=y.normal.array;for(x=0,M=S.length;x<M;x+=3)B.pushNormal(S[x],S[x+1],S[x+2])}if(void 0!==y.uv){var R=y.uv.array;for(x=0,M=R.length;x<M;x+=2)B.pushUv(R[x],R[x+1])}if(null!==v.index){var j=v.index.array;if(E.length>0)for(var k=0;k<E.length;k++){var G=E[k];for(x=G.start,M=G.start+G.count;x<M;x+=3)B.pushTriangle(j[x],j[x+1],j[x+2])}else for(x=0,M=j.length;x<M;x+=3)B.pushTriangle(j[x],j[x+1],j[x+2])}else for(x=0,M=be.length/3;x<M;x+=3)B.pushTriangle(x,x+1,x+2)}else if(v instanceof THREE.Geometry){var W=v.vertices,X=v.faces,Y=v.faceVertexUvs[0];C.getNormalMatrix(h);for(var q=g.material,Z=Array.isArray(q),J=0,Q=W.length;J<Q;J++){var K=W[J];if(w.copy(K),!0===q.morphTargets)for(var $=v.morphTargets,ee=g.morphTargetInfluences,te=0,ie=$.length;te<ie;te++){var re=ee[te];if(0!==re){var ne=$[te].vertices[J];w.x+=(ne.x-K.x)*re,w.y+=(ne.y-K.y)*re,w.z+=(ne.z-K.z)*re}}B.pushVertex(w.x,w.y,w.z)}for(var oe=0,ae=X.length;oe<ae;oe++){var se=X[oe];if(void 0!==(q=!0===Z?g.material[se.materialIndex]:g.material)){var ce=q.side,le=p[se.a],he=p[se.b],ue=p[se.c];if(!1!==B.checkTriangleVisibility(le,he,ue)){var de=B.checkBackfaceCulling(le,he,ue);if(ce!==THREE.DoubleSide){if(ce===THREE.FrontSide&&!1===de)continue;if(ce===THREE.BackSide&&!0===de)continue}(n=N()).id=g.id,n.v1.copy(le),n.v2.copy(he),n.v3.copy(ue),n.normalModel.copy(se.normal),!1!==de||ce!==THREE.BackSide&&ce!==THREE.DoubleSide||n.normalModel.negate(),n.normalModel.applyMatrix3(C).normalize();for(var pe=se.vertexNormals,fe=0,me=Math.min(pe.length,3);fe<me;fe++){var ge=n.vertexNormalsModel[fe];ge.copy(pe[fe]),!1!==de||ce!==THREE.BackSide&&ce!==THREE.DoubleSide||ge.negate(),ge.applyMatrix3(C).normalize()}n.vertexNormalsLength=pe.length;var ve=Y[oe];if(void 0!==ve)for(var ye=0;ye<3;ye++)n.uvs[ye].copy(ve[ye]);n.color=se.color,n.material=q,n.z=(le.positionScreen.z+he.positionScreen.z+ue.positionScreen.z)/3,n.renderOrder=g.renderOrder,b.elements.push(n)}}}}}else if(g instanceof THREE.Line){if(D.multiplyMatrices(_,h),v instanceof THREE.BufferGeometry){if(void 0!==(y=v.attributes).position){for(x=0,M=(be=y.position.array).length;x<M;x+=3)B.pushVertex(be[x],be[x+1],be[x+2]);if(void 0!==y.color){var Ee=y.color.array;for(x=0,M=Ee.length;x<M;x+=3)B.pushColor(Ee[x],Ee[x+1],Ee[x+2])}if(null!==v.index)for(x=0,M=(j=v.index.array).length;x<M;x+=2)B.pushLine(j[x],j[x+1]);else{var xe=g instanceof THREE.LineSegments?2:1;for(x=0,M=be.length/3-1;x<M;x+=xe)B.pushLine(x,x+1)}}}else if(v instanceof THREE.Geometry){if(0===(W=g.geometry.vertices).length)continue;(le=U()).positionScreen.copy(W[0]).applyMatrix4(D);for(xe=g instanceof THREE.LineSegments?2:1,J=1,Q=W.length;J<Q;J++)(le=U()).positionScreen.copy(W[J]).applyMatrix4(D),(J+1)%xe>0||(he=p[r-2],P.copy(le.positionScreen),H.copy(he.positionScreen),!0===z(P,H)&&(P.multiplyScalar(1/P.w),H.multiplyScalar(1/H.w),(a=V()).id=g.id,a.v1.positionScreen.copy(P),a.v2.positionScreen.copy(H),a.z=Math.max(P.z,H.z),a.renderOrder=g.renderOrder,a.material=g.material,g.material.vertexColors===THREE.VertexColors&&(a.vertexColors[0].copy(g.geometry.colors[J]),a.vertexColors[1].copy(g.geometry.colors[J-1])),b.elements.push(a)))}}else if(g instanceof THREE.Points){if(D.multiplyMatrices(_,h),v instanceof THREE.Geometry)for(J=0,Q=(W=g.geometry.vertices).length;J<Q;J++){K=W[J];T.set(K.x,K.y,K.z,1),T.applyMatrix4(D),O(T,g,i)}else if(v instanceof THREE.BufferGeometry){if(void 0!==(y=v.attributes).position){var be;for(x=0,M=(be=y.position.array).length;x<M;x+=3)T.set(be[x],be[x+1],be[x+2],1),T.applyMatrix4(D),O(T,g,i)}}}else g instanceof THREE.Sprite&&(T.set(h.elements[12],h.elements[13],h.elements[14],1),T.applyMatrix4(_),O(T,g,i))}return!0===u&&b.elements.sort(F),b}},THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=!0,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var t,i,r,n,o,a,s,c,l,h,u,d,p,f,m,g,v,y,E,x=this,b=new THREE.Projector,w=void 0!==e.canvas?e.canvas:document.createElement("canvas"),T=w.width,M=w.height,S=Math.floor(T/2),R=Math.floor(M/2),A=0,_=0,D=T,C=M,L=1,P=w.getContext("2d",{alpha:!0===e.alpha}),H=new THREE.Color(0),B=!0===e.alpha?0:1,I=1,O=0,U=null,N=null,V=null,F=null,z=null,j=[],k=new THREE.Color,G=new THREE.Color,W=new THREE.Color,X=new THREE.Color,Y={},q=new THREE.Box2,Z=new THREE.Box2,J=new THREE.Box2,Q=new THREE.Color,K=new THREE.Color,$=new THREE.Color,ee=new THREE.Vector3,te=new THREE.Vector3,ie=new THREE.Vector3,re=new THREE.Matrix3;function ne(e,t,i){de(i.opacity),pe(i.blending);var r=t.scale.x*S,n=t.scale.y*R,o=Math.sqrt(r*r+n*n);if(J.min.set(e.x-o,e.y-o),J.max.set(e.x+o,e.y+o),i.isSpriteMaterial){var a=i.map;if(null!==a){var s=Y[a.id];if(void 0!==s&&s.version===a.version||(s=le(a),Y[a.id]=s),void 0!==s.canvas){ye(s.canvas);var c=a.image,l=c.width*a.offset.x,h=c.height*a.offset.y,u=c.width*a.repeat.x,d=c.height*a.repeat.y,p=r/u,f=n/d;P.save(),P.translate(e.x,e.y),0!==i.rotation&&P.rotate(i.rotation),P.translate(-r/2,-n/2),P.scale(p,f),P.translate(-l,-h),P.fillRect(l,h,u,d),P.restore()}}else ye(i.color.getStyle()),P.save(),P.translate(e.x,e.y),0!==i.rotation&&P.rotate(i.rotation),P.scale(r,-n),P.fillRect(-.5,-.5,1,1),P.restore()}else i.isSpriteCanvasMaterial?(ve(i.color.getStyle()),ye(i.color.getStyle()),P.save(),P.translate(e.x,e.y),0!==i.rotation&&P.rotate(i.rotation),P.scale(r,n),i.program(P),P.restore()):i.isPointsMaterial&&(ye(i.color.getStyle()),P.save(),P.translate(e.x,e.y),0!==i.rotation&&P.rotate(i.rotation),P.scale(r*i.size,-n*i.size),P.fillRect(-.5,-.5,1,1),P.restore())}function oe(e,t,i,r){if(de(r.opacity),pe(r.blending),P.beginPath(),P.moveTo(e.positionScreen.x,e.positionScreen.y),P.lineTo(t.positionScreen.x,t.positionScreen.y),r.isLineBasicMaterial){if(fe(r.linewidth),me(r.linecap),ge(r.linejoin),r.vertexColors!==THREE.VertexColors)ve(r.color.getStyle());else{var n=i.vertexColors[0].getStyle(),o=i.vertexColors[1].getStyle();if(n===o)ve(n);else{try{var a=P.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,n),a.addColorStop(1,o)}catch(e){a=n}ve(a)}}r.isLineDashedMaterial&&Ee([r.dashSize,r.gapSize]),P.stroke(),J.expandByScalar(2*r.linewidth),r.isLineDashedMaterial&&Ee([])}}function ae(e,t,i,n,o,a,b,w){var T,M,S,R,A,_;if(x.info.render.vertices+=3,x.info.render.faces++,de(w.opacity),pe(w.blending),s=e.positionScreen.x,c=e.positionScreen.y,l=t.positionScreen.x,h=t.positionScreen.y,u=i.positionScreen.x,d=i.positionScreen.y,T=s,M=c,S=l,R=h,A=u,_=d,P.beginPath(),P.moveTo(T,M),P.lineTo(S,R),P.lineTo(A,_),P.closePath(),(w.isMeshLambertMaterial||w.isMeshPhongMaterial||w.isMeshStandardMaterial)&&null===w.map)G.copy(w.color),W.copy(w.emissive),w.vertexColors===THREE.FaceColors&&G.multiply(b.color),k.copy(Q),te.copy(e.positionWorld).add(t.positionWorld).add(i.positionWorld).divideScalar(3),function(e,t,i){for(var n=0,o=r.length;n<o;n++){var a=r[n];if(X.copy(a.color),a.isDirectionalLight){var s=ee.setFromMatrixPosition(a.matrixWorld).normalize();if((c=t.dot(s))<=0)continue;c*=a.intensity,i.add(X.multiplyScalar(c))}else if(a.isPointLight){var c;if(s=ee.setFromMatrixPosition(a.matrixWorld),(c=t.dot(ee.subVectors(s,e).normalize()))<=0)continue;if(0==(c*=0==a.distance?1:1-Math.min(e.distanceTo(s)/a.distance,1)))continue;c*=a.intensity,i.add(X.multiplyScalar(c))}}}(te,b.normalModel,k),k.multiply(G).add(W),!0===w.wireframe?se(k,w.wireframeLinewidth,w.wireframeLinecap,w.wireframeLinejoin):ce(k);else if(w.isMeshBasicMaterial||w.isMeshLambertMaterial||w.isMeshPhongMaterial||w.isMeshStandardMaterial){if(null!==w.map)w.map.mapping===THREE.UVMapping&&(p=b.uvs,he(s,c,l,h,u,d,p[n].x,p[n].y,p[o].x,p[o].y,p[a].x,p[a].y,w.map));else null!==w.envMap?w.envMap.mapping===THREE.SphericalReflectionMapping&&(ie.copy(b.vertexNormalsModel[n]).applyMatrix3(re),f=.5*ie.x+.5,m=.5*ie.y+.5,ie.copy(b.vertexNormalsModel[o]).applyMatrix3(re),g=.5*ie.x+.5,v=.5*ie.y+.5,ie.copy(b.vertexNormalsModel[a]).applyMatrix3(re),y=.5*ie.x+.5,E=.5*ie.y+.5,he(s,c,l,h,u,d,f,m,g,v,y,E,w.envMap)):(k.copy(w.color),w.vertexColors===THREE.FaceColors&&k.multiply(b.color),!0===w.wireframe?se(k,w.wireframeLinewidth,w.wireframeLinecap,w.wireframeLinejoin):ce(k))}else w.isMeshNormalMaterial?(ie.copy(b.normalModel).applyMatrix3(re),k.setRGB(ie.x,ie.y,ie.z).multiplyScalar(.5).addScalar(.5),!0===w.wireframe?se(k,w.wireframeLinewidth,w.wireframeLinecap,w.wireframeLinejoin):ce(k)):(k.setRGB(1,1,1),!0===w.wireframe?se(k,w.wireframeLinewidth,w.wireframeLinecap,w.wireframeLinejoin):ce(k))}function se(e,t,i,r){fe(t),me(i),ge(r),ve(e.getStyle()),P.stroke(),J.expandByScalar(2*t)}function ce(e){ye(e.getStyle()),P.fill()}function le(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(!1===t.complete)return{canvas:void 0,version:0};var i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,r=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,n=e.wrapS===THREE.MirroredRepeatWrapping,o=e.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=t.width*(n?2:1),a.height=t.height*(o?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,t.height),s.drawImage(t,0,0),!0===n&&(s.setTransform(-1,0,0,-1,t.width,t.height),s.drawImage(t,-t.width,0)),!0===o&&(s.setTransform(1,0,0,1,0,0),s.drawImage(t,0,t.height)),!0===n&&!0===o&&(s.setTransform(-1,0,0,1,t.width,0),s.drawImage(t,-t.width,t.height));var c="no-repeat";!0===i&&!0===r?c="repeat":!0===i?c="repeat-x":!0===r&&(c="repeat-y");var l=P.createPattern(a,c);return e.onUpdate&&e.onUpdate(e),{canvas:l,version:e.version}}function he(e,t,i,r,n,o,a,s,c,l,h,u,d){var p=Y[d.id];if(void 0!==p&&p.version===d.version||(p=le(d),Y[d.id]=p),void 0===p.canvas)return ye("rgba( 0, 0, 0, 1)"),void P.fill();ye(p.canvas);var f,m,g,v,y,E,x,b,w=d.offset.x/d.repeat.x,T=d.offset.y/d.repeat.y,M=d.image.width*d.repeat.x,S=d.image.height*d.repeat.y;c=(c+w)*M,l=(l+T)*S,h=(h+w)*M,u=(u+T)*S,i-=e,r-=t,n-=e,o-=t,0!==(x=(c-=a=(a+w)*M)*(u-=s=(s+T)*S)-(h-=a)*(l-=s))&&(y=e-(f=(u*i-l*n)*(b=1/x))*a-(g=(c*n-h*i)*b)*s,E=t-(m=(u*r-l*o)*b)*a-(v=(c*o-h*r)*b)*s,P.save(),P.transform(f,m,g,v,y,E),P.fill(),P.restore())}function ue(e,t,i){var r,n=t.x-e.x,o=t.y-e.y,a=n*n+o*o;0!==a&&(n*=r=i/Math.sqrt(a),o*=r,t.x+=n,t.y+=o,e.x-=n,e.y-=o)}function de(e){I!==e&&(P.globalAlpha=e,I=e)}function pe(e){O!==e&&(e===THREE.NormalBlending?P.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?P.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?P.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(P.globalCompositeOperation="multiply"),O=e)}function fe(e){V!==e&&(P.lineWidth=e,V=e)}function me(e){F!==e&&(P.lineCap=e,F=e)}function ge(e){z!==e&&(P.lineJoin=e,z=e)}function ve(e){U!==e&&(P.strokeStyle=e,U=e)}function ye(e){N!==e&&(P.fillStyle=e,N=e)}function Ee(e){j.length!==e.length&&(P.setLineDash(e),j=e)}void 0===P.setLineDash&&(P.setLineDash=function(){}),this.domElement=w,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return P},this.getContextAttributes=function(){return P.getContextAttributes()},this.getPixelRatio=function(){return L},this.setPixelRatio=function(e){void 0!==e&&(L=e)},this.setSize=function(e,t,i){T=e*L,M=t*L,w.width=T,w.height=M,S=Math.floor(T/2),R=Math.floor(M/2),!1!==i&&(w.style.width=e+"px",w.style.height=t+"px"),q.min.set(-S,-R),q.max.set(S,R),Z.min.set(-S,-R),Z.max.set(S,R),I=1,O=0,U=null,N=null,V=null,F=null,z=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,r){A=e*L,_=t*L,D=i*L,C=r*L},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){H.set(e),B=void 0!==t?t:1,Z.min.set(-S,-R),Z.max.set(S,R)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return H},this.getClearAlpha=function(){return B},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===Z.isEmpty()&&(Z.intersect(q),Z.expandByScalar(2),Z.min.x=Z.min.x+S,Z.min.y=-Z.min.y+R,Z.max.x=Z.max.x+S,Z.max.y=-Z.max.y+R,B<1&&P.clearRect(0|Z.min.x,0|Z.max.y,Z.max.x-Z.min.x|0,Z.min.y-Z.max.y|0),B>0&&(de(1),pe(THREE.NormalBlending),ye("rgba("+Math.floor(255*H.r)+","+Math.floor(255*H.g)+","+Math.floor(255*H.b)+","+B+")"),P.fillRect(0|Z.min.x,0|Z.max.y,Z.max.x-Z.min.x|0,Z.min.y-Z.max.y|0)),Z.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,s){if(void 0!==s.isCamera){var c=e.background;c&&c.isColor?(de(1),pe(THREE.NormalBlending),ye(c.getStyle()),P.fillRect(0,0,T,M)):!0===this.autoClear&&this.clear(),x.info.render.vertices=0,x.info.render.faces=0,P.setTransform(D/T,0,0,-C/M,A,M-_),P.translate(S,R),t=b.projectScene(e,s,this.sortObjects,this.sortElements),i=t.elements,r=t.lights,re.getNormalMatrix(s.matrixWorldInverse),function(){Q.setRGB(0,0,0),K.setRGB(0,0,0),$.setRGB(0,0,0);for(var e=0,t=r.length;e<t;e++){var i=r[e],n=i.color;i.isAmbientLight?Q.add(n):i.isDirectionalLight?K.add(n):i.isPointLight&&$.add(n)}}();for(var l=0,h=i.length;l<h;l++){var u=i[l],d=u.material;if(void 0!==d&&0!==d.opacity){if(J.makeEmpty(),u instanceof THREE.RenderableSprite)(n=u).x*=S,n.y*=R,ne(n,u,d);else if(u instanceof THREE.RenderableLine)n=u.v1,o=u.v2,n.positionScreen.x*=S,n.positionScreen.y*=R,o.positionScreen.x*=S,o.positionScreen.y*=R,J.setFromPoints([n.positionScreen,o.positionScreen]),!0===q.intersectsBox(J)&&oe(n,o,u,d);else if(u instanceof THREE.RenderableFace){if(n=u.v1,o=u.v2,a=u.v3,n.positionScreen.z<-1||n.positionScreen.z>1)continue;if(o.positionScreen.z<-1||o.positionScreen.z>1)continue;if(a.positionScreen.z<-1||a.positionScreen.z>1)continue;n.positionScreen.x*=S,n.positionScreen.y*=R,o.positionScreen.x*=S,o.positionScreen.y*=R,a.positionScreen.x*=S,a.positionScreen.y*=R,d.overdraw>0&&(ue(n.positionScreen,o.positionScreen,d.overdraw),ue(o.positionScreen,a.positionScreen,d.overdraw),ue(a.positionScreen,n.positionScreen,d.overdraw)),J.setFromPoints([n.positionScreen,o.positionScreen,a.positionScreen]),!0===q.intersectsBox(J)&&ae(n,o,a,0,1,2,u,d)}Z.union(J)}}P.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.")}},THREE.RaytracingRenderer=function(e){console.log("THREE.RaytracingRenderer",THREE.REVISION),e=e||{};var t,i,r=this,n=[],o=!1,a=document.createElement("canvas"),s=a.getContext("2d",{alpha:!0===e.alpha}),c=new THREE.Color(0);this.domElement=a,this.autoClear=!0;var l=e.workers,h=e.blockSize||64;this.randomize=e.randomize;var u,d,p,f=[],m=0,g=0;function v(e){e.postMessage({init:[t,i],worker:e.id,blockSize:h})}function y(e){if(!f.length)return o=!1,r.dispatchEvent({type:"complete"});var t=f.pop(),i=t%d*h,n=(t/d|0)*h;e.postMessage({render:!0,x:i,y:n,sceneId:g}),s.fillStyle="#"+e.color,s.fillRect(i,n,h,h)}console.log("%cSpinning off "+l+" Workers ","font-size: 20px; background: black; color: white; font-family: monospace;"),this.setWorkers=function(t){for(l=t||navigator.hardwareConcurrency||4;n.length<l;){var i=new Worker(e.workerPath);i.id=m++,i.onmessage=function(e){var t=e.data;if(t&&t.blockSize&&g==t.sceneId){var i=new ImageData(new Uint8ClampedArray(t.data),t.blockSize,t.blockSize);if(s.putImageData(i,t.blockX,t.blockY),console.log("Worker "+this.id,t.time/1e3,(Date.now()-b)/1e3+" s"),n.length>l)return n.splice(n.indexOf(this),1),this.terminate();y(this)}},i.color=(new THREE.Color).setHSL(Math.random(),.8,.8).getHexString(),n.push(i),o&&(v(i),i.postMessage({scene:E,camera:x,annex:w,sceneId:g}),y(i))}if(!o)for(;n.length>l;)n.pop().terminate()},this.setWorkers(l),this.setClearColor=function(e,t){c.set(e)},this.setPixelRatio=function(){},this.setSize=function(e,r){a.width=e,a.height=r,t=a.width,i=a.height,s.fillStyle="white",n.forEach(v)},this.setSize(a.width,a.height),this.clear=function(){};var E,x,b,w={},T={mirror:1,reflectivity:1,refractionRatio:1,glass:1};function M(e){var t=e.material;if(t&&!(t.uuid in w)){var i={};for(var r in T)void 0!==t[r]&&(i[r]=t[r]);w[t.uuid]=i}}this.render=function(e,a){o=!0,!0===e.autoUpdate&&e.updateMatrixWorld(),null===a.parent&&a.updateMatrixWorld(),E=e.toJSON(),x=a.toJSON(),++g,e.traverse(M),n.forEach(function(e){e.postMessage({scene:E,camera:x,annex:w,sceneId:g})}),s.clearRect(0,0,t,i),b=Date.now(),d=Math.ceil(t/h),p=Math.ceil(i/h),u=d*p,f=[];for(var c=0;c<u;c++)f.push(c);if(r.randomize)for(c=0;c<u;c++){var l=Math.random()*u|0,m=f[l];f[l]=f[c],f[c]=m}n.forEach(y)}},Object.assign(THREE.RaytracingRenderer.prototype,THREE.EventDispatcher.prototype),THREE.SoftwareRenderer=function(e){console.log("THREE.SoftwareRenderer",THREE.REVISION);var t,i,r,n,o,a,s,c,l,h,u,d,p,f,m,g,v=void 0!==(e=e||{}).canvas?e.canvas:document.createElement("canvas"),y=v.getContext("2d",{alpha:!0===e.alpha}),E=e.alpha,x={},b={},w=new THREE.Color(0),T=1,M=2,S=4,R=(1<<S)-1,A=3,_=1<<A,D=1<<24,C=!1,L=new THREE.Vector3(0,0,1),P=new THREE.Vector3,H=1/0,B=1/0,I=0,O=0,U=1/0,N=1/0,V=0,F=0,z=new THREE.Projector,j=new THREE.Vector4,k=new THREE.Vector4,G=new THREE.Vector4,W=new THREE.Vector2,X=new THREE.Vector2,Y=new THREE.Vector2,q=[],Z=0,J=[],Q=0,K=[],$=0;function ee(e){for(var r=t*i*4,n=0;n<r;n+=4)d[n]=255*e.r|0,d[n+1]=255*e.g|0,d[n+2]=255*e.b|0,d[n+3]=E?0:255;y.fillStyle=E?"rgba(0, 0, 0, 0)":e.getStyle(),y.fillRect(0,0,t,i)}function te(e,t){var i=0,r=0,n=255*e.color.r,o=255*e.color.g,a=255*e.color.b,s=new Uint8Array(768);if(t){for(;i<204;)s[r++]=Math.min(i*n/204,255),s[r++]=Math.min(i*o/204,255),s[r++]=Math.min(i*a/204,255),++i;for(;i<256;)s[r++]=Math.min(n+(i-204)*(255-n)/82,255),s[r++]=Math.min(o+(i-204)*(255-o)/82,255),s[r++]=Math.min(a+(i-204)*(255-a)/82,255),++i}else for(;i<256;)s[r++]=Math.min(i*n/255,255),s[r++]=Math.min(i*o/255,255),s[r++]=Math.min(i*a/255,255),++i;return s}function ie(e,t,i,r,n,o,a,s,c){var l=4*i,h=b[c.map.id];if(h.data){var u=h.width,d=c.transparent,p=u-1,f=h.data,m=4*((o*u&p)*u+(n*u&p));if(d){var g=f[m],v=f[m+1],y=f[m+2],E=f[m+3]*c.opacity/255,x=e[l],w=e[l+1],T=e[l+2];e[l]=g*E+x*(1-E),e[l+1]=v*E+w*(1-E),e[l+2]=y*E+T*(1-E),e[l+3]=(c.opacity<<8)-1,255==e[l+3]&&(t[i]=r)}else e[l]=f[m],e[l+1]=f[m+1],e[l+2]=f[m+2],e[l+3]=(c.opacity<<8)-1,t[i]=r}}function re(e,t,i,r,n,o,a,s,c){var l=4*i,h=b[c.map.id];if(h.data){var u=h.width,d=c.transparent,p=3*(a>0?~~a:0),f=u-1,m=h.data,g=4*((o*u&f)*u+(n*u&f));if(d){var v=c.palette[p]*m[g],y=c.palette[p+1]*m[g+1],E=c.palette[p+2]*m[g+2],x=m[g+3]*c.opacity/256,w=e[l],T=e[l+1],M=e[l+2];e[l]=v*x+w*(1-x),e[l+1]=y*x+T*(1-x),e[l+2]=E*x+M*(1-x),e[l+3]=(c.opacity<<8)-1,255==e[l+3]&&(t[i]=r)}else e[l]=c.palette[p]*m[g]>>8,e[l+1]=c.palette[p+1]*m[g+1]>>8,e[l+2]=c.palette[p+2]*m[g+2]>>8,e[l+3]=(c.opacity<<8)-1,t[i]=r}}function ne(e){var t=e.id,i=x[t];if(i&&e.map&&!b[e.map.id]&&delete x[t],void 0===x[t]||!0===e.needsUpdate){if(e instanceof THREE.MeshBasicMaterial||e instanceof THREE.MeshLambertMaterial||e instanceof THREE.MeshPhongMaterial||e instanceof THREE.SpriteMaterial)if(e instanceof THREE.MeshLambertMaterial?e.palette||(e.palette=te(e,!1)):e instanceof THREE.MeshPhongMaterial&&(e.palette||(e.palette=te(e,!0))),e.map){var r=new THREE.SoftwareRenderer.Texture;if(r.fromImage(e.map.image),!r.data)return;b[e.map.id]=r,i=e instanceof THREE.MeshBasicMaterial||e instanceof THREE.SpriteMaterial?ie:re}else n=e.vertexColors===THREE.FaceColors?["var colorOffset = offset * 4;","buffer[ colorOffset ] = face.color.r * 255;","buffer[ colorOffset + 1 ] = face.color.g * 255;","buffer[ colorOffset + 2 ] = face.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"):["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * 255;","buffer[ colorOffset + 1 ] = material.color.g * 255;","buffer[ colorOffset + 2 ] = material.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"),i=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",n);else if(e instanceof THREE.LineBasicMaterial){var n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * (color1.r+color2.r) * 0.5 * 255;","buffer[ colorOffset + 1 ] = material.color.g * (color1.g+color2.g) * 0.5 * 255;","buffer[ colorOffset + 2 ] = material.color.b * (color1.b+color2.b) * 0.5 * 255;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");i=new Function("buffer, depthBuf, offset, depth, color1, color2, material",n)}else{n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = u * 255;","buffer[ colorOffset + 1 ] = v * 255;","buffer[ colorOffset + 2 ] = 0;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");i=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",n)}x[t]=i,e.needsUpdate=!1}return i}function oe(e,n,u,f,v,y,E,x,b){if(!(e.z<-1||e.z>1||n.z<-1||n.z>1||u.z<-1||u.z>1)){var w=1<<S,D=e.x*o+c|0,C=n.x*o+c|0,L=u.x*o+c|0,P=e.y*a+l|0,U=n.y*a+l|0,N=u.y*a+l|0,V=x.vertexNormalsModel&&x.vertexNormalsModel.length,F=f&&v&&y,z=Math.max(Math.sqrt((D-C)*(D-C)+(P-U)*(P-U)),Math.sqrt((C-L)*(C-L)+(U-N)*(U-N)),Math.sqrt((L-D)*(L-D)+(N-P)*(N-P)));if(!(x instanceof THREE.RenderableSprite)&&z>100*w){var j,k,G,W,X,Y,ee,te,ie,re,ne={vertexNormalsModel:[],color:x.color};if(F)$===K.length?(j=new THREE.Vector2,K.push(j),++$,k=new THREE.Vector2,K.push(k),++$,G=new THREE.Vector2,K.push(G),++$):(j=K[$],k=K[++$],G=K[++$],++$),W=(1+n.z)*(n.w/e.w)/(1+e.z),j.copy(f).multiplyScalar(W).add(v).multiplyScalar(1/(W+1)),W=(1+u.z)*(u.w/n.w)/(1+n.z),k.copy(v).multiplyScalar(W).add(y).multiplyScalar(1/(W+1)),W=(1+e.z)*(e.w/u.w)/(1+u.z),G.copy(y).multiplyScalar(W).add(f).multiplyScalar(1/(W+1));return Z===q.length?(X=new THREE.Vector4,q.push(X),++Z,Y=new THREE.Vector4,q.push(Y),++Z,ee=new THREE.Vector4,q.push(ee),++Z):(X=q[Z],Y=q[++Z],ee=q[++Z],++Z),X.copy(e).add(n).multiplyScalar(.5),Y.copy(n).add(u).multiplyScalar(.5),ee.copy(u).add(e).multiplyScalar(.5),V&&(Q===J.length?(te=new THREE.Vector3,J.push(te),++Q,ie=new THREE.Vector3,J.push(ie),++Q,re=new THREE.Vector3,J.push(re),++Q):(te=J[Q],ie=J[++Q],re=J[++Q],++Q),te.copy(x.vertexNormalsModel[0]).add(x.vertexNormalsModel[1]).normalize(),ie.copy(x.vertexNormalsModel[1]).add(x.vertexNormalsModel[2]).normalize(),re.copy(x.vertexNormalsModel[2]).add(x.vertexNormalsModel[0]).normalize()),V&&(ne.vertexNormalsModel[0]=x.vertexNormalsModel[0],ne.vertexNormalsModel[1]=te,ne.vertexNormalsModel[2]=re),oe(e,X,ee,f,j,G,E,ne,b),V&&(ne.vertexNormalsModel[0]=x.vertexNormalsModel[1],ne.vertexNormalsModel[1]=ie,ne.vertexNormalsModel[2]=te),oe(n,Y,X,v,k,j,E,ne,b),V&&(ne.vertexNormalsModel[0]=te,ne.vertexNormalsModel[1]=ie,ne.vertexNormalsModel[2]=re),oe(X,Y,ee,j,k,G,E,ne,b),V&&(ne.vertexNormalsModel[0]=x.vertexNormalsModel[2],ne.vertexNormalsModel[1]=re,ne.vertexNormalsModel[2]=ie),void oe(u,ee,Y,y,G,k,E,ne,b)}var ae,ce,le,he,ue,de,pe,fe,me,ge,ve,ye,Ee=e.z*s+h|0,xe=n.z*s+h|0,be=u.z*s+h|0;F=!1;f&&v&&y&&(F=!0,ae=f.x,ce=1-f.y,le=v.x,he=1-v.y,ue=y.x,de=1-y.y),V&&(pe=x.vertexNormalsModel[0],fe=x.vertexNormalsModel[1],me=x.vertexNormalsModel[2],ge=255*pe.z,ve=255*fe.z,ye=255*me.z);var we=D-C,Te=U-P,Me=C-L,Se=N-U,Re=L-D,Ae=P-N,_e=Math.max(Math.min(D,C,L)+R>>S,0),De=Math.min(Math.max(D,C,L)+R>>S,t),Ce=Math.max(Math.min(P,U,N)+R>>S,0),Le=Math.min(Math.max(P,U,N)+R>>S,i);H=Math.min(_e,H),I=Math.max(De,I),B=Math.min(Ce,B),O=Math.max(Le,O);var Pe=_,He=(_e&=~(Pe-1))<<S,Be=(Ce&=~(Pe-1))<<S,Ie=Te*(He-D)+we*(Be-P),Oe=Se*(He-C)+Me*(Be-U),Ue=Ae*(He-L)+Re*(Be-N);(Te>0||0==Te&&we>0)&&Ie++,(Se>0||0==Se&&Me>0)&&Oe++,(Ae>0||0==Ae&&Re>0)&&Ue++,Ie=Ie-1>>S,Oe=Oe-1>>S,Ue=Ue-1>>S;var Ne,Ve,Fe,ze,je,ke=Ee-xe,Ge=be-Ee,We=1/(we*Ae-Re*Te),Xe=We*(ke*Ae-Ge*Te),Ye=We*(ke*Re-we*Ge),qe=Ee+(He-D)*Xe+(Be-P)*Ye|0;if(Xe=Xe*w|0,Ye=Ye*w|0,F){var Ze=ae-le,Je=ue-ae,Qe=We*(Ze*Ae-Je*Te),Ke=We*(Ze*Re-we*Je),$e=ce-he,et=de-ce;Fe=ae+(He-D)*Qe+(Be-P)*Ke,ze=ce+(He-D)*(Ne=We*($e*Ae-et*Te))+(Be-P)*(Ve=We*($e*Re-we*et)),Qe*=w,Ke*=w,Ne*=w,Ve*=w}if(V){var tt,it=ge-ve,rt=ye-ge,nt=We*(it*Ae-rt*Te);je=ge+(He-D)*nt+(Be-P)*(tt=We*(it*Re-we*rt)),nt*=w,tt*=w}var ot=Pe-1,at=0,st=0,ct=0,lt=0,ht=0,ut=0,dt=0,pt=0;we>=0?st-=ot*we:at-=ot*we,Te>=0?st-=ot*Te:at-=ot*Te,Me>=0?lt-=ot*Me:ct-=ot*Me,Se>=0?lt-=ot*Se:ct-=ot*Se,Re>=0?ut-=ot*Re:ht-=ot*Re,Ae>=0?ut-=ot*Ae:ht-=ot*Ae,Xe>=0?pt+=ot*Xe:dt+=ot*Xe,Ye>=0?pt+=ot*Ye:dt+=ot*Ye;var ft,mt,gt,vt=t-Pe,yt=Ie,Et=Oe,xt=Ue,bt=qe,wt=-Pe,Tt=wt*Te,Mt=wt*Se,St=wt*Ae,Rt=wt*Xe;F&&(ft=wt*Qe,mt=wt*Ne),V&&(gt=wt*nt);for(var At=_e,_t=Ce;_t<Le;_t+=Pe){for(;At>=_e&&At<De&&yt>=st&&Et>=lt&&xt>=ut;)At+=wt,yt+=Tt,Et+=Mt,xt+=St,bt+=Rt,F&&(Fe+=ft,ze+=mt),V&&(je+=gt);for(wt=-wt,Tt=-Tt,Mt=-Mt,St=-St,Rt=-Rt,F&&(ft=-ft,mt=-mt),V&&(gt=-gt);At+=wt,yt+=Tt,Et+=Mt,xt+=St,bt+=Rt,F&&(Fe+=ft,ze+=mt),V&&(je+=gt),!(At<_e||At>=De);)if(yt<st){if(Tt<0)break}else if(Et<lt){if(Mt<0)break}else if(xt<ut){if(St<0)break}else{var Dt=At>>A,Ct=_t>>A,Lt=Dt+Ct*r,Pt=bt+dt;if(!(m[Lt]<Pt)){var Ht=g[Lt];Ht&M&&se(Dt,Ct),g[Lt]=Ht&~(T|M);var Bt=At+_t*t;if(yt>=at&&Et>=ct&&xt>=ht){var It=bt+pt;m[Lt]=Math.min(m[Lt],It);var Ot=yt,Ut=Et,Nt=bt;F&&(Gt=Fe,Wt=ze),V&&(Xt=je);for(var Vt=0;Vt<Pe;Vt++){var Ft=Ot,zt=Ut,jt=Nt;F&&(qt=Gt,Zt=Wt),V&&(Jt=Xt);for(var kt=0;kt<Pe;kt++){(Kt=jt)<p[Bt]&&E(d,p,Bt,Kt,qt,Zt,Jt,x,b),Ft+=Te,zt+=Se,jt+=Xe,F&&(qt+=Qe,Zt+=Ne),V&&(Jt+=nt),Bt++}Ot+=we,Ut+=Me,Nt+=Ye,F&&(Gt+=Ke,Wt+=Ve),V&&(Xt+=tt),Bt+=vt}}else{Ot=yt,Ut=Et;var Gt,Wt,Xt,Yt=xt;Nt=bt;F&&(Gt=Fe,Wt=ze),V&&(Xt=je);for(Vt=0;Vt<Pe;Vt++){Ft=Ot,zt=Ut;var qt,Zt,Jt,Qt=Yt;jt=Nt;F&&(qt=Gt,Zt=Wt),V&&(Jt=Xt);for(kt=0;kt<Pe;kt++){var Kt;if((Ft|zt|Qt)>=0)(Kt=jt)<p[Bt]&&E(d,p,Bt,Kt,qt,Zt,Jt,x,b);Ft+=Te,zt+=Se,Qt+=Ae,jt+=Xe,F&&(qt+=Qe,Zt+=Ne),V&&(Jt+=nt),Bt++}Ot+=we,Ut+=Me,Yt+=Re,Nt+=Ye,F&&(Gt+=Ke,Wt+=Ve),V&&(Xt+=tt),Bt+=vt}}}}yt+=Pe*we,Et+=Pe*Me,xt+=Pe*Re,bt+=Pe*Ye,F&&(Fe+=Pe*Ke,ze+=Pe*Ve),V&&(je+=Pe*tt)}}}function ae(e,x,b,U,N,V){if(C||(C=!0,_=1<<(A=0),function(e,x){r=Math.floor(e/_),n=Math.floor(x/_);var b=1<<S;o=b*(t=r*_)/2,a=-b*(i=n*_)/2,s=D/2,c=b*t/2+.5,l=b*i/2+.5,h=D/2+.5,v.width=t,v.height=i,y.fillStyle=E?"rgba(0, 0, 0, 0)":w.getStyle(),y.fillRect(0,0,t,i),u=y.getImageData(0,0,t,i),d=u.data,p=new Int32Array(d.length/4),f=r*n,m=new Int32Array(f),g=new Uint8Array(f);for(var M=0,R=p.length;M<R;M++)p[M]=D;for(M=0;M<f;M++)g[M]=T;ee(w)}(v.width,v.height)),!(e.z<-1||e.z>1||x.z<-1||x.z>1)){var F=Math.floor(.5*(V.linewidth-1)),z=e.x*o+c|0,j=x.x*o+c|0,k=e.y*a+l|0,G=x.y*a+l|0,W=e.z*s+h|0,X=x.z*s+h|0,Y=z-j,q=k-G,Z=W-X,J=Math.max(Math.min(z,j)+R>>S,0),Q=Math.min(Math.max(z,j)+R>>S,t),K=Math.max(Math.min(k,G)+R>>S,0),$=Math.min(Math.max(k,G)+R>>S,i),te=Math.max(Math.min(W,X)+R>>S,0),ie=Math.max(W,X)+R>>S;H=Math.min(J,H),I=Math.max(Q,I),B=Math.min(K,B),O=Math.max($,O);var re,ne,oe,ae,ce,le=Math.sqrt(q*q+Y*Y),he=Y/le,ue=q/le,de=Z/le;for(P.set(he,ue,de),P.cross(L),P.normalize();le>0;){re=(re=j+le*he)+R>>S,ne=(ne=G+le*ue)+R>>S,ce=X+le*de+R>>S;for(var pe=-F;pe<=F;++pe)if(oe=Math.floor(re+P.x*pe),ae=Math.floor(ne+P.y*pe),!(H>=oe||I<=oe||B>=ae||O<=ae)){var fe=oe>>A,me=ae>>A,ge=fe+me*r;if(!(m[ge]<te)){m[ge]=Math.min(m[ge],ie);var ve=g[ge];ve&M&&se(fe,me),g[ge]=ve&~(T|M);var ye=oe+ae*t;ce<p[ye]&&N(d,p,ye,ce,b,U,V)}}--le}}}function se(e,i){for(var r=e*_+i*_*t,n=4*r,o=t-_,a=4*o,s=0;s<_;s++){for(var c=0;c<_;c++)p[r++]=D,d[n++]=255*w.r|0,d[n++]=255*w.g|0,d[n++]=255*w.b|0,d[n++]=E?0:255;r+=o,n+=a}}this.domElement=v,this.autoClear=!0,this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(e){w.set(e),ee(w)},this.setPixelRatio=function(){},this.setSize=function(e,x){r=Math.floor(e/_),n=Math.floor(x/_);var b=1<<S;o=b*(t=r*_)/2,a=-b*(i=n*_)/2,s=D/2,c=b*t/2+.5,l=b*i/2+.5,h=D/2+.5,v.width=t,v.height=i,y.fillStyle=E?"rgba(0, 0, 0, 0)":w.getStyle(),y.fillRect(0,0,t,i),u=y.getImageData(0,0,t,i),d=u.data,p=new Int32Array(d.length/4),f=r*n,m=new Int32Array(f),g=new Uint8Array(f);for(var M=0,R=p.length;M<R;M++)p[M]=D;for(M=0;M<f;M++)g[M]=T;ee(w)},this.setSize(v.width,v.height),this.clear=function(){H=1/0,B=1/0,I=0,O=0,Z=0,Q=0,$=0;for(var e=0;e<f;e++)m[e]=D,g[e]=g[e]&T?T:M},this.render=function(e,t){this.clear();var i=e.background;i&&i.isColor&&ee(i);for(var o=z.projectScene(e,t,!1,!1).elements,a=0,s=o.length;a<s;a++){var c=o[a],l=c.material;if(p=ne(l))if(c instanceof THREE.RenderableFace)c.uvs?oe(c.v1.positionScreen,c.v2.positionScreen,c.v3.positionScreen,c.uvs[0],c.uvs[1],c.uvs[2],p,c,l):oe(c.v1.positionScreen,c.v2.positionScreen,c.v3.positionScreen,null,null,null,p,c,l);else if(c instanceof THREE.RenderableSprite){var h=.5*c.scale.x,d=.5*c.scale.y;j.copy(c),j.x-=h,j.y+=d,k.copy(c),k.x-=h,k.y-=d,G.copy(c),G.x+=h,G.y+=d,l.map?(W.set(0,1),X.set(0,0),Y.set(1,1),oe(j,k,G,W,X,Y,p,c,l)):oe(j,k,G,null,null,null,p,c,l),j.copy(c),j.x+=h,j.y+=d,k.copy(c),k.x-=h,k.y-=d,G.copy(c),G.x+=h,G.y-=d,l.map?(W.set(1,1),X.set(0,0),Y.set(1,0),oe(j,k,G,W,X,Y,p,c,l)):oe(j,k,G,null,null,null,p,c,l)}else if(c instanceof THREE.RenderableLine){var p=ne(l);ae(c.v1.positionScreen,c.v2.positionScreen,c.vertexColors[0],c.vertexColors[1],p,l)}}!function(){for(var e=0,t=0;t<n;t++)for(var i=0;i<r;i++)g[e]&M&&(se(i,t),g[e]=T),e++}();var f=Math.min(H,U),m=Math.min(B,N),v=Math.max(I,V)-f,E=Math.max(O,F)-m;f!==1/0&&y.putImageData(u,0,0,f,m,v,E),U=H,N=B,V=I,F=O}},THREE.SoftwareRenderer.Texture=function(){var e;this.fromImage=function(t){if(!(!t||t.width<=0||t.height<=0)){void 0===e&&(e=document.createElement("canvas"));var i=t.width>t.height?t.width:t.height;i=THREE.Math.nextPowerOfTwo(i),e.width==i&&e.height==i||(e.width=i,e.height=i);var r=e.getContext("2d");r.clearRect(0,0,i,i),r.drawImage(t,0,0,i,i);var n=r.getImageData(0,0,i,i);this.data=n.data,this.width=i,this.height=i,this.srcUrl=t.src}}},THREE.SVGObject=function(e){THREE.Object3D.call(this),this.node=e},THREE.SVGObject.prototype=Object.create(THREE.Object3D.prototype),THREE.SVGObject.prototype.constructor=THREE.SVGObject,THREE.SVGRenderer=function(){console.log("THREE.SVGRenderer",THREE.REVISION);var e,t,i,r,n,o,a,s,c,l,h,u,d,p=this,f=new THREE.Projector,m=document.createElementNS("http://www.w3.org/2000/svg","svg"),g=new THREE.Box2,v=new THREE.Box2,y=new THREE.Color,E=new THREE.Color,x=new THREE.Color,b=new THREE.Color,w=new THREE.Color,T=new THREE.Color,M=1,S=new THREE.Vector3,R=new THREE.Vector3,A=new THREE.Vector3,_=new THREE.Matrix3,D=new THREE.Matrix4,C=new THREE.Matrix4,L=[],P=0,H=1,B=null;function I(){for(P=0;m.childNodes.length>0;)m.removeChild(m.childNodes[0])}function O(e,t){var i=Math.floor(255*e.r)+","+Math.floor(255*e.g)+","+Math.floor(255*e.b);return void 0===t||1===t?"rgb("+i+")":"rgba("+i+","+t+")"}function U(e){return null!==B?e.toFixed(B):e}function N(e,t,i){var r=t.scale.x*o,n=t.scale.y*a;i.isPointsMaterial&&(r*=i.size,n*=i.size);var s="M"+U(e.x-.5*r)+","+U(e.y-.5*n)+"h"+U(r)+"v"+U(n)+"h"+U(-r)+"z",c="";(i.isSpriteMaterial||i.isPointsMaterial)&&(c="fill:"+O(i.color,i.opacity)),z(c,s)}function V(e,t,i,r){var n="M"+U(e.positionScreen.x)+","+U(e.positionScreen.y)+"L"+U(t.positionScreen.x)+","+U(t.positionScreen.y);if(r.isLineBasicMaterial){var o="fill:none;stroke:"+O(r.color,r.opacity)+";stroke-width:"+r.linewidth+";stroke-linecap:"+r.linecap;r.isLineDashedMaterial&&(o=o+";stroke-dasharray:"+r.dashSize+","+r.gapSize),z(o,n)}}function F(e,t,r,n,o){p.info.render.vertices+=3,p.info.render.faces++;var a="M"+U(e.positionScreen.x)+","+U(e.positionScreen.y)+"L"+U(t.positionScreen.x)+","+U(t.positionScreen.y)+"L"+U(r.positionScreen.x)+","+U(r.positionScreen.y)+"z";o instanceof THREE.MeshBasicMaterial?(y.copy(o.color),o.vertexColors===THREE.FaceColors&&y.multiply(n.color)):o instanceof THREE.MeshLambertMaterial||o instanceof THREE.MeshPhongMaterial?(E.copy(o.color),o.vertexColors===THREE.FaceColors&&E.multiply(n.color),y.copy(x),R.copy(e.positionWorld).add(t.positionWorld).add(r.positionWorld).divideScalar(3),function(e,t,i,r){for(var n=0,o=e.length;n<o;n++){var a=e[n],s=a.color;if(a instanceof THREE.DirectionalLight){var c=S.setFromMatrixPosition(a.matrixWorld).normalize();if((l=i.dot(c))<=0)continue;l*=a.intensity,r.r+=s.r*l,r.g+=s.g*l,r.b+=s.b*l}else if(a instanceof THREE.PointLight){var l;if(c=S.setFromMatrixPosition(a.matrixWorld),(l=i.dot(S.subVectors(c,t).normalize()))<=0)continue;if(0==(l*=0==a.distance?1:1-Math.min(t.distanceTo(c)/a.distance,1)))continue;l*=a.intensity,r.r+=s.r*l,r.g+=s.g*l,r.b+=s.b*l}}}(i,R,n.normalModel,y),y.multiply(E).add(o.emissive)):o instanceof THREE.MeshNormalMaterial&&(A.copy(n.normalModel).applyMatrix3(_),y.setRGB(A.x,A.y,A.z).multiplyScalar(.5).addScalar(.5)),z(o.wireframe?"fill:none;stroke:"+O(y,o.opacity)+";stroke-width:"+o.wireframeLinewidth+";stroke-linecap:"+o.wireframeLinecap+";stroke-linejoin:"+o.wireframeLinejoin:"fill:"+O(y,o.opacity),a)}function z(e,t){d===e?u+=t:(j(),d=e,u=t)}function j(){u&&((h=function(e){if(null==L[e])return L[e]=document.createElementNS("http://www.w3.org/2000/svg","path"),0==H&&L[e].setAttribute("shape-rendering","crispEdges"),L[e];return L[e]}(P++)).setAttribute("d",u),h.setAttribute("style",d),m.appendChild(h)),u="",d=""}this.domElement=m,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.setQuality=function(e){switch(e){case"high":H=1;break;case"low":H=0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(e,t){T.set(e),M=void 0!==t?t:1},this.setPixelRatio=function(){},this.setSize=function(e,t){o=(r=e)/2,a=(n=t)/2,m.setAttribute("viewBox",-o+" "+-a+" "+r+" "+n),m.setAttribute("width",r),m.setAttribute("height",n),g.min.set(-o,-a),g.max.set(o,a)},this.setPrecision=function(e){B=e},this.clear=function(){I(),m.style.backgroundColor=O(T,M)},this.render=function(r,n){if(n instanceof THREE.Camera!=!1){var h=r.background;h&&h.isColor?(I(),m.style.backgroundColor=O(h)):!0===this.autoClear&&this.clear(),p.info.render.vertices=0,p.info.render.faces=0,D.copy(n.matrixWorldInverse),C.multiplyMatrices(n.projectionMatrix,D),e=f.projectScene(r,n,this.sortObjects,this.sortElements),t=e.elements,i=e.lights,_.getNormalMatrix(n.matrixWorldInverse),function(e){x.setRGB(0,0,0),b.setRGB(0,0,0),w.setRGB(0,0,0);for(var t=0,i=e.length;t<i;t++){var r=e[t],n=r.color;r instanceof THREE.AmbientLight?(x.r+=n.r,x.g+=n.g,x.b+=n.b):r instanceof THREE.DirectionalLight?(b.r+=n.r,b.g+=n.g,b.b+=n.b):r instanceof THREE.PointLight&&(w.r+=n.r,w.g+=n.g,w.b+=n.b)}}(i),u="",d="";for(var y=0,E=t.length;y<E;y++){var T=t[y],M=T.material;if(void 0!==M&&0!==M.opacity)if(v.makeEmpty(),T instanceof THREE.RenderableSprite)(s=T).x*=o,s.y*=-a,N(s,T,M);else if(T instanceof THREE.RenderableLine)s=T.v1,c=T.v2,s.positionScreen.x*=o,s.positionScreen.y*=-a,c.positionScreen.x*=o,c.positionScreen.y*=-a,v.setFromPoints([s.positionScreen,c.positionScreen]),!0===g.intersectsBox(v)&&V(s,c,T,M);else if(T instanceof THREE.RenderableFace){if(s=T.v1,c=T.v2,l=T.v3,s.positionScreen.z<-1||s.positionScreen.z>1)continue;if(c.positionScreen.z<-1||c.positionScreen.z>1)continue;if(l.positionScreen.z<-1||l.positionScreen.z>1)continue;s.positionScreen.x*=o,s.positionScreen.y*=-a,c.positionScreen.x*=o,c.positionScreen.y*=-a,l.positionScreen.x*=o,l.positionScreen.y*=-a,v.setFromPoints([s.positionScreen,c.positionScreen,l.positionScreen]),!0===g.intersectsBox(v)&&F(s,c,l,T,M)}}j(),r.traverseVisible(function(e){if(e instanceof THREE.SVGObject){S.setFromMatrixPosition(e.matrixWorld),S.applyMatrix4(C);var t=S.x*o,i=-S.y*a,r=e.node;r.setAttribute("transform","translate("+t+","+i+")"),m.appendChild(r)}})}else console.error("THREE.SVGRenderer.render: camera is not an instance of THREE.Camera.")}},THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},r=e.getSize();(t=new THREE.WebGLRenderTarget(r.width,r.height,i)).texture.name="EffectComposer.rt1"}this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),void 0===THREE.ShaderPass&&console.error("THREE.EffectComposer relies on THREE.ShaderPass"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},Object.assign(THREE.EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);var t=this.renderer.getSize();e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){var t,i,r=!1,n=this.passes.length;for(i=0;i<n;i++)if(!1!==(t=this.passes[i]).enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,r),t.needsSwap){if(r){var o=this.renderer.context;o.stencilFunc(o.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),o.stencilFunc(o.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==THREE.MaskPass&&(t instanceof THREE.MaskPass?r=!0:t instanceof THREE.ClearMaskPass&&(r=!1))}},reset:function(e){if(void 0===e){var t=this.renderer.getSize();(e=this.renderTarget1.clone()).setSize(t.width,t.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var i=0;i<this.passes.length;i++)this.passes[i].setSize(e,t)}}),THREE.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(THREE.Pass.prototype,{setSize:function(e,t){},render:function(e,t,i,r,n){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),THREE.MaskPass=function(e,t){THREE.Pass.call(this),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1},THREE.MaskPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.MaskPass,render:function(e,t,i,r,n){var o,a,s=e.context,c=e.state;c.buffers.color.setMask(!1),c.buffers.depth.setMask(!1),c.buffers.color.setLocked(!0),c.buffers.depth.setLocked(!0),this.inverse?(o=0,a=1):(o=1,a=0),c.buffers.stencil.setTest(!0),c.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),c.buffers.stencil.setFunc(s.ALWAYS,o,4294967295),c.buffers.stencil.setClear(a),e.render(this.scene,this.camera,i,this.clear),e.render(this.scene,this.camera,t,this.clear),c.buffers.color.setLocked(!1),c.buffers.depth.setLocked(!1),c.buffers.stencil.setFunc(s.EQUAL,1,4294967295),c.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP)}}),THREE.ClearMaskPass=function(){THREE.Pass.call(this),this.needsSwap=!1},THREE.ClearMaskPass.prototype=Object.create(THREE.Pass.prototype),Object.assign(THREE.ClearMaskPass.prototype,{render:function(e,t,i,r,n){e.state.buffers.stencil.setTest(!1)}}),THREE.ShaderPass=function(e,t){THREE.Pass.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},THREE.ShaderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ShaderPass,render:function(e,t,i,r,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}}),THREE.RenderPass=function(e,t,i,r,n){THREE.Pass.call(this),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=r,this.clearAlpha=void 0!==n?n:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1},THREE.RenderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.RenderPass,render:function(e,t,i,r,n){var o,a,s=e.autoClear;e.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(o=e.getClearColor().getHex(),a=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.render(this.scene,this.camera,this.renderToScreen?null:i,this.clear),this.clearColor&&e.setClearColor(o,a),this.scene.overrideMaterial=null,e.autoClear=s}}),THREE.OutlinePass=function(e,t,i,r){this.renderScene=t,this.renderCamera=i,this.selectedObjects=void 0!==r?r:[],this.visibleEdgeColor=new THREE.Color(1,1,1),this.hiddenEdgeColor=new THREE.Color(.1,.04,.02),this.edgeGlow=0,this.usePatternTexture=!1,this.edgeThickness=1,this.edgeStrength=3,this.downSampleRatio=2,this.pulsePeriod=0,THREE.Pass.call(this),this.resolution=void 0!==e?new THREE.Vector2(e.x,e.y):new THREE.Vector2(256,256);var n={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},o=Math.round(this.resolution.x/this.downSampleRatio),a=Math.round(this.resolution.y/this.downSampleRatio);this.maskBufferMaterial=new THREE.MeshBasicMaterial({color:16777215}),this.maskBufferMaterial.side=THREE.DoubleSide,this.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,n),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=THREE.DoubleSide,this.renderTargetDepthBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,n),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(o,a,n),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(o,a,n),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.renderTargetBlurBuffer2=new THREE.WebGLRenderTarget(Math.round(o/2),Math.round(a/2),n),this.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",this.renderTargetBlurBuffer2.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new THREE.WebGLRenderTarget(o,a,n),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer2=new THREE.WebGLRenderTarget(Math.round(o/2),Math.round(a/2),n),this.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",this.renderTargetEdgeBuffer2.texture.generateMipmaps=!1;this.separableBlurMaterial1=this.getSeperableBlurMaterial(4),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(o,a),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.separableBlurMaterial2=this.getSeperableBlurMaterial(4),this.separableBlurMaterial2.uniforms.texSize.value=new THREE.Vector2(Math.round(o/2),Math.round(a/2)),this.separableBlurMaterial2.uniforms.kernelRadius.value=4,this.overlayMaterial=this.getOverlayMaterial(),void 0===THREE.CopyShader&&console.error("THREE.OutlinePass relies on THREE.CopyShader");var s=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(s.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.tempPulseColor1=new THREE.Color,this.tempPulseColor2=new THREE.Color,this.textureMatrix=new THREE.Matrix4},THREE.OutlinePass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.OutlinePass,dispose:function(){this.renderTargetMaskBuffer.dispose(),this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetBlurBuffer2.dispose(),this.renderTargetEdgeBuffer1.dispose(),this.renderTargetEdgeBuffer2.dispose()},setSize:function(e,t){this.renderTargetMaskBuffer.setSize(e,t);var i=Math.round(e/this.downSampleRatio),r=Math.round(t/this.downSampleRatio);this.renderTargetMaskDownSampleBuffer.setSize(i,r),this.renderTargetBlurBuffer1.setSize(i,r),this.renderTargetEdgeBuffer1.setSize(i,r),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(i,r),i=Math.round(i/2),r=Math.round(r/2),this.renderTargetBlurBuffer2.setSize(i,r),this.renderTargetEdgeBuffer2.setSize(i,r),this.separableBlurMaterial2.uniforms.texSize.value=new THREE.Vector2(i,r)},changeVisibilityOfSelectedObjects:function(e){function t(t){t instanceof THREE.Mesh&&(t.visible=e)}for(var i=0;i<this.selectedObjects.length;i++){this.selectedObjects[i].traverse(t)}},changeVisibilityOfNonSelectedObjects:function(e){var t=[];function i(e){e instanceof THREE.Mesh&&t.push(e)}for(var r=0;r<this.selectedObjects.length;r++){this.selectedObjects[r].traverse(i)}this.renderScene.traverse(function(i){if(i instanceof THREE.Mesh){for(var r=!1,n=0;n<t.length;n++)if(t[n].id===i.id){r=!0;break}if(!r){var o=i.visible;e&&!i.bVisible||(i.visible=e),i.bVisible=o}}})},updateTextureMatrix:function(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)},render:function(e,t,i,r,n){if(0!==this.selectedObjects.length){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var o=e.autoClear;if(e.autoClear=!1,n&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(16777215,1),this.changeVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.depthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!0),this.changeVisibilityOfSelectedObjects(!0),this.updateTextureMatrix(),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0),this.tempPulseColor1.copy(this.visibleEdgeColor),this.tempPulseColor2.copy(this.hiddenEdgeColor),this.pulsePeriod>0){var a=.625+.75*Math.cos(.01*performance.now()/this.pulsePeriod)/2;this.tempPulseColor1.multiplyScalar(a),this.tempPulseColor2.multiplyScalar(a)}this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=this.tempPulseColor1,this.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=this.tempPulseColor2,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=THREE.OutlinePass.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,e.render(this.scene,this.camera,this.renderTargetBlurBuffer1,!0),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=THREE.OutlinePass.BlurDirectionY,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.separableBlurMaterial2,this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial2.uniforms.direction.value=THREE.OutlinePass.BlurDirectionX,e.render(this.scene,this.camera,this.renderTargetBlurBuffer2,!0),this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetBlurBuffer2.texture,this.separableBlurMaterial2.uniforms.direction.value=THREE.OutlinePass.BlurDirectionY,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer2,!0),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.renderTargetEdgeBuffer2.texture,this.overlayMaterial.uniforms.patternTexture.value=this.patternTexture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,this.overlayMaterial.uniforms.edgeGlow.value=this.edgeGlow,this.overlayMaterial.uniforms.usePatternTexture.value=this.usePatternTexture,n&&e.context.enable(e.context.STENCIL_TEST),e.render(this.scene,this.camera,i,!1),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=o}},getPrepareMaskMaterial:function(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"varying vec2 vUv;\t\t\t\tvarying vec4 projTexCoord;\t\t\t\tvarying vec4 vPosition;\t\t\t\tuniform mat4 textureMatrix;\t\t\t\tvoid main() {\t\t\t\t\tvUv = uv;\t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <packing>\t\t\t\tvarying vec2 vUv;\t\t\t\tvarying vec4 vPosition;\t\t\t\tvarying vec4 projTexCoord;\t\t\t\tuniform sampler2D depthTexture;\t\t\t\tuniform vec2 cameraNearFar;\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\t\t\t\t\tfloat viewZ = -perspectiveDepthToViewZ( depth, cameraNearFar.x, cameraNearFar.y );\t\t\t\t\tfloat depthTest = (-vPosition.z > viewZ) ? 1.0 : 0.0;\t\t\t\t\tgl_FragColor = vec4(0.0, depthTest, 1.0, 1.0);\t\t\t\t}"})},getEdgeDetectionMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},visibleEdgeColor:{value:new THREE.Vector3(1,1,1)},hiddenEdgeColor:{value:new THREE.Vector3(1,1,1)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec3 visibleEdgeColor;\t\t\t\tuniform vec3 hiddenEdgeColor;\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tvec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\t\t\t\t\tvec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);\t\t\t\t\tvec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);\t\t\t\t\tvec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);\t\t\t\t\tvec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);\t\t\t\t\tfloat diff1 = (c1.r - c2.r)*0.5;\t\t\t\t\tfloat diff2 = (c3.r - c4.r)*0.5;\t\t\t\t\tfloat d = length( vec2(diff1, diff2) );\t\t\t\t\tfloat a1 = min(c1.g, c2.g);\t\t\t\t\tfloat a2 = min(c3.g, c4.g);\t\t\t\t\tfloat visibilityFactor = min(a1, a2);\t\t\t\t\tvec3 edgeColor = 1.0 - visibilityFactor > 0.001 ? visibleEdgeColor : hiddenEdgeColor;\t\t\t\t\tgl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\t\t\t\t}"})},getSeperableBlurMaterial:function(e){return new THREE.ShaderMaterial({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\t\t\t\tuniform sampler2D colorTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\tuniform float kernelRadius;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, kernelRadius);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tvec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\t\t\t\t\tvec2 uvOffset = delta;\t\t\t\t\tfor( int i = 1; i <= MAX_RADIUS; i ++ ) {\t\t\t\t\t\tfloat w = gaussianPdf(uvOffset.x, kernelRadius);\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += ((sample1 + sample2) * w);\t\t\t\t\t\tweightSum += (2.0 * w);\t\t\t\t\t\tuvOffset += delta;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\t\t\t\t}"})},getOverlayMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},patternTexture:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},usePatternTexture:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform sampler2D edgeTexture1;\t\t\t\tuniform sampler2D edgeTexture2;\t\t\t\tuniform sampler2D patternTexture;\t\t\t\tuniform float edgeStrength;\t\t\t\tuniform float edgeGlow;\t\t\t\tuniform bool usePatternTexture;\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tvec4 edgeValue1 = texture2D(edgeTexture1, vUv);\t\t\t\t\tvec4 edgeValue2 = texture2D(edgeTexture2, vUv);\t\t\t\t\tvec4 maskColor = texture2D(maskTexture, vUv);\t\t\t\t\tvec4 patternColor = texture2D(patternTexture, 6.0 * vUv);\t\t\t\t\tfloat visibilityFactor = 1.0 - maskColor.g > 0.0 ? 1.0 : 0.5;\t\t\t\t\tvec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;\t\t\t\t\tvec4 finalColor = edgeStrength * maskColor.r * edgeValue;\t\t\t\t\tif(usePatternTexture)\t\t\t\t\t\tfinalColor += + visibilityFactor * (1.0 - maskColor.r) * (1.0 - patternColor.r);\t\t\t\t\tgl_FragColor = finalColor;\t\t\t\t}",blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}),THREE.OutlinePass.BlurDirectionX=new THREE.Vector2(1,0),THREE.OutlinePass.BlurDirectionY=new THREE.Vector2(0,1),THREE.VREffect=function(e,t){var i,r,n,o,a=new THREE.Vector3,s=new THREE.Vector3,c=new THREE.Matrix4,l=new THREE.Matrix4,h=new THREE.Matrix4,u=null;"VRFrameData"in window&&(u=new window.VRFrameData),navigator.getVRDisplays&&navigator.getVRDisplays().then(function(e){r=e,e.length>0?i=e[0]:t&&t("HMD not available")}).catch(function(){console.warn("THREE.VREffect: Unable to get VR Displays")}),this.isPresenting=!1;var d=this,p=e.getSize(),f=!1,m=e.getPixelRatio();this.getVRDisplay=function(){return i},this.setVRDisplay=function(e){i=e},this.getVRDisplays=function(){return console.warn("THREE.VREffect: getVRDisplays() is being deprecated."),r},this.setSize=function(t,r,n){if(p={width:t,height:r},f=n,d.isPresenting){var o=i.getEyeParameters("left");e.setPixelRatio(1),e.setSize(2*o.renderWidth,o.renderHeight,!1)}else e.setPixelRatio(m),e.setSize(t,r,n)};var g=e.domElement,v=[0,0,.5,1],y=[.5,0,.5,1];function E(){var t=d.isPresenting;if(d.isPresenting=void 0!==i&&i.isPresenting,d.isPresenting){var r=i.getEyeParameters("left"),n=r.renderWidth,o=r.renderHeight;t||(m=e.getPixelRatio(),p=e.getSize(),e.setPixelRatio(1),e.setSize(2*n,o,!1))}else t&&(e.setPixelRatio(m),e.setSize(p.width,p.height,f))}window.addEventListener("vrdisplaypresentchange",E,!1),this.setFullScreen=function(e){return new Promise(function(t,r){void 0!==i?d.isPresenting!==e?t(e?i.requestPresent([{source:g}]):i.exitPresent()):t():r(new Error("No VR hardware found."))})},this.requestPresent=function(){return this.setFullScreen(!0)},this.exitPresent=function(){return this.setFullScreen(!1)},this.requestAnimationFrame=function(e){return void 0!==i?i.requestAnimationFrame(e):window.requestAnimationFrame(e)},this.cancelAnimationFrame=function(e){void 0!==i?i.cancelAnimationFrame(e):window.cancelAnimationFrame(e)},this.submitFrame=function(){void 0!==i&&d.isPresenting&&i.submitFrame()},this.autoSubmitFrame=!0;var x=new THREE.PerspectiveCamera;x.layers.enable(1);var b=new THREE.PerspectiveCamera;b.layers.enable(2),this.render=function(t,r,p,f){if(i&&d.isPresenting){var m=t.autoUpdate;m&&(t.updateMatrixWorld(),t.autoUpdate=!1),Array.isArray(t)&&(console.warn("THREE.VREffect.render() no longer supports arrays. Use object.layers instead."),t=t[0]);var g,E,S=e.getSize(),R=i.getLayers();if(R.length){var A=R[0];g=null!==A.leftBounds&&4===A.leftBounds.length?A.leftBounds:v,E=null!==A.rightBounds&&4===A.rightBounds.length?A.rightBounds:y}else g=v,E=y;if(n={x:Math.round(S.width*g[0]),y:Math.round(S.height*g[1]),width:Math.round(S.width*g[2]),height:Math.round(S.height*g[3])},o={x:Math.round(S.width*E[0]),y:Math.round(S.height*E[1]),width:Math.round(S.width*E[2]),height:Math.round(S.height*E[3])},p?(e.setRenderTarget(p),p.scissorTest=!0):(e.setRenderTarget(null),e.setScissorTest(!0)),(e.autoClear||f)&&e.clear(),null===r.parent&&r.updateMatrixWorld(),r.matrixWorld.decompose(x.position,x.quaternion,x.scale),b.position.copy(x.position),b.quaternion.copy(x.quaternion),b.scale.copy(x.scale),i.getFrameData)i.depthNear=r.near,i.depthFar=r.far,i.getFrameData(u),x.projectionMatrix.elements=u.leftProjectionMatrix,b.projectionMatrix.elements=u.rightProjectionMatrix,function(e){e.pose.orientation?(w.fromArray(e.pose.orientation),c.makeRotationFromQuaternion(w)):c.identity();e.pose.position&&(T.fromArray(e.pose.position),c.setPosition(T));l.fromArray(e.leftViewMatrix),l.multiply(c),h.fromArray(e.rightViewMatrix),h.multiply(c),l.getInverse(l),h.getInverse(h)}(u),x.updateMatrix(),x.matrix.multiply(l),x.matrix.decompose(x.position,x.quaternion,x.scale),b.updateMatrix(),b.matrix.multiply(h),b.matrix.decompose(b.position,b.quaternion,b.scale);else{var _=i.getEyeParameters("left"),D=i.getEyeParameters("right");x.projectionMatrix=M(_.fieldOfView,!0,r.near,r.far),b.projectionMatrix=M(D.fieldOfView,!0,r.near,r.far),a.fromArray(_.offset),s.fromArray(D.offset),x.translateOnAxis(a,x.scale.x),b.translateOnAxis(s,b.scale.x)}return p?(p.viewport.set(n.x,n.y,n.width,n.height),p.scissor.set(n.x,n.y,n.width,n.height)):(e.setViewport(n.x,n.y,n.width,n.height),e.setScissor(n.x,n.y,n.width,n.height)),e.render(t,x,p,f),p?(p.viewport.set(o.x,o.y,o.width,o.height),p.scissor.set(o.x,o.y,o.width,o.height)):(e.setViewport(o.x,o.y,o.width,o.height),e.setScissor(o.x,o.y,o.width,o.height)),e.render(t,b,p,f),p?(p.viewport.set(0,0,S.width,S.height),p.scissor.set(0,0,S.width,S.height),p.scissorTest=!1,e.setRenderTarget(null)):(e.setViewport(0,0,S.width,S.height),e.setScissorTest(!1)),m&&(t.autoUpdate=!0),void(d.autoSubmitFrame&&d.submitFrame())}e.render(t,r,p,f)},this.dispose=function(){window.removeEventListener("vrdisplaypresentchange",E,!1)};var w=new THREE.Quaternion,T=new THREE.Vector3;function M(e,t,i,r){var n=Math.PI/180;return function(e,t,i,r){t=void 0===t||t,i=void 0===i?.01:i,r=void 0===r?1e4:r;var n=t?-1:1,o=new THREE.Matrix4,a=o.elements,s=function(e){var t=2/(e.leftTan+e.rightTan),i=(e.leftTan-e.rightTan)*t*.5,r=2/(e.upTan+e.downTan);return{scale:[t,r],offset:[i,(e.upTan-e.downTan)*r*.5]}}(e);return a[0]=s.scale[0],a[1]=0,a[2]=s.offset[0]*n,a[3]=0,a[4]=0,a[5]=s.scale[1],a[6]=-s.offset[1]*n,a[7]=0,a[8]=0,a[9]=0,a[10]=r/(i-r)*-n,a[11]=r*i/(i-r),a[12]=0,a[13]=0,a[14]=n,a[15]=0,o.transpose(),o}({upTan:Math.tan(e.upDegrees*n),downTan:Math.tan(e.downDegrees*n),leftTan:Math.tan(e.leftDegrees*n),rightTan:Math.tan(e.rightDegrees*n)},t,i,r)}},THREE.VRControls=function(e,t){var i,r,n=this,o=new THREE.Matrix4,a=null;"VRFrameData"in window&&(a=new VRFrameData),navigator.getVRDisplays&&navigator.getVRDisplays().then(function(e){r=e,e.length>0?i=e[0]:t&&t("VR input not available.")}).catch(function(){console.warn("THREE.VRControls: Unable to get VR Displays")}),this.scale=1,this.standing=!1,this.userHeight=1.6,this.getVRDisplay=function(){return i},this.setVRDisplay=function(e){i=e},this.getVRDisplays=function(){return console.warn("THREE.VRControls: getVRDisplays() is being deprecated."),r},this.getStandingMatrix=function(){return o},this.update=function(){var t;i&&(i.getFrameData?(i.getFrameData(a),t=a.pose):i.getPose&&(t=i.getPose()),null!==t.orientation&&e.quaternion.fromArray(t.orientation),null!==t.position?e.position.fromArray(t.position):e.position.set(0,0,0),this.standing&&(i.stageParameters?(e.updateMatrix(),o.fromArray(i.stageParameters.sittingToStandingTransform),e.applyMatrix(o)):e.position.setY(e.position.y+this.userHeight)),e.position.multiplyScalar(n.scale))},this.dispose=function(){i=null}},function(e){function t(e,t,i,r,n){this._listener=t,this._isOnce=i,this.context=r,this._signal=e,this._priority=n||0}function i(e,t){if("function"!=typeof e)throw Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",t))}var r={VERSION:"0.7.4"};t.prototype={active:!0,params:null,execute:function(e){var t;return this.active&&this._listener&&(e=this.params?this.params.concat(e):e,t=this._listener.apply(this.context,e),this._isOnce&&this.detach()),t},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},getListener:function(){return this._listener},_destroy:function(){delete this._signal,delete this._listener,delete this.context},isOnce:function(){return this._isOnce},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},r.Signal=function(){this._bindings=[],this._prevParams=null},r.Signal.prototype={memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(e,i,r,n){var o=this._indexOfListener(e,r);if(-1!==o){if((e=this._bindings[o]).isOnce()!==i)throw Error("You cannot add"+(i?"":"Once")+"() then add"+(i?"Once":"")+"() the same listener without removing the relationship first.")}else e=new t(this,e,i,r,n),this._addBinding(e);return this.memorize&&this._prevParams&&e.execute(this._prevParams),e},_addBinding:function(e){var t=this._bindings.length;do{--t}while(this._bindings[t]&&e._priority<=this._bindings[t]._priority);this._bindings.splice(t+1,0,e)},_indexOfListener:function(e,t){for(var i,r=this._bindings.length;r--;)if((i=this._bindings[r])._listener===e&&i.context===t)return r;return-1},has:function(e,t){return-1!==this._indexOfListener(e,t)},add:function(e,t,r){return i(e,"add"),this._registerListener(e,!1,t,r)},addOnce:function(e,t,r){return i(e,"addOnce"),this._registerListener(e,!0,t,r)},remove:function(e,t){i(e,"remove");var r=this._indexOfListener(e,t);return-1!==r&&(this._bindings[r]._destroy(),this._bindings.splice(r,1)),e},removeAll:function(){for(var e=this._bindings.length;e--;)this._bindings[e]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(e){if(this.active){var t,i=Array.prototype.slice.call(arguments),r=this._bindings.length;if(this.memorize&&(this._prevParams=i),r){t=this._bindings.slice(),this._shouldPropagate=!0;do{r--}while(t[r]&&this._shouldPropagate&&!1!==t[r].execute(i))}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}},"function"==typeof define&&define.amd?define(r):"undefined"!=typeof module&&module.exports?module.exports=r:e.signals=r}(this);var UI={Element:function(e){this.dom=e}};UI.Element.prototype={add:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];t instanceof UI.Element?this.dom.appendChild(t.dom):console.error("UI.Element:",t,"is not an instance of UI.Element.")}return this},remove:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];t instanceof UI.Element?this.dom.removeChild(t.dom):console.error("UI.Element:",t,"is not an instance of UI.Element.")}return this},clear:function(){for(;this.dom.children.length;)this.dom.removeChild(this.dom.lastChild)},setId:function(e){return this.dom.id=e,this},setClass:function(e){return this.dom.className=e,this},setStyle:function(e,t){for(var i=0;i<t.length;i++)this.dom.style[e]=t[i];return this},setDisabled:function(e){return this.dom.disabled=e,this},setTextContent:function(e){return this.dom.textContent=e,this}};var properties=["position","left","top","right","bottom","width","height","border","borderLeft","borderTop","borderRight","borderBottom","borderColor","display","overflow","margin","marginLeft","marginTop","marginRight","marginBottom","padding","paddingLeft","paddingTop","paddingRight","paddingBottom","color","background","backgroundColor","opacity","fontSize","fontWeight","textAlign","textDecoration","textTransform","cursor","zIndex"];properties.forEach(function(e){var t="set"+e.substr(0,1).toUpperCase()+e.substr(1,e.length);UI.Element.prototype[t]=function(){return this.setStyle(e,arguments),this}});var events=["KeyUp","KeyDown","MouseOver","MouseOut","Click","DblClick","Change"];events.forEach(function(e){var t="on"+e;UI.Element.prototype[t]=function(t){return this.dom.addEventListener(e.toLowerCase(),t.bind(this),!1),this}}),UI.Span=function(){return UI.Element.call(this),this.dom=document.createElement("span"),this},UI.Span.prototype=Object.create(UI.Element.prototype),UI.Span.prototype.constructor=UI.Span,UI.Div=function(){return UI.Element.call(this),this.dom=document.createElement("div"),this},UI.Div.prototype=Object.create(UI.Element.prototype),UI.Div.prototype.constructor=UI.Div,UI.Row=function(){UI.Element.call(this);var e=document.createElement("div");return e.className="Row",this.dom=e,this},UI.Row.prototype=Object.create(UI.Element.prototype),UI.Row.prototype.constructor=UI.Row,UI.Panel=function(){UI.Element.call(this);var e=document.createElement("div");return e.className="Panel",this.dom=e,this},UI.Panel.prototype=Object.create(UI.Element.prototype),UI.Panel.prototype.constructor=UI.Panel,UI.Text=function(e){UI.Element.call(this);var t=document.createElement("span");return t.className="Text",t.style.cursor="default",t.style.display="inline-block",t.style.verticalAlign="middle",this.dom=t,this.setValue(e),this},UI.Text.prototype=Object.create(UI.Element.prototype),UI.Text.prototype.constructor=UI.Text,UI.Text.prototype.getValue=function(){return this.dom.textContent},UI.Text.prototype.setValue=function(e){return void 0!==e&&(this.dom.textContent=e),this},UI.Input=function(e){UI.Element.call(this);var t=document.createElement("input");return t.className="Input",t.style.padding="2px",t.style.border="1px solid transparent",t.addEventListener("keydown",function(e){e.stopPropagation()},!1),this.dom=t,this.setValue(e),this},UI.Input.prototype=Object.create(UI.Element.prototype),UI.Input.prototype.constructor=UI.Input,UI.Input.prototype.getValue=function(){return this.dom.value},UI.Input.prototype.setValue=function(e){return this.dom.value=e,this},UI.TextArea=function(){UI.Element.call(this);var e=document.createElement("textarea");return e.className="TextArea",e.style.padding="2px",e.spellcheck=!1,e.addEventListener("keydown",function(t){if(t.stopPropagation(),9===t.keyCode){t.preventDefault();var i=e.selectionStart;e.value=e.value.substring(0,i)+"\t"+e.value.substring(i),e.selectionStart=i+1,e.selectionEnd=e.selectionStart}},!1),this.dom=e,this},UI.TextArea.prototype=Object.create(UI.Element.prototype),UI.TextArea.prototype.constructor=UI.TextArea,UI.TextArea.prototype.getValue=function(){return this.dom.value},UI.TextArea.prototype.setValue=function(e){return this.dom.value=e,this},UI.Select=function(){UI.Element.call(this);var e=document.createElement("select");return e.className="Select",e.style.padding="2px",this.dom=e,this},UI.Select.prototype=Object.create(UI.Element.prototype),UI.Select.prototype.constructor=UI.Select,UI.Select.prototype.setMultiple=function(e){return this.dom.multiple=e,this},UI.Select.prototype.setOptions=function(e){for(var t=this.dom.value;this.dom.children.length>0;)this.dom.removeChild(this.dom.firstChild);for(var i in e){var r=document.createElement("option");r.value=i,r.innerHTML=e[i],this.dom.appendChild(r)}return this.dom.value=t,this},UI.Select.prototype.getValue=function(){return this.dom.value},UI.Select.prototype.setValue=function(e){return e=String(e),this.dom.value!==e&&(this.dom.value=e),this},UI.Checkbox=function(e){UI.Element.call(this);var t=document.createElement("input");return t.className="Checkbox",t.type="checkbox",this.dom=t,this.setValue(e),this},UI.Checkbox.prototype=Object.create(UI.Element.prototype),UI.Checkbox.prototype.constructor=UI.Checkbox,UI.Checkbox.prototype.getValue=function(){return this.dom.checked},UI.Checkbox.prototype.setValue=function(e){return void 0!==e&&(this.dom.checked=e),this},UI.Color=function(){UI.Element.call(this);var e=document.createElement("input");e.className="Color",e.style.width="64px",e.style.height="17px",e.style.border="0px",e.style.padding="2px",e.style.backgroundColor="transparent";try{e.type="color",e.value="#ffffff"}catch(e){}return this.dom=e,this},UI.Color.prototype=Object.create(UI.Element.prototype),UI.Color.prototype.constructor=UI.Color,UI.Color.prototype.getValue=function(){return this.dom.value},UI.Color.prototype.getHexValue=function(){return parseInt(this.dom.value.substr(1),16)},UI.Color.prototype.setValue=function(e){return this.dom.value=e,this},UI.Color.prototype.setHexValue=function(e){return this.dom.value="#"+("000000"+e.toString(16)).slice(-6),this},UI.Number=function(e){UI.Element.call(this);var t=this,i=document.createElement("input");i.className="Number",i.value="0.00",i.addEventListener("keydown",function(e){e.stopPropagation(),13===e.keyCode&&i.blur()},!1),this.value=0,this.min=-1/0,this.max=1/0,this.precision=2,this.step=1,this.unit="",this.dom=i,this.setValue(e);var r=document.createEvent("HTMLEvents");r.initEvent("change",!0,!0);var n=0,o=0,a=[0,0],s=[0,0];function c(e){var c=t.value;a=[e.clientX,e.clientY],n+=a[0]-s[0]-(a[1]-s[1]);var l=o+n/(e.shiftKey?5:50)*t.step;c!==(l=Math.min(t.max,Math.max(t.min,l)))&&(t.setValue(l),i.dispatchEvent(r)),s=[e.clientX,e.clientY]}function l(e){document.removeEventListener("mousemove",c,!1),document.removeEventListener("mouseup",l,!1),Math.abs(n)<2&&(i.focus(),i.select())}function h(e){i.style.backgroundColor="transparent",i.style.cursor="col-resize"}return h(),i.addEventListener("mousedown",function(e){e.preventDefault(),n=0,o=t.value,s=[e.clientX,e.clientY],document.addEventListener("mousemove",c,!1),document.addEventListener("mouseup",l,!1)},!1),i.addEventListener("change",function(e){t.setValue(i.value)},!1),i.addEventListener("focus",function(e){i.style.backgroundColor="",i.style.cursor=""},!1),i.addEventListener("blur",h,!1),this},UI.Number.prototype=Object.create(UI.Element.prototype),UI.Number.prototype.constructor=UI.Number,UI.Number.prototype.getValue=function(){return this.value},UI.Number.prototype.setValue=function(e){return void 0!==e&&((e=parseFloat(e))<this.min&&(e=this.min),e>this.max&&(e=this.max),this.value=e,this.dom.value=e.toFixed(this.precision),""!==this.unit&&(this.dom.value+=" "+this.unit)),this},UI.Number.prototype.setPrecision=function(e){return this.precision=e,this},UI.Number.prototype.setStep=function(e){return this.step=e,this},UI.Number.prototype.setRange=function(e,t){return this.min=e,this.max=t,this},UI.Number.prototype.setUnit=function(e){return this.unit=e,this},UI.Integer=function(e){UI.Element.call(this);var t=this,i=document.createElement("input");i.className="Number",i.value="0",i.addEventListener("keydown",function(e){e.stopPropagation()},!1),this.value=0,this.min=-1/0,this.max=1/0,this.step=1,this.dom=i,this.setValue(e);var r=document.createEvent("HTMLEvents");r.initEvent("change",!0,!0);var n=0,o=0,a=[0,0],s=[0,0];function c(e){var c=t.value;a=[e.clientX,e.clientY],n+=a[0]-s[0]-(a[1]-s[1]);var l=o+n/(e.shiftKey?5:50)*t.step;c!==(l=0|Math.min(t.max,Math.max(t.min,l)))&&(t.setValue(l),i.dispatchEvent(r)),s=[e.clientX,e.clientY]}function l(e){document.removeEventListener("mousemove",c,!1),document.removeEventListener("mouseup",l,!1),Math.abs(n)<2&&(i.focus(),i.select())}function h(e){i.style.backgroundColor="transparent",i.style.cursor="col-resize"}return h(),i.addEventListener("mousedown",function(e){e.preventDefault(),n=0,o=t.value,s=[e.clientX,e.clientY],document.addEventListener("mousemove",c,!1),document.addEventListener("mouseup",l,!1)},!1),i.addEventListener("change",function(e){t.setValue(i.value)},!1),i.addEventListener("focus",function(e){i.style.backgroundColor="",i.style.cursor=""},!1),i.addEventListener("blur",h,!1),this},UI.Integer.prototype=Object.create(UI.Element.prototype),UI.Integer.prototype.constructor=UI.Integer,UI.Integer.prototype.getValue=function(){return this.value},UI.Integer.prototype.setValue=function(e){return void 0!==e&&(e=parseInt(e),this.value=e,this.dom.value=e),this},UI.Integer.prototype.setStep=function(e){return this.step=parseInt(e),this},UI.Integer.prototype.setRange=function(e,t){return this.min=e,this.max=t,this},UI.Break=function(){UI.Element.call(this);var e=document.createElement("br");return e.className="Break",this.dom=e,this},UI.Break.prototype=Object.create(UI.Element.prototype),UI.Break.prototype.constructor=UI.Break,UI.HorizontalRule=function(){UI.Element.call(this);var e=document.createElement("hr");return e.className="HorizontalRule",this.dom=e,this},UI.HorizontalRule.prototype=Object.create(UI.Element.prototype),UI.HorizontalRule.prototype.constructor=UI.HorizontalRule,UI.Button=function(e){UI.Element.call(this);var t=document.createElement("button");return t.className="Button",this.dom=t,this.dom.textContent=e,this},UI.Button.prototype=Object.create(UI.Element.prototype),UI.Button.prototype.constructor=UI.Button,UI.Button.prototype.setLabel=function(e){return this.dom.textContent=e,this},UI.Image=function(e){UI.Element.call(this);var t=document.createElement("img");return t.className="Img",this.dom=t,this.dom.src=e,this.dom.style="cursor:hand",this},UI.Image.prototype=Object.create(UI.Element.prototype),UI.Image.prototype.constructor=UI.Image,UI.Modal=function(e){var t=this,i=document.createElement("div");return i.style.position="absolute",i.style.width="100%",i.style.height="100%",i.style.backgroundColor="rgba(0,0,0,0.5)",i.style.display="none",i.style.alignItems="center",i.style.justifyContent="center",i.addEventListener("click",function(e){t.hide()}),this.dom=i,this.container=new UI.Panel,this.container.dom.style.width="200px",this.container.dom.style.padding="20px",this.container.dom.style.backgroundColor="#ffffff",this.container.dom.style.boxShadow="0px 5px 10px rgba(0,0,0,0.5)",this.add(this.container),this},UI.Modal.prototype=Object.create(UI.Element.prototype),UI.Modal.prototype.constructor=UI.Modal,UI.Modal.prototype.show=function(e){return this.container.clear(),this.container.add(e),this.dom.style.display="flex",this},UI.Modal.prototype.hide=function(){return this.dom.style.display="none",this},UI.Texture=function(e){UI.Element.call(this);var t=this,i=document.createElement("span"),r=document.createElement("form"),n=document.createElement("input");n.type="file",n.addEventListener("change",function(e){s(e.target.files[0])}),r.appendChild(n);var o=document.createElement("canvas");o.width=32,o.height=16,o.style.cursor="pointer",o.style.marginRight="5px",o.style.border="1px solid #888",o.addEventListener("click",function(e){n.click()},!1),o.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),s(e.dataTransfer.files[0])},!1),i.appendChild(o);var a=document.createElement("input");function s(i){if(i.type.match("image.*")){var n=new FileReader;"image/targa"===i.type?(n.addEventListener("load",function(r){var n=(new THREE.TGALoader).parse(r.target.result),o=new THREE.CanvasTexture(n,e);o.sourceFile=i.name,t.setValue(o),t.onChangeCallback&&t.onChangeCallback()},!1),n.readAsArrayBuffer(i)):(n.addEventListener("load",function(r){var n=document.createElement("img");n.addEventListener("load",function(r){var n=new THREE.Texture(this,e);n.sourceFile=i.name,n.needsUpdate=!0,t.setValue(n),t.onChangeCallback&&t.onChangeCallback()},!1),n.src=r.target.result},!1),n.readAsDataURL(i))}r.reset()}return a.disabled=!0,a.style.width="64px",a.style.border="1px solid #ccc",i.appendChild(a),this.dom=i,this.texture=null,this.onChangeCallback=null,this},UI.Texture.prototype=Object.create(UI.Element.prototype),UI.Texture.prototype.constructor=UI.Texture,UI.Texture.prototype.getValue=function(){return this.texture},UI.Texture.prototype.setValue=function(e){var t=this.dom.children[0],i=this.dom.children[1],r=t.getContext("2d");if(null!==e){var n=e.image;if(void 0!==n&&n.width>0){i.value=e.sourceFile;var o=t.width/n.width;r.drawImage(n,0,0,n.width*o,n.height*o)}else i.value=e.sourceFile+" (error)",r.clearRect(0,0,t.width,t.height)}else i.value="",null!==r&&r.clearRect(0,0,t.width,t.height);this.texture=e},UI.Texture.prototype.onChange=function(e){return this.onChangeCallback=e,this},UI.Outliner=function(e){UI.Element.call(this);var t=this,i=document.createElement("div");return i.className="Outliner",i.tabIndex=0,this.scene=e.scene,i.addEventListener("keydown",function(e){switch(e.keyCode){case 38:case 40:e.preventDefault(),e.stopPropagation()}},!1),i.addEventListener("keyup",function(e){switch(e.keyCode){case 38:t.selectIndex(t.selectedIndex-1);break;case 40:t.selectIndex(t.selectedIndex+1)}},!1),this.dom=i,this.options=[],this.selectedIndex=-1,this.selectedValue=null,this},UI.Outliner.prototype=Object.create(UI.Element.prototype),UI.Outliner.prototype.constructor=UI.Outliner,UI.Outliner.prototype.selectIndex=function(e){if(e>=0&&e<this.options.length){this.setValue(this.options[e].value);var t=document.createEvent("HTMLEvents");t.initEvent("change",!0,!0),this.dom.dispatchEvent(t)}},UI.Outliner.prototype.setOptions=function(e){for(var t,i=this;i.dom.children.length>0;)i.dom.removeChild(i.dom.firstChild);function r(){i.setValue(this.value);var e=document.createEvent("HTMLEvents");e.initEvent("change",!0,!0),i.dom.dispatchEvent(e)}function n(e){t=this}function o(e){e.dataTransfer.setData("text","foo")}function a(e){if(this!==t){var i=e.offsetY/this.clientHeight;this.className=i<.25?"option dragTop":i>.75?"option dragBottom":"option drag"}}function s(){this!==t&&(this.className="option")}function c(e){if(this!==t){this.className="option";var r=i.scene,n=r.getObjectById(t.value),o=e.offsetY/this.clientHeight;if(o<.25)l(n,(a=r.getObjectById(this.value)).parent,a);else if(o>.75){var a;l(n,(a=r.getObjectById(this.nextSibling.value)).parent,a)}else{l(n,r.getObjectById(this.value))}}}function l(e,t,r){null===r&&(r=void 0);var n=!1;if(e.traverse(function(e){e===t&&(n=!0)}),!n){editor.execute(new MoveObjectCommand(e,t,r));var o=document.createEvent("HTMLEvents");o.initEvent("change",!0,!0),i.dom.dispatchEvent(o)}}i.options=[];for(var h=0;h<e.length;h++){var u=e[h];u.className="option",i.dom.appendChild(u),i.options.push(u),u.addEventListener("click",r,!1),!0===u.draggable&&(u.addEventListener("drag",n,!1),u.addEventListener("dragstart",o,!1),u.addEventListener("dragover",a,!1),u.addEventListener("dragleave",s,!1),u.addEventListener("drop",c,!1))}return i},UI.Outliner.prototype.getValue=function(){return this.selectedValue},UI.Outliner.prototype.setValue=function(e){for(var t=0;t<this.options.length;t++){var i=this.options[t];if(i.value===e){i.classList.add("active");var r=i.offsetTop-this.dom.offsetTop,n=r+i.offsetHeight-this.dom.offsetHeight;this.dom.scrollTop>r?this.dom.scrollTop=r:this.dom.scrollTop<n&&(this.dom.scrollTop=n),this.selectedIndex=t}else i.classList.remove("active")}return this.selectedValue=e,this},UI.THREE={},UI.THREE.Boolean=function(e,t){UI.Span.call(this),this.setMarginRight("10px"),this.checkbox=new UI.Checkbox(e),this.text=new UI.Text(t).setMarginLeft("3px"),this.add(this.checkbox),this.add(this.text)},UI.THREE.Boolean.prototype=Object.create(UI.Span.prototype),UI.THREE.Boolean.prototype.constructor=UI.THREE.Boolean,UI.THREE.Boolean.prototype.getValue=function(){return this.checkbox.getValue()},UI.THREE.Boolean.prototype.setValue=function(e){return this.checkbox.setValue(e)};var Storage=function(){var e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;if(void 0===e)return console.warn("Storage: IndexedDB not available."),{init:function(){},get:function(){},set:function(){},clear:function(){}};var t;return{init:function(i){var r=e.open("threejs-editor",1);r.onupgradeneeded=function(e){var t=e.target.result;!1===t.objectStoreNames.contains("states")&&t.createObjectStore("states")},r.onsuccess=function(e){t=e.target.result,i()},r.onerror=function(e){console.error("IndexedDB",e)}},get:function(e){t.transaction(["states"],"readwrite").objectStore("states").get(0).onsuccess=function(t){e(t.target.result)}},set:function(e,i){var r=performance.now();t.transaction(["states"],"readwrite").objectStore("states").put(e,0).onsuccess=function(e){console.log("["+/\d\d\:\d\d\:\d\d/.exec(new Date)[0]+"]","Saved state to IndexedDB. "+(performance.now()-r).toFixed(2)+"ms")}},clear:function(){void 0!==t&&(t.transaction(["states"],"readwrite").objectStore("states").clear().onsuccess=function(e){console.log("["+/\d\d\:\d\d\:\d\d/.exec(new Date)[0]+"]","Cleared IndexedDB.")})}}},Command=function(e){this.id=-1,this.inMemory=!1,this.updatable=!1,this.type="",this.name="",void 0!==e&&(Command.editor=e),this.editor=Command.editor};Command.prototype.toJSON=function(){var e={};return e.type=this.type,e.id=this.id,e.name=this.name,e},Command.prototype.fromJSON=function(e){this.inMemory=!0,this.type=e.type,this.id=e.id,this.name=e.name},History=function(e){this.editor=e,this.undos=[],this.redos=[],this.lastCmdTime=new Date,this.idCounter=0,this.historyDisabled=!1,this.config=e.config,Command(e);var t=this;this.editor.signals.startPlayer.add(function(){t.historyDisabled=!0}),this.editor.signals.stopPlayer.add(function(){t.historyDisabled=!1})},History.prototype={execute:function(e,t){var i=this.undos[this.undos.length-1],r=(new Date).getTime()-this.lastCmdTime.getTime(),n=i&&i.updatable&&e.updatable&&i.object===e.object&&i.type===e.type&&i.script===e.script&&i.attributeName===e.attributeName;n&&"SetScriptValueCommand"===e.type?(i.update(e),e=i):n&&r<500?(i.update(e),e=i):(this.undos.push(e),e.id=++this.idCounter),e.name=void 0!==t?t:e.name,e.execute(),e.inMemory=!0,this.config.getKey("settings/history")&&(e.json=e.toJSON()),this.lastCmdTime=new Date,this.redos=[],this.editor.signals.historyChanged.dispatch(e)},undo:function(){if(!this.historyDisabled){var e=void 0;return this.undos.length>0&&!1===(e=this.undos.pop()).inMemory&&e.fromJSON(e.json),void 0!==e&&(e.undo(),this.redos.push(e),this.editor.signals.historyChanged.dispatch(e)),e}alert("Undo/Redo disabled while scene is playing.")},redo:function(){if(!this.historyDisabled){var e=void 0;return this.redos.length>0&&!1===(e=this.redos.pop()).inMemory&&e.fromJSON(e.json),void 0!==e&&(e.execute(),this.undos.push(e),this.editor.signals.historyChanged.dispatch(e)),e}alert("Undo/Redo disabled while scene is playing.")},toJSON:function(){var e={undos:[],redos:[]};if(!this.config.getKey("settings/history"))return e;for(var t=0;t<this.undos.length;t++)this.undos[t].hasOwnProperty("json")&&e.undos.push(this.undos[t].json);for(t=0;t<this.redos.length;t++)this.redos[t].hasOwnProperty("json")&&e.redos.push(this.redos[t].json);return e},fromJSON:function(e){if(void 0!==e){for(var t=0;t<e.undos.length;t++){var i=e.undos[t];(r=new window[i.type]).json=i,r.id=i.id,r.name=i.name,this.undos.push(r),this.idCounter=i.id>this.idCounter?i.id:this.idCounter}for(t=0;t<e.redos.length;t++){var r;i=e.redos[t];(r=new window[i.type]).json=i,r.id=i.id,r.name=i.name,this.redos.push(r),this.idCounter=i.id>this.idCounter?i.id:this.idCounter}this.editor.signals.historyChanged.dispatch(this.undos[this.undos.length-1])}},clear:function(){this.undos=[],this.redos=[],this.idCounter=0,this.editor.signals.historyChanged.dispatch()},goToState:function(e){if(this.historyDisabled)alert("Undo/Redo disabled while scene is playing.");else{this.editor.signals.sceneGraphChanged.active=!1,this.editor.signals.historyChanged.active=!1;var t=this.undos.length>0?this.undos[this.undos.length-1]:void 0;if(void 0===t||e>t.id)for(t=this.redo();void 0!==t&&e>t.id;)t=this.redo();else for(;void 0!==(t=this.undos[this.undos.length-1])&&e!==t.id;)this.undo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.historyChanged.active=!0,this.editor.signals.sceneGraphChanged.dispatch(),this.editor.signals.historyChanged.dispatch(t)}},enableSerialization:function(e){this.goToState(-1),this.editor.signals.sceneGraphChanged.active=!1,this.editor.signals.historyChanged.active=!1;for(var t=this.redo();void 0!==t;)t.hasOwnProperty("json")||(t.json=t.toJSON()),t=this.redo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.historyChanged.active=!0,this.goToState(e)}};var Editor=function(){this.DEFAULT_CAMERA=new THREE.PerspectiveCamera(50,1,1,3e5),this.DEFAULT_CAMERA.name="Camera",this.DEFAULT_CAMERA.position.set(20,10,20),this.DEFAULT_CAMERA.lookAt(new THREE.Vector3);var e=signals.Signal;this.signals={editScript:new e,startPlayer:new e,stopPlayer:new e,playAnimation:new e,stopAnimation:new e,showModal:new e,editorCleared:new e,savingStarted:new e,savingFinished:new e,themeChanged:new e,transformModeChanged:new e,snapChanged:new e,spaceChanged:new e,rendererChanged:new e,sceneBackgroundChanged:new e,sceneFogChanged:new e,sceneGraphChanged:new e,cameraChanged:new e,geometryChanged:new e,objectSelected:new e,objectFocused:new e,objectAdded:new e,objectChanged:new e,objectRemoved:new e,helperAdded:new e,helperRemoved:new e,materialChanged:new e,scriptAdded:new e,scriptChanged:new e,scriptRemoved:new e,windowResize:new e,showGridChanged:new e,refreshSidebarObject3D:new e,historyChanged:new e},this.config=new Config("threejs-editor"),this.history=new History(this),this.storage=new Storage,this.loader=new Loader(this),this.camera=this.DEFAULT_CAMERA.clone(),this.scene=new THREE.Scene,this.scene.name="Scene",this.scene.background=new THREE.Color(11184810),this.sceneHelpers=new THREE.Scene,this.object={},this.geometries={},this.materials={},this.textures={},this.scripts={},this.selected=null,this.helpers={}};Editor.prototype={setTheme:function(e){document.getElementById("theme").href=e,this.signals.themeChanged.dispatch(e)},setScene:function(e){for(this.scene.uuid=e.uuid,this.scene.name=e.name,null!==e.background&&(this.scene.background=e.background.clone()),null!==e.fog&&(this.scene.fog=e.fog.clone()),this.scene.userData=JSON.parse(JSON.stringify(e.userData)),this.signals.sceneGraphChanged.active=!1;e.children.length>0;)this.addObject(e.children[0]);this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},addObject:function(e){var t=this;e.traverse(function(e){void 0!==e.geometry&&t.addGeometry(e.geometry),void 0!==e.material&&t.addMaterial(e.material),t.addHelper(e)}),this.scene.add(e),this.signals.objectAdded.dispatch(e),this.signals.sceneGraphChanged.dispatch()},moveObject:function(e,t,i){if(void 0===t&&(t=this.scene),t.add(e),void 0!==i){var r=t.children.indexOf(i);t.children.splice(r,0,e),t.children.pop()}this.signals.sceneGraphChanged.dispatch()},nameObject:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},removeObject:function(e){if(null!==e.parent){var t=this;e.traverse(function(e){t.removeHelper(e)}),e.parent.remove(e),this.signals.objectRemoved.dispatch(e),this.signals.sceneGraphChanged.dispatch()}},addGeometry:function(e){this.geometries[e.uuid]=e},setGeometryName:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},addMaterial:function(e){this.materials[e.uuid]=e},setMaterialName:function(e,t){e.name=t,this.signals.sceneGraphChanged.dispatch()},addTexture:function(e){this.textures[e.uuid]=e},addHelper:function(){var e=new THREE.SphereBufferGeometry(2,4,2),t=new THREE.MeshBasicMaterial({color:16711680,visible:!1});return function(i){var r;if(i instanceof THREE.Camera)r=new THREE.CameraHelper(i,1);else if(i instanceof THREE.PointLight)r=new THREE.PointLightHelper(i,1);else if(i instanceof THREE.DirectionalLight)r=new THREE.DirectionalLightHelper(i,1);else if(i instanceof THREE.SpotLight)r=new THREE.SpotLightHelper(i,1);else if(i instanceof THREE.HemisphereLight)r=new THREE.HemisphereLightHelper(i,1);else{if(!(i instanceof THREE.SkinnedMesh))return;r=new THREE.SkeletonHelper(i)}var n=new THREE.Mesh(e,t);n.name="picker",n.userData.object=i,r.add(n),this.sceneHelpers.add(r),this.helpers[i.id]=r,this.signals.helperAdded.dispatch(r)}}(),removeHelper:function(e){if(void 0!==this.helpers[e.id]){var t=this.helpers[e.id];t.parent.remove(t),delete this.helpers[e.id],this.signals.helperRemoved.dispatch(t)}},addScript:function(e,t){void 0===this.scripts[e.uuid]&&(this.scripts[e.uuid]=[]),this.scripts[e.uuid].push(t),this.signals.scriptAdded.dispatch(t)},removeScript:function(e,t){if(void 0!==this.scripts[e.uuid]){var i=this.scripts[e.uuid].indexOf(t);-1!==i&&this.scripts[e.uuid].splice(i,1),this.signals.scriptRemoved.dispatch(t)}},getObjectMaterial:function(e,t){var i=e.material;return Array.isArray(i)&&(i=i[t]),i},setObjectMaterial:function(e,t,i){Array.isArray(e.material)?e.material[t]=i:e.material=i},select:function(e){if(this.selected!==e){var t=null;null!==e&&(t=e.uuid),this.selected=e,this.config.setKey("selected",t),this.signals.objectSelected.dispatch(e)}},selectById:function(e){e!==this.camera.id?this.select(this.scene.getObjectById(e,!0)):this.select(this.camera)},selectByUuid:function(e){var t=this;this.scene.traverse(function(i){i.uuid===e&&t.select(i)})},deselect:function(){this.select(null)},focus:function(e){this.signals.objectFocused.dispatch(e)},focusById:function(e){this.focus(this.scene.getObjectById(e,!0))},clear:function(){this.history.clear(),this.storage.clear(),this.camera.copy(this.DEFAULT_CAMERA),this.scene.background.setHex(11184810),this.scene.fog=null;for(var e=this.scene.children;e.length>0;)this.removeObject(e[0]);this.geometries={},this.materials={},this.textures={},this.scripts={},this.deselect(),this.signals.editorCleared.dispatch()},fromJSON:function(e){var t=new THREE.ObjectLoader;if(void 0!==e.scene){var i=t.parse(e.camera);this.camera.copy(i),this.camera.aspect=this.DEFAULT_CAMERA.aspect,this.camera.updateProjectionMatrix(),this.history.fromJSON(e.history),this.scripts=e.scripts,this.setScene(t.parse(e.scene))}else this.setScene(t.parse(e))},toJSON:function(){var e=this.scene,t=this.scripts;for(var i in t){0!==t[i].length&&void 0!==e.getObjectByProperty("uuid",i)||delete t[i]}return{metadata:{},project:{gammaInput:this.config.getKey("project/renderer/gammaInput"),gammaOutput:this.config.getKey("project/renderer/gammaOutput"),shadows:this.config.getKey("project/renderer/shadows"),vr:this.config.getKey("project/vr")},camera:this.camera.toJSON(),scene:this.scene.toJSON(),scripts:this.scripts,history:this.history.toJSON()}},objectByUuid:function(e){return this.scene.getObjectByProperty("uuid",e,!0)},execute:function(e,t){this.history.execute(e,t)},undo:function(){this.history.undo()},redo:function(){this.history.redo()}};var Config=function(e){var t={autosave:!0,theme:"css/light.css","project/renderer":"WebGLRenderer","project/renderer/antialias":!0,"project/renderer/gammaInput":!1,"project/renderer/gammaOutput":!1,"project/renderer/shadows":!0,"project/vr":!1,"settings/history":!1};if(void 0===window.localStorage[e])window.localStorage[e]=JSON.stringify(t);else{var i=JSON.parse(window.localStorage[e]);for(var r in i)t[r]=i[r]}return{getKey:function(e){return t[e]},setKey:function(){for(var i=0,r=arguments.length;i<r;i+=2)t[arguments[i]]=arguments[i+1];window.localStorage[e]=JSON.stringify(t),console.log("["+/\d\d\:\d\d\:\d\d/.exec(new Date)[0]+"]","Saved config to LocalStorage.")},clear:function(){delete window.localStorage[e]}}},Loader=function(e){var t=this;e.signals;function i(i,r,n){switch(void 0===i.metadata&&(i.metadata={type:"Geometry"}),void 0===i.metadata.type&&(i.metadata.type="Geometry"),void 0!==i.metadata.formatVersion&&(i.metadata.version=i.metadata.formatVersion),i.metadata.type.toLowerCase()){case"buffergeometry":var o=(l=new THREE.BufferGeometryLoader).parse(i),a=new THREE.Mesh(o);e.execute(new AddObjectCommand(a));break;case"geometry":(l=new THREE.JSONLoader).setTexturePath(t.texturePath);var s,c=(o=l.parse(i)).geometry;s=void 0!==o.materials?o.materials.length>1?new THREE.MultiMaterial(o.materials):o.materials[0]:new THREE.MeshStandardMaterial,c.sourceType="ascii",c.sourceFile=r.name,(a=c.animation&&c.animation.hierarchy?new THREE.SkinnedMesh(c,s):new THREE.Mesh(c,s)).name=n,e.execute(new AddObjectCommand(a));break;case"object":var l;(l=new THREE.ObjectLoader).setTexturePath(t.texturePath),(o=l.parse(i))instanceof THREE.Scene?e.execute(new SetSceneCommand(o)):e.execute(new AddObjectCommand(o));break;case"app":e.fromJSON(i)}}this.texturePath="",this.loadFile=function(t){var r=t.name,n=r.split(".").pop().toLowerCase(),o=new FileReader;switch(o.addEventListener("progress",function(e){var t="("+Math.floor(e.total/1e3).format()+" KB)",i=Math.floor(e.loaded/e.total*100)+"%";console.log("Loading",r,t,i)}),n){case"3ds":o.addEventListener("load",function(t){var i=(new THREE.TDSLoader).parse(t.target.result);e.execute(new AddObjectCommand(i))},!1),o.readAsArrayBuffer(t);break;case"amf":o.addEventListener("load",function(t){var i=(new THREE.AMFLoader).parse(t.target.result);e.execute(new AddObjectCommand(i))},!1),o.readAsArrayBuffer(t);break;case"awd":o.addEventListener("load",function(t){var i=(new THREE.AWDLoader).parse(t.target.result);e.execute(new SetSceneCommand(i))},!1),o.readAsArrayBuffer(t);break;case"babylon":o.addEventListener("load",function(t){var i=t.target.result,r=JSON.parse(i),n=(new THREE.BabylonLoader).parse(r);e.execute(new SetSceneCommand(n))},!1),o.readAsText(t);break;case"babylonmeshdata":o.addEventListener("load",function(t){var i=t.target.result,n=JSON.parse(i),o=(new THREE.BabylonLoader).parseGeometry(n),a=new THREE.MeshStandardMaterial,s=new THREE.Mesh(o,a);s.name=r,e.execute(new AddObjectCommand(s))},!1),o.readAsText(t);break;case"ctm":o.addEventListener("load",function(i){var n=new Uint8Array(i.target.result),o=new CTM.Stream(n);o.offset=0,(new THREE.CTMLoader).createModel(new CTM.File(o),function(i){i.sourceType="ctm",i.sourceFile=t.name;var n=new THREE.MeshStandardMaterial,o=new THREE.Mesh(i,n);o.name=r,e.execute(new AddObjectCommand(o))})},!1),o.readAsArrayBuffer(t);break;case"dae":o.addEventListener("load",function(t){var i=t.target.result,n=(new THREE.ColladaLoader).parse(i);n.scene.name=r,e.execute(new AddObjectCommand(n.scene))},!1),o.readAsText(t);break;case"fbx":o.addEventListener("load",function(t){var i=t.target.result,r=(new THREE.FBXLoader).parse(i);e.execute(new AddObjectCommand(r))},!1),o.readAsArrayBuffer(t);break;case"glb":case"gltf":o.addEventListener("load",function(t){var i=t.target.result;(new THREE.GLTFLoader).parse(i,"",function(t){t.scene.name=r,e.execute(new AddObjectCommand(t.scene))})},!1),o.readAsArrayBuffer(t);break;case"js":case"json":case"3geo":case"3mat":case"3obj":case"3scn":o.addEventListener("load",function(e){var n,o=e.target.result;if(-1!==o.indexOf("postMessage")){var a=new Blob([o],{type:"text/javascript"}),s=URL.createObjectURL(a),c=new Worker(s);return c.onmessage=function(e){e.data.metadata={version:2},i(e.data,t,r)},void c.postMessage(Date.now())}try{n=JSON.parse(o)}catch(e){return void alert(e)}i(n,t,r)},!1),o.readAsText(t);break;case"kmz":o.addEventListener("load",function(t){var i=(new THREE.KMZLoader).parse(t.target.result);i.scene.name=r,e.execute(new AddObjectCommand(i.scene))},!1),o.readAsArrayBuffer(t);break;case"md2":o.addEventListener("load",function(t){var i=t.target.result,n=(new THREE.MD2Loader).parse(i),o=new THREE.MeshStandardMaterial({morphTargets:!0,morphNormals:!0}),a=new THREE.Mesh(n,o);a.mixer=new THREE.AnimationMixer(a),a.name=r,e.execute(new AddObjectCommand(a))},!1),o.readAsArrayBuffer(t);break;case"obj":o.addEventListener("load",function(t){var i=t.target.result,n=(new THREE.OBJLoader).parse(i);n.name=r,e.execute(new AddObjectCommand(n))},!1),o.readAsText(t);break;case"playcanvas":o.addEventListener("load",function(t){var i=t.target.result,r=JSON.parse(i),n=(new THREE.PlayCanvasLoader).parse(r);e.execute(new AddObjectCommand(n))},!1),o.readAsText(t);break;case"ply":o.addEventListener("load",function(i){var n=i.target.result,o=(new THREE.PLYLoader).parse(n);o.sourceType="ply",o.sourceFile=t.name;var a=new THREE.MeshStandardMaterial,s=new THREE.Mesh(o,a);s.name=r,e.execute(new AddObjectCommand(s))},!1),o.readAsArrayBuffer(t);break;case"stl":o.addEventListener("load",function(i){var n=i.target.result,o=(new THREE.STLLoader).parse(n);o.sourceType="stl",o.sourceFile=t.name;var a=new THREE.MeshStandardMaterial,s=new THREE.Mesh(o,a);s.name=r,e.execute(new AddObjectCommand(s))},!1),void 0!==o.readAsBinaryString?o.readAsBinaryString(t):o.readAsArrayBuffer(t);break;case"vtk":o.addEventListener("load",function(i){var n=i.target.result,o=(new THREE.VTKLoader).parse(n);o.sourceType="vtk",o.sourceFile=t.name;var a=new THREE.MeshStandardMaterial,s=new THREE.Mesh(o,a);s.name=r,e.execute(new AddObjectCommand(s))},!1),o.readAsText(t);break;case"wrl":o.addEventListener("load",function(t){var i=t.target.result,r=(new THREE.VRMLLoader).parse(i);e.execute(new SetSceneCommand(r))},!1),o.readAsText(t);break;case"zip":o.addEventListener("load",function(t){var i=t.target.result,r=new JSZip(i);if(r.files["model.obj"]&&r.files["materials.mtl"]){var n=(new THREE.MTLLoader).parse(r.file("materials.mtl").asText()),o=(new THREE.OBJLoader).setMaterials(n).parse(r.file("model.obj").asText());e.execute(new AddObjectCommand(o))}},!1),o.readAsBinaryString(t);break;default:alert("Unsupported file format ("+n+").")}}},Viewport=function(e){var t=e.signals,i=new UI.Panel;i.setId("viewport"),i.setPosition("absolute"),i.add(new Viewport.Info(e));var r=null,n=e.camera,o=e.scene,a=e.sceneHelpers,s=[],c=new THREE.GridHelper(60,60);a.add(c);var l=new THREE.Box3,h=new THREE.BoxHelper;h.material.depthTest=!1,h.material.transparent=!0,h.visible=!1,a.add(h);var u=null,d=null,p=null,f=new THREE.TransformControls(n,i.dom);f.addEventListener("change",function(){var i=f.object;void 0!==i&&(h.setFromObject(i),void 0!==e.helpers[i.id]&&e.helpers[i.id].update(),t.refreshSidebarObject3D.dispatch(i)),A()}),f.addEventListener("mouseDown",function(){var e=f.object;u=e.position.clone(),d=e.rotation.clone(),p=e.scale.clone(),S.enabled=!1}),f.addEventListener("mouseUp",function(){var t=f.object;if(void 0!==t)switch(f.getMode()){case"translate":u.equals(t.position)||e.execute(new SetPositionCommand(t,t.position,u));break;case"rotate":d.equals(t.rotation)||e.execute(new SetRotationCommand(t,t.rotation,d));break;case"scale":p.equals(t.scale)||e.execute(new SetScaleCommand(t,t.scale,p))}S.enabled=!0}),a.add(f);var m=new THREE.Raycaster,g=new THREE.Vector2;function v(e,t){return g.set(2*e.x-1,-2*e.y+1),m.setFromCamera(g,n),m.intersectObjects(t)}var y=new THREE.Vector2,E=new THREE.Vector2,x=new THREE.Vector2;function b(e,t,i){var r=e.getBoundingClientRect();return[(t-r.left)/r.width,(i-r.top)/r.height]}function w(){if(0===y.distanceTo(E)){var t=v(E,s);if(t.length>0){var i=t[0].object;void 0!==i.userData.object?e.select(i.userData.object):e.select(i)}else e.select(null);A()}}function T(e){var t=b(i.dom,e.clientX,e.clientY);E.fromArray(t),w(),document.removeEventListener("mouseup",T,!1)}function M(e){var t=e.changedTouches[0],r=b(i.dom,t.clientX,t.clientY);E.fromArray(r),w(),document.removeEventListener("touchend",M,!1)}i.dom.addEventListener("mousedown",function(e){e.preventDefault();var t=b(i.dom,e.clientX,e.clientY);y.fromArray(t),document.addEventListener("mouseup",T,!1)},!1),i.dom.addEventListener("touchstart",function(e){var t=e.changedTouches[0],r=b(i.dom,t.clientX,t.clientY);y.fromArray(r),document.addEventListener("touchend",M,!1)},!1),i.dom.addEventListener("dblclick",function(e){var r=b(i.dom,e.clientX,e.clientY);x.fromArray(r);var n=v(x,s);if(n.length>0){var o=n[0];t.objectFocused.dispatch(o.object)}},!1);var S=new THREE.EditorControls(n,i.dom);S.addEventListener("change",function(){f.update(),t.cameraChanged.dispatch(n)}),t.editorCleared.add(function(){S.center.set(0,0,0),A()}),t.themeChanged.add(function(e){switch(e){case"css/light.css":a.remove(c),c=new THREE.GridHelper(60,60,4473924,8947848),a.add(c);break;case"css/dark.css":a.remove(c),c=new THREE.GridHelper(60,60,12303291,8947848),a.add(c)}A()}),t.transformModeChanged.add(function(e){f.setMode(e)}),t.snapChanged.add(function(e){f.setTranslationSnap(e)}),t.spaceChanged.add(function(e){f.setSpace(e)}),t.rendererChanged.add(function(e){null!==r&&i.dom.removeChild(r.domElement),(r=e).autoClear=!1,r.autoUpdateScene=!1,r.setPixelRatio(window.devicePixelRatio),r.setSize(i.dom.offsetWidth,i.dom.offsetHeight),i.dom.appendChild(r.domElement),A()}),t.sceneGraphChanged.add(function(){A()}),t.cameraChanged.add(function(){A()}),t.objectSelected.add(function(e){h.visible=!1,f.detach(),null!==e&&e!==o&&e!==n&&(l.setFromObject(e),!1===l.isEmpty()&&(h.setFromObject(e),h.visible=!0),f.attach(e)),A()}),t.objectFocused.add(function(e){S.focus(e)}),t.geometryChanged.add(function(e){void 0!==e&&h.setFromObject(e),A()}),t.objectAdded.add(function(e){e.traverse(function(e){s.push(e)})}),t.objectChanged.add(function(t){e.selected===t&&(h.setFromObject(t),f.update()),t instanceof THREE.PerspectiveCamera&&t.updateProjectionMatrix(),void 0!==e.helpers[t.id]&&e.helpers[t.id].update(),A()}),t.objectRemoved.add(function(e){e.traverse(function(e){s.splice(s.indexOf(e),1)})}),t.helperAdded.add(function(e){s.push(e.getObjectByName("picker"))}),t.helperRemoved.add(function(e){s.splice(s.indexOf(e.getObjectByName("picker")),1)}),t.materialChanged.add(function(e){A()}),t.sceneBackgroundChanged.add(function(e){o.background.setHex(e),A()});var R=null;function A(){a.updateMatrixWorld(),o.updateMatrixWorld(),r.render(o,n),r instanceof THREE.RaytracingRenderer==!1&&r.render(a,n)}return t.sceneFogChanged.add(function(e,t,i,r,n){if(R!==e){switch(e){case"None":o.fog=null;break;case"Fog":o.fog=new THREE.Fog;break;case"FogExp2":o.fog=new THREE.FogExp2}R=e}o.fog instanceof THREE.Fog?(o.fog.color.setHex(t),o.fog.near=i,o.fog.far=r):o.fog instanceof THREE.FogExp2&&(o.fog.color.setHex(t),o.fog.density=n),A()}),t.windowResize.add(function(){e.DEFAULT_CAMERA.aspect=i.dom.offsetWidth/i.dom.offsetHeight,e.DEFAULT_CAMERA.updateProjectionMatrix(),n.aspect=i.dom.offsetWidth/i.dom.offsetHeight,n.updateProjectionMatrix(),r.setSize(i.dom.offsetWidth,i.dom.offsetHeight),A()}),t.showGridChanged.add(function(e){c.visible=e,A()}),i};Viewport.Info=function(e){var t=e.signals,i=new UI.Panel;i.setId("info"),i.setPosition("absolute"),i.setLeft("10px"),i.setBottom("10px"),i.setFontSize("12px"),i.setColor("#fff");var r=new UI.Text("0").setMarginLeft("6px"),n=new UI.Text("0").setMarginLeft("6px"),o=new UI.Text("0").setMarginLeft("6px");function a(){for(var t=e.scene,i=0,a=0,s=0,c=0,l=t.children.length;c<l;c++){t.children[c].traverseVisible(function(e){if(i++,e instanceof THREE.Mesh){var t=e.geometry;t instanceof THREE.Geometry?(a+=t.vertices.length,s+=t.faces.length):t instanceof THREE.BufferGeometry&&(null!==t.index?(a+=3*t.index.count,s+=t.index.count):(a+=t.attributes.position.count,s+=t.attributes.position.count/3))}})}r.setValue(i.format()),n.setValue(a.format()),o.setValue(s.format())}return i.add(new UI.Text("objects"),r,new UI.Break),i.add(new UI.Text("vertices"),n,new UI.Break),i.add(new UI.Text("triangles"),o,new UI.Break),t.objectAdded.add(a),t.objectRemoved.add(a),t.geometryChanged.add(a),i},THREE.SubdivisionModifier=function(e){this.subdivisions=void 0===e?1:e},THREE.SubdivisionModifier.prototype.modify=function(e){for(var t=this.subdivisions;t-- >0;)this.smooth(e);e.computeFaceNormals(),e.computeVertexNormals()},function(){var e=["a","b","c"];function t(e,t,i){return i[Math.min(e,t)+"_"+Math.max(e,t)]}function i(e,t,i,r,n,o){var a,s=Math.min(e,t),c=Math.max(e,t),l=s+"_"+c;l in r?a=r[l]:(a={a:i[s],b:i[c],newEdge:null,faces:[]},r[l]=a);a.faces.push(n),o[e].edges.push(a),o[t].edges.push(a)}function r(e,t,i,r){e.push(new THREE.Face3(t,i,r))}function n(e,t){return Math.abs(t-e)/2+Math.min(e,t)}function o(e,t,i,r){e.push([t.clone(),i.clone(),r.clone()])}THREE.SubdivisionModifier.prototype.smooth=function(a){var s,c,l,h,u,d,p,f,m,g,v,y,E,x,b=new THREE.Vector3,w=[];s=a.vertices,c=a.faces;var T,M,S,R,A,_,D,C,L,P,H,B,I,O,U=void 0!==(l=a.faceVertexUvs[0])&&l.length>0;for(p in function(e,t,r,n){var o,a,s;for(o=0,a=e.length;o<a;o++)r[o]={edges:[]};for(o=0,a=t.length;o<a;o++)i((s=t[o]).a,s.b,e,n,s,r),i(s.b,s.c,e,n,s,r),i(s.c,s.a,e,n,s,r)}(s,c,v=new Array(s.length),y={}),E=[],y){for(M=y[p],S=new THREE.Vector3,A=3/8,_=1/8,2!=(D=M.faces.length)&&(A=.5,_=0),S.addVectors(M.a,M.b).multiplyScalar(A),b.set(0,0,0),m=0;m<D;m++){for(R=M.faces[m],g=0;g<3&&((T=s[R[e[g]]])===M.a||T===M.b);g++);b.add(T)}b.multiplyScalar(_),S.add(b),M.newEdge=E.length,E.push(S)}for(x=[],p=0,f=s.length;p<f;p++){for(I=s[p],3==(d=(B=v[p].edges).length)?C=3/16:d>3&&(C=3/(8*d)),L=1-d*C,P=C,d<=2&&2==d&&(L=.75,P=1/8),O=I.clone().multiplyScalar(L),b.set(0,0,0),m=0;m<d;m++)T=(H=B[m]).a!==I?H.a:H.b,b.add(T);b.multiplyScalar(P),O.add(b),x.push(O)}h=x.concat(E);var N,V,F,z,j,k,G,W=x.length;u=[];var X=new THREE.Vector2,Y=new THREE.Vector2,q=new THREE.Vector2;for(p=0,f=c.length;p<f;p++)r(u,N=t((R=c[p]).a,R.b,y).newEdge+W,V=t(R.b,R.c,y).newEdge+W,F=t(R.c,R.a,y).newEdge+W),r(u,R.a,N,F),r(u,R.b,V,N),r(u,R.c,F,V),U&&(j=(z=l[p])[0],k=z[1],G=z[2],X.set(n(j.x,k.x),n(j.y,k.y)),Y.set(n(k.x,G.x),n(k.y,G.y)),q.set(n(j.x,G.x),n(j.y,G.y)),o(w,X,Y,q),o(w,j,X,q),o(w,k,Y,X),o(w,G,q,Y));a.vertices=h,a.faces=u,U&&(a.faceVertexUvs[0]=w)}}();var VB={REVISION:"4",Effect:function(){var e,t,i;this.skyboxCamera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,2e4),this.skyboxScene=new THREE.Scene,VB.Effect.prototype.initWater=function(i){(e=new THREE.PlaneGeometry(1e4,1e4,1,1)).applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),e.computeFaceNormals(),e.computeVertexNormals();var r=THREE.ImageUtils.loadTexture("imagepath");r.wrapS=r.wrapT=THREE.RepeatWrapping,r.repeat.set(100,100),t=new THREE.MeshBasicMaterial({color:17663,map:r}),mesh=new THREE.Mesh(e,t),mesh.position.y=-1,scene.add(mesh);var n=new THREE.Mesh(new THREE.CubeGeometry(5,5,5),new THREE.MeshLambertMaterial({color:16711680}));scene.add(n),n.position.set(0,1,-50)},VB.Effect.prototype.initSkybox=function(e,t){var r=[t+"px.jpg",t+"nx.jpg",t+"py.jpg",t+"ny.jpg",t+"pz.jpg",t+"nz.jpg"],n=THREE.ImageUtils.loadTextureCube(r),o=THREE.ShaderLib.cube;o.uniforms.tCube.value=n;var a=new THREE.ShaderMaterial({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:o.uniforms,depthWrite:!1,side:THREE.BackSide});i=new THREE.Mesh(new THREE.CubeGeometry(1e3,1e3,1e3,1,1,1),a),this.skyboxScene.add(i)}},Editor:function(){Editor.call(this),this.loader=new VB.Loader(this),this.poiManager,this.DeviceManager,this.topologyManager,this.LibraryManager,this.camera.near=10,this.signals.continuousRender=new signals.Signal,this.signals.continuousRenderSrc=new signals.Signal,this.signals.updateBoundingBox=new signals.Signal,this.signals.selectPosition=new signals.Signal,this.selectMode=VB.Editor.SelectMode.object,this.bbox}};VB.Editor.prototype=Object.create(Editor.prototype),VB.Editor.prototype.constructor=VB.Editor,VB.Editor.prototype.clear=function(){this.camera.position.set(500,250,500),this.camera.lookAt(new THREE.Vector3);var e=this.scene.children;for(this.signals.sceneGraphChanged.active=!1;e.length>0;)this.removeObject(e[0]);for(var t in this.poiManager&&this.poiManager.clear(),this.LibraryManager&&this.LibraryManager.clear(),this.DeviceManager&&this.DeviceManager.clear(),this.topologyManager&&this.topologyManager.clear(),this.geometries)this.geometries[t].dispose();for(var i in this.materials)this.materials[i].dispose();for(var r in this.textures)this.textures[r].dispose();this.geometries={},this.materials={},this.textures={},this.scripts={},this.deselect(),this.signals.sceneGraphChanged.active=!0,this.signals.editorCleared.dispatch(),this.signals.sceneGraphChanged.dispatch()},VB.Editor.prototype.setScene=function(e){for(this.scene.uuid=e.uuid,this.scene.name=e.name,this.scene.userData=e.userData,this.signals.sceneGraphChanged.active=!1;e.children.length>0;)this.addObject(e.children[0]);this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},VB.Editor.prototype.getBoundingBox=function(e,t){var i=new THREE.Box3;if(t)i.setFromObject(e);else{var r=function(e,t){if(e&&t(e))for(var i=0,n=e.children.length;i<n;i++)r(e.children[i],t)};r(e,function(e){return e.visible&&e instanceof THREE.Mesh&&i.union((new THREE.Box3).setFromObject(e)),e.visible})}return i},VB.Editor.prototype.autoFitTo=function(e,t,i){var r=(new Box3).setFromObject(e).getBoundingSphere(),n=t.fov*Math.PI/180*.618,o=r.radius/Math.tan(n/2),a=Math.sqrt(Math.pow(o,2)+Math.pow(o,2));t.position.set(a,a,a),i.update(),t.lookAt(r.center),t.updateProjectionMatrix(),this.setViewpoint(viewpoint)},VB.Editor.prototype.fitBoundingBoxToScreen=function(e,t,i,r,n,o){var a=new THREE.Quaternion;null!=n&&(a.copy(this.camera.quaternion),this.camera.rotation.set(n.x,n.y,n.z));var s=new THREE.Vector3(0,0,-1);s.applyQuaternion(this.camera.quaternion);var c=new THREE.Vector3(0,1,0);c.applyQuaternion(this.camera.quaternion);var l=torad(this.camera.fov),h=l*(e/t),u=new THREE.Vector3,d=[new THREE.Vector3(i.max.x,i.max.y,i.max.z),new THREE.Vector3(i.max.x,i.max.y,i.min.z),new THREE.Vector3(i.max.x,i.min.y,i.max.z),new THREE.Vector3(i.max.x,i.min.y,i.min.z),new THREE.Vector3(i.min.x,i.max.y,i.max.z),new THREE.Vector3(i.min.x,i.max.y,i.min.z),new THREE.Vector3(i.min.x,i.min.y,i.max.z),new THREE.Vector3(i.min.x,i.min.y,i.min.z)],p=i.getCenter(),f=getRotationTo(s,UNIT_X.clone());c.applyQuaternion(f);var m=getRotationTo(c,UNIT_Y.clone()).clone();m.multiply(f);for(var g,v=Math.tan(l/2),y=FLT_MIN,E=FLT_MAX,x=Math.tan(h/2.15),b=FLT_MIN,w=FLT_MAX,T=(new THREE.Vector3,0);T<d.length;++T){var M=d[T];M.sub(p),M.applyQuaternion(m),(g=M.y-v*M.x)>y&&(y=g),(g=M.y+v*M.x)<E&&(E=g),(g=M.z-x*M.x)>b&&(b=g),(g=M.z+x*M.x)<w&&(w=g)}if(!(v<.001||x<.001)){var S=(E-y)/(2*v),R=(E+y)/2,A=(w-b)/(2*x),_=(w+b)/2;S<A?(u.x=S/1,u.y=R,u.z=_,!0):(u.x=A/1,u.z=_,u.y=R,!1),m.inverse(),u.applyQuaternion(m),u.add(p);var D=i.getCenter(),C=s.clone();C.negate(),C.normalize();var L=new THREE.Plane(C,-D.length()),P=new THREE.Ray(u.clone(),s).intersectPlane(L);P||(D.y=0,P=D);var H=this;if(null!=n&&this.camera.setRotationFromQuaternion(a),void 0!==r&&r){this.signals.continuousRender.dispatch(!0);new TWEEN.Tween(H.camera.position).to({x:u.x,y:u.y,z:u.z},1500).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){H.signals.continuousRenderSrc.dispatch()}).start();if(n)new TWEEN.Tween(H.camera.rotation).to({x:n.x,y:n.y,z:n.z},1500).easing(TWEEN.Easing.Linear.None).onUpdate(function(){}).onComplete(function(){o&&o()}).start();console.log("tween start")}else this.camera.position.copy(u),null!=n&&this.setViewpoint(n)}},VB.Editor.prototype.setViewpoint=function(e){this.camera.rotation.x=e.x,this.camera.rotation.y=e.y,this.camera.rotation.z=e.z,this.camera.rotationAutoUpdate=!1},VB.Editor.prototype.createSky=function(){null==this.Effect&&(this.Effect=new VB.Effect,this.Effect.initSkybox(this.scene,"images/sunnysky/"))},VB.Editor.prototype.createDeviceManager=function(e,t,i){if(null==this.DeviceManager){this.DeviceManager=new VB.DeviceManager(e,t,i),this.signals.layerChanged=new signals.Signal,this.signals.layerAdded=new signals.Signal,this.signals.objectRemoved.add(this.DeviceManager.removeLayer.bind(this.DeviceManager)),this.signals.windowResize.add(this.DeviceManager.onResize.bind(this.DeviceManager));new THREE.Raycaster}},VB.Editor.prototype.createLibraryManager=function(e,t,i){null==this.LibraryManager&&(this.LibraryManager=new VB.LibraryManager(e,t,i))},VB.Editor.prototype.createPoiManager=function(e,t,i){if(null==this.poiManager){this.poiManager=new VB.PoiManager(e,t,i),this.signals.layerChanged=new signals.Signal,this.signals.layerAdded=new signals.Signal,this.signals.objectRemoved.add(this.poiManager.removeLayer.bind(this.poiManager)),this.signals.windowResize.add(this.poiManager.onResize.bind(this.poiManager));new THREE.Raycaster}},VB.Editor.prototype.addLayer=function(e){if(this.poiManager){var t=this.poiManager.createLayer(e);return this.signals.sceneGraphChanged.dispatch(),t}},VB.Editor.prototype.selectPoiById=function(e){this.select(this.poiManager.poiScene.getObjectById(e))},VB.Editor.prototype.addPoi=function(e){if(this.poiManager){var t=this.poiManager.addPoi(e);return this.signals.sceneGraphChanged.dispatch(),t}},VB.Editor.prototype.addDevice=function(e){if(this.DeviceManager){var t=this.DeviceManager.addDevice(e);return this.signals.sceneGraphChanged.dispatch(),t}},VB.Editor.prototype.createTopologyManager=function(e,t,i,r){null==this.topologyManager&&(this.topologyManager=new VB.TopologyManager(this,e,r),this.signals.windowResize.add(this.topologyManager.onResize.bind(this.topologyManager)))},VB.Editor.prototype.getParentByProperty=function(e,t,i,r){var n,o=function(e,t){e&&(t(e),r&&o(e.parent,t))};return o(e.parent,function(e){e&&null!=e[t]&&e[t]===i&&(n=e)}),n},VB.Editor.prototype.getParentByUserData=function(e,t,i,r){var n,o=function(e,t){e&&(t(e),r&&o(e.parent,t))};return o(e.parent,function(e){e&&e.userData&&null!=e.userData[t]&&e.userData[t]===i&&(n=e)}),n},VB.Editor.prototype.getChildByProperty=function(e,t,i,r){for(var n,o=function(e){e&&null!=e[t]&&e[t]===i&&(n=e)},a=function(e,t){if(e&&(t(e),r))for(var i=0,n=e.children.length;i<n;i++)a(e.children[i],t)},s=0,c=e.children.length;s<c;s++)a(e.children[s],o);return n},VB.Editor.prototype.getChildByUserData=function(e,t,i,r){for(var n,o=function(e){e&&e.userData&&null!=e.userData[t]&&e.userData[t]===i&&(n=e)},a=function(e,t){if(e&&(t(e),r))for(var i=0,n=e.children.length;i<n;i++)a(e.children[i],t)},s=0,c=e.children.length;s<c;s++)a(e.children[s],o);return n},VB.Editor.prototype.importModel=function(e,t){this.signals.sceneGraphChanged.active=!1,this.addObject(e),t!==this.scene&&this.moveObject(e,t),this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},VB.Editor.prototype.selectPosition=function(e){this.signals.selectPosition.dispatch(e)},VB.Editor.prototype.addMaterial=function(e){var t=e.uuid;this.materials[t]=e},VB.Editor.prototype.removeMaterial=function(e){var t=this.materials[e];t&&(delete this.materials[e],t.dispose())},VB.Editor.prototype.addTexture=function(e){var t=e.sourceFile;this.texture[t]=e},VB.Editor.prototype.removeTexture=function(e){var t=this.textures[e];t&&(delete this.textures[e],t.dispose())},VB.Editor.prototype.removeGeometry=function(e){var t=this.geometries[e];t&&(delete this.geometries[e],t.dispose())},VB.Editor.prototype.select=function(e){if(this.selected!==e){null!==e&&e.uuid,this.selected=e,this.signals.objectSelected.dispatch(e)}},VB.Editor.prototype.updateSceneBoundingBox=function(e){this.bbox=this.getBoundingBox(this.scene,e),this.signals.updateBoundingBox.dispatch(this.bbox.getCenter())},VB.Editor.prototype.update=function(){},VB.Editor.SelectMode={object:0,position:1,deviceobject:2},VB.EditorControls=function(e,t,i){t=void 0!==t?t:document,this.rotateTiltRange={max:Math.PI,min:Math.PI/2},this.enabled=!0,this.center=new THREE.Vector3,this.centerzoom=!0,this.wheelscale=1,this.rotateRad=new THREE.Vector3,this.handmode=!1,this.getIntersectPoint;var r=!1,n=new THREE.Vector3,o=this,a=new THREE.Vector3,s=VB.EditorControls.STATE.NONE;this.navigationMode={lbuttonDown:VB.EditorControls.STATE.ROTATE,mbuttonDown:VB.EditorControls.STATE.ZOOM,rbuttonDown:VB.EditorControls.STATE.PAN},this.oldNavigantionMode={lbuttonDown:VB.EditorControls.STATE.ROTATE,mbuttonDown:VB.EditorControls.STATE.ZOOM,rbuttonDown:VB.EditorControls.STATE.PAN},this.saveNavigationMode=function(){o.oldNavigantionMode.lbuttonDown=o.navigationMode.lbuttonDown,o.oldNavigantionMode.mbuttonDown=o.navigationMode.mbuttonDown,o.oldNavigantionMode.rbuttonDown=o.navigationMode.rbuttonDown},this.restoreNavigationMode=function(){o.navigationMode.lbuttonDown=o.oldNavigantionMode.lbuttonDown,o.navigationMode.mbuttonDown=o.oldNavigantionMode.mbuttonDown,o.navigationMode.rbuttonDown=o.oldNavigantionMode.rbuttonDown};var c=new THREE.Matrix3,l=new THREE.Vector2,h=new THREE.Vector2,u={type:"change"};function d(e){if(!1!==o.enabled){l.set(e.clientX,e.clientY);var t=l.x-h.x,i=l.y-h.y;s===VB.EditorControls.STATE.ROTATE?o.rotate(new THREE.Vector3(.005*-t,.005*-i,0),!1):s===VB.EditorControls.STATE.ZOOM?o.zoom(new THREE.Vector3(0,0,i)):s===VB.EditorControls.STATE.PAN?o.pan(new THREE.Vector3(-t,i,0)):s==VB.EditorControls.STATE.PARALLELPAN&&o.parallelpan(new THREE.Vector3(-t,i,0)),h.set(e.clientX,e.clientY)}}function p(e){t.removeEventListener("mousemove",d,!1),t.removeEventListener("mouseup",p,!1),t.removeEventListener("mouseout",p,!1),t.removeEventListener("dblclick",p,!1),s=VB.EditorControls.STATE.NONE}function f(e){if(e.preventDefault(),!1!==o.enabled){var t=0;e.wheelDelta?t=-e.wheelDelta*o.wheelscale:e.detail&&(t=10*e.detail*o.wheelscale),o.centerzoom?o.zoom_on_point(new THREE.Vector3(0,0,t)):o.zoom(new THREE.Vector3(0,0,t))}}this.focus=function(t,i){var r=new THREE.Vector3;t.matrixWorld.decompose(o.center,new THREE.Quaternion,r);var n=(new THREE.Vector3).copy(o.center);if(i&&t.geometry){r=(r.x+r.y+r.z)/3,n.add(t.geometry.boundingSphere.center.clone().multiplyScalar(r));var a=t.geometry.boundingSphere.radius*r,s=e.position.clone().sub(n).normalize().multiplyScalar(2*a);e.position.copy(n).add(s)}e.lookAt(n),o.dispatchEvent(u)},this.pan=function(t){var i=e.position.distanceTo(o.center);i<5e3&&(i=5e3),t.multiplyScalar(.001*i),t.applyMatrix3(c.getNormalMatrix(e.matrix)),e.position.add(t),o.dispatchEvent(u)},this.parallelpan=function(t){var i=e.position.distanceTo(o.center);i<5e3&&(i=5e3),t.multiplyScalar(.002*i),t.applyMatrix3(c.getNormalMatrix(e.matrix)),t.y=0,e.position.add(t),o.dispatchEvent(u)},this.zoom_on_point=function(r){var n=r.z,a=e.position.distanceTo(o.center);if(a<5e3&&(a=5e3),r.multiplyScalar(.001*a),!(r.length()>a)){if(r.applyMatrix3(c.getNormalMatrix(e.matrix)),this.rotateTiltRange.min>=Math.PI/2){var s=(new THREE.Vector3).copy(e.position).add(r),l=(i.bbox.containsPoint(e.position),i.bbox.containsPoint(s),i.bbox.getCenter()),h=[];(new THREE.Vector3).copy(l).x=i.bbox.min.x,(new THREE.Vector3).copy(l).x=i.bbox.max.x,(new THREE.Vector3).copy(l).z=i.bbox.max.z,(new THREE.Vector3).copy(l).z=i.bbox.min.z,(new THREE.Vector3).copy(l).y=i.bbox.min.y,h.push(new THREE.Plane(new THREE.Vector3(-1,0,0),-Math.abs(i.bbox.min.x))),h.push(new THREE.Plane(new THREE.Vector3(1,0,0),-Math.abs(i.bbox.max.x))),h.push(new THREE.Plane(new THREE.Vector3(0,0,1),-Math.abs(i.bbox.max.z))),h.push(new THREE.Plane(new THREE.Vector3(0,0,-1),-Math.abs(i.bbox.min.z))),h.push(new THREE.Plane(new THREE.Vector3(0,-1,0),-Math.abs(i.bbox.min.y))),(v=new THREE.Vector3(0,0,-1)).applyMatrix3(c.getNormalMatrix(e.matrix)),v.normalize();var d=(new THREE.Vector3).copy(r);d.normalize();for(var p=d.dot(v),f=new THREE.Ray(e.position,d),m=0;m<h.length;++m){var g=f.distanceToPlane(h[m]);if(g&&g-100-e.near<r.length()&&Math.abs(p-1)<.001&&d.dot(h[m].normal)>0)return}}var v,y=event.clientX/t.offsetWidth*2-1,E=-event.clientY/t.offsetHeight*2+1;(v=new THREE.Vector3(y,E,.1)).unproject(e),v.sub(e.position),e.position.addVectors(e.position,v.setLength(10*-n)),o.dispatchEvent(u)}},this.zoom=function(t){var r=e.position.distanceTo(o.center);if(r<5e3&&(r=5e3),t.multiplyScalar(.001*r),!(t.length()>r)){if(t.applyMatrix3(c.getNormalMatrix(e.matrix)),this.rotateTiltRange.min>=Math.PI/2){var n=(new THREE.Vector3).copy(e.position).add(t),a=(i.bbox.containsPoint(e.position),i.bbox.containsPoint(n),i.bbox.getCenter()),s=[];(new THREE.Vector3).copy(a).x=i.bbox.min.x,(new THREE.Vector3).copy(a).x=i.bbox.max.x,(new THREE.Vector3).copy(a).z=i.bbox.max.z,(new THREE.Vector3).copy(a).z=i.bbox.min.z,(new THREE.Vector3).copy(a).y=i.bbox.min.y,s.push(new THREE.Plane(new THREE.Vector3(-1,0,0),-Math.abs(i.bbox.min.x))),s.push(new THREE.Plane(new THREE.Vector3(1,0,0),-Math.abs(i.bbox.max.x))),s.push(new THREE.Plane(new THREE.Vector3(0,0,1),-Math.abs(i.bbox.max.z))),s.push(new THREE.Plane(new THREE.Vector3(0,0,-1),-Math.abs(i.bbox.min.z))),s.push(new THREE.Plane(new THREE.Vector3(0,-1,0),-Math.abs(i.bbox.min.y)));var l=new THREE.Vector3(0,0,-1);l.applyMatrix3(c.getNormalMatrix(e.matrix)),l.normalize();var h=(new THREE.Vector3).copy(t);h.normalize();for(var d=h.dot(l),p=new THREE.Ray(e.position,h),f=0;f<s.length;++f){var m=p.distanceToPlane(s[f]);if(m&&m-100-e.near<t.length()&&Math.abs(d-1)<.001&&h.dot(s[f].normal)>0)return}}e.position.add(t),o.dispatchEvent(u)}},this.rotate=function(t,i){if(i&&(r=!0,n.copy(o.center)),o.getIntersectPoint&&r){!1;var s=new THREE.Vector3(0,0,-1);s.applyQuaternion(e.quaternion);var c=s.angleTo(new THREE.Vector3(0,1,0));o.rotateTiltRange.max<c-t.y?t.y=0:c-t.y<o.rotateTiltRange.min&&(t.y=0),a.copy(e.position).sub(n);var l=new THREE.Matrix4;l.makeRotationAxis(new THREE.Vector3(0,1,0),t.x);var h=new THREE.Vector3(1,0,0).applyEuler(e.rotation),d=new THREE.Matrix4;d.makeRotationAxis(h,t.y),l.multiply(d),a.applyMatrix4(l),e.position.copy(n).add(a),s.applyMatrix4(l),e.lookAt(s.add(e.position))}o.dispatchEvent(u)},this.rotate2=function(t,i){if(i&&(r=!0,n.copy(o.center)),o.getIntersectPoint&&r){a.copy(e.position).sub(o.center);var s=Math.atan2(a.x,a.z),c=Math.atan2(Math.sqrt(a.x*a.x+a.z*a.z),a.y);s+=t;c=Math.max(1e-6,Math.min(Math.PI-1e-6,c));var l=a.length();a.x=l*Math.sin(c)*Math.sin(s),a.y=l*Math.cos(c),a.z=l*Math.sin(c)*Math.cos(s),e.position.copy(o.center).add(a),e.lookAt(o.center)}o.dispatchEvent(u)};new THREE.Vector3;var m=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],g=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],v=null;"ontouchstart"in window?(t.addEventListener("touchstart",function(e){if(!1!==o.enabled){switch(e.touches.length){case 1:m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),m[1].set(e.touches[0].pageX,e.touches[0].pageY,0);break;case 2:m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),m[1].set(e.touches[1].pageX,e.touches[1].pageY,0),v=m[0].distanceTo(m[1]);break;case 3:m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),m[1].set(e.touches[1].pageX,e.touches[1].pageY,0)}var t;g[0].copy(m[0]),g[1].copy(m[1]),!o.getIntersectPoint||1!==e.touches.length&&3!==e.touches.length||((t=o.getIntersectPoint(new THREE.Vector2(e.touches[0].pageX,e.touches[0].pageY)))?(r=!0,n.copy(t)):(r=!0,n.copy(o.center))),o.getIntersectPoint&&2===e.touches.length&&((t=o.getIntersectPoint(new THREE.Vector2((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2)))?(r=!0,n.copy(t)):(r=!0,n.copy(o.center)))}},!1),t.addEventListener("touchmove",function(e){if(e.preventDefault(),e.stopPropagation(),!1!==o.enabled){var t=function(e,t){var i=t[0];for(var r in t)i.distanceTo(e)>t[r].distanceTo(e)&&(i=t[r]);return i};if(o.navigationMode.lbuttonDown==VB.EditorControls.STATE.ROTATE)switch(e.touches.length){case 1:m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),m[1].set(e.touches[0].pageX,e.touches[0].pageY,0),o.rotate(m[0].sub(t(m[0],g)).multiplyScalar(-.005),!1);break;case 2:m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),m[1].set(e.touches[1].pageX,e.touches[1].pageY,0),distance=m[0].distanceTo(m[1]),o.zoom(new THREE.Vector3(0,0,v-distance)),v=distance;var i=m[0].clone().sub(t(m[0],g)),r=m[1].clone().sub(t(m[1],g));i.x=-i.x,r.x=-r.x,o.pan(i.add(r).multiplyScalar(.5))}else switch(e.touches.length){case 1:m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),(i=m[0].clone().sub(t(m[0],g))).x=-i.x,o.parallelpan(i);break;case 2:m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),m[1].set(e.touches[1].pageX,e.touches[1].pageY,0);var n=m[1].sub(m[0]).angleTo(g[1].sub(g[0]));m[1].sub(m[0]).cross(g[1].sub(g[0])).z>0&&(n*=-1),o.rotate2(n,!1),m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),m[1].set(e.touches[1].pageX,e.touches[1].pageY,0),distance=m[0].distanceTo(m[1]),o.zoom(new THREE.Vector3(0,0,2*(v-distance))),v=distance;break;case 3:m[0].set(e.touches[0].pageX,e.touches[0].pageY,0),m[1].set(e.touches[0].pageX,e.touches[0].pageY,0),o.rotate(m[0].sub(t(m[0],g)).multiplyScalar(-.005),!1)}g[0].copy(m[0]),g[1].copy(m[1])}},!1),t.addEventListener("mousewheel",f,!1)):(t.addEventListener("contextmenu",function(e){e.preventDefault()},!1),t.addEventListener("mousedown",function(e){if(!1!==o.enabled){if(0===e.button?s=o.navigationMode.lbuttonDown:1===e.button?s=o.navigationMode.mbuttonDown:2===e.button&&(s=o.navigationMode.rbuttonDown),h.set(e.clientX,e.clientY),o.getIntersectPoint&&s===VB.EditorControls.STATE.ROTATE){var i=o.getIntersectPoint(h);i?(r=!0,n.copy(i)):(r=!0,n.copy(o.center))}t.addEventListener("mousemove",d,!1),t.addEventListener("mouseup",p,!1),t.addEventListener("mouseout",p,!1),t.addEventListener("dblclick",p,!1)}},!1),t.addEventListener("mousewheel",f,!1),t.addEventListener("DOMMouseScroll",f,!1)),this.update=function(){this.rotateRad.length()&&(r=!0,n.copy(n.copy(o.center)),this.rotate(this.rotateRad,!1))}},VB.EditorControls.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,PARALLELPAN:3},VB.EditorControls.prototype=Object.create(THREE.EventDispatcher.prototype),VB.EditorControls.prototype.constructor=VB.EditorControls,VB.SBMLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.materials={},this.textures={}},VB.SBMLoader.prototype={constructor:VB.SBMLoader,load:function(e,t,i,r,n){var o=this,a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.crossOrigin=this.crossOrgin,a.onreadystatechange=function(){4!==this.readyState||200!==this.status&&304!==this.status||i(o.parse(this.response,t,r),t)},a.send(null)},parse:function(e,t,i){var r={totalModels:0,totalMaterials:0,loadedModels:0,loadedMaterials:0,totalSBMs:t.totalSBMs,currentSBMs:t.currentSBMs};console.time("SBMParse");var n=new THREE.Object3D;n.userData.filesource=t.fileUrl,n.userData.id=t.id,n.userData.materials=[],n.userData.textures=[],null!=t.baseFloor&&(n.userData.baseFloor=t.baseFloor),n.name=t.name;var o=new DataView(e),a=0,s=getAsciiString(e,a,8);if(a+=8,"SBM-----"!==s)throw" SBM  .";var c=o.getUint8(a);if(a+=1,c>3)throw"  SBM .";var l=o.getUint16(a,!0);a+=2;var h=o.getUint16(a,!0);a+=2,r.totalModels=h,r.totalMaterials=l;for(var u=0;u<l;++u){var d=o.getUint16(a,!0);a+=2;o.getFloat32(a,!0);a+=4;o.getFloat32(a,!0);a+=4;o.getFloat32(a,!0);a+=4;o.getFloat32(a,!0);a+=4;var p=o.getFloat32(a,!0);a+=4;var f=o.getFloat32(a,!0);a+=4;var m=o.getFloat32(a,!0);a+=4;var g=o.getFloat32(a,!0);a+=4;o.getFloat32(a,!0);a+=4;o.getFloat32(a,!0);a+=4;o.getFloat32(a,!0);a+=4;o.getFloat32(a,!0);a+=4;var v=o.getUint8(a,!0);a+=1;var y=0;0===v?y=THREE.FrontSide:1===v?y=THREE.BackSide:2===v&&(y=THREE.DoubleSide);var E=o.getUint16(a,!0);a+=2;var x=null;if(E>0){for(var b=e.slice(a,a+E),w="",T="",M=new Uint8Array(b,0,E),S=0;S<E;++S)M[S]>127?T=T+"%"+M[S].toString(16).toUpperCase():(T.length&&(w+=decodeURIforEUCKR(T)),w+=String.fromCharCode(M[S]),T="");a+=E,w=w.replace("\\","/");var R=null;if(t.textureUrl){if(t.textureUrl.toString().length){var A,_=w;-1!==(A=_.lastIndexOf("/"))&&(_=_.substr(A+1,_.length-A+1)),R=t.textureUrl+_}}else R=-1!==(A=(R=t.fileUrl).lastIndexOf("/"))?R.substr(0,A+1)+w:w;this.textures[R]?x=this.textures[R]:((x=VB.TextureUtils.load(R)).name=w,this.textures[R]=x,n.userData.textures.push(R)),x.wrapS=THREE.RepeatWrapping,x.wrapT=THREE.RepeatWrapping,x.flipY=!1,t.anisotropy&&(x.anisotropy=t.anisotropy)}var D=this.materials[d.toString()];null==D&&((D=new THREE.MeshPhongMaterial({color:new THREE.Color(p,f,m),opacity:g,transparent:!0,map:x,side:y,alphaTest:.5,shininess:50,specular:328965,needsUpdate:!0})).name=d.toString(),this.materials[d.toString()]=D,n.userData.materials.push(D.uuid)),r.loadedMaterials++,i&&i(r)}for(u=0;u<h;++u){d=String(o.getUint16(a,!0));if(a+=2,3===c){var C=o.getUint16(a,!0);a+=2;x=null;if(C>0){for(b=e.slice(a,a+C),T="",M=new Uint8Array(b,0,C),S=0;S<C;++S)M[S]>127?T=T+"%"+M[S].toString(16).toUpperCase():(T.length&&decodeURIforEUCKR(T),String.fromCharCode(M[S]),T="");a+=C}}var L=o.getUint16(a,!0);a+=2;var P=new THREE.Geometry,H=0;if(c>=3?(H=o.getUint32(a,!0),a+=4):(H=o.getUint16(a,!0),a+=2),H>0)for(var B=0;B<H;++B){var I=new THREE.Vector3;I.x=o.getFloat32(a,!0),a+=4,I.y=o.getFloat32(a,!0),a+=4,I.z=o.getFloat32(a,!0),a+=4,I.multiplyScalar(t.scale),P.vertices.push(I)}var O=0;if(c>=3?(O=o.getUint32(a,!0),a+=4):(O=o.getUint16(a,!0),a+=2),O>0)for(var U=0;U<O;++U){var N=new THREE.Vector3;N.x=o.getFloat32(a,!0),a+=4,N.y=o.getFloat32(a,!0),a+=4,N.z=o.getFloat32(a,!0),a+=4}var V=0;c>=3?(V=o.getUint32(a,!0),a+=4):(V=o.getUint16(a,!0),a+=2);var F=new Array(V);if(V>0)for(var z=0;z<V;++z){var j=new THREE.Vector2;j.x=o.getFloat32(a,!0),a+=4,j.y=o.getFloat32(a,!0),a+=4,F[z]=j}var k=0;if(c>=3?(k=o.getUint32(a,!0),a+=4):(k=o.getUint16(a,!0),a+=2),k>0)for(var G=0;G<k;++G){var W=new THREE.Face3;W.a=o.getUint16(a,!0),a+=2,W.b=o.getUint16(a,!0),a+=2,W.c=o.getUint16(a,!0),a+=2,P.faces.push(W),F.length>0&&P.faceVertexUvs[0].push([F[W.a],F[W.b],F[W.c]])}P.computeBoundingSphere(),P.computeBoundingBox(),P.computeVertexNormals(!0),P.computeFaceNormals();var X=P;if(t.useBufferGeometry&&((X=new THREE.BufferGeometry).fromGeometry(P),X.boundingBox=P.boundingBox.clone()),this.materials[L.toString()]){var Y=new THREE.Mesh(X,this.materials[L.toString()]);Y.userData.id=d,Y.name=d,Y.castShadow=!0,Y.receiveShadow=!0,n.add(Y)}r.loadedModels++,i&&i(r)}return console.timeEnd("SBMParse"),n}},VB.Loader=function(e){e.signals;this.loadFile=function(i){var r=i.name,n=r.split(".").pop().toLowerCase();switch(n){case"awd":(o=new FileReader).addEventListener("load",function(t){var i=(new THREE.AWDLoader).parse(t.target.result);e.setScene(i)},!1),o.readAsArrayBuffer(i);break;case"babylon":(o=new FileReader).addEventListener("load",function(t){var i=t.target.result,r=JSON.parse(i),n=(new THREE.BabylonLoader).parse(r);e.setScene(n)},!1),o.readAsText(i);break;case"babylonmeshdata":(o=new FileReader).addEventListener("load",function(t){var i=t.target.result,n=JSON.parse(i),o=(new THREE.BabylonLoader).parseGeometry(n),a=new THREE.MeshPhongMaterial,s=new THREE.Mesh(o,a);s.name=r,e.addObject(s),e.select(s)},!1),o.readAsText(i);break;case"ctm":(o=new FileReader).addEventListener("load",function(t){var n=new Uint8Array(t.target.result),o=new CTM.Stream(n);o.offset=0,(new THREE.CTMLoader).createModel(new CTM.File(o),function(t){t.sourceType="ctm",t.sourceFile=i.name;var n=new THREE.MeshPhongMaterial,o=new THREE.Mesh(t,n);o.name=r,e.addObject(o),e.select(o)})},!1),o.readAsArrayBuffer(i);break;case"dae":(o=new FileReader).addEventListener("load",function(t){var i=t.target.result,n=(new DOMParser).parseFromString(i,"text/xml");(new THREE.ColladaLoader).parse(n,function(t){t.scene.name=r,e.addObject(t.scene),e.select(t.scene)})},!1),o.readAsText(i);break;case"js":case"json":case"3geo":case"3mat":case"3obj":case"3scn":(o=new FileReader).addEventListener("load",function(e){var n,o=e.target.result;if(-1!==o.indexOf("postMessage")){var a=new Blob([o],{type:"text/javascript"}),s=URL.createObjectURL(a),c=new Worker(s);return c.onmessage=function(e){e.data.metadata={version:2},t(e.data,i,r)},void c.postMessage(Date.now())}try{n=JSON.parse(o)}catch(e){return void alert(e)}t(n,i,r)},!1),o.readAsText(i);break;case"obj":(o=new FileReader).addEventListener("load",function(t){var i=t.target.result,n=(new THREE.OBJLoader).parse(i);n.name=r,e.addObject(n),e.select(n)},!1),o.readAsText(i);break;case"ply":(o=new FileReader).addEventListener("load",function(t){var n=t.target.result,o=(new THREE.PLYLoader).parse(n);o.sourceType="ply",o.sourceFile=i.name;var a=new THREE.MeshPhongMaterial,s=new THREE.Mesh(o,a);s.name=r,e.addObject(s),e.select(s)},!1),o.readAsText(i);break;case"stl":(o=new FileReader).addEventListener("load",function(t){var n=t.target.result,o=(new THREE.STLLoader).parse(n);o.sourceType="stl",o.sourceFile=i.name;var a=new THREE.MeshPhongMaterial,s=new THREE.Mesh(o,a);s.name=r,e.addObject(s),e.select(s)},!1),void 0!==o.readAsBinaryString?o.readAsBinaryString(i):o.readAsArrayBuffer(i);break;case"vtk":(o=new FileReader).addEventListener("load",function(t){var n=t.target.result,o=(new THREE.VTKLoader).parse(n);o.sourceType="vtk",o.sourceFile=i.name;var a=new THREE.MeshPhongMaterial,s=new THREE.Mesh(o,a);s.name=r,e.addObject(s),e.select(s)},!1),o.readAsText(i);break;case"wrl":var o;(o=new FileReader).addEventListener("load",function(t){var i=t.target.result,r=(new THREE.VRMLLoader).parse(i);e.setScene(r)},!1),o.readAsText(i);break;case"sbm":break;default:alert("Unsupported file format ("+n+").")}};var t=function(t,i,r){if(void 0===t.metadata&&(t.metadata={type:"Geometry"}),void 0===t.metadata.type&&(t.metadata.type="Geometry"),void 0===t.metadata.version&&(t.metadata.version=t.metadata.formatVersion),"BufferGeometry"===t.metadata.type){var n=(new THREE.BufferGeometryLoader).parse(t),o=new THREE.Mesh(n);e.addObject(o),e.select(o)}else if("geometry"===t.metadata.type.toLowerCase()){var a,s=(n=(new THREE.JSONLoader).parse(t)).geometry;a=void 0!==n.materials?n.materials.length>1?new THREE.MeshFaceMaterial(n.materials):n.materials[0]:new THREE.MeshPhongMaterial,s.sourceType="ascii",s.sourceFile=i.name,(o=s.animation&&s.animation.hierarchy?new THREE.SkinnedMesh(s,a):new THREE.Mesh(s,a)).name=r,e.addObject(o),e.select(o)}else if("object"===t.metadata.type.toLowerCase()){(n=(new THREE.ObjectLoader).parse(t))instanceof THREE.Scene?e.setScene(n):(e.addObject(n),e.select(n))}else if("scene"===t.metadata.type.toLowerCase()){(new THREE.SceneLoader).parse(t,function(t){e.setScene(t.scene)},"")}}},VB.BoxHelper=function(e){THREE.BoxHelper.call(this,e)},VB.BoxHelper.prototype=Object.create(THREE.BoxHelper.prototype),VB.BoxHelper.prototype.constructor=VB.BoxHelper,VB.BoxHelper.prototype.update=function(e){var t,i,r;if(e instanceof THREE.Object3D){var n=(new THREE.Box3).setFromObject(e);i=n.min,r=n.max}else null===(t=e.geometry).boundingBox&&t.computeBoundingBox(),i=t.boundingBox.min,r=t.boundingBox.max;var o=this.geometry.attributes.position.array;o[0]=r.x,o[1]=r.y,o[2]=r.z,o[3]=i.x,o[4]=r.y,o[5]=r.z,o[6]=i.x,o[7]=r.y,o[8]=r.z,o[9]=i.x,o[10]=i.y,o[11]=r.z,o[12]=i.x,o[13]=i.y,o[14]=r.z,o[15]=r.x,o[16]=i.y,o[17]=r.z,o[18]=r.x,o[19]=i.y,o[20]=r.z,o[21]=r.x,o[22]=r.y,o[23]=r.z,o[24]=r.x,o[25]=r.y,o[26]=i.z,o[27]=i.x,o[28]=r.y,o[29]=i.z,o[30]=i.x,o[31]=r.y,o[32]=i.z,o[33]=i.x,o[34]=i.y,o[35]=i.z,o[36]=i.x,o[37]=i.y,o[38]=i.z,o[39]=r.x,o[40]=i.y,o[41]=i.z,o[42]=r.x,o[43]=i.y,o[44]=i.z,o[45]=r.x,o[46]=r.y,o[47]=i.z,o[48]=r.x,o[49]=r.y,o[50]=r.z,o[51]=r.x,o[52]=r.y,o[53]=i.z,o[54]=i.x,o[55]=r.y,o[56]=r.z,o[57]=i.x,o[58]=r.y,o[59]=i.z,o[60]=i.x,o[61]=i.y,o[62]=r.z,o[63]=i.x,o[64]=i.y,o[65]=i.z,o[66]=r.x,o[67]=i.y,o[68]=r.z,o[69]=r.x,o[70]=i.y,o[71]=i.z,this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeBoundingSphere(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1},VB.Viewport=function(e){var t,i,r=0;this.preRender=new Map,this.postRender=new Map,this.renderRequestId=-1,this.enable=!0,this.continuousRender=!1,this.enableFocus=!0,this.enableSelect=!0,this.renderer=null;var n=this,o=e.signals,a=this.continuousRender;o.continuousRender.add(function(e){a=n.continuousRender,n.continuousRender=e}),o.continuousRenderSrc.add(function(){n.continuousRender=a});var s=new UI.Panel;this.container=s,s.setId("viewport"),s.setPosition("absolute"),s.add(new Viewport.Info(e));var c=e.scene,l=e.sceneHelpers,h=[];this.clipPlanes=[];var u=new THREE.GridHelper(500,25);l.add(u);var d=e.camera,p=[],f=new VB.TransformControls(d,s.dom);this.transformControls=f,f.addEventListener("change",function(){if(f.visible){var t=f.object;void 0!==t&&void 0!==e.helpers[t.id]&&e.helpers[t.id].update(),P()}}),f.addEventListener("mouseDown",function(){f.visible&&(A.enabled=!1)}),f.addEventListener("mouseUp",function(){f.visible&&(o.objectChanged.dispatch(f.object),A.enabled=!0)}),l.add(f);var m=new THREE.Raycaster,g=new THREE.Vector2,v=function(e,t){return g.set(2*e.x-1,-2*e.y+1),m.setFromCamera(g,d),t instanceof Array?m.intersectObjects(t):m.intersectObject(t)};this.getIntersectPoint=function(t){console.log("x :"+t.x+", y : "+t.y);var i=new THREE.Vector3;i.fromArray(w(s.dom,t.x,t.y));for(var r=v(i,h),n=0;n<r.length;++n){var o=r[n].object;if(o.visible)if(null==e.getParentByProperty(o,"visible",!1,!0))return r[n].point}};var y=new THREE.Vector2,E=new THREE.Vector2,x=new THREE.Vector2,b=new THREE.Vector2;this.onMovePosition=b;var w=function(e,t,i){var r=e.getBoundingClientRect();return[(t-r.left)/r.width,(i-r.top)/r.height]},T=function(t){r++,setTimeout(function(){if(1===r){if(y.distanceTo(E)<.1||VB.Editor.SelectMode.position){var i=v(E,h);if(i.length>0){if(e.selectMode===VB.Editor.SelectMode.object){for(var n,o=0;o<i.length;++o)if((n=i[o].object).visible){if(null==e.getParentByProperty(n,"visible",!1,!0))break;n=void 0}n&&void 0!==n.userData.object?e.select(n.userData.object):e.select(n)}else if(e.selectMode===VB.Editor.SelectMode.position){for(o=0;o<i.length;++o)if((n=i[o].object).visible){if(null==e.getParentByProperty(n,"visible",!1,!0))break;n=void 0}n?e.selectPosition(i[o]):e.selectPosition()}}else e.selectMode===VB.Editor.SelectMode.position&&e.selectPosition(),e.select(null);P()}r=0}else r>1&&(y.distanceTo(E)<.1&&R(t),r=0)},200)},M=function(e){e.preventDefault();var t=w(s.dom,e.clientX,e.clientY);E.fromArray(t),0===e.button&&T(e),document.removeEventListener("mouseup",M,!1)},S=function(e){e.preventDefault();var t=e.changedTouches[0],i=w(s.dom,t.clientX,t.clientY);E.fromArray(i),b.fromArray(i),T(e),document.removeEventListener("touchend",S,!1)},R=function(t){t.preventDefault(),console.log("onDoubleClick");var i=w(s.dom,t.clientX,t.clientY);x.fromArray(i);for(var r,n=v(x,h),a=0;a<n.length;++a)if(r=n[a].object){if(null==e.getParentByProperty(r,"visible",!1,!0))break;r=void 0}console.log(n[0].point),r&&o.objectFocused.dispatch(r)};"ontouchstart"in window?(s.dom.addEventListener("touchstart",function(e){e.preventDefault();var t=e.changedTouches[0],i=w(s.dom,t.clientX,t.clientY);y.fromArray(i),b.fromArray(i),document.addEventListener("touchend",S,!1)},!1),s.dom.addEventListener("touchmove",function(e){var t=e.changedTouches[0],i=w(s.dom,t.clientX,t.clientY);b.fromArray(i)},!1)):(s.dom.addEventListener("mousedown",function(e){e.preventDefault();var t=w(s.dom,e.clientX,e.clientY);y.fromArray(t),document.addEventListener("mouseup",M,!1)},!1),s.dom.addEventListener("mousemove",function(e){var t=w(s.dom,e.clientX,e.clientY);b.fromArray(t)},!1));var A=new VB.EditorControls(d,s.dom,e);this.controls=A,A.addEventListener("change",function(){f.update(),o.cameraChanged.dispatch(d)}),A.getIntersectPoint=this.getIntersectPoint,o.editorCleared.add(function(){A.center.set(0,0,0),P()}),o.themeChanged.add(function(e){switch(e){case"../lib/THREE/editor/css/light.css":u.setColors(4473924,8947848),_=11184810;break;case"../lib/THREE/editor/css/dark.css":default:u.setColors(12303291,8947848),_=3355443}n.renderer.setClearColor(_),P()}),o.transformModeChanged.add(function(e){f.setMode(e)}),o.snapChanged.add(function(e){f.setSnap(e)}),o.spaceChanged.add(function(e){f.setSpace(e)}),o.rendererChanged.add(function(e,t){s.dom.removeChild(n.renderer.domElement),n.renderer=D(e,t),n.renderer.setSize(s.dom.offsetWidth,s.dom.offsetHeight),s.dom.appendChild(n.renderer.domElement),P()}),o.sceneGraphChanged.add(function(){P()}),o.cameraChanged.add(function(){P()}),o.objectSelected.add(function(e){if(!1!==n.enableSelect){for(var t=0;t<p.length;++t)l.remove(p[t]);if(p=[],f.detach(),null!==e&&e instanceof VB.Poi==!1&&e instanceof VB.Layer==!1){if(void 0!==e.geometry&&e instanceof THREE.Sprite==!1)if(e.parent&&e.parent instanceof THREE.Group)for(t=0;t<e.parent.children.length;++t){var i=new THREE.EdgesHelper(e.parent.children[t],16711680);p.push(i,16776960),l.add(i)}else{i=new THREE.EdgesHelper(e,16711680);p.push(i,16711680),l.add(i)}f.attach(e)}P()}}),o.objectFocused.add(function(e){n.enableFocus&&A.focus(e)}),o.geometryChanged.add(function(t){if(e.selected.parent&&e.selected.parent instanceof THREE.Group)for(var i=0;i<e.selected.parent.children.length;++i){var r=new THREE.EdgesHelper(e.selected.parent.children[i],16711680);p.push(r,16711680),l.add(r)}else{r=new THREE.EdgesHelper(e.selected,16711680);p.push(r,16711680),l.add(r)}P()}),o.objectAdded.add(function(e){var t=!1;e.traverse(function(e){e instanceof THREE.Light&&(t=!0),h.push(e)}),!0===t&&C()}),o.objectChanged.add(function(t){f.update(),t instanceof THREE.PerspectiveCamera&&t.updateProjectionMatrix(),void 0!==e.helpers[t.id]&&e.helpers[t.id].update(),P()}),o.objectRemoved.add(function(e){var t=!1;e.traverse(function(e){e instanceof THREE.Light&&(t=!0),h.splice(h.indexOf(e),1)}),!0===t&&C()}),o.helperAdded.add(function(e){h.push(e.getObjectByName("picker"))}),o.helperRemoved.add(function(e){h.splice(h.indexOf(e.getObjectByName("picker")),1)}),o.materialChanged.add(function(e){P()}),o.windowResize.add(function(){if(d.aspect=s.dom.offsetWidth/s.dom.offsetHeight,d.updateProjectionMatrix(),n.renderer.setSize(s.dom.offsetWidth,s.dom.offsetHeight),i){var e=s.dom.offsetWidth||2,r=s.dom.offsetHeight||2;t.uniforms.resolution.value.set(1/e,1/r),i.reset()}P()}),o.showGridChanged.add(function(e){u.visible=e,P()}),o.updateBoundingBox.add(function(e){A.center.copy(e)});var _,D=function(e,r){var n=!1;"WebGLRenderer"===e&&(!1===System.support.webgl?e="CanvasRenderer":n=!1);var o=new THREE[e]({antialias:r,logarithmicDepthBuffer:n});o.setClearColor(_),o.setPixelRatio(window.devicePixelRatio),o.autoClear=!1,o.autoUpdateScene=!1,o.gammaInput=!0,o.gammaOutput=!0,console.log(o.capabilities.getMaxAnisotropy()),null==t&&(t=new THREE.ShaderPass(THREE.FXAAShader));var a=o.domElement.offsetWidth||2,s=o.domElement.offsetHeight||2;return t.uniforms.resolution.value.set(1/a,1/s),(i=new THREE.EffectComposer(o)).addPass(t),o};function C(){e.scene.traverse(function(e){if(e.material&&(e.material.needsUpdate=!0,e.material instanceof THREE.MeshFaceMaterial))for(var t=0;t<e.material.materials.length;t++)e.material.materials[t].needsUpdate=!0})}this.renderer=D(e.config.getKey("project/renderer"),e.config.getKey("project/renderer/antialias")),this.outlinePass=void 0,s.dom.appendChild(this.renderer.domElement),this.animate(),this.mainRender=function(){n.controls.update(),n.renderer.render(c,d),n.renderer instanceof THREE.RaytracingRenderer==!1&&n.renderer.render(l,d),i&&i.render(),e.update&&e.update(),null!=e.Effect&&(e.Effect.skyboxCamera.rotation.copy(d.rotation),n.renderer.render(e.Effect.skyboxScene,e.Effect.skyboxCamera))};var L=function(){if(n.enable){for(var e in l.updateMatrixWorld(),c.updateMatrixWorld(),TWEEN&&TWEEN.update(),n.renderer.clear(),!1===n.renderer.autoClear&&n.renderer.clearDepth(),n.preRender.map)n.preRender.map[e]();for(var e in n.mainRender(),n.postRender.map)n.postRender.map[e]()}},P=function(){!1===n.continuousRender&&L()};this.renderByState=P,this.render=L,this.getMousePosition=w,VB.Viewport.prototype.worldToScreen=function(e){var t=new THREE.Vector3;return t.copy(e),t.project(d),t.x=Math.round((t.x+1)*n.renderer.domElement.clientWidth/2),t.y=Math.round((1-t.y)*n.renderer.domElement.clientHeight/2),t.z=0,t},VB.Viewport.prototype.setNavigationMode=function(e,t){A.navigationMode[e]=t}},VB.Viewport.prototype.getWidth=function(){return this.renderer.domElement.width},VB.Viewport.prototype.getHeight=function(){return this.renderer.domElement.height},VB.Viewport.prototype.animate=function(){var e=this;if(this.renderRequestId=requestAnimationFrame(function(){e.animate()}),THREE.SEA3D.AnimationHandler.animators.length>0){THREE.SEA3D.AnimationHandler.update(.016);for(var t=0,i=sceneHelpers.children.length;t<i;t++){var r=sceneHelpers.children[t];r instanceof THREE.SkeletonHelper&&r.update()}e.render()}else e.render&&e.continuousRender&&e.render()},VB.Viewport.prototype.stopAnimate=function(){-1!==this.renderRequestId&&window.cancelAnimationFrame(this.renderRequestId),this.renderRequestId=-1},VB.Viewport.prototype.addPreRender=function(e,t){this.preRender.containsKey(e)||this.preRender.put(e,t)},VB.Viewport.prototype.removePreRender=function(e,t){this.preRender.containsKey(e)&&this.preRender.remove(e)},VB.Viewport.prototype.addPostRender=function(e,t){this.postRender.containsKey(e)||this.postRender.put(e,t)},VB.Viewport.prototype.removePostRender=function(e,t){this.postRender.containsKey(e)||this.postRender.put(e,t)},VB.Viewport.prototype.enableTransformControl=function(e){this.transformControls.visible=e},function(){"use strict";var e=function(e){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.FrontSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};(e.prototype=Object.create(THREE.MeshBasicMaterial.prototype)).constructor=e;var t=function(e){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};(t.prototype=Object.create(THREE.LineBasicMaterial.prototype)).constructor=t,VB.TransformGizmo=function(){var e=this;this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var e=new THREE.PlaneBufferGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({wireframe:!0});t.side=THREE.DoubleSide;var i={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};for(var r in this.activePlane=i.XYZE,i.YZ.rotation.set(0,Math.PI/2,0),i.XZ.rotation.set(-Math.PI/2,0,0),i)i[r].name=r,this.planes.add(i[r]),this.planes[r]=i[r],i[r].visible=!1;var n=function(e,t){for(var i in e)for(r=e[i].length;r--;){var n=e[i][r][0],o=e[i][r][1],a=e[i][r][2];n.name=i,o&&n.position.set(o[0],o[1],o[2]),a&&n.rotation.set(a[0],a[1],a[2]),t.add(n)}};n(this.handleGizmos,this.handles),n(this.pickerGizmos,this.pickers),this.traverse(function(e){if(e instanceof THREE.Mesh){e.updateMatrix();var t=e.geometry.clone();t.applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}})},this.hide=function(){this.traverse(function(e){e.visible=!1})},this.show=function(){this.traverse(function(t){t.visible=!0,t.parent==e.pickers&&(t.visible=!1),t.parent==e.planes&&(t.visible=!1)}),this.activePlane.visible=!1},this.highlight=function(e){this.traverse(function(t){t.material&&t.material.highlight&&(t.name==e?t.material.highlight(!0):t.material.highlight(!1))})}},VB.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype),VB.TransformGizmo.prototype.constructor=VB.TransformGizmo,VB.TransformGizmo.prototype.update=function(e,t){var i=new THREE.Vector3(0,0,0),r=new THREE.Vector3(0,1,0),n=new THREE.Matrix4;this.traverse(function(o){-1!=o.name.search("E")?o.quaternion.setFromRotationMatrix(n.lookAt(t,i,r)):-1==o.name.search("X")&&-1==o.name.search("Y")&&-1==o.name.search("Z")||o.quaternion.setFromEuler(e)})},VB.TransformGizmoTranslate=function(){VB.TransformGizmo.call(this);var i=new THREE.Geometry,r=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));r.position.y=.5,r.updateMatrix(),i.merge(r.geometry,r.matrix);var n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0));var o=new THREE.Geometry;o.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0));var a=new THREE.Geometry;a.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)),this.handleGizmos={X:[[new THREE.Mesh(i,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(n,new t({color:16711680}))]],Y:[[new THREE.Mesh(i,new e({color:65280})),[0,.5,0]],[new THREE.Line(o,new t({color:65280}))]],Z:[[new THREE.Mesh(i,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(a,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new e({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new e({color:16711680,opacity:.25})),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new e({color:65280,opacity:.25})),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new e({color:255,opacity:.25})),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),new e({color:16777215,opacity:.25}))]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),new e({color:16776960,opacity:.25})),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),new e({color:65535,opacity:.25})),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),new e({color:16711935,opacity:.25})),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"==e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"==e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"==e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"==e&&(this.activePlane=this.planes.XYZE),"XY"==e&&(this.activePlane=this.planes.XY),"YZ"==e&&(this.activePlane=this.planes.YZ),"XZ"==e&&(this.activePlane=this.planes.XZ),this.hide(),this.show()},this.init()},VB.TransformGizmoTranslate.prototype=Object.create(VB.TransformGizmo.prototype),VB.TransformGizmoTranslate.prototype.constructor=VB.TransformGizmoTranslate,VB.TransformGizmoRotate=function(){VB.TransformGizmo.call(this);var i=function(e,t,i){var r=new THREE.Geometry;i=i||1;for(var n=0;n<=64*i;++n)"x"==t&&r.vertices.push(new THREE.Vector3(0,Math.cos(n/32*Math.PI),Math.sin(n/32*Math.PI)).multiplyScalar(e)),"y"==t&&r.vertices.push(new THREE.Vector3(Math.cos(n/32*Math.PI),0,Math.sin(n/32*Math.PI)).multiplyScalar(e)),"z"==t&&r.vertices.push(new THREE.Vector3(Math.sin(n/32*Math.PI),Math.cos(n/32*Math.PI),0).multiplyScalar(e));return r};this.handleGizmos={X:[[new THREE.Line(new i(1,"x",.5),new t({color:16711680}))]],Y:[[new THREE.Line(new i(1,"y",.5),new t({color:65280}))]],Z:[[new THREE.Line(new i(1,"z",.5),new t({color:255}))]],E:[[new THREE.Line(new i(1.25,"z",1),new t({color:13421568}))]],XYZE:[[new THREE.Line(new i(1,"z",1),new t({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new e({color:16711680,opacity:.25})),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new e({color:65280,opacity:.25})),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),new e({color:255,opacity:.25})),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusGeometry(1.25,.12,2,24),new e({color:16776960,opacity:.25}))]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]},this.setActivePlane=function(e){"E"==e&&(this.activePlane=this.planes.XYZE),"X"==e&&(this.activePlane=this.planes.YZ),"Y"==e&&(this.activePlane=this.planes.XZ),"Z"==e&&(this.activePlane=this.planes.XY),this.hide(),this.show()},this.update=function(e,t){VB.TransformGizmo.prototype.update.apply(this,arguments);this.handles,this.pickers;var i=new THREE.Matrix4,r=new THREE.Euler(0,0,1),n=new THREE.Quaternion,o=new THREE.Vector3(1,0,0),a=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),c=new THREE.Quaternion,l=new THREE.Quaternion,h=new THREE.Quaternion,u=t.clone();r.copy(this.planes.XY.rotation),n.setFromEuler(r),i.makeRotationFromQuaternion(n).getInverse(i),u.applyMatrix4(i),this.traverse(function(e){n.setFromEuler(r),"X"==e.name&&(c.setFromAxisAngle(o,Math.atan2(-u.y,u.z)),n.multiplyQuaternions(n,c),e.quaternion.copy(n)),"Y"==e.name&&(l.setFromAxisAngle(a,Math.atan2(u.x,u.z)),n.multiplyQuaternions(n,l),e.quaternion.copy(n)),"Z"==e.name&&(h.setFromAxisAngle(s,Math.atan2(u.y,u.x)),n.multiplyQuaternions(n,h),e.quaternion.copy(n))})},this.init()},VB.TransformGizmoRotate.prototype=Object.create(VB.TransformGizmo.prototype),VB.TransformGizmoRotate.prototype.constructor=VB.TransformGizmoRotate,VB.TransformGizmoScale=function(){VB.TransformGizmo.call(this);var i=new THREE.Geometry,r=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));r.position.y=.5,r.updateMatrix(),i.merge(r.geometry,r.matrix);var n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0));var o=new THREE.Geometry;o.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0));var a=new THREE.Geometry;a.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)),this.handleGizmos={X:[[new THREE.Mesh(i,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(n,new t({color:16711680}))]],Y:[[new THREE.Mesh(i,new e({color:65280})),[0,.5,0]],[new THREE.Line(o,new t({color:65280}))]],Z:[[new THREE.Mesh(i,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(a,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125),new e({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new e({color:16711680,opacity:.25})),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new e({color:65280,opacity:.25})),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),new e({color:255,opacity:.25})),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.4,.4,.4),new e({color:16777215,opacity:.25}))]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"==e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"==e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"==e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"==e&&(this.activePlane=this.planes.XYZE),this.hide(),this.show()},this.init()},VB.TransformGizmoScale.prototype=Object.create(VB.TransformGizmo.prototype),VB.TransformGizmoScale.prototype.constructor=VB.TransformGizmoScale,VB.TransformControls=function(e,t){THREE.Object3D.call(this),t=void 0!==t?t:document,this.gizmo={},this.gizmo.translate=new VB.TransformGizmoTranslate,this.gizmo.rotate=new VB.TransformGizmoRotate,this.gizmo.scale=new VB.TransformGizmoScale,this.add(this.gizmo.translate),this.add(this.gizmo.rotate),this.add(this.gizmo.scale),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.object=void 0,this.snap=null,this.space="world",this.size=1,this.axis=null;var i=this,r=!1,n="translate",o={type:"change"},a={type:"mouseDown"},s={type:"mouseUp",mode:n},c={type:"objectChange"},l=new THREE.Raycaster,h=new THREE.Vector3,u=new THREE.Vector3,d=new THREE.Vector3,p=new THREE.Vector3,f=new THREE.Vector3,m=1,g=new THREE.Matrix4,v=new THREE.Vector3,y=new THREE.Matrix4,E=new THREE.Vector3,x=new THREE.Quaternion,b=new THREE.Vector3(1,0,0),w=new THREE.Vector3(0,1,0),T=new THREE.Vector3(0,0,1),M=new THREE.Quaternion,S=new THREE.Quaternion,R=new THREE.Quaternion,A=new THREE.Quaternion,_=new THREE.Quaternion,D=new THREE.Vector3,C=new THREE.Vector3,L=new THREE.Matrix4,P=new THREE.Matrix4,H=new THREE.Vector3,B=new THREE.Vector3,I=new THREE.Euler,O=new THREE.Matrix4,U=new THREE.Vector3,N=new THREE.Euler;function V(e){if(!1!==i.visible&&void 0!==i.object&&!0!==r){e.preventDefault();var t=k(e.changedTouches?e.changedTouches[0]:e,i.gizmo[n].pickers.children),a=null;t&&(a=t.object.name),i.axis!==a&&(i.axis=a,i.update(),i.dispatchEvent(o))}}function F(e){if(!1!==i.visible&&void 0!==i.object&&!0!==r){e.preventDefault(),e.stopPropagation();var t=e.changedTouches?e.changedTouches[0]:e;if(0===t.button||void 0===t.button){var o=k(t,i.gizmo[n].pickers.children);if(o){i.dispatchEvent(a),i.axis=o.object.name,i.update(),v.copy(U).sub(B).normalize(),i.gizmo[n].setActivePlane(i.axis,v);var s=k(t,[i.gizmo[n].activePlane]);D.copy(i.object.position),C.copy(i.object.scale),L.extractRotation(i.object.matrix),O.extractRotation(i.object.matrixWorld),P.extractRotation(i.object.parent.matrixWorld),H.setFromMatrixScale(y.getInverse(i.object.parent.matrixWorld)),d.copy(s.point)}}r=!0}}function z(e){if(!1!==i.visible&&void 0!==i.object&&null!==i.axis&&!1!==r){e.preventDefault(),e.stopPropagation();var t=k(e.changedTouches?e.changedTouches[0]:e,[i.gizmo[n].activePlane]);u.copy(t.point),"translate"==n?(u.sub(d),u.multiply(H),"local"==i.space&&(u.applyMatrix4(y.getInverse(O)),-1==i.axis.search("X")&&(u.x=0),-1==i.axis.search("Y")&&(u.y=0),-1==i.axis.search("Z")&&(u.z=0),u.applyMatrix4(L),i.object.position.copy(D),i.object.position.add(u)),"world"!=i.space&&-1==i.axis.search("XYZ")||(-1==i.axis.search("X")&&(u.x=0),-1==i.axis.search("Y")&&(u.y=0),-1==i.axis.search("Z")&&(u.z=0),u.applyMatrix4(y.getInverse(P)),i.object instanceof VB.Poi?(i.object.pos3D.copy(D),i.object.pos3D.add(u)):(i.object.position.copy(D),i.object.position.add(u))),null!==i.snap&&(-1!=i.axis.search("X")&&(i.object.position.x=Math.round(i.object.position.x/i.snap)*i.snap),-1!=i.axis.search("Y")&&(i.object.position.y=Math.round(i.object.position.y/i.snap)*i.snap),-1!=i.axis.search("Z")&&(i.object.position.z=Math.round(i.object.position.z/i.snap)*i.snap))):"scale"==n?(u.sub(d),u.multiply(H),"local"==i.space&&("XYZ"==i.axis?(m=1+u.y/50,i.object.scale.x=C.x*m,i.object.scale.y=C.y*m,i.object.scale.z=C.z*m):(u.applyMatrix4(y.getInverse(O)),"X"==i.axis&&(i.object.scale.x=C.x*(1+u.x/50)),"Y"==i.axis&&(i.object.scale.y=C.y*(1+u.y/50)),"Z"==i.axis&&(i.object.scale.z=C.z*(1+u.z/50))))):"rotate"==n&&(u.sub(B),u.multiply(H),E.copy(d).sub(B),E.multiply(H),"E"==i.axis?(u.applyMatrix4(y.getInverse(g)),E.applyMatrix4(y.getInverse(g)),p.set(Math.atan2(u.z,u.y),Math.atan2(u.x,u.z),Math.atan2(u.y,u.x)),f.set(Math.atan2(E.z,E.y),Math.atan2(E.x,E.z),Math.atan2(E.y,E.x)),x.setFromRotationMatrix(y.getInverse(P)),_.setFromAxisAngle(v,p.z-f.z),M.setFromRotationMatrix(O),x.multiplyQuaternions(x,_),x.multiplyQuaternions(x,M),i.object.quaternion.copy(x)):"XYZE"==i.axis?(_.setFromEuler(u.clone().cross(E).normalize()),x.setFromRotationMatrix(y.getInverse(P)),S.setFromAxisAngle(_,-u.clone().angleTo(E)),M.setFromRotationMatrix(O),x.multiplyQuaternions(x,S),x.multiplyQuaternions(x,M),i.object.quaternion.copy(x)):"local"==i.space?(u.applyMatrix4(y.getInverse(O)),E.applyMatrix4(y.getInverse(O)),p.set(Math.atan2(u.z,u.y),Math.atan2(u.x,u.z),Math.atan2(u.y,u.x)),f.set(Math.atan2(E.z,E.y),Math.atan2(E.x,E.z),Math.atan2(E.y,E.x)),M.setFromRotationMatrix(L),S.setFromAxisAngle(b,p.x-f.x),R.setFromAxisAngle(w,p.y-f.y),A.setFromAxisAngle(T,p.z-f.z),"X"==i.axis&&M.multiplyQuaternions(M,S),"Y"==i.axis&&M.multiplyQuaternions(M,R),"Z"==i.axis&&M.multiplyQuaternions(M,A),i.object.quaternion.copy(M)):"world"==i.space&&(p.set(Math.atan2(u.z,u.y),Math.atan2(u.x,u.z),Math.atan2(u.y,u.x)),f.set(Math.atan2(E.z,E.y),Math.atan2(E.x,E.z),Math.atan2(E.y,E.x)),x.setFromRotationMatrix(y.getInverse(P)),S.setFromAxisAngle(b,p.x-f.x),R.setFromAxisAngle(w,p.y-f.y),A.setFromAxisAngle(T,p.z-f.z),M.setFromRotationMatrix(O),"X"==i.axis&&x.multiplyQuaternions(x,S),"Y"==i.axis&&x.multiplyQuaternions(x,R),"Z"==i.axis&&x.multiplyQuaternions(x,A),x.multiplyQuaternions(x,M),i.object.quaternion.copy(x))),i.update(),i.dispatchEvent(o),i.dispatchEvent(c)}}function j(e){!1!==i.visible&&(r&&null!==i.axis&&(s.mode=n,i.dispatchEvent(s)),r=!1,V(e))}function k(i,r){var n=t.getBoundingClientRect(),o=(i.clientX-n.left)/n.width,a=(i.clientY-n.top)/n.height;h.set(2*o-1,-2*a+1,.5),h.unproject(e),l.set(U,h.sub(U).normalize());var s=l.intersectObjects(r,!0);return!!s[0]&&s[0]}t.addEventListener("mousedown",F,!1),t.addEventListener("touchstart",F,!1),t.addEventListener("mousemove",V,!1),t.addEventListener("touchmove",V,!1),t.addEventListener("mousemove",z,!1),t.addEventListener("touchmove",z,!1),t.addEventListener("mouseup",j,!1),t.addEventListener("mouseout",j,!1),t.addEventListener("touchend",j,!1),t.addEventListener("touchcancel",j,!1),t.addEventListener("touchleave",j,!1),this.attach=function(e){i.object=e,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[n].show(),i.update()},this.detach=function(e){i.object=void 0,this.axis=null,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide()},this.setMode=function(e){"scale"==(n=e||n)&&(i.space="local"),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[n].show(),this.update(),i.dispatchEvent(o)},this.setSnap=function(e){i.snap=e},this.setSize=function(e){i.size=e,this.update(),i.dispatchEvent(o)},this.setSpace=function(e){i.space=e,this.update(),i.dispatchEvent(o)},this.update=function(){void 0!==i.object&&(i.object.updateMatrixWorld(),B.setFromMatrixPosition(i.object.matrixWorld),I.setFromRotationMatrix(y.extractRotation(i.object.matrixWorld)),e.updateMatrixWorld(),U.setFromMatrixPosition(e.matrixWorld),N.setFromRotationMatrix(y.extractRotation(e.matrixWorld)),m=B.distanceTo(U)/6*i.size,this.position.copy(B),this.scale.set(m,m,m),v.copy(U).sub(B).normalize(),"local"==i.space?this.gizmo[n].update(I,v):"world"==i.space&&this.gizmo[n].update(new THREE.Euler,v),this.gizmo[n].highlight(i.axis))}},VB.TransformControls.prototype=Object.create(THREE.Object3D.prototype),VB.TransformControls.prototype.constructor=VB.TransformControls}();var filesToEncoding={"utf8.bin":"utf-8","utf16le.bin":"utf-16le","macintosh.bin":"macintosh"},m1=new THREE.Matrix4,m2=new THREE.Matrix4,m3=new THREE.Matrix4;m1.makeRotationY(1*-Math.PI/4),m2.makeRotationX(1*-Math.PI/4);var lt=new THREE.Euler;m3.multiplyMatrices(m1,m2),lt.setFromRotationMatrix(m3),m1=new THREE.Matrix4,m2=new THREE.Matrix4,m3=new THREE.Matrix4,m1.makeRotationY(1*Math.PI/4-.009),m2.makeRotationX(1*-Math.PI/4-.009);var rt=new THREE.Euler;m3.multiplyMatrices(m1,m2),rt.setFromRotationMatrix(m3);var VIEWPOINT={LEFT:{x:0,y:-Math.PI/2+.009,z:0},RIGHT:{x:0,y:Math.PI/2-.009,z:0},FRONT:{x:0,y:0,z:0},BACK:{x:0,y:Math.PI-.009,z:0},TOP:{x:-Math.PI/2+.009,y:0,z:0},BOTTOM:{x:Math.PI/2-.009,y:0,z:0},LEFTTOP:{x:lt.x,y:lt.y,z:lt.z},RIGHTTOP:{x:rt.x,y:rt.y,z:rt.z}};console.log(VIEWPOINT.LEFTTOP.x),console.log(VIEWPOINT.LEFTTOP.y),console.log(VIEWPOINT.LEFTTOP.z);var UNIT_X=new THREE.Vector3(1,0,0),UNIT_Y=new THREE.Vector3(0,1,0),FLT_MAX=3.402823466e38,FLT_MIN=1.175494351e-38;function torad(e){return e*(Math.PI/180)}function getRotationTo(e,t){var i=new THREE.Quaternion,r=e.clone(),n=t;r.normalize(),n.normalize();var o=r.dot(n);if(o>=1)return i;if(o<1e-6-1){var a=new THREE.Vector3;a.crossVectors(UNIT_X,e),a.lengthSq()<1e-12&&a.crossVectors(UNIT_Y,e),a.normalize(),i.setFromAxisAngle(a,Math.PI)}else{var s=Math.sqrt(2*(1+o)),c=1/s,l=new THREE.Vector3;l.crossVectors(r,n),i.x=l.x*c,i.y=l.y*c,i.z=l.z*c,i.w=.5*s,i.normalize()}return i}function getAsciiString(e,t,i){return String.fromCharCode.apply(null,new Uint8Array(e,t,i))}VB.TextureUtils={nextHighestPowerOfTwo_:function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},ensurePowerOfTw:function(e){if(!THREE.Math.isPowerOfTwo(e.width)||!THREE.Math.isPowerOfTwo(e.height)){var t=document.createElement("canvas");return t.width=this.nextHighestPowerOfTwo_(e.width),t.height=this.nextHighestPowerOfTwo_(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t}return e},load:function(e,t){var i,r=this,n=THREE.Loader.Handlers.get(e);return null!==n?i=n.load(e,t):(i=new THREE.Texture,(n=new THREE.ImageLoader).crossOrigin="anonymous",n.load(e,function(e){i.image=r.ensurePowerOfTw(e),i.needsUpdate=!0,t&&t(i)})),i.sourceFile=e,i}},VB.LibraryManager=function(e,t,i){this.mainCamera=t,this.renderer=e,this.onMovePosition=i;this.renderer.domElement.clientWidth,this.renderer.domElement.clientHeight;var r=new THREE.Vector2,n=new THREE.Vector2,o=this,a=0,s=new Map;this.LoadLibrary=function(e,t,i,r){var n=new VB.SBMLoader;n.textures=editor.textures;var o={id:s.size()+1,name:t,fileUrl:i,useBufferGeometry:!0,scale:1,totalSBMs:1,currentSBMs:0,textureUrl:r,baseFloor:1};n.load(i,o,function(e,i){e.userData.type="library",e.visible=!1,s.put(t,e)})};var c=function(e){n.copy(o.onMovePosition),a++,setTimeout(function(){1===a?(console.log("library click"),0==r.distanceTo(n)&&0===e.button&&o.handleClick(e,a),a=0):a>1&&(0==r.distanceTo(n)&&0===e.button&&o.handleClick(e,a),a=0)},200),document.removeEventListener("mouseup",c,!1)},l=function(e){n.copy(o.onMovePosition),a++,console.log("clicks : :"+a),setTimeout(function(){1===a?(console.log("device click"),r.distanceTo(n)<.1&&o.handleClick(e,a),a=0):a>1&&(r.distanceTo(n)<.1&&o.handleClick(e,a),a=0)},200),document.removeEventListener("touchend",l,!1)};"ontouchstart"in window?this.renderer.domElement.addEventListener("touchstart",function(e){e.changedTouches[0];r.copy(o.onMovePosition),document.addEventListener("touchend",l,!1)},!1):this.renderer.domElement.addEventListener("mousedown",function(e){e.preventDefault(),r.copy(o.onMovePosition),document.addEventListener("mouseup",c,!1)},!1),this.clear=function(){this.libraryScene=new THREE.Scene,this.libraryScene.name="LIBRARY";var e=new THREE.AmbientLight(10132122);this.libraryScene.add(e),(e=new THREE.DirectionalLight(16777215,1)).position.set(1,.5,.8),this.libraryScene.add(e),s.clear()},this.clearModel=function(){for(var e=this.libraryScene.children.length-1;e>=0;e--){var t=this.libraryScene.children[e];"library"==t.userData.id&&this.libraryScene.remove(t)}},createInstace=function(e,t,i){var r=new THREE.Object3D;r.userData.id="library";for(var n=s.get(e),o=0;o<n.children.length;o++){var a=n.children[o],c=new THREE.Mesh(a.geometry,a.material);r.add(c)}return r.translateX(t.x),r.translateY(t.y),r.translateZ(t.z),r.rotateY(THREE.Math.degToRad(i)),r},this.getIntersectObjectByPos=function(e){var t=new THREE.Vector3;t.set(0,-1,0).transformDirection(this.mainCamera.matrixWorld);var i=new THREE.Raycaster;return i.set(e,t),i.intersectObject(editor.scene,!0)},this.InsertLibrary=function(e,t,i,r,n){e.editor;var o=createInstace(t,i,r);if(o.userData.name=t,n&&n>0){for(var a=1e11,s=this.getIntersectObjectByPos(i),c=0;c<s.length;++c)a=Math.min(a,s[c].distance);var l=new THREE.ConeGeometry(n,a-20,32),h=new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:.2}),u=new THREE.Mesh(l,h);u.translateY(-a/2+10),o.add(u),o.userData.lightcone=u}return this.libraryScene.add(o),o},this.update=function(){this.renderer.render(this.libraryScene,this.mainCamera)}},VB.LibraryManager.prototype.setVisibleLight=function(e,t,i){},VB.LibraryManager.prototype.onClick=function(e){console.log("VB.LibraryManager.prototype.onClick")},VB.LibraryManager.prototype.handleClick=function(e,t){e.preventDefault();for(var i=this.getIntersectObject(),r=0;r<i.length;++r){if(i[r].object instanceof THREE.Mesh)if(i[r].object.parent.visible)if(null==this.getParentByProperty(i[r].object,"visible",!1,!0)){e.stopPropagation();var n={id:i[r].object.parent.id,layerId:i[r].object.parent.parent.name,name:i[r].object.parent.userData.name,device:i[r].object.parent,clicks:t};return void(1===t?this.onClick(n):this.onDblClick(n))}}1===t?this.onClick(n):this.onDblClick(n)},VB.LibraryManager.prototype.getIntersectObject=function(){var e=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);return e.unproject(this.mainCamera),new THREE.Raycaster(this.mainCamera.position,e.sub(this.mainCamera.position).normalize()).intersectObject(this.libraryScene,!0)},VB.LibraryManager.prototype.getParentByProperty=function(e,t,i,r){var n,o=function(e,t){e&&(t(e),r&&o(e.parent,t))};return o(e.parent,function(e){e&&null!=e[t]&&e[t]===i&&(n=e)}),n},VB.Layer=function(){THREE.Group.call(this),this.type="Layer"},VB.Layer.prototype=Object.create(THREE.Group.prototype),VB.Icon=function(e){THREE.Sprite.call(this,e)},VB.Icon.prototype=Object.create(THREE.Sprite.prototype),VB.Poi=function(){THREE.Object3D.call(this),this.type="POI",this.icon=null,this.text=null,this.line=null,this.point=null,this.circle=null,this.mixer=null,this.clipAction=null,this.clock=new THREE.Clock,this.width=0,this.height=0,this.pos3D=new THREE.Vector3,this.elevation=0,this.srcMaterial={text:void 0,icon:void 0,line:void 0,point:void 0,circle:void 0},this.lod=[],this.zindex=0};var lineGeometry=new THREE.Geometry;lineGeometry.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,10,0));var pointGeometry=new THREE.CircleGeometry(1,8);VB.Poi.prototype=Object.create(THREE.Object3D.prototype),VB.Poi.prototype.createIcon=function(e){this.icon=new VB.Icon(e.material),this.icon.scale.set(e.width,e.height,1),this.icon.position.set(e.position.x,e.position.y,e.position.z),this.add(this.icon)},VB.Poi.prototype.createText=function(e,t){this.text=new Text2D(void 0,e,t),this.add(this.text.sprite),this.text.texture.flipY=!1},VB.Poi.prototype.createLine=function(e){this.line=new THREE.Line(lineGeometry,new THREE.LineDashedMaterial({color:16724016,dashSize:2,gapSize:1})),this.point=new THREE.Mesh(pointGeometry,new THREE.MeshBasicMaterial({color:16724016,side:THREE.BackSide})),this.add(this.line),this.add(this.point)},VB.Poi.prototype.createCircle=function(e){void 0==e&&(e=2);var t=new THREE.CircleGeometry(e,18),i=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.5,side:THREE.BackSide});this.circle=new THREE.Mesh(t,i),this.add(this.circle);var r=new THREE.VectorKeyframeTrack(".scale",[0,1,2,3],[1,10,20,30]),n=new THREE.AnimationClip("Poi Anmation",.8,[r]);this.mixer=new THREE.AnimationMixer(this.circle),this.clipAction=this.mixer.clipAction(n),this.clipAction.play()},VB.Poi.prototype.play=function(){this.clipAction.play()},VB.Poi.prototype.stop=function(){this.clipAction.stop()},VB.Poi.prototype.create=function(e){this.width=e.width,this.height=e.height,this.userData.id=e.id,this.name=e.name,this.pos3D=new THREE.Vector3(e.position.x,e.position.y,e.position.z),this.zindex=null!=e.zindex?e.zindex:0,this.elevation=null!=e.elevation?e.elevation:0,this.userData.floorid=null!=e.floorid?e.floorid:0,e.material.map.flipY=!1,this.createIcon(e);var t=new Array,i={text:e.name,size:10};t.push(i),this.createText(t,this.icon.position),this.createLine(e),this.saveMaterial()},VB.Poi.prototype.dispose=function(){this.parent&&this.parent.remove(this),this.restoreMaterial(),this.icon.geometry.dispose(),this.text.dispose(),this.srcMaterial={}},VB.Poi.prototype.setAnimation=function(){this.createCircle(),this.animation=!0,this.needsUpdate=!0},VB.Poi.prototype.saveMaterial=function(){this.srcMaterial={text:this.text.sprite.material,icon:this.icon.material}},VB.Poi.prototype.restoreMaterial=function(){this.srcMaterial.text.uuid!==this.text.sprite.material.uuid&&(this.text.sprite.material.dispose(),this.text.sprite.material=this.srcMaterial.text),this.srcMaterial.icon.uuid!==this.icon.material.uuid&&(this.icon.material.dispose(),this.icon.material=this.srcMaterial.icon)},VB.Poi.prototype.setColor=function(e,t,i,r){this.srcMaterial.text.uuid===this.text.sprite.material.uuid&&(this.text.sprite.material=this.text.sprite.material.clone()),this.srcMaterial.icon.uuid===this.icon.material.uuid&&(this.icon.material=this.icon.material.clone()),null!=e&&this.text.sprite.material.color.set(e),null!=i&&(this.text.sprite.material.opacity=i),null!=t&&this.icon.material.color.set(t),null!=r&&(this.icon.material.opacity=r)},VB.Poi.prototype.addLOD=function(e){e&&this.lod.push(e)},VB.Poi.prototype.getLODByDistance=function(e){for(var t in this.lod){var i=this.lod[t];if(e>i.min&&e<i.max)return i}},VB.Poi.prototype.applyLOD=function(e){e&&(this.icon.scale.set(e.iconSize.width,e.iconSize.height,1),this.icon.visible=e.visibleIcon,this.text.sprite.visible=e.visibleText,this.line.visible=e.visibleIcon||e.visibleText,this.point.visible=this.line.visible,this.circle&&(this.circle.visible=this.line.visible))},VB.Poi.LOD=function(e,t,i,r,n,o,a){this.level=e,this.iconSize={width:t,height:i},this.visibleText=r,this.visibleIcon=n,this.min=o,this.max=a};var SHOWONLY_POI=0,SHOW_POI=1,HIDE_POI=2;VB.PoiManager=function(e,t,i){this.orthoCamera=null,this.mainCamera=t,this.renderer=e,this.clear(),this.visible=!0,this.mouseOverObj=null,this.checkDepth,this.cellSize=50,this.poiCellDepthResult=[],this.onMovePosition=i;var r=this.renderer.domElement.clientWidth,n=this.renderer.domElement.clientHeight;this.orthoCamera=new THREE.OrthographicCamera(0,r,0,n,-10,1e3),this.orthoCamera.updateProjectionMatrix();var o=new THREE.Vector2,a=new THREE.Vector2,s=this,c=0;this.onLOD=!0;var l=function(e){a.copy(s.onMovePosition),c++,setTimeout(function(){1===c?(console.log("poi click"),0==o.distanceTo(a)&&0===e.button&&s.handleClick(e,c),c=0):c>1&&(0==o.distanceTo(a)&&0===e.button&&s.handleClick(e,c),c=0)},200),document.removeEventListener("mouseup",l,!1)},h=function(e){a.copy(s.onMovePosition),c++,console.log("clicks : :"+c),setTimeout(function(){1===c?(console.log("poi click"),o.distanceTo(a)<.1&&s.handleClick(e,c),c=0):c>1&&(o.distanceTo(a)<.1&&s.handleClick(e,c),c=0)},200),document.removeEventListener("touchend",h,!1)};"ontouchstart"in window?this.renderer.domElement.addEventListener("touchstart",function(e){e.changedTouches[0];o.copy(s.onMovePosition),document.addEventListener("touchend",h,!1)},!1):this.renderer.domElement.addEventListener("mousedown",function(e){e.preventDefault(),o.copy(s.onMovePosition),document.addEventListener("mouseup",l,!1)},!1),this.materials=[],this.moving},VB.PoiManager.prototype.createTooltip=function(){var e=new Array;e.push({text:"undefined",size:12}),this.tooltip=new Text2D(this.tooltipScene,e,new THREE.Vector3(0,0,0)),this.tooltip.texture.flipY=!1,this.tooltip.clearRect()},VB.PoiManager.prototype.clearMaterial=function(){for(var e in this.materials){var t=this.materials[e];t.map&&t.map.dispose(),t.dispose()}this.materials=[]},VB.PoiManager.prototype.addMaterial=function(e){if(null!=e){var t=this.materials[e.id];null==t&&(t=new THREE.SpriteMaterial({map:VB.TextureUtils.load(e.textureUrl),color:null==e.color?16777215:e.color,fog:null==e.fog||e.fog}),this.materials[e.id]=t)}},VB.PoiManager.prototype.clear=function(){this.poiScene=new THREE.Scene,this.poiScene.name="POIS",this.clearMaterial()},VB.PoiManager.prototype.getIntersectObject=function(){var e=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);e.unproject(this.orthoCamera);var t=new THREE.Vector3;t.set(0,0,-1).transformDirection(this.orthoCamera.matrixWorld);var i=new THREE.Raycaster;return i.set(e,t),i.intersectObject(this.poiScene,!0)},VB.PoiManager.prototype.handleClick=function(e,t){e.preventDefault();for(var i=this.getIntersectObject(),r=0;r<i.length;++r){if(i[r].object instanceof VB.Icon)if(i[r].object.parent.visible)if(null==this.getParentByProperty(i[r].object,"visible",!1,!0)){e.stopPropagation();var n={id:i[r].object.parent.id,layerId:i[r].object.parent.parent.name,name:i[r].object.parent.name,poi:i[r].object.parent,clicks:t};return void(1===t?this.onClick(n):this.onDblClick(n))}}1===t?this.onClick(n):this.onDblClick(n)},VB.PoiManager.prototype.getLayer=function(e){return this.getLayerByProperty("name",e)},VB.PoiManager.prototype.getLayerByProperty=function(e,t){var i;return this.poiScene.traverse(function(r){r instanceof VB.Layer&&null!=r[e]&&r[e]===t&&(i=r)}),i},VB.PoiManager.prototype.createLayer=function(e){var t=this.getLayerByProperty("name",e);return null==t&&((t=new VB.Layer).name=e,this.poiScene.add(t)),t},VB.PoiManager.prototype.removeLayerByProperty=function(e,t){var i=this.getLayerByProperty(e,t);null!=i&&this.removeLayer(i)},VB.PoiManager.prototype.removeLayer=function(e){e.traverse(function(e){VB.Poi}),e.parent&&e.parent.remove(e)},VB.PoiManager.prototype.getPoiByProperty=function(e,t){var i;return this.poiScene.traverse(function(r){r instanceof VB.Poi&&null!=r[e]&&r[e]===t&&(i=r)}),i},VB.PoiManager.prototype.getPoiByUserData=function(e,t){var i;return this.poiScene.traverse(function(r){"POI"===r.type&&null!=r.userData[e]&&r.userData[e]===t&&(i=r)}),i},VB.PoiManager.prototype.addPoi=function(e){var t=e.layerName,i=this.createLayer(t),r=new VB.Poi;return r.create(e),i.add(r),r},VB.PoiManager.prototype.update=function(){if(!1!==this.visible){var e=this.renderer.autoClear;this.renderer.autoClear=!1,this.renderer.clearDepth(),this.mainCamera.updateProjectionMatrix(),this.mainCamera.updateMatrixWorld();var t=new THREE.Frustum;(new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse),t.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse));var i=this,r=new Array,n=new Array;if(this.poiScene.traverse(function(e){if(e instanceof VB.Poi&&e.parent.visible){var o=e.pos3D.clone();o.project(i.mainCamera);var a=e.pos3D.clone();a.project(i.mainCamera),e&&(o.x=Math.round((o.x+1)*i.renderer.domElement.clientWidth/2),o.y=Math.round((1-o.y)*i.renderer.domElement.clientHeight/2),o.z=0,a.x=Math.round((a.x+1)*i.renderer.domElement.clientWidth/2),a.y=Math.round((1-a.y)*i.renderer.domElement.clientHeight/2),a.z=0),e.icon.position.set(o.x,o.y-e.icon.scale.y/2,e.zindex),e.text.sprite.position.copy(e.icon.position),e.text.sprite.position.y-=e.icon.scale.y/1.2,e.text.sprite.position.z+=1,e.line.position.copy(o),e.line.scale.y=(new THREE.Vector3).subVectors(o,a).length();var s=new THREE.Vector3(0,1,0).angleTo((new THREE.Vector3).subVectors(a,o).normalize());if(e.line.rotation.x=0,e.line.rotation.y=0,e.line.rotation.z=0,o.x<a.x&&(s=-s),e.line.rotateOnAxis(new THREE.Vector3(0,0,1),s),e.point.position.copy(a),e.point.scale.set(3,3,3),e.circle){e.circle.position.copy(a),e.circle.scale.set(3,3,3);var c=e.clock.getDelta();e.mixer.update(c)}if(!0===i.onLOD)if(t.containsPoint(e.pos3D)){var l=e.pos3D.distanceTo(i.mainCamera.position),h=e.getLODByDistance(l);if(h){e.applyLOD(h),e.text.sprite.position.y=e.icon.position.y,e.text.sprite.position.y-=e.icon.scale.y/1.2;var u=new THREE.Vector3;u.subVectors(i.mainCamera.position,e.pos3D),u.normalize()}else e.lod.length>0&&(r.push(e),n.push(e.visible),e.visible=!1)}else i.moving!==e&&(r.push(e),n.push(e.visible),e.visible=!1)}}),this.moving){var o=this.moving.pos3D.clone();o.project(i.mainCamera),o.x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),o.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),o.z=0,this.moving.icon.position.set(o.x,o.y-this.moving.height/2,this.moving.zindex),this.moving.text.sprite.position.copy(this.moving.icon.position),this.moving.text.sprite.position.y-=this.moving.height/1.2,this.moving.text.sprite.position.z+=1}this.renderer.render(this.poiScene,this.orthoCamera);for(var a=0;a<r.length;++a)r[a].visible=n[a];this.renderer.autoClear=e}},VB.PoiManager.prototype.update2=function(){if(!1!==this.visible){var e=this.renderer.autoClear;this.renderer.autoClear=!1,this.renderer.clearDepth(),this.mainCamera.updateMatrix(),this.mainCamera.updateMatrixWorld();var t=new THREE.Frustum;(new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse),t.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse));var i=this,r=new Array,n=new Array;if(this.poiScene.traverse(function(e){if(e instanceof VB.Poi){var o=e.pos3D.clone();o.project(i.mainCamera),e&&(o.x=Math.round((o.x+1)*i.renderer.domElement.clientWidth/2),o.y=Math.round((1-o.y)*i.renderer.domElement.clientHeight/2),o.z=0),e.icon.position.set(o.x,o.y-e.height/2,0),e.text.sprite.position.copy(e.icon.position),e.text.sprite.position.y-=e.height/1.2,e.text.sprite.position.z+=1,t.containsPoint(e.pos3D)||i.moving!==e&&(r.push(e),n.push(e.visible),e.visible=!1)}}),this.moving){var o=this.moving.pos3D.clone();o.project(i.mainCamera),o.x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),o.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),o.z=0,this.moving.icon.position.set(o.x,o.y-this.moving.height/2,0),this.moving.text.sprite.position.copy(this.moving.icon.position),this.moving.text.sprite.position.y-=this.moving.height/1.2,this.moving.text.sprite.position.z+=1}this.renderer.render(this.poiScene,this.orthoCamera);for(var a=0;a<r.length;++a)r[a].visible=n[a];this.renderer.autoClear=e}},VB.PoiManager.prototype.onClick=function(e){console.log("VB.PoiManager.prototype.onClick")},VB.PoiManager.prototype.onDblClick=function(e){console.log("VB.PoiManager.prototype.onDblClick")},VB.PoiManager.prototype.show=function(e){this.visible=e},VB.PoiManager.prototype.showLayer=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],n=this.getLayerByProperty("name",r);n&&(n.visible=t)}},VB.PoiManager.prototype.onResize=function(){this.orthoCamera.right=this.renderer.domElement.clientWidth,this.orthoCamera.bottom=this.renderer.domElement.clientHeight,this.orthoCamera.updateProjectionMatrix()},VB.PoiManager.prototype.getBoundingBox=function(e,t){if(e){var i=new THREE.Vector3,r=new THREE.Vector3,n=new THREE.Vector3(500,500,500);return t&&n.copy(t),i.copy(e.pos3D),r.copy(e.pos3D),i.sub(n),r.add(n),new THREE.Box3(i,r)}},VB.PoiManager.prototype.getBoundingBoxByUserId=function(e,t){var i=this.getPoiByUserData("id",e);if(i)return getBoundingBox(i)},VB.PoiManager.prototype.moveObject=function(e,t,i){if(void 0===t&&(t=this.poiScene),t.add(e),void 0!==i){var r=t.children.indexOf(i);t.children.splice(r,0,e),t.children.pop()}},VB.PoiManager.prototype.removePoiByLayerName=function(e){var t=this.getLayerByProperty("name",e);if(t){for(var i=[],r=0;r<t.children.length;++r){var n=t.children[r];n instanceof VB.Poi&&i.push(n)}for(r=0;r<i.length;++r)t.remove(i[r])}},VB.PoiManager.prototype.removePoiByProperty=function(e,t){var i=this.getPoiByProperty(e,t);i&&i.dispose()},VB.PoiManager.prototype.getParentByProperty=function(e,t,i,r){var n,o=function(e,t){e&&(t(e),r&&o(e.parent,t))};return o(e.parent,function(e){e&&null!=e[t]&&e[t]===i&&(n=e)}),n},VB.PoiManager.prototype.setMovingPoi=function(e){this.moving&&(this.moving.dispose(),this.moving=void 0),e&&(this.moving=this.addPoi({width:e.width,height:e.height,material:e.srcMaterial.icon,name:e.name,id:e.userData.id,position:{x:e.pos3D.x,y:e.pos3D.y,z:e.pos3D.z},layerName:"moving",zindex:2}))},VB.PoiManager.prototype.load=function(e,t,i,r){var n=this;if(document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState&&(0===o.status||200===o.status))if(o.responseXML)n.parse(e,o.responseXML,t,i);else if(o.responseText){var a=(new DOMParser).parseFromString(o.responseText,"application/xml");n.parse(e,a,t,i)}else r?r():console.error("GKXMLLoader : Empty or non-existing file ("+e+")")},o.open("GET",e,!0),o.send(null)}else alert("Don't know to parse XML")},VB.PoiManager.prototype.parse=function(e,t,i,r){var n=0,o=(t.evaluate?t:document).evaluate("Project/Poi",t,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),a=o.iterateNext();for(n=0;a;){var s=VB.TextureUtils.load(a.getAttribute("icon")),c=new THREE.SpriteMaterial({map:s,color:16777215,fog:!0}),l={layerName:"",id:"Poi "+ ++n,name:"",floorid:-1,imgname:"",memo:"",position:{x:0,y:0,z:0},width:32,height:32,icon:"../image/poi/poi_icon_indoor.png",material:c};l.id=a.getAttribute("id"),l.layerName=a.getAttribute("layername"),l.name=a.getAttribute("name"),l.imgname=a.getAttribute("imgname");var h=a.getAttribute("position").split(",");l.position.x=h[0],l.position.y=h[1],l.position.z=h[2],l.memo=a.getAttribute("memo"),l.floorid=a.getAttribute("floorid"),this.addPoi(l),a=o.iterateNext()}i&&i()},VB.Device=function(){THREE.Object3D.call(this),this.type="DEVICE",this.icon=null,this.text=null,this.line=null,this.point=null,this.circle=null,this.mixer=null,this.clipAction=null,this.clock=new THREE.Clock,this.width=0,this.height=0,this.pos3D=new THREE.Vector3,this.elevation=0,this.srcMaterial={text:void 0,icon:void 0,line:void 0,point:void 0,circle:void 0},this.lod=[],this.zindex=0,this.DeviceSelected=!1,this.DeviceStates=VB.Device.DeviceState.Normal,this.tooltip=!1,this.tooltip_text=null},VB.Device.DeviceState={Normal:-1,On:0,Off:1,NotRegister:2,Error:3,ComError:4};var lineGeometry=new THREE.Geometry;lineGeometry.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,10,0));var pointGeometry=new THREE.CircleGeometry(1,8);VB.Device.prototype=Object.create(THREE.Object3D.prototype),VB.Device.prototype.createIcon=function(e){this.icon=new VB.Icon(e.material),this.icon.scale.set(e.width,e.height,1),this.icon.position.set(e.position.x,e.position.y,e.position.z),this.add(this.icon)},VB.Device.prototype.createText=function(e,t){this.text=new Text2D(void 0,e,t),this.add(this.text.sprite),this.text.texture.flipY=!1},VB.Device.prototype.createLine=function(e){this.line=new THREE.Line(lineGeometry,new THREE.LineDashedMaterial({color:16724016,dashSize:2,gapSize:1})),this.point=new THREE.Mesh(pointGeometry,new THREE.MeshBasicMaterial({color:16724016,side:THREE.BackSide})),this.add(this.line),this.add(this.point)},VB.Device.prototype.createCircle=function(e){void 0==e&&(e=2);var t,i=new THREE.CircleGeometry(e,18);t=this.DeviceStates==VB.Device.DeviceState.Error?new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.5,side:THREE.BackSide}):new THREE.MeshBasicMaterial({color:255,transparent:!0,opacity:.5,side:THREE.BackSide}),this.circle=new THREE.Mesh(i,t),this.add(this.circle)},VB.Device.prototype.play=function(){this.clipAction&&this.clipAction.play()},VB.Device.prototype.stop=function(){this.circle&&this.remove(this.circle),this.clipAction&&this.clipAction.stop()},VB.Device.prototype.create=function(e){this.width=e.width,this.height=e.height,this.userData.id=e.id,this.name=e.name,this.pos3D=new THREE.Vector3(e.position.x,e.position.y,e.position.z),this.zindex=null!=e.zindex?e.zindex:0,this.elevation=null!=e.elevation?e.elevation:0,null!=e.material&&(e.material.map.flipY=!1),this.createIcon(e);var t=new Array,i={text:e.name,size:10};t.push(i),this.createText(t,this.icon.position),this.createLine(e),this.saveMaterial()},VB.Device.prototype.dispose=function(){this.parent&&this.parent.remove(this),this.restoreMaterial(),this.icon.geometry.dispose(),this.text.dispose(),this.srcMaterial={}},VB.Device.prototype.setAnimation=function(){this.createCircle(3);var e=new THREE.VectorKeyframeTrack(".scale",[0,1,2,3],[1,10,20,30]),t=new THREE.AnimationClip("Device Anmation",.8,[e]);this.mixer=new THREE.AnimationMixer(this.circle),this.clipAction=this.mixer.clipAction(t),this.clipAction.play()},VB.Device.prototype.saveMaterial=function(){this.srcMaterial={text:this.text.sprite.material,icon:this.icon.material}},VB.Device.prototype.restoreMaterial=function(){this.srcMaterial.text.uuid!==this.text.sprite.material.uuid&&(this.text.sprite.material.dispose(),this.text.sprite.material=this.srcMaterial.text),this.srcMaterial.icon.uuid!==this.icon.material.uuid&&(this.icon.material.dispose(),this.icon.material=this.srcMaterial.icon)},VB.Device.prototype.setSelect=function(){this.DeviceSelected?this.setDeselect():(this.DeviceSelected=!0,this.StopColorAnimator(),this.CreateColorAnimator(new THREE.Color(0,0,0),new THREE.Color(0,0,1),1e3))},VB.Device.prototype.setDeselect=function(){this.DeviceSelected=!1,this.setObjectState(this.DeviceStates)},VB.Device.prototype.setDeviceText=function(e,t,i){var r=new Array,n={text:e,size:i,color:t};r.push(n),this.text.setText(r)},VB.Device.prototype.setObjectState=function(e,t,i){switch(void 0==i&&(i=!1),this.object=this.GetObject(),this.stop(),this.StopColorAnimator(),this.DeviceStates=t,t){case VB.Device.DeviceState.Normal:i&&this.setDeviceText(this.name,"#ffffff",10),this.setColor(16777215,16777215,1,1);break;case VB.Device.DeviceState.On:case VB.Device.DeviceState.Off:this.setColor(16777215,16777215,1,1);break;case VB.Device.DeviceState.NotRegister:this.CreateColorAnimator(new THREE.Color(.5,.5,.5),new THREE.Color(.5,.5,.5),0),i&&this.setDeviceText(this.name+" : ","#000000",12),e.setVisibleLight(this,!1,!0),this.setColor(16777215,5263440,1,1);break;case VB.Device.DeviceState.Error:null==this.object?this.setAnimation():this.CreateColorAnimator(new THREE.Color(1,1,0),new THREE.Color(1,0,0),100),this.setColor(16777215,16711680,1,1),i&&this.setDeviceText(this.name+" : ","#ff0000",12),e.setVisibleLight(this,!1,!0);break;case VB.Device.DeviceState.ComError:this.setAnimation(),i&&this.setDeviceText(this.name+" : ","#0000ff",12),e.setVisibleLight(this,!1,!0),this.setColor(16777215,255,1,1)}},VB.Device.prototype.setColor=function(e,t,i,r){this.srcMaterial.text.uuid===this.text.sprite.material.uuid&&(this.text.sprite.material=this.text.sprite.material.clone()),this.srcMaterial.icon.uuid===this.icon.material.uuid&&(this.icon.material=this.icon.material.clone()),null!=e&&this.text.sprite.material.color.set(e),null!=i&&(this.text.sprite.material.opacity=i),null!=t&&this.icon.material.color.set(t),null!=r&&(this.icon.material.opacity=r)},VB.Device.prototype.addLOD=function(e){e&&this.lod.push(e)},VB.Device.prototype.getLODByDistance=function(e){for(var t in this.lod){var i=this.lod[t];if(e>i.min&&e<i.max)return i}},VB.Device.prototype.applyLOD=function(e){e&&(this.icon.scale.set(e.iconSize.width,e.iconSize.height,1),this.icon.visible=e.visibleIcon,this.text.sprite.visible=e.visibleText,this.line.visible=e.visibleIcon||e.visibleText,this.point.visible=this.line.visible,this.circle&&(this.circle.visible=this.line.visible))},VB.Device.LOD=function(e,t,i,r,n,o,a){this.level=e,this.iconSize={width:t,height:i},this.visibleText=r,this.visibleIcon=n,this.min=o,this.max=a},VB.Device.prototype.GetObject=function(){return this.userData.meshContainer},VB.Device.prototype.CreateColorAnimator=function(e,t,i){this.object=this.GetObject(),this.duration=i,this.controlMaterial=new THREE.MeshStandardMaterial({side:THREE.DoubleSide}),this.startColor=e,this.destColor=t,this.currColor=new THREE.Color(e.r,e.g,e.b),this.tweenToEnd=new TWEEN.Tween(this.currColor).to(this.destColor,this.duration),this.tweenToStart=new TWEEN.Tween(this.currColor).to(this.startColor,this.duration),this.tweenToEnd.easing=TWEEN.Easing.Elastic.InOut,this.tweenToStart.easing=TWEEN.Easing.Elastic.InOut,this.tweenToEnd.chain(this.tweenToStart),this.tweenToStart.chain(this.tweenToEnd),this.arrayMaterials=new Array;var r=this.controlMaterial,n=this.currColor;null!=this.object&&(this.object.traverse(function(e){e instanceof THREE.Mesh&&(e.material_bak=e.material,r.map=e.material.map,e.material=r)}),this.tweenToEnd.onUpdate(function(){r.color=n}),this.tweenToStart.onUpdate(function(){r.color=n}),this.tweenToEnd.start())},VB.Device.prototype.StopColorAnimator=function(){null!=this.object&&this.tweenToEnd&&(this.object.traverse(function(e){e instanceof THREE.Mesh&&(e.material=e.material_bak)}),this.tweenToEnd.stop())};var SHOWONLY_POI=0,SHOW_POI=1,HIDE_POI=2;VB.DeviceManager=function(e,t,i){this.orthoCamera=null,this.mainCamera=t,this.renderer=e,this.clear(),this.visible=!0,this.mouseOverObj=null,this.checkDepth,this.cellSize=50,this.poiCellDepthResult=[],this.tooltip_device=null,this.onMovePosition=i;var r=this.renderer.domElement.clientWidth,n=this.renderer.domElement.clientHeight;this.orthoCamera=new THREE.OrthographicCamera(0,r,0,n,-10,1e3),this.orthoCamera.updateProjectionMatrix();var o=new THREE.Vector2,a=new THREE.Vector2,s=this,c=0;this.onLOD=!0;var l=function(e){a.copy(s.onMovePosition),c++,setTimeout(function(){1===c?(console.log("device click"),0==o.distanceTo(a)&&0===e.button&&s.handleClick(e,c),c=0):c>1&&(0==o.distanceTo(a)&&0===e.button&&s.handleClick(e,c),c=0)},200),document.removeEventListener("mouseup",l,!1)},h=function(e){a.copy(s.onMovePosition),c++,console.log("clicks : :"+c),setTimeout(function(){1===c?(console.log("device click"),o.distanceTo(a)<.1&&s.handleClick(e,c),c=0):c>1&&(o.distanceTo(a)<.1&&s.handleClick(e,c),c=0)},200),document.removeEventListener("touchend",h,!1)};"ontouchstart"in window?this.renderer.domElement.addEventListener("touchstart",function(e){e.changedTouches[0];o.copy(s.onMovePosition),document.addEventListener("touchend",h,!1)},!1):this.renderer.domElement.addEventListener("mousedown",function(e){e.preventDefault(),o.copy(s.onMovePosition),document.addEventListener("mouseup",l,!1)},!1),this.materials=[],this.moving},VB.DeviceManager.prototype.createTooltip=function(){this.tooltip_device=this.addDevice({layerName:"tooltip",id:99999,name:"",position:{x:0,y:0,z:1},width:0,height:0,icon:"",groupId:0,zindex:2,elevation:0,animation:!1}),this.tooltip_device.tooltip=!0},VB.DeviceManager.prototype.clearMaterial=function(){for(var e in this.materials){var t=this.materials[e];t.map&&t.map.dispose(),t.dispose()}this.materials=[]},VB.DeviceManager.prototype.resetSelection=function(){this.deviceScene.traverse(function(e){e instanceof VB.Device&&e.parent.visible&&e.DeviceSelected&&e.setDeselect()})},VB.DeviceManager.prototype.getSelectedList=function(){var e=new Array;return this.deviceScene.traverse(function(t){t instanceof VB.Device&&t.parent.visible&&t.DeviceSelected&&e.push(t)}),e},VB.DeviceManager.prototype.addMaterial=function(e){if(null!=e){var t=this.materials[e.id];null==t&&(t=new THREE.SpriteMaterial({map:VB.TextureUtils.load(e.textureUrl),color:null==e.color?16777215:e.color,fog:null==e.fog||e.fog}),this.materials[e.id]=t)}},VB.DeviceManager.prototype.clear=function(e){this.deviceScene=new THREE.Scene,this.deviceScene.name="DEVICES",e&&this.clearMaterial()},VB.DeviceManager.prototype.getIntersectObject=function(){var e=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);e.unproject(this.orthoCamera);var t=new THREE.Vector3;t.set(0,0,-1).transformDirection(this.orthoCamera.matrixWorld);var i=new THREE.Raycaster;return i.set(e,t),i.intersectObject(this.deviceScene,!0)},VB.DeviceManager.prototype.getIntersectPoi=function(){var e=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);e.unproject(this.orthoCamera);var t=new THREE.Vector3;t.set(0,0,-1).transformDirection(this.orthoCamera.matrixWorld);var i=new THREE.Raycaster;i.set(e,t);for(var r=i.intersectObject(this.deviceScene,!0),n=0;n<r.length;++n){if(r[n].object instanceof VB.Icon)if(r[n].object.parent.visible)if(null==this.getParentByProperty(r[n].object,"visible",!1,!0))return event.stopPropagation(),{id:r[n].object.parent.id,layerId:r[n].object.parent.parent.name,name:r[n].object.parent.name,device:r[n].object.parent}}return null},VB.DeviceManager.prototype.handleClick=function(e,t){e.preventDefault();for(var i=this.getIntersectObject(),r=0;r<i.length;++r){if(i[r].object instanceof VB.Icon)if(i[r].object.parent.visible)if(null==this.getParentByProperty(i[r].object,"visible",!1,!0)){e.stopPropagation();var n={id:i[r].object.parent.id,layerId:i[r].object.parent.parent.name,name:i[r].object.parent.name,device:i[r].object.parent,clicks:t};return void(1===t?this.onClick(n):this.onDblClick(n))}}1===t?this.onClick(n):this.onDblClick(n)},VB.DeviceManager.prototype.getLayer=function(e){return this.getLayerByProperty("name",e)},VB.DeviceManager.prototype.getLayerByProperty=function(e,t){var i;return this.deviceScene.traverse(function(r){r instanceof VB.Layer&&null!=r[e]&&r[e]===t&&(i=r)}),i},VB.DeviceManager.prototype.createLayer=function(e){var t=this.getLayerByProperty("name",e);return null==t&&((t=new VB.Layer).name=e,this.deviceScene.add(t)),t},VB.DeviceManager.prototype.removeLayerByProperty=function(e,t){var i=this.getLayerByProperty(e,t);null!=i&&this.removeLayer(i)},VB.DeviceManager.prototype.removeLayer=function(e){e.traverse(function(e){VB.Device}),e.parent&&e.parent.remove(e)},VB.DeviceManager.prototype.getDeviceByProperty=function(e,t){var i;return this.deviceScene.traverse(function(r){r instanceof VB.Device&&null!=r[e]&&r[e]===t&&(i=r)}),i},VB.DeviceManager.prototype.getDeviceByUserData=function(e,t){var i;return this.deviceScene.traverse(function(r){"DEVICE"===r.type&&null!=r.userData[e]&&r.userData[e]===t&&(i=r)}),i},VB.DeviceManager.prototype.addDevice=function(e){var t=e.layerName,i=this.createLayer(t),r=new VB.Device;return r.create(e),i.add(r),r},VB.DeviceManager.prototype.update=function(){if(!1!==this.visible){var e=this.renderer.autoClear;this.renderer.autoClear=!1,this.renderer.clearDepth(),this.mainCamera.updateProjectionMatrix(),this.mainCamera.updateMatrixWorld();var t=new THREE.Frustum;(new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse),t.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse));var i=this,r=new Array,n=new Array;if(this.tooltip_device){var o=this.getIntersectObject(),a=!1;for(u=0;u<o.length;u++)if(o[u].object.parent instanceof VB.Device&&!o[u].object.parent.tooltip){this.tooltip_device.tooltip_text=o[u].object.parent.tooltip_text,a=!0;break}if(o.length>0&&a){var s=new Array,c={text:this.tooltip_device.tooltip_text,size:12};s.push(c),this.tooltip_device.text.setText(s),console.log(this.tooltip_device.tooltip_text)}else this.tooltip_device.text.clearRect()}var l,h=this.tooltip_device;if(this.deviceScene.traverse(function(e){if(e instanceof VB.Device&&e.parent.visible&&e!=h){var o=e.pos3D.clone();o.project(i.mainCamera);var a=e.pos3D.clone();a.project(i.mainCamera),e&&(o.x=Math.round((o.x+1)*i.renderer.domElement.clientWidth/2),o.y=Math.round((1-o.y)*i.renderer.domElement.clientHeight/2),o.z=0,a.x=Math.round((a.x+1)*i.renderer.domElement.clientWidth/2),a.y=Math.round((1-a.y)*i.renderer.domElement.clientHeight/2),a.z=0),e.icon.position.set(o.x,o.y-e.icon.scale.y/2,e.zindex),e.text.sprite.position.copy(e.icon.position),e.text.sprite.position.y-=e.icon.scale.y/1.2,e.text.sprite.position.z+=1,e.line.position.copy(o),e.line.scale.y=(new THREE.Vector3).subVectors(o,a).length();var s=new THREE.Vector3(0,1,0).angleTo((new THREE.Vector3).subVectors(a,o).normalize());if(e.line.rotation.x=0,e.line.rotation.y=0,e.line.rotation.z=0,o.x<a.x&&(s=-s),e.line.rotateOnAxis(new THREE.Vector3(0,0,1),s),e.point.position.copy(a),e.point.scale.set(3,3,3),e.circle&&(e.circle.position.copy(a),e.circle.scale.set(3,3,3)),e.mixer){var c=e.clock.getDelta();e.mixer.update(c)}if(!0===i.onLOD)if(t.containsPoint(e.pos3D)){var l=e.pos3D.distanceTo(i.mainCamera.position),u=e.getLODByDistance(l);if(u){e.applyLOD(u),e.text.sprite.position.y=e.icon.position.y,e.text.sprite.position.y-=e.icon.scale.y/1.2;var d=new THREE.Vector3;d.subVectors(i.mainCamera.position,e.pos3D),d.normalize()}else e.lod.length>0&&(r.push(e),n.push(e.visible),e.visible=!1)}else i.moving!==e&&(r.push(e),n.push(e.visible),e.visible=!1)}}),this.tooltip_device)(l=i.onMovePosition.clone()).x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),l.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),l.z=10,this.tooltip_device.text.sprite.position.set(l.x,l.y,l.z);if(this.moving)(l=this.moving.pos3D.clone()).project(i.mainCamera),l.x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),l.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),l.z=0,this.moving.icon.position.set(l.x,l.y-this.moving.height/2,this.moving.zindex),this.moving.text.sprite.position.copy(this.moving.icon.position),this.moving.text.sprite.position.y-=this.moving.height/1.2,this.moving.text.sprite.position.z+=1;this.renderer.render(this.deviceScene,this.orthoCamera);for(var u=0;u<r.length;++u)r[u].visible=n[u];this.renderer.autoClear=e,this.composer&&this.composer.render()}},VB.DeviceManager.prototype.update2=function(){if(!1!==this.visible){var e=this.renderer.autoClear;this.renderer.autoClear=!1,this.renderer.clearDepth(),this.mainCamera.updateMatrix(),this.mainCamera.updateMatrixWorld();var t=new THREE.Frustum;(new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse),t.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse));var i=this,r=new Array,n=new Array;if(this.deviceScene.traverse(function(e){if(e instanceof VB.Device){var o=e.pos3D.clone();o.project(i.mainCamera),e&&(o.x=Math.round((o.x+1)*i.renderer.domElement.clientWidth/2),o.y=Math.round((1-o.y)*i.renderer.domElement.clientHeight/2),o.z=0),e.icon.position.set(o.x,o.y-e.height/2,0),e.text.sprite.position.copy(e.icon.position),e.text.sprite.position.y-=e.height/1.2,e.text.sprite.position.z+=1,t.containsPoint(e.pos3D)||i.moving!==e&&(r.push(e),n.push(e.visible),e.visible=!1)}}),this.moving){var o=this.moving.pos3D.clone();o.project(i.mainCamera),o.x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),o.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),o.z=0,this.moving.icon.position.set(o.x,o.y-this.moving.height/2,0),this.moving.text.sprite.position.copy(this.moving.icon.position),this.moving.text.sprite.position.y-=this.moving.height/1.2,this.moving.text.sprite.position.z+=1}this.renderer.render(this.deviceScene,this.orthoCamera);for(var a=0;a<r.length;++a)r[a].visible=n[a];this.renderer.autoClear=e}},VB.DeviceManager.prototype.onClick=function(e){console.log("VB.DeviceManager.prototype.onClick")},VB.DeviceManager.prototype.onDblClick=function(e){console.log("VB.DeviceManager.prototype.onDblClick")},VB.DeviceManager.prototype.show=function(e){this.visible=e},VB.DeviceManager.prototype.showLayer=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],n=this.getLayerByProperty("name",r);n&&(n.visible=t)}},VB.DeviceManager.prototype.onResize=function(){this.orthoCamera.right=this.renderer.domElement.clientWidth,this.orthoCamera.bottom=this.renderer.domElement.clientHeight,this.orthoCamera.updateProjectionMatrix()},VB.DeviceManager.prototype.getBoundingBox=function(e,t){if(e){var i=new THREE.Vector3,r=new THREE.Vector3,n=new THREE.Vector3(500,500,500);return t&&n.copy(t),i.copy(e.pos3D),r.copy(e.pos3D),i.sub(n),r.add(n),console.log(i),console.log(r),new THREE.Box3(i,r)}},VB.DeviceManager.prototype.getBoundingBoxByUserId=function(e,t){var i=this.getDeviceByUserData("id",e);if(i)return getBoundingBox(i)},VB.DeviceManager.prototype.moveObject=function(e,t,i){if(void 0===t&&(t=this.deviceScene),t.add(e),void 0!==i){var r=t.children.indexOf(i);t.children.splice(r,0,e),t.children.pop()}},VB.DeviceManager.prototype.removeDeviceByLayerName=function(e){var t=this.getLayerByProperty("name",e);if(t){for(var i=[],r=0;r<t.children.length;++r){var n=t.children[r];n instanceof VB.Device&&i.push(n)}for(r=0;r<i.length;++r)t.remove(i[r])}},VB.DeviceManager.prototype.removeDeviceByProperty=function(e,t){var i=this.getDeviceByProperty(e,t);i&&i.dispose()},VB.DeviceManager.prototype.getParentByProperty=function(e,t,i,r){var n,o=function(e,t){e&&(t(e),r&&o(e.parent,t))};return o(e.parent,function(e){e&&null!=e[t]&&e[t]===i&&(n=e)}),n},VB.DeviceManager.prototype.setMovingDevice=function(e){this.moving&&(this.moving.dispose(),this.moving=void 0),e&&(this.moving=this.addDevice({width:e.width,height:e.height,material:e.srcMaterial.icon,name:e.name,id:e.userData.id,position:{x:e.pos3D.x,y:e.pos3D.y,z:e.pos3D.z},layerName:"moving",zindex:2}))},VB.DeviceManager.prototype.setPoiData=function(e){this.deviceScene.traverse(function(t){t instanceof VB.Device&&t.parent.visible&&e(device.pos3D)})},VB.DeviceManager.prototype.load=function(e,t,i,r,n){var o=this;if(document.implementation&&document.implementation.createDocument){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState&&(0===a.status||200===a.status))if(a.responseXML)o.parse(e,t,a.responseXML,i,r);else if(a.responseText){var s=(new DOMParser).parseFromString(a.responseText,"application/xml");o.parse(e,s,i,r)}else n?n():console.error("POIXMLLoader : Empty or non-existing file ("+e+")")},a.open("GET",e,!0),a.send(null)}else alert("Don't know to parse XML")},VB.DeviceManager.prototype.parse=function(e,t,i,r,n){var o=i.evaluate?i:document,a=VB.TextureUtils.load(t),s=new THREE.SpriteMaterial({map:a,color:16777215,fog:!0}),c=o.evaluate("devices/floors/floor/entities/entity",i,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),l=c.iterateNext();for(0;l;){var h={layerName:"devices",id:99999,name:"",position:{x:0,y:0,z:1},width:0,height:0,icon:"",groupId:0,zindex:2,elevation:0,animation:!1,width:25,height:25,material:s};h.id=l.getAttribute("id"),h.name=l.getAttribute("id");var u=o.evaluate("center",l,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(u){var d=u.textContent.split(" ");h.position.x=d[0],h.position.y=d[1],h.position.z=d[2]}var p=this.addDevice(h);r&&r(p,h),l=c.iterateNext()}},Text2D=function(e,t,i){this.width=256,this.height=64;var r=this.width,n=this.height;this.params=t,this.canvas=document.createElement("canvas"),this.canvas.width=r,this.canvas.height=n,this.context=this.canvas.getContext("2d");var o=.5*r,a=.5*n;if(t instanceof Array){for(var s=0,c=0;c<t.length;++c){if(void 0!==(u=t[c]).text){void 0===u.font&&(u.font=" "),void 0===u.size&&(u.size=12),void 0===u.margin&&(u.margin=c+1===t.length?0:5),void 0===u.color&&(u.color="#FFFFFF");var l=96*u.size/72;u.height=l,s+=l+u.margin}}var h=a-.5*s;this.context.textAlign="center",this.context.textBaseline="top";for(c=0;c<t.length;++c){var u;void 0!==(u=t[c]).text&&(this.context.save(),this.context.font=u.size+"pt "+u.font,this.context.shadowBlur=4,this.context.shadowColor="black",this.context.strokeStyle="black",this.context.lineWidth=3,this.context.strokeText(u.text,o,h),this.context.shadowBlur=0,this.context.fillStyle=u.color,this.context.fillText(u.text,o,h),h+=u.height+u.margin,this.context.restore())}}this.texture=new THREE.Texture(this.canvas),this.texture.generateMipMaps=!1,this.texture.needsUpdate=!0,this.material=new THREE.SpriteMaterial({map:this.texture,depthTest:!1}),this.sprite=new THREE.Sprite(this.material),this.sprite.scale.set(r,n),this.sprite.position.set(i.x,i.y,i.z),e&&e.add(this.sprite)},Text2D.prototype.clearRect=function(){this.context.clearRect(0,0,this.width,this.height),this.texture.needsUpdate=!0},Text2D.prototype.setText=function(e){this.clearRect(),this.params=e;var t=.5*this.width,i=.5*this.height;if(e instanceof Array){for(var r=0,n=0;n<e.length;++n){if(void 0!==(s=e[n]).text){void 0===s.font&&(s.font=" "),void 0===s.size&&(s.size=12),void 0===s.margin&&(s.margin=n+1===e.length?0:5),void 0===s.color&&(s.color="#FFFFFF");var o=96*s.size/72;s.height=o,r+=o+s.margin}}var a=i-.5*r;this.context.textAlign="center",this.context.textBaseline="top";for(n=0;n<e.length;++n){var s;void 0!==(s=e[n]).text&&(this.context.save(),this.context.font=s.size+"pt "+s.font,this.context.shadowBlur=4,this.context.shadowColor="black",this.context.strokeStyle="black",this.context.lineWidth=3,this.context.strokeText(s.text,t,a),this.context.shadowBlur=0,this.context.fillStyle=s.color,this.context.fillText(s.text,t,a),a+=s.height+s.margin,this.context.restore())}}},Text2D.prototype.dispose=function(){this.texture.dispose(),this.material.dispose(),this.sprite.geometry.dispose()},Text2DManager=function(e){this.textObjects=new Array,this.scene=e},Text2DManager.prototype.add=function(e,t){var i=new Text2D(this.scene,e,t);return this.textObjects.push(i),i},Text2DManager.prototype.remove=function(e){this.scene.remove(e.sprite);var t=this.textObjects.indexOf(e);-1!==t&&this.textObjects.splice(t,1)},Text2DManager.prototype.clear=function(){for(;this.textObjects.length>0;){var e=this.textObjects[0];this.remove(e)}},Text2DManager.prototype.update=function(e){for(var t=0;t<this.textObjects.length;++t){var i=this.textObjects[t],r=i.sprite.position.clone();r.sub(e.position);var n=r.length()/875;i.sprite.scale.set(i.width*n,i.height*n)}},onmessage=function(e){var t=[];var i=e.data.progress,r=e.data.sbmInfo,n=e.data.data,o=new DataView(n),a=!0,s=0,c=function(e,t,i){return String.fromCharCode.apply(null,new Uint8Array(e,t,i))}(n,s,8);if(s+=8,"SBK-----"!==c)throw"This SBM file is not supported by the SDK.";for(var l=[],h=0;h<32;h++){var u=o.getUint8(s,a);s+=1,l[h]=u}var d=o.getUint16(s);if(s+=2,d>3)throw"This is an unsupported version of SBK.";var p=[];for(h=0;h<32;h++){u=o.getUint8(s,a);s+=1,p[h]=u}var f=[];for(h=0;h<64;h++){u=o.getUint8(s,a);s+=1,f[h]=u}var m=[];m=(m=(m=m.concat(p)).concat(f)).concat(l);var g=0;for(h=0;h<128;h++)if(h<=7||h>23&&h<=31||h>39&&h<=55||h>63&&h<=87||h>95&&h<=103){if(g>=64)throw"This is a wrong SBK file.";t[g]=m[h],g++}n=new Uint8Array(function(e,i){for(var r=e.byteLength-i,n=[],o=0,s=0;s<r;s++){var c=e.getUint8(i,a);i+=1;var l=t[o++];o>=64&&(o=0);var h=c^l;n[s]=h}return n}(o,s)).buffer;var v=new DataView(n);s=0;var y=v.getUint16(s,a);s+=2;var E=v.getUint16(s,a);for(s+=2,i.totalModels=E,i.totalMaterials=y,h=0;h<y;++h){var x=v.getUint16(s,a);s+=2;var b=v.getFloat32(s,a);s+=4;var w=v.getFloat32(s,a);s+=4;var T=v.getFloat32(s,a);s+=4;v.getFloat32(s,a);s+=4;var M=v.getFloat32(s,a);s+=4;var S=v.getFloat32(s,a);s+=4;var R=v.getFloat32(s,a);s+=4;var A=v.getFloat32(s,a);s+=4;v.getFloat32(s,a);s+=4;v.getFloat32(s,a);s+=4;v.getFloat32(s,a);s+=4;v.getFloat32(s,a);s+=4;var _=v.getUint8(s,a);s+=1;var D=_,C=v.getUint16(s,a);s+=2;var L="",P="";if(C>0){var H=n.slice(s,s+C),B="",I=new Uint8Array(H,0,C);for(g=0;g<C;++g)I[g]>127?B=B+"%"+I[g].toString(16).toUpperCase():(B.length&&(P+=decodeURIforEUCKR(B)),P+=String.fromCharCode(I[g]),B="");if(s+=C,P=P.replace("\\","/"),r.textureUrl){if(r.textureUrl.toString().length){var O,U=P;-1!==(O=U.lastIndexOf("/"))&&(U=U.substr(O+1,U.length-O+1)),L=r.textureUrl+U}}else L=-1!==(O=(L=r.fileUrl).lastIndexOf("/"))?L.substr(0,O+1)+P:P}postMessage({msg:"material",texture:{textureUrl:L,textureName:P},material:{id:x.toString(),d:[M,S,R],a:[b,w,T],opacity:A,side:D}}),i.loadedMaterials++,postMessage({msg:"progress",val:i})}for(h=0;h<E;++h){x=String(v.getUint16(s,a));s+=2;var N=v.getUint16(s,a);s+=2;var V=[],F=v.getUint16(s,a);if(s+=2,F>0)for(var z=0;z<F;++z){var j=v.getFloat32(s,a);s+=4;var k=v.getFloat32(s,a);s+=4;var G=v.getFloat32(s,a);s+=4,V.push([j,k,G])}var W=[],X=v.getUint16(s,a);if(s+=2,X>0)for(var Y=0;Y<X;++Y){j=v.getFloat32(s,a);s+=4;k=v.getFloat32(s,a);s+=4;G=v.getFloat32(s,a);s+=4,W.push([j,k,G])}var q=v.getUint16(s,a);s+=2;var Z=[];if(q>0)for(var J=0;J<q;++J){j=v.getFloat32(s,a);s+=4;k=v.getFloat32(s,a);s+=4,Z.push([j,k])}var Q=[],K=v.getUint16(s,a);if(s+=2,K>0)for(var $=0;$<K;++$){var ee=v.getUint16(s,a);s+=2;var te=v.getUint16(s,a);s+=2;var ie=v.getUint16(s,a);s+=2,Q.push([ee,te,ie])}postMessage({msg:"mesh",id:x,mat_id:N,geom:{vertices:V,normals:W,texcoords:Z,indices:Q}}),i.loadedModels++,postMessage({msg:"progress",val:i})}postMessage({msg:"finish"})},VB.SBMLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.materials={},this.textures={},this.worker},VB.SBMLoader.prototype={constructor:VB.SBMLoader,load:function(e,t,i,r,n){var o=this,a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.crossOrigin=this.crossOrgin,a.onreadystatechange=function(){if(4===this.readyState&&(200===this.status||304===this.status))if(null==o.worker){var e=o.parse(this.response,t,r);i&&i(e,t)}else o.parseWorker(this.response,t,r,i)},a.send(null)},parse:function(e,t,i){var r={totalModels:0,totalMaterials:0,loadedModels:0,loadedMaterials:0,totalSBMs:t.totalSBMs,currentSBMs:t.currentSBMs};console.time("SBMParse");var n=new THREE.Object3D;n.userData.filesource=t.fileUrl,n.userData.id=t.id,n.userData.materials=[],n.userData.textures=[],null!=t.baseFloor&&(n.userData.baseFloor=t.baseFloor),n.name=t.name;var o=[];var a=new DataView(e),s=!0,c=0,l=getAsciiString(e,c,8);if(c+=8,"SBK-----"!==l)throw"This SBM file is not supported by the SDK.";for(var h=[],u=0;u<32;u++){var d=a.getUint8(c,s);c+=1,h[u]=d}var p=a.getUint16(c);if(c+=2,p>3)throw"This is an unsupported version of SBK.";var f=[];for(u=0;u<32;u++){d=a.getUint8(c,s);c+=1,f[u]=d}var m=[];for(u=0;u<64;u++){d=a.getUint8(c,s);c+=1,m[u]=d}var g=[];g=(g=(g=g.concat(f)).concat(m)).concat(h);var v=0;for(u=0;u<128;u++)if(u<=7||u>23&&u<=31||u>39&&u<=55||u>63&&u<=87||u>95&&u<=103){if(v>=64)throw"This is a wrong SBK file.";o[v]=g[u],v++}e=new Uint8Array(function(e,t){for(var i=e.byteLength-t,r=[],n=0,a=0;a<i;a++){var c=e.getUint8(t,s);t+=1;var l=o[n++];n>=64&&(n=0);var h=c^l;r[a]=h}return r}(a,c)).buffer;var y=new DataView(e);c=0;var E=y.getUint16(c,s);c+=2;var x=y.getUint16(c,s);c+=2,r.totalModels=x,r.totalMaterials=E;for(u=0;u<E;++u){var b=y.getUint16(c,s);c+=2;y.getFloat32(c,s);c+=4;y.getFloat32(c,s);c+=4;y.getFloat32(c,s);c+=4;y.getFloat32(c,s);c+=4;var w=y.getFloat32(c,s);c+=4;var T=y.getFloat32(c,s);c+=4;var M=y.getFloat32(c,s);c+=4;var S=y.getFloat32(c,s);c+=4;y.getFloat32(c,s);c+=4;y.getFloat32(c,s);c+=4;y.getFloat32(c,s);c+=4;y.getFloat32(c,s);c+=4;var R=y.getUint8(c,s);c+=1;var A=0;0===R?A=THREE.FrontSide:1===R?A=THREE.BackSide:2===R&&(A=THREE.DoubleSide);var _=y.getUint16(c,s);c+=2;var D=null;if(_>0){var C=e.slice(c,c+_),L="",P="",H=new Uint8Array(C,0,_);for(v=0;v<_;++v)H[v]>127?P=P+"%"+H[v].toString(16).toUpperCase():(P.length&&(L+=decodeURIforEUCKR(P)),L+=String.fromCharCode(H[v]),P="");c+=_,L=L.replace("\\","/");var B=null;if(t.textureUrl){if(t.textureUrl.toString().length){var I,O=L;-1!==(I=O.lastIndexOf("/"))&&(O=O.substr(I+1,O.length-I+1)),B=t.textureUrl+O}}else B=-1!==(I=(B=t.fileUrl).lastIndexOf("/"))?B.substr(0,I+1)+L:L;this.textures[B]?D=this.textures[B]:((D=VB.TextureUtils.load(B)).name=L,this.textures[B]=D,n.userData.textures.push(B)),D.wrapS=THREE.RepeatWrapping,D.wrapT=THREE.RepeatWrapping,D.flipY=!1,t.anisotropy&&(D.anisotropy=t.anisotropy)}var U=this.materials[b.toString()];null==U&&((U=new THREE.MeshPhongMaterial({color:new THREE.Color(w,T,M),opacity:S,transparent:!0,map:D,side:A,alphaTest:.5,shininess:50,specular:328965,needsUpdate:!0})).name=b.toString(),this.materials[b.toString()]=U,n.userData.materials.push(U.uuid)),r.loadedMaterials++,i&&i(r)}for(u=0;u<x;++u){b=String(y.getUint16(c,s));if(c+=2,3===p){var N=y.getUint16(c,s);c+=2;D=null;if(N>0){for(C=e.slice(c,c+N),P="",H=new Uint8Array(C,0,N),v=0;v<N;++v)H[v]>127?P=P+"%"+H[v].toString(16).toUpperCase():(P.length&&decodeURIforEUCKR(P),String.fromCharCode(H[v]),P="");c+=N}}var V=y.getUint16(c,s);c+=2;var F=new THREE.Geometry,z=0;if(p>=3?(z=y.getUint32(c,s),c+=4):(z=y.getUint16(c,s),c+=2),z>0)for(var j=0;j<z;++j){var k=new THREE.Vector3;k.x=y.getFloat32(c,s),c+=4,k.y=y.getFloat32(c,s),c+=4,k.z=y.getFloat32(c,s),c+=4,k.multiplyScalar(t.scale),F.vertices.push(k)}var G=0;if(p>=3?(G=y.getUint32(c,s),c+=4):(G=y.getUint16(c,s),c+=2),G>0)for(var W=0;W<G;++W){var X=new THREE.Vector3;X.x=y.getFloat32(c,s),c+=4,X.y=y.getFloat32(c,s),c+=4,X.z=y.getFloat32(c,s),c+=4}var Y=0;p>=3?(Y=y.getUint32(c,s),c+=4):(Y=y.getUint16(c,s),c+=2);var q=new Array(Y);if(Y>0)for(var Z=0;Z<Y;++Z){var J=new THREE.Vector2;J.x=y.getFloat32(c,s),c+=4,J.y=y.getFloat32(c,s),c+=4,q[Z]=J}var Q=0;if(p>=3?(Q=y.getUint32(c,s),c+=4):(Q=y.getUint16(c,s),c+=2),Q>0)for(var K=0;K<Q;++K){var $=new THREE.Face3;$.a=y.getUint16(c,s),c+=2,$.b=y.getUint16(c,s),c+=2,$.c=y.getUint16(c,s),c+=2,F.faces.push($),q.length>0&&F.faceVertexUvs[0].push([q[$.a],q[$.b],q[$.c]])}F.computeBoundingSphere(),F.computeBoundingBox(),F.computeVertexNormals(!0),F.computeFaceNormals();var ee=F;if(t.useBufferGeometry&&((ee=new THREE.BufferGeometry).fromGeometry(F),ee.boundingBox=F.boundingBox.clone()),this.materials[V.toString()]){var te=new THREE.Mesh(ee,this.materials[V.toString()]);te.userData.id=b,te.name=b,te.castShadow=!0,te.receiveShadow=!0,n.add(te)}r.loadedModels++,i&&i(r)}return console.timeEnd("SBMParse"),n},parseWorker:function(e,t,i,r){var n=this,o={totalModels:0,totalMaterials:0,loadedModels:0,loadedMaterials:0,totalSBMs:t.totalSBMs,currentSBMs:t.currentSBMs},a=new THREE.Object3D;a.userData.filesource=t.fileUrl,a.userData.id=t.id,a.userData.materials=[],a.userData.textures=[],null!=t.baseFloor&&(a.userData.baseFloor=t.baseFloor),a.name=t.name;var s=new Worker(this.worker);s.onmessage=function(e){if("progress"===e.data.msg)i&&i(e.data.val);else if("finish"===e.data.msg)r&&r(a,t),s.terminate();else if("debug"===e.data.msg)console.log("debug");else if("material"===e.data.msg){var o=n.getTexture(e.data.texture.textureUrl,e.data.texture.textureName,t.anisotropy,a),c=n.materials[e.data.material.id];null==c&&(c=n.createMaterial(e.data.material,o,a))}else if("mesh"===e.data.msg){for(var l=new THREE.Geometry,h=e.data.geom.vertices,u=0;u<h.length;++u){var d=new THREE.Vector3(h[u][0],h[u][1],h[u][2]);d.multiplyScalar(t.scale),l.vertices.push(d)}var p=e.data.geom.texcoords,f=e.data.geom.indices;for(u=0;u<f.length;++u){var m=new THREE.Face3;m.a=f[u][0],m.b=f[u][1],m.c=f[u][2],l.faces.push(m),p.length>0&&l.faceVertexUvs[0].push([new THREE.Vector2(p[m.a][0],p[m.a][1]),new THREE.Vector2(p[m.b][0],p[m.b][1]),new THREE.Vector2(p[m.c][0],p[m.c][1])])}l.computeBoundingSphere(),l.computeBoundingBox(),l.computeVertexNormals(!0),l.computeFaceNormals();var g=l;t.useBufferGeometry&&((g=new THREE.BufferGeometry).fromGeometry(l),g.boundingBox=l.boundingBox.clone());var v=e.data.mat_id,y=e.data.id;if(n.materials[v.toString()]){var E=new THREE.Mesh(g,n.materials[v.toString()]);E.userData.id=y,E.name=y,E.castShadow=!0,E.receiveShadow=!0,a.add(E)}}};var c={progress:o,sbmInfo:t,data:e};s.postMessage(c)},getTexture:function(e,t,i,r){var n;return null!=e&&null==(n=this.textures[e])&&((n=VB.TextureUtils.load(e)).name=t,this.textures[e]=n,r.userData.textures.push(e),n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,n.flipY=!1,i&&(n.anisotropy=i)),n},createMaterial:function(e,t,i){var r=THREE.FrontSide;if(1===e.side?r=THREE.BackSide:2===e.side&&(r=THREE.DoubleSide),t.sourceFile)var n=new THREE.MeshPhongMaterial({color:new THREE.Color(e.d[0],e.d[1],e.d[2]),opacity:e.opacity,transparent:!0,map:t,side:r,alphaTest:.5,shininess:50,specular:328965,needsUpdate:!0});else n=new THREE.MeshPhongMaterial({color:new THREE.Color(e.d[0],e.d[1],e.d[2]),opacity:e.opacity,transparent:!0,side:r,alphaTest:.5,shininess:50,specular:328965,needsUpdate:!0});return n.name=e.id.toString(),this.materials[n.name]=n,i.userData.materials.push(n.uuid),n}},VB.TopologyManager=function(e,t,i){this.dijkstras=new Dijkstras,this.cameraObject,this.camera,this.cameraHelper,this.path,this.DriveMode=VB.TopologyManager.CameraMove,this.DrivePoi,this.mapPostRender=i,this.restrict_bit=0,this.mainRender,this.pauseState=!1;var r,n,o=this;o.camera=new THREE.PerspectiveCamera(84,t.domElement.clientWidth/t.domElement.clientHeight,10,1e4),o.cameraObject=new THREE.Object3D,o.cameraObject.add(o.camera),o.cameraHelper=new THREE.CameraHelper(o.camera),o.cameraHelper.visible=!1,r=new THREE.Vector3,n=new THREE.Vector3;var a,s=0,c=new THREE.Vector3,l=new THREE.Vector3,h=!1,u=0;this.cameraElevation=150,this.speed=120,this.render=function(){e.scene.updateMatrixWorld(),t.clear(),!1===t.autoClear&&t.clearDepth();var i=o.cameraElevation,a=1/(o.path.parameters.path.getLength()/(o.speed/32))*s;if(a<1){!1===o.pauseState&&s++;var d=o.path.parameters.path.getPointAt(a),p=o.path.tangents.length,f=a*p,m=Math.floor(f),g=(m+1)%p;r.subVectors(o.path.binormals[g],o.path.binormals[m]),r.multiplyScalar(f-m).add(o.path.binormals[m]);var v=o.path.parameters.path.getTangentAt(a);n.set(0,1,0),d.add(n.clone().multiplyScalar(i)),o.camera.position.copy(d);var y=a+o.speed/o.path.parameters.path.getLength();y>1?y=1:y%=1;var E=o.path.parameters.path.getPointAt(y);E.add(v.multiplyScalar(0)),E.add(n.clone().multiplyScalar(140));var x=1-Math.abs(o.path.parameters.path.getTangentAt(y).y)<1e-5||1-Math.abs(o.path.parameters.path.getTangentAt(a).y)<1e-5;if(x||1===y){if(E.copy(l).add((new THREE.Vector3).subVectors(d,c)),x)if(!1===h&&0===u)h=!0;else if(h){var b=new THREE.Vector3;b.copy(d),b.y=E.y,E.subVectors(E,b),E.applyAxisAngle(new THREE.Vector3(0,1,0),5*Math.PI/180),E.addVectors(E,b),u+=5*Math.PI/180,Math.abs(u-Math.PI)<1e-5&&(h=!1)}}else h=!1,u=0;if(l.copy(E),c.copy(d),this.DriveMode==VB.TopologyManager.DriveMode.CameraMove)o.camera.matrix.lookAt(o.camera.position,E,n),o.camera.rotation.setFromRotationMatrix(o.camera.matrix,o.camera.rotation.order),o.cameraHelper.update();else{var w=new THREE.Vector3;w.x=d.x-this.DrivePoi.pos3D.x,w.y=d.y-this.DrivePoi.pos3D.y,w.z=d.z-this.DrivePoi.pos3D.z,this.DrivePoi.pos3D.set(d.x,d.y,d.z),e.camera.position.x+=w.x,e.camera.position.y+=w.y,e.camera.position.z+=w.z}}if(this.DriveMode==VB.TopologyManager.DriveMode.CameraMove)t.render(e.scene,o.camera);else for(var T in t.render(e.scene,e.camera),o.mapPostRender.map)o.mapPostRender.map[T]()},VB.TopologyManager.prototype.setCameraPos=function(e,t){const i=t.fov*Math.PI/180,r=e/Math.tan(i/2),n=Math.sqrt(Math.pow(r,2)+Math.pow(r,2));t.position.set(n,n,n)},VB.TopologyManager.prototype.start=function(){if(null!=this.path){0===s&&(e.scene.add(this.cameraObject),e.scene.add(this.cameraHelper));var t=this;a=requestAnimationFrame(function(){t.start()}),this.render()}},VB.TopologyManager.prototype.stop=function(){-1!==a&&window.cancelAnimationFrame(a),a=-1,s=0,e.scene.remove(o.cameraHelper)},VB.TopologyManager.prototype.pause=function(){this.pauseState=!this.pauseState},VB.TopologyManager.prototype.onResize=function(){this.camera.aspect=t.domElement.clientWidth/t.domElement.clientHeight,this.camera.updateProjectionMatrix()},VB.TopologyManager.prototype.getPath=function(e,t,i){var r=this.dijkstras.getPath(t,i),n=new THREE.CurvePath,o=e.getObjectByProperty("gmlid",t),a=e.getObjectByProperty("gmlid",r[0]);n.add(new THREE.LineCurve3(o.getWorldPosition(),a.getWorldPosition()));for(var s=0;s<r.length-1;++s){var c=r[s],l=r[s+1],h=e.getObjectByProperty("gmlid",c),u=e.getObjectByProperty("gmlid",l);h&&u&&n.add(new THREE.LineCurve3(h.getWorldPosition(),u.getWorldPosition()))}var d=new THREE.TubeGeometry(n,265,5,8,!1),p=new THREE.MeshBasicMaterial({color:65331,wireframe:!1,transparent:!0,opacity:1});return new THREE.Mesh(d,p)},VB.TopologyManager.prototype.getPaths=function(e,t){if(!(t.length<2)){for(var i=new THREE.CurvePath,r=0;r<t.length-1;++r){var n=this.dijkstras.getPath(t[r],t[r+1]);if(n.length){var o=e.getObjectByProperty("gmlid",t[r]),a=e.getObjectByProperty("gmlid",n[0]);i.add(new THREE.LineCurve3(o.getWorldPosition(),a.getWorldPosition()));for(var s=0;s<n.length-1;++s){var c=n[s],l=n[s+1],h=e.getObjectByProperty("gmlid",c),u=e.getObjectByProperty("gmlid",l);h&&u&&i.add(new THREE.LineCurve3(h.getWorldPosition(),u.getWorldPosition()))}}}if(i.curves.length){var d=new THREE.TubeGeometry(i,32,10,16,!1);new THREE.SubdivisionModifier(.1).modify(d);var p=new THREE.MeshBasicMaterial({color:65331,wireframe:!1,transparent:!1,opacity:1});return new THREE.Mesh(d,p)}}}},VB.TopologyManager.prototype.updateLink=function(e,t){e.traverse(function(e){e instanceof VB.Node&&e.updateLink(t)})},VB.TopologyManager.prototype.clear=function(){this.path=void 0},VB.TopologyManager.prototype.setLink=function(e,t,i,r,n){var o=e.getObjectByProperty("gmlid",t),a=e.getObjectByProperty("gmlid",i);if(void 0!==o&&void 0!==a&&3!==n){if(void 0===n||0===n||1===n)o.addLink(a).restrict=r;if(void 0===n||0===n||2===n)a.addLink(o).restrict=r}},VB.TopologyManager.prototype.makeGraph=function(e){var t=[];e.traverse(function(e){if(e instanceof VB.Node){var i=e.makeGraph();t.push(i)}}),this.dijkstras.setGraph(t)},VB.TopologyManager.prototype.showPath=function(e){},VB.TopologyManager.prototype.addImmediateNode=function(e){},VB.TopologyManager.prototype.makeLink=function(e,t){var i=e.getObjectByProperty("gmlid",t.source),r=e.getObjectByProperty("gmlid",t.target),n=i.position,o=r.position,a=n.distanceTo(o),s=new THREE.Vector3;s.subVectors(o,n),s.normalize();var c=t.material,l=new VB.Link(VB.LinkGeometry,c);l.gmlid=t.gmlid,l.userData.id=t.gmlid,l.name=t.name,l.userData.thickness=t.thickness,l.userData.restrict=t.restrict;var h=new THREE.Vector3(1,0,0),u=(new THREE.Quaternion).setFromUnitVectors(h,s),d=(new THREE.Matrix4).makeRotationFromQuaternion(u);return l.applyMatrix(d),l.scale.x=a,l.scale.z=t.radius,l.scale.y=t.radius,l.position.copy(n),l},VB.TopologyManager.DriveMode={CameraMove:0,"PoiMove : ":1},function(){var e=new THREE.CylinderGeometry(1,1,1,8);e.applyMatrix((new THREE.Matrix4).makeRotationZ(torad(-90))),e.applyMatrix((new THREE.Matrix4).makeTranslation(.5,0,0)),e.computeBoundingBox(),VB.LinkGeometry=new THREE.BufferGeometry,VB.LinkGeometry.fromGeometry(e),VB.LinkGeometry.boundingBox=e.boundingBox.clone(),VB.LinkMaterial={available:new THREE.MeshBasicMaterial({color:65280,wireframe:!1}),impossibility:new THREE.MeshBasicMaterial({color:16711680,wireframe:!1})}}(),VB.Link=function(e,t){THREE.Mesh.call(this,e,t),this.gmlid},VB.Link.prototype=Object.create(THREE.Mesh.prototype),VB.Link.prototype.constructor=VB.Link,function(){var e=new THREE.SphereGeometry(10,32,32);e.computeBoundingBox(),VB.NodeGeometry=new THREE.BufferGeometry,VB.NodeGeometry.fromGeometry(e),VB.NodeGeometry.boundingBox=e.boundingBox.clone(),VB.NodeMaterial=new THREE.MeshBasicMaterial({color:255,wireframe:!1})}(),VB.Node=function(e,t){THREE.Mesh.call(this,e,t),this.gmlid,this.floorId,this.links=new Map,VB.Node.prototype.addLink=function(e){if(!this.links.containsKey(e.gmlid)){var t=this.position.distanceTo(e.position),i=new VB.Node.Link(e.gmlid,t);return this.links.put(e.gmlid,i),i}},VB.Node.prototype.updateLink=function(e){for(var t in this.links.map){var i=this.links.map[t];i.enable=(e&i.restrict)===i.restrict,(0===e&&1!==i.restrict||1!==e&&0===i.restrict)&&(i.enable=!0)}},VB.Node.prototype.makeGraph=function(){var e=[];e.push(this.gmlid);var t=[];for(var i in this.links.map){var r=this.links.map[i];r.enable&&t.push(r.makeGraph())}return e.push(t),e}},VB.Node.prototype=Object.create(THREE.Mesh.prototype),VB.Node.prototype.constructor=VB.Node,VB.Node.Link=function(e,t){this.targetNodeId=e,this.weight=t,this.enable=!0,this.restrict=0},VB.Node.Link.prototype.makeGraph=function(){var e=[];return e.push(this.targetNodeId),e.push(this.weight),e};var Dijkstras=function(){var e=function(){this.graph=[],this.queue,this.distance=[],this.previous=[]};e.prototype.setGraph=function(e){if("object"!=typeof e)throw"graph isn't an object ("+typeof e+")";if(e.length<1)throw"graph is empty";for(var t in e){var i=e[t];if("object"!=typeof i||2!==i.length)throw"node must be an array and contain 2 values (name, vertices). Failed at index: "+t;var r=i[0],n=i[1];for(var o in this.graph[r]=[],n){var a=n[o];if("object"!=typeof a||2!==a.length)throw"vertex must be an array and contain 2 values (name, vertices). Failed at index: "+t+"["+o+"]";var s=a[0],c=a[1];this.graph[r][s]=c}}},e.prototype.getPath=function(e,i){if(void 0===this.graph[e])throw"source "+e+" doesn't exist";if(void 0===this.graph[i])throw"target "+i+" doesn't exist";if(e===i)return[];this.queue=new t,this.queue.add(e,0),this.previous[e]=null;for(var r=null;r=this.queue.shift();){if(r===i){for(var n=[];null!=this.previous[r];)n.unshift(r),r=this.previous[r];return n}if(this.queue.getDistance(r)==1/0)return[];var o=this.queue.getDistance(r);for(var a in this.graph[r]){var s=this.queue.getDistance(a),c=o+this.graph[r][a];c<s&&(this.queue.update(a,c),this.previous[a]=r)}}return[]};var t=function(){var e=function(){this.min=null,this.roots=[],this.nodes=[]};return e.prototype.shift=function(){var e=this.min;if(null==e||this.roots.length<1)return this.min=null,e;this.remove(e),this.roots.length>50&&this.consolidate();for(var t=1/0,i=this.roots.length,r=0;r<i;r++){var n=this.roots[r],o=this.getDistance(n);o<t&&(t=o,this.min=n)}return e},e.prototype.consolidate=function(){for(var e=[[],[],[],[],[],[],[]],t=e.length-1,i=this.roots.length,r=0;r<i;r++){var n=this.roots[r];(o=this.nodes[n].depth)<t&&e[o].push(n)}for(var o=0;o<=t;o++)for(;e[o].length>1;){var a=e[o].shift(),s=e[o].shift(),c=o+1,l=-1;this.nodes[a].distance<this.nodes[s].distance?(this.nodes[a].depth=c,this.nodes[a].children.push(s),this.nodes[s].parent=a,c<=t&&e[c].push(a),l=this.roots.indexOf(s)):(this.nodes[s].depth=c,this.nodes[s].children.push(a),this.nodes[a].parent=s,c<=t&&e[c].push(s),l=this.roots.indexOf(a)),l>-1&&this.roots.splice(l,1)}},e.prototype.add=function(e,t){this.nodes[e]={node:e,distance:t,depth:0,parent:null,children:[]},(!this.min||t<this.nodes[this.min].distance)&&(this.min=e),this.roots.push(e)},e.prototype.update=function(e,t){this.remove(e),this.add(e,t)},e.prototype.remove=function(e){if(this.nodes[e]){var t=this.nodes[e].children.length;if(t>0)for(var i=0;i<t;i++){var r=this.nodes[e].children[i];this.nodes[r].parent=this.nodes[e].parent,null==this.nodes[r].parent&&this.roots.push(r)}var n=this.nodes[e].parent;if(null==n){var o=this.roots.indexOf(e);o>-1&&this.roots.splice(o,1)}else for(;n;)this.nodes[n].depth--,n=this.nodes[n].parent}},e.prototype.getDistance=function(e){return this.nodes[e]?this.nodes[e].distance:1/0},e}();return e}();VB.GMLLoader=function(e){this.topologyManager=e,this.option={fittingOrign:!1,orign:{x:0,y:0,z:0},makeToplogyMesh:!0}},VB.GMLLoader.prototype={constructor:VB.GMLLoader,load:function(e,t,i,r){var n=this;if(document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState&&(0===o.status||200===o.status))if(o.responseXML)n.parse(e,o.responseXML,t,i);else if(o.responseText){var a=(new DOMParser).parseFromString(o.responseText,"application/xml");n.parse(e,a,t,i)}else r?r():console.error("ColladaLoader : Empty or non-existing file ("+e+")")},o.open("GET",e,!0),o.overrideMimeType("application/xml"),o.send(null)}else alert("Don't know to parse XML")},parse:function(e,t,i,r){var n=this,o=!1,a=new THREE.Object3D,s=function(e){if(console.log("parseX_definition"),e.children)for(var t=e.children,i=0;i<t.length;++i){var r=t[i];if("zcoord"===r.tagName)"true"===r.getElementsByTagName("apply_floorheight")[0].firstChild.nodeValue&&(o=!0);else r.tagName}else for(var a=e.firstElementChild;a;){if("zcoord"===a.tagName)"true"===a.getElementsByTagName("apply_floorheight")[0].firstChild.nodeValue&&(o=!0);else if("restrict"===a.tagName){var s=a.getElementsByTagName("restrict_bit");n.topologyManager.restrict_bit=parseInt(s[0].firstChild.nodeValue)}a=a.nextElementSibling}},c=function(e){console.log("VB.GMLLoader.parseSpaceLayerMember");for(var t=e.getElementsByTagName("X_floor"),i=0;i<t.length;++i){var r=new THREE.Object3D,s=t[i],c=parseInt(s.getAttribute("number")),l=parseInt(s.getAttribute("level")),h=s.getAttribute("id");nodeName="gml:Node";for(var u=s.getElementsByTagName(nodeName),d=0;d<u.length;++d){var p=new VB.Node(VB.NodeGeometry,VB.NodeMaterial),f=u[d];p.gmlid=f.getAttribute("gml:id"),p.userData.id=f.getAttribute("gml:id");var m=f.getElementsByTagName("type");p.userData.type=parseInt(m[0].firstChild.nodeValue),/Trident/i.test(navigator.userAgent)?(p.position.x=parseInt(f.getElementsByTagName("xcoord")[0].firstChild.wholeText),p.position.z=-1*parseInt(f.getElementsByTagName("ycoord")[0].firstChild.wholeText),p.position.y=parseInt(f.getElementsByTagName("zcoord")[0].firstChild.wholeText)+5):(p.position.x=parseInt(f.getElementsByTagName("xcoord")[0].firstChild.nodeValue),p.position.z=-1*parseInt(f.getElementsByTagName("ycoord")[0].firstChild.nodeValue),p.position.y=parseInt(f.getElementsByTagName("zcoord")[0].firstChild.nodeValue)+5),!1===o&&(p.position.z+=l),r.add(p)}r.userData.baseFloor=c,r.userData.id=h,r.userData.type="floor",a.add(r)}for(i=0;i<t.length;++i){r=a.children[i];var g=(s=t[i]).getElementsByTagName("Transition");for(d=0;d<g.length;++d){var v=g[d],y=v.getAttribute("gml:id");nodeName="gml:directedNode";var E,x,b=v.getElementsByTagName(nodeName);if(2===b.length){E=b[0].getAttribute("xlink:href"),x=b[1].getAttribute("xlink:href");var w,T=v.getElementsByTagName("restrict"),M=parseInt(T[0].firstChild.nodeValue),S=v.getElementsByTagName("length"),R=(parseInt(S[0].firstChild.nodeValue),v.getElementsByTagName("link_name"));R[0].firstChild&&(w=R[0].firstChild.nodeValue);var A,_=v.getElementsByTagName("Width");if(_.length>0&&_[0].firstChild&&(A=parseInt(_[0].firstChild.nodeValue)),n.topologyManager.setLink(a,E,x,M),n.option.makeToplogyMesh){var D={gmlid:y,source:E,target:x,radius:5,thickness:A,material:1===M?VB.LinkMaterial.impossibility:VB.LinkMaterial.available,name:w,restrict:M},C=n.topologyManager.makeLink(a,D);r.add(C)}}}}},l=t.firstChild;if("MultiLayeredGraph"===l.tagName)if(l.children)for(var h=l.children,u=0;u<h.length;++u){var d=h[u];"X_definition"===d.tagName?s(d):"SpaceLayerMember"===d.tagName&&c(d)}else for(var p=l.firstElementChild;p;)"X_definition"===p.tagName?s(p):"SpaceLayerMember"===p.tagName&&c(p),p=p.nextElementSibling;n.topologyManager.updateLink(a),i&&i(a)}},VB.Toolbar=function(e,t){var r=new UI.Panel,n=e;this.container=r,r.setId("toolbar"),r.dom.style.position="absolute",t.horizontal||(r.dom.style.width="24px"),r.dom.style.top=t.pos_top,r.dom.style.right=t.pos_right,r.dom.style.zIndex=100;var o=new UI.Panel;r.add(o);var a,s=!0;for(showAll=function(){for(i=1;i<o.dom.children.length;i++)o.dom.children[i].style.visibility="visible";o.dom.children[0].src="../image/showtoolbar.png",s=!0},hideAll=function(){for(i=1;i<o.dom.children.length;i++)o.dom.children[i].style.visibility="hidden";o.dom.children[0].src="../image/hidetoolbar.png",s=!1},a=new UI.Image("../image/showtoolbar.png").onClick(function(){s?hideAll():showAll()}),o.add(a),o.add(new UI.HorizontalRule),t.button_home&&(a=new UI.Image("../image/home.png").onClick(function(){var e=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.RIGHTTOP,e.min,e.max,!1)}),o.add(a),t.button_rotate&&o.add(new UI.HorizontalRule)),t.button_rotate&&(a=new UI.Image("../image/rotate_left.png").onClick(function(){n.rotate(new THREE.Vector3(-.2,0,0))}),o.add(a),a=new UI.Image("../image/rotate_right.png").onClick(function(){n.rotate(new THREE.Vector3(.2,0,0))}),o.add(a),t.button_sideview&&o.add(new UI.HorizontalRule)),t.button_sideview&&(a=new UI.Image("../image/zoomin.png").onClick(function(){var e=n.getSceneBoundingBox(!1);n.zoom(.1*-(e.min.z-e.max.z))}),o.add(a),a=new UI.Image("../image/zoomout.png").onClick(function(){var e=n.getSceneBoundingBox(!1);n.zoom(.1*(e.min.z-e.max.z))}),o.add(a),o.add(new UI.HorizontalRule),a=new UI.Image("../image/left_side.png").onClick(function(){var e=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.LEFT,e.min,e.max,!1)}),o.add(a),a=new UI.Image("../image/right_side.png").onClick(function(){var e=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.RIGHT,e.min,e.max,!1)}),o.add(a),a=new UI.Image("../image/front_side.png").onClick(function(){var e=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.FRONT,e.min,e.max,!1)}),o.add(a),a=new UI.Image("../image/back_side.png").onClick(function(){var e=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.BACK,e.min,e.max,!1)}),o.add(a),a=new UI.Image("../image/up_side.png").onClick(function(){var e=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.TOP,e.min,e.max,!1)}),o.add(a)),i=1;i<o.dom.children.length;i++)o.dom.children[i].src&&(o.dom.children[i].addEventListener("mouseover",c),o.dom.children[i].addEventListener("mouseout",l));function c(e){var t=e.target.src.replace(".png","_over.png");e.target.src=t}function l(e){var t=e.target.src.replace("_over.png",".png");e.target.src=t}return this},VB.GKXMLLoader=function(e){this.onPluginParser=function(e){console.log("not defined")},e&&(this.onPluginParser=e),this.resourceManager={textures:void 0,materials:void 0,geometries:void 0}},VB.GKXMLLoader.prototype={constructor:VB.GKXMLLoader,setResoucreManager:function(e,t,i){this.resourceManager.textures=e,this.resourceManager.materials=t,this.resourceManager.geometries=i},load:function(e,t,i,r,n){var o=this;if(document.implementation&&document.implementation.createDocument){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState&&(0===a.status||200===a.status))if(a.responseXML)o.parse(e,a.responseXML,t,i,r);else if(a.responseText){var s=(new DOMParser).parseFromString(a.responseText,"application/xml");o.parse(e,s,t,i,r)}else n?n():console.error("GKXMLLoader : Empty or non-existing file ("+e+")")},a.open("GET",e,!0),a.send(null)}else alert("Don't know to parse XML")},parse:function(e,t,i,r,n){var o=this,a=0,s=0,c=new THREE.Object3D;c.userData.boundingBox=new THREE.Box3;for(var l=t.evaluate?t:document,h=l.evaluate("count(Project/Building/Floors/Floor)",t,null,XPathResult.ANY_TYPE,null).numberValue,u=l.evaluate("Project/Building/Floors/Floor/FileSource",t,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),d=u.iterateNext();d;){var p={id:null,name:null,fileUrl:null,useBufferGeometry:!0,scale:1,totalSBMs:h,currentSBMs:a++};o.resourceManager.textures&&(p.textures=o.resourceManager.textures),p.id=d.parentNode.getAttribute("id"),p.name=d.parentNode.getAttribute("name");var f=d.getAttribute("name"),m=f.lastIndexOf("\\");-1!==m&&(f=f.substr(m+1));var g="";-1!==(m=e.lastIndexOf("/"))&&(g=e.substr(0,m+1)),p.fileUrl=g+f;var v=new VB.SBMLoader;v.worker=n,v.load(p.fileUrl,p,function(e,r){var n=new Map;e.traverse(function(e){e instanceof THREE.Mesh&&n.put(e.userData.id,e)});for(var a=(t.evaluate?t:document).evaluate("Project/Building/ObjectHierarchy/Entity[@id='"+r.id+"']",t,null,XPathResult.ANY_UNORDERED_NODE_TYPE,null).singleNodeValue,u=(t.evaluate?t:document).evaluate("Entity",a,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),d=u.iterateNext();d;){var p=n.get(d.getAttribute("id"));p&&(p.userData.name=d.getAttribute("name"),p.userData.longname=d.getAttribute("longname"),p.userData.type=d.getAttribute("type"),p.userData.posX=d.getAttribute("posX"),p.userData.posY=d.getAttribute("posY"),p.userData.posZ=d.getAttribute("posZ"),p.userData.area=d.getAttribute("area")),d=u.iterateNext()}if(e.userData.id=a.getAttribute("id"),e.userData.name=a.getAttribute("name"),e.userData.type=a.getAttribute("type"),e.userData.longname=a.getAttribute("longname"),e.userData.filesource=r.fileUrl,e.userData.index=s,e.name=a.getAttribute("name"),c.add(e),++s===h){var f=l.evaluate("Project/PluginData",t,null,XPathResult.ANY_UNORDERED_NODE_TYPE,null).singleNodeValue;o.onPluginParser(f),c.name="Main Model Scene",i(c)}},r),d=u.iterateNext()}}};var GongVue=function(){this.editor,this.viewport};GongVue.version=1,GongVue.prototype.init=function(e,t,i){if(null==e)return!1;var r=this;Number.prototype.format=function(){return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")},this.editor=new VB.Editor;var n=this.editor;this.viewport=new VB.Viewport(n);var o=this.viewport;e.appendChild(o.container.dom),o.transformControls.visible=!1,o.container.dom.style.position="relative",o.container.dom.style.width="100%",o.container.dom.style.height="100%",o.continuousRender=!0,o.enableFocus=!1,n.signals.showGridChanged.dispatch(!0),i&&(o.transformControls.visible=!0===i.enableTransform,o.continuousRender=!0===i.continuousRender||null==i.continuousRender,o.enableFocus=!0===i.enableFocus,n.signals.showGridChanged.dispatch(!0===i.showGrid),o.renderer.setClearColor(i.backgroundColor),o.enableSelect=!0===i.enableSelect||null==i.enableSelect);try{n.createLibraryManager(o.renderer,n.camera,o.onMovePosition),o.addPostRender("Library Render",n.LibraryManager.update.bind(n.LibraryManager)),n.LibraryManager.onClick=function(e){var i;t&&t.libraryClick&&r.editor.selectMode===VB.Editor.SelectMode.deviceobject&&(e&&(i={device:e.device.device,name:e.name,layerName:e.layerId}),t.libraryClick(i))},n.LibraryManager.onDblClick=function(e){var i;t&&t.libraryDblClick&&r.editor.selectMode===VB.Editor.SelectMode.deviceobject&&(e&&(i={uuid:e.device.device.uuid,id:e.device.device.id,userId:e.device.device.userData.id,name:e.name,layerName:e.layerId}),t.libraryDblClick(i))}}catch(e){console.log(e.message)}try{n.createPoiManager(o.renderer,n.camera,o.onMovePosition),o.addPostRender("POI Render",n.poiManager.update.bind(n.poiManager)),n.poiManager.onClick=function(e){var i;t&&t.poiClick&&r.editor.selectMode===VB.Editor.SelectMode.object&&(e&&(i=e.poi?{uuid:e.poi.uuid,id:e.poi.id,userId:e.poi.userData.id,name:e.name,layerName:e.layerId}:{menu:e.menu}),t.poiClick(i))},n.poiManager.onDblClick=function(e){var i;t&&t.poiDblClick&&(e&&(i={uuid:e.poi.uuid,id:e.poi.id,userId:e.poi.userData.id,name:e.name,layerName:e.layerId}),t.poiDblClick(i))}}catch(e){console.log(e.message)}try{n.createDeviceManager(o.renderer,n.camera,o.onMovePosition),o.addPostRender("DEVICE Render",n.DeviceManager.update.bind(n.DeviceManager)),n.DeviceManager.onClick=function(e){var i;t&&t.deviceClick&&r.editor.selectMode===VB.Editor.SelectMode.position&&(e&&(i={uuid:e.device.uuid,id:e.device.id,userId:e.device.userData.id,name:e.name,layerName:e.layerId}),t.deviceClick(i))},n.DeviceManager.onDblClick=function(e){var i;t&&t.poiDblClick&&(e&&(i={uuid:e.device.uuid,id:e.device.id,userId:e.device.userData.id,name:e.name,layerName:e.layerId}),t.poiDblClick(i))}}catch(e){console.log(e.message)}n.signals.objectSelected.add(function(e){if(t&&t.objClick){var i={};e&&(i.uuid=e.uuid,i.floorId=e.parent.userData.id,i.userId=e.parent.userData.id),t.objClick(i)}}),n.signals.objectFocused.add(function(e){t&&t.objDblClick&&t.objDblClick()}),n.signals.selectPosition.add(function(e){if(t&&t.selectPosition){var i={};e&&(i.parentUesrId=e.object.parent.userData.id,i.floorId=e.object.parent.userData.id,i.position={x:e.point.x,y:e.point.y,z:e.point.z}),t.selectPosition(i)}}),n.signals.cameraChanged.add(function(e){t&&t.cameraChanged&&t.cameraChanged(r.editor.camera)});try{n.createTopologyManager(o.renderer,n.camera,o.onMovePosition,o.postRender)}catch(e){console.log(e.message)}document.addEventListener("keydown",function(e){switch(e.keyCode){case 8:if("INPUT"!=e.target.nodeName&&"TEXTAREA"!=e.target.nodeName){e.preventDefault();break}}},!1);var a=function(e){t&&t.resize&&t.resize(e),n.signals.windowResize.dispatch()};return window.addEventListener("resize",a,!1),n.clear(),a(),!0},GongVue.prototype.SetDefaultLight=function(){this.createAmbientLight({color:10132122,name:"MainAmbientLight"}),this.createDirectionalLight({colo:16777215,intensity:1,name:"MainDirectionalLight",direction:{x:1,y:.5,z:.8}}),this.createHemisphereLight({skyColor:4494832,groundColor:11251373,intensity:.05,name:"MainHemisphereLight",position:{x:0,y:0,z:10}})},GongVue.prototype.SetDefaultLightDark=function(){var e=new THREE.AmbientLight(10132122,.1);return e.name="MainAmbientLight",this.editor.addObject(e),e},GongVue.prototype.SetDefaultMaterial=function(e){this.addDeviceMaterial({textureUrl:e?"../image/poi/poi_icon_led.png":"",id:"0",color:16777215}),this.addDeviceMaterial({textureUrl:e?"../image/poi/tip_gw_normal.png":"",id:"1",color:16777215}),this.addDeviceMaterial({textureUrl:e?"../image/poi/poi_icon_sensor.png":"",id:"2",color:16777215})},GongVue.prototype.SetControlWheelScale=function(e){this.viewport.controls.wheelscale=e},GongVue.prototype.updateBoundingBox=function(){this.editor.updateSceneBoundingBox()},GongVue.prototype.getSceneBoundingBox=function(e){var t=this.editor.bbox;return!0!==e&&null!=t||(this.editor.updateSceneBoundingBox(),t=this.editor.bbox),{min:{x:t.min.x,y:t.min.y,z:t.min.z},max:{x:t.max.x,y:t.max.y,z:t.max.z}}},GongVue.prototype.ShowPoi=function(e){for(i=0;i<editor.poiManager.poiScene.children.length;i++)if(obj=editor.poiManager.poiScene.children[i],obj instanceof VB.Layer)for(j=0;j<obj.children.length;j++){var t=obj.children[j];-1!=e&&t.userData.floorid!=e||(t.visible=!0)}},GongVue.prototype.HidePoi=function(e){for(i=0;i<editor.poiManager.poiScene.children.length;i++)if(obj=editor.poiManager.poiScene.children[i],obj instanceof VB.Layer)for(j=0;j<obj.children.length;j++){var t=obj.children[j];-1!=e&&t.userData.floorid!=e||(t.visible=!1)}},GongVue.prototype.ShowFloor=function(e){for(i=0;i<editor.scene.children.length;i++)if(obj=editor.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var t=obj.children[j];t instanceof THREE.Object3D&&"Floor"==t.userData.type&&(-1!=e&&t.userData.id!=e||(t.visible=!0))}},GongVue.prototype.HideFloor=function(e){for(i=0;i<editor.scene.children.length;i++)if(obj=editor.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var t=obj.children[j];t instanceof THREE.Object3D&&"Floor"==t.userData.type&&(-1!=e&&t.userData.id!=e||(t.visible=!1))}},GongVue.prototype.GetFloorInfoArray=function(){var e=[];for(i=0;i<editor.scene.children.length;i++)if(obj=editor.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var t=obj.children[j];t instanceof THREE.Object3D&&"Floor"==t.userData.type&&e.push({id:t.userData.id,name:t.name})}return e.sort(function(e,t){return e.id-t.id}),e};var setY=!1;function getObject(e,t,i){for(var r=0;r<e.scene.children.length;++r){var n=e.scene.children[r];if(n.userData.id===t)return e.getChildByUserData(n,"id",i)}}GongVue.prototype.IsDivideFloor=function(){return setY},GongVue.prototype.DivideFloor=function(e){function t(t,r,n){var o=0;for(i=0;i<t.length;i++)t[i].object instanceof THREE.Object3D&&(o=Math.max(o,t[i].value));for(null!=e&&e>0&&(o=e),i=0;i<t.length;i++)t[i].object instanceof THREE.Object3D&&new TWEEN.Tween(t[i].object.position).to({x:t[i].object.position.x,y:t[i].object.position.y+o*r*t[i].object.userData.id,z:t[i].object.position.z},500).easing(TWEEN.Easing.Linear.None).start()}var r=this.editor,n=(this.viewport,[]);for(i=0;i<r.scene.children.length;i++)if(obj=r.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var o=obj.children[j];if(o instanceof THREE.Object3D){var a=o.userData.id;if(a){var s=(new THREE.Box3).setFromObject(o),c=s.max.y-s.min.y;n.push({id:a-1,value:c,object:o})}}}console.log(n),setY?(t(n,-1),setY=!1):(t(n,1),setY=!0)},GongVue.prototype.fitBoundingBoxToScreen=function(e,t,i,r,n){var o=this.editor,a=this.viewport,s=new THREE.Box3(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z));o.fitBoundingBoxToScreen(a.getWidth(),a.getHeight(),s,!0===i,r,n)},GongVue.prototype.setViewpoint=function(e,t,i,r,n){this.editor,this.viewport;this.fitBoundingBoxToScreen(t,i,r,e,n)},GongVue.prototype.setZoomToMousePosition=function(e){this.viewport.controls.centerzoom=!e},GongVue.prototype.createSky=function(){this.editor.createSky(this.viewport.renderer)},GongVue.prototype.setBackgroundColor=function(e){this.viewport.renderer.setClearColor(e),this.editor.scene.background=new THREE.Color(e)},GongVue.prototype.setSelectMode=function(e){this.editor.selectMode=e},GongVue.prototype.getSelectMode=function(){return this.editor.selectMode},GongVue.prototype.render=function(){this.viewport.renderByState()},GongVue.prototype.clear=function(){this.editor.clear()},GongVue.prototype.enableEditControl=function(e){this.viewport.controls.enabled=e},GongVue.prototype.zoom=function(e){this.viewport.controls.zoom(new THREE.Vector3(0,0,e))},GongVue.prototype.pan=function(e){this.viewport.controls.pan(e)},GongVue.prototype.rotate=function(e){this.viewport.controls.rotate(e,!0)},GongVue.prototype.startRotateByCenter=function(e,t,i){gongvue.viewport.controls.rotateRad=new THREE.Vector3(e,t,i)},GongVue.prototype.stopRotateByCenter=function(){gongvue.viewport.controls.rotateRad=new THREE.Vector3},GongVue.prototype.getMainCameraPosition=function(){var e=this.editor.camera.position;return{x:e.x,y:e.y,z:e.z}},GongVue.prototype.setZoomFactor=function(){},GongVue.prototype.selectObjByScreenCoordinate=function(e){},GongVue.prototype.changeClippingLength=function(e){this.editor.scene.traverse(function(t){if(t instanceof THREE.Mesh&&t.material.clippingPlanes){for(var i=0;i<t.material.clippingPlanes.length;i++)t.material.clippingPlanes[i].constant=e,console.log(e);t.material.needsUpdate=!0}})},GongVue.prototype.insertClipping=function(e,t,i,r){this.viewport.renderer.localClippingEnabled=!0;var n=new THREE.Plane(new THREE.Vector3(e,t,i),r);this.editor.scene.traverse(function(e){e instanceof THREE.Mesh&&(e.material.clippingPlanes?e.material.clippingPlanes.push(n):e.material.clippingPlanes=[n],e.material.clipIntersection=!0,e.material.needsUpdate=!0)})},GongVue.prototype.showClipping=function(){this.editor.scene.traverse(function(e){e instanceof THREE.Mesh&&(e.material.clipIntersection=!0)}),this.viewport.renderer.localClippingEnabled=!0},GongVue.prototype.hideClipping=function(){this.editor.scene.traverse(function(e){e instanceof THREE.Mesh&&(e.material.clipIntersection=!1)}),this.viewport.renderer.localClippingEnabled=!1},GongVue.prototype.setVisibleLight=function(e,t,i){editor.LibraryManager.setVisibleLight(e,t,i)},GongVue.prototype.importGML=function(e){if(null!=e.topologyID&&null!=e.fileUrl){var t=this.editor,i=t.getChildByUserData(t.scene,"id",e.parentID,!0);null==i&&(i=t.scene);var r=this;new VB.GMLLoader(this.editor.topologyManager).load(e.fileUrl,function(t){t.userData.type="topology",t.name="topology",t.userData.id=e.topologyID,null!=e.visible&&(t.visible=e.visible),e.offsetElevation&&t.translateY(e.offsetElevation),r.editor.importModel(t,i),e.onLoad&&e.onLoad(t.uuid)})}},GongVue.prototype.showTopologyByType=function(e){if(null!=e.topologyID&&null!=e.type&&null!=e.visible){var t=this.editor,i=t.getChildByUserData(t.scene,"id",e.topologyID,!0);i&&i.traverse(function(t){var i=-1;i=t instanceof VB.Node?1:t instanceof VB.Link?2:-1,(e.type===i||0===e.type&&i>0)&&(t.visible=e.visible)})}},GongVue.prototype.setTopologyColor=function(e){if(null!=e){this.editor;var t=[];1===e.type?t.push(VB.NodeMaterial):2===e.type?t.push(VB.LinkMaterial):0===e.type&&(t.push(VB.NodeMaterial),t.push(VB.LinkMaterial));for(var i=0;i<t.length;++i)e.color&&t[i].color&&t[i].color.set(e.color),e.opacity&&(t[i].opacity=e.opacity)}},GongVue.prototype.removeTopology=function(e){var t=this.editor,i=t.getChildByUserData(t.scene,"id",e,!0);i&&t.removeObject(i)},GongVue.prototype.clearTopology=function(){var e=this.editor,t=[];e.scene.traverse(function(e){"topology"===e.userData.type&&t.push(e)});for(var i=0;i<t.length;++i)e.removeObject(t[i])},GongVue.prototype.findShortestPath=function(e){if(null!=e&&null!=e.topologyID){var t=this.editor,i=t.getChildByUserData(t.scene,"id",e.toplogyID,!0);t.topologyManager.makeGraph(i);var r=t.topologyManager.getPaths(i,e.startGMLID,e.endGMLID);return t.importModel(i.parent,r),r.uuid}},GongVue.prototype.removePathByUUID=function(e){if(null!=e){var t=this.editor.getChildByProperty(this.editor.scene,"uuid",e,!0);t&&(this.editor.removeGeometry(t.geometry),t.material.map&&this.editor.removeTexture(t.material.map.sourceFile),this.editor.removeMaterial(t.material.uuid),this.editor.removeObject(t))}},GongVue.prototype.setPathColor=function(e,t){if(null!=e){var i=this.editor.getChildByProperty(this.editor.scene,"uuid",e,!0);i&&i.material.map&&i.material.map.color.set(t.color)}},GongVue.prototype.showPath=function(e,t){if(null!=e){var i=this.editor.getChildByProperty(this.editor.scene,"uuid",e,!0);i&&(i.visible=t)}},GongVue.prototype.checkHandicappedPath=function(){var e=this.editor.topologyManager.restrict_bit;return!e||4&e},GongVue.prototype.findShortestPathByPosition=function(e){if(null!=e&&null!=e.topologyID&&null!=e.positions&&!(e.positions.length<2)){var t=this.editor,i=t.getChildByUserData(t.scene,"id",e.topologyID,!0);t.topologyManager.updateLink(i,e.restrict),t.topologyManager.makeGraph(i);for(var r=[],n=0;n<e.positions.length;++n){var o=e.positions[n].position,a=c(i,new THREE.Vector3(o.x,o.y,o.z),e.positions[n].floorId);r.push(a.gmlid)}var s=t.topologyManager.getPaths(i,r);return null!=s?(t.importModel(s,i.parent),s.uuid):void 0}function c(e,t,i){var r,n=Number.MAX_VALUE,o=function(e,t){for(var i=0;i<e.children.length;++i){var r=e.children[i];if(r.userData.id===t)return r}console.log("Find Floor Node Error")}(e,i);if(o)for(var a=0;a<o.children.length;++a){var s=o.children[a];if(s instanceof VB.Node){var c=s.getWorldPosition().clone().distanceTo(t);n>c&&(n=c,r=s)}}return r}},GongVue.prototype.getDistanceOfPath=function(e){if(null!=e){var t=this.editor.getChildByProperty(this.editor.scene,"uuid",e,!0);return t?t.geometry.parameters.path.getLength():0}},GongVue.prototype.followPath=function(e){switch(e.cmd){case 1:if(e.pathUUID){var t=this.editor.getChildByProperty(this.editor.scene,"uuid",e.pathUUID,!0);t&&(this.viewport.enable=!1,this.viewport.stopAnimate(),this.editor.topologyManager.path=t.geometry,this.editor.topologyManager.speed=e.speed,this.editor.topologyManager.DriveMode=e.mode,this.editor.topologyManager.DrivePoi=e.poi,this.editor.topologyManager.start())}break;case 2:this.editor.topologyManager.pause();break;case 3:this.editor.topologyManager.stop(),this.viewport.enable=!0,this.viewport.animate()}},GongVue.prototype.importGKXML=function(e,t,i,r,n,o){var a=this.editor;this.viewport;a.deselect();var s=new VB.GKXMLLoader;s.setResoucreManager(a.textures),s.load(t,function(e){if(!0===o)for(var t=0;t<this.editor.scene.children.length;++t){var r=a.getBoundingBox(a.scene.children[t],!0),n=r.getCenter();n.y=r.min.y;var s=(new THREE.Matrix4).makeTranslation(-n.x,-n.y,-n.z);a.scene.children[t].traverse(function(e){e instanceof THREE.Mesh&&(e.geometry.applyMatrix(s),e.geometry.computeBoundingSphere(),e.geometry.computeBoundingBox(),e.geometry.computeVertexNormals(!0),e.geometry.computeFaceNormals(),e.position.addVectors(e.position,n))})}a.importModel(e,a.scene),i&&i({userId:e.userData.id})},r,n,null)},GongVue.prototype.insertGateware=function(e,t,i,r){var n=this.editor;void 0==r&&(r=0);var o=n.LibraryManager.InsertLibrary(this,e,t,r,0),a={id:0,name:i,materialId:1,width:20,height:20,position:{x:t.x,y:t.y,z:t.z}},s=this.createDevice(a,o);return n.DeviceManager.getDeviceByProperty("uuid",s)},GongVue.prototype.insertSense=function(e,t,i){var r=this.editor;void 0==i&&(i=0);var n=r.LibraryManager.InsertLibrary(this,e,t,i,0),o={id:0,name:"",materialId:2,width:20,height:20,position:{x:t.x,y:t.y,z:t.z}},a=this.createDevice(o,n);return r.DeviceManager.getDeviceByProperty("uuid",a)},GongVue.prototype.insertLED=function(e,t,i){var r=this.editor;void 0==i&&(i=0);var n=r.LibraryManager.InsertLibrary(this,e,t,i,0),o={id:0,name:"",materialId:0,width:20,height:20,position:{x:t.x,y:t.y,z:t.z}},a=this.createDevice(o,n);return r.DeviceManager.getDeviceByProperty("uuid",a)},GongVue.prototype.insertLibrary=function(e,t,i,r,n){var o=this.editor;void 0==r&&(r=0),void 0==n&&(n=100);var a=o.LibraryManager.InsertLibrary(this,e,t,r,n),s={id:0,name:i||"",materialId:0,width:20,height:20,position:{x:t.x,y:t.y,z:t.z}},c=this.createDevice(s,a);return o.DeviceManager.getDeviceByProperty("uuid",c)},GongVue.prototype.insertLEDPointLight=function(e,t,i,r,n,o,a,s){var c=this.editor;void 0==a&&(a=0);var l={color:16777215,position:{x:t.x,y:t.y,z:t.z},target:{x:t.x,y:t.y-2e3,z:t.z},intensity:1,distance:500,decay:1,shapetype:r,width:n,height:o,angle:a,enablelight:s},h=this.createLEDLight(l),u={id:0,name:i||"",materialId:0,width:20,height:20,position:{x:t.x,y:t.y,z:t.z}},d=this.createDevice(u,h);return c.DeviceManager.getDeviceByProperty("uuid",d)},GongVue.prototype.insertLightingLibrary=function(e,t,i,r,n){var o=this.editor;void 0==r&&(r=0),void 0==n&&(n=100);var a=o.LibraryManager.InsertLibrary(this,e,t,r,n),s={id:0,name:i||"",materialId:0,width:20,height:20,position:{x:t.x,y:t.y,z:t.z}},c=this.createDevice(s,a);return o.DeviceManager.getDeviceByProperty("uuid",c)},GongVue.prototype.loadLibrary=function(e,t,i){var r=this.editor;try{r.LibraryManager.LoadLibrary(this,e,t,i)}catch(e){console.log(e.message)}},GongVue.prototype.importSBM=function(e,t,i,r,n,o){var a=this.editor;this.viewport;a.deselect();for(var s,c=0,l=this.viewport.renderer.capabilities.getMaxAnisotropy(),h=0;h<this.editor.scene.children.length;++h)if(a.scene.children[h].userData.id===e){s=a.scene.children[h];break}null==s&&((s=new THREE.Group).userData.type="indoor",s.userData.id=e,null==e&&(s.userData.id=s.uuid.toString()),s.visible=!0);var u=function(e,h){var u=new VB.SBMLoader;u.worker=n,u.textures=a.textures,u.load(e.fileUrl,e,function(e,r){if(c++,e.userData.type="floor",!0===o){var n=a.getBoundingBox(e,!0),u=n.getCenter();u.y=n.min.y;var d=(new THREE.Matrix4).makeTranslation(-u.x,-u.y,-u.z);e.traverse(function(e){e instanceof THREE.Mesh&&(e.geometry.applyMatrix(d),e.geometry.computeBoundingSphere(),e.geometry.computeBoundingBox(),e.geometry.computeVertexNormals(!0),e.geometry.computeFaceNormals(),e.position.addVectors(e.position,u))})}if(s.add(e),c>=t.length)a.importModel(s,a.scene),i&&i({userId:s.userData.id});else if(c<t.length){var p=t[c];p.anisotropy=l,h(p,h)}},void 0!==r?r:void 0)},d=t[c];d.anisotropy=l,u(d,u)},GongVue.prototype.clearPointLight=function(){for(var e=[],t=0;t<this.editor.scene.children.length;++t)"pointlight"===this.editor.scene.children[t].userData.type&&e.push(this.editor.scene.children[t]);for(t=0;t<e.length;++t)this.editor.removeObject(e[t])},GongVue.prototype.clearSBM=function(){for(var e=[],t=0;t<this.editor.scene.children.length;++t)if("indoor"===this.editor.scene.children[t].userData.type){e.push(this.editor.scene.children[t]),this.editor.poiManager.poiScene.userData[this.editor.scene.children[t].userData.id]={};break}for(t=0;t<e.length;++t)this.editor.removeObject(e[t])},GongVue.prototype.removeSBM=function(e,t){this.editor,this.viewport;for(var i=0;i<this.editor.scene.children.length;++i){var r=this.editor.scene.children[i];if(r.userData.id===e){var n=this.editor.getChildByUserData(r,"id",t);this.editor.removeObject(n),null!=this.editor.poiManager.poiScene.userData[e]&&null!=this.editor.poiManager.poiScene.userData[e][t]&&delete this.editor.poiManager.poiScene.userData[e][t];break}}},GongVue.prototype.showSBM=function(e,t,i){this.editor,this.viewport;for(var r=0;r<this.editor.scene.children.length;++r){var n=this.editor.scene.children[r];if(n.userData.id===e){var o=this.editor.getChildByUserData(n,"id",t);if("floor"===o.userData.type){o.visible=i;break}}}},GongVue.prototype.isExistSBM=function(e,t){this.editor,this.viewport;for(var i=0;i<this.editor.scene.children.length;++i){if(this.editor.scene.children[i].userData.id===e)if("floor"===this.editor.getChildByUserData("id",t).userData.type)return!0}return!1},GongVue.prototype.selectObjByUserId=function(e){var t=this.editor.getChildByUserData(this.editor.scene,"id",e,!0);t&&this.editor.select(t)},GongVue.prototype.setSBMColorByUserID=function(e,t,i,r){var n=this.editor;this.viewport;function o(e,t,i){var r=n.materials[e.material.uuid];r&&(e.userData.srcMaterial=r.uuid,r=r.clone()),t&&r.color.set(t),i&&(r.opacity=i),e.material=r}var a=getObject(n,e,t);if(a)if("floor"===a.userData.type)for(var s=0;s<a.children.length;++s){var c=a.children[s];c instanceof THREE.Mesh&&o(c,i,r)}else a instanceof THREE.Mesh&&o(a,i,r)},GongVue.prototype.restoreSBMColorByUserID=function(e,t){var i=this.editor;this.viewport;function r(e,t){var r=t.userData.srcMaterial;if(r){var n=i.materials[r];t.material=n}}var n=getObject(i,e,t);if(n)if("floor"===n.userData.type)for(var o=0;o<n.children.length;++o){var a=n.children[o];a instanceof THREE.Mesh&&r(n.userData.materials,a)}else n instanceof THREE.Mesh&&this.editor.restoreMaterial(n.parent.userData.materials,n)},GongVue.prototype.enableSBM2DMode=function(e,t){var i=!1===t?1:.01,r=this.editor.getChildByUserData(this.editor.scene,"id",e,!0);if(r)for(var n=0;n<r.children.length;++n){var o=r.children[n];if("floor"===o.userData.type)for(var a=0;a<o.children.length;++a)o.children[a].scale.y=i}},GongVue.prototype.spreadSBM=function(e,t,i,r){var n=function(e){var t=e.scalar;return e.baseFloor>0?t*=e.baseFloor-1:t*=e.baseFloor,t};null!=r&&(n=r);var o=this.editor.getChildByUserData(this.editor.scene,"id",e,!0);if(o){for(var a,s=0;s<o.children.length;++s){if("topology"===(l=o.children[s]).userData.type){a=l;break}}var c={};for(s=0;s<o.children.length;++s){var l;if("floor"===(l=o.children[s]).userData.type){var h=n({scalar:t,baseFloor:l.userData.baseFloor,floorId:l.userData.id});if(l.translateOnAxis((new THREE.Vector3).set(i.x,i.y,i.z),h),l.updateMatrix(),l.updateMatrixWorld(),null!=this.editor.poiManager.poiScene.userData[e]&&null!=this.editor.poiManager.poiScene.userData[e][l.userData.id]){var u=this.editor.poiManager.poiScene.userData[e][l.userData.id];if(u){var d=new THREE.Vector3;for(var p in d.copy(i),d.multiplyScalar(h),u){var f=u[p];f.pos3D.addVectors(f.pos3D,d)}}}a&&(c[l.userData.id]=h)}}if(null!=a)for(s=0;s<a.children.length;++s){var m=a.children[s];null!=(h=c[m.userData.id])&&(m.translateOnAxis((new THREE.Vector3).set(i.x,i.y,i.z),h),m.updateMatrix(),m.updateMatrixWorld())}this.updateBoundingBox()}},GongVue.prototype.spreadSBMByBoundingBox=function(e,t,i,r){var n=function(e){var t=0,r=Math.abs(e.bb.max.x-e.bb.min.x),n=Math.abs(e.bb.max.z-e.bb.min.z),o=i.x<i.z?r:n;return e.baseFloor!==e.preBaseFloor&&(t=e.baseFloor>0?o*e.magnification+e.prePositiveValue:o*e.magnification*-1+e.preNegativeValue),t},o=new THREE.Box3,a=0,s=0,c=0;null!=r&&(n=r);var l=this.editor.getChildByUserData(this.editor.scene,"id",e,!0);if(l){for(var h,u=0;u<l.children.length;++u){if("topology"===(p=l.children[u]).userData.type){h=p;break}}var d={};for(u=0;u<l.children.length;++u){var p;if("floor"===(p=l.children[u]).userData.type){var f=t;if(p.userData.baseFloor){0===u&&(c=p.userData.baseFloor);f=n({magnification:t,preBaseFloor:c,baseFloor:p.userData.baseFloor,floorId:p.userData.id,bb:o,prePositiveValue:a,preNegativeValue:s});if(p.userData.baseFloor>0?a=f:s=f,p.translateOnAxis((new THREE.Vector3).set(i.x,i.y,i.z),f),p.updateMatrix(),null!=this.editor.poiManager.poiScene.userData[e]&&null!=this.editor.poiManager.poiScene.userData[e][p.userData.id]){var m=this.editor.poiManager.poiScene.userData[e][p.userData.id];if(m){var g=new THREE.Vector3;for(var v in g.copy(i),g.multiplyScalar(f),m){var y=m[v];y.pos3D.addVectors(y.pos3D,g)}}}h&&(d[p.userData.id]=f),c!==p.userData.baseFloor?o=this.editor.getBoundingBox(p,!0):o.union(this.editor.getBoundingBox(p,!0)),c=p.userData.baseFloor}}}if(null!=h)for(u=0;u<h.children.length;++u){var E=h.children[u];null!=(f=d[E.userData.id])&&(E.translateOnAxis((new THREE.Vector3).set(i.x,i.y,i.z),f),E.updateMatrix())}this.updateBoundingBox()}},GongVue.prototype.setStairMode=function(e){var t=this.editor.getChildByUserData(this.editor.scene,"id",e,!0);if(t){if(!0===t.userData.StairMode)return!0;t.userData.StairMode=!0;for(var i,r=gongvue.getSceneBoundingBox(),n=(f=Math.abs(r.max.x-r.min.x))<(m=Math.abs(r.max.z-r.min.z))?new THREE.Vector3(1,0,0):new THREE.Vector3(0,0,1),o=0;o<t.children.length;++o){if("topology"===(x=t.children[o]).userData.type){i=x;break}}var a={},s={},c=0,l=0;for(o=0;o<t.children.length;++o){if("floor"===(x=t.children[o]).userData.type){r=this.editor.getBoundingBox(x,!0);var h=x.userData.baseFloor.toString();null==s[h]&&(s[h]={floors:[],bb:new THREE.Box3}),s[h].bb.union(r),s[h].floors.push(x),c>parseInt(x.userData.baseFloor)&&(c=parseInt(x.userData.baseFloor)),l<parseInt(x.userData.baseFloor)&&(l=parseInt(x.userData.baseFloor))}}var u=0,d=0;for(o=-1;o>c;--o){r=s[o.toString()].bb;for(var p=s[(o+1).toString()].bb,f=Math.abs(p.min.x-r.max.x),m=Math.abs(p.min.z-r.max.z),g=n.x<n.z?f:m,v=0;v<s[o.toString()].floors.length;++v){if((x=s[o.toString()].floors[v]).userData.StairMode={axis:n,value:u+g},x.translateOnAxis(x.userData.StairMode.axis,x.userData.StairMode.value),x.updateMatrix(),x.updateMatrixWorld(),b=this.editor.poiManager.poiScene.userData[e][x.userData.id]){var y=new THREE.Vector3;for(var E in y.copy(x.userData.StairMode.axis),y.multiplyScalar(x.userData.StairMode.value),b){(w=b[E]).pos3D.addVectors(w.pos3D,y)}}i&&(a[x.userData.id]=x.userData.StairMode)}u+=g}for(o=1;o<l+1;++o){for(r=s[o.toString()].bb,p=s[(o-1).toString()].bb,f=Math.abs(p.max.x-r.min.x),m=Math.abs(p.max.z-r.min.z),g=n.x>n.z?f:m,v=0;v<s[o.toString()].floors.length;++v){var x,b;if((x=s[o.toString()].floors[v]).userData.StairMode={axis:(new THREE.Vector3).set(n.x,n.y,n.z),value:d+g},x.translateOnAxis(x.userData.StairMode.axis,x.userData.StairMode.value),x.updateMatrix(),x.updateMatrixWorld(),null!=this.editor.poiManager.poiScene.userData[e]&&null!=this.editor.poiManager.poiScene.userData[e][x.userData.id])if(b=this.editor.poiManager.poiScene.userData[e][x.userData.id]){y=new THREE.Vector3;for(var E in y.copy(x.userData.StairMode.axis),y.multiplyScalar(x.userData.StairMode.value),b){var w;(w=b[E]).pos3D.addVectors(w.pos3D,y)}}i&&(a[x.userData.id]=x.userData.StairMode)}d+=g}for(o=0;o<i.children.length;++o){var T=i.children[o],M=a[T.userData.id];null!=M&&(T.translateOnAxis(M.axis,M.value),T.updateMatrix(),T.updateMatrixWorld())}this.updateBoundingBox()}},GongVue.prototype.cancelStairMode=function(e){var t=this.editor.getChildByUserData(this.editor.scene,"id",e,!0);if(t){if(1!=t.userData.StairMode)return!0;var i;t.userData.StairMode=!1;for(var r=0;r<t.children.length;++r){if("topology"===(d=t.children[r]).userData.type){i=d;break}}var n={},o={},a=0,s=0;for(r=0;r<t.children.length;++r){if("floor"===(d=t.children[r]).userData.type){var c=d.userData.baseFloor.toString();null==o[c]&&(o[c]={floors:[]}),o[c].floors.push(d),a>parseInt(d.userData.baseFloor)&&(a=parseInt(d.userData.baseFloor)),s<parseInt(d.userData.baseFloor)&&(s=parseInt(d.userData.baseFloor))}}for(r=-1;r>a;--r)for(var l=0;l<o[r.toString()].floors.length;++l){if((d=o[r.toString()].floors[l]).translateOnAxis(d.userData.StairMode.axis,-d.userData.StairMode.value),d.updateMatrix(),d.updateMatrixWorld(),null!=this.editor.poiManager.poiScene.userData[e]&&null!=this.editor.poiManager.poiScene.userData[e][d.userData.id])if(p=this.editor.poiManager.poiScene.userData[e][d.userData.id]){var h=new THREE.Vector3;for(var u in h.copy(d.userData.StairMode.axis),h.multiplyScalar(-d.userData.StairMode.value),p){(f=p[u]).pos3D.addVectors(f.pos3D,h)}}i&&(n[d.userData.id]=d.userData.StairMode)}for(r=1;r<s+1;++r)for(l=0;l<o[r.toString()].floors.length;++l){var d,p;if((d=o[r.toString()].floors[l]).translateOnAxis(d.userData.StairMode.axis,-d.userData.StairMode.value),d.updateMatrix(),d.updateMatrixWorld(),p=this.editor.poiManager.poiScene.userData[e][d.userData.id]){h=new THREE.Vector3;for(var u in h.copy(d.userData.StairMode.axis),h.multiplyScalar(-d.userData.StairMode.value),p){var f;(f=p[u]).pos3D.addVectors(f.pos3D,h)}}i&&(n[d.userData.id]=d.userData.StairMode)}for(r=0;r<i.children.length;++r){var m=i.children[r],g=n[m.userData.id];null!=g&&(m.translateOnAxis(g.axis,-g.value),m.updateMatrix(),m.updateMatrixWorld())}this.updateBoundingBox()}},GongVue.prototype.createAmbientLight=function(e){if(null!=e){var t=new THREE.AmbientLight(e.color);return t.name=null==e.name?"ambientLight":e.name,this.editor.addObject(t),t.uuid}},GongVue.prototype.createDirectionalLight=function(e){if(null!=e){var t=new THREE.DirectionalLight(e.color,e.intensity);return t.name=null==e.name?"directionalLight":e.name,t.position.set(e.direction.x,e.direction.y,e.direction.z),this.editor.addObject(t),this.editor.helpers[t.id].visible=!0===e.showHelper,t.uuid}},GongVue.prototype.createHemisphereLight=function(e){if(null!=e){var t=new THREE.HemisphereLight(e.skyColor,e.groundColor,e.intensity);return t.name=null==e.name?"HemisphereLight":e.name,t.position.set(e.position.x,e.position.y,e.position.z),this.editor.addObject(t),this.editor.helpers[t.id].visible=!0===e.showHelper,t.uuid}},GongVue.prototype.createSpotLight=function(e){if(null!=e){var t=new THREE.SpotLight(e.color);return t.position.set(e.position.x,e.position.y,e.position.z),t.castShadow=!0,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,t.shadow.camera.near=500,t.shadow.camera.far=4e3,t.shadow.camera.fov=30,t.target.position.set(e.target.x,e.target.y,e.target.z),t.target.updateMatrixWorld(),t.angle=e.angle,this.editor.addObject(t),this.editor.helpers[t.id].visible=!0===e.showHelper,t}},GongVue.prototype.createRectLight=function(e){if(null!=e){var t=new THREE.RectAreaLight(e.color,e.intensity,e.width,e.height);t.position.set(e.position.x,e.position.y,e.position.z),t.lookAt(new THREE.Vector3(e.target.x,e.target.y,e.target.z));var i=new THREE.PlaneBufferGeometry(t.width,t.height,2,2),r=new THREE.MeshBasicMaterial({color:16777215,side:THREE.FrontSide}),n=new THREE.Mesh(i,r);t.add(n);var o=new THREE.PlaneBufferGeometry(t.width,t.height,2,2),a=new THREE.MeshBasicMaterial({color:526344,side:THREE.BackSide}),s=new THREE.Mesh(o,a);return t.add(s),this.editor.addObject(t),t}},GongVue.prototype.getAmbientLightUUIDs=function(){var e=[];return this.editor.scene.traverse(function(t){t instanceof THREE.AmbientLight&&e.push(t.uuid)}),e},GongVue.prototype.createLEDLight=function(e){if(null!=e){if(e.shapetype){switch(e.shapetype){case"square":(n=e.enablelight?new THREE.PointLight(e.color,e.intensity,e.distance,e.decay):new THREE.Object3D).position.set(e.position.x,e.position.y,e.position.z);var t=new THREE.PlaneBufferGeometry(e.width,e.height,2,2),i=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}),r=new THREE.Mesh(t,i);n.add(r),n.lookAt(new THREE.Vector3(e.target.x,e.target.y,e.target.z));break;case"circle":var n;(n=e.enablelight?this.createSpotLight(e):new THREE.Object3D).position.set(e.position.x,e.position.y,e.position.z);t=new THREE.CircleGeometry(e.width,8),i=new THREE.MeshBasicMaterial({color:5263440,side:THREE.DoubleSide}),r=new THREE.Mesh(t,i);n.add(r),n.lookAt(new THREE.Vector3(e.target.x,e.target.y,e.target.z));break;default:(n=e.enablelight?new THREE.PointLight(e.color,e.intensity,e.distance,e.decay):new THREE.Object3D).position.set(e.position.x,e.position.y,e.position.z)}n.userData.type="pointlight",this.editor.addObject(n),e.enablelight&&(this.editor.helpers[n.id].visible=!0===e.showHelper)}return n}},GongVue.prototype.createLayer=function(e){this.editor.addLayer(e)},GongVue.prototype.showLayer=function(e,t){var i=[];i.push(e),this.editor.poiManager.showLayer(i,t)},GongVue.prototype.removeLayer=function(e){var t=this.editor.poiManager.getLayer(e);t&&this.editor.poiManager.removeLayer(t)},GongVue.prototype.addPOIMaterial=function(e){this.editor.poiManager.addMaterial(e)},GongVue.prototype.createPOI=function(e){if(null!=e){var t=this.editor.poiManager.materials[e.materialId],i={layerName:e.layerName,id:e.id,name:e.name,position:{x:e.position.x,y:e.position.y,z:e.position.z},width:e.width,height:e.height,icon:t.map.sourceFile,material:t,groupId:e.groupId,zindex:e.zindex,elevation:e.elevation,animation:e.animation},r=this.editor.addPoi(i);if(r){if(r.visible=!0===e.visible||null==e.visible,e.animation&&r.setAnimation(),null!=e.floorId&&(r.userData.floorId=e.floorId,null==this.editor.poiManager.poiScene.userData[e.groupId]&&(this.editor.poiManager.poiScene.userData[e.groupId]={}),null==this.editor.poiManager.poiScene.userData[e.groupId][e.floorId]&&(this.editor.poiManager.poiScene.userData[e.groupId][e.floorId]={}),this.editor.poiManager.poiScene.userData[e.groupId][e.floorId][e.id]=r),e.lods)for(var n=0;n<e.lods.length;++n){var o=e.lods[n];r.addLOD(new VB.Poi.LOD(o.level,o.iconSize.width,o.iconSize.height,o.visibleText,o.visibleIcon,o.min,o.max))}return r.uuid}}},GongVue.prototype.removePOI=function(e){e&&this.editor.poiManager.removePoiByProperty("uuid",e)},GongVue.prototype.setPOIColor=function(e,t,i,r,n){var o;e&&(o=this.editor.poiManager.getPoiByProperty("uuid",e))&&o.setColor(t,i,r,n)},GongVue.prototype.restorePOIColor=function(e){var t;e&&(t=this.editor.poiManager.getPoiByProperty("uuid",e))&&t.restoreMaterial()},GongVue.prototype.setMovingPOI=function(e){var t;e&&(t=this.editor.poiManager.getPoiByProperty("uuid",e)),this.editor.poiManager.setMovingPoi(t)},GongVue.prototype.setPOIPosition=function(e,t){var i;e&&(this.viewport.stopAnimate(),(i=this.editor.poiManager.getPoiByProperty("uuid",e))&&i.pos3D.set(t.x,t.y,t.z),this.viewport.animate())},GongVue.prototype.clearPOI=function(){this.editor.poiManager.clear()},GongVue.prototype.getUserIdToMovingPOI=function(){if(this.editor.poiManager.moving)return this.editor.poiManager.moving.userData.id},GongVue.prototype.getUserDataToMovingPOI=function(){if(this.editor.poiManager.moving)return this.editor.poiManager.moving.userData},GongVue.prototype.getLayerNameOfPOI=function(e){var t=this.editor.poiManager.getPoiByProperty("uuid",e);if(t)return t.parent.name},GongVue.prototype.getPOIInformation=function(e){var t,i=this.editor.poiManager.getPoiByProperty("uuid",e);return i&&(t={layerName:i.parent.name,userId:i.userData.id,name:i.name,uuid:i.uuid,id:i.id,position:{x:i.pos3D.x,y:i.pos3D.y,z:i.pos3D.z}}),t},GongVue.prototype.getPOIInformationByUesrID=function(e){var t,i=this.editor.poiManager.getPoiByUserData("id",e);return i&&(t={layerName:i.parent.name,userId:i.userData.id,name:i.name,uuid:i.uuid,id:i.id,position:{x:i.pos3D.x,y:i.pos3D.y,z:i.pos3D.z}}),t},GongVue.prototype.focusPOIByUserID=function(e,t,i){var r=this.editor.poiManager.getPoiByUserData("id",e),n=this.editor.poiManager.getBoundingBox(r,new THREE.Vector3(t,t,t)),o=this.editor,a=this.viewport;if(n){var s=this.getSceneBoundingBox();return this.setViewpoint(VIEWPOINT.LEFTTOP,s.min,s.max,!0,function(){o.fitBoundingBoxToScreen(a.getWidth(),a.getHeight(),n,!0,i)}),r.uuid}},GongVue.prototype.setUserDataOfPOI=function(e,t,i){var r=this.editor.poiManager.getPoiByProperty("uuid",e);r&&(r.userData[t]=i)},GongVue.prototype.addDeviceMaterial=function(e){this.editor.DeviceManager.addMaterial(e)},GongVue.prototype.createLightingDevice=function(e,t,i){insertLightingLibrary(e,i.position,t);var r=gongvue.createDevice(optionParam);return gongvue.editor.DeviceManager.getDeviceByProperty("uuid",r)},GongVue.prototype.focusDEVICEByUserID=function(e,t,i){var r=this.editor.DeviceManager.getDeviceByProperty("id",e),n=this.editor.DeviceManager.getBoundingBox(r,new THREE.Vector3(t,t,t)),o=this.editor,a=this.viewport;if(console.log(n),n){var s=this.getSceneBoundingBox();return this.setViewpoint(VIEWPOINT.LEFTTOP,s.min,s.max,!0,function(){o.fitBoundingBoxToScreen(a.getWidth(),a.getHeight(),n,!0,i)}),r.uuid}},GongVue.prototype.createDevice=function(e,t){if(null!=e){var i=this.editor.DeviceManager.materials[e.materialId],r={layerName:e.layerName,id:e.id,name:e.name,position:{x:e.position.x,y:e.position.y,z:e.position.z},width:e.width,height:e.height,icon:i.map.sourceFile,material:i,groupId:e.groupId,zindex:e.zindex,elevation:e.elevation,animation:e.animation},n=this.editor.addDevice(r);if(n){if(n.visible=!0===e.visible||null==e.visible,e.animation&&n.setAnimation(),null!=e.floorId&&(n.userData.floorId=e.floorId,null==this.editor.DeviceManager.deviceScene.userData[e.groupId]&&(this.editor.DeviceManager.deviceScene.userData[e.groupId]={}),null==this.editor.DeviceManager.deviceScene.userData[e.groupId][e.floorId]&&(this.editor.DeviceManager.deviceScene.userData[e.groupId][e.floorId]={}),this.editor.DeviceManager.deviceScene.userData[e.groupId][e.floorId][e.id]=n),e.lods)for(var o=0;o<e.lods.length;++o){var a=e.lods[o];n.addLOD(new VB.Device.LOD(a.level,a.iconSize.width,a.iconSize.height,a.visibleText,a.visibleIcon,a.min,a.max))}return t&&(n.userData.meshContainer=t,t.device=n),n.uuid}}},GongVue.prototype.removeDevice=function(e){e&&this.editor.DeviceManager.removePoiByProperty("uuid",e)},GongVue.prototype.calcDistance=function(e,t){return new THREE.Vector3(e.x,e.y,e.z).distanceTo(new THREE.Vector3(t.x,t.y,t.z))},GongVue.prototype.moveMainCamera=function(e,t,i,r){if(t){var n=null==i?1500:i;new TWEEN.Tween(this.editor.camera.position).to({x:e.x,y:e.y,z:e.z},n).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){r&&r()}).start()}else this.editor.camera.position.set(e.x,e.y,e.z)},GongVue.prototype.transformMianCameraOnWorldAxis=function(e,t,i,r){var n=new THREE.Vector3(this.editor.camera.position.x,this.editor.camera.position.y,this.editor.camera.position.z),o=new THREE.Vector3(e.x,e.y,e.z);if(o.normalize(),o.multiplyScalar(t),n.addVectors(n,o),i)new TWEEN.Tween(this.editor.camera.position).to({x:n.x,y:n.y,z:n.z},1500).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){r&&r()}).start();else this.editor.camera.position.set(n.x,n.y,n.z)},GongVue.prototype.setMainCameraRotation=function(e,t,i,r){var n=this.editor.camera;if(t){var o=null==i?500:i;new TWEEN.Tween(this.editor.camera.rotation).to({x:e.x,y:e.y,z:e.z},o).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){n.updateMatrix(),r&&r()}).start()}else this.editor.setViewpoint(e)},GongVue.prototype.startFirstPersonCamera=function(e){var t=this;this.enableEditControl(!1),this.editor.saveCameraState(),this.moveMainCamera(e,!0,1500,function(){var e={x:0,y:t.editor.camera.rotation.y,z:0};t.setMainCameraRotation(e,!0,500,function(){t.viewport.firstPersonControls.init()})})},GongVue.prototype.stopFirstPersonCamera=function(e){var t=this.editor.getSavedCameraState();if(this.viewport.firstPersonControls.release(),this.enableEditControl(!0),!1!==e){var i=this,r={x:t.rotation.x,y:t.rotation.y,z:t.rotation.z};this.setMainCameraRotation(r,!0,500,function(){i.moveMainCamera(t.position,!0,1500,function(){})})}};var SEA3D={VERSION:18100,getVersion:function(){var e=SEA3D.VERSION.toString(),t=e.length;return e.substring(0,t-4)+"."+e.substring(t-4,t-3)+"."+e.substring(t-3,t-2)+"."+parseFloat(e.substring(t-2,t)).toString()}};console.log("SEA3D "+SEA3D.getVersion()),SEA3D.Stream=function(e){this.position=0,this.buffer=e||new ArrayBuffer},SEA3D.Stream.NONE=0,SEA3D.Stream.BOOLEAN=1,SEA3D.Stream.BYTE=2,SEA3D.Stream.UBYTE=3,SEA3D.Stream.SHORT=4,SEA3D.Stream.USHORT=5,SEA3D.Stream.INT24=6,SEA3D.Stream.UINT24=7,SEA3D.Stream.INT=8,SEA3D.Stream.UINT=9,SEA3D.Stream.FLOAT=10,SEA3D.Stream.DOUBLE=11,SEA3D.Stream.DECIMAL=12,SEA3D.Stream.VECTOR3D=74,SEA3D.Stream.VECTOR4D=106,SEA3D.Stream.STRING_TINY=128,SEA3D.Stream.STRING_SHORT=129,SEA3D.Stream.STRING_LONG=130,SEA3D.Stream.ASSET=200,SEA3D.Stream.GROUP=255,SEA3D.Stream.BLEND_MODE=["normal","add","subtract","multiply","dividing","mix","alpha","screen","darken","overlay","colorburn","linearburn","lighten","colordodge","lineardodge","softlight","hardlight","pinlight","spotlight","spotlightblend","hardmix","average","difference","exclusion","hue","saturation","color","value","linearlight","grainextract","reflect","glow","darkercolor","lightercolor","phoenix","negation"],SEA3D.Stream.INTERPOLATION_TABLE=["normal","linear","sine.in","sine.out","sine.inout","cubic.in","cubic.out","cubic.inout","quint.in","quint.out","quint.inout","circ.in","circ.out","circ.inout","back.in","back.out","back.inout","quad.in","quad.out","quad.inout","quart.in","quart.out","quart.inout","expo.in","expo.out","expo.inout","elastic.in","elastic.out","elastic.inout","bounce.in","bounce.out","bounce.inout"],SEA3D.Stream.sizeOf=function(e){return 0==e?0:e>=1&&e<=31?1:e>=32&&e<=63?2:e>=64&&e<=95?3:e>=96&&e<=125?4:-1},SEA3D.Stream.prototype={constructor:SEA3D.Stream,set buffer(e){this.buf=e,this.length=e.byteLength,this.data=new DataView(e)},get buffer(){return this.buf},get bytesAvailable(){return this.length-this.position}},SEA3D.Stream.prototype.getByte=function(e){return this.data.getInt8(e)},SEA3D.Stream.prototype.readBytes=function(e){var t=this.buf.slice(this.position,this.position+e);return this.position+=e,t},SEA3D.Stream.prototype.readByte=function(){return this.data.getInt8(this.position++)},SEA3D.Stream.prototype.readUByte=function(){return this.data.getUint8(this.position++)},SEA3D.Stream.prototype.readBool=function(){return 0!=this.data.getInt8(this.position++)},SEA3D.Stream.prototype.readShort=function(){var e=this.data.getInt16(this.position,!0);return this.position+=2,e},SEA3D.Stream.prototype.readUShort=function(){var e=this.data.getUint16(this.position,!0);return this.position+=2,e},SEA3D.Stream.prototype.readUInt24=function(){var e=16777215&this.data.getUint32(this.position,!0);return this.position+=3,e},SEA3D.Stream.prototype.readUInt24F=function(){return this.readUShort()|this.readUByte()<<16},SEA3D.Stream.prototype.readInt=function(){var e=this.data.getInt32(this.position,!0);return this.position+=4,e},SEA3D.Stream.prototype.readUInt=function(){var e=this.data.getUint32(this.position,!0);return this.position+=4,e},SEA3D.Stream.prototype.readFloat=function(){var e=this.data.getFloat32(this.position,!0);return this.position+=4,e},SEA3D.Stream.prototype.readUInteger=function(){var e=this.readUByte(),t=127&e;return 0!=(128&e)&&(t|=(127&(e=this.readUByte()))<<7,0!=(128&e)&&(t|=(127&(e=this.readUByte()))<<13)),t},SEA3D.Stream.prototype.readVector2=function(){return{x:this.readFloat(),y:this.readFloat()}},SEA3D.Stream.prototype.readVector3=function(){return{x:this.readFloat(),y:this.readFloat(),z:this.readFloat()}},SEA3D.Stream.prototype.readVector4=function(){return{x:this.readFloat(),y:this.readFloat(),z:this.readFloat(),w:this.readFloat()}},SEA3D.Stream.prototype.readMatrix=function(){var e=new Float32Array(16);return e[0]=this.readFloat(),e[1]=this.readFloat(),e[2]=this.readFloat(),e[3]=0,e[4]=this.readFloat(),e[5]=this.readFloat(),e[6]=this.readFloat(),e[7]=0,e[8]=this.readFloat(),e[9]=this.readFloat(),e[10]=this.readFloat(),e[11]=0,e[12]=this.readFloat(),e[13]=this.readFloat(),e[14]=this.readFloat(),e[15]=1,e},SEA3D.Stream.prototype.readUTF8=function(e){var t=this.readBytes(e);return window.TextDecoder?(new TextDecoder).decode(t):decodeURIComponent(escape(String.fromCharCode.apply(null,new Uint8Array(t))))},SEA3D.Stream.prototype.readExt=function(){return this.readUTF8(4).replace(/\0/g,"")},SEA3D.Stream.prototype.readUTF8Tiny=function(){return this.readUTF8(this.readUByte())},SEA3D.Stream.prototype.readUTF8Short=function(){return this.readUTF8(this.readUShort())},SEA3D.Stream.prototype.readUTF8Long=function(){return this.readUTF8(this.readUInt())},SEA3D.Stream.prototype.readUByteArray=function(e){var t=new Uint8Array(e);return SEA3D.Stream.memcpy(t.buffer,0,this.buffer,this.position,e),this.position+=e,t},SEA3D.Stream.prototype.readUShortArray=function(e){var t=new Uint16Array(e),i=2*e;return SEA3D.Stream.memcpy(t.buffer,0,this.buffer,this.position,i),this.position+=i,t},SEA3D.Stream.prototype.readUInt24Array=function(e){for(var t=new Uint32Array(e),i=0;i<e;i++)t[i]=this.readUInt24();return t},SEA3D.Stream.prototype.readUIntArray=function(e){var t=new Uint32Array(e),i=4*e;return SEA3D.Stream.memcpy(t.buffer,0,this.buffer,this.position,i),this.position+=i,t},SEA3D.Stream.prototype.readFloatArray=function(e){var t=new Float32Array(e),i=4*e;return SEA3D.Stream.memcpy(t.buffer,0,this.buffer,this.position,i),this.position+=i,t},SEA3D.Stream.prototype.readBlendMode=function(){return SEA3D.Stream.BLEND_MODE[this.readUByte()]},SEA3D.Stream.prototype.readInterpolation=function(){return SEA3D.Stream.INTERPOLATION_TABLE[this.readUByte()]},SEA3D.Stream.prototype.readTags=function(e){for(var t=this.readUByte(),i=0;i<t;++i){var r=this.readUShort(),n=this.readUInt(),o=this.position;e(r,this,n),this.position=o+=n}},SEA3D.Stream.prototype.readProperties=function(e){var t=this.readUByte(),i={},r={};i.__type=r;for(var n=0;n<t;n++){var o=this.readUTF8Tiny(),a=this.readUByte();r[o]=a,i[o]=a==SEA3D.Stream.GROUP?this.readProperties(e):this.readToken(a,e)}return i},SEA3D.Stream.prototype.readAnimationList=function(e){for(var t=[],i=this.readUByte(),r=0;r<i;){var n=this.readUByte(),o={};o.relative=0!=(1&n),2&n&&(o.timeScale=this.readFloat()),o.tag=e.getObject(this.readUInt()),t[r++]=o}return t},SEA3D.Stream.prototype.readScriptList=function(e){for(var t=[],i=this.readUByte(),r=0;r<i;){var n=this.readUByte(),o={};if(o.priority=1&n|2&n,4&n){var a=this.readUByte();o.params={};for(var s=0;s<a;s++){var c=this.readUTF8Tiny();o.params[c]=this.readObject(e)}}8&n&&(o.method=this.readUTF8Tiny()),o.tag=e.getObject(this.readUInt()),t[r++]=o}return t},SEA3D.Stream.prototype.readObject=function(e){return this.readToken(this.readUByte(),e)},SEA3D.Stream.prototype.readToken=function(e,t){switch(e){case SEA3D.Stream.BOOLEAN:return this.readBool();case SEA3D.Stream.UBYTE:return this.readUByte();case SEA3D.Stream.USHORT:return this.readUShort();case SEA3D.Stream.UINT24:return this.readUInt24();case SEA3D.Stream.INT:return this.readInt();case SEA3D.Stream.UINT:return this.readUInt();case SEA3D.Stream.FLOAT:return this.readFloat();case SEA3D.Stream.VECTOR3D:return this.readVector3();case SEA3D.Stream.VECTOR4D:return this.readVector4();case SEA3D.Stream.STRING_TINY:return this.readUTF8Tiny();case SEA3D.Stream.STRING_SHORT:return this.readUTF8Short();case SEA3D.Stream.STRING_LONG:return this.readUTF8Long();case SEA3D.Stream.ASSET:var i=this.readUInt();return i>0?t.getObject(i-1).tag:null;default:console.error("DataType not found!")}return null},SEA3D.Stream.prototype.readVector=function(e,t,i){var r=SEA3D.Stream.sizeOf(e),n=i*r+t*r;switch(e){case SEA3D.Stream.BOOLEAN:case SEA3D.Stream.UBYTE:return this.readUByteArray(n);case SEA3D.Stream.USHORT:return this.readUShortArray(n);case SEA3D.Stream.UINT24:return this.readUInt24Array(n);case SEA3D.Stream.UINT:return this.readUIntArray(n);case SEA3D.Stream.FLOAT:case SEA3D.Stream.VECTOR3D:case SEA3D.Stream.VECTOR4D:return this.readFloatArray(n)}},SEA3D.Stream.prototype.append=function(e){var t=new ArrayBuffer(this.data.byteLength+e.byteLength);t.set(new ArrayBuffer(this.data),0),t.set(new ArrayBuffer(e),this.data.byteLength),this.data=t},SEA3D.Stream.prototype.concat=function(e,t){return new SEA3D.Stream(this.buffer.slice(e,e+t))},SEA3D.Stream.memcpy=function(e,t,i,r,n){var o=new Uint8Array(e,t,n),a=new Uint8Array(i,r,n);o.set(a)},SEA3D.UByteArray=function(){this.ubytes=[],this.length=0},SEA3D.UByteArray.prototype={constructor:SEA3D.UByteArray,add:function(e){this.ubytes.push(e),this.length+=e.byteLength},toBuffer:function(){for(var e=new Uint8Array(this.length),t=0,i=0;t<this.ubytes.length;t++)e.set(this.ubytes[t],i),i+=this.ubytes[t].byteLength;return e.buffer}},SEA3D.Math={DEGREES:180/Math.PI,RADIANS:Math.PI/180},SEA3D.Math.angle=function(e){var t=e<0;return(e=(t?-e:e)%360)>180&&(e=e-180-180),t?-e:e},SEA3D.Math.lerpAngle=function(e,t,i){return Math.abs(e-t)>180&&(e>t?t+=360:t-=360),e+=(t-e)*i,SEA3D.Math.angle(e)},SEA3D.Math.lerpColor=function(e,t,i){var r=e>>24&255,n=e>>16&255,o=e>>8&255,a=255&e;return(r+=((t>>24&255)-r)*i)<<24|(n+=((t>>16&255)-n)*i)<<16|(o+=((t>>8&255)-o)*i)<<8|(a+=((255&t)-a)*i)},SEA3D.Math.lerp=function(e,t,i){return e+(t-e)*i},SEA3D.Math.lerp1x=function(e,t,i){e[0]+=(t[0]-e[0])*i},SEA3D.Math.lerp3x=function(e,t,i){e[0]+=(t[0]-e[0])*i,e[1]+=(t[1]-e[1])*i,e[2]+=(t[2]-e[2])*i},SEA3D.Math.lerpAng1x=function(e,t,i){e[0]=SEA3D.Math.lerpAngle(e[0],t[0],i)},SEA3D.Math.lerpColor1x=function(e,t,i){e[0]=SEA3D.Math.lerpColor(e[0],t[0],i)},SEA3D.Math.lerpQuat4x=function(e,t,i){var r,n,o,a,s,c=e[0],l=e[1],h=e[2],u=e[3],d=t[0],p=t[1],f=t[2],m=t[3];c*d+l*p+h*f+u*m<0&&(d=-d,p=-p,f=-f,m=-m),r=c+i*(d-c),n=l+i*(p-l),o=h+i*(f-h),a=u+i*(m-u),s=1/Math.sqrt(a*a+r*r+n*n+o*o),e[0]=r*s,e[1]=n*s,e[2]=o*s,e[3]=a*s},SEA3D.Timer=function(){this.time=this.start=Date.now()},SEA3D.Timer.prototype={constructor:SEA3D.Timer,get now(){return Date.now()},get deltaTime(){return Date.now()-this.time},get elapsedTime(){return Date.now()-this.start},update:function(){this.time=Date.now()}},SEA3D.Object=function(e,t,i,r){this.name=e,this.data=t,this.type=i,this.sea3d=r},SEA3D.GeometryBase=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.attrib=t.readUShort(),this.isBig=0!=(1&this.attrib),t.readVInt=this.isBig?t.readUInt:t.readUShort,this.numVertex=t.readVInt(),this.length=3*this.numVertex},SEA3D.Geometry=function(e,t,i){var r,n,o;if(SEA3D.GeometryBase.call(this,e,t,i),4&this.attrib&&(this.normal=t.readFloatArray(this.length)),8&this.attrib&&(this.tangent=t.readFloatArray(this.length)),32&this.attrib)for(this.uv=[],this.uv.length=t.readUByte(),o=2*this.numVertex,r=0;r<this.uv.length;)this.uv[r++]=t.readFloatArray(o);if(64&this.attrib){this.jointPerVertex=t.readUByte();var a=this.numVertex*this.jointPerVertex;this.joint=t.readUShortArray(a),this.weight=t.readFloatArray(a)}if(128&this.attrib){var s=t.readUByte();for(this.numColor=1+((64&s)>>6|(128&s)>>6),this.color=[],r=0,o=15&s;r<o;r++)this.color.push(t.readFloatArray(this.numVertex*this.numColor))}this.vertex=t.readFloatArray(this.length);var c=t.readUByte();if(this.groups=[],1024&this.attrib){for(r=0,o=0;r<c;r++)n=3*t.readVInt(),this.groups.push({start:o,count:n}),o+=n;this.indexes=this.isBig?t.readUIntArray(o):t.readUShortArray(o)}else{var l=this.isBig?4:2,h=new SEA3D.UByteArray;for(r=0,n=0;r<c;r++)o=3*t.readVInt(),this.groups.push({start:n,count:o}),n+=o,h.add(t.readUByteArray(o*l));this.indexes=this.isBig?new Uint32Array(h.toBuffer()):new Uint16Array(h.toBuffer())}},SEA3D.Geometry.prototype=Object.create(SEA3D.GeometryBase.prototype),SEA3D.Geometry.prototype.constructor=SEA3D.Geometry,SEA3D.Geometry.prototype.type="geo",SEA3D.Object3D=function(e,t,i){if(this.name=e,this.data=t,this.sea3d=i,this.isStatic=!1,this.visible=!0,this.attrib=t.readUShort(),1&this.attrib&&(this.parent=i.getObject(t.readUInt())),2&this.attrib&&(this.animations=t.readAnimationList(i)),4&this.attrib&&(this.scripts=t.readScriptList(i)),16&this.attrib&&(this.attributes=i.getObject(t.readUInt())),32&this.attrib){var r=t.readUByte();this.isStatic=0!=(1&r),this.visible=0==(2&r)}},SEA3D.Object3D.prototype.readTag=function(e,t,i){},SEA3D.Entity3D=function(e,t,i){if(SEA3D.Object3D.call(this,e,t,i),this.castShadows=!0,64&this.attrib){var r=t.readUByte();this.castShadows=0==(1&r)}},SEA3D.Entity3D.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Entity3D.prototype.constructor=SEA3D.Entity3D,SEA3D.Sound3D=function(e,t,i){SEA3D.Object3D.call(this,e,t,i),this.autoPlay=0!=(64&this.attrib),128&this.attrib&&(this.mixer=i.getObject(t.readUInt())),this.sound=i.getObject(t.readUInt()),this.volume=t.readFloat()},SEA3D.Sound3D.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Sound3D.prototype.constructor=SEA3D.Sound3D,SEA3D.SoundPoint=function(e,t,i){SEA3D.Sound3D.call(this,e,t,i),this.position=t.readVector3(),this.distance=t.readFloat(),t.readTags(this.readTag.bind(this))},SEA3D.SoundPoint.prototype=Object.create(SEA3D.Sound3D.prototype),SEA3D.SoundPoint.prototype.constructor=SEA3D.SoundPoint,SEA3D.SoundPoint.prototype.type="sp",SEA3D.Container3D=function(e,t,i){SEA3D.Object3D.call(this,e,t,i),this.transform=t.readMatrix(),t.readTags(this.readTag.bind(this))},SEA3D.Container3D.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Container3D.prototype.constructor=SEA3D.Container3D,SEA3D.Container3D.prototype.type="c3d",SEA3D.ScriptURL=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.url=t.readUTF8(t.length)},SEA3D.ScriptURL.prototype.type="src",SEA3D.TextureURL=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.url=t.readUTF8(t.length)},SEA3D.TextureURL.prototype.type="urlT",SEA3D.CubeMapURL=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.faces=[];for(var r=0;r<6;r++)this.faces[r]=t.readUTF8Tiny()},SEA3D.CubeMapURL.prototype.type="cURL",SEA3D.Actions=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.count=t.readUInt(),this.actions=[];for(var r=0;r<this.count;r++){var n=t.readUByte(),o=t.readUShort(),a=t.readUShort(),s=t.position,c=this.actions[r]={kind:o};switch(1&n&&(c.range=[t.readUInt(),t.readUInt()]),2&n&&(c.time=t.readUInt()),4&n&&(c.intrpl=t.readInterpolation(),0==c.intrpl.indexOf("back.")?c.intrplParam0=t.readFloat():0==c.intrpl.indexOf("elastic.")&&(c.intrplParam0=t.readFloat(),c.intrplParam1=t.readFloat())),o){case SEA3D.Actions.RTT_TARGET:case SEA3D.Actions.LOOK_AT:c.source=i.getObject(t.readUInt()),c.target=i.getObject(t.readUInt());break;case SEA3D.Actions.PLAY_SOUND:c.sound=i.getObject(t.readUInt()),c.offset=t.readUInt();break;case SEA3D.Actions.PLAY_ANIMATION:c.object=i.getObject(t.readUInt()),c.name=t.readUTF8Tiny();break;case SEA3D.Actions.FOG:c.color=t.readUInt24(),c.min=t.readFloat(),c.max=t.readFloat();break;case SEA3D.Actions.ENVIRONMENT:c.texture=i.getObject(t.readUInt());break;case SEA3D.Actions.ENVIRONMENT_COLOR:c.color=t.readUInt24F();break;case SEA3D.Actions.CAMERA:c.camera=i.getObject(t.readUInt());break;case SEA3D.Actions.SCRIPTS:c.scripts=t.readScriptList(i);break;case SEA3D.Actions.CLASS_OF:c.classof=i.getObject(t.readUInt());break;case SEA3D.Actions.ATTRIBUTES:c.attributes=i.getObject(t.readUInt());break;default:console.log('Action "'+o+'" not found.')}t.position=s+a}},SEA3D.Actions.SCENE=0,SEA3D.Actions.ENVIRONMENT_COLOR=1,SEA3D.Actions.ENVIRONMENT=2,SEA3D.Actions.FOG=3,SEA3D.Actions.PLAY_ANIMATION=4,SEA3D.Actions.PLAY_SOUND=5,SEA3D.Actions.ANIMATION_AUDIO_SYNC=6,SEA3D.Actions.LOOK_AT=7,SEA3D.Actions.RTT_TARGET=8,SEA3D.Actions.CAMERA=9,SEA3D.Actions.SCRIPTS=10,SEA3D.Actions.CLASS_OF=11,SEA3D.Actions.ATTRIBUTES=12,SEA3D.Actions.prototype.type="act",SEA3D.Properties=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.tag=t.readProperties(i),this.tag.__name=e},SEA3D.Properties.prototype.type="prop",SEA3D.FileInfo=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.tag=t.readProperties(i),this.tag.__name=e,i.info=this.tag},SEA3D.FileInfo.prototype.type="info",SEA3D.JavaScript=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.src=t.readUTF8(t.length)},SEA3D.JavaScript.prototype.type="js",SEA3D.JavaScriptMethod=function(e,t,i){this.name=e,this.data=t,this.sea3d=i;var r=t.readUShort();this.methods={};for(var n=0;n<r;n++){t.readUByte();var o=t.readUTF8Tiny();this.methods[o]={src:t.readUTF8Long()}}},SEA3D.JavaScriptMethod.prototype.type="jsm",SEA3D.GLSL=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.src=t.readUTF8(t.length)},SEA3D.GLSL.prototype.type="glsl",SEA3D.Dummy=function(e,t,i){SEA3D.Object3D.call(this,e,t,i),this.transform=t.readMatrix(),this.width=t.readFloat(),this.height=t.readFloat(),this.depth=t.readFloat(),t.readTags(this.readTag.bind(this))},SEA3D.Dummy.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Dummy.prototype.constructor=SEA3D.Dummy,SEA3D.Dummy.prototype.type="dmy",SEA3D.Line=function(e,t,i){SEA3D.Object3D.call(this,e,t,i),this.count=3*(64&this.attrib?t.readUInt():t.readUShort()),this.closed=0!=(128&this.attrib),this.transform=t.readMatrix(),this.vertex=[];for(var r=0;r<this.count;)this.vertex[r++]=t.readFloat();t.readTags(this.readTag.bind(this))},SEA3D.Line.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Line.prototype.constructor=SEA3D.Line,SEA3D.Line.prototype.type="line",SEA3D.Sprite=function(e,t,i){SEA3D.Object3D.call(this,e,t,i),256&this.attrib&&(this.material=i.getObject(t.readUInt())),this.position=t.readVector3(),this.width=t.readFloat(),this.height=t.readFloat(),t.readTags(this.readTag.bind(this))},SEA3D.Sprite.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Sprite.prototype.constructor=SEA3D.Sprite,SEA3D.Sprite.prototype.type="m2d",SEA3D.Mesh=function(e,t,i){if(SEA3D.Entity3D.call(this,e,t,i),256&this.attrib)if(this.material=[],1==(o=t.readUByte()))this.material[0]=i.getObject(t.readUInt());else for(var r=0;r<o;){var n=t.readUInt();this.material[r++]=n>0?i.getObject(n-1):void 0}if(512&this.attrib){this.modifiers=[];var o=t.readUByte();for(r=0;r<o;r++)this.modifiers[r]=i.getObject(t.readUInt())}1024&this.attrib&&(this.reference={type:t.readUByte(),ref:i.getObject(t.readUInt())}),this.transform=t.readMatrix(),this.geometry=i.getObject(t.readUInt()),t.readTags(this.readTag.bind(this))},SEA3D.Mesh.prototype=Object.create(SEA3D.Entity3D.prototype),SEA3D.Mesh.prototype.constructor=SEA3D.Mesh,SEA3D.Mesh.prototype.type="m3d",SEA3D.Skeleton=function(e,t,i){this.name=e,this.data=t,this.sea3d=i;var r=t.readUShort();this.joint=[];for(var n=0;n<r;n++)this.joint[n]={name:t.readUTF8Tiny(),parentIndex:t.readUShort()-1,inverseBindMatrix:t.readMatrix()}},SEA3D.Skeleton.prototype.type="skl",SEA3D.SkeletonLocal=function(e,t,i){this.name=e,this.data=t,this.sea3d=i;var r=t.readUShort();this.joint=[];for(var n=0;n<r;n++)this.joint[n]={name:t.readUTF8Tiny(),parentIndex:t.readUShort()-1,x:t.readFloat(),y:t.readFloat(),z:t.readFloat(),qx:t.readFloat(),qy:t.readFloat(),qz:t.readFloat(),qw:t.readFloat()}},SEA3D.SkeletonLocal.prototype.type="sklq",SEA3D.AnimationBase=function(e,t,i){this.name=e,this.data=t,this.sea3d=i;var r=t.readUByte();if(this.sequence=[],1&r)for(var n=t.readUShort(),o=0;o<n;o++)r=t.readUByte(),this.sequence[o]={name:t.readUTF8Tiny(),start:t.readUInt(),count:t.readUInt(),repeat:0!=(1&r),intrpl:0==(2&r)};this.frameRate=t.readUByte(),this.numFrames=t.readUInt(),0==this.sequence.length&&(this.sequence[0]={name:"root",start:0,count:this.numFrames,repeat:!0,intrpl:!0})},SEA3D.Animation=function(e,t,i){SEA3D.AnimationBase.call(this,e,t,i),this.dataList=[];for(var r=0,n=t.readUByte();r<n;r++){var o=t.readUShort(),a=t.readUByte(),s=t.readVector(a,this.numFrames,0);this.dataList.push({kind:o,type:a,blockSize:SEA3D.Stream.sizeOf(a),data:s})}},SEA3D.Animation.POSITION=0,SEA3D.Animation.ROTATION=1,SEA3D.Animation.SCALE=2,SEA3D.Animation.COLOR=3,SEA3D.Animation.MULTIPLIER=4,SEA3D.Animation.ATTENUATION_START=5,SEA3D.Animation.ATTENUATION_END=6,SEA3D.Animation.FOV=7,SEA3D.Animation.OFFSET_U=8,SEA3D.Animation.OFFSET_V=9,SEA3D.Animation.SCALE_U=10,SEA3D.Animation.SCALE_V=11,SEA3D.Animation.ANGLE=12,SEA3D.Animation.ALPHA=13,SEA3D.Animation.VOLUME=14,SEA3D.Animation.DefaultLerpFuncs=[SEA3D.Math.lerp3x,SEA3D.Math.lerpQuat4x,SEA3D.Math.lerp3x,SEA3D.Math.lerpColor1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerpAng1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x],SEA3D.Animation.prototype=Object.create(SEA3D.AnimationBase.prototype),SEA3D.Animation.prototype.constructor=SEA3D.Animation,SEA3D.Animation.prototype.type="anm",SEA3D.SkeletonAnimation=function(e,t,i){SEA3D.AnimationBase.call(this,e,t,i),this.name=e,this.data=t,this.sea3d=i,this.numJoints=t.readUShort(),this.raw=t.readFloatArray(this.numFrames*this.numJoints*7)},SEA3D.SkeletonAnimation.prototype.type="skla",SEA3D.Morph=function(e,t,i){SEA3D.GeometryBase.call(this,e,t,i);var r=0!=(2&this.attrib),n=0!=(4&this.attrib),o=t.readUShort();this.node=[];for(var a=0;a<o;a++){var s,c,l=t.readUTF8Tiny();r&&(s=t.readFloatArray(this.length)),n&&(c=t.readFloatArray(this.length)),this.node[a]={vertex:s,normal:c,name:l}}},SEA3D.Morph.prototype=Object.create(SEA3D.GeometryBase.prototype),SEA3D.Morph.prototype.constructor=SEA3D.Morph,SEA3D.Morph.prototype.type="mph",SEA3D.VertexAnimation=function(e,t,i){SEA3D.AnimationBase.call(this,e,t,i);var r=t.readUByte();this.isBig=0!=(1&r),t.readVInt=this.isBig?t.readUInt:t.readUShort,this.numVertex=t.readVInt(),this.length=3*this.numVertex;var n,o,a,s=0!=(2&r),c=0!=(4&r);for(this.frame=[],n=0;n<this.numFrames;n++)s&&(o=t.readFloatArray(this.length)),c&&(a=t.readFloatArray(this.length)),this.frame[n]={vertex:o,normal:a}},SEA3D.VertexAnimation.prototype=Object.create(SEA3D.AnimationBase.prototype),SEA3D.VertexAnimation.prototype.constructor=SEA3D.VertexAnimation,SEA3D.VertexAnimation.prototype.type="vtxa",SEA3D.Camera=function(e,t,i){SEA3D.Object3D.call(this,e,t,i),64&this.attrib&&(this.dof={distance:t.readFloat(),range:t.readFloat()}),this.transform=t.readMatrix(),this.fov=t.readFloat(),t.readTags(this.readTag.bind(this))},SEA3D.Camera.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Camera.prototype.constructor=SEA3D.Camera,SEA3D.Camera.prototype.type="cam",SEA3D.OrthographicCamera=function(e,t,i){SEA3D.Object3D.call(this,e,t,i),this.transform=t.readMatrix(),this.height=t.readFloat(),t.readTags(this.readTag.bind(this))},SEA3D.OrthographicCamera.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.OrthographicCamera.prototype.constructor=SEA3D.OrthographicCamera,SEA3D.OrthographicCamera.prototype.type="camo",SEA3D.JointObject=function(e,t,i){SEA3D.Object3D.call(this,e,t,i),this.target=i.getObject(t.readUInt()),this.joint=t.readUShort(),t.readTags(this.readTag.bind(this))},SEA3D.JointObject.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.JointObject.prototype.constructor=SEA3D.JointObject,SEA3D.JointObject.prototype.type="jnt",SEA3D.Light=function(e,t,i){if(SEA3D.Object3D.call(this,e,t,i),this.attenStart=Number.MAX_VALUE,this.attenEnd=Number.MAX_VALUE,64&this.attrib){var r=t.readUByte();this.shadow={},this.shadow.opacity=1&r?t.readFloat():1,this.shadow.color=2&r?t.readUInt24():0}512&this.attrib&&(this.attenStart=t.readFloat(),this.attenEnd=t.readFloat()),this.color=t.readUInt24(),this.multiplier=t.readFloat()},SEA3D.Light.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Light.prototype.constructor=SEA3D.Light,SEA3D.PointLight=function(e,t,i){SEA3D.Light.call(this,e,t,i),128&this.attrib&&(this.attenuation={start:t.readFloat(),end:t.readFloat()}),this.position=t.readVector3(),t.readTags(this.readTag.bind(this))},SEA3D.PointLight.prototype=Object.create(SEA3D.Light.prototype),SEA3D.PointLight.prototype.constructor=SEA3D.PointLight,SEA3D.PointLight.prototype.type="plht",SEA3D.HemisphereLight=function(e,t,i){SEA3D.Light.call(this,e,t,i),128&this.attrib&&(this.attenuation={start:t.readFloat(),end:t.readFloat()}),this.secondColor=t.readUInt24(),t.readTags(this.readTag.bind(this))},SEA3D.HemisphereLight.prototype=Object.create(SEA3D.Light.prototype),SEA3D.HemisphereLight.prototype.constructor=SEA3D.HemisphereLight,SEA3D.HemisphereLight.prototype.type="hlht",SEA3D.AmbientLight=function(e,t,i){SEA3D.Light.call(this,e,t,i),t.readTags(this.readTag.bind(this))},SEA3D.AmbientLight.prototype=Object.create(SEA3D.Light.prototype),SEA3D.AmbientLight.prototype.constructor=SEA3D.AmbientLight,SEA3D.AmbientLight.prototype.type="alht",SEA3D.DirectionalLight=function(e,t,i){SEA3D.Light.call(this,e,t,i),this.transform=t.readMatrix(),t.readTags(this.readTag.bind(this))},SEA3D.DirectionalLight.prototype=Object.create(SEA3D.Light.prototype),SEA3D.DirectionalLight.prototype.constructor=SEA3D.DirectionalLight,SEA3D.DirectionalLight.prototype.type="dlht",SEA3D.Material=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.technique=[],this.tecniquesDict={},this.attrib=t.readUShort(),this.alpha=1,this.blendMode="normal",this.physical=!1,this.anisotropy=!1,this.bothSides=0!=(1&this.attrib),this.receiveLights=0==(2&this.attrib),this.receiveShadows=0==(4&this.attrib),this.receiveFog=0==(8&this.attrib),this.repeat=0==(16&this.attrib),32&this.attrib&&(this.alpha=t.readFloat()),64&this.attrib&&(this.blendMode=t.readBlendMode()),128&this.attrib&&(this.animations=t.readAnimationList(i)),this.depthWrite=0==(256&this.attrib),this.depthTest=0==(512&this.attrib),this.premultipliedAlpha=0!=(1024&this.attrib);for(var r=t.readUByte(),n=0;n<r;++n){var o,a,s=t.readUShort(),c=t.readUShort(),l=t.position;switch(s){case SEA3D.Material.PHONG:o={ambientColor:t.readUInt24(),diffuseColor:t.readUInt24(),specularColor:t.readUInt24(),specular:t.readFloat(),gloss:t.readFloat()};break;case SEA3D.Material.PHYSICAL:o={color:t.readUInt24(),roughness:t.readFloat(),metalness:t.readFloat()};break;case SEA3D.Material.ANISOTROPIC:break;case SEA3D.Material.COMPOSITE_TEXTURE:o={composite:i.getObject(t.readUInt())};break;case SEA3D.Material.DIFFUSE_MAP:case SEA3D.Material.SPECULAR_MAP:case SEA3D.Material.NORMAL_MAP:o={texture:i.getObject(t.readUInt())};break;case SEA3D.Material.REFLECTION:case SEA3D.Material.FRESNEL_REFLECTION:o={texture:i.getObject(t.readUInt()),alpha:t.readFloat()},s==SEA3D.Material.FRESNEL_REFLECTION&&(o.power=t.readFloat(),o.normal=t.readFloat());break;case SEA3D.Material.REFRACTION:o={texture:i.getObject(t.readUInt()),alpha:t.readFloat(),ior:t.readFloat()};break;case SEA3D.Material.RIM:o={color:t.readUInt24(),strength:t.readFloat(),power:t.readFloat(),blendMode:t.readBlendMode()};break;case SEA3D.Material.LIGHT_MAP:o={texture:i.getObject(t.readUInt()),channel:t.readUByte(),blendMode:t.readBlendMode()};break;case SEA3D.Material.DETAIL_MAP:o={texture:i.getObject(t.readUInt()),scale:t.readFloat(),blendMode:t.readBlendMode()};break;case SEA3D.Material.CEL:o={color:t.readUInt24(),levels:t.readUByte(),size:t.readFloat(),specularCutOff:t.readFloat(),smoothness:t.readFloat()};break;case SEA3D.Material.TRANSLUCENT:o={translucency:t.readFloat(),scattering:t.readFloat()};break;case SEA3D.Material.BLEND_NORMAL_MAP:a=t.readUByte(),o={texture:i.getObject(t.readUInt()),secondaryTexture:i.getObject(t.readUInt())},1&a?(o.offsetX0=t.readFloat(),o.offsetY0=t.readFloat(),o.offsetX1=t.readFloat(),o.offsetY1=t.readFloat()):o.offsetX0=o.offsetY0=o.offsetX1=o.offsetY1=0,o.animate=2&a;break;case SEA3D.Material.MIRROR_REFLECTION:o={texture:i.getObject(t.readUInt()),alpha:t.readFloat()};break;case SEA3D.Material.AMBIENT_MAP:case SEA3D.Material.ALPHA_MAP:o={texture:i.getObject(t.readUInt())};break;case SEA3D.Material.EMISSIVE:o={color:t.readUInt24()};break;case SEA3D.Material.EMISSIVE_MAP:o={texture:i.getObject(t.readUInt())};break;case SEA3D.Material.ROUGHNESS_MAP:case SEA3D.Material.METALNESS_MAP:o={texture:i.getObject(t.readUInt())};break;case SEA3D.Material.VERTEX_COLOR:o={blendMode:t.readBlendMode()};break;case SEA3D.Material.WRAP_LIGHTING:o={color:t.readUInt24(),strength:t.readFloat()};break;case SEA3D.Material.COLOR_REPLACE:a=t.readUByte(),o={red:t.readUInt24(),green:t.readUInt24(),blue:t.readUInt24F()},1&a&&(o.mask=i.getObject(t.readUInt())),2&a&&(o.alpha=t.readFloat());break;case SEA3D.Material.REFLECTION_SPHERICAL:o={texture:i.getObject(t.readUInt()),alpha:t.readFloat()};break;case SEA3D.Material.REFLECTIVITY:a=t.readUByte(),o={strength:t.readFloat()},1&a&&(o.mask=i.getObject(t.readUInt()));break;case SEA3D.Material.CLEAR_COAT:o={strength:t.readFloat(),roughness:t.readFloat()};break;default:console.warn("SEA3D: MaterialTechnique not found:",s.toString(16)),t.position=l+=c;continue}o.kind=s,this.technique.push(o),this.tecniquesDict[s]=o,t.position=l+=c}},SEA3D.Material.PHONG=0,SEA3D.Material.COMPOSITE_TEXTURE=1,SEA3D.Material.DIFFUSE_MAP=2,SEA3D.Material.SPECULAR_MAP=3,SEA3D.Material.REFLECTION=4,SEA3D.Material.REFRACTION=5,SEA3D.Material.NORMAL_MAP=6,SEA3D.Material.FRESNEL_REFLECTION=7,SEA3D.Material.RIM=8,SEA3D.Material.LIGHT_MAP=9,SEA3D.Material.DETAIL_MAP=10,SEA3D.Material.CEL=11,SEA3D.Material.TRANSLUCENT=12,SEA3D.Material.BLEND_NORMAL_MAP=13,SEA3D.Material.MIRROR_REFLECTION=14,SEA3D.Material.AMBIENT_MAP=15,SEA3D.Material.ALPHA_MAP=16,SEA3D.Material.EMISSIVE_MAP=17,SEA3D.Material.VERTEX_COLOR=18,SEA3D.Material.WRAP_LIGHTING=19,SEA3D.Material.COLOR_REPLACE=20,SEA3D.Material.REFLECTION_SPHERICAL=21,SEA3D.Material.ANISOTROPIC=22,SEA3D.Material.EMISSIVE=23,SEA3D.Material.PHYSICAL=24,SEA3D.Material.ROUGHNESS_MAP=25,SEA3D.Material.METALNESS_MAP=26,SEA3D.Material.REFLECTIVITY=27,SEA3D.Material.CLEAR_COAT=28,SEA3D.Material.prototype.type="mat",SEA3D.Composite=function(e,t,i){this.name=e,this.data=t,this.sea3d=i;var r=t.readUByte();this.layer=[];for(var n=0;n<r;n++)this.layer[n]=new SEA3D.Composite.prototype.Layer(t,i)},SEA3D.Composite.prototype.getLayerByName=function(e){for(var t=0;t<this.layer.length;t++)if(this.layer[t].name==e)return this.layer[t]},SEA3D.Composite.prototype.Layer=function(e,t){var i=e.readUShort();1&i?this.texture=new SEA3D.Composite.LayerBitmap(e,t):this.color=e.readUInt24(),2&i&&(this.mask=new SEA3D.Composite.LayerBitmap(e,t)),4&i&&(this.name=e.readUTF8Tiny()),this.blendMode=8&i?e.readBlendMode():"normal",this.opacity=16&i?e.readFloat():1},SEA3D.Composite.LayerBitmap=function(e,t){this.map=t.getObject(e.readUInt());var i=e.readUShort();this.channel=1&i?e.readUByte():0,this.repeat=!1&i,this.offsetU=4&i?e.readFloat():0,this.offsetV=8&i?e.readFloat():0,this.scaleU=16&i?e.readFloat():1,this.scaleV=32&i?e.readFloat():1,this.rotation=64&i?e.readFloat():0,128&i&&(this.animation=e.readAnimationList(t))},SEA3D.Composite.prototype.type="ctex",SEA3D.PlanarRender=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.attrib=t.readUByte(),this.quality=1&this.attrib|2&this.attrib,this.transform=t.readMatrix()},SEA3D.PlanarRender.prototype.type="rttp",SEA3D.CubeRender=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.attrib=t.readUByte(),this.quality=1&this.attrib|2&this.attrib,this.position=t.readVector3()},SEA3D.CubeRender.prototype.type="rttc",SEA3D.CubeMap=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.transparent=!1;t.readExt();this.faces=[];for(var r=0;r<6;r++){var n=t.readUInt();this.faces[r]=t.concat(t.position,n),t.position+=n}},SEA3D.CubeMap.prototype.type="cmap",SEA3D.JPEG=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.transparent=!1},SEA3D.JPEG.prototype.type="jpg",SEA3D.JPEG_XR=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.transparent=!0},SEA3D.JPEG_XR.prototype.type="wdp",SEA3D.PNG=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.transparent=6==t.getByte(25)},SEA3D.PNG.prototype.type="png",SEA3D.GIF=function(e,t,i){this.name=e,this.data=t,this.sea3d=i,this.transparent=t.getByte(11)>0},SEA3D.GIF.prototype.type="gif",SEA3D.OGG=function(e,t,i){this.name=e,this.data=t,this.sea3d=i},SEA3D.OGG.prototype.type="ogg",SEA3D.MP3=function(e,t,i){this.name=e,this.data=t,this.sea3d=i},SEA3D.MP3.prototype.type="mp3",SEA3D.File=function(e){this.config={streaming:!0,timeLimit:60},e&&(void 0!==e.streaming&&(this.config.streaming=e.streaming),void 0!==e.timeLimit&&(this.config.timeLimit=e.timeLimit)),this.version=SEA3D.VERSION,this.objects=[],this.typeClass={},this.typeRead={},this.typeUnique={},this.position=this.dataPosition=0,this.scope=this,this.addClass(SEA3D.FileInfo,!0),this.addClass(SEA3D.Geometry,!0),this.addClass(SEA3D.Mesh),this.addClass(SEA3D.Sprite),this.addClass(SEA3D.Material),this.addClass(SEA3D.Composite),this.addClass(SEA3D.PointLight),this.addClass(SEA3D.DirectionalLight),this.addClass(SEA3D.HemisphereLight),this.addClass(SEA3D.AmbientLight),this.addClass(SEA3D.Skeleton,!0),this.addClass(SEA3D.SkeletonLocal,!0),this.addClass(SEA3D.SkeletonAnimation,!0),this.addClass(SEA3D.JointObject),this.addClass(SEA3D.Camera),this.addClass(SEA3D.OrthographicCamera),this.addClass(SEA3D.Morph,!0),this.addClass(SEA3D.VertexAnimation,!0),this.addClass(SEA3D.CubeMap,!0),this.addClass(SEA3D.Animation),this.addClass(SEA3D.Dummy),this.addClass(SEA3D.Line),this.addClass(SEA3D.SoundPoint),this.addClass(SEA3D.PlanarRender),this.addClass(SEA3D.CubeRender),this.addClass(SEA3D.Actions),this.addClass(SEA3D.Container3D),this.addClass(SEA3D.Properties),this.addClass(SEA3D.ScriptURL,!0),this.addClass(SEA3D.TextureURL,!0),this.addClass(SEA3D.CubeMapURL,!0),this.addClass(SEA3D.JPEG,!0),this.addClass(SEA3D.JPEG_XR,!0),this.addClass(SEA3D.PNG,!0),this.addClass(SEA3D.GIF,!0),this.addClass(SEA3D.OGG,!0),this.addClass(SEA3D.MP3,!0),this.addClass(SEA3D.JavaScript,!0),this.addClass(SEA3D.JavaScriptMethod,!0),this.addClass(SEA3D.GLSL,!0);for(var t=SEA3D.File.Extensions.length;t--;)SEA3D.File.Extensions[t].call(this)},SEA3D.File.Extensions=[],SEA3D.File.CompressionLibs={},SEA3D.File.DecompressionMethod={},SEA3D.File.setExtension=function(e){SEA3D.File.Extensions.push(e)},SEA3D.File.setDecompressionEngine=function(e,t,i){SEA3D.File.CompressionLibs[e]=t,SEA3D.File.DecompressionMethod[e]=i},SEA3D.File.prototype.addClass=function(e,t){this.typeClass[e.prototype.type]=e,this.typeUnique[e.prototype.type]=!0===t},SEA3D.File.prototype.readHead=function(){if(this.stream.bytesAvailable<16)return!1;if("SEA"!=this.stream.readUTF8(3))throw new Error("Invalid SEA3D format.");if(this.sign=this.stream.readUTF8(3),this.version=this.stream.readUInt24(),0!=this.stream.readUByte())throw new Error("Protection algorithm not compatible.");if(this.compressionID=this.stream.readUByte(),this.compressionAlgorithm=SEA3D.File.CompressionLibs[this.compressionID],this.decompressionMethod=SEA3D.File.DecompressionMethod[this.compressionID],this.compressionID>0&&!this.decompressionMethod)throw new Error("Compression algorithm not compatible.");return this.length=this.stream.readUInt(),this.dataPosition=this.stream.position,this.objects.length=0,this.state=this.readBody,this.onHead&&this.onHead({file:this,sign:this.sign}),!0},SEA3D.File.prototype.getObject=function(e){return this.objects[e]},SEA3D.File.prototype.getObjectByName=function(e){return this.objects[e]},SEA3D.File.prototype.readSEAObject=function(){if(this.stream.bytesAvailable<4)return null;var e=this.stream.readUInt(),t=this.stream.position;if(this.stream.bytesAvailable<e)return null;var i=this.stream.readUByte(),r=this.stream.readExt(),n=null,o=1&i?this.stream.readUTF8Tiny():"",a=0!=(2&i),s=0!=(4&i);if(8&i){var c=this.stream.readUShort(),l=this.stream.concat(this.stream.position,c);this.stream.position+=c,a&&this.decompressionMethod&&(l.buffer=this.decompressionMethod(l.buffer)),n=l.readProperties(this)}e-=this.stream.position-t,t=this.stream.position;var h,u=this.stream.concat(t,e);return this.typeClass[r]?(a&&this.decompressionMethod&&(u.buffer=this.decompressionMethod(u.buffer)),h=new this.typeClass[r](o,u,this),(this.config.streaming&&s||this.config.forceStreaming)&&this.typeRead[r]&&this.typeRead[r].call(this.scope,h)):(h=new SEA3D.Object(o,u,r,this),console.warn('SEA3D: Unknown format "'+r+'" of file "'+o+'". Add a module referring for this format.')),h.streaming=s,h.metadata=n,this.objects.push(this.objects[h.name+"."+h.type]=h),this.dataPosition=t+e,++this.position,h},SEA3D.File.prototype.isDone=function(){return this.position==this.length},SEA3D.File.prototype.readBody=function(){if(this.timer.update(),!this.resume)return!1;for(;this.position<this.length;){if(!(this.timer.deltaTime<this.config.timeLimit))return!1;this.stream.position=this.dataPosition;var e=this.readSEAObject();if(!e)return!1;this.dispatchCompleteObject(e)}return this.state=this.readComplete,!0},SEA3D.File.prototype.initParse=function(){this.timer=new SEA3D.Timer,this.position=0,this.resume=!0},SEA3D.File.prototype.parse=function(){this.initParse(),isFinite(this.config.timeLimit)?setTimeout(this.parseObject.bind(this),10):this.parseObject()},SEA3D.File.prototype.parseObject=function(){for(this.timer.update();this.position<this.length&&this.timer.deltaTime<this.config.timeLimit;){var e=this.objects[this.position++],t=e.type;this.typeUnique[t]||delete e.tag,(e.streaming||this.config.forceStreaming)&&this.typeRead[t]&&void 0==e.tag&&this.typeRead[t].call(this.scope,e)}if(this.position==this.length){var i=this.timer.elapsedTime,r=i+"ms, "+this.objects.length+" objects";this.onParseComplete?this.onParseComplete({file:this,timeTotal:i,message:r}):console.log("SEA3D Parse Complete:",r)}else this.onParseProgress&&this.onParseProgress({file:this,loaded:this.position,total:this.length}),setTimeout(this.parseObject.bind(this),10)},SEA3D.File.prototype.readComplete=function(){return this.stream.position=this.dataPosition,6202321!=this.stream.readUInt24F()&&console.warn("SEA3D file is corrupted."),delete this.state,!1},SEA3D.File.prototype.readState=function(){for(;this.state();)continue;this.state?(requestAnimationFrame(this.readState.bind(this)),this.dispatchProgress()):this.dispatchComplete()},SEA3D.File.prototype.read=function(e){if(!e)throw new Error("No data found.");this.initParse(),this.stream=new SEA3D.Stream(e),this.state=this.readHead,this.readState()},SEA3D.File.prototype.dispatchCompleteObject=function(e){this.onCompleteObject&&this.onCompleteObject({file:this,object:e})},SEA3D.File.prototype.dispatchProgress=function(){this.onProgress&&this.onProgress({file:this,loaded:this.position,total:this.length})},SEA3D.File.prototype.dispatchDownloadProgress=function(e,t){this.onDownloadProgress&&this.onDownloadProgress({file:this,loaded:e,total:t})},SEA3D.File.prototype.dispatchComplete=function(){var e=this.timer.elapsedTime,t=e+"ms, "+this.objects.length+" objects";this.onComplete?this.onComplete({file:this,timeTotal:e,message:t}):console.log("SEA3D:",t)},SEA3D.File.prototype.dispatchError=function(e,t){this.onError?this.onError({file:this,id:e,message:t}):console.error("SEA3D: #"+e,t)},SEA3D.File.prototype.load=function(e){var t=this,i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onprogress=function(e){e.lengthComputable&&t.dispatchDownloadProgress(e.loaded,e.total)},i.onreadystatechange=function(){2===i.readyState||3===i.readyState||4===i.readyState&&(200===i.status||0===i.status?t.read(this.response):this.dispatchError(1001,"Couldn't load ["+e+"] ["+i.status+"]"))},i.send()},void 0===THREE.Float32BufferAttribute&&(THREE.Float32BufferAttribute=THREE.Float32Attribute),THREE.SEA3D=function(e){this.config={id:"",scripts:!0,runScripts:!0,autoPlay:!1,dummys:!0,multiplier:1,bounding:!0,audioRolloffFactor:10,lights:!0,useEnvironment:!0,useVertexTexture:!0,forceStatic:!1,streaming:!0,async:!0,paths:{},timeLimit:10},e&&this.loadConfig(e)},THREE.SEA3D.MTXBUF=new THREE.Matrix4,THREE.SEA3D.VECBUF=new THREE.Vector3,THREE.SEA3D.QUABUF=new THREE.Quaternion,THREE.SEA3D.BACKGROUND_COLOR=3355443,THREE.SEA3D.HELPER_COLOR=10140133,THREE.SEA3D.RTT_SIZE=512,THREE.SEA3D.prototype=Object.assign(Object.create(THREE.EventDispatcher.prototype),{constructor:THREE.SEA3D,setShadowMap:function(e){e.shadow.mapSize.width=2048,e.shadow.mapSize.height=1024,e.castShadow=!0,e.shadow.camera.left=-200,e.shadow.camera.right=200,e.shadow.camera.top=200,e.shadow.camera.bottom=-200,e.shadow.camera.near=1,e.shadow.camera.far=3e3,e.shadow.camera.fov=45,e.shadow.bias=-.001}}),Object.defineProperties(THREE.SEA3D.prototype,{container:{set:function(e){this.config.container=e},get:function(){return this.config.container}},elapsedTime:{get:function(){return this.file.timer.elapsedTime}}}),THREE.SEA3D.Domain=function(e,t,i){this.id=e,this.objects=t,this.container=i,this.sources=[],this.global={},this.scriptTargets=[],this.events=new THREE.EventDispatcher},Object.assign(THREE.SEA3D.Domain.prototype,{add:function(e){this.sources.push(e)},remove:function(e){this.sources.splice(this.sources.indexOf(e),1)},contains:function(e){return-1!=this.sources.indexOf(e)},addEventListener:function(e,t){this.events.addEventListener(e,t)},hasEventListener:function(e,t){return this.events.hasEventListener(e,t)},removeEventListener:function(e,t){this.events.removeEventListener(e,t)},print:function(){console.log.apply(console,arguments)},watch:function(){console.log.apply(console,"watch:",arguments)},runScripts:function(){for(var e=0;e<this.scriptTargets.length;e++)this.runJSMList(this.scriptTargets[e])},runJSMList:function(e){for(var t=e.scripts,i=0;i<t.length;i++)this.runJSM(e,t[i]);return t},runJSM:function(e,t){void 0==e.local&&(e.local={});var i={print:this.print,watch:this.watch,sea3d:this,scene:this.container,source:new THREE.SEA3D.ScriptDomain(this,e instanceof THREE.SEA3D.Domain)};Object.freeze(i.source),THREE.SEA3D.ScriptHandler.add(i.source);try{this.methods[t.method](i,this.getReference,this.global,e.local,e,t.params)}catch(e){console.error('SEA3D JavaScript: Error running method "'+t.method+'".'),console.error(e)}},getReference:function(ns){return eval(ns)},disposeList:function(e){if(e&&e.length)for(var t=(e=e.concat()).length;t--;)e[t].dispose()},dispatchEvent:function(e){e.domain=this;for(var t=this.sources.concat(),i=t.length;i--;)t[i].dispatchEvent(e);this.events.dispatchEvent(e)},dispose:function(){for(this.disposeList(this.sources);this.container.children.length;)this.container.remove(this.container.children[0]);for(var e=THREE.SEA3D.EXTENSIONS_DOMAIN.length;e--;){var t=THREE.SEA3D.EXTENSIONS_DOMAIN[e];t.dispose&&t.dispose.call(this)}this.disposeList(this.materials),this.disposeList(this.dummys),this.dispatchEvent({type:"dispose"})}}),THREE.SEA3D.DomainManager=function(e){this.domains=[],this.autoDisposeRootDomain=void 0==e},Object.assign(THREE.SEA3D.DomainManager.prototype,{onDisposeDomain:function(e){this.remove(e.domain),this.autoDisposeRootDomain&&1==this.domains.length&&this.dispose()},add:function(e){this._onDisposeDomain=this._onDisposeDomain||this.onDisposeDomain.bind(this),e.on("dispose",this._onDisposeDomain),this.domains.push(e),this.textures=this.textures||e.textures,this.cubemaps=this.cubemaps||e.cubemaps,this.geometries=this.geometries||e.geometries},remove:function(e){e.removeEvent("dispose",this._onDisposeDomain),this.domains.splice(this.domains.indexOf(e),1)},contains:function(e){return-1!=this.domains.indexOf(e)},disposeList:function(e){if(e&&e.length)for(var t=(e=e.concat()).length;t--;)e[t].dispose()},dispose:function(){this.disposeList(this.domains),this.disposeList(this.textures),this.disposeList(this.cubemaps),this.disposeList(this.geometries)}}),THREE.SEA3D.ScriptDomain=function(e,t){(e=e||new THREE.SEA3D.Domain).add(this);var i=new THREE.EventDispatcher;this.getId=function(){return e.id},this.isRoot=function(){return t},this.addEventListener=function(e,t){i.addEventListener(e,t)},this.hasEventListener=function(e,t){return i.hasEventListener(e,t)},this.removeEventListener=function(e,t){i.removeEventListener(e,t)},this.dispatchEvent=function(e){e.script=this,i.dispatchEvent(e)},this.dispose=function(){e.remove(this),t&&e.dispose(),this.dispatchEvent({type:"dispose"})}},THREE.SEA3D.ScriptManager=function(){this.scripts=[];var e=function(e){this.remove(e.script)}.bind(this);this.add=function(t){t.addEventListener("dispose",e),this.scripts.push(t)},this.remove=function(t){t.removeEventListener("dispose",e),this.scripts.splice(this.scripts.indexOf(t),1)},this.contains=function(e){return this.scripts.indexOf(e)>-1},this.dispatchEvent=function(e){for(var t=this.scripts.concat(),i=t.length;i--;)t[i].dispatchEvent(e)}},THREE.SEA3D.ScriptHandler=new THREE.SEA3D.ScriptManager,THREE.SEA3D.ScriptHandler.dispatchUpdate=function(e){this.dispatchEvent({type:"update",delta:e})},THREE.SEA3D.AnimationClip=function(e,t,i,r){THREE.AnimationClip.call(this,e,t,i),this.repeat=void 0===r||r},THREE.SEA3D.AnimationClip.fromClip=function(e,t){return new THREE.SEA3D.AnimationClip(e.name,e.duration,e.tracks,t)},THREE.SEA3D.AnimationClip.prototype=Object.assign(Object.create(THREE.AnimationClip.prototype),{constructor:THREE.SEA3D.AnimationClip}),THREE.SEA3D.Animation=function(e,t){this.clip=e,this.timeScale=void 0!==t?t:1},THREE.SEA3D.Animation.COMPLETE="animationComplete",THREE.SEA3D.Animation.prototype=Object.assign(Object.create(THREE.EventDispatcher.prototype),{constructor:THREE.SEA3D.Animation,onComplete:function(e){this.dispatchEvent({type:THREE.SEA3D.Animation.COMPLETE,target:this})}}),Object.defineProperties(THREE.SEA3D.Animation.prototype,{name:{get:function(){return this.clip.name}},repeat:{get:function(){return this.clip.repeat}},mixer:{set:function(e){this.mx&&(this.mx.uncacheClip(this.clip),delete this.mx),e&&(this.mx=e,this.mx.clipAction(this.clip))},get:function(){return this.mx}}}),THREE.SEA3D.Animator=function(e,t){this.updateAnimations(e,t),this.clone=function(e){return new this.constructor(this.clips,new THREE.AnimationMixer(e)).copyFrom(this)}.bind(this)},Object.assign(THREE.SEA3D.Animator.prototype,{update:function(e){return this.mixer.update(e||0),this.currentAnimationAction&&this.currentAnimationAction.paused&&(this.pause(),this.currentAnimation&&this.currentAnimation.onComplete(this)),this},updateAnimations:function(e,t){if(this.playing&&this.stop(),this.mixer&&THREE.SEA3D.AnimationHandler.remove(this),this.mixer=t,this.relative=!1,this.playing=!1,this.paused=!1,this.timeScale=1,this.animations=[],this.animation={},this.clips=[],e)for(var i=0;i<e.length;i++)this.addAnimation(e[i]);return this},addAnimation:function(e){return e instanceof THREE.AnimationClip&&(this.clips.push(e),e=new THREE.SEA3D.Animation(e)),this.animations.push(e),this.animation[e.name]=e,e.mixer=this.mixer,e},removeAnimation:function(e){return e instanceof THREE.AnimationClip&&(e=this.getAnimationByClip(e)),this.clips.splice(this.clips.indexOf(e.clip),1),delete this.animation[e.name],this.animations.splice(this.animations.indexOf(e),1),e.mixer=null,e},getAnimationByClip:function(e){for(var t=0;t<this.animations.length;t++)if(this.animations[t].clip===e)return e},getAnimationByName:function(e){return"number"==typeof e?this.animations[e]:this.animation[e]},setAnimationWeight:function(e,t){this.mixer.clipAction(this.getAnimationByName(e).clip).setEffectiveWeight(t)},getAnimationWeight:function(e){return this.mixer.clipAction(this.getAnimationByName(e).clip).getEffectiveWeight()},pause:function(){return this.playing&&this.currentAnimation&&(THREE.SEA3D.AnimationHandler.remove(this),this.playing=!1),this},resume:function(){return!this.playing&&this.currentAnimation&&(THREE.SEA3D.AnimationHandler.add(this),this.playing=!0),this},setTimeScale:function(e){return this.timeScale=e,this.currentAnimationAction&&this.updateTimeScale(),this},getTimeScale:function(){return this.timeScale},updateTimeScale:function(){return this.currentAnimationAction.setEffectiveTimeScale(this.timeScale*(this.currentAnimation?this.currentAnimation.timeScale:1)),this},play:function(e,t,i,r){var n=this.getAnimationByName(e);if(!n)throw new Error('Animation "'+e+'" not found.');return n==this.currentAnimation?(void 0===i&&n.repeat||(this.currentAnimationAction.time=void 0!==i?i:this.currentAnimationAction.timeScale>=0?0:this.currentAnimation.duration),this.currentAnimationAction.setEffectiveWeight(void 0!==r?r:1),this.currentAnimationAction.paused=!1,this.resume()):(this.previousAnimation=this.currentAnimation,this.currentAnimation=n,this.previousAnimationAction=this.currentAnimationAction,this.currentAnimationAction=this.mixer.clipAction(n.clip).setLoop(n.repeat?THREE.LoopRepeat:THREE.LoopOnce,1/0).reset(),this.currentAnimationAction.clampWhenFinished=!n.repeat,this.currentAnimationAction.paused=!1,this.updateTimeScale(),void 0===i&&n.repeat||(this.currentAnimationAction.time=void 0!==i?i:this.currentAnimationAction.timeScale>=0?0:this.currentAnimation.duration),this.currentAnimationAction.setEffectiveWeight(void 0!==r?r:1),this.currentAnimationAction.play(),this.playing||this.mixer.update(0),this.playing=!0,this.previousAnimation&&this.previousAnimationAction.crossFadeTo(this.currentAnimationAction,t||0,!1),THREE.SEA3D.AnimationHandler.add(this),this)},stop:function(){return this.playing&&THREE.SEA3D.AnimationHandler.remove(this),this.currentAnimation&&(this.currentAnimationAction.stop(),this.previousAnimation=this.currentAnimation,this.previousAnimationAction=this.currentAnimationAction,delete this.currentAnimationAction,delete this.currentAnimation,this.playing=!1),this},playw:function(e,t){this.playing||this.paused||THREE.SEA3D.AnimationHandler.add(this);var i=this.getAnimationByName(e);this.playing=!0;var r=this.mixer.clipAction(i.clip);return r.setLoop(i.repeat?THREE.LoopRepeat:THREE.LoopOnce,1/0).reset(),r.clampWhenFinished=!i.repeat,r.paused=!1,r.setEffectiveWeight(t).play(),r},crossFade:function(e,t,i,r){this.mixer.stopAllAction();var n=this.playw(e,1),o=this.playw(t,1);return n.crossFadeTo(o,i,void 0!==r&&r),this},stopAll:function(){return this.stop().mixer.stopAllAction(),this.playing=!1,this},unPauseAll:function(){return this.mixer.timeScale=1,this.playing=!0,this.paused=!1,this},pauseAll:function(){return this.mixer.timeScale=0,this.playing=!1,this.paused=!0,this},setRelative:function(e){if(this.relative!=e)return this.stop(),this.relative=e,this},getRelative:function(){return this.relative},copyFrom:function(e){for(var t=0;t<this.animations.length;t++)this.animations[t].timeScale=e.animations[t].timeScale;return this}}),THREE.SEA3D.Object3DAnimator=function(e,t){this.object3d=t,THREE.SEA3D.Animator.call(this,e,new THREE.AnimationMixer(t)),this.clone=function(e){return new this.constructor(this.clips,e).copyFrom(this)}.bind(this)},THREE.SEA3D.Object3DAnimator.prototype=Object.assign(Object.create(THREE.SEA3D.Animator.prototype),{constructor:THREE.SEA3D.Object3DAnimator,stop:function(){if(this.currentAnimation){var e=this.object3d.animate;e&&this instanceof THREE.SEA3D.Object3DAnimator&&(e.position.set(0,0,0),e.quaternion.set(0,0,0,1),e.scale.set(1,1,1))}THREE.SEA3D.Animator.prototype.stop.call(this)},setRelative:function(e){THREE.SEA3D.Animator.prototype.setRelative.call(this,e),this.object3d.setAnimator(this.relative),this.updateAnimations(this.clips,new THREE.AnimationMixer(this.relative?this.object3d.animate:this.object3d))}}),THREE.SEA3D.CameraAnimator=function(e,t){THREE.SEA3D.Object3DAnimator.call(this,e,t)},THREE.SEA3D.CameraAnimator.prototype=Object.assign(Object.create(THREE.SEA3D.Object3DAnimator.prototype),{constructor:THREE.SEA3D.CameraAnimator}),THREE.SEA3D.SoundAnimator=function(e,t){THREE.SEA3D.Object3DAnimator.call(this,e,t)},THREE.SEA3D.SoundAnimator.prototype=Object.assign(Object.create(THREE.SEA3D.Object3DAnimator.prototype),{constructor:THREE.SEA3D.SoundAnimator}),THREE.SEA3D.LightAnimator=function(e,t){THREE.SEA3D.Object3DAnimator.call(this,e,t)},THREE.SEA3D.LightAnimator.prototype=Object.assign(Object.create(THREE.SEA3D.Object3DAnimator.prototype),{constructor:THREE.SEA3D.LightAnimator}),THREE.SEA3D.Object3D=function(){THREE.Object3D.call(this)},THREE.SEA3D.Object3D.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:THREE.SEA3D.Object3D,updateAnimateMatrix:function(e){!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==e||(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.animate.updateMatrix(),this.matrixWorld.multiplyMatrices(this.matrixWorld,this.animate.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=0,i=this.children.length;t<i;t++)this.children[t].updateMatrixWorld(e)},setAnimator:function(e){this.getAnimator()!=e&&(e?(this.animate=new THREE.Object3D,this.updateMatrixWorld=THREE.SEA3D.Object3D.prototype.updateAnimateMatrix):(delete this.animate,this.updateMatrixWorld=THREE.Object3D.prototype.updateMatrixWorld),this.matrixWorldNeedsUpdate=!0)},getAnimator:function(){return void 0!=this.animate},copy:function(e){return THREE.Object3D.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this}}),THREE.SEA3D.Dummy=function(e,t,i){this.width=void 0!=e?e:100,this.height=void 0!=t?t:100,this.depth=void 0!=i?i:100;var r=new THREE.BoxGeometry(this.width,this.height,this.depth,1,1,1);r.computeBoundingBox(),r.computeBoundingSphere(),THREE.Mesh.call(this,r,THREE.SEA3D.Dummy.MATERIAL)},THREE.SEA3D.Dummy.MATERIAL=new THREE.MeshBasicMaterial({wireframe:!0,color:THREE.SEA3D.HELPER_COLOR}),THREE.SEA3D.Dummy.prototype=Object.assign(Object.create(THREE.Mesh.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.Dummy,copy:function(e){return THREE.Mesh.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this},dispose:function(){this.geometry.dispose()}}),THREE.SEA3D.Mesh=function(e,t){THREE.Mesh.call(this,e,t)},THREE.SEA3D.Mesh.prototype=Object.assign(Object.create(THREE.Mesh.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.Mesh,setWeight:function(e,t){var i="number"==typeof e?e:this.morphTargetDictionary[e];this.morphTargetInfluences[i]=t},getWeight:function(e){var t="number"==typeof e?e:this.morphTargetDictionary[e];return this.morphTargetInfluences[t]},copy:function(e){return THREE.Mesh.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this}}),THREE.SEA3D.SkinnedMesh=function(e,t,i){THREE.SkinnedMesh.call(this,e,t,i),this.updateAnimations(e.animations,new THREE.AnimationMixer(this))},THREE.SEA3D.SkinnedMesh.prototype=Object.assign(Object.create(THREE.SkinnedMesh.prototype),THREE.SEA3D.Mesh.prototype,THREE.SEA3D.Animator.prototype,{constructor:THREE.SEA3D.SkinnedMesh,boneByName:function(e){for(var t=this.skeleton.bones,i=0,r=t.length;i<r;i++)if(e==t[i].name)return t[i]},copy:function(e){return THREE.SkinnedMesh.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this}}),THREE.SEA3D.VertexAnimationMesh=function(e,t){THREE.Mesh.call(this,e,t),this.type="MorphAnimMesh",this.updateAnimations(e.animations,new THREE.AnimationMixer(this))},THREE.SEA3D.VertexAnimationMesh.prototype=Object.assign(Object.create(THREE.Mesh.prototype),THREE.SEA3D.Mesh.prototype,THREE.SEA3D.Animator.prototype,{constructor:THREE.SEA3D.VertexAnimationMesh,copy:function(e){return THREE.Mesh.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this}}),THREE.SEA3D.Camera=function(e,t,i,r){THREE.PerspectiveCamera.call(this,e,t,i,r)},THREE.SEA3D.Camera.prototype=Object.assign(Object.create(THREE.PerspectiveCamera.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.Camera,copy:function(e){return THREE.PerspectiveCamera.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this}}),THREE.SEA3D.OrthographicCamera=function(e,t,i,r,n,o){THREE.OrthographicCamera.call(this,e,t,i,r,n,o)},THREE.SEA3D.OrthographicCamera.prototype=Object.assign(Object.create(THREE.OrthographicCamera.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.OrthographicCamera,copy:function(e){return THREE.OrthographicCamera.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this}}),THREE.SEA3D.PointLight=function(e,t,i,r){THREE.PointLight.call(this,e,t,i,r)},THREE.SEA3D.PointLight.prototype=Object.assign(Object.create(THREE.PointLight.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.PointLight,copy:function(e){return THREE.PointLight.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this}}),THREE.SEA3D.PointSound=function(e){THREE.PositionalAudio.call(this,e)},THREE.SEA3D.PointSound.prototype=Object.assign(Object.create(THREE.PositionalAudio.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.PointSound,copy:function(e){return THREE.PositionalAudio.prototype.copy.call(this,e),this.attribs=e.attribs,this.scripts=e.scripts,e.animator&&(this.animator=e.animator.clone(this)),this}}),THREE.SEA3D.AnimationHandler={animators:[],update:function(e){for(var t=0;t<this.animators.length;)this.animators[t++].update(e)},add:function(e){-1===this.animators.indexOf(e)&&this.animators.push(e)},remove:function(e){var t=this.animators.indexOf(e);-1!==t&&this.animators.splice(t,1)}},THREE.SEA3D.Domain.prototype.getMesh=THREE.SEA3D.prototype.getMesh=function(e){return this.objects["m3d/"+e]},THREE.SEA3D.Domain.prototype.getDummy=THREE.SEA3D.prototype.getDummy=function(e){return this.objects["dmy/"+e]},THREE.SEA3D.Domain.prototype.getLine=THREE.SEA3D.prototype.getLine=function(e){return this.objects["line/"+e]},THREE.SEA3D.Domain.prototype.getSound3D=THREE.SEA3D.prototype.getSound3D=function(e){return this.objects["sn3d/"+e]},THREE.SEA3D.Domain.prototype.getMaterial=THREE.SEA3D.prototype.getMaterial=function(e){return this.objects["mat/"+e]},THREE.SEA3D.Domain.prototype.getLight=THREE.SEA3D.prototype.getLight=function(e){return this.objects["lht/"+e]},THREE.SEA3D.Domain.prototype.getGLSL=THREE.SEA3D.prototype.getGLSL=function(e){return this.objects["glsl/"+e]},THREE.SEA3D.Domain.prototype.getCamera=THREE.SEA3D.prototype.getCamera=function(e){return this.objects["cam/"+e]},THREE.SEA3D.Domain.prototype.getTexture=THREE.SEA3D.prototype.getTexture=function(e){return this.objects["tex/"+e]},THREE.SEA3D.Domain.prototype.getCubeMap=THREE.SEA3D.prototype.getCubeMap=function(e){return this.objects["cmap/"+e]},THREE.SEA3D.Domain.prototype.getJointObject=THREE.SEA3D.prototype.getJointObject=function(e){return this.objects["jnt/"+e]},THREE.SEA3D.Domain.prototype.getContainer3D=THREE.SEA3D.prototype.getContainer3D=function(e){return this.objects["c3d/"+e]},THREE.SEA3D.Domain.prototype.getSprite=THREE.SEA3D.prototype.getSprite=function(e){return this.objects["m2d/"+e]},THREE.SEA3D.Domain.prototype.getProperties=THREE.SEA3D.prototype.getProperties=function(e){return this.objects["prop/"+e]},THREE.SEA3D.prototype.isPowerOfTwo=function(e){return!!e&&(e&-e)==e},THREE.SEA3D.prototype.nearestPowerOfTwo=function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},THREE.SEA3D.prototype.updateTransform=function(e,t){var i=THREE.SEA3D.MTXBUF,r=THREE.SEA3D.VECBUF;t.transform?i.fromArray(t.transform):i.makeTranslation(t.position.x,t.position.y,t.position.z),e.position.setFromMatrixPosition(i),e.scale.setFromMatrixScale(i),i.scale(r.set(1/e.scale.x,1/e.scale.y,1/e.scale.z)),e.rotation.setFromRotationMatrix(i),(this.config.forceStatic||t.isStatic)&&(e.updateMatrix(),e.matrixAutoUpdate=!1)},THREE.SEA3D.prototype.toVector3=function(e){return new THREE.Vector3(e.x,e.y,e.z)},THREE.SEA3D.prototype.toFaces=function(e){var t=[];return t[0]=e[1],t[1]=e[0],t[2]=e[3],t[3]=e[2],t[4]=e[5],t[5]=e[4],t},THREE.SEA3D.prototype.updateScene=function(){if(void 0!=this.materials)for(var e=0,t=this.materials.length;e<t;++e)this.materials[e].needsUpdate=!0},THREE.SEA3D.prototype.addSceneObject=function(e,t){(t=t||e.tag).visible=e.visible,e.parent?e.parent.tag.add(t):this.config.container&&this.config.container.add(t),e.attributes&&(t.attribs=e.attributes.tag),e.scripts&&(t.scripts=this.getJSMList(t,e.scripts),this.config.runScripts&&this.domain.runJSMList(t))},THREE.SEA3D.prototype.createObjectURL=function(e,t){return(window.URL||window.webkitURL).createObjectURL(new Blob([e],{type:t}))},THREE.SEA3D.prototype.bufferToTexture=function(e){return this.createObjectURL(e,"image")},THREE.SEA3D.prototype.bufferToSound=function(e){return this.createObjectURL(e,"audio")},THREE.SEA3D.prototype.parsePath=function(e){var t=this.config.paths;for(var i in t)e=e.replace(new RegExp("%"+i+"%","g"),t[i]);return e},THREE.SEA3D.prototype.addDefaultAnimation=function(e,t){for(var i=e.tag,r=0,n=e.animations?e.animations.length:0;r<n;r++){var o=e.animations[r];switch(o.tag.type){case SEA3D.Animation.prototype.type:var a=o.tag.tag||this.getAnimationType({sea:o.tag,scope:i,relative:o.relative});return i.animator=new t(a,i),i.animator.setRelative(o.relative),this.config.autoPlay&&i.animator.play(0),i.animator}}},THREE.SEA3D.prototype.readGeometryBuffer=function(e){for(var t=new THREE.BufferGeometry,i=0;i<e.groups.length;i++){var r=e.groups[i];t.addGroup(r.start,r.count,i)}t.setIndex(new THREE.BufferAttribute(e.indexes,1)),t.addAttribute("position",new THREE.BufferAttribute(e.vertex,3)),e.uv&&(t.addAttribute("uv",new THREE.BufferAttribute(e.uv[0],2)),e.uv.length>1&&t.addAttribute("uv2",new THREE.BufferAttribute(e.uv[1],2))),e.normal?t.addAttribute("normal",new THREE.BufferAttribute(e.normal,3)):t.computeVertexNormals(),e.tangent4&&t.addAttribute("tangent",new THREE.BufferAttribute(e.tangent4,4)),e.color&&t.addAttribute("color",new THREE.BufferAttribute(e.color[0],e.numColor)),e.joint&&(t.addAttribute("skinIndex",new THREE.Float32BufferAttribute(e.joint,e.jointPerVertex)),t.addAttribute("skinWeight",new THREE.Float32BufferAttribute(e.weight,e.jointPerVertex))),this.config.bounding&&(t.computeBoundingBox(),t.computeBoundingSphere()),t.name=e.name,this.domain.geometries=this.geometries=this.geometries||[],this.geometries.push(this.objects["geo/"+e.name]=e.tag=t)},THREE.SEA3D.prototype.readDummy=function(e){var t=new THREE.SEA3D.Dummy(e.width,e.height,e.depth);t.name=e.name,this.domain.dummys=this.dummys=this.dummys||[],this.dummys.push(this.objects["dmy/"+e.name]=e.tag=t),this.addSceneObject(e),this.updateTransform(t,e),this.addDefaultAnimation(e,THREE.SEA3D.Object3DAnimator)},THREE.SEA3D.prototype.readLine=function(e){var t=new THREE.BufferGeometry;e.closed&&e.vertex.push(e.vertex[0],e.vertex[1],e.vertex[2]),t.addAttribute("position",new THREE.Float32BufferAttribute(e.vertex,3));var i=new THREE.Line(t,new THREE.LineBasicMaterial({color:THREE.SEA3D.HELPER_COLOR,linewidth:3}));i.name=e.name,this.lines=this.lines||[],this.lines.push(this.objects["line/"+e.name]=e.tag=i),this.addSceneObject(e),this.updateTransform(i,e),this.addDefaultAnimation(e,THREE.SEA3D.Object3DAnimator)},THREE.SEA3D.prototype.readContainer3D=function(e){var t=new THREE.SEA3D.Object3D;this.domain.containers=this.containers=this.containers||[],this.containers.push(this.objects["c3d/"+e.name]=e.tag=t),this.addSceneObject(e),this.updateTransform(t,e),this.addDefaultAnimation(e,THREE.SEA3D.Object3DAnimator)},THREE.SEA3D.prototype.readSprite=function(e){var t;e.material&&(e.material.tag.sprite?t=e.material.tag.sprite:(t=e.material.tag.sprite=new THREE.SpriteMaterial,this.setBlending(t,e.blendMode),t.map=e.material.tag.map,t.map.flipY=!0,t.color.set(e.material.tag.color),t.opacity=e.material.tag.opacity,t.fog=e.material.receiveFog));var i=new THREE.Sprite(t);i.name=e.name,this.domain.sprites=this.sprites=this.sprites||[],this.sprites.push(this.objects["m2d/"+e.name]=e.tag=i),this.addSceneObject(e),this.updateTransform(i,e),i.scale.set(e.width,e.height,1)},THREE.SEA3D.prototype.readMesh=function(e){var t,i,r,n,o,a,s,c,l=e.geometry.tag;for(t=0,i=e.modifiers?e.modifiers.length:0;t<i;t++){var h=e.modifiers[t];switch(h.type){case SEA3D.Skeleton.prototype.type:case SEA3D.SkeletonLocal.prototype.type:o=h,l.bones=o.tag;break;case SEA3D.Morph.prototype.type:c=h,l.morphAttributes=c.tag.attribs,l.morphTargets=c.tag.targets}}for(t=0,i=e.animations?e.animations.length:0;t<i;t++){var u=e.animations[t];switch(u.tag.type){case SEA3D.SkeletonAnimation.prototype.type:a=u.tag,l.animations=a.tag||this.getAnimationType({sea:a,skeleton:o,relative:!0});break;case SEA3D.VertexAnimation.prototype.type:s=u.tag,l.morphAttributes=s.tag.attribs,l.morphTargets=s.tag.targets,l.animations=s.tag.animations}}var d=void 0!=c||void 0!=s,p=c&&void 0!=c.tag.attribs.normal||s&&void 0!=s.tag.attribs.normal;if(e.material)if(e.material.length>1){var f=[];for(t=0;t<e.material.length;t++)f[t]=e.material[t].tag,f[t].skinning=void 0!=o,f[t].morphTargets=d,f[t].morphNormals=p,f[t].vertexColors=e.geometry.color?THREE.VertexColors:THREE.NoColors;n=f}else(n=e.material[0].tag).skinning=void 0!=o,n.morphTargets=d,n.morphNormals=p,n.vertexColors=e.geometry.color?THREE.VertexColors:THREE.NoColors;o?(r=new THREE.SEA3D.SkinnedMesh(l,n,this.config.useVertexTexture),this.config.autoPlay&&a&&r.play(0)):s?(r=new THREE.SEA3D.VertexAnimationMesh(l,n,s.frameRate),this.config.autoPlay&&r.play(0)):r=new THREE.SEA3D.Mesh(l,n),r.name=e.name,r.castShadow=e.castShadows,r.receiveShadow=!e.material||e.material[0].receiveShadows,this.domain.meshes=this.meshes=this.meshes||[],this.meshes.push(this.objects["m3d/"+e.name]=e.tag=r),this.addSceneObject(e),this.updateTransform(r,e),this.addDefaultAnimation(e,THREE.SEA3D.Object3DAnimator)},THREE.SEA3D.prototype.readSoundPoint=function(e){this.audioListener||(this.audioListener=new THREE.AudioListener,this.config.container&&this.config.container.add(this.audioListener));var t=new THREE.SEA3D.PointSound(this.audioListener);(new THREE.AudioLoader).load(e.sound.tag,function(e){t.setBuffer(e)}),t.autoplay=e.autoPlay,t.setLoop(e.autoPlay),t.setVolume(e.volume),t.setRefDistance(e.distance),t.setRolloffFactor(this.config.audioRolloffFactor),t.name=e.name,this.domain.sounds3d=this.sounds3d=this.sounds3d||[],this.sounds3d.push(this.objects["sn3d/"+e.name]=e.tag=t),this.addSceneObject(e),this.updateTransform(t,e),this.addDefaultAnimation(e,THREE.SEA3D.SoundAnimator)},THREE.SEA3D.prototype.readCubeRender=function(e){var t=new THREE.CubeCamera(.1,5e3,THREE.SEA3D.RTT_SIZE);t.renderTarget.cubeCamera=t,e.tag=t.renderTarget,this.domain.cubeRenderers=this.cubeRenderers=this.cubeRenderers||[],this.cubeRenderers.push(this.objects["rttc/"+e.name]=t),this.addSceneObject(e,t),this.updateTransform(t,e)},THREE.SEA3D.prototype.readTexture=function(e){var t=new Image,i=new THREE.Texture;i.name=e.name,i.wrapS=i.wrapT=THREE.RepeatWrapping,i.flipY=!1,i.image=t,void 0!==this.config.anisotropy&&(i.anisotropy=this.config.anisotropy),t.onload=function(){i.needsUpdate=!0},t.src=this.bufferToTexture(e.data.buffer),this.domain.textures=this.textures=this.textures||[],this.textures.push(this.objects["tex/"+e.name]=e.tag=i)},THREE.SEA3D.prototype.readCubeMap=function(e){var t=this.toFaces(e.faces),i=new THREE.CubeTexture([]),r=0;i.name=e.name,i.flipY=!1,i.format=THREE.RGBFormat;for(var n=function(){6==++r&&(i.needsUpdate=!0,this.config.async||(this.file.resume=!0))}.bind(this),o=0;o<t.length;++o){var a=new Image;a.onload=n,a.src=this.bufferToTexture(t[o].buffer),i.images[o]=a}this.config.async||(this.file.resume=!1),this.domain.cubemaps=this.cubemaps=this.cubemaps||[],this.cubemaps.push(this.objects["cmap/"+e.name]=e.tag=i)},THREE.SEA3D.prototype.readSound=function(e){var t=this.bufferToSound(e.data.buffer);this.domain.sounds=this.sounds=this.sounds||[],this.sounds.push(this.objects["snd/"+e.name]=e.tag=t)},THREE.SEA3D.prototype.readScriptURL=function(e){this.file.resume=!1,(new THREE.FileLoader).setResponseType("text").load(e.url,function(t){this.file.resume=!0,this.domain.scripts=this.scripts=this.scripts||[],this.scripts.push(this.objects["src/"+e.name]=e.tag=t)}.bind(this))},THREE.SEA3D.prototype.readTextureURL=function(e){var t=(new THREE.TextureLoader).load(this.parsePath(e.url));t.name=e.name,t.wrapS=t.wrapT=THREE.RepeatWrapping,t.flipY=!1,void 0!==this.config.anisotropy&&(t.anisotropy=this.config.anisotropy),this.domain.textures=this.textures=this.textures||[],this.textures.push(this.objects["tex/"+e.name]=e.tag=t)},THREE.SEA3D.prototype.readCubeMapURL=function(e){for(var t=this.toFaces(e.faces),i=0;i<t.length;i++)t[i]=this.parsePath(t[i]);var r;if("hdr"==t[0].substr(-3)){var n=null!=THREE.PMREMGenerator;this.file.resume=!n,r=(new THREE.HDRCubeTextureLoader).load(THREE.UnsignedByteType,t,function(t){if(n){var i=new THREE.PMREMGenerator(t);i.update(this.config.renderer);var r=new THREE.PMREMCubeUVPacker(i.cubeLods);r.update(this.config.renderer),t.dispose(),this.objects["cmap/"+e.name]=e.tag=r.CubeUVRenderTarget.texture,this.file.resume=!0}}.bind(this))}else r=(new THREE.CubeTextureLoader).load(t);r.name=e.name,r.wrapS=r.wrapT=THREE.RepeatWrapping,r.flipY=!1,void 0!==this.config.anisotropy&&(r.anisotropy=this.config.anisotropy),this.domain.cubemaps=this.cubemaps=this.cubemaps||[],this.cubemaps.push(this.objects["cmap/"+e.name]=e.tag=r)},THREE.SEA3D.prototype.getJSMList=function(e,t){for(var i=[],r=0;r<t.length;r++){var n=t[r];n.tag.type==SEA3D.JavaScriptMethod.prototype.type&&i.push(n)}return this.domain.scriptTargets=this.scriptTargets=this.scriptTargets||[],this.scriptTargets.push(e),i},THREE.SEA3D.prototype.readJavaScriptMethod=function(sea){try{var src="(function() {\nvar $METHOD = {}\n",declare='function($INC, $REF, global, local, $his, $PARAM) {\nvar watch = $INC["watch"],\nscene = $INC["scene"],\nsea3d = $INC["sea3d"],\nprint = $INC["print"];\n';for(var name in declare+='var $SRC = $INC["source"],\naddEventListener = $SRC.addEventListener.bind( $SRC ),\nhasEventListener = $SRC.hasEventListener.bind( $SRC ),\nremoveEventListener = $SRC.removeEventListener.bind( $SRC ),\ndispatchEvent = $SRC.dispatchEvent.bind( $SRC ),\ndispose = $SRC.dispose.bind( $SRC );\n',sea.methods)src+='$METHOD["'+name+'"] = '+declare+sea.methods[name].src+"}\n";src+="return $METHOD; })",this.domain.methods=eval(src)()}catch(e){console.error('SEA3D JavaScriptMethod: Error running "'+sea.name+'".'),console.error(e)}},THREE.SEA3D.prototype.readGLSL=function(e){this.domain.glsl=this.glsl=this.glsl||[],this.glsl.push(this.objects["glsl/"+e.name]=e.tag=e.src)},THREE.SEA3D.prototype.materialTechnique=function(){var e={onComplete:function(e,t){(t.alpha<1||e.blending>THREE.NormalBlending)&&(e.opacity=t.alpha,e.transparent=!0)}};return e[SEA3D.Material.PHYSICAL]=function(e,t){e.color.setHex(t.color),e.roughness=t.roughness,e.metalness=t.metalness},e[SEA3D.Material.REFLECTIVITY]=function(e,t){e.reflectivity=t.strength},e[SEA3D.Material.CLEAR_COAT]=function(e,t){e.clearCoat=t.strength,e.clearCoatRoughness=t.roughness},e[SEA3D.Material.PHONG]=function(e,t){e.color.setHex(t.diffuseColor),e.specular.setHex(t.specularColor).multiplyScalar(t.specular),e.shininess=t.gloss},e[SEA3D.Material.DIFFUSE_MAP]=function(e,t,i){e.map=t.texture.tag,e.color.setHex(16777215),e.map.wrapS=e.map.wrapT=i.repeat?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,t.texture.transparent&&(e.transparent=!0)},e[SEA3D.Material.ROUGHNESS_MAP]=function(e,t){e.roughnessMap=t.texture.tag},e[SEA3D.Material.METALNESS_MAP]=function(e,t){e.metalnessMap=t.texture.tag},e[SEA3D.Material.SPECULAR_MAP]=function(e,t){e.specular&&(e.specularMap=t.texture.tag,e.specular.setHex(16777215))},e[SEA3D.Material.NORMAL_MAP]=function(e,t){e.normalMap=t.texture.tag},e[SEA3D.Material.REFLECTION]=e[SEA3D.Material.FRESNEL_REFLECTION]=function(e,t){e.envMap=t.texture.tag,e.envMap.mapping=THREE.CubeReflectionMapping,e.combine=THREE.MixOperation,e.reflectivity=t.alpha},e[SEA3D.Material.REFLECTION_SPHERICAL]=function(e,t){e.envMap=t.texture.tag,e.envMap.mapping=THREE.SphericalReflectionMapping,e.combine=THREE.MixOperation,e.reflectivity=t.alpha},e[SEA3D.Material.REFRACTION_MAP]=function(e,t){e.envMap=t.texture.tag,e.envMap.mapping=THREE.CubeRefractionMapping,e.refractionRatio=t.ior,e.reflectivity=t.alpha},e[SEA3D.Material.LIGHT_MAP]=function(e,t){"multiply"==t.blendMode?e.aoMap=t.texture.tag:e.lightMap=t.texture.tag},e[SEA3D.Material.EMISSIVE]=function(e,t){e.emissive.setHex(t.color)},e[SEA3D.Material.EMISSIVE_MAP]=function(e,t){e.emissiveMap=t.texture.tag},e[SEA3D.Material.ALPHA_MAP]=function(e,t,i){e.alphaMap=t.texture.tag,e.transparent=!0,e.alphaMap.wrapS=e.alphaMap.wrapT=i.repeat?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping},e}(),THREE.SEA3D.prototype.createMaterial=function(e){return e.tecniquesDict[SEA3D.Material.REFLECTIVITY]||e.tecniquesDict[SEA3D.Material.CLEAR_COAT]?new THREE.MeshPhysicalMaterial:e.tecniquesDict[SEA3D.Material.PHYSICAL]?new THREE.MeshStandardMaterial:new THREE.MeshPhongMaterial},THREE.SEA3D.prototype.setBlending=function(e,t){if("normal"!==t){switch(t){case"add":e.blending=THREE.AdditiveBlending;break;case"subtract":e.blending=THREE.SubtractiveBlending;break;case"multiply":e.blending=THREE.MultiplyBlending;break;case"screen":e.blending=THREE.CustomBlending,e.blendSrc=THREE.OneFactor,e.blendDst=THREE.OneMinusSrcColorFactor,e.blendEquation=THREE.AddEquation}e.transparent=!0}},THREE.SEA3D.prototype.readMaterial=function(e){var t=this.createMaterial(e);t.name=e.name,t.depthWrite=e.depthWrite,t.depthTest=e.depthTest,t.premultipliedAlpha=e.premultipliedAlpha,t.side=e.bothSides?THREE.DoubleSide:THREE.FrontSide,this.setBlending(t,e.blendMode);for(var i=0;i<e.technique.length;i++){var r=e.technique[i];this.materialTechnique[r.kind]&&this.materialTechnique[r.kind].call(this,t,r,e)}this.materialTechnique.onComplete&&this.materialTechnique.onComplete.call(this,t,e),this.domain.materials=this.materials=this.materials||[],this.materials.push(this.objects["mat/"+e.name]=e.tag=t)},THREE.SEA3D.prototype.readPointLight=function(e){var t=new THREE.SEA3D.PointLight(e.color,e.multiplier*this.config.multiplier);t.name=e.name,e.attenuation&&(t.distance=e.attenuation.end),e.shadow&&this.setShadowMap(t),this.domain.lights=this.lights=this.lights||[],this.lights.push(this.objects["lht/"+e.name]=e.tag=t),this.addSceneObject(e),this.updateTransform(t,e),this.addDefaultAnimation(e,THREE.SEA3D.LightAnimator),this.updateScene()},THREE.SEA3D.prototype.readHemisphereLight=function(e){var t=new THREE.HemisphereLight(e.color,e.secondColor,e.multiplier*this.config.multiplier);t.position.set(0,500,0),t.name=e.name,this.domain.lights=this.lights=this.lights||[],this.lights.push(this.objects["lht/"+e.name]=e.tag=t),this.addSceneObject(e),this.addDefaultAnimation(e,THREE.SEA3D.LightAnimator),this.updateScene()},THREE.SEA3D.prototype.readAmbientLight=function(e){var t=new THREE.AmbientLight(e.color,e.multiplier*this.config.multiplier);t.name=e.name,this.domain.lights=this.lights=this.lights||[],this.lights.push(this.objects["lht/"+e.name]=e.tag=t),this.addSceneObject(e),this.addDefaultAnimation(e,THREE.SEA3D.LightAnimator),this.updateScene()},THREE.SEA3D.prototype.readDirectionalLight=function(e){var t=new THREE.DirectionalLight(e.color,e.multiplier*this.config.multiplier);t.name=e.name,e.shadow&&this.setShadowMap(t),this.domain.lights=this.lights=this.lights||[],this.lights.push(this.objects["lht/"+e.name]=e.tag=t),this.addSceneObject(e),this.updateTransform(t,e),this.addDefaultAnimation(e,THREE.SEA3D.LightAnimator),this.updateScene()},THREE.SEA3D.prototype.readCamera=function(e){var t=new THREE.SEA3D.Camera(e.fov);t.name=e.name,this.domain.cameras=this.cameras=this.cameras||[],this.cameras.push(this.objects["cam/"+e.name]=e.tag=t),this.addSceneObject(e),this.updateTransform(t,e),this.addDefaultAnimation(e,THREE.SEA3D.CameraAnimator)},THREE.SEA3D.prototype.readOrthographicCamera=function(e){var t,i,r,n=void 0!==this.config.stageWidth?this.config.stageWidth:window?window.innerWidth:1024,o=void 0!==this.config.stageHeight?this.config.stageHeight:window?window.innerHeight:1024;n>o?(t=n/o,i=e.height*t,r=e.height):(t=o/n,i=e.height,r=e.height*t);var a=new THREE.SEA3D.OrthographicCamera(-i,i,r,-r);a.name=e.name,this.domain.cameras=this.cameras=this.cameras||[],this.cameras.push(this.objects["cam/"+e.name]=e.tag=a),this.addSceneObject(e),this.updateTransform(a,e),this.addDefaultAnimation(e,THREE.SEA3D.CameraAnimator)},THREE.SEA3D.prototype.readSkeletonLocal=function(e){for(var t=[],i=0;i<e.joint.length;i++){var r=e.joint[i];t[i]={name:r.name,pos:[r.x,r.y,r.z],rotq:[r.qx,r.qy,r.qz,r.qw],parent:r.parentIndex}}e.tag=t},THREE.SEA3D.prototype.readJointObject=function(e){var t=e.target.tag.skeleton.bones[e.joint];this.domain.joints=this.joints=this.joints||[],this.joints.push(this.objects["jnt/"+e.name]=e.tag=t)},THREE.SEA3D.prototype.readMorpher=function(e){for(var t={position:[]},i=[],r=0;r<e.node.length;r++){var n=e.node[r];t.position[r]=new THREE.Float32BufferAttribute(n.vertex,3),t.position[r].name=n.name,n.normal&&(t.normal=t.normal||[],t.normal[r]=new THREE.Float32BufferAttribute(n.normal,3)),i[r]={name:n.name}}e.tag={attribs:t,targets:i}},THREE.SEA3D.prototype.readAnimation=function(e){for(var t=[],i=1e3/e.frameRate/1e3,r=0;r<e.sequence.length;r++){for(var n=e.sequence[r],o=[],a=0;a<e.dataList.length;a++){var s,c,l,h,u=e.dataList[a],d=u.data,p=n.start*u.blockSize,f=p+n.count*u.blockSize,m=!!n.intrpl&&THREE.InterpolateLinear,g=null;switch(u.kind){case SEA3D.Animation.POSITION:g=".position";break;case SEA3D.Animation.ROTATION:g=".quaternion";break;case SEA3D.Animation.SCALE:g=".scale";break;case SEA3D.Animation.COLOR:g=".color";break;case SEA3D.Animation.MULTIPLIER:g=".intensity";break;case SEA3D.Animation.FOV:g=".fov"}if(g)switch(u.type){case SEA3D.Stream.BYTE:case SEA3D.Stream.UBYTE:case SEA3D.Stream.INT:case SEA3D.Stream.UINT:case SEA3D.Stream.FLOAT:case SEA3D.Stream.DOUBLE:case SEA3D.Stream.DECIMAL:for(h=d.subarray(p,f),l=new Float32Array(h.length),s=0,c=0;c<l.length;c++)l[c]=s,s+=i;o.push(new THREE.VectorKeyframeTrack(g,l,h,m));break;case SEA3D.Stream.VECTOR3D:for(h=d.subarray(p,f),l=new Float32Array(h.length/u.blockSize),s=0,c=0;c<l.length;c++)l[c]=s,s+=i;o.push(new THREE.VectorKeyframeTrack(g,l,h,m));break;case SEA3D.Stream.VECTOR4D:for(h=d.subarray(p,f),l=new Float32Array(h.length/u.blockSize),s=0,c=0;c<l.length;c++)l[c]=s,s+=i;o.push(new THREE.QuaternionKeyframeTrack(g,l,h,m));break;case SEA3D.Stream.INT24:case SEA3D.Stream.UINT24:for(h=new Float32Array(3*(f-p)),l=new Float32Array(h.length/3),s=0,c=0;c<l.length;c++)h[3*c]=(d[c]>>16&255)/255,h[3*c+1]=(d[c]>>8&255)/255,h[3*c+2]=(255&d[c])/255,l[c]=s,s+=i;o.push(new THREE.VectorKeyframeTrack(g,l,h,m))}}t.push(new THREE.SEA3D.AnimationClip(n.name,-1,o,n.repeat))}this.domain.clips=this.clips=this.clips||[],this.clips.push(this.objects[e.name+".anm"]=e.tag=t)},THREE.SEA3D.prototype.readSkeletonAnimation=function(e,t){for(var i=[],r=1e3/e.frameRate/1e3,n=0;n<e.sequence.length;n++){for(var o=e.sequence[n],a=o.start,s=a+o.count,c={name:o.name,fps:e.frameRate,length:r*o.count,hierarchy:[]},l=e.numJoints,h=e.raw,u=0;u<l;u++){for(var d={parent:t.joint[u].parentIndex,keys:[]},p=d.keys,f=0,m=a;m<s;m++){var g=m*l*7+7*u;p.push({time:f,pos:[h[g],h[g+1],h[g+2]],rot:[h[g+3],h[g+4],h[g+5],h[g+6]],scl:[1,1,1]}),f+=r}c.hierarchy[u]=d}i.push(THREE.SEA3D.AnimationClip.fromClip(THREE.AnimationClip.parseAnimation(c,t.tag),o.repeat))}this.domain.clips=this.clips=this.clips||[],this.clips.push(this.objects[e.name+".skla"]=e.tag=i)},THREE.SEA3D.prototype.readVertexAnimation=function(e){var t,i,r,n={position:[]},o=[],a=[];for(t=0,r=e.frame.length;t<r;t++){var s=e.frame[t];n.position[t]=new THREE.Float32BufferAttribute(s.vertex,3),s.normal&&(n.normal=n.normal||[],n.normal[t]=new THREE.Float32BufferAttribute(s.normal,3)),o[t]={name:t}}for(t=0;t<e.sequence.length;t++){var c=e.sequence[t],l=[];for(i=0;i<c.count;i++)l[i]=o[c.start+i];a.push(THREE.SEA3D.AnimationClip.fromClip(THREE.AnimationClip.CreateFromMorphTargetSequence(c.name,l,e.frameRate),c.repeat))}e.tag={attribs:n,targets:o,animations:a},this.domain.clips=this.clips=this.clips||[],this.clips.push(this.objects[e.name+".vtxa"]=e.tag)},THREE.SEA3D.prototype.getAnimationType=function(e){var t=e.sea;switch(t.type){case SEA3D.SkeletonAnimation.prototype.type:this.readSkeletonAnimation(t,e.skeleton)}return t.tag},THREE.SEA3D.prototype.applyEnvironment=function(e){for(var t=0,i=this.materials.length;t<i;++t){var r=this.materials[t];if(r instanceof THREE.MeshStandardMaterial){if(r.envMap)continue;r.envMap=e,r.envMap.mapping=THREE.CubeReflectionMapping,r.needsUpdate=!0}}},THREE.SEA3D.prototype.readActions=function(e){for(var t=0;t<e.actions.length;t++){var i=e.actions[t];switch(i.kind){case SEA3D.Actions.ATTRIBUTES:this.attribs=this.domain.attribs=i.attributes.tag;break;case SEA3D.Actions.SCRIPTS:this.domain.scripts=this.getJSMList(this.domain,i.scripts),this.config.runScripts&&this.domain.runJSMList(this.domain);break;case SEA3D.Actions.ENVIRONMENT_COLOR:this.domain.background=this.background=this.background||{},this.background.color=new THREE.Color(i.color);break;case SEA3D.Actions.ENVIRONMENT:this.domain.background=this.background=this.background||{},this.background.texture=i.texture.tag,this.config.useEnvironment&&void 0!=this.materials&&this.applyEnvironment(i.texture.tag)}}},THREE.SEA3D.Event={PROGRESS:"sea3d_progress",LOAD_PROGRESS:"sea3d_load",DOWNLOAD_PROGRESS:"sea3d_download",COMPLETE:"sea3d_complete",OBJECT_COMPLETE:"sea3d_object",PARSE_PROGRESS:"parse_progress",PARSE_COMPLETE:"parse_complete",ERROR:"sea3d_error"},THREE.SEA3D.prototype.onProgress=function(e){e.status=e.type,e.progress=e.loaded/e.total,e.type=THREE.SEA3D.Event.PROGRESS,this.dispatchEvent(e)},THREE.SEA3D.prototype.onLoadProgress=function(e){e.type=THREE.SEA3D.Event.LOAD_PROGRESS,this.dispatchEvent(e),this.onProgress(e)},THREE.SEA3D.prototype.onDownloadProgress=function(e){e.type=THREE.SEA3D.Event.DOWNLOAD_PROGRESS,this.dispatchEvent(e),this.onProgress(e)},THREE.SEA3D.prototype.onComplete=function(e){e.type=THREE.SEA3D.Event.COMPLETE,this.dispatchEvent(e)},THREE.SEA3D.prototype.onCompleteObject=function(e){e.type=THREE.SEA3D.Event.OBJECT_COMPLETE,this.dispatchEvent(e)},THREE.SEA3D.prototype.onParseProgress=function(e){e.type=THREE.SEA3D.Event.PARSE_PROGRESS,this.dispatchEvent(e)},THREE.SEA3D.prototype.onParseComplete=function(e){e.type=THREE.SEA3D.Event.PARSE_COMPLETE,this.dispatchEvent(e)},THREE.SEA3D.prototype.onError=function(e){e.type=THREE.SEA3D.Event.ERROR,this.dispatchEvent(e)},THREE.SEA3D.prototype.createDomain=function(){return this.domain=new THREE.SEA3D.Domain(this.config.id,this.objects={},this.config.container)},THREE.SEA3D.prototype.clone=function(e,t,i){if(!this.file.isDone())throw new Error("Previous parse is not completed.");this.config.container=e&&void 0!==e.container?e.container:new THREE.Object3D,e&&this.loadConfig(e);var r=this.config.timeLimit;return this.config.timeLimit=e&&void 0!==e.timeLimit?e.timeLimit:1/0,this.parse(t,i),this.config.timeLimit=r,this.domain},THREE.SEA3D.prototype.loadConfig=function(e){for(var t in e)this.config[t]=e[t]},THREE.SEA3D.prototype.parse=function(e,t){delete this.cameras,delete this.containers,delete this.lights,delete this.joints,delete this.meshes,delete this.materials,delete this.animationSets,delete this.sprites,delete this.sounds3d,delete this.cubeRenderers,delete this.sounds,delete this.glsl,delete this.dummy,delete this.background,delete this.domain,this.createDomain(),this.setTypeRead(),this.file.onParseComplete=function(t){this.config.manager&&this.config.manager.add(this.domain),(e||this.onParseComplete).call(this,t)}.bind(this),this.file.onParseProgress=t||this.onParseProgress;for(var i=THREE.SEA3D.EXTENSIONS_LOADER.length;i--;){var r=THREE.SEA3D.EXTENSIONS_LOADER[i];r.parse&&r.parse.call(this)}return this.file.parse(),this.domain},THREE.SEA3D.prototype.onHead=function(e){if("TJS"!=e.sign)throw new Error("Sign '"+e.sign+"' not supported! Use SEA3D Studio to publish or SEA3DLegacy.js")},THREE.SEA3D.EXTENSIONS_LOADER=[],THREE.SEA3D.EXTENSIONS_DOMAIN=[],THREE.SEA3D.prototype.setTypeRead=function(){this.file.typeRead={},this.file.typeRead[SEA3D.Geometry.prototype.type]=this.readGeometryBuffer,this.file.typeRead[SEA3D.Mesh.prototype.type]=this.readMesh,this.file.typeRead[SEA3D.Sprite.prototype.type]=this.readSprite,this.file.typeRead[SEA3D.Container3D.prototype.type]=this.readContainer3D,this.file.typeRead[SEA3D.Line.prototype.type]=this.readLine,this.file.typeRead[SEA3D.Material.prototype.type]=this.readMaterial,this.file.typeRead[SEA3D.Camera.prototype.type]=this.readCamera,this.file.typeRead[SEA3D.OrthographicCamera.prototype.type]=this.readOrthographicCamera,this.file.typeRead[SEA3D.SkeletonLocal.prototype.type]=this.readSkeletonLocal,this.file.typeRead[SEA3D.JointObject.prototype.type]=this.readJointObject,this.file.typeRead[SEA3D.CubeMap.prototype.type]=this.readCubeMap,this.file.typeRead[SEA3D.CubeRender.prototype.type]=this.readCubeRender,this.file.typeRead[SEA3D.Animation.prototype.type]=this.readAnimation,this.file.typeRead[SEA3D.SoundPoint.prototype.type]=this.readSoundPoint,this.file.typeRead[SEA3D.TextureURL.prototype.type]=this.readTextureURL,this.file.typeRead[SEA3D.CubeMapURL.prototype.type]=this.readCubeMapURL,this.file.typeRead[SEA3D.Morph.prototype.type]=this.readMorpher,this.file.typeRead[SEA3D.VertexAnimation.prototype.type]=this.readVertexAnimation,this.file.typeRead[SEA3D.Actions.prototype.type]=this.readActions,this.config.dummys&&(this.file.typeRead[SEA3D.Dummy.prototype.type]=this.readDummy),this.config.scripts&&(this.file.typeRead[SEA3D.ScriptURL.prototype.type]=this.readScriptURL,this.file.typeRead[SEA3D.JavaScriptMethod.prototype.type]=this.readJavaScriptMethod),this.config.lights&&(this.file.typeRead[SEA3D.PointLight.prototype.type]=this.readPointLight,this.file.typeRead[SEA3D.DirectionalLight.prototype.type]=this.readDirectionalLight,this.file.typeRead[SEA3D.HemisphereLight.prototype.type]=this.readHemisphereLight,this.file.typeRead[SEA3D.AmbientLight.prototype.type]=this.readAmbientLight),this.file.typeRead[SEA3D.JPEG.prototype.type]=this.file.typeRead[SEA3D.JPEG_XR.prototype.type]=this.file.typeRead[SEA3D.PNG.prototype.type]=this.file.typeRead[SEA3D.GIF.prototype.type]=this.readTexture,this.file.typeRead[SEA3D.MP3.prototype.type]=this.readSound,this.file.typeRead[SEA3D.GLSL.prototype.type]=this.readGLSL;for(var e=THREE.SEA3D.EXTENSIONS_LOADER.length;e--;){var t=THREE.SEA3D.EXTENSIONS_LOADER[e];t.setTypeRead&&t.setTypeRead.call(this)}},THREE.SEA3D.prototype.load=function(e){this.file=new SEA3D.File,this.file.scope=this,this.file.config=this.config,this.file.onProgress=this.onLoadProgress.bind(this),this.file.onCompleteObject=this.onCompleteObject.bind(this),this.file.onDownloadProgress=this.onDownloadProgress.bind(this),this.file.onParseProgress=this.onParseProgress.bind(this),this.file.onParseComplete=this.onParseComplete.bind(this),this.file.onError=this.onError.bind(this),this.file.onHead=this.onHead.bind(this),this.file.onComplete=function(e){this.config.manager&&this.config.manager.add(this.domain),this.onComplete.call(this,e)}.bind(this),this.createDomain(),this.setTypeRead(),void 0!==e&&("string"==typeof e?this.file.load(e):this.file.read(e))};